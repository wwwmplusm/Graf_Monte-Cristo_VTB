<!-- a83d3236-dbf6-4a41-8e79-efeae857947c 708900d4-5567-4fb9-acb0-aac7108a8046 -->
# План дальнейших доработок

## Приоритет 1: Критичные UX улучшения (2-3 дня)

### Задача 1.1: Экран прогресса consent processing

**Проблема**: После выбора банков и согласий нет визуализации процесса создания согласий. Пользователь не видит прогресс.

**Решение**:

- Создать компонент `Step2ConsentProgress.tsx` (новый шаг между Step2 и Step3)
- Компонент показывает прогресс создания согласий для каждого банка
- Отображает статусы: "Создание...", "Ожидание подтверждения", "Успешно", "Ошибка"
- Если consent требует ручного подтверждения - показывает ссылку на банк
- После завершения всех согласий - переход к следующему шагу

**Файлы для изменения**:

- `hktn/src/components/steps/Step2ConsentProgress.tsx` (новый)
- `hktn/src/screens/OnboardingScreen.tsx` - добавить шаг 2.5
- `hktn/src/utils/api.ts` - добавить функцию вызова `/api/onboarding/consents`
- `hktn/backend/services/consents.py` - улучшить `create_multiple_consents()` для возврата детального прогресса

**Интеграция**:

- После Step2BanksAndConsents вызывать `POST /api/onboarding/consents`
- Показывать Step2ConsentProgress с polling статуса через `GET /api/onboarding/status`
- После успешного создания всех согласий - переход к Step3 (ProductSelection)

### Задача 1.2: Экран Summary перед завершением онбординга

**Проблема**: Нет финального экрана с подтверждением выбранных настроек.

**Решение**:

- Создать компонент `Step6Summary.tsx` (новый шаг после Step5)
- Показывает сводку: подключенные банки, выбранные цели, стратегия
- Кнопка "Готово" запускает финализацию онбординга

**Файлы для изменения**:

- `hktn/src/components/steps/Step6Summary.tsx` (новый)
- `hktn/src/screens/OnboardingScreen.tsx` - добавить шаг 6, обновить Stepper на 6 шагов
- `hktn/src/screens/OnboardingScreen.tsx` - вызывать `POST /api/onboarding/finalize` при завершении

---

## Приоритет 2: Завершение платежной системы (2-3 дня)

### Задача 2.1: Сохранение транзакций после платежей

**Проблема**: Платежи не сохраняются в БД, нет истории операций.

**Решение**:

- Добавить таблицу `payments` в `database.py`
- Создать функцию `save_payment()` для сохранения платежей
- Обновить `pay_mdp()`, `pay_adp()`, `pay_sdp()` для сохранения в БД
- Сохранять: payment_id, user_id, bank_id, type (mdp/adp/sdp), amount, status, timestamp

**Файлы для изменения**:

- `hktn/core/database.py` - добавить таблицу и функции
- `hktn/backend/services/payments.py` - вызывать `save_payment()` после успешного платежа

### Задача 2.2: Пересчет STS после платежей

**Проблема**: После платежа STS не обновляется автоматически.

**Решение**:

- Создать функцию `recalculate_sts()` в `analytics.py`
- Вызывать после успешного платежа в `pay_mdp()`, `pay_adp()`, `pay_sdp()`
- Добавить endpoint `POST /api/sts/recalculate` для ручного пересчета
- Возвращать новый STS и разницу с предыдущим

**Файлы для изменения**:

- `hktn/backend/services/analytics.py` - добавить `recalculate_sts()`
- `hktn/backend/services/payments.py` - вызывать пересчет после платежа
- `hktn/backend/routers/analytics.py` - добавить endpoint

### Задача 2.3: Получение реального account_id для платежей

**Проблема**: Используется placeholder `account-{user_id}-{bank_id}`.

**Решение**:

- Использовать `fetch_bank_accounts_with_consent()` для получения списка счетов
- Выбирать первый активный счет или счет с наибольшим балансом
- Сохранять account_id в запросе платежа

**Файлы для изменения**:

- `hktn/backend/services/payments.py` - получать реальные счета перед платежом

---

## Приоритет 3: Базовый Refinance функционал (2-3 дня)

### Задача 3.1: Создание роутера refinance

**Решение**:

- Создать `hktn/backend/routers/refinance.py`
- Добавить базовые endpoints: `GET /api/refinance/offers`, `POST /api/refinance/optimize`
- Использовать упрощенную логику: сравнение ставок кредитов с каталогом продуктов

**Файлы для изменения**:

- `hktn/backend/routers/refinance.py` (новый)
- `hktn/backend/services/refinance.py` (новый)
- `hktn/backend/app.py` - добавить роутер
- `hktn/backend/schemas.py` - добавить схемы для refinance

### Задача 3.2: Базовый алгоритм поиска офферов

**Решение**:

- Получать список кредитов пользователя через product consent
- Сравнивать ставки с каталогом банков (можно использовать mock данные)
- Возвращать топ-3 оффера с расчетом экономии

**Файлы для изменения**:

- `hktn/backend/services/refinance.py` - реализовать `find_refinance_offers()`

---

## Приоритет 4: Дополнительные endpoints (1-2 дня)

### Задача 4.1: Endpoints для loans и deposits

**Решение**:

- `GET /api/loans` - список кредитов
- `GET /api/loans/summary` - сводка (можно взять из dashboard)
- `GET /api/deposits` - список вкладов
- `GET /api/deposits/current` - текущий вклад

**Файлы для изменения**:

- `hktn/backend/routers/loans.py` (новый) или добавить в `analytics.py`
- `hktn/backend/routers/deposits.py` (новый) или добавить в `analytics.py`

### Задача 4.2: Endpoints для STS и Health

**Решение**:

- `GET /api/sts/today` - текущий STS (можно взять из dashboard)
- `POST /api/sts/recalculate` - пересчет STS
- `GET /api/health` - показатель финансового здоровья (можно взять из dashboard)

**Файлы для изменения**:

- `hktn/backend/routers/analytics.py` - добавить endpoints

---

## Приоритет 5: Улучшение алгоритмов (опционально, если есть время)

### Задача 5.1: Полная реализация MDP/ADP расчета

**Решение**:

- Реализовать полный алгоритм из back onboard.md
- Учитывать графики платежей, даты, статусы оплаты
- Использовать транзакции для определения факта оплаты

**Файлы для изменения**:

- `hktn/backend/services/analytics.py` - доработать `_calculate_loan_summary()`

### Задача 5.2: Алгоритм категоризации транзакций

**Решение**:

- Реализовать `transactions_categorization_salary_and_loans`
- Определять регулярность зарплаты
- Находить платежи по кредитам в транзакциях

**Файлы для изменения**:

- `hktn/backend/services/analytics.py` - добавить функцию категоризации

---

## Порядок выполнения

1. **День 1-2**: Приоритет 1 (UX улучшения)

- Экран прогресса consent processing
- Экран Summary

2. **День 3-4**: Приоритет 2 (Платежная система)

- Сохранение транзакций
- Пересчет STS
- Реальные account_id

3. **День 5-6**: Приоритет 3 (Refinance)

- Базовые endpoints
- Простой алгоритм поиска офферов

4. **День 7**: Приоритет 4 (Дополнительные endpoints)

- Loans, deposits, STS, health endpoints

5. **День 8+**: Приоритет 5 (Улучшение алгоритмов)

- Если останется время

---

## Оценка времени

- **Минимум для демо**: Приоритеты 1-2 (4-5 дней)
- **Хороший уровень**: Приоритеты 1-3 (6-7 дней)
- **Полная реализация**: Все приоритеты (8-10 дней)

## Критерии готовности

После выполнения приоритетов 1-2:

- ✅ Онбординг полностью функционален с визуализацией прогресса
- ✅ Платежи сохраняются и обновляют STS
- ✅ Dashboard показывает актуальные данные

После выполнения приоритета 3:

- ✅ Refinance функционал работает (базовая версия)
- ✅ Пользователь может видеть предложения по рефинансу

После выполнения приоритета 4:

- ✅ Все основные endpoints из API_INTEGRATION.md реализованы
- ✅ Frontend может получать данные независимо от dashboard