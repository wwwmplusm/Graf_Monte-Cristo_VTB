<!-- ef4b90fa-e79d-40a6-8a14-5c9cf31c52f5 341fde11-9aba-4ca0-a823-c6bd4106f366 -->
# Следующие шаги после критических исправлений

## Текущий статус

### Выполнено:

1. Исправлено сохранение onboarding_id в БД
2. Исправлен finalize_onboarding с последовательной загрузкой данных
3. Исправлены Payment endpoints (используют реальные account_id)
4. Реализован расчет SDP на основе цели и дохода
5. Сохранение настроек онбординга в БД
6. Добавлено персистентное хранение данных (accounts, transactions, balances, credits)
7. Улучшена обработка ошибок в payment endpoints
8. Обновление dashboard cache после платежей

### Уже реализовано ранее:

- Payment Consent реализован в `obr_client.py` и используется в `create_multiple_consents`
- Объединенный экран `Step2BanksAndConsents.tsx` существует
- Payment endpoints (MDP/ADP/SDP) реализованы
- Onboarding API endpoints реализованы

---

## Что нужно доработать

### 1. Улучшить Dashboard структуру

**Проблема:** Dashboard возвращает упрощенную структуру, некоторые поля используют placeholder значения.

**Файл:** `hktn/backend/services/analytics.py:368`

**Что нужно сделать:**

1. **Улучшить расчет `sts_today.tomorrow.amount`:**

- Сейчас используется упрощенная версия (равна `sts_daily_recommended`)
- Нужно пересчитать STS на завтра с учетом событий завтрашнего дня

2. **Реализовать отслеживание `sts_today.spent`:**

- Сейчас всегда 0.0 (TODO)
- Нужно суммировать транзакции за сегодня (debit транзакции)

3. **Проверить структуру `loan_summary`:**

- Должен содержать: `total_outstanding`, `mandatory_daily_payment`, `additional_daily_payment`, `total_monthly_payment`
- Проверить что все поля заполняются правильно

4. **Проверить структуру `savings_summary`:**

- Должен содержать: `total_saved`, `daily_payment`, `target`, `progress_percent`
- Проверить что все поля заполняются правильно

---

### 2. Проверить и доработать логику определения цели (Step 1.6)

**Проблема:** Согласно `back onboard.md`, кнопка "Закрыть кредиты" должна быть доступна ТОЛЬКО если у пользователя есть кредиты/кредитные карты.

**Файл:** `hktn/src/components/steps/Step5Questions.tsx`

**Что нужно сделать:**

1. Проверить что `checkUserHasLoans` правильно вызывается
2. Проверить что UI скрывает кнопку "Закрыть кредиты" если `hasLoans === false`
3. Проверить что backend endpoint `/api/user/has-loans` правильно работает
4. Если кредитов нет, предлагать только цель "Накопить деньги"

---

### 3. Улучшить обработку ошибок и edge cases

**Что нужно сделать:**

1. **Graceful degradation при недоступности банка:**

- Если один банк недоступен, продолжать работу с другими
- Показывать понятные сообщения об ошибках

2. **Обработка expired consents:**

- Проверять срок действия consent перед использованием
- Автоматически обновлять consent если истек

3. **Валидация данных:**

- Проверка сумм платежей (не больше баланса)
- Проверка наличия достаточных средств

---

### 4. Тестирование всех endpoints

**Что нужно сделать:**

1. **Протестировать onboarding flow:**

- POST /api/onboarding/start
- POST /api/onboarding/consents
- GET /api/onboarding/consents/status
- POST /api/onboarding/finalize
- GET /api/onboarding/status

2. **Протестировать payment endpoints:**

- POST /api/payments/mdp
- POST /api/payments/adp
- POST /api/payments/sdp

3. **Протестировать dashboard:**

- GET /api/dashboard
- Проверить что все поля заполняются правильно

---

### 5. Доработать frontend интеграцию

**Что нужно сделать:**

1. **Проверить интеграцию Step2BanksAndConsents с API:**

- Правильно ли отправляется запрос на `/api/onboarding/consents`
- Правильно ли обрабатываются ответы

2. **Проверить Step2ConsentProgress:**

- Правильно ли отображается прогресс создания consent
- Правильно ли обрабатываются ошибки

3. **Проверить интеграцию платежей:**

- Правильно ли вызываются payment endpoints
- Правильно ли обновляется UI после платежа

---

### 6. Улучшить расчет STS на завтра

**Проблема:** `sts_today.tomorrow.amount` использует упрощенную версию.

**Файл:** `hktn/backend/services/analytics.py:373`

**Что нужно сделать:**

Пересчитать STS на завтра с учетом:

- Событий завтрашнего дня (платежи по кредитам, поступления)
- Изменения баланса после завтрашних операций
- Влияния завтрашнего дохода (если он ожидается)

---

### 7. Реализовать отслеживание потраченных средств (sts_today.spent)

**Проблема:** `sts_today.spent` всегда 0.0.

**Файл:** `hktn/backend/services/analytics.py:371`

**Что нужно сделать:**

Суммировать все debit транзакции за сегодня:

- Фильтровать транзакции по дате (сегодня)
- Фильтровать по типу (debit)
- Суммировать суммы
- Возвращать общую сумму потраченных средств

---

## Приоритет выполнения

1. **Высокий приоритет:**

- Улучшить Dashboard структуру (задача 1)
- Проверить логику определения цели (задача 2)
- Реализовать отслеживание потраченных средств (задача 7)

2. **Средний приоритет:**

- Улучшить расчет STS на завтра (задача 6)
- Улучшить обработку ошибок (задача 3)

3. **Низкий приоритет:**

- Тестирование endpoints (задача 4)
- Доработка frontend интеграции (задача 5)