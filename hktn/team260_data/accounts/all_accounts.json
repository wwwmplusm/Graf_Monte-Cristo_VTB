import requests
import json
import os

# --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
CLIENT_ID = "team260"
CLIENT_SECRET = "wPnKt4ljvSh63JpV0Pmmqp2OeNFHWcYN"

# ! –í–ê–ñ–ù–û: –ï—Å–ª–∏ –≤ ABank –ø—É—Å—Ç–æ, –¥–∞–Ω–Ω—ã–µ —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ –≤ VBank.
# –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–∞—á–∞–ª–∞ vbank, –µ—Å–ª–∏ –Ω—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ. –ï—Å–ª–∏ –Ω—É–∂–µ–Ω –∏–º–µ–Ω–Ω–æ abank, —Ä–∞—Å–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ –≤—Ç–æ—Ä—É—é —Å—Ç—Ä–æ–∫—É.
BASE_URL = "https://vbank.open.bankingapi.ru" 
# BASE_URL = "https://abank.open.bankingapi.ru"

TARGET_USER_ID = f"{CLIENT_ID}-1" 
OUTPUT_DIR = "team260_data"

session = requests.Session()

def setup_directories():
    folders = [f"{OUTPUT_DIR}/profile", f"{OUTPUT_DIR}/accounts", f"{OUTPUT_DIR}/products", f"{OUTPUT_DIR}/agreements"]
    for folder in folders:
        os.makedirs(folder, exist_ok=True)
    print(f"üìÇ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: {OUTPUT_DIR} (–ë–∞–Ω–∫: {BASE_URL})")

def save_json(data, filename, folder):
    filepath = os.path.join(OUTPUT_DIR, folder, filename)
    with open(filepath, 'w', encoding='utf-8') as f:
        json.dump(data, f, ensure_ascii=False, indent=4)
    print(f"   üíæ Saved: {folder}/{filename}")

def get_bank_token():
    print("\nüîê –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...")
    url = f"{BASE_URL}/auth/bank-token"
    # –î–æ–±–∞–≤–ª—è–µ–º client_id –≤ URL –¥–ª—è –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏, —Ö–æ—Ç—è –¥–ª—è auth —ç—Ç–æ –æ–±—ã—á–Ω–æ POST body/query mix
    params = {"client_id": CLIENT_ID, "client_secret": CLIENT_SECRET}
    try:
        resp = session.post(url, params=params)
        resp.raise_for_status()
        return resp.json().get("access_token")
    except Exception as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {e}")
        exit(1)

def create_consent(token, type_):
    headers = {
        "Authorization": f"Bearer {token}",
        "X-Requesting-Bank": CLIENT_ID,
        "Content-Type": "application/json"
    }
    
    # –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û: –¥–æ–±–∞–≤–ª—è–µ–º client_id –≤ query params –¥–ª—è –≤—Å–µ—Ö POST –∑–∞–ø—Ä–æ—Å–æ–≤ —Å bank_token
    params = {"client_id": TARGET_USER_ID} 

    if type_ == "accounts":
        url = f"{BASE_URL}/account-consents/request"
        body = {
            "client_id": TARGET_USER_ID,
            "permissions": ["ReadAccountsDetail", "ReadBalances", "ReadTransactionsDetail"],
            "reason": "Hackathon Export",
            "requesting_bank": CLIENT_ID,
            "requesting_bank_name": "Team 260 App"
        }
        filename = "account_consent.json"
    else:
        url = f"{BASE_URL}/product-agreement-consents/request"
        body = {
            "client_id": TARGET_USER_ID,
            "requesting_bank": CLIENT_ID,
            "read_product_agreements": True,
            "open_product_agreements": False,
            "close_product_agreements": False,
            "allowed_product_types": ["deposit", "credit", "card", "account"], # –î–æ–±–∞–≤–∏–ª account –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
            "reason": "Hackathon Export"
        }
        filename = "product_consent.json"

    try:
        # ! –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ø–µ—Ä–µ–¥–∞–µ–º params={"client_id": ...}
        resp = session.post(url, headers=headers, json=body, params=params)
        resp.raise_for_status()
        data = resp.json()
        # –ò–Ω–æ–≥–¥–∞ API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç consentId (camelCase), –∏–Ω–æ–≥–¥–∞ consent_id (snake_case)
        c_id = data.get("consent_id") or data.get("data", {}).get("consentId")
        save_json(data, filename, "profile")
        print(f"   ‚úÖ –°–æ–≥–ª–∞—Å–∏–µ ({type_}) —Å–æ–∑–¥–∞–Ω–æ: {c_id}")
        return c_id
    except requests.exceptions.RequestException as e:
        print(f"   ‚ùå –û—à–∏–±–∫–∞ ({type_}): {e}")
        if e.response is not None:
            print(f"   –û—Ç–≤–µ—Ç: {e.response.text}")
        return None

def fetch_data(token, acc_consent, prod_consent):
    base_headers = {"Authorization": f"Bearer {token}", "X-Requesting-Bank": CLIENT_ID}
    
    # --- –°–ß–ï–¢–ê ---
    print("\nüì° –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –ø–æ —Å—á–µ—Ç–∞–º...")
    if acc_consent:
        headers = base_headers.copy()
        headers["X-Consent-Id"] = acc_consent
        try:
            # –î–æ–±–∞–≤–ª–µ–Ω client_id –≤ params
            resp = session.get(f"{BASE_URL}/accounts", headers=headers, params={"client_id": TARGET_USER_ID})
            if resp.status_code == 200:
                data = resp.json()
                save_json(data, "list.json", "accounts")
                # –£–Ω–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–∏—Å–∫–∞ —Å–ø–∏—Å–∫–∞
                accounts = data.get("data", {}).get("accounts", [])
                if not accounts: accounts = data.get("accounts", [])
                
                print(f"   –ù–∞–π–¥–µ–Ω–æ —Å—á–µ—Ç–æ–≤: {len(accounts)}")
                
                for acc in accounts:
                    aid = acc.get("accountId")
                    print(f"   ‚¨áÔ∏è –°—á–µ—Ç {aid}: –¥–µ—Ç–∞–ª–∏, –±–∞–ª–∞–Ω—Å, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏...")
                    # –î–µ—Ç–∞–ª–∏
                    save_json(session.get(f"{BASE_URL}/accounts/{aid}", headers=headers, params={"client_id": TARGET_USER_ID}).json(), f"{aid}_details.json", "accounts")
                    # –ë–∞–ª–∞–Ω—Å
                    save_json(session.get(f"{BASE_URL}/accounts/{aid}/balances", headers=headers, params={"client_id": TARGET_USER_ID}).json(), f"{aid}_balance.json", "accounts")
                    # –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
                    save_json(session.get(f"{BASE_URL}/accounts/{aid}/transactions", headers=headers, params={"client_id": TARGET_USER_ID, "limit": 1000}).json(), f"{aid}_transactions.json", "accounts")
        except Exception as e: print(f"‚ùå –û—à–∏–±–∫–∞ —Å—á–µ—Ç–æ–≤: {e}")

    # --- –î–û–ì–û–í–û–†–´ ---
    print("\nüì¶ –°–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –∏ –¥–æ–≥–æ–≤–æ—Ä–æ–≤...")
    save_json(session.get(f"{BASE_URL}/products").json(), "catalog.json", "products")

    if prod_consent:
        headers = base_headers.copy()
        headers["X-Product-Agreement-Consent-Id"] = prod_consent
        try:
            # –î–æ–±–∞–≤–ª–µ–Ω client_id –≤ params
            resp = session.get(f"{BASE_URL}/product-agreements", headers=headers, params={"client_id": TARGET_USER_ID})
            if resp.status_code == 200:
                data = resp.json()
                save_json(data, "list.json", "agreements")
                
                agreements = data.get("data", {}).get("agreements", [])
                if not agreements: agreements = data.get("agreements", []) # Fallback
                
                print(f"   –ù–∞–π–¥–µ–Ω–æ –¥–æ–≥–æ–≤–æ—Ä–æ–≤: {len(agreements)}")
                for agr in agreements:
                    ag_id = agr.get("agreementId")
                    print(f"   ‚¨áÔ∏è –î–æ–≥–æ–≤–æ—Ä {ag_id}...")
                    save_json(session.get(f"{BASE_URL}/product-agreements/{ag_id}", headers=headers, params={"client_id": TARGET_USER_ID}).json(), f"{ag_id}.json", "agreements")
        except Exception as e: print(f"‚ùå –û—à–∏–±–∫–∞ –¥–æ–≥–æ–≤–æ—Ä–æ–≤: {e}")

if __name__ == "__main__":
    setup_directories()
    tk = get_bank_token()
    ac_id = create_consent(tk, "accounts")
    pr_id = create_consent(tk, "products")
    fetch_data(tk, ac_id, pr_id)
    print("\n‚úÖ –ì–æ—Ç–æ–≤–æ.")