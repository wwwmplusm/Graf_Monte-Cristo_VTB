# üéØ –ü–ª–∞–Ω –¥–æ—Ä–∞–±–æ—Ç–∫–∏ FinPulse –¥–ª—è —Ö–∞–∫–∞—Ç–æ–Ω–∞

**–¶–µ–ª—å:** –î–æ–≤–µ—Å—Ç–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–æ 95% —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞ 18-26 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã

---

## üìä –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å: 70% –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

**–ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ:**
- ‚úÖ Backend –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ API
- ‚úÖ 6 –∏–∑ 9 –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ —Ä–∞—Å—á–µ—Ç–∞
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å OpenBanking Russia
- ‚úÖ Dashboard —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- ‚úÖ Payment flow (MDP/ADP/SDP)
- ‚úÖ UI/UX –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤

**–ß—Ç–æ –Ω—É–∂–Ω–æ –¥–æ—Ä–∞–±–æ—Ç–∞—Ç—å:**
- ‚ùå –û–Ω–±–æ—Ä–¥–∏–Ω–≥ (–Ω–∞—Ä—É—à–µ–Ω–∏—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏)
- ‚ùå Refinancing (–Ω–µ—Ç backend –ª–æ–≥–∏–∫–∏)
- ‚ùå Loans/Deposits Detail (mock –¥–∞–Ω–Ω—ã–µ)
- ‚ùå Goal Selection (–Ω–µ—Ç –≤–∞–ª–∏–¥–∞—Ü–∏–∏)

---

## üî¥ –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –∑–∞–¥–∞—á–∏ (14-20 —á–∞—Å–æ–≤)

### –ó–∞–¥–∞—á–∞ 1.1: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ Consent Flow –≤ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ (6 —á–∞—Å–æ–≤)

**–ü—Ä–æ–±–ª–µ–º–∞:** –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è consent –Ω–µ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è auto-approve –∏ –Ω–µ –¥–∞–µ—Ç—Å—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –±–∞–Ω–∫

**–°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è (back onboard.md, Step 1.5):**
```
–ö–∞–∫ —Ç–æ–ª—å–∫–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –Ω–∞ –±—ç–∫—ç–Ω–¥–µ –∑–∞–ø—Ä–æ—Å –Ω–∞ –∫–æ–Ω—Å–µ–Ω—Ç, –±–∞–Ω–∫ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –≤ —Ä–µ–∂–∏–º –æ–∂–∏–¥–∞–Ω–∏—è. 
–ò –µ—Å–ª–∏ –Ω–µ –ø–æ–ª—É—á–∏–ª approve –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞, —Ç–æ –≤—ã–≤–æ–¥–∏—Ç—Å—è —ç–∫—Ä–∞–Ω—á–∏–∫ –æ–∂–∏–¥–∞–Ω–∏—è —Å —Å—Å—ã–ª–∫–æ–π –Ω–∞ –±–∞–Ω–∫, 
—á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—à–µ–ª –∏ –≤—Ä—É—á–Ω—É—é –≤—Å–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª.
```

#### –®–∞–≥ 1.1.1: Backend - –ø—Ä–æ–≤–µ—Ä–∫–∞ auto-approve (2 —á–∞—Å–∞)

**–§–∞–π–ª:** `hktn/backend/services/consents.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ñ—É–Ω–∫—Ü–∏–∏ `initiate_full_consent_flow()`:**

```python
async def initiate_full_consent_flow(req: ConsentInitiateRequest) -> Dict[str, Any]:
    """–ò–Ω–∏—Ü–∏–∏—Ä—É–µ—Ç –ø–æ–ª–Ω—ã–π consent flow: accounts + products + payments."""
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    # –ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è account consent
    account_response = await client.request_account_consent(...)
    
    # –î–û–ë–ê–í–ò–¢–¨: –ü—Ä–æ–≤–µ—Ä–∫–∞ auto-approve
    auto_approved = account_response.get("status") == "approved"
    authorization_url = None
    
    if not auto_approved:
        # –ü–æ—Å—Ç—Ä–æ–∏—Ç—å URL –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
        authorization_url = (
            f"{config.base_url}/consent/authorize?"
            f"request_id={account_request_id}&"
            f"client_id={req.user_id}"
        )
    
    # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å consent —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
    consent = StoredConsent(
        user_id=req.user_id,
        bank_id=req.bank_id,
        consent_id=account_consent_id,
        consent_type="accounts",
        status="approved" if auto_approved else "pending",
        # ...
    )
    
    # –ò–ó–ú–ï–ù–ò–¢–¨: –í–µ—Ä–Ω—É—Ç—å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–π –æ—Ç–≤–µ—Ç
    return {
        "status": "ok",
        "bank_id": req.bank_id,
        "consents": {
            "account": {
                "consent_id": account_consent_id,
                "request_id": account_request_id,
                "status": "approved" if auto_approved else "pending",
                "auto_approved": auto_approved,
                "authorization_url": authorization_url,
            },
            # ... –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è product –∏ payment consents
        },
    }
```

**–ù–æ–≤—ã–µ –ø–æ–ª—è –≤ –æ—Ç–≤–µ—Ç–µ:**
- `auto_approved: bool` - –±—ã–ª –ª–∏ consent –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–¥–æ–±—Ä–µ–Ω
- `authorization_url: str | null` - —Å—Å—ã–ª–∫–∞ –Ω–∞ –±–∞–Ω–∫ –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- `status: "approved" | "pending"` - —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å consent

---

#### –®–∞–≥ 1.1.2: Backend - endpoint –¥–ª—è polling —Å—Ç–∞—Ç—É—Å–∞ (1 —á–∞—Å)

**–§–∞–π–ª:** `hktn/backend/services/consents.py`

**–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**

```python
async def poll_consent_status(
    user_id: str,
    bank_id: str,
    request_id: str,
) -> Dict[str, Any]:
    """
    –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å—Ç–∞—Ç—É—Å consent –ø–æ request_id.
    –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è polling –ø–æ—Å–ª–µ —Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤ –±–∞–Ω–∫–µ.
    """
    config = get_bank_config(bank_id, require_url=True)
    
    async with bank_client(bank_id) as client:
        # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —á–µ—Ä–µ–∑ –±–∞–Ω–∫–æ–≤—Å–∫–∏–π API
        status_response = await client.get_consent_status(request_id)
        
        status = status_response.get("status", "pending")
        
        if status == "approved":
            # –ü–æ–ª—É—á–∏—Ç—å consent_id –∏ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
            consent_id = status_response.get("consent_id")
            
            # –û–±–Ω–æ–≤–∏—Ç—å –≤ –ë–î
            update_consent_status(user_id, bank_id, "accounts", consent_id, "approved")
            
        return {
            "status": status,  # "pending" | "approved" | "rejected"
            "consent_id": consent_id if status == "approved" else None,
        }
```

**–†–æ—É—Ç–µ—Ä —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç:** `hktn/backend/routers/consents.py` (—Å—Ç—Ä–æ–∫–∞ 41-43)

---

#### –®–∞–≥ 1.1.3: Frontend - –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å—Å—ã–ª–∫–∏ –∏ polling (3 —á–∞—Å–∞)

**–§–∞–π–ª:** `hktn/src/components/steps/Step2ConsentProgress.tsx`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥:**
```typescript
// –°–µ–π—á–∞—Å –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è spinner –∏ –ø–µ—Ä–µ—Ö–æ–¥ –¥–∞–ª—å—à–µ
```

**–ù–æ–≤—ã–π –∫–æ–¥:**

```typescript
interface ConsentStatus {
  consent_id: string | null;
  request_id: string;
  status: 'pending' | 'approved' | 'rejected';
  auto_approved: boolean;
  authorization_url: string | null;
}

interface BankConsentState {
  bank_id: string;
  bank_name: string;
  account: ConsentStatus;
  product: ConsentStatus;
  payment: ConsentStatus;
  current_step: 'account' | 'product' | 'payment' | 'done';
}

export function Step2ConsentProgress({ ... }) {
  const [banksState, setBanksState] = useState<BankConsentState[]>([]);
  const [currentBankIndex, setCurrentBankIndex] = useState(0);
  
  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è consent –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –±–∞–Ω–∫–∞
  useEffect(() => {
    if (currentBankIndex >= banksWithConsents.length) {
      // –í—Å–µ –±–∞–Ω–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã
      onNext();
      return;
    }
    
    const bank = banksWithConsents[currentBankIndex];
    initiateConsentsForBank(bank);
  }, [currentBankIndex]);
  
  const initiateConsentsForBank = async (bank: any) => {
    // 1. –°–æ–∑–¥–∞—Ç—å account consent
    const accountResponse = await fetch('/api/consent/initiate', {
      method: 'POST',
      body: JSON.stringify({
        user_id: userId,
        bank_id: bank.bank_id,
      }),
    });
    
    const accountData = await accountResponse.json();
    const accountConsent = accountData.consents.account;
    
    // 2. –û–±–Ω–æ–≤–∏—Ç—å state
    setBanksState((prev) => {
      const newState = [...prev];
      newState[currentBankIndex] = {
        bank_id: bank.bank_id,
        bank_name: bank.bank_name,
        account: accountConsent,
        product: { ... },
        payment: { ... },
        current_step: 'account',
      };
      return newState;
    });
    
    // 3. –ï—Å–ª–∏ –ù–ï auto-approved ‚Üí –∑–∞–ø—É—Å—Ç–∏—Ç—å polling
    if (!accountConsent.auto_approved) {
      startPolling(bank.bank_id, accountConsent.request_id, 'account');
    } else {
      // –°—Ä–∞–∑—É –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ product consent
      proceedToProductConsent(bank);
    }
  };
  
  const startPolling = (bankId: string, requestId: string, consentType: string) => {
    const intervalId = setInterval(async () => {
      const statusResponse = await fetch(
        `/api/consent/status?user_id=${userId}&bank_id=${bankId}&request_id=${requestId}`
      );
      const statusData = await statusResponse.json();
      
      if (statusData.status === 'approved') {
        clearInterval(intervalId);
        
        // –û–±–Ω–æ–≤–∏—Ç—å state
        setBanksState((prev) => {
          const newState = [...prev];
          newState[currentBankIndex][consentType].status = 'approved';
          newState[currentBankIndex][consentType].consent_id = statusData.consent_id;
          return newState;
        });
        
        // –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É consent
        if (consentType === 'account') {
          proceedToProductConsent(banksWithConsents[currentBankIndex]);
        } else if (consentType === 'product') {
          proceedToPaymentConsent(banksWithConsents[currentBankIndex]);
        } else if (consentType === 'payment') {
          // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–∞–Ω–∫—É
          setCurrentBankIndex((prev) => prev + 1);
        }
      } else if (statusData.status === 'rejected') {
        clearInterval(intervalId);
        // –ü–æ–∫–∞–∑–∞—Ç—å –æ—à–∏–±–∫—É
        alert('Consent –±—ã–ª –æ—Ç–∫–ª–æ–Ω–µ–Ω. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.');
      }
    }, 5000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥
  };
  
  // Render
  return (
    <div>
      <h2>–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∞–Ω–∫–æ–≤</h2>
      
      {banksState.map((bank, index) => (
        <div key={bank.bank_id}>
          <h3>{bank.bank_name}</h3>
          
          {/* Account consent */}
          <div>
            {bank.account.status === 'pending' && (
              <>
                <div className="spinner" />
                <p>–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è...</p>
                {bank.account.authorization_url && (
                  <a 
                    href={bank.account.authorization_url} 
                    target="_blank"
                    className="btn-primary"
                  >
                    –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤ –±–∞–Ω–∫–µ ‚Üí
                  </a>
                )}
              </>
            )}
            
            {bank.account.status === 'approved' && (
              <div className="success">‚úì Account consent –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω</div>
            )}
          </div>
          
          {/* Product consent (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ) */}
          {/* Payment consent (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ) */}
        </div>
      ))}
    </div>
  );
}
```

**–ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã:**
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞–Ω–∫–æ–≤ (–æ–¥–∏–Ω –∑–∞ –¥—Ä—É–≥–∏–º)
- –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–Ω–∫–∞: —Å–Ω–∞—á–∞–ª–∞ account ‚Üí product ‚Üí payment
- –ï—Å–ª–∏ –Ω–µ auto-approved ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Å—ã–ª–∫—É + polling –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫
- –¢–æ–ª—å–∫–æ –ø–æ—Å–ª–µ approve –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É consent

---

### –ó–∞–¥–∞—á–∞ 1.2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Refinancing API (8 —á–∞—Å–æ–≤)

**–ü—Ä–æ–±–ª–µ–º–∞:** RefinanceScreen –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ mock –¥–∞–Ω–Ω—ã–µ, –Ω–µ—Ç backend –ª–æ–≥–∏–∫–∏

#### –®–∞–≥ 1.2.1: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ financing_need_detector (2 —á–∞—Å–∞)

**–§–∞–π–ª:** `hktn/backend/services/algorithms.py`

**–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**

```python
def financing_need_detector(
    estimated_monthly_income: float,
    active_loans: List[Dict[str, Any]],
    debt_obligations_status: List[Dict[str, Any]],
    sts_status: str,
    days_until_gap: int,
    total_overdue_debt_base: float,
    dti_threshold: float = 0.5,
) -> Dict[str, Any]:
    """
    –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –Ω—É–∂–¥–∞–µ—Ç—Å—è –ª–∏ –∫–ª–∏–µ–Ω—Ç –≤ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–∏ (—Ä–µ—Ñ–∏–Ω–∞–Ω—Å, –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è).
    
    –°–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ê–ª–≥–æ—Ä–∏—Ç–º 7):
    - –†–∞—Å—á–µ—Ç –ü–î–ù (DTI)
    - –°–±–æ—Ä —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
    - –û—Ü–µ–Ω–∫–∞ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏
    """
    # –≠–¢–ê–ü 1: –†–∞—Å—á–µ—Ç DTI
    total_payments = sum(
        ob.get("planned_amount", 0) 
        for ob in debt_obligations_status
    )
    
    if estimated_monthly_income > 0:
        dti = total_payments / estimated_monthly_income
    else:
        dti = 1.0  # –°—á–∏—Ç–∞–µ–º, —á—Ç–æ –≤—Å—ë –ø–ª–æ—Ö–æ
    
    # –≠–¢–ê–ü 2: –°–±–æ—Ä —Ç—Ä–∏–≥–≥–µ—Ä–æ–≤
    triggers = []
    refi_candidates = []
    
    # –¢—Ä–∏–≥–≥–µ—Ä 1: –ü—Ä–æ—Å—Ä–æ—á–∫–∞
    if total_overdue_debt_base > 0:
        triggers.append("overdue")
    
    # –¢—Ä–∏–≥–≥–µ—Ä 2: Gap Risk (–Ω–µ—Ç –¥–µ–Ω–µ–≥)
    if sts_status == "DANGER":
        triggers.append("gap_risk")
    
    # –¢—Ä–∏–≥–≥–µ—Ä 3: High Load (–≤—ã—Å–æ–∫–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞)
    if dti > dti_threshold:
        triggers.append("high_dti")
    
    # –¢—Ä–∏–≥–≥–µ—Ä 4: Refi Opportunity (–º–æ–∂–Ω–æ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å)
    # –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∫—Ä–µ–¥–∏—Ç–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –º–æ–∂–Ω–æ –ª–∏ —Å–Ω–∏–∑–∏—Ç—å —Å—Ç–∞–≤–∫—É
    for loan in active_loans:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º product catalog
        catalog = load_product_catalog()
        
        # –ò—â–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Å—Ç–∞–≤–∫—É –¥–ª—è —Ç–∞–∫–æ–≥–æ –∂–µ —Ç–∏–ø–∞ –ø—Ä–æ–¥—É–∫—Ç–∞
        best_market_rate = min(
            (p["rate"] for p in catalog if p["product_type"] == loan["product_type"]),
            default=loan["interest_rate"]
        )
        
        rate_diff = loan["interest_rate"] - best_market_rate
        
        if rate_diff >= 1.5 and total_overdue_debt_base == 0:
            # –ú–æ–∂–Ω–æ —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å
            triggers.append("refi_opportunity")
            refi_candidates.append(loan["agreement_id"])
    
    # –≠–¢–ê–ü 3: –û—Ü–µ–Ω–∫–∞ —Å—Ä–æ—á–Ω–æ—Å—Ç–∏
    if "overdue" in triggers or "gap_risk" in triggers:
        urgency = "HIGH"
    elif "high_dti" in triggers:
        urgency = "MEDIUM"
    elif "refi_opportunity" in triggers:
        urgency = "WATCH"
    else:
        urgency = "NONE"
    
    # –≠–¢–ê–ü 4: –§–∏–Ω–∞–ª
    financing_needed = urgency != "NONE"
    
    return {
        "financing_needed": financing_needed,
        "urgency": urgency,
        "triggers": triggers,
        "refi_candidates": refi_candidates,
        "dti": round(dti, 3),
    }
```

**–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**

```python
def load_product_catalog() -> List[Dict[str, Any]]:
    """–ó–∞–≥—Ä—É–∂–∞–µ—Ç product catalog –∏–∑ JSON —Ñ–∞–π–ª–∞."""
    catalog_path = "hktn/team260_data/products/catalog.json"
    
    with open(catalog_path, "r", encoding="utf-8") as f:
        data = json.load(f)
    
    return data.get("products", [])
```

---

#### –®–∞–≥ 1.2.2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –∞–ª–≥–æ—Ä–∏—Ç–º–∞ best_financing_offer_selector (3 —á–∞—Å–∞)

**–§–∞–π–ª:** `hktn/backend/services/algorithms.py`

**–ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**

```python
import numpy as np

def best_financing_offer_selector(
    refi_candidates: List[str],
    active_loans: List[Dict[str, Any]],
    estimated_monthly_income: float,
    min_rate_diff: float = 1.5,
) -> List[Dict[str, Any]]:
    """
    –ü–æ–¥–±–∏—Ä–∞–µ—Ç –ª—É—á—à–∏–µ —É—Å–ª–æ–≤–∏—è —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è: —Ä–µ—Ñ–∏–Ω–∞–Ω—Å –∏–ª–∏ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è.
    
    –°–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (–ê–ª–≥–æ—Ä–∏—Ç–º 8):
    - –°—Ü–µ–Ω–∞—Ä–∏–π "–¢–æ—á–µ—á–Ω—ã–π –≤—ã—Å—Ç—Ä–µ–ª" (Single Refi)
    - –°—Ü–µ–Ω–∞—Ä–∏–π "–ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è" (All-in)
    - –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ monthly_saving
    """
    catalog = load_product_catalog()
    top_offers = []
    
    # –≠–¢–ê–ü 1: –°—Ü–µ–Ω–∞—Ä–∏–π "–¢–æ—á–µ—á–Ω—ã–π –≤—ã—Å—Ç—Ä–µ–ª"
    for loan_id in refi_candidates:
        loan = next((l for l in active_loans if l["agreement_id"] == loan_id), None)
        if not loan:
            continue
        
        # –ò—â–µ–º –æ—Ñ—Ñ–µ—Ä—ã –≤ –∫–∞—Ç–∞–ª–æ–≥–µ
        matching_offers = [
            offer for offer in catalog
            if (
                offer["product_type"] in ["loan", "refinance"] and
                offer["min_amount"] <= loan["amount"] <= offer["max_amount"] and
                offer["rate"] <= loan["interest_rate"] - min_rate_diff
            )
        ]
        
        for offer in matching_offers:
            # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –Ω–æ–≤—ã–π –ø–ª–∞—Ç–µ–∂ (PMT –∞–Ω–Ω—É–∏—Ç–µ—Ç)
            new_monthly_payment = calculate_pmt(
                rate=offer["rate"] / 100 / 12,
                nper=offer["max_term_months"],
                pv=loan["amount"],
            )
            
            # –°—á–∏—Ç–∞–µ–º –≤—ã–≥–æ–¥—É
            old_monthly_payment = loan.get("monthly_payment", 0)
            if old_monthly_payment == 0:
                # –≠–≤—Ä–∏—Å—Ç–∏–∫–∞
                old_monthly_payment = loan["amount"] * 0.02
            
            monthly_saving = old_monthly_payment - new_monthly_payment
            
            if monthly_saving > 0:
                top_offers.append({
                    "id": f"refi-{loan_id}-{offer['id']}",
                    "strategy": "Refinance One",
                    "bank": offer["bank"],
                    "product": offer["product_name"],
                    "rate": offer["rate"],
                    "term_months": offer["max_term_months"],
                    "old_monthly_payment": round(old_monthly_payment, 2),
                    "new_monthly_payment": round(new_monthly_payment, 2),
                    "monthly_saving": round(monthly_saving, 2),
                    "total_saving": round(monthly_saving * offer["max_term_months"], 2),
                    "commission": offer.get("commission", 0),
                    "breakeven_months": (
                        int(offer.get("commission", 0) / monthly_saving) 
                        if monthly_saving > 0 else 0
                    ),
                    "target_loans": [loan_id],
                })
    
    # –≠–¢–ê–ü 2: –°—Ü–µ–Ω–∞—Ä–∏–π "–ö–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è"
    if len(refi_candidates) > 1:
        # –°–æ–±–∏—Ä–∞–µ–º "–ü–∞–∫–µ—Ç"
        total_debt_sum = sum(
            loan["amount"] 
            for loan in active_loans 
            if loan["agreement_id"] in refi_candidates
        )
        
        total_current_pay = sum(
            loan.get("monthly_payment", loan["amount"] * 0.02)
            for loan in active_loans
            if loan["agreement_id"] in refi_candidates
        )
        
        # –ò—â–µ–º –æ—Ñ—Ñ–µ—Ä—ã –¥–ª—è –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏
        consolidation_offers = [
            offer for offer in catalog
            if (
                offer["product_type"] in ["loan", "refinance", "consolidation"] and
                offer["max_amount"] >= total_debt_sum
            )
        ]
        
        for offer in consolidation_offers:
            new_total_pay = calculate_pmt(
                rate=offer["rate"] / 100 / 12,
                nper=offer["max_term_months"],
                pv=total_debt_sum,
            )
            
            total_saving = total_current_pay - new_total_pay
            
            if total_saving > 0:
                top_offers.append({
                    "id": f"consol-{offer['id']}",
                    "strategy": "Consolidation",
                    "bank": offer["bank"],
                    "product": offer["product_name"],
                    "rate": offer["rate"],
                    "term_months": offer["max_term_months"],
                    "old_monthly_payment": round(total_current_pay, 2),
                    "new_monthly_payment": round(new_total_pay, 2),
                    "monthly_saving": round(total_saving, 2),
                    "total_saving": round(total_saving * offer["max_term_months"], 2),
                    "commission": offer.get("commission", 0),
                    "breakeven_months": (
                        int(offer.get("commission", 0) / total_saving)
                        if total_saving > 0 else 0
                    ),
                    "target_loans": refi_candidates,
                })
    
    # –≠–¢–ê–ü 3: –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—ã–≥–æ–¥–µ
    top_offers.sort(key=lambda x: x["monthly_saving"], reverse=True)
    
    # –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–æ–ø-3
    return top_offers[:3]


def calculate_pmt(rate: float, nper: int, pv: float) -> float:
    """
    –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç –∞–Ω–Ω—É–∏—Ç–µ—Ç–Ω—ã–π –ø–ª–∞—Ç–µ–∂ (—Ñ–æ—Ä–º—É–ª–∞ PMT –∏–∑ Excel).
    
    PMT = PV * [r(1 + r)^n] / [(1 + r)^n - 1]
    
    Args:
        rate: –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ –∑–∞ –ø–µ—Ä–∏–æ–¥ (–º–µ—Å—è—Ü)
        nper: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–µ—Ä–∏–æ–¥–æ–≤ (–º–µ—Å—è—Ü–µ–≤)
        pv: —Ç–µ–∫—É—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (—Å—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–∞)
    
    Returns:
        –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –ø–ª–∞—Ç–µ–∂
    """
    if rate == 0:
        return pv / nper
    
    return pv * (rate * (1 + rate) ** nper) / ((1 + rate) ** nper - 1)
```

---

#### –®–∞–≥ 1.2.3: Backend —Ä–æ—É—Ç–µ—Ä –¥–ª—è Refinancing (2 —á–∞—Å–∞)

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `hktn/backend/routers/refinance.py`

```python
from __future__ import annotations

import logging
from typing import Any, Dict, List

from fastapi import APIRouter, HTTPException

from ..services.algorithms import (
    financing_need_detector,
    best_financing_offer_selector,
)
from ..services.analytics import get_dashboard_metrics

router = APIRouter(prefix="/api", tags=["refinance"])
logger = logging.getLogger("finpulse.backend.refinance")


@router.get("/refinance/optimize-loans")
async def optimize_loans(user_id: str) -> Dict[str, Any]:
    """
    –û–ø—Ç–∏–º–∏–∑–∏—Ä—É–µ—Ç –∫—Ä–µ–¥–∏—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏—è.
    
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–æ–ø-3 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è, –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –≤—ã–≥–æ–¥–µ.
    """
    # 1. –ü–æ–ª—É—á–∞–µ–º dashboard –º–µ—Ç—Ä–∏–∫–∏
    dashboard = await get_dashboard_metrics(user_id, force_refresh=False)
    
    # –ò–∑–≤–ª–µ–∫–∞–µ–º –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –¥–∞–Ω–Ω—ã–µ
    # (–Ω—É–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å get_dashboard_metrics —á—Ç–æ–±—ã –≤–æ–∑–≤—Ä–∞—â–∞–ª –±–æ–ª—å—à–µ –¥–µ—Ç–∞–ª–µ–π)
    
    # –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º mock –¥–∞–Ω–Ω—ã–µ
    # TODO: –†–∞—Å—à–∏—Ä–∏—Ç—å dashboard API
    
    estimated_monthly_income = 50000.0  # –ó–∞–≥–ª—É—à–∫–∞
    active_loans = []  # –ó–∞–≥–ª—É—à–∫–∞
    debt_obligations_status = []
    sts_status = "OK"
    days_until_gap = 30
    total_overdue_debt_base = 0.0
    
    # 2. –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Ç—Ä–µ–±–Ω–æ—Å—Ç—å –≤ —Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–∏
    detection = financing_need_detector(
        estimated_monthly_income=estimated_monthly_income,
        active_loans=active_loans,
        debt_obligations_status=debt_obligations_status,
        sts_status=sts_status,
        days_until_gap=days_until_gap,
        total_overdue_debt_base=total_overdue_debt_base,
    )
    
    if not detection["financing_needed"]:
        return {
            "status": "ok",
            "financing_needed": False,
            "message": "–í–∞—à–∏ –∫—Ä–µ–¥–∏—Ç—ã –≤ –ø–æ—Ä—è–¥–∫–µ, —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.",
            "offers": [],
        }
    
    # 3. –ü–æ–¥–±–∏—Ä–∞–µ–º –ª—É—á—à–∏–µ –æ—Ñ—Ñ–µ—Ä—ã
    offers = best_financing_offer_selector(
        refi_candidates=detection["refi_candidates"],
        active_loans=active_loans,
        estimated_monthly_income=estimated_monthly_income,
    )
    
    logger.info(
        "Refinance optimization for user %s: %d offers, urgency=%s",
        user_id,
        len(offers),
        detection["urgency"],
    )
    
    return {
        "status": "ok",
        "financing_needed": True,
        "urgency": detection["urgency"],
        "triggers": detection["triggers"],
        "dti": detection["dti"],
        "offers": offers,
    }


@router.post("/refinance/apply")
async def apply_for_refinance(
    user_id: str,
    offer_id: str,
) -> Dict[str, Any]:
    """
    –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ.
    
    –î–ª—è –¥–µ–º–æ: –ø—Ä–æ—Å—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Å—Ç–∞—Ç—É—Å (approved/declined).
    """
    import random
    
    # Mock: 70% –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –æ–¥–æ–±—Ä–µ–Ω–∏—è
    approved = random.random() < 0.7
    
    logger.info(
        "Refinance application: user=%s, offer=%s, approved=%s",
        user_id,
        offer_id,
        approved,
    )
    
    return {
        "status": "ok",
        "application_status": "approved" if approved else "declined",
        "offer_id": offer_id,
        "message": (
            "–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞! –í–∞—à–∏ –∫—Ä–µ–¥–∏—Ç—ã –±—É–¥—É—Ç —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω—ã." 
            if approved else 
            "–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –∑–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è."
        ),
    }
```

**–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—É—Ç–µ—Ä:**

**–§–∞–π–ª:** `hktn/backend/app.py`

```python
from .routers import analytics, banks, consents, auth, payments, onboarding, refinance

# ...

app.include_router(refinance.router)
```

---

#### –®–∞–≥ 1.2.4: Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (1 —á–∞—Å)

**–§–∞–π–ª:** `hktn/src/utils/api.ts`

**–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏:**

```typescript
export interface RefinanceOffer {
  id: string;
  strategy: 'Refinance One' | 'Consolidation';
  bank: string;
  product: string;
  rate: number;
  term_months: number;
  old_monthly_payment: number;
  new_monthly_payment: number;
  monthly_saving: number;
  total_saving: number;
  commission: number;
  breakeven_months: number;
  target_loans: string[];
}

export interface RefinanceResponse {
  status: 'ok';
  financing_needed: boolean;
  urgency?: 'HIGH' | 'MEDIUM' | 'WATCH' | 'NONE';
  triggers?: string[];
  dti?: number;
  offers: RefinanceOffer[];
  message?: string;
}

export async function getRefinanceOffers(userId: string): Promise<RefinanceResponse> {
  const response = await fetch(
    `${API_BASE_URL}/api/refinance/optimize-loans?user_id=${userId}`
  );
  if (!response.ok) {
    throw new Error('Failed to fetch refinance offers');
  }
  return response.json();
}

export async function applyForRefinance(
  userId: string,
  offerId: string
): Promise<{ application_status: 'approved' | 'declined'; message: string }> {
  const response = await fetch(`${API_BASE_URL}/api/refinance/apply`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: userId, offer_id: offerId }),
  });
  if (!response.ok) {
    throw new Error('Failed to apply for refinance');
  }
  return response.json();
}
```

**–§–∞–π–ª:** `hktn/src/screens/RefinanceScreen.tsx`

**–ó–∞–º–µ–Ω–∏—Ç—å mock –¥–∞–Ω–Ω—ã–µ –Ω–∞ API:**

```typescript
import { getRefinanceOffers, applyForRefinance, type RefinanceOffer } from '../utils/api';

export function RefinanceScreen({ appState, onBack }: RefinanceScreenProps) {
  const [offers, setOffers] = useState<RefinanceOffer[]>([]);
  const [loading, setLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  
  useEffect(() => {
    const loadOffers = async () => {
      try {
        setLoading(true);
        const data = await getRefinanceOffers(appState.user.id);
        
        if (!data.financing_needed) {
          // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ "–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è"
          setOffers([]);
        } else {
          setOffers(data.offers);
        }
      } catch (err) {
        setError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è');
      } finally {
        setLoading(false);
      }
    };
    
    loadOffers();
  }, [appState.user.id]);
  
  const handleSubmitApplication = async () => {
    if (!selectedOffer) return;
    
    setApplicationStatus('pending');
    
    try {
      const result = await applyForRefinance(appState.user.id, selectedOffer);
      
      if (result.application_status === 'approved') {
        setApplicationStatus('approved');
      } else {
        setApplicationStatus('declined');
      }
    } catch (err) {
      setError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É');
      setApplicationStatus('idle');
    }
  };
  
  // ... –æ—Å—Ç–∞–ª—å–Ω–æ–π –∫–æ–¥ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π
}
```

---

### –ó–∞–¥–∞—á–∞ 1.3: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è Loans/Deposits Detail API (6 —á–∞—Å–æ–≤)

**–ü—Ä–æ–±–ª–µ–º–∞:** –≠–∫—Ä–∞–Ω—ã LoansDetailScreen –∏ DepositsDetailScreen –∏—Å–ø–æ–ª—å–∑—É—é—Ç mock –¥–∞–Ω–Ω—ã–µ

#### –®–∞–≥ 1.3.1: Backend - –ø–∞—Ä—Å–∏–Ω–≥ –∫—Ä–µ–¥–∏—Ç–æ–≤ –∏ –≤–∫–ª–∞–¥–æ–≤ (3 —á–∞—Å–∞)

**–°–æ–∑–¥–∞—Ç—å —Ñ–∞–π–ª:** `hktn/backend/routers/loans.py`

```python
from __future__ import annotations

import logging
from typing import Any, Dict, List

from fastapi import APIRouter, HTTPException

from hktn.core.database import find_approved_consents

from ..services.banking import fetch_bank_credits
from ..services.algorithms import (
    total_debt_calculation,
    mdp_calculation,
    adp_calculation,
    transactions_categorization_salary_and_loans,
)

router = APIRouter(prefix="/api", tags=["loans"])
logger = logging.getLogger("finpulse.backend.loans")


@router.get("/loans")
async def get_loans(user_id: str) -> Dict[str, Any]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π.
    
    –í–∫–ª—é—á–∞–µ—Ç:
    - –°–ø–∏—Å–æ–∫ –∫—Ä–µ–¥–∏—Ç–æ–≤ —Å –ø–æ–ª—è–º–∏: id, bank, type, balance, rate, monthly_payment, priority
    - –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏: total_outstanding, mdp, adp
    - –°—Ç—Ä–∞—Ç–µ–≥–∏—è –ø–æ–≥–∞—à–µ–Ω–∏—è
    """
    # 1. –ü–æ–ª—É—á–∏—Ç—å product consents
    product_consents = find_approved_consents(user_id, consent_type="products")
    if not product_consents:
        return {
            "status": "ok",
            "loans": [],
            "total_outstanding": 0.0,
            "mdp": 0.0,
            "adp": 0.0,
            "strategy": "avalanche",
        }
    
    # 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –∫—Ä–µ–¥–∏—Ç—ã –∏–∑ –≤—Å–µ—Ö –±–∞–Ω–∫–æ–≤
    all_credits = []
    for consent in product_consents:
        try:
            result = await fetch_bank_credits(
                consent.bank_id,
                consent.consent_id,
                user_id,
            )
            if result.get("status") == "ok":
                all_credits.extend(result.get("credits", []))
        except Exception as e:
            logger.error(f"Failed to fetch credits from {consent.bank_id}: {e}")
    
    # 3. –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∫—Ä–µ–¥–∏—Ç—ã (–Ω–µ –≤–∫–ª–∞–¥—ã)
    loans = []
    for credit in all_credits:
        product_type = credit.get("productType") or credit.get("product_type", "").lower()
        
        if any(keyword in product_type for keyword in ["loan", "credit", "mortgage", "–∫—Ä–µ–¥–∏—Ç", "–∏–ø–æ—Ç–µ–∫–∞"]):
            # –≠—Ç–æ –∫—Ä–µ–¥–∏—Ç
            loans.append(credit)
    
    # 4. –†–∞—Å—á–µ—Ç –¥–æ–ª–≥–∞ —á–µ—Ä–µ–∑ –∞–ª–≥–æ—Ä–∏—Ç–º
    debt_result = total_debt_calculation(loans)
    
    # 5. –†–∞—Å—á–µ—Ç MDP –∏ ADP
    # TODO: –ù—É–∂–Ω—ã —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –¥–ª—è categorization
    # –î–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ä–∞—Å—á–µ—Ç
    
    # 6. –†–∞–Ω–∂–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ (Avalanche)
    ranked_loans = sorted(
        debt_result["active_loans"],
        key=lambda l: (-l.get("interest_rate", 0), l.get("amount", 0))
    )
    
    # –ü—Ä–∏—Å–≤–æ–∏—Ç—å priority
    for idx, loan in enumerate(ranked_loans):
        loan["priority"] = idx + 1
    
    # 7. –§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞
    loans_list = []
    for loan in ranked_loans:
        # –ù–∞–π—Ç–∏ –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π credit –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        original = next(
            (c for c in loans if c.get("agreementId") == loan["agreement_id"]),
            None
        )
        
        loans_list.append({
            "id": loan["agreement_id"],
            "bank": original.get("bank") or "Unknown Bank",
            "type": original.get("productType") or original.get("product_type") or "Loan",
            "balance": loan["amount"],
            "rate": loan["interest_rate"],
            "monthly_payment": original.get("monthlyPayment") or original.get("monthly_payment") or loan["amount"] * 0.02,
            "maturity_date": original.get("maturityDate") or original.get("maturity_date") or "2026-12-31",
            "priority": loan["priority"],
        })
    
    return {
        "status": "ok",
        "loans": loans_list,
        "total_outstanding": debt_result["total_debt_base"],
        "mdp": 0.0,  # TODO: Real calculation
        "adp": 0.0,  # TODO: Real calculation
        "strategy": "avalanche",
    }


@router.get("/deposits")
async def get_deposits(user_id: str) -> Dict[str, Any]:
    """
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–≤/–¥–µ–ø–æ–∑–∏—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    
    –í–∫–ª—é—á–∞–µ—Ç:
    - –°–ø–∏—Å–æ–∫ –¥–µ–ø–æ–∑–∏—Ç–æ–≤ —Å –ø–æ–ª—è–º–∏: id, bank, type, balance, rate, term_months
    - –û–±—â–∏–µ –º–µ—Ç—Ä–∏–∫–∏: total_saved, sdp, target, progress
    """
    # 1. –ü–æ–ª—É—á–∏—Ç—å product consents
    product_consents = find_approved_consents(user_id, consent_type="products")
    if not product_consents:
        return {
            "status": "ok",
            "deposits": [],
            "total_saved": 0.0,
            "sdp": 0.0,
            "target": 0.0,
            "progress_percent": 0.0,
        }
    
    # 2. –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –ø—Ä–æ–¥—É–∫—Ç—ã
    all_products = []
    for consent in product_consents:
        try:
            result = await fetch_bank_credits(
                consent.bank_id,
                consent.consent_id,
                user_id,
            )
            if result.get("status") == "ok":
                all_products.extend(result.get("credits", []))
        except Exception as e:
            logger.error(f"Failed to fetch products from {consent.bank_id}: {e}")
    
    # 3. –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–µ–ø–æ–∑–∏—Ç—ã
    deposits = []
    total_saved = 0.0
    
    for product in all_products:
        product_type = product.get("productType") or product.get("product_type", "").lower()
        
        if any(keyword in product_type for keyword in ["deposit", "savings", "–≤–∫–ª–∞–¥", "–Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω"]):
            balance = float(product.get("balance") or product.get("currentBalance") or product.get("amount") or 0)
            
            deposits.append({
                "id": product.get("agreementId") or product.get("agreement_id"),
                "bank": product.get("bank") or "Unknown Bank",
                "type": product.get("productType") or product.get("product_type") or "Deposit",
                "balance": balance,
                "rate": float(product.get("interestRate") or product.get("interest_rate") or 0),
                "term_months": int(product.get("termMonths") or product.get("term_months") or 12),
            })
            
            total_saved += balance
    
    # 4. –†–∞—Å—á–µ—Ç SDP (Savings Daily Payment)
    # TODO: –ù—É–∂–Ω—ã –¥–∞–Ω–Ω—ã–µ –æ —Ü–µ–ª–∏ –∏–∑ user_financial_inputs
    sdp = 500.0  # Fallback
    
    return {
        "status": "ok",
        "deposits": deposits,
        "total_saved": round(total_saved, 2),
        "sdp": sdp,
        "target": 100000.0,  # TODO: From user_financial_inputs
        "progress_percent": round((total_saved / 100000.0) * 100, 2),
    }
```

**–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Ä–æ—É—Ç–µ—Ä:**

**–§–∞–π–ª:** `hktn/backend/app.py`

```python
from .routers import analytics, banks, consents, auth, payments, onboarding, refinance, loans

# ...

app.include_router(loans.router)
```

---

#### –®–∞–≥ 1.3.2: Frontend –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è (3 —á–∞—Å–∞)

**–§–∞–π–ª:** `hktn/src/utils/api.ts`

**–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–∏:**

```typescript
export interface Loan {
  id: string;
  bank: string;
  type: string;
  balance: number;
  rate: number;
  monthly_payment: number;
  maturity_date: string;
  priority: number;
}

export interface LoansResponse {
  status: 'ok';
  loans: Loan[];
  total_outstanding: number;
  mdp: number;
  adp: number;
  strategy: 'avalanche' | 'snowball';
}

export async function getLoans(userId: string): Promise<LoansResponse> {
  const response = await fetch(`${API_BASE_URL}/api/loans?user_id=${userId}`);
  if (!response.ok) {
    throw new Error('Failed to fetch loans');
  }
  return response.json();
}

export interface Deposit {
  id: string;
  bank: string;
  type: string;
  balance: number;
  rate: number;
  term_months: number;
}

export interface DepositsResponse {
  status: 'ok';
  deposits: Deposit[];
  total_saved: number;
  sdp: number;
  target: number;
  progress_percent: number;
}

export async function getDeposits(userId: string): Promise<DepositsResponse> {
  const response = await fetch(`${API_BASE_URL}/api/deposits?user_id=${userId}`);
  if (!response.ok) {
    throw new Error('Failed to fetch deposits');
  }
  return response.json();
}
```

**–§–∞–π–ª:** `hktn/src/screens/LoansDetailScreen.tsx`

**–ó–∞–º–µ–Ω–∏—Ç—å mock –¥–∞–Ω–Ω—ã–µ:**

```typescript
import { useEffect, useState } from 'react';
import { getLoans, type Loan } from '../utils/api';

export function LoansDetailScreen({ appState, onBack, onPayment }: LoansDetailScreenProps) {
  const [loans, setLoans] = useState<Loan[]>([]);
  const [loading, setLoading] = useState(true);
  const [totalOutstanding, setTotalOutstanding] = useState(0);
  const [mdp, setMdp] = useState(0);
  const [adp, setAdp] = useState(0);
  
  useEffect(() => {
    const loadLoans = async () => {
      try {
        setLoading(true);
        const data = await getLoans(appState.user.id);
        
        setLoans(data.loans);
        setTotalOutstanding(data.total_outstanding);
        setMdp(data.mdp);
        setAdp(data.adp);
      } catch (err) {
        console.error('Failed to load loans:', err);
      } finally {
        setLoading(false);
      }
    };
    
    loadLoans();
  }, [appState.user.id]);
  
  if (loading) {
    return <div>–ó–∞–≥—Ä—É–∑–∫–∞...</div>;
  }
  
  return (
    <div>
      {/* Summary */}
      <div>
        <div>–û–±—â–∏–π –¥–æ–ª–≥</div>
        <div>{formatCurrency(totalOutstanding)}</div>
        
        <div>
          <button onClick={() => onPayment('mdp')}>
            –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π: {formatCurrency(mdp)}
          </button>
          
          <button onClick={() => onPayment('adp')}>
            –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π: {formatCurrency(adp)}
          </button>
        </div>
      </div>
      
      {/* Loans list */}
      <div>
        {loans.map((loan) => (
          <div key={loan.id}>
            <div>{loan.bank}</div>
            <div>{loan.type}</div>
            <div>–û—Å—Ç–∞—Ç–æ–∫: {formatCurrency(loan.balance)}</div>
            <div>–°—Ç–∞–≤–∫–∞: {loan.rate}%</div>
            <div>–ü–ª–∞—Ç–µ–∂: {formatCurrency(loan.monthly_payment)}</div>
            <div>–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç: {loan.priority}</div>
          </div>
        ))}
      </div>
    </div>
  );
}
```

**–ê–Ω–∞–ª–æ–≥–∏—á–Ω–æ –¥–ª—è DepositsDetailScreen**

---

## üü† –ü–†–ò–û–†–ò–¢–ï–¢ 2: –í—ã—Å–æ–∫–∏–π (4-6 —á–∞—Å–æ–≤)

### –ó–∞–¥–∞—á–∞ 2.1: Goal Selection - –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ "–ó–∞–∫—Ä—ã—Ç—å –∫—Ä–µ–¥–∏—Ç—ã" (2 —á–∞—Å–∞)

**–§–∞–π–ª:** `hktn/src/components/steps/Step5Questions.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```typescript
import { useEffect, useState } from 'react';
import { getLoans } from '../../utils/api';

export function Step5Questions({ onNext, onBack, initialGoals, userId }) {
  const [hasLoans, setHasLoans] = useState(false);
  const [loadingLoans, setLoadingLoans] = useState(true);
  
  useEffect(() => {
    const checkLoans = async () => {
      try {
        setLoadingLoans(true);
        const data = await getLoans(userId);
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤
        setHasLoans(data.loans.length > 0);
      } catch (err) {
        console.error('Failed to check loans:', err);
        // Fallback: —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—ã–±—Ä–∞—Ç—å –ª—é–±–æ–π —Ä–µ–∂–∏–º
        setHasLoans(true);
      } finally {
        setLoadingLoans(false);
      }
    };
    
    checkLoans();
  }, [userId]);
  
  if (loadingLoans) {
    return <div>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ü–µ–ª–µ–π...</div>;
  }
  
  return (
    <div>
      <h2>–í—ã–±–µ—Ä–∏—Ç–µ –≤–∞—à—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤—É—é —Ü–µ–ª—å</h2>
      
      {/* –ó–∞–∫—Ä—ã—Ç—å –∫—Ä–µ–¥–∏—Ç—ã */}
      <button
        onClick={() => selectGoal('close_loans')}
        disabled={!hasLoans}
        className={!hasLoans ? 'opacity-50 cursor-not-allowed' : ''}
      >
        <div>–ó–∞–∫—Ä—ã—Ç—å –∫—Ä–µ–¥–∏—Ç—ã</div>
        {!hasLoans && (
          <div className="text-xs text-red-600 mt-2">
            –£ –≤–∞—Å –Ω–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤
          </div>
        )}
      </button>
      
      {/* –ù–∞–∫–æ–ø–∏—Ç—å –¥–µ–Ω—å–≥–∏ */}
      <button onClick={() => selectGoal('save_money')}>
        <div>–ù–∞–∫–æ–ø–∏—Ç—å –Ω–∞ —Ü–µ–ª—å</div>
      </button>
    </div>
  );
}
```

---

### –ó–∞–¥–∞—á–∞ 2.2: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ repayment_speed (1 —á–∞—Å)

**–§–∞–π–ª:** `hktn/src/components/steps/Step5Questions.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```typescript
const handleNext = async () => {
  // –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
  await fetch('/api/onboarding/save-financial-inputs', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      user_id: userId,
      repayment_speed: selectedSpeed,  // 'conservative' | 'balanced' | 'fast'
      repayment_strategy: 'avalanche',  // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
      // ... –¥—Ä—É–≥–∏–µ –ø–æ–ª—è
    }),
  });
  
  onNext({
    mode: selectedMode,
    speed: selectedSpeed,
    // ...
  });
};
```

**–§–∞–π–ª:** `hktn/backend/services/onboarding.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**

```python
async def save_financial_inputs(req: FinancialInputsRequest) -> Dict[str, Any]:
    """–°–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è."""
    # ... —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥ ...
    
    # –î–û–ë–ê–í–ò–¢–¨: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ repayment_speed –∏ repayment_strategy
    set_user_financial_inputs(
        user_id=req.user_id,
        salary_amount=req.salary_amount,
        next_salary_date=req.next_salary_date,
        credit_payment_amount=req.credit_payment_amount,
        credit_payment_date=req.credit_payment_date,
        repayment_speed=req.repayment_speed,  # –ù–û–í–û–ï
        repayment_strategy=req.repayment_strategy,  # –ù–û–í–û–ï
    )
    
    # ...
```

---

### –ó–∞–¥–∞—á–∞ 2.3: Health Score reasons (2 —á–∞—Å–∞)

**–§–∞–π–ª:** `hktn/backend/services/analytics.py`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ `_calculate_health_score()`:**

```python
def _calculate_health_score(
    total_balance: float,
    total_credit_debt: float,
    monthly_income: float,
    monthly_expenses: float,
) -> Dict[str, Any]:
    """–í—ã—á–∏—Å–ª—è–µ—Ç –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–≥–æ –∑–¥–æ—Ä–æ–≤—å—è (0-100)."""
    score = 50.0
    reasons = []
    
    # –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞ –∫ –±–∞–ª–∞–Ω—Å—É
    if total_balance > 0:
        debt_ratio = total_credit_debt / total_balance
        if debt_ratio < 0.5:
            score += 20
            reasons.append("–î–æ–ª–≥ –º–µ–Ω—å—à–µ –ø–æ–ª–æ–≤–∏–Ω—ã –≤–∞—à–∏—Ö –∞–∫—Ç–∏–≤–æ–≤")
        elif debt_ratio < 1.0:
            score += 10
            reasons.append("–î–æ–ª–≥ –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º")
        elif debt_ratio > 2.0:
            score -= 20
            reasons.append("‚ö†Ô∏è –î–æ–ª–≥ –ø—Ä–µ–≤—ã—à–∞–µ—Ç –∞–∫—Ç–∏–≤—ã –≤ 2 —Ä–∞–∑–∞")
    
    # –°–æ–æ—Ç–Ω–æ—à–µ–Ω–∏–µ —Ä–∞—Å—Ö–æ–¥–æ–≤ –∫ –¥–æ—Ö–æ–¥–∞–º
    if monthly_income > 0:
        expense_ratio = monthly_expenses / monthly_income
        if expense_ratio < 0.7:
            score += 20
            reasons.append("–†–∞—Å—Ö–æ–¥—ã –º–µ–Ω—å—à–µ 70% –¥–æ—Ö–æ–¥–∞")
        elif expense_ratio < 0.9:
            score += 10
            reasons.append("–†–∞—Å—Ö–æ–¥—ã –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º")
        elif expense_ratio > 1.0:
            score -= 20
            reasons.append("‚ö†Ô∏è –†–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç –¥–æ—Ö–æ–¥—ã")
    
    # STS –ø—Ä–æ–≤–µ—Ä–∫–∞
    # TODO: –ü–µ—Ä–µ–¥–∞–≤–∞—Ç—å STS –∫–∞–∫ –ø–∞—Ä–∞–º–µ—Ç—Ä
    
    score = max(0.0, min(100.0, score))
    
    if score >= 75:
        status = "excellent"
    elif score >= 60:
        status = "good"
    elif score >= 40:
        status = "fair"
    else:
        status = "poor"
    
    return {
        "value": round(score, 1),
        "status": status,
        "reasons": reasons,  # –ù–û–í–û–ï
    }
```

---

## ‚è±Ô∏è –ò—Ç–æ–≥–æ–≤—ã–π —Ç–∞–π–º–ª–∞–π–Ω

### –°–ø—Ä–∏–Ω—Ç 1: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –±–∞–≥–∏ (–î–µ–Ω—å 1-2, 14-20 —á–∞—Å–æ–≤)

| –ó–∞–¥–∞—á–∞ | –í—Ä–µ–º—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|--------|-------|-----------|
| 1.1 Consent Flow | 6 —á | üî¥ |
| 1.2 Refinancing API | 8 —á | üî¥ |
| 1.3 Loans/Deposits API | 6 —á | üî¥ |

### –°–ø—Ä–∏–Ω—Ç 2: –£–ª—É—á—à–µ–Ω–∏—è (–î–µ–Ω—å 3, 4-6 —á–∞—Å–æ–≤)

| –ó–∞–¥–∞—á–∞ | –í—Ä–µ–º—è | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|--------|-------|-----------|
| 2.1 Goal Selection –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ | 2 —á | üü† |
| 2.2 Repayment Speed | 1 —á | üü† |
| 2.3 Health Reasons | 2 —á | üü† |

---

## ‚úÖ –ö—Ä–∏—Ç–µ—Ä–∏–∏ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏

### –î–ª—è —Ö–∞–∫–∞—Ç–æ–Ω–∞ (–º–∏–Ω–∏–º—É–º):
- [x] –û–Ω–±–æ—Ä–¥–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (—Å—Å—ã–ª–∫–∞ –Ω–∞ –±–∞–Ω–∫, polling)
- [x] Refinancing –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –æ—Ñ—Ñ–µ—Ä—ã
- [x] Loans/Deposits Detail –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
- [x] Goal Selection –±–ª–æ–∫–∏—Ä—É–µ—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã–µ —Ä–µ–∂–∏–º—ã

### –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ (–∂–µ–ª–∞—Ç–µ–ª—å–Ω–æ):
- [x] Health Score —Å reasons
- [x] Repayment Speed —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î
- [ ] Profile Screen (–º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ù–∞—á–∞—Ç—å —Å –ó–∞–¥–∞—á–∏ 1.1** - —Å–∞–º–∞—è –∫—Ä–∏—Ç–∏—á–Ω–∞—è –¥–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏—è —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
2. **–ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ –¥–µ–ª–∞—Ç—å 1.2 –∏ 1.3** - –º–æ–∂–Ω–æ —Ä–∞–∑–¥–µ–ª–∏—Ç—å –º–µ–∂–¥—É —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞–º–∏
3. **–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö** - –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ —É–ª—É—á—à–µ–Ω–∏—è–º

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ü–æ–ª–Ω–æ—Ü–µ–Ω–Ω—ã–π MVP, –≥–æ—Ç–æ–≤—ã–π –∫ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–∞ —Ö–∞–∫–∞—Ç–æ–Ω–µ —á–µ—Ä–µ–∑ 18-26 —á–∞—Å–æ–≤ —Ä–∞–±–æ—Ç—ã.

