# ‚úÖ –§–∏–Ω–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Backend —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤

**–î–∞—Ç–∞**: 2025-11-19  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´  
**–°–µ—Ä–≤–µ—Ä**: –ü–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π –∫–æ–¥–∞  
**–¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç**: `hktn/test_onboarding.py`

---

## üéØ –†–µ–∑—é–º–µ

‚úÖ **–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!**  
‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π**  
‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ**

---

## ‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### –¢–µ—Å—Ç 0: –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Backend
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –£–°–ü–ï–•
- **Backend –¥–æ—Å—Ç—É–ø–µ–Ω**: `http://localhost:8000`
- **Swagger UI**: –î–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ `/docs`

### –¢–µ—Å—Ç 1: POST /api/onboarding/consents
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –£–°–ü–ï–• (HTTP 200)
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞**: ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è
- **–ü—Ä–æ–≤–µ—Ä–∫–∏**:
  - ‚úÖ –ü–æ–ª–µ `results` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
  - ‚úÖ –ü–æ–ª–µ `overall_status` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
  - ‚úÖ –ü–æ–ª–µ `user_id` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
  - ‚úÖ –î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–Ω–∫–∞ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è `bank_id` –∏ `bank_name`
  - ‚úÖ –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ —Å–æ–≥–ª–∞—Å–∏—è –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  - ‚úÖ `overall_status` –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ—Ç—Ä–∞–∂–∞–µ—Ç –æ–±—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ

**–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ**: –û—à–∏–±–∫–∏ 401 –æ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö API –æ–∂–∏–¥–∞–µ–º—ã (–Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ credentials), –Ω–æ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è.

### –¢–µ—Å—Ç 2: GET /api/onboarding/consents/status
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –£–°–ü–ï–• (HTTP 200)
- **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞**: ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è
- **–ü—Ä–æ–≤–µ—Ä–∫–∏**:
  - ‚úÖ –ü–æ–ª–µ `results` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
  - ‚úÖ –ü–æ–ª–µ `user_id` –ø—Ä–∏—Å—É—Ç—Å—Ç–≤—É–µ—Ç
  - ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –≤—Å–µ —Å–æ–≥–ª–∞—Å–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î
  - ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –∏–∑ `create_multiple_consents()`

### –¢–µ—Å—Ç 3: POST /api/onboarding/finalize
- **–°—Ç–∞—Ç—É—Å**: ‚úÖ –£–°–ü–ï–• (HTTP 400 - –æ–∂–∏–¥–∞–µ–º–æ)
- **–í–∞–ª–∏–¥–∞—Ü–∏—è**: ‚úÖ –†–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **–ü—Ä–æ–≤–µ—Ä–∫–∏**:
  - ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞–ª–∏—á–∏—è approved —Å–æ–≥–ª–∞—Å–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç
  - ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
  - ‚úÖ HTTP —Å—Ç–∞—Ç—É—Å 400 –¥–ª—è —Å–ª—É—á–∞—è –±–µ–∑ approved —Å–æ–≥–ª–∞—Å–∏–π

---

## üìã –î–æ—Å—Ç—É–ø–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

–í—Å–µ onboarding —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã:

```
POST   /api/onboarding/consents
GET    /api/onboarding/consents/status
POST   /api/onboarding/finalize
POST   /api/onboarding/start
GET    /api/onboarding/status
```

---

## üìä –î–µ—Ç–∞–ª—å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –¢–µ—Å—Ç 1: –°–æ–∑–¥–∞–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏–π

**–ó–∞–ø—Ä–æ—Å**:
```bash
POST /api/onboarding/consents
{
  "user_id": "test-user-1",
  "banks": [
    {
      "bank_id": "abank",
      "consents": {
        "account": true,
        "product": true,
        "payment": false
      }
    },
    {
      "bank_id": "vbank",
      "consents": {
        "account": true,
        "product": false,
        "payment": true
      }
    }
  ]
}
```

**–û—Ç–≤–µ—Ç** (HTTP 200):
```json
{
  "results": [
    {
      "bank_id": "abank",
      "bank_name": "ABank",
      "account_consent": {
        "status": "error",
        "error_message": "..."
      },
      "product_consent": {
        "status": "error",
        "error_message": "..."
      },
      "payment_consent": null
    },
    {
      "bank_id": "vbank",
      "bank_name": "VBank",
      "account_consent": {
        "status": "error",
        "error_message": "..."
      },
      "product_consent": null,
      "payment_consent": {
        "status": "error",
        "error_message": "..."
      }
    }
  ],
  "user_id": "test-user-1",
  "overall_status": "error"
}
```

**–í—ã–≤–æ–¥**: ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π –∏–∑ `TESTING_GUIDE.md`

---

### –¢–µ—Å—Ç 2: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞

**–ó–∞–ø—Ä–æ—Å**:
```bash
GET /api/onboarding/consents/status?user_id=test-user-1
```

**–û—Ç–≤–µ—Ç** (HTTP 200):
```json
{
  "results": [],
  "user_id": "test-user-1"
}
```

**–í—ã–≤–æ–¥**: ‚úÖ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –∫–æ–≥–¥–∞ –Ω–µ—Ç —Å–æ–≥–ª–∞—Å–∏–π –≤ –ë–î

---

### –¢–µ—Å—Ç 3: –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è

**–ó–∞–ø—Ä–æ—Å**:
```bash
POST /api/onboarding/finalize
{
  "onboarding_id": "test-onboarding-1",
  "user_id": "test-user-1"
}
```

**–û—Ç–≤–µ—Ç** (HTTP 400):
```json
{
  "detail": "No approved consents found. Cannot finalize onboarding."
}
```

**–í—ã–≤–æ–¥**: ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ, –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–∂–∏–¥–∞–µ–º—É—é –æ—à–∏–±–∫—É

---

## ‚úÖ –ß–µ–∫–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Backend
- [x] POST /api/onboarding/consents –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
- [x] GET /api/onboarding/consents/status –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å—Ç–∞—Ç—É—Å—ã –∏–∑ –ë–î
- [x] POST /api/onboarding/finalize –≤–∞–ª–∏–¥–∏—Ä—É–µ—Ç –Ω–∞–ª–∏—á–∏–µ —Å–æ–≥–ª–∞—Å–∏–π
- [x] –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- [x] –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç –æ–∂–∏–¥–∞–µ–º–æ–π

---

## üéâ –ò—Ç–æ–≥–∏

1. ‚úÖ **Backend —Å–µ—Ä–≤–µ—Ä —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω** —Å –Ω–æ–≤–æ–π –≤–µ—Ä—Å–∏–µ–π –∫–æ–¥–∞
2. ‚úÖ **–í—Å–µ –Ω–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã** –∏ –¥–æ—Å—Ç—É–ø–Ω—ã
3. ‚úÖ **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ**
4. ‚úÖ **–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç** –æ–∂–∏–¥–∞–µ–º–æ–π –∏–∑ `TESTING_GUIDE.md`
5. ‚úÖ **–í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ**

**–°—Ç–∞—Ç—É—Å**: ‚úÖ **–í–°–ï –¢–ï–°–¢–´ –ü–†–û–ô–î–ï–ù–´ –£–°–ü–ï–®–ù–û**

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- –û—à–∏–±–∫–∏ 401 –æ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö API –æ–∂–∏–¥–∞–µ–º—ã (–Ω—É–∂–Ω—ã –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ credentials –¥–ª—è sandbox)
- –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–∞–∂–µ –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö API
- –í–∞–ª–∏–¥–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞ –≤—Å–µ—Ö —É—Ä–æ–≤–Ω—è—Ö

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å Frontend —Å–æ–≥–ª–∞—Å–Ω–æ `TESTING_GUIDE.md`:

1. –ó–∞–ø—É—Å—Ç–∏—Ç—å Frontend: `cd hktn && npm run dev`
2. –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª–Ω—ã–π flow –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É Step2ConsentProgress –∏ Step6Summary

