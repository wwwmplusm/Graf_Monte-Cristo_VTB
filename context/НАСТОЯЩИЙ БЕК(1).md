# Бекенд

| Название модуля | Описание модуля | Взаимодействие с фронтендом | Взаимодействие с OpenBanking API | Взаимодействие с БД |
| --- | --- | --- | --- | --- |
| **Auth & UserService** | Отвечает за регистрацию/логин пользователя, хранит маппинг между внутренним `user_id` и внешним `client_id` (типа `team260-3`), который подставляется в запросы к банкам. | Эндпоинты: `POST /api/auth/register`, `POST /api/auth/login`, `GET /api/auth/me`. Возвращает `user_id` и минимальный профайл, который фронт дальше использует для всех остальных запросов. | Напрямую с OpenBanking не общается. Используется другими модулями (например, OnboardingService), чтобы узнать правильный `client_id` для запросов в банки. | Таблицы: `users` (id, external_client_id, email/phone, created_at, last_login и т.п.). |
| **OnboardingService** | Управляет всем сценарием онбординга: выбор банков, запуск подключения, отслеживание шагов и статусов, разрешает переход на главный экран. | Эндпоинты: `POST /api/onboarding/start`, `GET /api/onboarding/status`, `POST /api/banks/{bank_code}/connect`, `POST /api/banks/{bank_code}/sync`. Фронт показывает прогресс по шагам и статусам. | Напрямую к OpenBanking не ходит. Делегирует работу с банками в `ConsentService`, `BankConnectionService`, `SyncService`. | Таблицы: `onboarding_flows` (текущий шаг, завершён/нет), опирается на `bank_connections`, `consents`, чтобы показать статусы по банкам. |
| **BankConnectionService** | Модель «подключения банка» к пользователю: какие банки привязаны, с каким статусом (`not_connected / consent_pending / sync_in_progress / ready / error`). | Эндпоинты: `GET /api/banks` — фронт получает список банков и их статусы; может дополнительно быть `GET /api/banks/{bank_code}/status`. | Сам к OpenBanking не ходит. Использует результаты `ConsentService` и `SyncService` (успешно/ошибка) для обновления статусов коннектов. | Таблица: `bank_connections` (user_id, bank_code, status, last_sync_at, last_error). Служит источником правды для UI. |
| **ConsentService** | Управляет жизненным циклом согласий (consent) для аккаунтов и продуктов: создание, опрос статуса, хранение `consent_id`/`status`. | Эндпоинты: может быть `GET /api/consents` (для дебага/админки); для фронта обычно не торчит, используется внутри `OnboardingService` и `SyncService`. | Через соответствующий `BankClient` вызывает: `POST /account-consents/request`, `GET /account-consents/{id}`, аналогично для `product-consents`. Проставляет `Authorization: Bearer <bank_token>`, `X-Requesting-Bank: team260`, тело с `client_id` и `permissions`. | Таблица: `consents` (id, user_id, bank_code, type: accounts/products, bank_consent_id, status, permissions, created_at, updated_at, raw_response JSON). |
| **BankTokenService** | Получает и кэширует `bank-token` для каждого банка (VBank, ABank, SBank) по твоим `CLIENT_ID`/`CLIENT_SECRET`, следит за `expires_in`. | Не взаимодействует напрямую с фронтендом. Используется всеми клиентами к банкам при каждом запросе, чтобы не дёргать авторизацию лишний раз. | Вызывает `POST /oauth2/token` (или аналогичный эндпоинт банка/песочницы) для получения `access_token`. Кэширует токен, учитывая TTL (например, 24 часа). | Таблица: `bank_tokens` (bank_code, access_token, expires_at, last_refreshed_at). В памяти может храниться LRU-кэш, но БД даёт пережить рестарт. |
| **BankClient (VBankClient / ABankClient / SBankClient)** | Низкоуровневые HTTP-клиенты для каждого банка. Инкапсулируют детали URL, хедеров, схемы ответов. | Не вызывается фронтом напрямую. Используется сервисами: `ConsentService`, `SyncService`, `AccountsService`, `ProductsService`. | Ходит во все необходимые эндпоинты конкретного банка: `POST /account-consents/request`, `GET /accounts`, `GET /accounts/{id}/balances`, `GET /accounts/{id}/transactions`, `GET /products` и т.п. Проставляет: `Authorization: Bearer <bank_token>`, `X-Requesting-Bank: team260`, иногда `X-Consent-Id` и `client_id` как query/body. | Напрямую в БД не пишет. Возвращает нормализованные DTO, которые дальше сохраняются через репозитории (`AccountsRepository`, `TransactionsRepository` и т.д.). |
| **SyncService (Data Sync Orchestrator)** | Оркестратор синхронизации данных с банками. Для каждого `BankConnection` делает: загрузку аккаунтов, балансов, транзакций, продуктов, обновление статусов и запуск аналитики. | Эндпоинты: косвенно через `POST /api/banks/{bank_code}/sync` и `GET /api/onboarding/status`. Фронт видит прогресс (`sync_in_progress`, проценты, ошибки). | Через `BankClient` по шагам: 1) `get_accounts`, 2) `get_account_balances`, 3) `get_account_transactions` (с `from_date` = последняя транзакция в БД), 4) `get_products`. Учитывает лимиты и ошибки, реализует ретраи. | Записывает в БД: `accounts`, `balance_snapshots`, `transactions`, `product_agreements`. Обновляет `bank_connections.status`, пишет в `raw_api_logs` сырой ответ для аудита. После успеха вызывает `AnalyticsService` для пересчёта метрик. |
| **AccountsService** | Отвечает за работу с аккаунтами и балансами: нормализация ответов по счетам, выбор «активных» счетов, агрегирование общих остатков по пользователю. | Эндпоинты: `GET /api/accounts` (список счетов + текущие балансы), может использоваться главным экраном или отдельным разделом. | Напрямую с OpenBanking обычно не ходит (это делает SyncService + BankClient). Может иметь методы «форс-обновление балансов», которые через `SyncService` инициируют свежий запрос к `/accounts/{id}/balances`. | Читает: `accounts`, `balance_snapshots`. Пишет: новые записи при синхронизации (в связке с SyncService). Может хранить агрегаты в `account_summaries` для быстрого ответа фронту. |
| **TransactionsService** | Работа с историей транзакций: сохранение, выдача выборок, агрегации (по дням, категориям), подготовка данных для аналитики (доходы/расходы, кэшфлоу). | Эндпоинты: `GET /api/transactions?from=&to=&account_id=`, `GET /api/transactions/summary?period=30d` и т.п. Фронт может показывать историю или короткие срезы (последние операции, расходы по категориям). | Как правило, не ходит напрямую в OpenBanking. Получает новые транзакции через `SyncService` (который обращается к `/accounts/{id}/transactions`) и только сохраняет/обрабатывает их внутри. | Таблицы: `transactions` (id, account_id, amount, currency, dates, merchant, category, raw JSON), возможно `transaction_categories`, `transaction_aggregates` (подготовленные суммы по периодам для быстрого ответа). |
| **ProductsService / CreditAgreementsService** | Управляет банковскими продуктами и кредитными договорами: хранит основную информацию по долгам, графикам платежей, ставкам, лимитам и т.д. | Эндпоинты: `GET /api/products`, `GET /api/debts`, `GET /api/debts/next-payment`. Главный экран использует это для блока «кредиты/долги» и «ближайший платёж». | Через `BankClient` получает список продуктов и договоров (`GET /product-agreements` или аналогичные эндпоинты, зависящие от конкретного банка). Проставляет нужные хедеры/параметры так же, как при работе со счетами. | Таблицы: `product_agreements` (user_id, bank_code, type, principal, interest_rate, payment_schedule JSON, next_payment_date/amount). Используется `AnalyticsService` для расчёта долговой нагрузки. |
| **AnalyticsService (STS & Health Score)** | Считает все ключевые метрики: Save to Spend, коэффициент финансового здоровья, общая сумма долга, ближайшие платежи, прогноз кэшфлоу. | Напрямую фронтом не вызывается; фронт дергает `GET /api/dashboard`, а тот уже использует результат аналитики. Может быть `GET /api/analytics` для дебага/отдельного экрана. | С OpenBanking не взаимодействует. Работает только с данными, уже сохранёнными в БД (`transactions`, `accounts`, `product_agreements`). | Читает: `transactions`, `balance_snapshots`, `product_agreements`. Пишет результаты в `analytics_snapshots` (user_id, sts_amount, health_score, total_debt, next_payment_date/amount, created_at). Это кэш для быстрого ответа дашборда. |
| **DashboardService** | Собирает финальный JSON для главного экрана: метрики, список счетов, долги, ближайшие платежи, статусы банков. Делает один красивый ответ для фронта. | Эндпоинт: `GET /api/dashboard`. Фронт делает один запрос и получает всё, что нужно для главного экрана, без сотни мелких ручек. | С OpenBanking не общается напрямую. Работает поверх `AnalyticsService`, `AccountsService`, `ProductsService`, `BankConnectionService`. | Читает из БД через другие сервисы/репозитории: `analytics_snapshots`, `accounts`, `balance_snapshots`, `product_agreements`, `bank_connections`. Сам ничего не пишет, только агрегирует данные. |
| **RawApiLog / AuditService** | Логирует сырые ответы банков и важные события (создание согласий, ошибки синка). Нужен для дебага и чтобы красиво показать судьям «вот реальный JSON от банка и как мы его интерпретируем». | Фронт может иметь только админский/техэкран: `GET /api/admin/raw-logs?user_id=...` для разработчиков/судей (не для обычных юзеров). | Не инициирует запросы к OpenBanking. При каждом вызове `BankClient` получает копию request/response и сохраняет их в лог, обрезая чувствительные данные (токены, секреты). | Таблица: `raw_api_logs` (user_id, bank_code, endpoint, direction (request/response), payload (обрезанный JSON), created_at, correlation_id). Позволяет воспроизвести сценарии и объяснить поведение системы. |