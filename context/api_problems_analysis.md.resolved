# üîç –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º —Å Balances –∏ Product Agreements

## üìã –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

**–ü—Ä–æ–±–ª–µ–º–∞**: Balances –∏ Product Agreements –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 0, —Ö–æ—Ç—è –¥–∞–Ω–Ω—ã–µ **–ï–°–¢–¨** –≤ –±–∞–Ω–∫–µ.

**–ü—Ä–∏—á–∏–Ω–∞**: 3 –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ –ø–∞—Ä—Å–∏–Ω–≥–µ –æ—Ç–≤–µ—Ç–æ–≤ –æ—Ç –±–∞–Ω–∫–æ–≤—Å–∫–æ–≥–æ API:
1. ‚ùå **Case-sensitive –æ—à–∏–±–∫–∞** –≤ –ø–∞—Ä—Å–∏–Ω–≥–µ balances (`"Balance"` vs `"balance"`)
2. ‚ùå **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å** –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è accounts (`"accounts"` vs `"account"`)
3. ‚ùå **–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç Product Consent** –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤

---

## üî¨ –î–µ—Ç–∞–ª—å–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ

### –ü—Ä–æ–±–ª–µ–º–∞ 1: Balances –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 0

#### –ö–∞–∫ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø—Ä–æ—Å

**–§–∞–π–ª**: [/hktn/core/obr_client.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py)  
**–ú–µ—Ç–æ–¥**: [fetch_balances_with_consent()](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py#489-542)

**–®–∞–≥–∏ –∑–∞–ø—Ä–æ—Å–∞**:

```python
# –®–∞–≥ 1: –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ accounts
response = await self._client.get(
    f"/accounts?client_id={user_id}", 
    headers={
        "Authorization": f"Bearer {bank_token}",
        "X-Consent-Id": consent_id,
        "X-Requesting-Bank": team_id,
        "x-fapi-interaction-id": uuid
    }
)

# –®–∞–≥ 2: –î–ª—è –∫–∞–∂–¥–æ–≥–æ account –∑–∞–ø—Ä–æ—Å–∏—Ç—å balances
for account in accounts:
    account_id = self._extract_account_id(account)
    url = f"/accounts/{account_id}/balances"
    
    response = await self._client.get(url, headers=headers)
    entries = self._jget(balance_payload, ["data", "Balance"], [])  # ‚ùå –ü–†–û–ë–õ–ï–ú–ê!
```

#### –ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–Ω–∫ (—Ä–µ–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç)

**Request**:
```http
GET https://abank.open.bankingapi.ru/accounts/acc-3693/balances
Authorization: Bearer eyJhbG...
X-Requesting-Bank: team260
X-Consent-Id: consent-df8ab442621e
```

**Response**:
```json
{
  "data": {
    "balance": [              // ‚ö†Ô∏è –º–∞–ª–µ–Ω—å–∫–∞—è 'b'!
      {
        "accountId": "acc-3693",
        "type": "InterimAvailable",
        "dateTime": "2025-11-19T16:38:28.580766Z",
        "amount": {
          "amount": "264245.21",   // ‚úÖ –ë–∞–ª–∞–Ω—Å –ï–°–¢–¨!
          "currency": "RUB"
        },
        "creditDebitIndicator": "Credit"
      },
      {
        "accountId": "acc-3693",
        "type": "InterimBooked",
        "dateTime": "2025-11-19T16:38:28.580776Z",
        "amount": {
          "amount": "264245.21",
          "currency": "RUB"
        },
        "creditDebitIndicator": "Credit"
      }
    ]
  }
}
```

#### –ü—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** (—Å—Ç—Ä–æ–∫–∞ 525 –≤ [obr_client.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py)):
```python
entries = self._jget(balance_payload, ["data", "Balance"], [])
#                                               ^^^^^^^^
#                                           –ë–æ–ª—å—à–∞—è 'B' ‚ùå
```

**–ß—Ç–æ –∏—â–µ—Ç**: `balance_payload["data"]["Balance"]` (—Å –±–æ–ª—å—à–æ–π B)  
**–ß—Ç–æ –µ—Å—Ç—å –≤ –æ—Ç–≤–µ—Ç–µ**: `balance_payload["data"]["balance"]` (—Å –º–∞–ª–µ–Ω—å–∫–æ–π b)

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: `entries = []` (–ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫)

#### –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π

–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è OpenBanking Russia v2.1 –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **–º–∞–ª–µ–Ω—å–∫—É—é** `"balance"`:
```
Response Schema:
{
  "data": {
    "balance": [...]  // ‚úÖ lowercase
  }
}
```

---

### –ü—Ä–æ–±–ª–µ–º–∞ 2: Accounts –ø–∞—Ä—Å–∏–Ω–≥

#### –ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–Ω–∫

**Request**:
```http
GET https://abank.open.bankingapi.ru/accounts?client_id=team260-3
```

**Response**:
```json
{
  "data": {
    "account": [        // ‚ö†Ô∏è –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ —á–∏—Å–ª–æ!
      {
        "accountId": "acc-3693",
        "status": "Enabled",
        "currency": "RUB",
        "accountType": "Personal",
        "accountSubType": "Checking"
      }
    ]
  }
}
```

#### –ü—Ä–æ–±–ª–µ–º–∞ –≤ –∫–æ–¥–µ

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** –≤ [_extract_accounts()](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py#635-647) (—Å—Ç—Ä–æ–∫–∞ 635):
```python
@staticmethod
def _extract_accounts(payload: Any) -> List[Dict[str, Any]]:
    if isinstance(payload, dict):
        if isinstance(payload.get("accounts"), list):  # ‚úÖ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ
            return payload["accounts"]
        data = payload.get("data")
        if isinstance(data, dict):
            if isinstance(data.get("accounts"), list):  # ‚úÖ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–µ
                return data["accounts"]
            if isinstance(data.get("account"), list):   # ‚úÖ –µ–¥–∏–Ω—Å—Ç–≤–µ–Ω–Ω–æ–µ
                return data["account"]
    return []
```

**–≠—Ç–æ—Ç –∫–æ–¥ –ü–†–ê–í–ò–õ–¨–ù–´–ô!** –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ (`"accounts"` –∏ `"account"`).

**–ù–û**: –ü–æ—Ä—è–¥–æ–∫ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–∂–µ–Ω, –∏ –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è.

---

### –ü—Ä–æ–±–ª–µ–º–∞ 3: Product Agreements / Credits –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç 0

#### –ö–∞–∫ —Å–æ–∑–¥–∞—ë—Ç—Å—è –∑–∞–ø—Ä–æ—Å

**–§–∞–π–ª**: [/hktn/core/obr_client.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py)  
**–ú–µ—Ç–æ–¥**: [fetch_credits_with_consent()](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py#543-596)

**–®–∞–≥–∏ –∑–∞–ø—Ä–æ—Å–∞**:
```python
urls_to_try = ["/credits", "/product-agreements"]

headers_variations = [
    {"X-Product-Agreement-Consent-Id": consent_id},
    {"x-product-agreement-consent-id": consent_id},
    {"X-Consent-Id": consent_id},
]

for url in urls_to_try:
    for header_variant in headers_variations:
        response = await self._client.get(url, headers=headers, params={"client_id": user_id})
        # ...
```

#### –ß—Ç–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –±–∞–Ω–∫

**–ü–æ–ø—ã—Ç–∫–∞ 1**: `GET /credits` —Å `X-Product-Agreement-Consent-Id`
```http
GET https://abank.open.bankingapi.ru/credits?client_id=team260-3
X-Product-Agreement-Consent-Id: consent-df8ab442621e
```

**Response**: `404 Not Found` –∏–ª–∏ `403 Forbidden`

**–ü—Ä–∏—á–∏–Ω–∞**: `consent-df8ab442621e` —ç—Ç–æ **ACCOUNT consent**, –∞ –Ω–µ **PRODUCT consent**!

#### –ü—Ä–æ–±–ª–µ–º–∞ –≤ –ª–æ–≥–∏–∫–µ

**Account Consent** ‚â† **Product Consent**

–î–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤ –Ω—É–∂–Ω–æ:
1. –°–æ–∑–¥–∞—Ç—å **–æ—Ç–¥–µ–ª—å–Ω—ã–π Product Consent**: `POST /product-consents/request`
2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å **product_consent_id** –≤ –∑–∞–ø—Ä–æ—Å–µ –∫ `/credits`

**–¢–µ–∫—É—â–∏–π –∫–æ–¥** –∏—Å–ø–æ–ª—å–∑—É–µ—Ç **account_consent_id** –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤ ‚Üí –æ—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞.

---

## üìä –°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –û–∂–∏–¥–∞–µ–º–æ–µ vs –†–µ–∞–ª—å–Ω–æ–µ

### Balances

| –ê—Å–ø–µ–∫—Ç | –û–∂–∏–¥–∞–µ—Ç—Å—è –≤ –∫–æ–¥–µ | –†–µ–∞–ª—å–Ω–æ –æ—Ç –±–∞–Ω–∫–∞ | –°—Ç–∞—Ç—É—Å |
|--------|------------------|------------------|--------|
| –ü—É—Ç—å –∫ –¥–∞–Ω–Ω—ã–º | `data.Balance` | `data.balance` | ‚ùå –†–ê–°–•–û–ñ–î–ï–ù–ò–ï |
| –°—Ç—Ä—É–∫—Ç—É—Ä–∞ | Array of objects | Array of objects | ‚úÖ –û–ö |
| –ü–æ–ª—è [amount](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/services/banking.py#103-110) | `{ "amount": string, "currency": string }` | `{ "amount": string, "currency": string }` | ‚úÖ –û–ö |

### Accounts

| –ê—Å–ø–µ–∫—Ç | –û–∂–∏–¥–∞–µ—Ç—Å—è –≤ –∫–æ–¥–µ | –†–µ–∞–ª—å–Ω–æ –æ—Ç –±–∞–Ω–∫–∞ | –°—Ç–∞—Ç—É—Å |
|--------|------------------|------------------|--------|
| –ü—É—Ç—å (–≤–∞—Ä–∏–∞–Ω—Ç 1) | `data.accounts[]` | - | ‚ùå –ù–ï –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø |
| –ü—É—Ç—å (–≤–∞—Ä–∏–∞–Ω—Ç 2) | `data.account[]` | `data.account[]` | ‚úÖ –û–ö |
| –ö–æ–¥ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç –û–ë–ê | ‚úÖ –î–∞ | - | ‚úÖ –û–ö |

### Credits

| –ê—Å–ø–µ–∫—Ç | –û–∂–∏–¥–∞–µ—Ç—Å—è –≤ –∫–æ–¥–µ | –†–µ–∞–ª—å–Ω–æ –æ—Ç –±–∞–Ω–∫–∞ | –°—Ç–∞—Ç—É—Å |
|--------|------------------|------------------|--------|
| Consent type | Account consent | **Product consent** | ‚ùå –†–ê–°–•–û–ñ–î–ï–ù–ò–ï |
| Endpoint | `/credits` –∏–ª–∏ `/product-agreements` | `/product-agreements` | ‚ö†Ô∏è –ß–ê–°–¢–ò–ß–ù–û |
| –ó–∞–≥–æ–ª–æ–≤–æ–∫ | `X-Product-Agreement-Consent-Id` | `X-Product-Agreement-Consent-Id` | ‚úÖ –û–ö |

---

## üõ†Ô∏è –ü–ª–∞–Ω –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø–∞—Ä—Å–∏–Ω–≥ Balances (–ö–†–ò–¢–ò–ß–ù–û!)

**–§–∞–π–ª**: [/hktn/core/obr_client.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py)  
**–°—Ç—Ä–æ–∫–∞**: 525

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```python
entries = self._jget(balance_payload, ["data", "Balance"], [])
```

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
```python
# –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –æ–±–∞ –≤–∞—Ä–∏–∞–Ω—Ç–∞: —Å –±–æ–ª—å—à–æ–π –∏ –º–∞–ª–µ–Ω—å–∫–æ–π –±—É–∫–≤—ã
entries = (
    self._jget(balance_payload, ["data", "balance"], [])  # lowercase (–∏–∑ –±–∞–Ω–∫–∞)
    or self._jget(balance_payload, ["data", "Balance"], [])  # uppercase (fallback)
)
```

**–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–∞** (–±–æ–ª–µ–µ –Ω–∞–¥—ë–∂–Ω–∞—è):
```python
# –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –≥–∏–±–∫–æ–≥–æ –∏–∑–≤–ª–µ—á–µ–Ω–∏—è
@staticmethod
def _extract_balances(payload: Any) -> List[Dict[str, Any]]:
    """–ò–∑–≤–ª–µ–∫–∞–µ—Ç –±–∞–ª–∞–Ω—Å—ã –∏–∑ —Ä–∞–∑–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ—Ç–≤–µ—Ç–∞"""
    if not isinstance(payload, dict):
        return []
    
    # –í–∞—Ä–∏–∞–Ω—Ç 1: data.balance (lowercase)
    data = payload.get("data")
    if isinstance(data, dict):
        balance = data.get("balance")
        if isinstance(balance, list):
            return balance
        
        # –í–∞—Ä–∏–∞–Ω—Ç 2: data.Balance (uppercase)
        balance = data.get("Balance")
        if isinstance(balance, list):
            return balance
    
    # –í–∞—Ä–∏–∞–Ω—Ç 3: –ø—Ä—è–º–æ –≤ –∫–æ—Ä–Ω–µ
    balance = payload.get("balance") or payload.get("Balance")
    if isinstance(balance, list):
        return balance
    
    return []

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:
entries = self._extract_balances(balance_payload)
```

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 2: –î–æ–±–∞–≤–∏—Ç—å Product Consent Flow

**–ü—Ä–æ–±–ª–µ–º–∞**: –ù–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è product consent.

**–†–µ—à–µ–Ω–∏–µ**: –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å consent flow –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –û–ë–û–ò–• consents.

#### 2.1 –ò–∑–º–µ–Ω–∏—Ç—å [services/consents.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/services/consents.py)

**–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥**:
```python
async def initiate_full_consent_flow(req: ConsentInitiateRequest):
    """
    –°–æ–∑–¥–∞—ë—Ç –û–ë–ê consent: account + product
    """
    user_id = req.user_id
    bank_id = req.bank_id
    
    # 1. Account consent (–¥–ª—è —Å—á–µ—Ç–æ–≤, –±–∞–ª–∞–Ω—Å–æ–≤, —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π)
    account_result = await initiate_consent(req)
    
    # 2. –ï—Å–ª–∏ auto-approved, —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞—ë–º product consent
    if account_result.get("auto_approved"):
        try:
            logger.info("Creating product consent for user %s bank %s", user_id, bank_id)
            
            # –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –º–µ—Ç–æ–¥
            product_result = await initiate_product_consent(req)
            
            # –°–æ—Ö—Ä–∞–Ω—è–µ–º product consent –æ—Ç–¥–µ–ª—å–Ω–æ
            save_consent(
                user_id=user_id,
                bank_id=bank_id,
                consent_id=product_result.get("consent_id"),
                status="approved" if product_result.get("auto_approved") else "pending",
                consent_type="products"  # ‚ö†Ô∏è –û—Ç–¥–µ–ª—å–Ω—ã–π —Ç–∏–ø!
            )
            
            logger.info("Product consent created: %s", product_result.get("consent_id"))
            
        except Exception as e:
            logger.warning("Product consent failed (non-critical): %s", e)
            # –ù–ï –ø–∞–¥–∞–µ–º! Account consent —É–∂–µ –µ—Å—Ç—å
    
    return account_result
```

#### 2.2 –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ `/api/consent/initiate`

**–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ—É—Ç–µ—Ä**:
```python
@router.post("/consent/initiate")
async def initiate_consent_endpoint(req: ConsentInitiateRequest):
    # –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≤–º–µ—Å—Ç–æ —Å—Ç–∞—Ä–æ–≥–æ
    return await initiate_full_consent_flow(req)
```

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 3: –£–ª—É—á—à–∏—Ç—å –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ Product Consent ID

**–§–∞–π–ª**: [/hktn/backend/services/banking.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/services/banking.py)  
**–ú–µ—Ç–æ–¥**: [fetch_bank_credits()](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/services/banking.py#202-236)

**–¢–µ–∫—É—â–∏–π –∫–æ–¥**:
```python
async def fetch_bank_credits(..., create_product_consent: bool = False):
    prod_consent_id = consent_id  # ‚ùå –ò—Å–ø–æ–ª—å–∑—É–µ—Ç account consent!
    
    if create_product_consent:
        # –°–æ–∑–¥–∞—ë—Ç –Ω–∞ –ª–µ—Ç—É
        prod_consent_meta = await client.initiate_product_consent(...)
```

**–ü—Ä–æ–±–ª–µ–º–∞**: `create_product_consent=False` –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é!

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ**:
```python
async def fetch_bank_credits(
    bank_id: str,
    consent_id: str,  # account consent
    user_id: str,
    user_name: Optional[str] = None,
):
    async with bank_client(bank_id) as client:
        # 1. –ò—â–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π product consent –≤ –ë–î
        product_consent = find_consent_by_type(user_id, bank_id, "products")
        
        if product_consent and product_consent.status == "approved":
            prod_consent_id = product_consent.consent_id
            logger.info("Using existing product consent: %s", prod_consent_id)
        else:
            # 2. –°–æ–∑–¥–∞—ë–º –Ω–æ–≤—ã–π product consent
            logger.info("Creating new product consent...")
            prod_consent_meta = await client.initiate_product_consent(user_id, user_display_name=user_name)
            
            if prod_consent_meta and prod_consent_meta.consent_id:
                prod_consent_id = prod_consent_meta.consent_id
                
                # –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –ë–î
                save_consent(
                    user_id=user_id,
                    bank_id=bank_id,
                    consent_id=prod_consent_id,
                    status="approved",
                    consent_type="products"
                )
            else:
                # Fallback: –ø—Ä–æ–±—É–µ–º —Å account consent (–º–æ–∂–µ—Ç —Å—Ä–∞–±–æ—Ç–∞—Ç—å)
                logger.warning("Could not create product consent, trying with account consent")
                prod_consent_id = consent_id
        
        # 3. –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∫—Ä–µ–¥–∏—Ç—ã
        credits = await client.fetch_credits_with_consent(user_id, prod_consent_id)
        ...
```

---

### –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç 4: –†–∞—Å—à–∏—Ä–∏—Ç—å Database –¥–ª—è Product Consents

**–§–∞–π–ª**: [/hktn/core/database.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/database.py)

**–ü—Ä–æ–±–ª–µ–º–∞**: –¢–∞–±–ª–∏—Ü–∞ [consents](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/services/analytics.py#26-34) –Ω–µ —Ä–∞–∑–ª–∏—á–∞–µ—Ç account vs product consents.

**–¢–µ–∫—É—â–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞**:
```sql
CREATE TABLE IF NOT EXISTS consents (
    user_id TEXT NOT NULL,
    bank_id TEXT NOT NULL,
    consent_id TEXT,
    status TEXT,
    consent_type TEXT DEFAULT 'accounts',  -- ‚úÖ –ø–æ–ª–µ –£–ñ–ï –ï–°–¢–¨!
    ...
)
```

**–£–∂–µ —Ö–æ—Ä–æ—à–æ!** –ü–æ–ª–µ `consent_type` –µ—Å—Ç—å. –ù–æ –Ω—É–∂–µ–Ω –º–µ—Ç–æ–¥ –¥–ª—è –ø–æ–∏—Å–∫–∞:

**–î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é**:
```python
def find_consent_by_type(
    user_id: str,
    bank_id: str,
    consent_type: str = "accounts"
) -> Optional[StoredConsent]:
    """
    –ù–∞—Ö–æ–¥–∏—Ç consent –ø–æ —Ç–∏–ø—É
    
    Args:
        consent_type: "accounts" –∏–ª–∏ "products"
    """
    conn = get_db_connection()
    try:
        row = conn.execute(
            """
            SELECT bank_id, consent_id, consent_type
            FROM consents
            WHERE user_id = ? AND bank_id = ? AND consent_type = ? AND status = 'approved'
            ORDER BY timestamp DESC
            LIMIT 1
            """,
            (user_id, bank_id, consent_type),
        ).fetchone()
        
        if row:
            return StoredConsent(
                bank_id=row[0],
                consent_id=row[1],
                consent_type=row[2]
            )
        return None
    finally:
        conn.close()
```

---

## üìù –ü–æ—à–∞–≥–æ–≤—ã–π –ø–ª–∞–Ω –≤–Ω–µ–¥—Ä–µ–Ω–∏—è

### –®–∞–≥ 1: –ò—Å–ø—Ä–∞–≤–∏—Ç—å Balances (5 –º–∏–Ω—É—Ç)

**–§–∞–π–ª—ã**:
- [/hktn/core/obr_client.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py) (–¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ `_extract_balances()`)
- [/hktn/core/obr_client.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py) —Å—Ç—Ä–æ–∫–∞ 525 (–∑–∞–º–µ–Ω–∏—Ç—å [_jget](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py#618-627) –Ω–∞ `_extract_balances`)

**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
```bash
curl "http://localhost:8000/api/banks/abank/bootstrap?user_id=team260-3" | grep -o '"balances":\[.*\]' | head -c 200
# –û–∂–∏–¥–∞–µ—Ç—Å—è: "balances":[{"accountId":"acc-3693", ...}]
```

---

### –®–∞–≥ 2: –î–æ–±–∞–≤–∏—Ç—å find_consent_by_type() (3 –º–∏–Ω—É—Ç—ã)

**–§–∞–π–ª—ã**:
- [/hktn/core/database.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/database.py) (–¥–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é)

---

### –®–∞–≥ 3: –£–ª—É—á—à–∏—Ç—å fetch_bank_credits() (10 –º–∏–Ω—É—Ç)

**–§–∞–π–ª—ã**:
- [/hktn/backend/services/banking.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/services/banking.py) (–º–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å [fetch_bank_credits()](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/services/banking.py#202-236))

---

### –®–∞–≥ 4: –°–æ–∑–¥–∞—Ç—å initiate_full_consent_flow() (10 –º–∏–Ω—É—Ç)

**–§–∞–π–ª—ã**:
- [/hktn/backend/services/consents.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/services/consents.py) (–¥–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥)
- [/hktn/backend/routers/consents.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/routers/consents.py) (–∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥)

---

### –®–∞–≥ 5: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (10 –º–∏–Ω—É—Ç)

**–°—Ü–µ–Ω–∞—Ä–∏–π**:
```bash
# 1. –°–æ–∑–¥–∞—Ç—å consents (—Ç–µ–ø–µ—Ä—å —Å–æ–∑–¥–∞—Å—Ç –û–ë–ê)
curl -X POST http://localhost:8000/api/consent/initiate \
  -d '{"user_id": "team260-3", "bank_id": "abank"}'

# 2. –ü–æ–ª—É—á–∏—Ç—å balances (—Ç–µ–ø–µ—Ä—å –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–∞–Ω–Ω—ã–µ)
curl "http://localhost:8000/api/banks/abank/bootstrap?user_id=team260-3" | grep '"balances"'

# 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å credits
curl "http://localhost:8000/api/banks/abank/bootstrap?user_id=team260-3" | grep '"credits"'
```

---

## ‚úÖ –û–∂–∏–¥–∞–µ–º—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

### –î–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
```json
{
  "balances": [],           // ‚ùå –ø—É—Å—Ç–æ
  "credits": [],            // ‚ùå –ø—É—Å—Ç–æ  
  "accounts": [{ ... }],    // ‚úÖ –û–ö
  "transactions": [...]     // ‚úÖ –û–ö
}
```

### –ü–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π:
```json
{
  "balances": [             // ‚úÖ –î–∞–Ω–Ω—ã–µ!
    {
      "accountId": "acc-3693",
      "amount": {
        "amount": "264245.21",
        "currency": "RUB"
      }
    }
  ],
  "credits": [              // ‚úÖ –î–∞–Ω–Ω—ã–µ (–µ—Å–ª–∏ –µ—Å—Ç—å —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
    {
      "agreementId": "loan-team260-3-0447",
      "productType": "loan",
      "amount": 450000.0,
      "interestRate": 12.9,
      "monthlyPayment": 44773.27
    }
  ],
  "accounts": [{ ... }],    // ‚úÖ –û–ö
  "transactions": [...]     // ‚úÖ –û–ö
}
```

---

## üéØ –ò—Ç–æ–≥–æ–≤–∞—è –º–∞—Ç—Ä–∏—Ü–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| # | –ü—Ä–æ–±–ª–µ–º–∞ | –§–∞–π–ª | –ú–µ—Ç–æ–¥ | –°—Ç—Ä–æ–∫–∞ | –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç |
|---|----------|------|-------|--------|-------------|-----------|
| 1 | Balance –ø–∞—Ä—Å–∏–Ω–≥ (case) | [obr_client.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py) | [fetch_balances_with_consent](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/obr_client.py#489-542) | 525 | `"Balance"` ‚Üí `"balance"` (lowercase) | üî¥ HIGH |
| 2 | –ù–µ—Ç product consent | [consents.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/routers/consents.py) | –Ω–æ–≤—ã–π | - | –î–æ–±–∞–≤–∏—Ç—å `initiate_full_consent_flow()` | üî¥ HIGH |
| 3 | fetch_credits –∏—Å–ø–æ–ª—å–∑—É–µ—Ç account consent | [banking.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/services/banking.py) | [fetch_bank_credits](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/backend/services/banking.py#202-236) | 202-235 | –ò—Å–∫–∞—Ç—å product consent –≤ –ë–î | üü° MEDIUM |
| 4 | –ù–µ—Ç find_consent_by_type() | [database.py](file:///home/kesha/MyCode/HACKATHON/CASH_PREDICT/hktn/core/database.py) | –Ω–æ–≤—ã–π | - | –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –ø–æ–∏—Å–∫–∞ –ø–æ —Ç–∏–ø—É | üü° MEDIUM |

**–í—Å–µ–≥–æ**: 4 —Ñ–∞–π–ª–∞, ~50 —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞.

**–í—Ä–µ–º—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏**: 30-40 –º–∏–Ω—É—Ç.

---

–ì–æ—Ç–æ–≤ –ø—Ä–∏—Å—Ç—É–ø–∏—Ç—å –∫ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º?
