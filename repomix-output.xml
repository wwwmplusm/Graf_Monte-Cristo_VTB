This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
Figma_Front/
  src/
    components/
      figma/
        ImageWithFallback.tsx
      steps/
        CallbackScreen.tsx
        FinalSummary.tsx
        Step1UserInfo.tsx
        Step2BankSelection.tsx
        Step3BankConsent.tsx
        Step4ProductSelection.tsx
        Step5Questions.tsx
      ui/
        accordion.tsx
        alert-dialog.tsx
        alert.tsx
        aspect-ratio.tsx
        avatar.tsx
        badge.tsx
        breadcrumb.tsx
        button.tsx
        calendar.tsx
        card.tsx
        carousel.tsx
        chart.tsx
        checkbox.tsx
        collapsible.tsx
        command.tsx
        context-menu.tsx
        dialog.tsx
        drawer.tsx
        dropdown-menu.tsx
        form.tsx
        hover-card.tsx
        input-otp.tsx
        input.tsx
        label.tsx
        menubar.tsx
        navigation-menu.tsx
        pagination.tsx
        popover.tsx
        progress.tsx
        radio-group.tsx
        resizable.tsx
        scroll-area.tsx
        select.tsx
        separator.tsx
        sheet.tsx
        sidebar.tsx
        skeleton.tsx
        slider.tsx
        sonner.tsx
        switch.tsx
        table.tsx
        tabs.tsx
        textarea.tsx
        toggle-group.tsx
        toggle.tsx
        tooltip.tsx
        use-mobile.ts
        utils.ts
      widgets/
        DebitCardsWidget.tsx
        HealthWidget.tsx
        LoansDepositsWidget.tsx
        STSWidget.tsx
        TimelineWidget.tsx
      BankCard.tsx
      BottomNav.tsx
      ErrorBanner.tsx
      PaymentSheet.tsx
      ProductRow.tsx
      StatusChip.tsx
      Stepper.tsx
      ThemeToggle.tsx
    data/
      mockAppState.ts
    guidelines/
      API_INTEGRATION.md
      Guidelines.md
    screens/
      CardsScreen.tsx
      DepositsDetailScreen.tsx
      HomeScreen.tsx
      LoadingCalcScreen.tsx
      LoansDetailScreen.tsx
      OnboardingScreen.tsx
      RefinanceScreen.tsx
      SplashScreen.tsx
      STSDetailScreen.tsx
    styles/
      globals.css
    utils/
      formatters.ts
    API_INTEGRATION.md
    App.tsx
    Attributions.md
    index.css
    INTEGRATION_GUIDE.md
    main.tsx
    README.md
  index.html
  package.json
  vite.config.ts
hktn/
  backend/
    routers/
      __init__.py
      analytics.py
      banks.py
      consents.py
      onboarding.py
      profile.py
    services/
      analytics.py
      banking.py
      consents.py
      goals.py
      onboarding.py
      products.py
    __init__.py
    app.py
    config.py
    schemas.py
    state.py
  core/
    __init__.py
    analytics_engine.py
    data_models.py
    database.py
    obr_client.py
  src/
    api/
      client.js
      client.ts
    components/
      __tests__/
        BanksList.test.js
        BanksList.test.tsx
        UserIdForm.test.js
        UserIdForm.test.tsx
      BanksList.js
      BanksList.tsx
      UserIdForm.js
      UserIdForm.tsx
    pages/
      __tests__/
        DashboardPage.test.tsx
      BanksCatalogPage.js
      BanksCatalogPage.tsx
      CallbackPage.js
      CallbackPage.tsx
      ConsentProcessPage.js
      ConsentProcessPage.tsx
      ConsentStatusPage.js
      ConsentStatusPage.tsx
      DashboardPage.js
      DashboardPage.jsx
      DashboardPage.tsx
      DebtGoalPage.js
      DebtGoalPage.tsx
      GoalsLandingPage.js
      GoalsLandingPage.tsx
      IngestionPage.js
      IngestionPage.tsx
      SaveGoalPage.js
      SaveGoalPage.tsx
      UserIdPage.js
      UserIdPage.tsx
    state/
      notifications.js
      notifications.tsx
      useUser.js
      useUser.tsx
    styles/
      global.css
    test/
      setup.js
      setup.ts
    types/
      dashboard.ts
    App.js
    App.tsx
    main.js
    main.tsx
    vite-env.d.ts
  backend_app.py
  index.html
  jest.config.ts
  package.json
  README.md
  requirements.txt
  tsconfig.json
  tsconfig.node.json
  vite.config.ts
.gitignore
readme.md
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="Figma_Front/src/components/figma/ImageWithFallback.tsx">
import React, { useState } from 'react'

const ERROR_IMG_SRC =
  'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iODgiIGhlaWdodD0iODgiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyIgc3Ryb2tlPSIjMDAwIiBzdHJva2UtbGluZWpvaW49InJvdW5kIiBvcGFjaXR5PSIuMyIgZmlsbD0ibm9uZSIgc3Ryb2tlLXdpZHRoPSIzLjciPjxyZWN0IHg9IjE2IiB5PSIxNiIgd2lkdGg9IjU2IiBoZWlnaHQ9IjU2IiByeD0iNiIvPjxwYXRoIGQ9Im0xNiA1OCAxNi0xOCAzMiAzMiIvPjxjaXJjbGUgY3g9IjUzIiBjeT0iMzUiIHI9IjciLz48L3N2Zz4KCg=='

export function ImageWithFallback(props: React.ImgHTMLAttributes<HTMLImageElement>) {
  const [didError, setDidError] = useState(false)

  const handleError = () => {
    setDidError(true)
  }

  const { src, alt, style, className, ...rest } = props

  return didError ? (
    <div
      className={`inline-block bg-gray-100 text-center align-middle ${className ?? ''}`}
      style={style}
    >
      <div className="flex items-center justify-center w-full h-full">
        <img src={ERROR_IMG_SRC} alt="Error loading image" {...rest} data-original-url={src} />
      </div>
    </div>
  ) : (
    <img src={src} alt={alt} className={className} style={style} {...rest} onError={handleError} />
  )
}
</file>

<file path="Figma_Front/src/components/steps/CallbackScreen.tsx">
import { useEffect, useState } from "react";
import { Button } from "../ui/button";
import { CheckCircle, AlertCircle } from "lucide-react";
import { ErrorBanner } from "../ErrorBanner";
import { Skeleton } from "../ui/skeleton";

interface CallbackScreenProps {
  bankId: string;
  consentId: string;
  userId: string;
  onComplete: (bankId: string, consentId: string) => void;
}

type CallbackState = "checking" | "approved" | "error";

export function CallbackScreen({ bankId, consentId, userId, onComplete }: CallbackScreenProps) {
  const [state, setState] = useState<CallbackState>("checking");
  const [errorMessage, setErrorMessage] = useState("");

  // Check consent status
  // In real app: GET /api/consents/status?user_id=xxx&consent_id=xxx
  const checkConsentStatus = async () => {
    setState("checking");
    setErrorMessage("");

    try {
      // Simulate API call delay
      await new Promise((resolve) => setTimeout(resolve, 2000));

      // Mock response - in real app would check actual status
      const mockApproved = Math.random() > 0.1; // 90% success rate

      if (mockApproved) {
        setState("approved");
        // Auto-advance after showing success
        setTimeout(() => {
          onComplete(bankId, consentId);
        }, 1500);
      } else {
        setErrorMessage("–ë–∞–Ω–∫ –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞–ø—Ä–æ—Å –Ω–∞ –¥–æ—Å—Ç—É–ø");
        setState("error");
      }
    } catch (error) {
      setErrorMessage("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–æ–≥–ª–∞—Å–∏—è");
      setState("error");
    }
  };

  useEffect(() => {
    checkConsentStatus();
  }, []);

  if (state === "checking") {
    return (
      <div className="w-full max-w-md mx-auto">
        <div className="text-center mb-8">
          <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-[var(--color-brand-primary)] bg-opacity-10 flex items-center justify-center">
            <div className="w-8 h-8 border-4 border-[var(--color-brand-primary)] border-t-transparent rounded-full animate-spin" />
          </div>
          <h1 className="mb-2">–í–æ–∑–≤—Ä–∞—Ç –∏–∑ –±–∞–Ω–∫–∞</h1>
          <p className="text-[var(--color-text-secondary)]">
            –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è...
          </p>
          <p className="caption text-[var(--color-text-tertiary)] mt-2">
            Consent ID: {consentId}
          </p>
        </div>

        <div className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-6">
          <div className="space-y-3">
            <Skeleton className="h-4 w-full" />
            <Skeleton className="h-4 w-5/6" />
            <Skeleton className="h-4 w-4/6" />
          </div>
        </div>
      </div>
    );
  }

  if (state === "approved") {
    return (
      <div className="w-full max-w-md mx-auto text-center">
        <div className="w-20 h-20 mx-auto mb-6 rounded-2xl bg-[var(--color-success-light)] flex items-center justify-center">
          <CheckCircle className="w-10 h-10 text-[var(--color-success)]" />
        </div>
        <h1 className="mb-3 md:mb-4">–ë–∞–Ω–∫ –ø–æ–¥–∫–ª—é—á—ë–Ω</h1>
        <p className="text-[var(--color-text-secondary)]">
          –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ
        </p>
      </div>
    );
  }

  if (state === "error") {
    return (
      <div className="w-full max-w-md mx-auto">
        <div className="text-center mb-8">
          <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-[var(--color-error-light)] flex items-center justify-center">
            <AlertCircle className="w-8 h-8 text-[var(--color-error)]" />
          </div>
          <h1 className="mb-2">–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è</h1>
        </div>

        <ErrorBanner message={errorMessage} onRetry={checkConsentStatus} />

        <div className="mt-6">
          <Button
            variant="outline"
            size="lg"
            onClick={() => window.history.back()}
            className="w-full h-12 md:h-14 rounded-xl border-[var(--color-stroke-divider)] text-[var(--color-text-primary)]"
          >
            –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞–∑–∞–¥
          </Button>
        </div>
      </div>
    );
  }

  return null;
}
</file>

<file path="Figma_Front/src/components/steps/FinalSummary.tsx">
import { useState } from "react";
import { CheckCircle } from "lucide-react";
import { Button } from "../ui/button";
import { StatusChip } from "../StatusChip";
import { ErrorBanner } from "../ErrorBanner";

interface FinalSummaryProps {
  onComplete: () => void;
  onboardingState: any;
}

const speedLabels = {
  conservative: "–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ",
  optimal: "–û–ø—Ç–∏–º–∞–ª—å–Ω–æ",
  fast: "–ë—ã—Å—Ç—Ä–æ",
};

export function FinalSummary({
  onComplete,
  onboardingState,
}: FinalSummaryProps) {
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const connectedBanks = onboardingState.banks.filter((b: any) => b.connected);
  
  // Count consented products
  const consentedProducts = Object.values(onboardingState.productsByBank)
    .flat()
    .filter((p: any) => p.consented);

  const goals = onboardingState.goals;
  const hasSaveGoal = goals.mode === "save" || goals.mode === "both";
  const hasCloseGoal = goals.mode === "close_loans" || goals.mode === "both";

  const handleComplete = async () => {
    setIsSubmitting(true);
    setError(null);

    try {
      // Simulate API call: POST /api/onboarding/commit
      // Body: { user_id, banks, products, goals }
      await new Promise((resolve) => setTimeout(resolve, 1500));

      // Mock random error for demonstration (10% chance)
      if (Math.random() < 0.1) {
        throw new Error("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö");
      }

      // Success
      onComplete();
    } catch (err: any) {
      setError(err.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥");
      setIsSubmitting(false);
    }
  };

  return (
    <div className="w-full max-w-2xl mx-auto">
      {/* Success Icon */}
      <div className="text-center mb-6 md:mb-8">
        <div className="w-16 h-16 md:w-20 md:h-20 mx-auto mb-4 rounded-full bg-[var(--color-success-light)] flex items-center justify-center">
          <CheckCircle className="w-8 h-8 md:w-10 md:h-10 text-[var(--color-success)]" />
        </div>
        <h1 className="mb-2">–û—Ç–ª–∏—á–Ω–æ, {onboardingState.user_name || "–¥—Ä—É–≥"}!</h1>
        <p className="text-[var(--color-text-secondary)]">
          –í–∞—à –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω –≥–æ—Ç–æ–≤
        </p>
      </div>

      {/* Error Banner */}
      {error && (
        <div className="mb-6">
          <ErrorBanner message={error} onRetry={handleComplete} />
        </div>
      )}

      {/* Summary Cards */}
      <div className="space-y-4 md:space-y-6 mb-6 md:mb-8">
        {/* Banks */}
        <div className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-4 md:p-6">
          <h2 className="mb-4">–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –±–∞–Ω–∫–∏</h2>
          <div className="flex flex-wrap gap-2">
            {connectedBanks.map((bank: any) => (
              <div
                key={bank.id}
                className="inline-flex items-center gap-2 px-3 py-2 bg-[var(--color-bg-secondary)] rounded-lg"
              >
                <span className="text-lg">üè¶</span>
                <span className="text-[var(--color-text-primary)]">{bank.name}</span>
                <StatusChip status="connected" label="" />
              </div>
            ))}
          </div>
        </div>

        {/* Products */}
        <div className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-4 md:p-6">
          <h2 className="mb-4">–í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã</h2>
          <div className="flex items-center gap-2 text-[var(--color-text-secondary)]">
            <CheckCircle className="w-5 h-5 text-[var(--color-success)]" />
            <span>{consentedProducts.length} –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span>
          </div>
        </div>

        {/* Goals */}
        {goals.mode && (
          <div className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-4 md:p-6">
            <h2 className="mb-4">
              {goals.mode === "both" ? "–í–∞—à–∏ —Ü–µ–ª–∏" : "–í–∞—à–∞ —Ü–µ–ª—å"}
            </h2>
            <div className="space-y-4">
              {/* Save Goal */}
              {hasSaveGoal && (
                <div>
                  <div className="flex items-center gap-3 mb-2">
                    <span className="text-2xl">üí∞</span>
                    <div>
                      <p className="text-[var(--color-text-primary)]">–ù–∞–∫–æ–ø–∏—Ç—å –¥–µ–Ω–µ–≥</p>
                      {goals.save_amount && (
                        <p className="caption text-[var(--color-text-secondary)]">
                          –¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞: {goals.save_amount.toLocaleString("ru-RU")} ‚ÇΩ
                        </p>
                      )}
                    </div>
                  </div>
                  {goals.save_speed && (
                    <div className="ml-11 flex items-center gap-2">
                      <p className="caption text-[var(--color-text-secondary)]">
                        –¢–µ–º–ø: <span className="text-[var(--color-text-primary)]">{speedLabels[goals.save_speed]}</span>
                      </p>
                    </div>
                  )}
                </div>
              )}

              {/* Separator if both goals */}
              {hasSaveGoal && hasCloseGoal && (
                <div className="border-t border-[var(--color-stroke-divider)]" />
              )}

              {/* Close Loans Goal */}
              {hasCloseGoal && (
                <div>
                  <div className="flex items-center gap-3 mb-2">
                    <span className="text-2xl">üéØ</span>
                    <div>
                      <p className="text-[var(--color-text-primary)]">–ó–∞–∫—Ä—ã—Ç—å –∫—Ä–µ–¥–∏—Ç—ã</p>
                      {goals.close_loan_ids?.length > 0 && (
                        <p className="caption text-[var(--color-text-secondary)]">
                          –í—ã–±—Ä–∞–Ω–æ –∫—Ä–µ–¥–∏—Ç–æ–≤: {goals.close_loan_ids.length}
                        </p>
                      )}
                    </div>
                  </div>
                  {goals.close_speed && (
                    <div className="ml-11 flex items-center gap-2">
                      <p className="caption text-[var(--color-text-secondary)]">
                        –¢–µ–º–ø: <span className="text-[var(--color-text-primary)]">{speedLabels[goals.close_speed]}</span>
                      </p>
                    </div>
                  )}
                </div>
              )}
            </div>
          </div>
        )}
      </div>

      {/* CTA */}
      <Button
        size="lg"
        onClick={handleComplete}
        disabled={isSubmitting}
        className="w-full h-12 md:h-14 rounded-xl bg-[var(--color-brand-primary)] hover:bg-[var(--color-brand-primary-hover)] text-white disabled:opacity-50"
      >
        {isSubmitting ? "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..." : "–ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥"}
      </Button>
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/steps/Step1UserInfo.tsx">
import { useState } from "react";
import { Button } from "../ui/button";
import { Input } from "../ui/input";
import { Label } from "../ui/label";
import { Checkbox } from "../ui/checkbox";

interface Step1UserInfoProps {
  onNext: (userId: string, userName: string) => void;
  onSkip: () => void;
  initialUserId?: string;
  initialName?: string;
}

export function Step1UserInfo({ 
  onNext, 
  onSkip, 
  initialUserId = "",
  initialName = "" 
}: Step1UserInfoProps) {
  const [userId, setUserId] = useState(initialUserId);
  const [name, setName] = useState(initialName);
  const [agreedToTerms, setAgreedToTerms] = useState(false);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (userId.trim() && name.trim() && agreedToTerms) {
      onNext(userId.trim(), name.trim());
    }
  };

  return (
    <div className="w-full max-w-md mx-auto">
      <div className="text-center mb-8 md:mb-10">
        <h1 className="mb-3 md:mb-4">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å</h1>
        <p className="text-[var(--color-text-secondary)]">
          –†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ, —á—Ç–æ–±—ã –º—ã –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–ª–∏ –ø–ª–∞–Ω
        </p>
      </div>

      <form onSubmit={handleSubmit} className="space-y-6 md:space-y-8">
        {/* User ID field */}
        <div>
          <Label htmlFor="user-id" className="text-[var(--color-text-primary)] mb-2 block">
            User ID
          </Label>
          <Input
            id="user-id"
            type="text"
            placeholder="demo-001"
            value={userId}
            onChange={(e) => setUserId(e.target.value)}
            className="h-12 md:h-14 rounded-xl border-[var(--color-stroke-input)] bg-[var(--color-surface-panel)]"
          />
          <p className="caption text-[var(--color-text-tertiary)] mt-2">
            –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è API-–∑–∞–ø—Ä–æ—Å–æ–≤
          </p>
        </div>

        {/* User Name field */}
        <div>
          <Label htmlFor="name" className="text-[var(--color-text-primary)] mb-2 block">
            –í–∞—à–µ –∏–º—è
          </Label>
          <Input
            id="name"
            type="text"
            placeholder="–ò–≤–∞–Ω"
            value={name}
            onChange={(e) => setName(e.target.value)}
            className="h-12 md:h-14 rounded-xl border-[var(--color-stroke-input)] bg-[var(--color-surface-panel)]"
          />
        </div>

        <div className="flex items-start gap-3 p-3 bg-[var(--color-bg-secondary)] rounded-xl">
          <Checkbox
            id="terms-agreement"
            checked={agreedToTerms}
            onCheckedChange={(checked) => setAgreedToTerms(checked as boolean)}
          />
          <Label
            htmlFor="terms-agreement"
            className="text-[var(--color-text-primary)] cursor-pointer"
          >
            –ü—Ä–æ—á–∏—Ç–∞–ª –∏ —Å–æ–≥–ª–∞—Å–µ–Ω —Å{" "}
            <a
              href="#"
              className="text-[var(--color-brand-primary)] hover:underline"
              onClick={(e) => e.preventDefault()}
            >
              –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ–º
            </a>
          </Label>
        </div>

        <div className="flex flex-col gap-3">
          <Button
            type="submit"
            size="lg"
            className="w-full h-12 md:h-14 rounded-xl bg-[var(--color-brand-primary)] hover:bg-[var(--color-brand-primary-hover)] text-white"
            disabled={!userId.trim() || !name.trim() || !agreedToTerms}
          >
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
          </Button>
          <Button
            type="button"
            variant="outline"
            size="lg"
            onClick={onSkip}
            className="w-full h-12 md:h-14 rounded-xl border-[var(--color-stroke-divider)] text-[var(--color-text-primary)]"
          >
            –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
          </Button>
        </div>
      </form>
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/steps/Step2BankSelection.tsx">
import { useState, useEffect } from "react";
import { Button } from "../ui/button";
import { BankCard } from "../BankCard";
import { ErrorBanner } from "../ErrorBanner";
import { Skeleton } from "../ui/skeleton";

interface Bank {
  id: string;
  name: string;
  connected: boolean;
}

interface Step2BankSelectionProps {
  onNext: (selectedBanks: string[]) => void;
  onBack: () => void;
  initialSelection?: string[];
  onboardingState: any;
  setOnboardingState: (updater: (prev: any) => any) => void;
}

type LoadingState = "idle" | "loading" | "error" | "empty" | "success";

export function Step2BankSelection({ 
  onNext, 
  onBack, 
  initialSelection = [],
  onboardingState,
  setOnboardingState
}: Step2BankSelectionProps) {
  const [selectedBanks, setSelectedBanks] = useState<string[]>(initialSelection);
  const [loadingState, setLoadingState] = useState<LoadingState>("idle");

  // Simulate API call to fetch banks
  // In real app: GET /api/banks
  const fetchBanks = async () => {
    setLoadingState("loading");
    
    try {
      // Simulate API delay
      await new Promise((resolve) => setTimeout(resolve, 1500));
      
      // Mock data - in real app this would be an API call
      const mockBanks: Bank[] = [
        { id: "bank-a", name: "–ë–∞–Ω–∫ A", connected: false },
        { id: "bank-b", name: "–ë–∞–Ω–∫ B", connected: false },
        { id: "bank-c", name: "–ë–∞–Ω–∫ C", connected: false },
      ];

      // Update onboardingState with banks
      setOnboardingState((prev: any) => ({
        ...prev,
        banks: mockBanks,
      }));

      if (mockBanks.length === 0) {
        setLoadingState("empty");
      } else {
        setLoadingState("success");
      }
    } catch (error) {
      setLoadingState("error");
    }
  };

  useEffect(() => {
    // Load banks if not already loaded
    if (onboardingState.banks.length === 0) {
      fetchBanks();
    } else {
      setLoadingState("success");
    }
  }, []);

  const handleBankSelect = (bankId: string, selected: boolean) => {
    setSelectedBanks((prev) =>
      selected ? [...prev, bankId] : prev.filter((id) => id !== bankId)
    );
  };

  const handleNext = () => {
    if (selectedBanks.length > 0) {
      onNext(selectedBanks);
    }
  };

  return (
    <div className="w-full max-w-2xl mx-auto">
      <div className="text-center mb-6 md:mb-8">
        <h1 className="mb-3 md:mb-4">–í–∞—à–∏ –±–∞–Ω–∫–∏</h1>
        <p className="text-[var(--color-text-secondary)]">
          –í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫–∏, —Å –∫–æ—Ç–æ—Ä—ã–º–∏ –±—É–¥–µ–º —Ä–∞–±–æ—Ç–∞—Ç—å
        </p>
      </div>

      {/* Loading State */}
      {loadingState === "loading" && (
        <div className="space-y-3 md:space-y-4 mb-6 md:mb-8">
          {[1, 2, 3].map((i) => (
            <div
              key={i}
              className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-6"
            >
              <div className="flex items-center gap-4">
                <Skeleton className="w-12 h-12 rounded-xl" />
                <div className="flex-1">
                  <Skeleton className="h-5 w-32 mb-2" />
                  <Skeleton className="h-4 w-24" />
                </div>
                <Skeleton className="w-5 h-5 rounded" />
              </div>
            </div>
          ))}
        </div>
      )}

      {/* Error State */}
      {loadingState === "error" && (
        <div className="mb-6">
          <ErrorBanner
            message="–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –±–∞–Ω–∫–æ–≤"
            onRetry={fetchBanks}
          />
        </div>
      )}

      {/* Empty State */}
      {loadingState === "empty" && (
        <div className="text-center py-12 mb-8">
          <div className="w-20 h-20 mx-auto mb-4 rounded-2xl bg-[var(--color-bg-secondary)] flex items-center justify-center">
            <span className="text-4xl">üè¶</span>
          </div>
          <h2 className="mb-2">–ë–∞–Ω–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</h2>
          <p className="text-[var(--color-text-secondary)] mb-6">
            –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±—ç–∫–µ–Ω–¥—É
          </p>
          <Button
            variant="outline"
            onClick={fetchBanks}
            className="rounded-xl border-[var(--color-stroke-divider)]"
          >
            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
          </Button>
        </div>
      )}

      {/* Success State - Bank List */}
      {loadingState === "success" && (
        <div className="space-y-3 md:space-y-4 mb-6 md:mb-8">
          {onboardingState.banks.map((bank: Bank) => (
            <BankCard
              key={bank.id}
              id={bank.id}
              name={bank.name}
              logo="üè¶"
              selected={selectedBanks.includes(bank.id)}
              onSelect={handleBankSelect}
            />
          ))}
        </div>
      )}

      <div className="flex flex-col md:flex-row gap-3">
        <Button
          variant="outline"
          size="lg"
          onClick={onBack}
          className="w-full md:w-auto h-12 md:h-14 rounded-xl border-[var(--color-stroke-divider)] text-[var(--color-text-primary)]"
        >
          –ù–∞–∑–∞–¥
        </Button>
        <Button
          size="lg"
          onClick={handleNext}
          disabled={selectedBanks.length === 0 || loadingState !== "success"}
          className="w-full md:flex-1 h-12 md:h-14 rounded-xl bg-[var(--color-brand-primary)] hover:bg-[var(--color-brand-primary-hover)] text-white"
        >
          –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </Button>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/steps/Step3BankConsent.tsx">
import { useState, useEffect } from "react";
import { Button } from "../ui/button";
import { Checkbox } from "../ui/checkbox";
import { Label } from "../ui/label";
import { Skeleton } from "../ui/skeleton";
import { StatusChip } from "../StatusChip";
import { ErrorBanner } from "../ErrorBanner";
import { Shield, CreditCard, PiggyBank, Receipt } from "lucide-react";

interface Bank {
  id: string;
  name: string;
  connected?: boolean;
}

interface Step3BankConsentProps {
  onNext: (consents: Record<string, string>) => void;
  onBack: () => void;
  selectedBanks: string[];
  banks: Bank[];
  initialConsents?: Record<string, string>;
}

type ConsentState = "idle" | "loading" | "success" | "error";

interface ProductType {
  id: string;
  type: "deposit" | "loan" | "debit_card" | "credit_card";
  name: string;
  icon: typeof PiggyBank;
}

const availableProducts: ProductType[] = [
  { id: "deposit", type: "deposit", name: "–í–∫–ª–∞–¥—ã", icon: PiggyBank },
  { id: "debit_card", type: "debit_card", name: "–î–µ–±–µ—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã", icon: CreditCard },
  { id: "credit_card", type: "credit_card", name: "–ö—Ä–µ–¥–∏—Ç–Ω—ã–µ –∫–∞—Ä—Ç—ã", icon: CreditCard },
  { id: "loan", type: "loan", name: "–ö—Ä–µ–¥–∏—Ç—ã", icon: Receipt },
];

export function Step3BankConsent({ 
  onNext, 
  onBack,
  selectedBanks,
  banks,
  initialConsents = {}
}: Step3BankConsentProps) {
  const [currentBankIndex, setCurrentBankIndex] = useState(0);
  const [agreed, setAgreed] = useState(false);
  const [state, setState] = useState<ConsentState>("idle");
  const [consents, setConsents] = useState<Record<string, string>>(initialConsents);

  const currentBankId = selectedBanks[currentBankIndex];
  const currentBank = banks.find(b => b.id === currentBankId);
  const totalBanks = selectedBanks.length;
  const isLastBank = currentBankIndex === totalBanks - 1;

  // Reset state when bank changes
  useEffect(() => {
    setAgreed(false);
    setState("idle");
  }, [currentBankId]);

  // Auto-advance when successfully connected
  useEffect(() => {
    if (state === "success") {
      const timer = setTimeout(() => {
        if (isLastBank) {
          // All banks connected, proceed to next step
          onNext(consents);
        } else {
          // Move to next bank
          setCurrentBankIndex(prev => prev + 1);
        }
      }, 1500);
      return () => clearTimeout(timer);
    }
  }, [state, isLastBank, consents, onNext]);

  const handleConnect = () => {
    setState("loading");
    
    // Simulate API call with random success/failure
    const delay = Math.random() * 400 + 800; // 800-1200ms
    setTimeout(() => {
      const success = Math.random() > 0.2; // 80% success rate
      if (success) {
        // Generate consent ID
        const consentId = `consent-${currentBankId}-${Date.now()}`;
        setConsents(prev => ({
          ...prev,
          [currentBankId]: consentId
        }));
        setState("success");
      } else {
        setState("error");
      }
    }, delay);
  };

  const handleRetry = () => {
    setState("idle");
    setAgreed(false);
  };

  if (!currentBank) {
    return (
      <div className="w-full max-w-md mx-auto text-center">
        <p className="text-[var(--color-text-secondary)]">–ë–∞–Ω–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω</p>
      </div>
    );
  }

  if (state === "loading") {
    return (
      <div className="w-full max-w-md mx-auto">
        <div className="text-center mb-8">
          <div className="w-16 h-16 md:w-20 md:h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-purple-100 to-purple-50 dark:from-purple-900 dark:to-purple-800 flex items-center justify-center">
            <span className="text-3xl md:text-4xl">üè¶</span>
          </div>
          <h1 className="mb-2">–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ {currentBank.name}</h1>
          <StatusChip status="pending" />
        </div>
        
        <div className="space-y-4">
          <Skeleton className="h-4 w-full" />
          <Skeleton className="h-4 w-5/6" />
          <Skeleton className="h-4 w-4/6" />
        </div>
      </div>
    );
  }

  if (state === "success") {
    return (
      <div className="w-full max-w-md mx-auto text-center">
        <div className="w-16 h-16 md:w-20 md:h-20 mx-auto mb-4 rounded-full bg-[var(--color-success-light)] flex items-center justify-center">
          <span className="text-3xl md:text-4xl">‚úì</span>
        </div>
        <h1 className="mb-2">–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ!</h1>
        <StatusChip status="connected" />
        {!isLastBank && (
          <p className="text-[var(--color-text-secondary)] mt-4">
            –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –±–∞–Ω–∫—É...
          </p>
        )}
      </div>
    );
  }

  return (
    <div className="w-full max-w-md mx-auto">
      {/* Bank Header */}
      <div className="text-center mb-6 md:mb-8">
        <div className="w-16 h-16 md:w-20 md:h-20 mx-auto mb-4 rounded-2xl bg-gradient-to-br from-purple-100 to-purple-50 dark:from-purple-900 dark:to-purple-800 flex items-center justify-center">
          <span className="text-3xl md:text-4xl">üè¶</span>
        </div>
        <h1 className="mb-2">–°–æ–≥–ª–∞—Å–∏–µ —Å {currentBank.name}</h1>
        {totalBanks > 1 && (
          <p className="caption text-[var(--color-text-tertiary)]">
            –ë–∞–Ω–∫ {currentBankIndex + 1} –∏–∑ {totalBanks}
          </p>
        )}
      </div>

      {state === "error" && (
        <div className="mb-6">
          <ErrorBanner
            message="–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å –±–∞–Ω–∫. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É"
            onRetry={handleRetry}
          />
        </div>
      )}

      {/* Available Products */}
      <div className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-4 md:p-6 mb-6">
        <h2 className="mb-4">–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã</h2>
        <div className="space-y-2">
          {availableProducts.map((product) => {
            const Icon = product.icon;
            return (
              <div
                key={product.id}
                className="flex items-center gap-3 p-3 bg-[var(--color-bg-secondary)] rounded-lg"
              >
                <div className="w-8 h-8 rounded-lg bg-[var(--color-brand-primary)] bg-opacity-10 flex items-center justify-center flex-shrink-0">
                  <Icon className="w-4 h-4 text-[var(--color-brand-primary)]" />
                </div>
                <span className="text-[var(--color-text-primary)]">{product.name}</span>
              </div>
            );
          })}
        </div>
      </div>

      {/* Consent Content */}
      <div className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-4 md:p-6 mb-6">
        <div className="flex items-start gap-3 mb-4">
          <Shield className="w-5 h-5 text-[var(--color-brand-primary)] flex-shrink-0 mt-0.5" />
          <div>
            <p className="text-[var(--color-text-primary)] mb-2">
              –†–∞–∑—Ä–µ—à–∏—Ç–µ –Ω–∞–º —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ —Å—á–µ—Ç–æ–≤, –∫–∞—Ä—Ç, –∫—Ä–µ–¥–∏—Ç–æ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –≤–∞—à–µ–≥–æ –ø–ª–∞–Ω–∞.
            </p>
            <a
              href="#"
              className="caption text-[var(--color-brand-primary)] hover:underline"
              onClick={(e) => e.preventDefault()}
            >
              –ü—Ä–æ—á–∏—Ç–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–µ —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ ‚Üí
            </a>
          </div>
        </div>

        <div className="flex items-start gap-3 p-3 bg-[var(--color-bg-secondary)] rounded-xl">
          <Checkbox
            id={`consent-${currentBankId}`}
            checked={agreed}
            onCheckedChange={(checked) => setAgreed(checked as boolean)}
          />
          <Label
            htmlFor={`consent-${currentBankId}`}
            className="text-[var(--color-text-primary)] cursor-pointer"
          >
            –ü—Ä–æ—á–∏—Ç–∞–ª –∏ —Å–æ–≥–ª–∞—Å–µ–Ω —Å —É—Å–ª–æ–≤–∏—è–º–∏
          </Label>
        </div>
      </div>

      {/* Actions */}
      <div className="flex flex-col md:flex-row gap-3">
        <Button
          variant="outline"
          size="lg"
          onClick={onBack}
          className="w-full md:w-auto h-12 md:h-14 rounded-xl border-[var(--color-stroke-divider)] text-[var(--color-text-primary)]"
        >
          –ù–∞–∑–∞–¥
        </Button>
        <Button
          size="lg"
          onClick={handleConnect}
          disabled={!agreed}
          className="w-full md:flex-1 h-12 md:h-14 rounded-xl bg-[var(--color-brand-primary)] hover:bg-[var(--color-brand-primary-hover)] text-white"
        >
          –í—ã–¥–∞—Ç—å –¥–æ—Å—Ç—É–ø
        </Button>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/steps/Step4ProductSelection.tsx">
import { useState, useEffect } from "react";
import { Button } from "../ui/button";
import { Checkbox } from "../ui/checkbox";
import { Label } from "../ui/label";
import { ProductRow } from "../ProductRow";
import { ErrorBanner } from "../ErrorBanner";
import { Skeleton } from "../ui/skeleton";

interface Product {
  id: string;
  type: "deposit" | "loan" | "debit_card" | "credit_card";
  name: string;
  consented: boolean;
  tos_url: string;
}

interface Step4ProductSelectionProps {
  onNext: (products: any[]) => void;
  onBack: () => void;
  connectedBanks: any[];
  initialProducts: any[];
}

type LoadingState = "idle" | "loading" | "error" | "success";

export function Step4ProductSelection({
  onNext,
  onBack,
  connectedBanks,
  initialProducts,
}: Step4ProductSelectionProps) {
  const [productsByBank, setProductsByBank] = useState<Record<string, Product[]>>({});
  const [loadingState, setLoadingState] = useState<LoadingState>("idle");
  const [agreed, setAgreed] = useState(false);
  const [errorMessage, setErrorMessage] = useState("");

  // Load products for each connected bank
  // In real app: GET /api/products?bank_id=xxx
  const loadProductsForBank = async (bankId: string) => {
    try {
      // Simulate API delay
      await new Promise((resolve) => setTimeout(resolve, 800));

      // Mock data - in real app this would be an API call
      const mockProducts: Product[] = [
        {
          id: `${bankId}-deposit`,
          type: "deposit",
          name: "–í–∫–ª–∞–¥",
          consented: false,
          tos_url: "#terms-deposit",
        },
        {
          id: `${bankId}-loan`,
          type: "loan",
          name: "–ö—Ä–µ–¥–∏—Ç",
          consented: false,
          tos_url: "#terms-loan",
        },
        {
          id: `${bankId}-debit`,
          type: "debit_card",
          name: "–ö–∞—Ä—Ç–∞: –¥–µ–±–µ—Ç–æ–≤–∞—è",
          consented: false,
          tos_url: "#terms-debit",
        },
        {
          id: `${bankId}-credit`,
          type: "credit_card",
          name: "–ö–∞—Ä—Ç–∞: –∫—Ä–µ–¥–∏—Ç–Ω–∞—è",
          consented: false,
          tos_url: "#terms-credit",
        },
      ];

      setProductsByBank((prev) => ({
        ...prev,
        [bankId]: mockProducts,
      }));
    } catch (error) {
      throw new Error(`Failed to load products for ${bankId}`);
    }
  };

  const loadAllProducts = async () => {
    setLoadingState("loading");
    setErrorMessage("");

    try {
      // Load products for all connected banks
      await Promise.all(connectedBanks.map((bank: any) => loadProductsForBank(bank.id)));
      setLoadingState("success");
    } catch (error: any) {
      setErrorMessage(error.message || "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–¥—É–∫—Ç—ã");
      setLoadingState("error");
    }
  };

  useEffect(() => {
    // Load products if not already loaded
    const hasProducts = connectedBanks.every((bank: any) => productsByBank[bank.id]);
    
    if (!hasProducts && connectedBanks.length > 0) {
      loadAllProducts();
    } else if (connectedBanks.length > 0) {
      setLoadingState("success");
    }
  }, []);

  const handleProductToggle = (bankId: string, productId: string, consented: boolean) => {
    setProductsByBank((prev) => ({
      ...prev,
      [bankId]: prev[bankId].map((p) =>
        p.id === productId ? { ...p, consented } : p
      ),
    }));
  };

  const handleSelectAllForBank = (bankId: string, selected: boolean) => {
    setProductsByBank((prev) => ({
      ...prev,
      [bankId]: prev[bankId].map((p) => ({ ...p, consented: selected })),
    }));
  };

  const handleNext = () => {
    // In real app: POST /api/products/consent
    // Body: { user_id, items: [{ bank_id, product_id, consent: boolean }] }
    
    if (agreed) {
      // Convert productsByBank to array of selected products
      const selectedProducts = Object.entries(productsByBank).flatMap(([bankId, products]) =>
        products
          .filter(p => p.consented)
          .map(p => ({
            bank_id: bankId,
            product_id: p.id,
            product_type: p.type,
          }))
      );
      onNext(selectedProducts);
    }
  };

  const hasSelectedProducts = Object.values(productsByBank).some((products) =>
    products.some((p) => p.consented)
  );

  if (loadingState === "loading") {
    return (
      <div className="w-full max-w-3xl mx-auto">
        <div className="text-center mb-6 md:mb-8">
          <h1 className="mb-3 md:mb-4">–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h1>
          <p className="text-[var(--color-text-secondary)]">
            –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã...
          </p>
        </div>

        <div className="space-y-6">
          {connectedBanks.map((bank: any) => (
            <div
              key={bank.id}
              className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-4 md:p-6"
            >
              <div className="flex items-center gap-3 mb-4">
                <Skeleton className="w-10 h-10 rounded-xl" />
                <Skeleton className="h-6 w-32" />
              </div>
              <div className="space-y-2">
                {[1, 2, 3].map((i) => (
                  <Skeleton key={i} className="h-12 w-full rounded-lg" />
                ))}
              </div>
            </div>
          ))}
        </div>
      </div>
    );
  }

  if (loadingState === "error") {
    return (
      <div className="w-full max-w-3xl mx-auto">
        <div className="text-center mb-6 md:mb-8">
          <h1 className="mb-3 md:mb-4">–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h1>
        </div>

        <ErrorBanner message={errorMessage} onRetry={loadAllProducts} />

        <div className="mt-6">
          <Button
            variant="outline"
            size="lg"
            onClick={onBack}
            className="w-full h-12 md:h-14 rounded-xl border-[var(--color-stroke-divider)] text-[var(--color-text-primary)]"
          >
            –ù–∞–∑–∞–¥
          </Button>
        </div>
      </div>
    );
  }

  return (
    <div className="w-full max-w-3xl mx-auto">
      <div className="text-center mb-6 md:mb-8">
        <h1 className="mb-3 md:mb-4">–í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤</h1>
        <p className="text-[var(--color-text-secondary)]">
          –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–¥—É–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
        </p>
      </div>

      <div className="space-y-6 mb-6 md:mb-8">
        {connectedBanks.map((bank: any) => {
          const bankProducts = productsByBank[bank.id] || [];
          const allSelected = bankProducts.every((p) => p.consented);

          return (
            <div
              key={bank.id}
              className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-4 md:p-6"
            >
              {/* Bank Header with Select All */}
              <div className="flex items-center gap-3 mb-4 pb-4 border-b border-[var(--color-stroke-divider)]">
                <div className="w-10 h-10 rounded-xl bg-gradient-to-br from-purple-100 to-purple-50 dark:from-purple-900 dark:to-purple-800 flex items-center justify-center">
                  <span className="text-lg">üè¶</span>
                </div>
                <div className="flex-1">
                  <h2>{bank.name}</h2>
                  <a
                    href="#"
                    className="caption text-[var(--color-brand-primary)] hover:underline"
                    onClick={(e) => e.preventDefault()}
                  >
                    –ü—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ ‚Üí
                  </a>
                </div>
                <div className="flex items-center gap-2">
                  <Checkbox
                    id={`select-all-${bank.id}`}
                    checked={allSelected}
                    onCheckedChange={(checked) => handleSelectAllForBank(bank.id, checked as boolean)}
                  />
                  <Label htmlFor={`select-all-${bank.id}`} className="caption text-[var(--color-text-secondary)] cursor-pointer">
                    –í—ã–±—Ä–∞—Ç—å –≤—Å—ë
                  </Label>
                </div>
              </div>

              {/* Products List */}
              <div className="space-y-2">
                {bankProducts.map((product) => (
                  <ProductRow
                    key={product.id}
                    id={product.id}
                    type={product.type}
                    name={product.name}
                    bankName={bank.name}
                    selected={product.consented}
                    onSelect={(id, selected) => handleProductToggle(bank.id, id, selected)}
                    onAgreementClick={() => window.open(product.tos_url, "_blank")}
                  />
                ))}
              </div>
            </div>
          );
        })}
      </div>

      {/* Agreement Checkbox */}
      <div className="bg-[var(--color-bg-secondary)] border border-[var(--color-stroke-divider)] rounded-xl p-4 mb-6">
        <div className="flex items-start gap-3">
          <Checkbox id="final-agreement" checked={agreed} onCheckedChange={(checked) => setAgreed(checked as boolean)} />
          <Label htmlFor="final-agreement" className="text-[var(--color-text-primary)] cursor-pointer">
            –ü—Ä–æ—á–∏—Ç–∞–ª –∏ —Å–æ–≥–ª–∞—Å–µ–Ω —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤
          </Label>
        </div>
      </div>

      {/* Actions */}
      <div className="flex flex-col md:flex-row gap-3">
        <Button
          variant="outline"
          size="lg"
          onClick={onBack}
          className="w-full md:w-auto h-12 md:h-14 rounded-xl border-[var(--color-stroke-divider)] text-[var(--color-text-primary)]"
        >
          –ù–∞–∑–∞–¥
        </Button>
        <Button
          size="lg"
          onClick={handleNext}
          disabled={!hasSelectedProducts || !agreed}
          className="w-full md:flex-1 h-12 md:h-14 rounded-xl bg-[var(--color-brand-primary)] hover:bg-[var(--color-brand-primary-hover)] text-white"
        >
          –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </Button>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/steps/Step5Questions.tsx">
import { useState } from "react";
import { Button } from "../ui/button";
import { Input } from "../ui/input";
import { Label } from "../ui/label";
import { Checkbox } from "../ui/checkbox";
import { Slider } from "../ui/slider";

type GoalType = "save" | "payoff";
type Speed = "conservative" | "optimal" | "fast";

interface Step5QuestionsProps {
  onNext: (goals: any) => void;
  onBack: () => void;
  initialGoals: any;
}

interface QuestionData {
  goals: GoalType[];
  saveAmount?: number;
  saveSpeed?: Speed;
  payoffSpeed?: Speed;
}

const SPEED_OPTIONS: Speed[] = ["conservative", "optimal", "fast"];
const SPEED_LABELS: Record<Speed, string> = {
  conservative: "–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ",
  optimal: "–û–ø—Ç–∏–º–∞–ª—å–Ω–æ",
  fast: "–ë—ã—Å—Ç—Ä–æ",
};

export function Step5Questions({ onNext, onBack, initialGoals }: Step5QuestionsProps) {
  const [step, setStep] = useState<"goal" | "save-input" | "save-result" | "payoff-input" | "payoff-result">("goal");
  
  // Map from API structure to UI structure
  const initialUIGoals: GoalType[] = [];
  if (initialGoals?.mode === "save" || initialGoals?.mode === "both") initialUIGoals.push("save");
  if (initialGoals?.mode === "close_loans" || initialGoals?.mode === "both") initialUIGoals.push("payoff");
  
  const [goals, setGoals] = useState<GoalType[]>(initialUIGoals);
  const [saveAmount, setSaveAmount] = useState<string>(initialGoals?.save_amount?.toString() || "");
  const [saveSpeed, setSaveSpeed] = useState<Speed>(initialGoals?.save_speed || "optimal");
  const [payoffSpeed, setPayoffSpeed] = useState<Speed>(initialGoals?.close_speed || "optimal");
  const [payoffLoans, setPayoffLoans] = useState<string[]>(initialGoals?.close_loan_ids || []);
  const [totalLoanAmount] = useState<number>(Math.floor(Math.random() * 900000) + 100000);

  // Generate random results based on speed
  const getSaveResults = (speed: Speed) => {
    const speedMultipliers = { conservative: 1, optimal: 1.5, fast: 2 };
    const multiplier = speedMultipliers[speed];
    return {
      percentageFaster: Math.floor(15 * multiplier + Math.random() * 10),
      monthsFaster: Math.floor(3 * multiplier + Math.random() * 2),
    };
  };

  const getPayoffResults = (speed: Speed) => {
    const speedMultipliers = { conservative: 1, optimal: 1.5, fast: 2 };
    const multiplier = speedMultipliers[speed];
    return {
      moneySaved: Math.floor((20000 + Math.random() * 30000) * multiplier),
      monthsFaster: Math.floor(3 * multiplier + Math.random() * 2),
    };
  };

  const handleGoalToggle = (goal: GoalType) => {
    // Allow toggling both goals (changed from radio behavior)
    setGoals((prev) =>
      prev.includes(goal) ? prev.filter((g) => g !== goal) : [...prev, goal]
    );
  };

  const handleGoalNext = () => {
    if (goals.includes("save")) {
      setStep("save-input");
    } else if (goals.includes("payoff")) {
      setStep("payoff-input");
    }
  };

  const handleCalculateSave = () => {
    if (goals.includes("payoff")) {
      // If both goals, go to payoff after save
      setStep("payoff-input");
    } else {
      setStep("save-result");
    }
  };

  const handleCalculatePayoff = () => {
    setStep("payoff-result");
  };

  const handleComplete = () => {
    // Map to API structure
    let mode: "save" | "close_loans" | "both" | null = null;
    
    if (goals.includes("save") && goals.includes("payoff")) {
      mode = "both";
    } else if (goals.includes("save")) {
      mode = "save";
    } else if (goals.includes("payoff")) {
      mode = "close_loans";
    }

    const goalsData = {
      mode,
      save_amount: goals.includes("save") ? parseFloat(saveAmount) : null,
      save_speed: goals.includes("save") ? saveSpeed : null,
      close_loan_ids: goals.includes("payoff") ? payoffLoans : [],
      close_speed: goals.includes("payoff") ? payoffSpeed : null,
    };

    // In real app: POST /api/goals
    // Body: { user_id, mode, save: {...}, close: {...} }
    
    onNext(goalsData);
  };

  // Goal Selection Screen
  if (step === "goal") {
    return (
      <div className="w-full max-w-md mx-auto">
        <div className="text-center mb-6 md:mb-8">
          <h1 className="mb-3 md:mb-4">–ö–∞–∫–∞—è —É —Ç–µ–±—è —Ü–µ–ª—å?</h1>
          <p className="text-[var(--color-text-secondary)]">
            –≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –Ω–∞–º —Å–æ–∑–¥–∞—Ç—å –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–ª–∞–Ω
          </p>
        </div>

        <div className="space-y-3 mb-6 md:mb-8">
          <div
            onClick={() => handleGoalToggle("save")}
            className={`
              w-full p-4 md:p-6 rounded-xl border-2 transition-all cursor-pointer
              ${
                goals.includes("save")
                  ? "border-[var(--color-brand-primary)] bg-[var(--color-brand-primary)] bg-opacity-5"
                  : "border-[var(--color-stroke-divider)] hover:border-[var(--color-brand-primary-light)]"
              }
            `}
          >
            <div className="flex items-center gap-3">
              <Checkbox
                checked={goals.includes("save")}
                onCheckedChange={() => handleGoalToggle("save")}
                onClick={(e) => e.stopPropagation()}
              />
              <div className="w-12 h-12 rounded-xl bg-[var(--color-brand-primary)] bg-opacity-10 flex items-center justify-center flex-shrink-0">
                <span className="text-2xl">üí∞</span>
              </div>
              <div>
                <p className="text-[var(--color-text-primary)] mb-1">–•–æ—á—É –Ω–∞–∫–æ–ø–∏—Ç—å –¥–µ–Ω–µ–≥</p>
                <p className="caption text-[var(--color-text-secondary)]">
                  –°–æ–∑–¥–∞–¥–∏–º –ø–ª–∞–Ω –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π
                </p>
              </div>
            </div>
          </div>

          <div
            onClick={() => handleGoalToggle("payoff")}
            className={`
              w-full p-4 md:p-6 rounded-xl border-2 transition-all cursor-pointer
              ${
                goals.includes("payoff")
                  ? "border-[var(--color-brand-primary)] bg-[var(--color-brand-primary)] bg-opacity-5"
                  : "border-[var(--color-stroke-divider)] hover:border-[var(--color-brand-primary-light)]"
              }
            `}
          >
            <div className="flex items-center gap-3">
              <Checkbox
                checked={goals.includes("payoff")}
                onCheckedChange={() => handleGoalToggle("payoff")}
                onClick={(e) => e.stopPropagation()}
              />
              <div className="w-12 h-12 rounded-xl bg-[var(--color-brand-primary)] bg-opacity-10 flex items-center justify-center flex-shrink-0">
                <span className="text-2xl">üéØ</span>
              </div>
              <div>
                <p className="text-[var(--color-text-primary)] mb-1">–ó–∞–∫—Ä—ã—Ç—å –∫—Ä–µ–¥–∏—Ç(—ã)</p>
                <p className="caption text-[var(--color-text-secondary)]">
                  –ü–æ–º–æ–∂–µ–º –±—ã—Å—Ç—Ä–µ–µ –∏–∑–±–∞–≤–∏—Ç—å—Å—è –æ—Ç –¥–æ–ª–≥–æ–≤
                </p>
              </div>
            </div>
          </div>
        </div>

        <div className="flex flex-col md:flex-row gap-3">
          <Button
            variant="outline"
            size="lg"
            onClick={onBack}
            className="w-full md:w-auto h-12 md:h-14 rounded-xl border-[var(--color-stroke-divider)] text-[var(--color-text-primary)]"
          >
            –ù–∞–∑–∞–¥
          </Button>
          <Button
            size="lg"
            onClick={handleGoalNext}
            disabled={goals.length === 0}
            className="w-full md:flex-1 h-12 md:h-14 rounded-xl bg-[var(--color-brand-primary)] hover:bg-[var(--color-brand-primary-hover)] text-white"
          >
            –î–∞–ª–µ–µ
          </Button>
        </div>
      </div>
    );
  }

  // Save Input Screen
  if (step === "save-input") {
    const speedIndex = SPEED_OPTIONS.indexOf(saveSpeed);

    return (
      <div className="w-full max-w-md mx-auto">
        {/* Amount Input Section */}
        <div className="mb-8 md:mb-12">
          <div className="text-center mb-6">
            <h2 className="mb-3">–°–∫–æ–ª—å–∫–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å?</h2>
          </div>
          <div className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-6 md:p-8">
            <Label htmlFor="save-amount" className="text-[var(--color-text-primary)] mb-3 block">
              –¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞
            </Label>
            <div className="relative">
              <Input
                id="save-amount"
                type="number"
                placeholder="100000"
                value={saveAmount}
                onChange={(e) => setSaveAmount(e.target.value)}
                className="h-14 md:h-16 rounded-xl border-[var(--color-stroke-input)] bg-[var(--color-bg-primary)] pr-12 text-center"
              />
              <span className="absolute right-4 top-1/2 -translate-y-1/2 text-[var(--color-text-secondary)]">
                ‚ÇΩ
              </span>
            </div>
          </div>
        </div>

        {/* Speed Selection Section */}
        <div className="mb-8 md:mb-12">
          <div className="text-center mb-6">
            <h2 className="mb-2">–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –Ω–∞–∫–æ–ø–∏—Ç—å?</h2>
          </div>
          <div className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-6 md:p-8">
            <div className="mb-6">
              <Slider
                value={[speedIndex]}
                onValueChange={(values) => setSaveSpeed(SPEED_OPTIONS[values[0]])}
                max={2}
                step={1}
                className="mb-4"
              />
              <div className="flex justify-between text-[var(--color-text-secondary)] caption">
                {SPEED_OPTIONS.map((speed) => (
                  <span
                    key={speed}
                    className={saveSpeed === speed ? "text-[var(--color-brand-primary)]" : ""}
                  >
                    {SPEED_LABELS[speed]}
                  </span>
                ))}
              </div>
            </div>
            <div className="text-center">
              <p className="text-[var(--color-text-primary)]">{SPEED_LABELS[saveSpeed]}</p>
            </div>
          </div>
        </div>

        {/* Actions */}
        <div className="flex flex-col md:flex-row gap-3">
          <Button
            variant="outline"
            size="lg"
            onClick={() => setStep("goal")}
            className="w-full md:w-auto h-12 md:h-14 rounded-xl border-[var(--color-stroke-divider)] text-[var(--color-text-primary)]"
          >
            –ù–∞–∑–∞–¥
          </Button>
          <Button
            size="lg"
            onClick={handleCalculateSave}
            disabled={!saveAmount || parseFloat(saveAmount) <= 0}
            className="w-full md:flex-1 h-12 md:h-14 rounded-xl bg-[var(--color-brand-primary)] hover:bg-[var(--color-brand-primary-hover)] text-white"
          >
            {goals.includes("payoff") ? "–î–∞–ª–µ–µ" : "–†–∞—Å—Å—á–∏—Ç–∞—Ç—å"}
          </Button>
        </div>
      </div>
    );
  }

  // Payoff Input Screen
  if (step === "payoff-input") {
    const speedIndex = SPEED_OPTIONS.indexOf(payoffSpeed);

    return (
      <div className="w-full max-w-md mx-auto">
        {/* Total Loans Section */}
        <div className="mb-8 md:mb-12">
          <div className="text-center mb-6">
            <h2 className="mb-3">–û–±—â–∞—è —Å—É–º–º–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤</h2>
          </div>
          <div className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-6 md:p-8">
            <div className="text-center">
              <p className="text-[var(--color-text-primary)]">
                {totalLoanAmount.toLocaleString('ru-RU')} ‚ÇΩ
              </p>
            </div>
          </div>
        </div>

        {/* Speed Selection Section */}
        <div className="mb-8 md:mb-12">
          <div className="text-center mb-6">
            <h2 className="mb-2">–ö–∞–∫ –±—ã—Å—Ç—Ä–æ –≤—ã —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–µ–¥–∏—Ç(—ã)?</h2>
          </div>
          <div className="bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl p-6 md:p-8">
            <div className="mb-6">
              <Slider
                value={[speedIndex]}
                onValueChange={(values) => setPayoffSpeed(SPEED_OPTIONS[values[0]])}
                max={2}
                step={1}
                className="mb-4"
              />
              <div className="flex justify-between text-[var(--color-text-secondary)] caption">
                {SPEED_OPTIONS.map((speed) => (
                  <span
                    key={speed}
                    className={payoffSpeed === speed ? "text-[var(--color-brand-primary)]" : ""}
                  >
                    {SPEED_LABELS[speed]}
                  </span>
                ))}
              </div>
            </div>
            <div className="text-center">
              <p className="text-[var(--color-text-primary)]">{SPEED_LABELS[payoffSpeed]}</p>
            </div>
          </div>
        </div>

        {/* Actions */}
        <div className="flex flex-col md:flex-row gap-3">
          <Button
            variant="outline"
            size="lg"
            onClick={() => goals.includes("save") ? setStep("save-input") : setStep("goal")}
            className="w-full md:w-auto h-12 md:h-14 rounded-xl border-[var(--color-stroke-divider)] text-[var(--color-text-primary)]"
          >
            –ù–∞–∑–∞–¥
          </Button>
          <Button
            size="lg"
            onClick={handleCalculatePayoff}
            className="w-full md:flex-1 h-12 md:h-14 rounded-xl bg-[var(--color-brand-primary)] hover:bg-[var(--color-brand-primary-hover)] text-white"
          >
            –†–∞—Å—Å—á–∏—Ç–∞—Ç—å
          </Button>
        </div>
      </div>
    );
  }

  // Combined Results Screen
  if (step === "save-result" || step === "payoff-result") {
    const saveResults = goals.includes("save") ? getSaveResults(saveSpeed) : null;
    const payoffResults = goals.includes("payoff") ? getPayoffResults(payoffSpeed) : null;

    return (
      <div className="w-full max-w-2xl mx-auto">
        <div className="text-center mb-8 md:mb-12">
          <h1 className="mb-3">
            {goals.length === 2 
              ? "–í–∞—à –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–ª–∞–Ω –≥–æ—Ç–æ–≤" 
              : goals.includes("save") 
                ? "–í–∞—à–∏ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è —Ä–∞—Å—Ç—É—Ç –±—ã—Å—Ç—Ä–µ–µ —Å –Ω–∞–º–∏"
                : "–í–∞—à –ø—É—Ç—å –∫ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π —Å–≤–æ–±–æ–¥–µ —É—Å–∫–æ—Ä—è–µ—Ç—Å—è"
            }
          </h1>
        </div>

        <div className="grid md:grid-cols-2 gap-4 md:gap-6 mb-8 md:mb-12">
          {/* Save Results */}
          {saveResults && (
            <>
              <div className="bg-gradient-to-br from-purple-50 to-white dark:from-purple-900/20 dark:to-purple-800/10 border border-[var(--color-stroke-divider)] rounded-2xl p-6 md:p-8">
                <div className="text-center">
                  <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-[var(--color-brand-primary)] bg-opacity-10 flex items-center justify-center">
                    <span className="text-3xl">üìà</span>
                  </div>
                  <p className="caption text-[var(--color-text-secondary)] mb-2">
                    –°–∫–æ—Ä–æ—Å—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è
                  </p>
                  <p className="text-[var(--color-text-primary)] mb-1">
                    –ó–∞—Ä–∞–±–æ—Ç–∞–π—Ç–µ –Ω–∞ {saveResults.percentageFaster}% –±—ã—Å—Ç—Ä–µ–µ —Å –Ω–∞–º–∏
                  </p>
                </div>
              </div>

              <div className="bg-gradient-to-br from-purple-50 to-white dark:from-purple-900/20 dark:to-purple-800/10 border border-[var(--color-stroke-divider)] rounded-2xl p-6 md:p-8">
                <div className="text-center">
                  <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-[var(--color-brand-primary)] bg-opacity-10 flex items-center justify-center">
                    <span className="text-3xl">‚è±Ô∏è</span>
                  </div>
                  <p className="caption text-[var(--color-text-secondary)] mb-2">
                    –í—Ä–µ–º—è –¥–æ —Ü–µ–ª–∏
                  </p>
                  <p className="text-[var(--color-text-primary)] mb-1">
                    –ù–∞ {saveResults.monthsFaster} {saveResults.monthsFaster === 1 ? '–º–µ—Å—è—Ü' : saveResults.monthsFaster < 5 ? '–º–µ—Å—è—Ü–∞' : '–º–µ—Å—è—Ü–µ–≤'} –±—ã—Å—Ç—Ä–µ–µ
                  </p>
                </div>
              </div>
            </>
          )}

          {/* Payoff Results */}
          {payoffResults && (
            <>
              <div className="bg-gradient-to-br from-purple-50 to-white dark:from-purple-900/20 dark:to-purple-800/10 border border-[var(--color-stroke-divider)] rounded-2xl p-6 md:p-8">
                <div className="text-center">
                  <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-[var(--color-brand-primary)] bg-opacity-10 flex items-center justify-center">
                    <span className="text-3xl">üíµ</span>
                  </div>
                  <p className="caption text-[var(--color-text-secondary)] mb-2">
                    –í—ã –º–æ–∂–µ—Ç–µ —Å—ç–∫–æ–Ω–æ–º–∏—Ç—å
                  </p>
                  <p className="text-[var(--color-text-primary)] mb-1">
                    {payoffResults.moneySaved.toLocaleString('ru-RU')} ‚ÇΩ
                  </p>
                </div>
              </div>

              <div className="bg-gradient-to-br from-purple-50 to-white dark:from-purple-900/20 dark:to-purple-800/10 border border-[var(--color-stroke-divider)] rounded-2xl p-6 md:p-8">
                <div className="text-center">
                  <div className="w-16 h-16 mx-auto mb-4 rounded-2xl bg-[var(--color-brand-primary)] bg-opacity-10 flex items-center justify-center">
                    <span className="text-3xl">‚ö°</span>
                  </div>
                  <p className="caption text-[var(--color-text-secondary)] mb-2">
                    –ó–∞–∫—Ä–æ–µ—Ç–µ –±—ã—Å—Ç—Ä–µ–µ
                  </p>
                  <p className="text-[var(--color-text-primary)] mb-1">
                    –ù–∞ {payoffResults.monthsFaster} {payoffResults.monthsFaster === 1 ? '–º–µ—Å—è—Ü' : payoffResults.monthsFaster < 5 ? '–º–µ—Å—è—Ü–∞' : '–º–µ—Å—è—Ü–µ–≤'} –±—ã—Å—Ç—Ä–µ–µ
                  </p>
                </div>
              </div>
            </>
          )}
        </div>

        {/* Action */}
        <div className="flex justify-center">
          <Button
            size="lg"
            onClick={handleComplete}
            className="w-full md:w-auto min-w-[200px] h-12 md:h-14 rounded-xl bg-[var(--color-brand-primary)] hover:bg-[var(--color-brand-primary-hover)] text-white"
          >
            –ó–∞–≤–µ—Ä—à–∏—Ç—å
          </Button>
        </div>
      </div>
    );
  }

  return null;
}
</file>

<file path="Figma_Front/src/components/ui/accordion.tsx">
"use client";

import * as React from "react";
import * as AccordionPrimitive from "@radix-ui/react-accordion@1.2.3";
import { ChevronDownIcon } from "lucide-react@0.487.0";

import { cn } from "./utils";

function Accordion({
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Root>) {
  return <AccordionPrimitive.Root data-slot="accordion" {...props} />;
}

function AccordionItem({
  className,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Item>) {
  return (
    <AccordionPrimitive.Item
      data-slot="accordion-item"
      className={cn("border-b last:border-b-0", className)}
      {...props}
    />
  );
}

function AccordionTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Trigger>) {
  return (
    <AccordionPrimitive.Header className="flex">
      <AccordionPrimitive.Trigger
        data-slot="accordion-trigger"
        className={cn(
          "focus-visible:border-ring focus-visible:ring-ring/50 flex flex-1 items-start justify-between gap-4 rounded-md py-4 text-left text-sm font-medium transition-all outline-none hover:underline focus-visible:ring-[3px] disabled:pointer-events-none disabled:opacity-50 [&[data-state=open]>svg]:rotate-180",
          className,
        )}
        {...props}
      >
        {children}
        <ChevronDownIcon className="text-muted-foreground pointer-events-none size-4 shrink-0 translate-y-0.5 transition-transform duration-200" />
      </AccordionPrimitive.Trigger>
    </AccordionPrimitive.Header>
  );
}

function AccordionContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof AccordionPrimitive.Content>) {
  return (
    <AccordionPrimitive.Content
      data-slot="accordion-content"
      className="data-[state=closed]:animate-accordion-up data-[state=open]:animate-accordion-down overflow-hidden text-sm"
      {...props}
    >
      <div className={cn("pt-0 pb-4", className)}>{children}</div>
    </AccordionPrimitive.Content>
  );
}

export { Accordion, AccordionItem, AccordionTrigger, AccordionContent };
</file>

<file path="Figma_Front/src/components/ui/alert-dialog.tsx">
"use client";

import * as React from "react";
import * as AlertDialogPrimitive from "@radix-ui/react-alert-dialog@1.1.6";

import { cn } from "./utils";
import { buttonVariants } from "./button";

function AlertDialog({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Root>) {
  return <AlertDialogPrimitive.Root data-slot="alert-dialog" {...props} />;
}

function AlertDialogTrigger({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Trigger>) {
  return (
    <AlertDialogPrimitive.Trigger data-slot="alert-dialog-trigger" {...props} />
  );
}

function AlertDialogPortal({
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Portal>) {
  return (
    <AlertDialogPrimitive.Portal data-slot="alert-dialog-portal" {...props} />
  );
}

function AlertDialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Overlay>) {
  return (
    <AlertDialogPrimitive.Overlay
      data-slot="alert-dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className,
      )}
      {...props}
    />
  );
}

function AlertDialogContent({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Content>) {
  return (
    <AlertDialogPortal>
      <AlertDialogOverlay />
      <AlertDialogPrimitive.Content
        data-slot="alert-dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className,
        )}
        {...props}
      />
    </AlertDialogPortal>
  );
}

function AlertDialogHeader({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  );
}

function AlertDialogFooter({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className,
      )}
      {...props}
    />
  );
}

function AlertDialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Title>) {
  return (
    <AlertDialogPrimitive.Title
      data-slot="alert-dialog-title"
      className={cn("text-lg font-semibold", className)}
      {...props}
    />
  );
}

function AlertDialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Description>) {
  return (
    <AlertDialogPrimitive.Description
      data-slot="alert-dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

function AlertDialogAction({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Action>) {
  return (
    <AlertDialogPrimitive.Action
      className={cn(buttonVariants(), className)}
      {...props}
    />
  );
}

function AlertDialogCancel({
  className,
  ...props
}: React.ComponentProps<typeof AlertDialogPrimitive.Cancel>) {
  return (
    <AlertDialogPrimitive.Cancel
      className={cn(buttonVariants({ variant: "outline" }), className)}
      {...props}
    />
  );
}

export {
  AlertDialog,
  AlertDialogPortal,
  AlertDialogOverlay,
  AlertDialogTrigger,
  AlertDialogContent,
  AlertDialogHeader,
  AlertDialogFooter,
  AlertDialogTitle,
  AlertDialogDescription,
  AlertDialogAction,
  AlertDialogCancel,
};
</file>

<file path="Figma_Front/src/components/ui/alert.tsx">
import * as React from "react";
import { cva, type VariantProps } from "class-variance-authority@0.7.1";

import { cn } from "./utils";

const alertVariants = cva(
  "relative w-full rounded-lg border px-4 py-3 text-sm grid has-[>svg]:grid-cols-[calc(var(--spacing)*4)_1fr] grid-cols-[0_1fr] has-[>svg]:gap-x-3 gap-y-0.5 items-start [&>svg]:size-4 [&>svg]:translate-y-0.5 [&>svg]:text-current",
  {
    variants: {
      variant: {
        default: "bg-card text-card-foreground",
        destructive:
          "text-destructive bg-card [&>svg]:text-current *:data-[slot=alert-description]:text-destructive/90",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

function Alert({
  className,
  variant,
  ...props
}: React.ComponentProps<"div"> & VariantProps<typeof alertVariants>) {
  return (
    <div
      data-slot="alert"
      role="alert"
      className={cn(alertVariants({ variant }), className)}
      {...props}
    />
  );
}

function AlertTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-title"
      className={cn(
        "col-start-2 line-clamp-1 min-h-4 font-medium tracking-tight",
        className,
      )}
      {...props}
    />
  );
}

function AlertDescription({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="alert-description"
      className={cn(
        "text-muted-foreground col-start-2 grid justify-items-start gap-1 text-sm [&_p]:leading-relaxed",
        className,
      )}
      {...props}
    />
  );
}

export { Alert, AlertTitle, AlertDescription };
</file>

<file path="Figma_Front/src/components/ui/aspect-ratio.tsx">
"use client";

import * as AspectRatioPrimitive from "@radix-ui/react-aspect-ratio@1.1.2";

function AspectRatio({
  ...props
}: React.ComponentProps<typeof AspectRatioPrimitive.Root>) {
  return <AspectRatioPrimitive.Root data-slot="aspect-ratio" {...props} />;
}

export { AspectRatio };
</file>

<file path="Figma_Front/src/components/ui/avatar.tsx">
"use client";

import * as React from "react";
import * as AvatarPrimitive from "@radix-ui/react-avatar@1.1.3";

import { cn } from "./utils";

function Avatar({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Root>) {
  return (
    <AvatarPrimitive.Root
      data-slot="avatar"
      className={cn(
        "relative flex size-10 shrink-0 overflow-hidden rounded-full",
        className,
      )}
      {...props}
    />
  );
}

function AvatarImage({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Image>) {
  return (
    <AvatarPrimitive.Image
      data-slot="avatar-image"
      className={cn("aspect-square size-full", className)}
      {...props}
    />
  );
}

function AvatarFallback({
  className,
  ...props
}: React.ComponentProps<typeof AvatarPrimitive.Fallback>) {
  return (
    <AvatarPrimitive.Fallback
      data-slot="avatar-fallback"
      className={cn(
        "bg-muted flex size-full items-center justify-center rounded-full",
        className,
      )}
      {...props}
    />
  );
}

export { Avatar, AvatarImage, AvatarFallback };
</file>

<file path="Figma_Front/src/components/ui/badge.tsx">
import * as React from "react";
import { Slot } from "@radix-ui/react-slot@1.1.2";
import { cva, type VariantProps } from "class-variance-authority@0.7.1";

import { cn } from "./utils";

const badgeVariants = cva(
  "inline-flex items-center justify-center rounded-md border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden",
  {
    variants: {
      variant: {
        default:
          "border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90",
        secondary:
          "border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90",
        destructive:
          "border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground",
      },
    },
    defaultVariants: {
      variant: "default",
    },
  },
);

function Badge({
  className,
  variant,
  asChild = false,
  ...props
}: React.ComponentProps<"span"> &
  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "span";

  return (
    <Comp
      data-slot="badge"
      className={cn(badgeVariants({ variant }), className)}
      {...props}
    />
  );
}

export { Badge, badgeVariants };
</file>

<file path="Figma_Front/src/components/ui/breadcrumb.tsx">
import * as React from "react";
import { Slot } from "@radix-ui/react-slot@1.1.2";
import { ChevronRight, MoreHorizontal } from "lucide-react@0.487.0";

import { cn } from "./utils";

function Breadcrumb({ ...props }: React.ComponentProps<"nav">) {
  return <nav aria-label="breadcrumb" data-slot="breadcrumb" {...props} />;
}

function BreadcrumbList({ className, ...props }: React.ComponentProps<"ol">) {
  return (
    <ol
      data-slot="breadcrumb-list"
      className={cn(
        "text-muted-foreground flex flex-wrap items-center gap-1.5 text-sm break-words sm:gap-2.5",
        className,
      )}
      {...props}
    />
  );
}

function BreadcrumbItem({ className, ...props }: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-item"
      className={cn("inline-flex items-center gap-1.5", className)}
      {...props}
    />
  );
}

function BreadcrumbLink({
  asChild,
  className,
  ...props
}: React.ComponentProps<"a"> & {
  asChild?: boolean;
}) {
  const Comp = asChild ? Slot : "a";

  return (
    <Comp
      data-slot="breadcrumb-link"
      className={cn("hover:text-foreground transition-colors", className)}
      {...props}
    />
  );
}

function BreadcrumbPage({ className, ...props }: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-page"
      role="link"
      aria-disabled="true"
      aria-current="page"
      className={cn("text-foreground font-normal", className)}
      {...props}
    />
  );
}

function BreadcrumbSeparator({
  children,
  className,
  ...props
}: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="breadcrumb-separator"
      role="presentation"
      aria-hidden="true"
      className={cn("[&>svg]:size-3.5", className)}
      {...props}
    >
      {children ?? <ChevronRight />}
    </li>
  );
}

function BreadcrumbEllipsis({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="breadcrumb-ellipsis"
      role="presentation"
      aria-hidden="true"
      className={cn("flex size-9 items-center justify-center", className)}
      {...props}
    >
      <MoreHorizontal className="size-4" />
      <span className="sr-only">More</span>
    </span>
  );
}

export {
  Breadcrumb,
  BreadcrumbList,
  BreadcrumbItem,
  BreadcrumbLink,
  BreadcrumbPage,
  BreadcrumbSeparator,
  BreadcrumbEllipsis,
};
</file>

<file path="Figma_Front/src/components/ui/button.tsx">
import * as React from "react";
import { Slot } from "@radix-ui/react-slot@1.1.2";
import { cva, type VariantProps } from "class-variance-authority@0.7.1";

import { cn } from "./utils";

const buttonVariants = cva(
  "inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-all disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 shrink-0 [&_svg]:shrink-0 outline-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive:
          "bg-destructive text-white hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60",
        outline:
          "border bg-background text-foreground hover:bg-accent hover:text-accent-foreground dark:bg-input/30 dark:border-input dark:hover:bg-input/50",
        secondary:
          "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost:
          "hover:bg-accent hover:text-accent-foreground dark:hover:bg-accent/50",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-9 px-4 py-2 has-[>svg]:px-3",
        sm: "h-8 rounded-md gap-1.5 px-3 has-[>svg]:px-2.5",
        lg: "h-10 rounded-md px-6 has-[>svg]:px-4",
        icon: "size-9 rounded-md",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

function Button({
  className,
  variant,
  size,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> &
  VariantProps<typeof buttonVariants> & {
    asChild?: boolean;
  }) {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      data-slot="button"
      className={cn(buttonVariants({ variant, size, className }))}
      {...props}
    />
  );
}

export { Button, buttonVariants };
</file>

<file path="Figma_Front/src/components/ui/calendar.tsx">
"use client";

import * as React from "react";
import { ChevronLeft, ChevronRight } from "lucide-react@0.487.0";
import { DayPicker } from "react-day-picker@8.10.1";

import { cn } from "./utils";
import { buttonVariants } from "./button";

function Calendar({
  className,
  classNames,
  showOutsideDays = true,
  ...props
}: React.ComponentProps<typeof DayPicker>) {
  return (
    <DayPicker
      showOutsideDays={showOutsideDays}
      className={cn("p-3", className)}
      classNames={{
        months: "flex flex-col sm:flex-row gap-2",
        month: "flex flex-col gap-4",
        caption: "flex justify-center pt-1 relative items-center w-full",
        caption_label: "text-sm font-medium",
        nav: "flex items-center gap-1",
        nav_button: cn(
          buttonVariants({ variant: "outline" }),
          "size-7 bg-transparent p-0 opacity-50 hover:opacity-100",
        ),
        nav_button_previous: "absolute left-1",
        nav_button_next: "absolute right-1",
        table: "w-full border-collapse space-x-1",
        head_row: "flex",
        head_cell:
          "text-muted-foreground rounded-md w-8 font-normal text-[0.8rem]",
        row: "flex w-full mt-2",
        cell: cn(
          "relative p-0 text-center text-sm focus-within:relative focus-within:z-20 [&:has([aria-selected])]:bg-accent [&:has([aria-selected].day-range-end)]:rounded-r-md",
          props.mode === "range"
            ? "[&:has(>.day-range-end)]:rounded-r-md [&:has(>.day-range-start)]:rounded-l-md first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md"
            : "[&:has([aria-selected])]:rounded-md",
        ),
        day: cn(
          buttonVariants({ variant: "ghost" }),
          "size-8 p-0 font-normal aria-selected:opacity-100",
        ),
        day_range_start:
          "day-range-start aria-selected:bg-primary aria-selected:text-primary-foreground",
        day_range_end:
          "day-range-end aria-selected:bg-primary aria-selected:text-primary-foreground",
        day_selected:
          "bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",
        day_today: "bg-accent text-accent-foreground",
        day_outside:
          "day-outside text-muted-foreground aria-selected:text-muted-foreground",
        day_disabled: "text-muted-foreground opacity-50",
        day_range_middle:
          "aria-selected:bg-accent aria-selected:text-accent-foreground",
        day_hidden: "invisible",
        ...classNames,
      }}
      components={{
        IconLeft: ({ className, ...props }) => (
          <ChevronLeft className={cn("size-4", className)} {...props} />
        ),
        IconRight: ({ className, ...props }) => (
          <ChevronRight className={cn("size-4", className)} {...props} />
        ),
      }}
      {...props}
    />
  );
}

export { Calendar };
</file>

<file path="Figma_Front/src/components/ui/card.tsx">
import * as React from "react";

import { cn } from "./utils";

function Card({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card"
      className={cn(
        "bg-card text-card-foreground flex flex-col gap-6 rounded-xl border",
        className,
      )}
      {...props}
    />
  );
}

function CardHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-header"
      className={cn(
        "@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-1.5 px-6 pt-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6",
        className,
      )}
      {...props}
    />
  );
}

function CardTitle({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <h4
      data-slot="card-title"
      className={cn("leading-none", className)}
      {...props}
    />
  );
}

function CardDescription({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <p
      data-slot="card-description"
      className={cn("text-muted-foreground", className)}
      {...props}
    />
  );
}

function CardAction({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-action"
      className={cn(
        "col-start-2 row-span-2 row-start-1 self-start justify-self-end",
        className,
      )}
      {...props}
    />
  );
}

function CardContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-content"
      className={cn("px-6 [&:last-child]:pb-6", className)}
      {...props}
    />
  );
}

function CardFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="card-footer"
      className={cn("flex items-center px-6 pb-6 [.border-t]:pt-6", className)}
      {...props}
    />
  );
}

export {
  Card,
  CardHeader,
  CardFooter,
  CardTitle,
  CardAction,
  CardDescription,
  CardContent,
};
</file>

<file path="Figma_Front/src/components/ui/carousel.tsx">
"use client";

import * as React from "react";
import useEmblaCarousel, {
  type UseEmblaCarouselType,
} from "embla-carousel-react@8.6.0";
import { ArrowLeft, ArrowRight } from "lucide-react@0.487.0";

import { cn } from "./utils";
import { Button } from "./button";

type CarouselApi = UseEmblaCarouselType[1];
type UseCarouselParameters = Parameters<typeof useEmblaCarousel>;
type CarouselOptions = UseCarouselParameters[0];
type CarouselPlugin = UseCarouselParameters[1];

type CarouselProps = {
  opts?: CarouselOptions;
  plugins?: CarouselPlugin;
  orientation?: "horizontal" | "vertical";
  setApi?: (api: CarouselApi) => void;
};

type CarouselContextProps = {
  carouselRef: ReturnType<typeof useEmblaCarousel>[0];
  api: ReturnType<typeof useEmblaCarousel>[1];
  scrollPrev: () => void;
  scrollNext: () => void;
  canScrollPrev: boolean;
  canScrollNext: boolean;
} & CarouselProps;

const CarouselContext = React.createContext<CarouselContextProps | null>(null);

function useCarousel() {
  const context = React.useContext(CarouselContext);

  if (!context) {
    throw new Error("useCarousel must be used within a <Carousel />");
  }

  return context;
}

function Carousel({
  orientation = "horizontal",
  opts,
  setApi,
  plugins,
  className,
  children,
  ...props
}: React.ComponentProps<"div"> & CarouselProps) {
  const [carouselRef, api] = useEmblaCarousel(
    {
      ...opts,
      axis: orientation === "horizontal" ? "x" : "y",
    },
    plugins,
  );
  const [canScrollPrev, setCanScrollPrev] = React.useState(false);
  const [canScrollNext, setCanScrollNext] = React.useState(false);

  const onSelect = React.useCallback((api: CarouselApi) => {
    if (!api) return;
    setCanScrollPrev(api.canScrollPrev());
    setCanScrollNext(api.canScrollNext());
  }, []);

  const scrollPrev = React.useCallback(() => {
    api?.scrollPrev();
  }, [api]);

  const scrollNext = React.useCallback(() => {
    api?.scrollNext();
  }, [api]);

  const handleKeyDown = React.useCallback(
    (event: React.KeyboardEvent<HTMLDivElement>) => {
      if (event.key === "ArrowLeft") {
        event.preventDefault();
        scrollPrev();
      } else if (event.key === "ArrowRight") {
        event.preventDefault();
        scrollNext();
      }
    },
    [scrollPrev, scrollNext],
  );

  React.useEffect(() => {
    if (!api || !setApi) return;
    setApi(api);
  }, [api, setApi]);

  React.useEffect(() => {
    if (!api) return;
    onSelect(api);
    api.on("reInit", onSelect);
    api.on("select", onSelect);

    return () => {
      api?.off("select", onSelect);
    };
  }, [api, onSelect]);

  return (
    <CarouselContext.Provider
      value={{
        carouselRef,
        api: api,
        opts,
        orientation:
          orientation || (opts?.axis === "y" ? "vertical" : "horizontal"),
        scrollPrev,
        scrollNext,
        canScrollPrev,
        canScrollNext,
      }}
    >
      <div
        onKeyDownCapture={handleKeyDown}
        className={cn("relative", className)}
        role="region"
        aria-roledescription="carousel"
        data-slot="carousel"
        {...props}
      >
        {children}
      </div>
    </CarouselContext.Provider>
  );
}

function CarouselContent({ className, ...props }: React.ComponentProps<"div">) {
  const { carouselRef, orientation } = useCarousel();

  return (
    <div
      ref={carouselRef}
      className="overflow-hidden"
      data-slot="carousel-content"
    >
      <div
        className={cn(
          "flex",
          orientation === "horizontal" ? "-ml-4" : "-mt-4 flex-col",
          className,
        )}
        {...props}
      />
    </div>
  );
}

function CarouselItem({ className, ...props }: React.ComponentProps<"div">) {
  const { orientation } = useCarousel();

  return (
    <div
      role="group"
      aria-roledescription="slide"
      data-slot="carousel-item"
      className={cn(
        "min-w-0 shrink-0 grow-0 basis-full",
        orientation === "horizontal" ? "pl-4" : "pt-4",
        className,
      )}
      {...props}
    />
  );
}

function CarouselPrevious({
  className,
  variant = "outline",
  size = "icon",
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollPrev, canScrollPrev } = useCarousel();

  return (
    <Button
      data-slot="carousel-previous"
      variant={variant}
      size={size}
      className={cn(
        "absolute size-8 rounded-full",
        orientation === "horizontal"
          ? "top-1/2 -left-12 -translate-y-1/2"
          : "-top-12 left-1/2 -translate-x-1/2 rotate-90",
        className,
      )}
      disabled={!canScrollPrev}
      onClick={scrollPrev}
      {...props}
    >
      <ArrowLeft />
      <span className="sr-only">Previous slide</span>
    </Button>
  );
}

function CarouselNext({
  className,
  variant = "outline",
  size = "icon",
  ...props
}: React.ComponentProps<typeof Button>) {
  const { orientation, scrollNext, canScrollNext } = useCarousel();

  return (
    <Button
      data-slot="carousel-next"
      variant={variant}
      size={size}
      className={cn(
        "absolute size-8 rounded-full",
        orientation === "horizontal"
          ? "top-1/2 -right-12 -translate-y-1/2"
          : "-bottom-12 left-1/2 -translate-x-1/2 rotate-90",
        className,
      )}
      disabled={!canScrollNext}
      onClick={scrollNext}
      {...props}
    >
      <ArrowRight />
      <span className="sr-only">Next slide</span>
    </Button>
  );
}

export {
  type CarouselApi,
  Carousel,
  CarouselContent,
  CarouselItem,
  CarouselPrevious,
  CarouselNext,
};
</file>

<file path="Figma_Front/src/components/ui/chart.tsx">
"use client";

import * as React from "react";
import * as RechartsPrimitive from "recharts@2.15.2";

import { cn } from "./utils";

// Format: { THEME_NAME: CSS_SELECTOR }
const THEMES = { light: "", dark: ".dark" } as const;

export type ChartConfig = {
  [k in string]: {
    label?: React.ReactNode;
    icon?: React.ComponentType;
  } & (
    | { color?: string; theme?: never }
    | { color?: never; theme: Record<keyof typeof THEMES, string> }
  );
};

type ChartContextProps = {
  config: ChartConfig;
};

const ChartContext = React.createContext<ChartContextProps | null>(null);

function useChart() {
  const context = React.useContext(ChartContext);

  if (!context) {
    throw new Error("useChart must be used within a <ChartContainer />");
  }

  return context;
}

function ChartContainer({
  id,
  className,
  children,
  config,
  ...props
}: React.ComponentProps<"div"> & {
  config: ChartConfig;
  children: React.ComponentProps<
    typeof RechartsPrimitive.ResponsiveContainer
  >["children"];
}) {
  const uniqueId = React.useId();
  const chartId = `chart-${id || uniqueId.replace(/:/g, "")}`;

  return (
    <ChartContext.Provider value={{ config }}>
      <div
        data-slot="chart"
        data-chart={chartId}
        className={cn(
          "[&_.recharts-cartesian-axis-tick_text]:fill-muted-foreground [&_.recharts-cartesian-grid_line[stroke='#ccc']]:stroke-border/50 [&_.recharts-curve.recharts-tooltip-cursor]:stroke-border [&_.recharts-polar-grid_[stroke='#ccc']]:stroke-border [&_.recharts-radial-bar-background-sector]:fill-muted [&_.recharts-rectangle.recharts-tooltip-cursor]:fill-muted [&_.recharts-reference-line_[stroke='#ccc']]:stroke-border flex aspect-video justify-center text-xs [&_.recharts-dot[stroke='#fff']]:stroke-transparent [&_.recharts-layer]:outline-hidden [&_.recharts-sector]:outline-hidden [&_.recharts-sector[stroke='#fff']]:stroke-transparent [&_.recharts-surface]:outline-hidden",
          className,
        )}
        {...props}
      >
        <ChartStyle id={chartId} config={config} />
        <RechartsPrimitive.ResponsiveContainer>
          {children}
        </RechartsPrimitive.ResponsiveContainer>
      </div>
    </ChartContext.Provider>
  );
}

const ChartStyle = ({ id, config }: { id: string; config: ChartConfig }) => {
  const colorConfig = Object.entries(config).filter(
    ([, config]) => config.theme || config.color,
  );

  if (!colorConfig.length) {
    return null;
  }

  return (
    <style
      dangerouslySetInnerHTML={{
        __html: Object.entries(THEMES)
          .map(
            ([theme, prefix]) => `
${prefix} [data-chart=${id}] {
${colorConfig
  .map(([key, itemConfig]) => {
    const color =
      itemConfig.theme?.[theme as keyof typeof itemConfig.theme] ||
      itemConfig.color;
    return color ? `  --color-${key}: ${color};` : null;
  })
  .join("\n")}
}
`,
          )
          .join("\n"),
      }}
    />
  );
};

const ChartTooltip = RechartsPrimitive.Tooltip;

function ChartTooltipContent({
  active,
  payload,
  className,
  indicator = "dot",
  hideLabel = false,
  hideIndicator = false,
  label,
  labelFormatter,
  labelClassName,
  formatter,
  color,
  nameKey,
  labelKey,
}: React.ComponentProps<typeof RechartsPrimitive.Tooltip> &
  React.ComponentProps<"div"> & {
    hideLabel?: boolean;
    hideIndicator?: boolean;
    indicator?: "line" | "dot" | "dashed";
    nameKey?: string;
    labelKey?: string;
  }) {
  const { config } = useChart();

  const tooltipLabel = React.useMemo(() => {
    if (hideLabel || !payload?.length) {
      return null;
    }

    const [item] = payload;
    const key = `${labelKey || item?.dataKey || item?.name || "value"}`;
    const itemConfig = getPayloadConfigFromPayload(config, item, key);
    const value =
      !labelKey && typeof label === "string"
        ? config[label as keyof typeof config]?.label || label
        : itemConfig?.label;

    if (labelFormatter) {
      return (
        <div className={cn("font-medium", labelClassName)}>
          {labelFormatter(value, payload)}
        </div>
      );
    }

    if (!value) {
      return null;
    }

    return <div className={cn("font-medium", labelClassName)}>{value}</div>;
  }, [
    label,
    labelFormatter,
    payload,
    hideLabel,
    labelClassName,
    config,
    labelKey,
  ]);

  if (!active || !payload?.length) {
    return null;
  }

  const nestLabel = payload.length === 1 && indicator !== "dot";

  return (
    <div
      className={cn(
        "border-border/50 bg-background grid min-w-[8rem] items-start gap-1.5 rounded-lg border px-2.5 py-1.5 text-xs shadow-xl",
        className,
      )}
    >
      {!nestLabel ? tooltipLabel : null}
      <div className="grid gap-1.5">
        {payload.map((item, index) => {
          const key = `${nameKey || item.name || item.dataKey || "value"}`;
          const itemConfig = getPayloadConfigFromPayload(config, item, key);
          const indicatorColor = color || item.payload.fill || item.color;

          return (
            <div
              key={item.dataKey}
              className={cn(
                "[&>svg]:text-muted-foreground flex w-full flex-wrap items-stretch gap-2 [&>svg]:h-2.5 [&>svg]:w-2.5",
                indicator === "dot" && "items-center",
              )}
            >
              {formatter && item?.value !== undefined && item.name ? (
                formatter(item.value, item.name, item, index, item.payload)
              ) : (
                <>
                  {itemConfig?.icon ? (
                    <itemConfig.icon />
                  ) : (
                    !hideIndicator && (
                      <div
                        className={cn(
                          "shrink-0 rounded-[2px] border-(--color-border) bg-(--color-bg)",
                          {
                            "h-2.5 w-2.5": indicator === "dot",
                            "w-1": indicator === "line",
                            "w-0 border-[1.5px] border-dashed bg-transparent":
                              indicator === "dashed",
                            "my-0.5": nestLabel && indicator === "dashed",
                          },
                        )}
                        style={
                          {
                            "--color-bg": indicatorColor,
                            "--color-border": indicatorColor,
                          } as React.CSSProperties
                        }
                      />
                    )
                  )}
                  <div
                    className={cn(
                      "flex flex-1 justify-between leading-none",
                      nestLabel ? "items-end" : "items-center",
                    )}
                  >
                    <div className="grid gap-1.5">
                      {nestLabel ? tooltipLabel : null}
                      <span className="text-muted-foreground">
                        {itemConfig?.label || item.name}
                      </span>
                    </div>
                    {item.value && (
                      <span className="text-foreground font-mono font-medium tabular-nums">
                        {item.value.toLocaleString()}
                      </span>
                    )}
                  </div>
                </>
              )}
            </div>
          );
        })}
      </div>
    </div>
  );
}

const ChartLegend = RechartsPrimitive.Legend;

function ChartLegendContent({
  className,
  hideIcon = false,
  payload,
  verticalAlign = "bottom",
  nameKey,
}: React.ComponentProps<"div"> &
  Pick<RechartsPrimitive.LegendProps, "payload" | "verticalAlign"> & {
    hideIcon?: boolean;
    nameKey?: string;
  }) {
  const { config } = useChart();

  if (!payload?.length) {
    return null;
  }

  return (
    <div
      className={cn(
        "flex items-center justify-center gap-4",
        verticalAlign === "top" ? "pb-3" : "pt-3",
        className,
      )}
    >
      {payload.map((item) => {
        const key = `${nameKey || item.dataKey || "value"}`;
        const itemConfig = getPayloadConfigFromPayload(config, item, key);

        return (
          <div
            key={item.value}
            className={cn(
              "[&>svg]:text-muted-foreground flex items-center gap-1.5 [&>svg]:h-3 [&>svg]:w-3",
            )}
          >
            {itemConfig?.icon && !hideIcon ? (
              <itemConfig.icon />
            ) : (
              <div
                className="h-2 w-2 shrink-0 rounded-[2px]"
                style={{
                  backgroundColor: item.color,
                }}
              />
            )}
            {itemConfig?.label}
          </div>
        );
      })}
    </div>
  );
}

// Helper to extract item config from a payload.
function getPayloadConfigFromPayload(
  config: ChartConfig,
  payload: unknown,
  key: string,
) {
  if (typeof payload !== "object" || payload === null) {
    return undefined;
  }

  const payloadPayload =
    "payload" in payload &&
    typeof payload.payload === "object" &&
    payload.payload !== null
      ? payload.payload
      : undefined;

  let configLabelKey: string = key;

  if (
    key in payload &&
    typeof payload[key as keyof typeof payload] === "string"
  ) {
    configLabelKey = payload[key as keyof typeof payload] as string;
  } else if (
    payloadPayload &&
    key in payloadPayload &&
    typeof payloadPayload[key as keyof typeof payloadPayload] === "string"
  ) {
    configLabelKey = payloadPayload[
      key as keyof typeof payloadPayload
    ] as string;
  }

  return configLabelKey in config
    ? config[configLabelKey]
    : config[key as keyof typeof config];
}

export {
  ChartContainer,
  ChartTooltip,
  ChartTooltipContent,
  ChartLegend,
  ChartLegendContent,
  ChartStyle,
};
</file>

<file path="Figma_Front/src/components/ui/checkbox.tsx">
"use client";

import * as React from "react";
import * as CheckboxPrimitive from "@radix-ui/react-checkbox@1.1.4";
import { CheckIcon } from "lucide-react@0.487.0";

import { cn } from "./utils";

function Checkbox({
  className,
  ...props
}: React.ComponentProps<typeof CheckboxPrimitive.Root>) {
  return (
    <CheckboxPrimitive.Root
      data-slot="checkbox"
      className={cn(
        "peer border bg-input-background dark:bg-input/30 data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground dark:data-[state=checked]:bg-primary data-[state=checked]:border-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive size-4 shrink-0 rounded-[4px] border shadow-xs transition-shadow outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      {...props}
    >
      <CheckboxPrimitive.Indicator
        data-slot="checkbox-indicator"
        className="flex items-center justify-center text-current transition-none"
      >
        <CheckIcon className="size-3.5" />
      </CheckboxPrimitive.Indicator>
    </CheckboxPrimitive.Root>
  );
}

export { Checkbox };
</file>

<file path="Figma_Front/src/components/ui/collapsible.tsx">
"use client";

import * as CollapsiblePrimitive from "@radix-ui/react-collapsible@1.1.3";

function Collapsible({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.Root>) {
  return <CollapsiblePrimitive.Root data-slot="collapsible" {...props} />;
}

function CollapsibleTrigger({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleTrigger>) {
  return (
    <CollapsiblePrimitive.CollapsibleTrigger
      data-slot="collapsible-trigger"
      {...props}
    />
  );
}

function CollapsibleContent({
  ...props
}: React.ComponentProps<typeof CollapsiblePrimitive.CollapsibleContent>) {
  return (
    <CollapsiblePrimitive.CollapsibleContent
      data-slot="collapsible-content"
      {...props}
    />
  );
}

export { Collapsible, CollapsibleTrigger, CollapsibleContent };
</file>

<file path="Figma_Front/src/components/ui/command.tsx">
"use client";

import * as React from "react";
import { Command as CommandPrimitive } from "cmdk@1.1.1";
import { SearchIcon } from "lucide-react@0.487.0";

import { cn } from "./utils";
import {
  Dialog,
  DialogContent,
  DialogDescription,
  DialogHeader,
  DialogTitle,
} from "./dialog";

function Command({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive>) {
  return (
    <CommandPrimitive
      data-slot="command"
      className={cn(
        "bg-popover text-popover-foreground flex h-full w-full flex-col overflow-hidden rounded-md",
        className,
      )}
      {...props}
    />
  );
}

function CommandDialog({
  title = "Command Palette",
  description = "Search for a command to run...",
  children,
  ...props
}: React.ComponentProps<typeof Dialog> & {
  title?: string;
  description?: string;
}) {
  return (
    <Dialog {...props}>
      <DialogHeader className="sr-only">
        <DialogTitle>{title}</DialogTitle>
        <DialogDescription>{description}</DialogDescription>
      </DialogHeader>
      <DialogContent className="overflow-hidden p-0">
        <Command className="[&_[cmdk-group-heading]]:text-muted-foreground **:data-[slot=command-input-wrapper]:h-12 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group]]:px-2 [&_[cmdk-group]:not([hidden])_~[cmdk-group]]:pt-0 [&_[cmdk-input-wrapper]_svg]:h-5 [&_[cmdk-input-wrapper]_svg]:w-5 [&_[cmdk-input]]:h-12 [&_[cmdk-item]]:px-2 [&_[cmdk-item]]:py-3 [&_[cmdk-item]_svg]:h-5 [&_[cmdk-item]_svg]:w-5">
          {children}
        </Command>
      </DialogContent>
    </Dialog>
  );
}

function CommandInput({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Input>) {
  return (
    <div
      data-slot="command-input-wrapper"
      className="flex h-9 items-center gap-2 border-b px-3"
    >
      <SearchIcon className="size-4 shrink-0 opacity-50" />
      <CommandPrimitive.Input
        data-slot="command-input"
        className={cn(
          "placeholder:text-muted-foreground flex h-10 w-full rounded-md bg-transparent py-3 text-sm outline-hidden disabled:cursor-not-allowed disabled:opacity-50",
          className,
        )}
        {...props}
      />
    </div>
  );
}

function CommandList({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.List>) {
  return (
    <CommandPrimitive.List
      data-slot="command-list"
      className={cn(
        "max-h-[300px] scroll-py-1 overflow-x-hidden overflow-y-auto",
        className,
      )}
      {...props}
    />
  );
}

function CommandEmpty({
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Empty>) {
  return (
    <CommandPrimitive.Empty
      data-slot="command-empty"
      className="py-6 text-center text-sm"
      {...props}
    />
  );
}

function CommandGroup({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Group>) {
  return (
    <CommandPrimitive.Group
      data-slot="command-group"
      className={cn(
        "text-foreground [&_[cmdk-group-heading]]:text-muted-foreground overflow-hidden p-1 [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium",
        className,
      )}
      {...props}
    />
  );
}

function CommandSeparator({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Separator>) {
  return (
    <CommandPrimitive.Separator
      data-slot="command-separator"
      className={cn("bg-border -mx-1 h-px", className)}
      {...props}
    />
  );
}

function CommandItem({
  className,
  ...props
}: React.ComponentProps<typeof CommandPrimitive.Item>) {
  return (
    <CommandPrimitive.Item
      data-slot="command-item"
      className={cn(
        "data-[selected=true]:bg-accent data-[selected=true]:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled=true]:pointer-events-none data-[disabled=true]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function CommandShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="command-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className,
      )}
      {...props}
    />
  );
}

export {
  Command,
  CommandDialog,
  CommandInput,
  CommandList,
  CommandEmpty,
  CommandGroup,
  CommandItem,
  CommandShortcut,
  CommandSeparator,
};
</file>

<file path="Figma_Front/src/components/ui/context-menu.tsx">
"use client";

import * as React from "react";
import * as ContextMenuPrimitive from "@radix-ui/react-context-menu@2.2.6";
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react@0.487.0";

import { cn } from "./utils";

function ContextMenu({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Root>) {
  return <ContextMenuPrimitive.Root data-slot="context-menu" {...props} />;
}

function ContextMenuTrigger({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Trigger>) {
  return (
    <ContextMenuPrimitive.Trigger data-slot="context-menu-trigger" {...props} />
  );
}

function ContextMenuGroup({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Group>) {
  return (
    <ContextMenuPrimitive.Group data-slot="context-menu-group" {...props} />
  );
}

function ContextMenuPortal({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Portal>) {
  return (
    <ContextMenuPrimitive.Portal data-slot="context-menu-portal" {...props} />
  );
}

function ContextMenuSub({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Sub>) {
  return <ContextMenuPrimitive.Sub data-slot="context-menu-sub" {...props} />;
}

function ContextMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.RadioGroup>) {
  return (
    <ContextMenuPrimitive.RadioGroup
      data-slot="context-menu-radio-group"
      {...props}
    />
  );
}

function ContextMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.SubTrigger> & {
  inset?: boolean;
}) {
  return (
    <ContextMenuPrimitive.SubTrigger
      data-slot="context-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto" />
    </ContextMenuPrimitive.SubTrigger>
  );
}

function ContextMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.SubContent>) {
  return (
    <ContextMenuPrimitive.SubContent
      data-slot="context-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-context-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className,
      )}
      {...props}
    />
  );
}

function ContextMenuContent({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Content>) {
  return (
    <ContextMenuPrimitive.Portal>
      <ContextMenuPrimitive.Content
        data-slot="context-menu-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-context-menu-content-available-height) min-w-[8rem] origin-(--radix-context-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className,
        )}
        {...props}
      />
    </ContextMenuPrimitive.Portal>
  );
}

function ContextMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Item> & {
  inset?: boolean;
  variant?: "default" | "destructive";
}) {
  return (
    <ContextMenuPrimitive.Item
      data-slot="context-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function ContextMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.CheckboxItem>) {
  return (
    <ContextMenuPrimitive.CheckboxItem
      data-slot="context-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <ContextMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </ContextMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </ContextMenuPrimitive.CheckboxItem>
  );
}

function ContextMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.RadioItem>) {
  return (
    <ContextMenuPrimitive.RadioItem
      data-slot="context-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <ContextMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </ContextMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </ContextMenuPrimitive.RadioItem>
  );
}

function ContextMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Label> & {
  inset?: boolean;
}) {
  return (
    <ContextMenuPrimitive.Label
      data-slot="context-menu-label"
      data-inset={inset}
      className={cn(
        "text-foreground px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className,
      )}
      {...props}
    />
  );
}

function ContextMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof ContextMenuPrimitive.Separator>) {
  return (
    <ContextMenuPrimitive.Separator
      data-slot="context-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function ContextMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="context-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className,
      )}
      {...props}
    />
  );
}

export {
  ContextMenu,
  ContextMenuTrigger,
  ContextMenuContent,
  ContextMenuItem,
  ContextMenuCheckboxItem,
  ContextMenuRadioItem,
  ContextMenuLabel,
  ContextMenuSeparator,
  ContextMenuShortcut,
  ContextMenuGroup,
  ContextMenuPortal,
  ContextMenuSub,
  ContextMenuSubContent,
  ContextMenuSubTrigger,
  ContextMenuRadioGroup,
};
</file>

<file path="Figma_Front/src/components/ui/dialog.tsx">
"use client";

import * as React from "react";
import * as DialogPrimitive from "@radix-ui/react-dialog@1.1.6";
import { XIcon } from "lucide-react@0.487.0";

import { cn } from "./utils";

function Dialog({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Root>) {
  return <DialogPrimitive.Root data-slot="dialog" {...props} />;
}

function DialogTrigger({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Trigger>) {
  return <DialogPrimitive.Trigger data-slot="dialog-trigger" {...props} />;
}

function DialogPortal({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Portal>) {
  return <DialogPrimitive.Portal data-slot="dialog-portal" {...props} />;
}

function DialogClose({
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Close>) {
  return <DialogPrimitive.Close data-slot="dialog-close" {...props} />;
}

function DialogOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Overlay>) {
  return (
    <DialogPrimitive.Overlay
      data-slot="dialog-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className,
      )}
      {...props}
    />
  );
}

function DialogContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Content>) {
  return (
    <DialogPortal data-slot="dialog-portal">
      <DialogOverlay />
      <DialogPrimitive.Content
        data-slot="dialog-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 fixed top-[50%] left-[50%] z-50 grid w-full max-w-[calc(100%-2rem)] translate-x-[-50%] translate-y-[-50%] gap-4 rounded-lg border p-6 shadow-lg duration-200 sm:max-w-lg",
          className,
        )}
        {...props}
      >
        {children}
        <DialogPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-accent data-[state=open]:text-muted-foreground absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4">
          <XIcon />
          <span className="sr-only">Close</span>
        </DialogPrimitive.Close>
      </DialogPrimitive.Content>
    </DialogPortal>
  );
}

function DialogHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-header"
      className={cn("flex flex-col gap-2 text-center sm:text-left", className)}
      {...props}
    />
  );
}

function DialogFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="dialog-footer"
      className={cn(
        "flex flex-col-reverse gap-2 sm:flex-row sm:justify-end",
        className,
      )}
      {...props}
    />
  );
}

function DialogTitle({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Title>) {
  return (
    <DialogPrimitive.Title
      data-slot="dialog-title"
      className={cn("text-lg leading-none font-semibold", className)}
      {...props}
    />
  );
}

function DialogDescription({
  className,
  ...props
}: React.ComponentProps<typeof DialogPrimitive.Description>) {
  return (
    <DialogPrimitive.Description
      data-slot="dialog-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

export {
  Dialog,
  DialogClose,
  DialogContent,
  DialogDescription,
  DialogFooter,
  DialogHeader,
  DialogOverlay,
  DialogPortal,
  DialogTitle,
  DialogTrigger,
};
</file>

<file path="Figma_Front/src/components/ui/drawer.tsx">
"use client";

import * as React from "react";
import { Drawer as DrawerPrimitive } from "vaul@1.1.2";

import { cn } from "./utils";

function Drawer({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Root>) {
  return <DrawerPrimitive.Root data-slot="drawer" {...props} />;
}

function DrawerTrigger({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Trigger>) {
  return <DrawerPrimitive.Trigger data-slot="drawer-trigger" {...props} />;
}

function DrawerPortal({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Portal>) {
  return <DrawerPrimitive.Portal data-slot="drawer-portal" {...props} />;
}

function DrawerClose({
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Close>) {
  return <DrawerPrimitive.Close data-slot="drawer-close" {...props} />;
}

function DrawerOverlay({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Overlay>) {
  return (
    <DrawerPrimitive.Overlay
      data-slot="drawer-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className,
      )}
      {...props}
    />
  );
}

function DrawerContent({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Content>) {
  return (
    <DrawerPortal data-slot="drawer-portal">
      <DrawerOverlay />
      <DrawerPrimitive.Content
        data-slot="drawer-content"
        className={cn(
          "group/drawer-content bg-background fixed z-50 flex h-auto flex-col",
          "data-[vaul-drawer-direction=top]:inset-x-0 data-[vaul-drawer-direction=top]:top-0 data-[vaul-drawer-direction=top]:mb-24 data-[vaul-drawer-direction=top]:max-h-[80vh] data-[vaul-drawer-direction=top]:rounded-b-lg data-[vaul-drawer-direction=top]:border-b",
          "data-[vaul-drawer-direction=bottom]:inset-x-0 data-[vaul-drawer-direction=bottom]:bottom-0 data-[vaul-drawer-direction=bottom]:mt-24 data-[vaul-drawer-direction=bottom]:max-h-[80vh] data-[vaul-drawer-direction=bottom]:rounded-t-lg data-[vaul-drawer-direction=bottom]:border-t",
          "data-[vaul-drawer-direction=right]:inset-y-0 data-[vaul-drawer-direction=right]:right-0 data-[vaul-drawer-direction=right]:w-3/4 data-[vaul-drawer-direction=right]:border-l data-[vaul-drawer-direction=right]:sm:max-w-sm",
          "data-[vaul-drawer-direction=left]:inset-y-0 data-[vaul-drawer-direction=left]:left-0 data-[vaul-drawer-direction=left]:w-3/4 data-[vaul-drawer-direction=left]:border-r data-[vaul-drawer-direction=left]:sm:max-w-sm",
          className,
        )}
        {...props}
      >
        <div className="bg-muted mx-auto mt-4 hidden h-2 w-[100px] shrink-0 rounded-full group-data-[vaul-drawer-direction=bottom]/drawer-content:block" />
        {children}
      </DrawerPrimitive.Content>
    </DrawerPortal>
  );
}

function DrawerHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="drawer-header"
      className={cn("flex flex-col gap-1.5 p-4", className)}
      {...props}
    />
  );
}

function DrawerFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="drawer-footer"
      className={cn("mt-auto flex flex-col gap-2 p-4", className)}
      {...props}
    />
  );
}

function DrawerTitle({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Title>) {
  return (
    <DrawerPrimitive.Title
      data-slot="drawer-title"
      className={cn("text-foreground font-semibold", className)}
      {...props}
    />
  );
}

function DrawerDescription({
  className,
  ...props
}: React.ComponentProps<typeof DrawerPrimitive.Description>) {
  return (
    <DrawerPrimitive.Description
      data-slot="drawer-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

export {
  Drawer,
  DrawerPortal,
  DrawerOverlay,
  DrawerTrigger,
  DrawerClose,
  DrawerContent,
  DrawerHeader,
  DrawerFooter,
  DrawerTitle,
  DrawerDescription,
};
</file>

<file path="Figma_Front/src/components/ui/dropdown-menu.tsx">
"use client";

import * as React from "react";
import * as DropdownMenuPrimitive from "@radix-ui/react-dropdown-menu@2.1.6";
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react@0.487.0";

import { cn } from "./utils";

function DropdownMenu({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Root>) {
  return <DropdownMenuPrimitive.Root data-slot="dropdown-menu" {...props} />;
}

function DropdownMenuPortal({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Portal>) {
  return (
    <DropdownMenuPrimitive.Portal data-slot="dropdown-menu-portal" {...props} />
  );
}

function DropdownMenuTrigger({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Trigger>) {
  return (
    <DropdownMenuPrimitive.Trigger
      data-slot="dropdown-menu-trigger"
      {...props}
    />
  );
}

function DropdownMenuContent({
  className,
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Content>) {
  return (
    <DropdownMenuPrimitive.Portal>
      <DropdownMenuPrimitive.Content
        data-slot="dropdown-menu-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 max-h-(--radix-dropdown-menu-content-available-height) min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border p-1 shadow-md",
          className,
        )}
        {...props}
      />
    </DropdownMenuPrimitive.Portal>
  );
}

function DropdownMenuGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Group>) {
  return (
    <DropdownMenuPrimitive.Group data-slot="dropdown-menu-group" {...props} />
  );
}

function DropdownMenuItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Item> & {
  inset?: boolean;
  variant?: "default" | "destructive";
}) {
  return (
    <DropdownMenuPrimitive.Item
      data-slot="dropdown-menu-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function DropdownMenuCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.CheckboxItem>) {
  return (
    <DropdownMenuPrimitive.CheckboxItem
      data-slot="dropdown-menu-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.CheckboxItem>
  );
}

function DropdownMenuRadioGroup({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioGroup>) {
  return (
    <DropdownMenuPrimitive.RadioGroup
      data-slot="dropdown-menu-radio-group"
      {...props}
    />
  );
}

function DropdownMenuRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.RadioItem>) {
  return (
    <DropdownMenuPrimitive.RadioItem
      data-slot="dropdown-menu-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-sm py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <DropdownMenuPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </DropdownMenuPrimitive.ItemIndicator>
      </span>
      {children}
    </DropdownMenuPrimitive.RadioItem>
  );
}

function DropdownMenuLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Label> & {
  inset?: boolean;
}) {
  return (
    <DropdownMenuPrimitive.Label
      data-slot="dropdown-menu-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className,
      )}
      {...props}
    />
  );
}

function DropdownMenuSeparator({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Separator>) {
  return (
    <DropdownMenuPrimitive.Separator
      data-slot="dropdown-menu-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function DropdownMenuShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="dropdown-menu-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className,
      )}
      {...props}
    />
  );
}

function DropdownMenuSub({
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.Sub>) {
  return <DropdownMenuPrimitive.Sub data-slot="dropdown-menu-sub" {...props} />;
}

function DropdownMenuSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubTrigger> & {
  inset?: boolean;
}) {
  return (
    <DropdownMenuPrimitive.SubTrigger
      data-slot="dropdown-menu-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[inset]:pl-8",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto size-4" />
    </DropdownMenuPrimitive.SubTrigger>
  );
}

function DropdownMenuSubContent({
  className,
  ...props
}: React.ComponentProps<typeof DropdownMenuPrimitive.SubContent>) {
  return (
    <DropdownMenuPrimitive.SubContent
      data-slot="dropdown-menu-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-dropdown-menu-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className,
      )}
      {...props}
    />
  );
}

export {
  DropdownMenu,
  DropdownMenuPortal,
  DropdownMenuTrigger,
  DropdownMenuContent,
  DropdownMenuGroup,
  DropdownMenuLabel,
  DropdownMenuItem,
  DropdownMenuCheckboxItem,
  DropdownMenuRadioGroup,
  DropdownMenuRadioItem,
  DropdownMenuSeparator,
  DropdownMenuShortcut,
  DropdownMenuSub,
  DropdownMenuSubTrigger,
  DropdownMenuSubContent,
};
</file>

<file path="Figma_Front/src/components/ui/form.tsx">
"use client";

import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label@2.1.2";
import { Slot } from "@radix-ui/react-slot@1.1.2";
import {
  Controller,
  FormProvider,
  useFormContext,
  useFormState,
  type ControllerProps,
  type FieldPath,
  type FieldValues,
} from "react-hook-form@7.55.0";

import { cn } from "./utils";
import { Label } from "./label";

const Form = FormProvider;

type FormFieldContextValue<
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
> = {
  name: TName;
};

const FormFieldContext = React.createContext<FormFieldContextValue>(
  {} as FormFieldContextValue,
);

const FormField = <
  TFieldValues extends FieldValues = FieldValues,
  TName extends FieldPath<TFieldValues> = FieldPath<TFieldValues>,
>({
  ...props
}: ControllerProps<TFieldValues, TName>) => {
  return (
    <FormFieldContext.Provider value={{ name: props.name }}>
      <Controller {...props} />
    </FormFieldContext.Provider>
  );
};

const useFormField = () => {
  const fieldContext = React.useContext(FormFieldContext);
  const itemContext = React.useContext(FormItemContext);
  const { getFieldState } = useFormContext();
  const formState = useFormState({ name: fieldContext.name });
  const fieldState = getFieldState(fieldContext.name, formState);

  if (!fieldContext) {
    throw new Error("useFormField should be used within <FormField>");
  }

  const { id } = itemContext;

  return {
    id,
    name: fieldContext.name,
    formItemId: `${id}-form-item`,
    formDescriptionId: `${id}-form-item-description`,
    formMessageId: `${id}-form-item-message`,
    ...fieldState,
  };
};

type FormItemContextValue = {
  id: string;
};

const FormItemContext = React.createContext<FormItemContextValue>(
  {} as FormItemContextValue,
);

function FormItem({ className, ...props }: React.ComponentProps<"div">) {
  const id = React.useId();

  return (
    <FormItemContext.Provider value={{ id }}>
      <div
        data-slot="form-item"
        className={cn("grid gap-2", className)}
        {...props}
      />
    </FormItemContext.Provider>
  );
}

function FormLabel({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  const { error, formItemId } = useFormField();

  return (
    <Label
      data-slot="form-label"
      data-error={!!error}
      className={cn("data-[error=true]:text-destructive", className)}
      htmlFor={formItemId}
      {...props}
    />
  );
}

function FormControl({ ...props }: React.ComponentProps<typeof Slot>) {
  const { error, formItemId, formDescriptionId, formMessageId } =
    useFormField();

  return (
    <Slot
      data-slot="form-control"
      id={formItemId}
      aria-describedby={
        !error
          ? `${formDescriptionId}`
          : `${formDescriptionId} ${formMessageId}`
      }
      aria-invalid={!!error}
      {...props}
    />
  );
}

function FormDescription({ className, ...props }: React.ComponentProps<"p">) {
  const { formDescriptionId } = useFormField();

  return (
    <p
      data-slot="form-description"
      id={formDescriptionId}
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

function FormMessage({ className, ...props }: React.ComponentProps<"p">) {
  const { error, formMessageId } = useFormField();
  const body = error ? String(error?.message ?? "") : props.children;

  if (!body) {
    return null;
  }

  return (
    <p
      data-slot="form-message"
      id={formMessageId}
      className={cn("text-destructive text-sm", className)}
      {...props}
    >
      {body}
    </p>
  );
}

export {
  useFormField,
  Form,
  FormItem,
  FormLabel,
  FormControl,
  FormDescription,
  FormMessage,
  FormField,
};
</file>

<file path="Figma_Front/src/components/ui/hover-card.tsx">
"use client";

import * as React from "react";
import * as HoverCardPrimitive from "@radix-ui/react-hover-card@1.1.6";

import { cn } from "./utils";

function HoverCard({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Root>) {
  return <HoverCardPrimitive.Root data-slot="hover-card" {...props} />;
}

function HoverCardTrigger({
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Trigger>) {
  return (
    <HoverCardPrimitive.Trigger data-slot="hover-card-trigger" {...props} />
  );
}

function HoverCardContent({
  className,
  align = "center",
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof HoverCardPrimitive.Content>) {
  return (
    <HoverCardPrimitive.Portal data-slot="hover-card-portal">
      <HoverCardPrimitive.Content
        data-slot="hover-card-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-64 origin-(--radix-hover-card-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",
          className,
        )}
        {...props}
      />
    </HoverCardPrimitive.Portal>
  );
}

export { HoverCard, HoverCardTrigger, HoverCardContent };
</file>

<file path="Figma_Front/src/components/ui/input-otp.tsx">
"use client";

import * as React from "react";
import { OTPInput, OTPInputContext } from "input-otp@1.4.2";
import { MinusIcon } from "lucide-react@0.487.0";

import { cn } from "./utils";

function InputOTP({
  className,
  containerClassName,
  ...props
}: React.ComponentProps<typeof OTPInput> & {
  containerClassName?: string;
}) {
  return (
    <OTPInput
      data-slot="input-otp"
      containerClassName={cn(
        "flex items-center gap-2 has-disabled:opacity-50",
        containerClassName,
      )}
      className={cn("disabled:cursor-not-allowed", className)}
      {...props}
    />
  );
}

function InputOTPGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="input-otp-group"
      className={cn("flex items-center gap-1", className)}
      {...props}
    />
  );
}

function InputOTPSlot({
  index,
  className,
  ...props
}: React.ComponentProps<"div"> & {
  index: number;
}) {
  const inputOTPContext = React.useContext(OTPInputContext);
  const { char, hasFakeCaret, isActive } = inputOTPContext?.slots[index] ?? {};

  return (
    <div
      data-slot="input-otp-slot"
      data-active={isActive}
      className={cn(
        "data-[active=true]:border-ring data-[active=true]:ring-ring/50 data-[active=true]:aria-invalid:ring-destructive/20 dark:data-[active=true]:aria-invalid:ring-destructive/40 aria-invalid:border-destructive data-[active=true]:aria-invalid:border-destructive dark:bg-input/30 border-input relative flex h-9 w-9 items-center justify-center border-y border-r text-sm bg-input-background transition-all outline-none first:rounded-l-md first:border-l last:rounded-r-md data-[active=true]:z-10 data-[active=true]:ring-[3px]",
        className,
      )}
      {...props}
    >
      {char}
      {hasFakeCaret && (
        <div className="pointer-events-none absolute inset-0 flex items-center justify-center">
          <div className="animate-caret-blink bg-foreground h-4 w-px duration-1000" />
        </div>
      )}
    </div>
  );
}

function InputOTPSeparator({ ...props }: React.ComponentProps<"div">) {
  return (
    <div data-slot="input-otp-separator" role="separator" {...props}>
      <MinusIcon />
    </div>
  );
}

export { InputOTP, InputOTPGroup, InputOTPSlot, InputOTPSeparator };
</file>

<file path="Figma_Front/src/components/ui/input.tsx">
import * as React from "react";

import { cn } from "./utils";

function Input({ className, type, ...props }: React.ComponentProps<"input">) {
  return (
    <input
      type={type}
      data-slot="input"
      className={cn(
        "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border px-3 py-1 text-base bg-input-background transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
        "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive",
        className,
      )}
      {...props}
    />
  );
}

export { Input };
</file>

<file path="Figma_Front/src/components/ui/label.tsx">
"use client";

import * as React from "react";
import * as LabelPrimitive from "@radix-ui/react-label@2.1.2";

import { cn } from "./utils";

function Label({
  className,
  ...props
}: React.ComponentProps<typeof LabelPrimitive.Root>) {
  return (
    <LabelPrimitive.Root
      data-slot="label"
      className={cn(
        "flex items-center gap-2 text-sm leading-none font-medium select-none group-data-[disabled=true]:pointer-events-none group-data-[disabled=true]:opacity-50 peer-disabled:cursor-not-allowed peer-disabled:opacity-50",
        className,
      )}
      {...props}
    />
  );
}

export { Label };
</file>

<file path="Figma_Front/src/components/ui/menubar.tsx">
"use client";

import * as React from "react";
import * as MenubarPrimitive from "@radix-ui/react-menubar@1.1.6";
import { CheckIcon, ChevronRightIcon, CircleIcon } from "lucide-react@0.487.0";

import { cn } from "./utils";

function Menubar({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Root>) {
  return (
    <MenubarPrimitive.Root
      data-slot="menubar"
      className={cn(
        "bg-background flex h-9 items-center gap-1 rounded-md border p-1 shadow-xs",
        className,
      )}
      {...props}
    />
  );
}

function MenubarMenu({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Menu>) {
  return <MenubarPrimitive.Menu data-slot="menubar-menu" {...props} />;
}

function MenubarGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Group>) {
  return <MenubarPrimitive.Group data-slot="menubar-group" {...props} />;
}

function MenubarPortal({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Portal>) {
  return <MenubarPrimitive.Portal data-slot="menubar-portal" {...props} />;
}

function MenubarRadioGroup({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioGroup>) {
  return (
    <MenubarPrimitive.RadioGroup data-slot="menubar-radio-group" {...props} />
  );
}

function MenubarTrigger({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Trigger>) {
  return (
    <MenubarPrimitive.Trigger
      data-slot="menubar-trigger"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex items-center rounded-sm px-2 py-1 text-sm font-medium outline-hidden select-none",
        className,
      )}
      {...props}
    />
  );
}

function MenubarContent({
  className,
  align = "start",
  alignOffset = -4,
  sideOffset = 8,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Content>) {
  return (
    <MenubarPortal>
      <MenubarPrimitive.Content
        data-slot="menubar-content"
        align={align}
        alignOffset={alignOffset}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[12rem] origin-(--radix-menubar-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-md",
          className,
        )}
        {...props}
      />
    </MenubarPortal>
  );
}

function MenubarItem({
  className,
  inset,
  variant = "default",
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Item> & {
  inset?: boolean;
  variant?: "default" | "destructive";
}) {
  return (
    <MenubarPrimitive.Item
      data-slot="menubar-item"
      data-inset={inset}
      data-variant={variant}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[variant=destructive]:text-destructive data-[variant=destructive]:focus:bg-destructive/10 dark:data-[variant=destructive]:focus:bg-destructive/20 data-[variant=destructive]:focus:text-destructive data-[variant=destructive]:*:[svg]:!text-destructive [&_svg:not([class*='text-'])]:text-muted-foreground relative flex cursor-default items-center gap-2 rounded-sm px-2 py-1.5 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 data-[inset]:pl-8 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function MenubarCheckboxItem({
  className,
  children,
  checked,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.CheckboxItem>) {
  return (
    <MenubarPrimitive.CheckboxItem
      data-slot="menubar-checkbox-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-xs py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      checked={checked}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <MenubarPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </MenubarPrimitive.ItemIndicator>
      </span>
      {children}
    </MenubarPrimitive.CheckboxItem>
  );
}

function MenubarRadioItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.RadioItem>) {
  return (
    <MenubarPrimitive.RadioItem
      data-slot="menubar-radio-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground relative flex cursor-default items-center gap-2 rounded-xs py-1.5 pr-2 pl-8 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      <span className="pointer-events-none absolute left-2 flex size-3.5 items-center justify-center">
        <MenubarPrimitive.ItemIndicator>
          <CircleIcon className="size-2 fill-current" />
        </MenubarPrimitive.ItemIndicator>
      </span>
      {children}
    </MenubarPrimitive.RadioItem>
  );
}

function MenubarLabel({
  className,
  inset,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Label> & {
  inset?: boolean;
}) {
  return (
    <MenubarPrimitive.Label
      data-slot="menubar-label"
      data-inset={inset}
      className={cn(
        "px-2 py-1.5 text-sm font-medium data-[inset]:pl-8",
        className,
      )}
      {...props}
    />
  );
}

function MenubarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Separator>) {
  return (
    <MenubarPrimitive.Separator
      data-slot="menubar-separator"
      className={cn("bg-border -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function MenubarShortcut({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      data-slot="menubar-shortcut"
      className={cn(
        "text-muted-foreground ml-auto text-xs tracking-widest",
        className,
      )}
      {...props}
    />
  );
}

function MenubarSub({
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.Sub>) {
  return <MenubarPrimitive.Sub data-slot="menubar-sub" {...props} />;
}

function MenubarSubTrigger({
  className,
  inset,
  children,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.SubTrigger> & {
  inset?: boolean;
}) {
  return (
    <MenubarPrimitive.SubTrigger
      data-slot="menubar-sub-trigger"
      data-inset={inset}
      className={cn(
        "focus:bg-accent focus:text-accent-foreground data-[state=open]:bg-accent data-[state=open]:text-accent-foreground flex cursor-default items-center rounded-sm px-2 py-1.5 text-sm outline-none select-none data-[inset]:pl-8",
        className,
      )}
      {...props}
    >
      {children}
      <ChevronRightIcon className="ml-auto h-4 w-4" />
    </MenubarPrimitive.SubTrigger>
  );
}

function MenubarSubContent({
  className,
  ...props
}: React.ComponentProps<typeof MenubarPrimitive.SubContent>) {
  return (
    <MenubarPrimitive.SubContent
      data-slot="menubar-sub-content"
      className={cn(
        "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 min-w-[8rem] origin-(--radix-menubar-content-transform-origin) overflow-hidden rounded-md border p-1 shadow-lg",
        className,
      )}
      {...props}
    />
  );
}

export {
  Menubar,
  MenubarPortal,
  MenubarMenu,
  MenubarTrigger,
  MenubarContent,
  MenubarGroup,
  MenubarSeparator,
  MenubarLabel,
  MenubarItem,
  MenubarShortcut,
  MenubarCheckboxItem,
  MenubarRadioGroup,
  MenubarRadioItem,
  MenubarSub,
  MenubarSubTrigger,
  MenubarSubContent,
};
</file>

<file path="Figma_Front/src/components/ui/navigation-menu.tsx">
import * as React from "react";
import * as NavigationMenuPrimitive from "@radix-ui/react-navigation-menu@1.2.5";
import { cva } from "class-variance-authority@0.7.1";
import { ChevronDownIcon } from "lucide-react@0.487.0";

import { cn } from "./utils";

function NavigationMenu({
  className,
  children,
  viewport = true,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Root> & {
  viewport?: boolean;
}) {
  return (
    <NavigationMenuPrimitive.Root
      data-slot="navigation-menu"
      data-viewport={viewport}
      className={cn(
        "group/navigation-menu relative flex max-w-max flex-1 items-center justify-center",
        className,
      )}
      {...props}
    >
      {children}
      {viewport && <NavigationMenuViewport />}
    </NavigationMenuPrimitive.Root>
  );
}

function NavigationMenuList({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.List>) {
  return (
    <NavigationMenuPrimitive.List
      data-slot="navigation-menu-list"
      className={cn(
        "group flex flex-1 list-none items-center justify-center gap-1",
        className,
      )}
      {...props}
    />
  );
}

function NavigationMenuItem({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Item>) {
  return (
    <NavigationMenuPrimitive.Item
      data-slot="navigation-menu-item"
      className={cn("relative", className)}
      {...props}
    />
  );
}

const navigationMenuTriggerStyle = cva(
  "group inline-flex h-9 w-max items-center justify-center rounded-md bg-background px-4 py-2 text-sm font-medium hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=open]:hover:bg-accent data-[state=open]:text-accent-foreground data-[state=open]:focus:bg-accent data-[state=open]:bg-accent/50 focus-visible:ring-ring/50 outline-none transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1",
);

function NavigationMenuTrigger({
  className,
  children,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Trigger>) {
  return (
    <NavigationMenuPrimitive.Trigger
      data-slot="navigation-menu-trigger"
      className={cn(navigationMenuTriggerStyle(), "group", className)}
      {...props}
    >
      {children}{" "}
      <ChevronDownIcon
        className="relative top-[1px] ml-1 size-3 transition duration-300 group-data-[state=open]:rotate-180"
        aria-hidden="true"
      />
    </NavigationMenuPrimitive.Trigger>
  );
}

function NavigationMenuContent({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Content>) {
  return (
    <NavigationMenuPrimitive.Content
      data-slot="navigation-menu-content"
      className={cn(
        "data-[motion^=from-]:animate-in data-[motion^=to-]:animate-out data-[motion^=from-]:fade-in data-[motion^=to-]:fade-out data-[motion=from-end]:slide-in-from-right-52 data-[motion=from-start]:slide-in-from-left-52 data-[motion=to-end]:slide-out-to-right-52 data-[motion=to-start]:slide-out-to-left-52 top-0 left-0 w-full p-2 pr-2.5 md:absolute md:w-auto",
        "group-data-[viewport=false]/navigation-menu:bg-popover group-data-[viewport=false]/navigation-menu:text-popover-foreground group-data-[viewport=false]/navigation-menu:data-[state=open]:animate-in group-data-[viewport=false]/navigation-menu:data-[state=closed]:animate-out group-data-[viewport=false]/navigation-menu:data-[state=closed]:zoom-out-95 group-data-[viewport=false]/navigation-menu:data-[state=open]:zoom-in-95 group-data-[viewport=false]/navigation-menu:data-[state=open]:fade-in-0 group-data-[viewport=false]/navigation-menu:data-[state=closed]:fade-out-0 group-data-[viewport=false]/navigation-menu:top-full group-data-[viewport=false]/navigation-menu:mt-1.5 group-data-[viewport=false]/navigation-menu:overflow-hidden group-data-[viewport=false]/navigation-menu:rounded-md group-data-[viewport=false]/navigation-menu:border group-data-[viewport=false]/navigation-menu:shadow group-data-[viewport=false]/navigation-menu:duration-200 **:data-[slot=navigation-menu-link]:focus:ring-0 **:data-[slot=navigation-menu-link]:focus:outline-none",
        className,
      )}
      {...props}
    />
  );
}

function NavigationMenuViewport({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Viewport>) {
  return (
    <div
      className={cn(
        "absolute top-full left-0 isolate z-50 flex justify-center",
      )}
    >
      <NavigationMenuPrimitive.Viewport
        data-slot="navigation-menu-viewport"
        className={cn(
          "origin-top-center bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-90 relative mt-1.5 h-[var(--radix-navigation-menu-viewport-height)] w-full overflow-hidden rounded-md border shadow md:w-[var(--radix-navigation-menu-viewport-width)]",
          className,
        )}
        {...props}
      />
    </div>
  );
}

function NavigationMenuLink({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Link>) {
  return (
    <NavigationMenuPrimitive.Link
      data-slot="navigation-menu-link"
      className={cn(
        "data-[active=true]:focus:bg-accent data-[active=true]:hover:bg-accent data-[active=true]:bg-accent/50 data-[active=true]:text-accent-foreground hover:bg-accent hover:text-accent-foreground focus:bg-accent focus:text-accent-foreground focus-visible:ring-ring/50 [&_svg:not([class*='text-'])]:text-muted-foreground flex flex-col gap-1 rounded-sm p-2 text-sm transition-all outline-none focus-visible:ring-[3px] focus-visible:outline-1 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function NavigationMenuIndicator({
  className,
  ...props
}: React.ComponentProps<typeof NavigationMenuPrimitive.Indicator>) {
  return (
    <NavigationMenuPrimitive.Indicator
      data-slot="navigation-menu-indicator"
      className={cn(
        "data-[state=visible]:animate-in data-[state=hidden]:animate-out data-[state=hidden]:fade-out data-[state=visible]:fade-in top-full z-[1] flex h-1.5 items-end justify-center overflow-hidden",
        className,
      )}
      {...props}
    >
      <div className="bg-border relative top-[60%] h-2 w-2 rotate-45 rounded-tl-sm shadow-md" />
    </NavigationMenuPrimitive.Indicator>
  );
}

export {
  NavigationMenu,
  NavigationMenuList,
  NavigationMenuItem,
  NavigationMenuContent,
  NavigationMenuTrigger,
  NavigationMenuLink,
  NavigationMenuIndicator,
  NavigationMenuViewport,
  navigationMenuTriggerStyle,
};
</file>

<file path="Figma_Front/src/components/ui/pagination.tsx">
import * as React from "react";
import {
  ChevronLeftIcon,
  ChevronRightIcon,
  MoreHorizontalIcon,
} from "lucide-react@0.487.0";

import { cn } from "./utils";
import { Button, buttonVariants } from "./button";

function Pagination({ className, ...props }: React.ComponentProps<"nav">) {
  return (
    <nav
      role="navigation"
      aria-label="pagination"
      data-slot="pagination"
      className={cn("mx-auto flex w-full justify-center", className)}
      {...props}
    />
  );
}

function PaginationContent({
  className,
  ...props
}: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="pagination-content"
      className={cn("flex flex-row items-center gap-1", className)}
      {...props}
    />
  );
}

function PaginationItem({ ...props }: React.ComponentProps<"li">) {
  return <li data-slot="pagination-item" {...props} />;
}

type PaginationLinkProps = {
  isActive?: boolean;
} & Pick<React.ComponentProps<typeof Button>, "size"> &
  React.ComponentProps<"a">;

function PaginationLink({
  className,
  isActive,
  size = "icon",
  ...props
}: PaginationLinkProps) {
  return (
    <a
      aria-current={isActive ? "page" : undefined}
      data-slot="pagination-link"
      data-active={isActive}
      className={cn(
        buttonVariants({
          variant: isActive ? "outline" : "ghost",
          size,
        }),
        className,
      )}
      {...props}
    />
  );
}

function PaginationPrevious({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) {
  return (
    <PaginationLink
      aria-label="Go to previous page"
      size="default"
      className={cn("gap-1 px-2.5 sm:pl-2.5", className)}
      {...props}
    >
      <ChevronLeftIcon />
      <span className="hidden sm:block">Previous</span>
    </PaginationLink>
  );
}

function PaginationNext({
  className,
  ...props
}: React.ComponentProps<typeof PaginationLink>) {
  return (
    <PaginationLink
      aria-label="Go to next page"
      size="default"
      className={cn("gap-1 px-2.5 sm:pr-2.5", className)}
      {...props}
    >
      <span className="hidden sm:block">Next</span>
      <ChevronRightIcon />
    </PaginationLink>
  );
}

function PaginationEllipsis({
  className,
  ...props
}: React.ComponentProps<"span">) {
  return (
    <span
      aria-hidden
      data-slot="pagination-ellipsis"
      className={cn("flex size-9 items-center justify-center", className)}
      {...props}
    >
      <MoreHorizontalIcon className="size-4" />
      <span className="sr-only">More pages</span>
    </span>
  );
}

export {
  Pagination,
  PaginationContent,
  PaginationLink,
  PaginationItem,
  PaginationPrevious,
  PaginationNext,
  PaginationEllipsis,
};
</file>

<file path="Figma_Front/src/components/ui/popover.tsx">
"use client";

import * as React from "react";
import * as PopoverPrimitive from "@radix-ui/react-popover@1.1.6";

import { cn } from "./utils";

function Popover({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Root>) {
  return <PopoverPrimitive.Root data-slot="popover" {...props} />;
}

function PopoverTrigger({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Trigger>) {
  return <PopoverPrimitive.Trigger data-slot="popover-trigger" {...props} />;
}

function PopoverContent({
  className,
  align = "center",
  sideOffset = 4,
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Content>) {
  return (
    <PopoverPrimitive.Portal>
      <PopoverPrimitive.Content
        data-slot="popover-content"
        align={align}
        sideOffset={sideOffset}
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-72 origin-(--radix-popover-content-transform-origin) rounded-md border p-4 shadow-md outline-hidden",
          className,
        )}
        {...props}
      />
    </PopoverPrimitive.Portal>
  );
}

function PopoverAnchor({
  ...props
}: React.ComponentProps<typeof PopoverPrimitive.Anchor>) {
  return <PopoverPrimitive.Anchor data-slot="popover-anchor" {...props} />;
}

export { Popover, PopoverTrigger, PopoverContent, PopoverAnchor };
</file>

<file path="Figma_Front/src/components/ui/progress.tsx">
"use client";

import * as React from "react";
import * as ProgressPrimitive from "@radix-ui/react-progress@1.1.2";

import { cn } from "./utils";

function Progress({
  className,
  value,
  ...props
}: React.ComponentProps<typeof ProgressPrimitive.Root>) {
  return (
    <ProgressPrimitive.Root
      data-slot="progress"
      className={cn(
        "bg-primary/20 relative h-2 w-full overflow-hidden rounded-full",
        className,
      )}
      {...props}
    >
      <ProgressPrimitive.Indicator
        data-slot="progress-indicator"
        className="bg-primary h-full w-full flex-1 transition-all"
        style={{ transform: `translateX(-${100 - (value || 0)}%)` }}
      />
    </ProgressPrimitive.Root>
  );
}

export { Progress };
</file>

<file path="Figma_Front/src/components/ui/radio-group.tsx">
"use client";

import * as React from "react";
import * as RadioGroupPrimitive from "@radix-ui/react-radio-group@1.2.3";
import { CircleIcon } from "lucide-react@0.487.0";

import { cn } from "./utils";

function RadioGroup({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Root>) {
  return (
    <RadioGroupPrimitive.Root
      data-slot="radio-group"
      className={cn("grid gap-3", className)}
      {...props}
    />
  );
}

function RadioGroupItem({
  className,
  ...props
}: React.ComponentProps<typeof RadioGroupPrimitive.Item>) {
  return (
    <RadioGroupPrimitive.Item
      data-slot="radio-group-item"
      className={cn(
        "border-input text-primary focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 aspect-square size-4 shrink-0 rounded-full border shadow-xs transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      {...props}
    >
      <RadioGroupPrimitive.Indicator
        data-slot="radio-group-indicator"
        className="relative flex items-center justify-center"
      >
        <CircleIcon className="fill-primary absolute top-1/2 left-1/2 size-2 -translate-x-1/2 -translate-y-1/2" />
      </RadioGroupPrimitive.Indicator>
    </RadioGroupPrimitive.Item>
  );
}

export { RadioGroup, RadioGroupItem };
</file>

<file path="Figma_Front/src/components/ui/resizable.tsx">
"use client";

import * as React from "react";
import { GripVerticalIcon } from "lucide-react@0.487.0";
import * as ResizablePrimitive from "react-resizable-panels@2.1.7";

import { cn } from "./utils";

function ResizablePanelGroup({
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelGroup>) {
  return (
    <ResizablePrimitive.PanelGroup
      data-slot="resizable-panel-group"
      className={cn(
        "flex h-full w-full data-[panel-group-direction=vertical]:flex-col",
        className,
      )}
      {...props}
    />
  );
}

function ResizablePanel({
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.Panel>) {
  return <ResizablePrimitive.Panel data-slot="resizable-panel" {...props} />;
}

function ResizableHandle({
  withHandle,
  className,
  ...props
}: React.ComponentProps<typeof ResizablePrimitive.PanelResizeHandle> & {
  withHandle?: boolean;
}) {
  return (
    <ResizablePrimitive.PanelResizeHandle
      data-slot="resizable-handle"
      className={cn(
        "bg-border focus-visible:ring-ring relative flex w-px items-center justify-center after:absolute after:inset-y-0 after:left-1/2 after:w-1 after:-translate-x-1/2 focus-visible:ring-1 focus-visible:ring-offset-1 focus-visible:outline-hidden data-[panel-group-direction=vertical]:h-px data-[panel-group-direction=vertical]:w-full data-[panel-group-direction=vertical]:after:left-0 data-[panel-group-direction=vertical]:after:h-1 data-[panel-group-direction=vertical]:after:w-full data-[panel-group-direction=vertical]:after:-translate-y-1/2 data-[panel-group-direction=vertical]:after:translate-x-0 [&[data-panel-group-direction=vertical]>div]:rotate-90",
        className,
      )}
      {...props}
    >
      {withHandle && (
        <div className="bg-border z-10 flex h-4 w-3 items-center justify-center rounded-xs border">
          <GripVerticalIcon className="size-2.5" />
        </div>
      )}
    </ResizablePrimitive.PanelResizeHandle>
  );
}

export { ResizablePanelGroup, ResizablePanel, ResizableHandle };
</file>

<file path="Figma_Front/src/components/ui/scroll-area.tsx">
"use client";

import * as React from "react";
import * as ScrollAreaPrimitive from "@radix-ui/react-scroll-area@1.2.3";

import { cn } from "./utils";

function ScrollArea({
  className,
  children,
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.Root>) {
  return (
    <ScrollAreaPrimitive.Root
      data-slot="scroll-area"
      className={cn("relative", className)}
      {...props}
    >
      <ScrollAreaPrimitive.Viewport
        data-slot="scroll-area-viewport"
        className="focus-visible:ring-ring/50 size-full rounded-[inherit] transition-[color,box-shadow] outline-none focus-visible:ring-[3px] focus-visible:outline-1"
      >
        {children}
      </ScrollAreaPrimitive.Viewport>
      <ScrollBar />
      <ScrollAreaPrimitive.Corner />
    </ScrollAreaPrimitive.Root>
  );
}

function ScrollBar({
  className,
  orientation = "vertical",
  ...props
}: React.ComponentProps<typeof ScrollAreaPrimitive.ScrollAreaScrollbar>) {
  return (
    <ScrollAreaPrimitive.ScrollAreaScrollbar
      data-slot="scroll-area-scrollbar"
      orientation={orientation}
      className={cn(
        "flex touch-none p-px transition-colors select-none",
        orientation === "vertical" &&
          "h-full w-2.5 border-l border-l-transparent",
        orientation === "horizontal" &&
          "h-2.5 flex-col border-t border-t-transparent",
        className,
      )}
      {...props}
    >
      <ScrollAreaPrimitive.ScrollAreaThumb
        data-slot="scroll-area-thumb"
        className="bg-border relative flex-1 rounded-full"
      />
    </ScrollAreaPrimitive.ScrollAreaScrollbar>
  );
}

export { ScrollArea, ScrollBar };
</file>

<file path="Figma_Front/src/components/ui/select.tsx">
"use client";

import * as React from "react";
import * as SelectPrimitive from "@radix-ui/react-select@2.1.6";
import {
  CheckIcon,
  ChevronDownIcon,
  ChevronUpIcon,
} from "lucide-react@0.487.0";

import { cn } from "./utils";

function Select({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Root>) {
  return <SelectPrimitive.Root data-slot="select" {...props} />;
}

function SelectGroup({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Group>) {
  return <SelectPrimitive.Group data-slot="select-group" {...props} />;
}

function SelectValue({
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Value>) {
  return <SelectPrimitive.Value data-slot="select-value" {...props} />;
}

function SelectTrigger({
  className,
  size = "default",
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Trigger> & {
  size?: "sm" | "default";
}) {
  return (
    <SelectPrimitive.Trigger
      data-slot="select-trigger"
      data-size={size}
      className={cn(
        "border-input data-[placeholder]:text-muted-foreground [&_svg:not([class*='text-'])]:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 dark:hover:bg-input/50 flex w-full items-center justify-between gap-2 rounded-md border bg-input-background px-3 py-2 text-sm whitespace-nowrap transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 data-[size=default]:h-9 data-[size=sm]:h-8 *:data-[slot=select-value]:line-clamp-1 *:data-[slot=select-value]:flex *:data-[slot=select-value]:items-center *:data-[slot=select-value]:gap-2 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    >
      {children}
      <SelectPrimitive.Icon asChild>
        <ChevronDownIcon className="size-4 opacity-50" />
      </SelectPrimitive.Icon>
    </SelectPrimitive.Trigger>
  );
}

function SelectContent({
  className,
  children,
  position = "popper",
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Content>) {
  return (
    <SelectPrimitive.Portal>
      <SelectPrimitive.Content
        data-slot="select-content"
        className={cn(
          "bg-popover text-popover-foreground data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 relative z-50 max-h-(--radix-select-content-available-height) min-w-[8rem] origin-(--radix-select-content-transform-origin) overflow-x-hidden overflow-y-auto rounded-md border shadow-md",
          position === "popper" &&
            "data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",
          className,
        )}
        position={position}
        {...props}
      >
        <SelectScrollUpButton />
        <SelectPrimitive.Viewport
          className={cn(
            "p-1",
            position === "popper" &&
              "h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)] scroll-my-1",
          )}
        >
          {children}
        </SelectPrimitive.Viewport>
        <SelectScrollDownButton />
      </SelectPrimitive.Content>
    </SelectPrimitive.Portal>
  );
}

function SelectLabel({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Label>) {
  return (
    <SelectPrimitive.Label
      data-slot="select-label"
      className={cn("text-muted-foreground px-2 py-1.5 text-xs", className)}
      {...props}
    />
  );
}

function SelectItem({
  className,
  children,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Item>) {
  return (
    <SelectPrimitive.Item
      data-slot="select-item"
      className={cn(
        "focus:bg-accent focus:text-accent-foreground [&_svg:not([class*='text-'])]:text-muted-foreground relative flex w-full cursor-default items-center gap-2 rounded-sm py-1.5 pr-8 pl-2 text-sm outline-hidden select-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4 *:[span]:last:flex *:[span]:last:items-center *:[span]:last:gap-2",
        className,
      )}
      {...props}
    >
      <span className="absolute right-2 flex size-3.5 items-center justify-center">
        <SelectPrimitive.ItemIndicator>
          <CheckIcon className="size-4" />
        </SelectPrimitive.ItemIndicator>
      </span>
      <SelectPrimitive.ItemText>{children}</SelectPrimitive.ItemText>
    </SelectPrimitive.Item>
  );
}

function SelectSeparator({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.Separator>) {
  return (
    <SelectPrimitive.Separator
      data-slot="select-separator"
      className={cn("bg-border pointer-events-none -mx-1 my-1 h-px", className)}
      {...props}
    />
  );
}

function SelectScrollUpButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollUpButton>) {
  return (
    <SelectPrimitive.ScrollUpButton
      data-slot="select-scroll-up-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className,
      )}
      {...props}
    >
      <ChevronUpIcon className="size-4" />
    </SelectPrimitive.ScrollUpButton>
  );
}

function SelectScrollDownButton({
  className,
  ...props
}: React.ComponentProps<typeof SelectPrimitive.ScrollDownButton>) {
  return (
    <SelectPrimitive.ScrollDownButton
      data-slot="select-scroll-down-button"
      className={cn(
        "flex cursor-default items-center justify-center py-1",
        className,
      )}
      {...props}
    >
      <ChevronDownIcon className="size-4" />
    </SelectPrimitive.ScrollDownButton>
  );
}

export {
  Select,
  SelectContent,
  SelectGroup,
  SelectItem,
  SelectLabel,
  SelectScrollDownButton,
  SelectScrollUpButton,
  SelectSeparator,
  SelectTrigger,
  SelectValue,
};
</file>

<file path="Figma_Front/src/components/ui/separator.tsx">
"use client";

import * as React from "react";
import * as SeparatorPrimitive from "@radix-ui/react-separator@1.1.2";

import { cn } from "./utils";

function Separator({
  className,
  orientation = "horizontal",
  decorative = true,
  ...props
}: React.ComponentProps<typeof SeparatorPrimitive.Root>) {
  return (
    <SeparatorPrimitive.Root
      data-slot="separator-root"
      decorative={decorative}
      orientation={orientation}
      className={cn(
        "bg-border shrink-0 data-[orientation=horizontal]:h-px data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-px",
        className,
      )}
      {...props}
    />
  );
}

export { Separator };
</file>

<file path="Figma_Front/src/components/ui/sheet.tsx">
"use client";

import * as React from "react";
import * as SheetPrimitive from "@radix-ui/react-dialog@1.1.6";
import { XIcon } from "lucide-react@0.487.0";

import { cn } from "./utils";

function Sheet({ ...props }: React.ComponentProps<typeof SheetPrimitive.Root>) {
  return <SheetPrimitive.Root data-slot="sheet" {...props} />;
}

function SheetTrigger({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Trigger>) {
  return <SheetPrimitive.Trigger data-slot="sheet-trigger" {...props} />;
}

function SheetClose({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Close>) {
  return <SheetPrimitive.Close data-slot="sheet-close" {...props} />;
}

function SheetPortal({
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Portal>) {
  return <SheetPrimitive.Portal data-slot="sheet-portal" {...props} />;
}

function SheetOverlay({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Overlay>) {
  return (
    <SheetPrimitive.Overlay
      data-slot="sheet-overlay"
      className={cn(
        "data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 fixed inset-0 z-50 bg-black/50",
        className,
      )}
      {...props}
    />
  );
}

function SheetContent({
  className,
  children,
  side = "right",
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Content> & {
  side?: "top" | "right" | "bottom" | "left";
}) {
  return (
    <SheetPortal>
      <SheetOverlay />
      <SheetPrimitive.Content
        data-slot="sheet-content"
        className={cn(
          "bg-background data-[state=open]:animate-in data-[state=closed]:animate-out fixed z-50 flex flex-col gap-4 shadow-lg transition ease-in-out data-[state=closed]:duration-300 data-[state=open]:duration-500",
          side === "right" &&
            "data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right inset-y-0 right-0 h-full w-3/4 border-l sm:max-w-sm",
          side === "left" &&
            "data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left inset-y-0 left-0 h-full w-3/4 border-r sm:max-w-sm",
          side === "top" &&
            "data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top inset-x-0 top-0 h-auto border-b",
          side === "bottom" &&
            "data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom inset-x-0 bottom-0 h-auto border-t",
          className,
        )}
        {...props}
      >
        {children}
        <SheetPrimitive.Close className="ring-offset-background focus:ring-ring data-[state=open]:bg-secondary absolute top-4 right-4 rounded-xs opacity-70 transition-opacity hover:opacity-100 focus:ring-2 focus:ring-offset-2 focus:outline-hidden disabled:pointer-events-none">
          <XIcon className="size-4" />
          <span className="sr-only">Close</span>
        </SheetPrimitive.Close>
      </SheetPrimitive.Content>
    </SheetPortal>
  );
}

function SheetHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-header"
      className={cn("flex flex-col gap-1.5 p-4", className)}
      {...props}
    />
  );
}

function SheetFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sheet-footer"
      className={cn("mt-auto flex flex-col gap-2 p-4", className)}
      {...props}
    />
  );
}

function SheetTitle({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Title>) {
  return (
    <SheetPrimitive.Title
      data-slot="sheet-title"
      className={cn("text-foreground font-semibold", className)}
      {...props}
    />
  );
}

function SheetDescription({
  className,
  ...props
}: React.ComponentProps<typeof SheetPrimitive.Description>) {
  return (
    <SheetPrimitive.Description
      data-slot="sheet-description"
      className={cn("text-muted-foreground text-sm", className)}
      {...props}
    />
  );
}

export {
  Sheet,
  SheetTrigger,
  SheetClose,
  SheetContent,
  SheetHeader,
  SheetFooter,
  SheetTitle,
  SheetDescription,
};
</file>

<file path="Figma_Front/src/components/ui/sidebar.tsx">
"use client";

import * as React from "react";
import { Slot } from "@radix-ui/react-slot@1.1.2";
import { VariantProps, cva } from "class-variance-authority@0.7.1";
import { PanelLeftIcon } from "lucide-react@0.487.0";

import { useIsMobile } from "./use-mobile";
import { cn } from "./utils";
import { Button } from "./button";
import { Input } from "./input";
import { Separator } from "./separator";
import {
  Sheet,
  SheetContent,
  SheetDescription,
  SheetHeader,
  SheetTitle,
} from "./sheet";
import { Skeleton } from "./skeleton";
import {
  Tooltip,
  TooltipContent,
  TooltipProvider,
  TooltipTrigger,
} from "./tooltip";

const SIDEBAR_COOKIE_NAME = "sidebar_state";
const SIDEBAR_COOKIE_MAX_AGE = 60 * 60 * 24 * 7;
const SIDEBAR_WIDTH = "16rem";
const SIDEBAR_WIDTH_MOBILE = "18rem";
const SIDEBAR_WIDTH_ICON = "3rem";
const SIDEBAR_KEYBOARD_SHORTCUT = "b";

type SidebarContextProps = {
  state: "expanded" | "collapsed";
  open: boolean;
  setOpen: (open: boolean) => void;
  openMobile: boolean;
  setOpenMobile: (open: boolean) => void;
  isMobile: boolean;
  toggleSidebar: () => void;
};

const SidebarContext = React.createContext<SidebarContextProps | null>(null);

function useSidebar() {
  const context = React.useContext(SidebarContext);
  if (!context) {
    throw new Error("useSidebar must be used within a SidebarProvider.");
  }

  return context;
}

function SidebarProvider({
  defaultOpen = true,
  open: openProp,
  onOpenChange: setOpenProp,
  className,
  style,
  children,
  ...props
}: React.ComponentProps<"div"> & {
  defaultOpen?: boolean;
  open?: boolean;
  onOpenChange?: (open: boolean) => void;
}) {
  const isMobile = useIsMobile();
  const [openMobile, setOpenMobile] = React.useState(false);

  // This is the internal state of the sidebar.
  // We use openProp and setOpenProp for control from outside the component.
  const [_open, _setOpen] = React.useState(defaultOpen);
  const open = openProp ?? _open;
  const setOpen = React.useCallback(
    (value: boolean | ((value: boolean) => boolean)) => {
      const openState = typeof value === "function" ? value(open) : value;
      if (setOpenProp) {
        setOpenProp(openState);
      } else {
        _setOpen(openState);
      }

      // This sets the cookie to keep the sidebar state.
      document.cookie = `${SIDEBAR_COOKIE_NAME}=${openState}; path=/; max-age=${SIDEBAR_COOKIE_MAX_AGE}`;
    },
    [setOpenProp, open],
  );

  // Helper to toggle the sidebar.
  const toggleSidebar = React.useCallback(() => {
    return isMobile ? setOpenMobile((open) => !open) : setOpen((open) => !open);
  }, [isMobile, setOpen, setOpenMobile]);

  // Adds a keyboard shortcut to toggle the sidebar.
  React.useEffect(() => {
    const handleKeyDown = (event: KeyboardEvent) => {
      if (
        event.key === SIDEBAR_KEYBOARD_SHORTCUT &&
        (event.metaKey || event.ctrlKey)
      ) {
        event.preventDefault();
        toggleSidebar();
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [toggleSidebar]);

  // We add a state so that we can do data-state="expanded" or "collapsed".
  // This makes it easier to style the sidebar with Tailwind classes.
  const state = open ? "expanded" : "collapsed";

  const contextValue = React.useMemo<SidebarContextProps>(
    () => ({
      state,
      open,
      setOpen,
      isMobile,
      openMobile,
      setOpenMobile,
      toggleSidebar,
    }),
    [state, open, setOpen, isMobile, openMobile, setOpenMobile, toggleSidebar],
  );

  return (
    <SidebarContext.Provider value={contextValue}>
      <TooltipProvider delayDuration={0}>
        <div
          data-slot="sidebar-wrapper"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH,
              "--sidebar-width-icon": SIDEBAR_WIDTH_ICON,
              ...style,
            } as React.CSSProperties
          }
          className={cn(
            "group/sidebar-wrapper has-data-[variant=inset]:bg-sidebar flex min-h-svh w-full",
            className,
          )}
          {...props}
        >
          {children}
        </div>
      </TooltipProvider>
    </SidebarContext.Provider>
  );
}

function Sidebar({
  side = "left",
  variant = "sidebar",
  collapsible = "offcanvas",
  className,
  children,
  ...props
}: React.ComponentProps<"div"> & {
  side?: "left" | "right";
  variant?: "sidebar" | "floating" | "inset";
  collapsible?: "offcanvas" | "icon" | "none";
}) {
  const { isMobile, state, openMobile, setOpenMobile } = useSidebar();

  if (collapsible === "none") {
    return (
      <div
        data-slot="sidebar"
        className={cn(
          "bg-sidebar text-sidebar-foreground flex h-full w-(--sidebar-width) flex-col",
          className,
        )}
        {...props}
      >
        {children}
      </div>
    );
  }

  if (isMobile) {
    return (
      <Sheet open={openMobile} onOpenChange={setOpenMobile} {...props}>
        <SheetContent
          data-sidebar="sidebar"
          data-slot="sidebar"
          data-mobile="true"
          className="bg-sidebar text-sidebar-foreground w-(--sidebar-width) p-0 [&>button]:hidden"
          style={
            {
              "--sidebar-width": SIDEBAR_WIDTH_MOBILE,
            } as React.CSSProperties
          }
          side={side}
        >
          <SheetHeader className="sr-only">
            <SheetTitle>Sidebar</SheetTitle>
            <SheetDescription>Displays the mobile sidebar.</SheetDescription>
          </SheetHeader>
          <div className="flex h-full w-full flex-col">{children}</div>
        </SheetContent>
      </Sheet>
    );
  }

  return (
    <div
      className="group peer text-sidebar-foreground hidden md:block"
      data-state={state}
      data-collapsible={state === "collapsed" ? collapsible : ""}
      data-variant={variant}
      data-side={side}
      data-slot="sidebar"
    >
      {/* This is what handles the sidebar gap on desktop */}
      <div
        data-slot="sidebar-gap"
        className={cn(
          "relative w-(--sidebar-width) bg-transparent transition-[width] duration-200 ease-linear",
          "group-data-[collapsible=offcanvas]:w-0",
          "group-data-[side=right]:rotate-180",
          variant === "floating" || variant === "inset"
            ? "group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4)))]"
            : "group-data-[collapsible=icon]:w-(--sidebar-width-icon)",
        )}
      />
      <div
        data-slot="sidebar-container"
        className={cn(
          "fixed inset-y-0 z-10 hidden h-svh w-(--sidebar-width) transition-[left,right,width] duration-200 ease-linear md:flex",
          side === "left"
            ? "left-0 group-data-[collapsible=offcanvas]:left-[calc(var(--sidebar-width)*-1)]"
            : "right-0 group-data-[collapsible=offcanvas]:right-[calc(var(--sidebar-width)*-1)]",
          // Adjust the padding for floating and inset variants.
          variant === "floating" || variant === "inset"
            ? "p-2 group-data-[collapsible=icon]:w-[calc(var(--sidebar-width-icon)+(--spacing(4))+2px)]"
            : "group-data-[collapsible=icon]:w-(--sidebar-width-icon) group-data-[side=left]:border-r group-data-[side=right]:border-l",
          className,
        )}
        {...props}
      >
        <div
          data-sidebar="sidebar"
          data-slot="sidebar-inner"
          className="bg-sidebar group-data-[variant=floating]:border-sidebar-border flex h-full w-full flex-col group-data-[variant=floating]:rounded-lg group-data-[variant=floating]:border group-data-[variant=floating]:shadow-sm"
        >
          {children}
        </div>
      </div>
    </div>
  );
}

function SidebarTrigger({
  className,
  onClick,
  ...props
}: React.ComponentProps<typeof Button>) {
  const { toggleSidebar } = useSidebar();

  return (
    <Button
      data-sidebar="trigger"
      data-slot="sidebar-trigger"
      variant="ghost"
      size="icon"
      className={cn("size-7", className)}
      onClick={(event) => {
        onClick?.(event);
        toggleSidebar();
      }}
      {...props}
    >
      <PanelLeftIcon />
      <span className="sr-only">Toggle Sidebar</span>
    </Button>
  );
}

function SidebarRail({ className, ...props }: React.ComponentProps<"button">) {
  const { toggleSidebar } = useSidebar();

  return (
    <button
      data-sidebar="rail"
      data-slot="sidebar-rail"
      aria-label="Toggle Sidebar"
      tabIndex={-1}
      onClick={toggleSidebar}
      title="Toggle Sidebar"
      className={cn(
        "hover:after:bg-sidebar-border absolute inset-y-0 z-20 hidden w-4 -translate-x-1/2 transition-all ease-linear group-data-[side=left]:-right-4 group-data-[side=right]:left-0 after:absolute after:inset-y-0 after:left-1/2 after:w-[2px] sm:flex",
        "in-data-[side=left]:cursor-w-resize in-data-[side=right]:cursor-e-resize",
        "[[data-side=left][data-state=collapsed]_&]:cursor-e-resize [[data-side=right][data-state=collapsed]_&]:cursor-w-resize",
        "hover:group-data-[collapsible=offcanvas]:bg-sidebar group-data-[collapsible=offcanvas]:translate-x-0 group-data-[collapsible=offcanvas]:after:left-full",
        "[[data-side=left][data-collapsible=offcanvas]_&]:-right-2",
        "[[data-side=right][data-collapsible=offcanvas]_&]:-left-2",
        className,
      )}
      {...props}
    />
  );
}

function SidebarInset({ className, ...props }: React.ComponentProps<"main">) {
  return (
    <main
      data-slot="sidebar-inset"
      className={cn(
        "bg-background relative flex w-full flex-1 flex-col",
        "md:peer-data-[variant=inset]:m-2 md:peer-data-[variant=inset]:ml-0 md:peer-data-[variant=inset]:rounded-xl md:peer-data-[variant=inset]:shadow-sm md:peer-data-[variant=inset]:peer-data-[state=collapsed]:ml-2",
        className,
      )}
      {...props}
    />
  );
}

function SidebarInput({
  className,
  ...props
}: React.ComponentProps<typeof Input>) {
  return (
    <Input
      data-slot="sidebar-input"
      data-sidebar="input"
      className={cn("bg-background h-8 w-full shadow-none", className)}
      {...props}
    />
  );
}

function SidebarHeader({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-header"
      data-sidebar="header"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  );
}

function SidebarFooter({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-footer"
      data-sidebar="footer"
      className={cn("flex flex-col gap-2 p-2", className)}
      {...props}
    />
  );
}

function SidebarSeparator({
  className,
  ...props
}: React.ComponentProps<typeof Separator>) {
  return (
    <Separator
      data-slot="sidebar-separator"
      data-sidebar="separator"
      className={cn("bg-sidebar-border mx-2 w-auto", className)}
      {...props}
    />
  );
}

function SidebarContent({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-content"
      data-sidebar="content"
      className={cn(
        "flex min-h-0 flex-1 flex-col gap-2 overflow-auto group-data-[collapsible=icon]:overflow-hidden",
        className,
      )}
      {...props}
    />
  );
}

function SidebarGroup({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-group"
      data-sidebar="group"
      className={cn("relative flex w-full min-w-0 flex-col p-2", className)}
      {...props}
    />
  );
}

function SidebarGroupLabel({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"div"> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "div";

  return (
    <Comp
      data-slot="sidebar-group-label"
      data-sidebar="group-label"
      className={cn(
        "text-sidebar-foreground/70 ring-sidebar-ring flex h-8 shrink-0 items-center rounded-md px-2 text-xs font-medium outline-hidden transition-[margin,opacity] duration-200 ease-linear focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        "group-data-[collapsible=icon]:-mt-8 group-data-[collapsible=icon]:opacity-0",
        className,
      )}
      {...props}
    />
  );
}

function SidebarGroupAction({
  className,
  asChild = false,
  ...props
}: React.ComponentProps<"button"> & { asChild?: boolean }) {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      data-slot="sidebar-group-action"
      data-sidebar="group-action"
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground absolute top-3.5 right-3 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 md:after:hidden",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  );
}

function SidebarGroupContent({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-group-content"
      data-sidebar="group-content"
      className={cn("w-full text-sm", className)}
      {...props}
    />
  );
}

function SidebarMenu({ className, ...props }: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="sidebar-menu"
      data-sidebar="menu"
      className={cn("flex w-full min-w-0 flex-col gap-1", className)}
      {...props}
    />
  );
}

function SidebarMenuItem({ className, ...props }: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="sidebar-menu-item"
      data-sidebar="menu-item"
      className={cn("group/menu-item relative", className)}
      {...props}
    />
  );
}

const sidebarMenuButtonVariants = cva(
  "peer/menu-button flex w-full items-center gap-2 overflow-hidden rounded-md p-2 text-left text-sm outline-hidden ring-sidebar-ring transition-[width,height,padding] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground focus-visible:ring-2 active:bg-sidebar-accent active:text-sidebar-accent-foreground disabled:pointer-events-none disabled:opacity-50 group-has-data-[sidebar=menu-action]/menu-item:pr-8 aria-disabled:pointer-events-none aria-disabled:opacity-50 data-[active=true]:bg-sidebar-accent data-[active=true]:font-medium data-[active=true]:text-sidebar-accent-foreground data-[state=open]:hover:bg-sidebar-accent data-[state=open]:hover:text-sidebar-accent-foreground group-data-[collapsible=icon]:size-8! group-data-[collapsible=icon]:p-2! [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
  {
    variants: {
      variant: {
        default: "hover:bg-sidebar-accent hover:text-sidebar-accent-foreground",
        outline:
          "bg-background shadow-[0_0_0_1px_hsl(var(--sidebar-border))] hover:bg-sidebar-accent hover:text-sidebar-accent-foreground hover:shadow-[0_0_0_1px_hsl(var(--sidebar-accent))]",
      },
      size: {
        default: "h-8 text-sm",
        sm: "h-7 text-xs",
        lg: "h-12 text-sm group-data-[collapsible=icon]:p-0!",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

function SidebarMenuButton({
  asChild = false,
  isActive = false,
  variant = "default",
  size = "default",
  tooltip,
  className,
  ...props
}: React.ComponentProps<"button"> & {
  asChild?: boolean;
  isActive?: boolean;
  tooltip?: string | React.ComponentProps<typeof TooltipContent>;
} & VariantProps<typeof sidebarMenuButtonVariants>) {
  const Comp = asChild ? Slot : "button";
  const { isMobile, state } = useSidebar();

  const button = (
    <Comp
      data-slot="sidebar-menu-button"
      data-sidebar="menu-button"
      data-size={size}
      data-active={isActive}
      className={cn(sidebarMenuButtonVariants({ variant, size }), className)}
      {...props}
    />
  );

  if (!tooltip) {
    return button;
  }

  if (typeof tooltip === "string") {
    tooltip = {
      children: tooltip,
    };
  }

  return (
    <Tooltip>
      <TooltipTrigger asChild>{button}</TooltipTrigger>
      <TooltipContent
        side="right"
        align="center"
        hidden={state !== "collapsed" || isMobile}
        {...tooltip}
      />
    </Tooltip>
  );
}

function SidebarMenuAction({
  className,
  asChild = false,
  showOnHover = false,
  ...props
}: React.ComponentProps<"button"> & {
  asChild?: boolean;
  showOnHover?: boolean;
}) {
  const Comp = asChild ? Slot : "button";

  return (
    <Comp
      data-slot="sidebar-menu-action"
      data-sidebar="menu-action"
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground peer-hover/menu-button:text-sidebar-accent-foreground absolute top-1.5 right-1 flex aspect-square w-5 items-center justify-center rounded-md p-0 outline-hidden transition-transform focus-visible:ring-2 [&>svg]:size-4 [&>svg]:shrink-0",
        // Increases the hit area of the button on mobile.
        "after:absolute after:-inset-2 md:after:hidden",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        showOnHover &&
          "peer-data-[active=true]/menu-button:text-sidebar-accent-foreground group-focus-within/menu-item:opacity-100 group-hover/menu-item:opacity-100 data-[state=open]:opacity-100 md:opacity-0",
        className,
      )}
      {...props}
    />
  );
}

function SidebarMenuBadge({
  className,
  ...props
}: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="sidebar-menu-badge"
      data-sidebar="menu-badge"
      className={cn(
        "text-sidebar-foreground pointer-events-none absolute right-1 flex h-5 min-w-5 items-center justify-center rounded-md px-1 text-xs font-medium tabular-nums select-none",
        "peer-hover/menu-button:text-sidebar-accent-foreground peer-data-[active=true]/menu-button:text-sidebar-accent-foreground",
        "peer-data-[size=sm]/menu-button:top-1",
        "peer-data-[size=default]/menu-button:top-1.5",
        "peer-data-[size=lg]/menu-button:top-2.5",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  );
}

function SidebarMenuSkeleton({
  className,
  showIcon = false,
  ...props
}: React.ComponentProps<"div"> & {
  showIcon?: boolean;
}) {
  // Random width between 50 to 90%.
  const width = React.useMemo(() => {
    return `${Math.floor(Math.random() * 40) + 50}%`;
  }, []);

  return (
    <div
      data-slot="sidebar-menu-skeleton"
      data-sidebar="menu-skeleton"
      className={cn("flex h-8 items-center gap-2 rounded-md px-2", className)}
      {...props}
    >
      {showIcon && (
        <Skeleton
          className="size-4 rounded-md"
          data-sidebar="menu-skeleton-icon"
        />
      )}
      <Skeleton
        className="h-4 max-w-(--skeleton-width) flex-1"
        data-sidebar="menu-skeleton-text"
        style={
          {
            "--skeleton-width": width,
          } as React.CSSProperties
        }
      />
    </div>
  );
}

function SidebarMenuSub({ className, ...props }: React.ComponentProps<"ul">) {
  return (
    <ul
      data-slot="sidebar-menu-sub"
      data-sidebar="menu-sub"
      className={cn(
        "border-sidebar-border mx-3.5 flex min-w-0 translate-x-px flex-col gap-1 border-l px-2.5 py-0.5",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  );
}

function SidebarMenuSubItem({
  className,
  ...props
}: React.ComponentProps<"li">) {
  return (
    <li
      data-slot="sidebar-menu-sub-item"
      data-sidebar="menu-sub-item"
      className={cn("group/menu-sub-item relative", className)}
      {...props}
    />
  );
}

function SidebarMenuSubButton({
  asChild = false,
  size = "md",
  isActive = false,
  className,
  ...props
}: React.ComponentProps<"a"> & {
  asChild?: boolean;
  size?: "sm" | "md";
  isActive?: boolean;
}) {
  const Comp = asChild ? Slot : "a";

  return (
    <Comp
      data-slot="sidebar-menu-sub-button"
      data-sidebar="menu-sub-button"
      data-size={size}
      data-active={isActive}
      className={cn(
        "text-sidebar-foreground ring-sidebar-ring hover:bg-sidebar-accent hover:text-sidebar-accent-foreground active:bg-sidebar-accent active:text-sidebar-accent-foreground [&>svg]:text-sidebar-accent-foreground flex h-7 min-w-0 -translate-x-px items-center gap-2 overflow-hidden rounded-md px-2 outline-hidden focus-visible:ring-2 disabled:pointer-events-none disabled:opacity-50 aria-disabled:pointer-events-none aria-disabled:opacity-50 [&>span:last-child]:truncate [&>svg]:size-4 [&>svg]:shrink-0",
        "data-[active=true]:bg-sidebar-accent data-[active=true]:text-sidebar-accent-foreground",
        size === "sm" && "text-xs",
        size === "md" && "text-sm",
        "group-data-[collapsible=icon]:hidden",
        className,
      )}
      {...props}
    />
  );
}

export {
  Sidebar,
  SidebarContent,
  SidebarFooter,
  SidebarGroup,
  SidebarGroupAction,
  SidebarGroupContent,
  SidebarGroupLabel,
  SidebarHeader,
  SidebarInput,
  SidebarInset,
  SidebarMenu,
  SidebarMenuAction,
  SidebarMenuBadge,
  SidebarMenuButton,
  SidebarMenuItem,
  SidebarMenuSkeleton,
  SidebarMenuSub,
  SidebarMenuSubButton,
  SidebarMenuSubItem,
  SidebarProvider,
  SidebarRail,
  SidebarSeparator,
  SidebarTrigger,
  useSidebar,
};
</file>

<file path="Figma_Front/src/components/ui/skeleton.tsx">
import { cn } from "./utils";

function Skeleton({ className, ...props }: React.ComponentProps<"div">) {
  return (
    <div
      data-slot="skeleton"
      className={cn("bg-accent animate-pulse rounded-md", className)}
      {...props}
    />
  );
}

export { Skeleton };
</file>

<file path="Figma_Front/src/components/ui/slider.tsx">
"use client";

import * as React from "react";
import * as SliderPrimitive from "@radix-ui/react-slider@1.2.3";

import { cn } from "./utils";

function Slider({
  className,
  defaultValue,
  value,
  min = 0,
  max = 100,
  ...props
}: React.ComponentProps<typeof SliderPrimitive.Root>) {
  const _values = React.useMemo(
    () =>
      Array.isArray(value)
        ? value
        : Array.isArray(defaultValue)
          ? defaultValue
          : [min, max],
    [value, defaultValue, min, max],
  );

  return (
    <SliderPrimitive.Root
      data-slot="slider"
      defaultValue={defaultValue}
      value={value}
      min={min}
      max={max}
      className={cn(
        "relative flex w-full touch-none items-center select-none data-[disabled]:opacity-50 data-[orientation=vertical]:h-full data-[orientation=vertical]:min-h-44 data-[orientation=vertical]:w-auto data-[orientation=vertical]:flex-col",
        className,
      )}
      {...props}
    >
      <SliderPrimitive.Track
        data-slot="slider-track"
        className={cn(
          "bg-muted relative grow overflow-hidden rounded-full data-[orientation=horizontal]:h-4 data-[orientation=horizontal]:w-full data-[orientation=vertical]:h-full data-[orientation=vertical]:w-1.5",
        )}
      >
        <SliderPrimitive.Range
          data-slot="slider-range"
          className={cn(
            "bg-primary absolute data-[orientation=horizontal]:h-full data-[orientation=vertical]:w-full",
          )}
        />
      </SliderPrimitive.Track>
      {Array.from({ length: _values.length }, (_, index) => (
        <SliderPrimitive.Thumb
          data-slot="slider-thumb"
          key={index}
          className="border-primary bg-background ring-ring/50 block size-4 shrink-0 rounded-full border shadow-sm transition-[color,box-shadow] hover:ring-4 focus-visible:ring-4 focus-visible:outline-hidden disabled:pointer-events-none disabled:opacity-50"
        />
      ))}
    </SliderPrimitive.Root>
  );
}

export { Slider };
</file>

<file path="Figma_Front/src/components/ui/sonner.tsx">
"use client";

import { useTheme } from "next-themes@0.4.6";
import { Toaster as Sonner, ToasterProps } from "sonner@2.0.3";

const Toaster = ({ ...props }: ToasterProps) => {
  const { theme = "system" } = useTheme();

  return (
    <Sonner
      theme={theme as ToasterProps["theme"]}
      className="toaster group"
      style={
        {
          "--normal-bg": "var(--popover)",
          "--normal-text": "var(--popover-foreground)",
          "--normal-border": "var(--border)",
        } as React.CSSProperties
      }
      {...props}
    />
  );
};

export { Toaster };
</file>

<file path="Figma_Front/src/components/ui/switch.tsx">
"use client";

import * as React from "react";
import * as SwitchPrimitive from "@radix-ui/react-switch@1.1.3";

import { cn } from "./utils";

function Switch({
  className,
  ...props
}: React.ComponentProps<typeof SwitchPrimitive.Root>) {
  return (
    <SwitchPrimitive.Root
      data-slot="switch"
      className={cn(
        "peer data-[state=checked]:bg-primary data-[state=unchecked]:bg-switch-background focus-visible:border-ring focus-visible:ring-ring/50 dark:data-[state=unchecked]:bg-input/80 inline-flex h-[1.15rem] w-8 shrink-0 items-center rounded-full border border-transparent transition-all outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50",
        className,
      )}
      {...props}
    >
      <SwitchPrimitive.Thumb
        data-slot="switch-thumb"
        className={cn(
          "bg-card dark:data-[state=unchecked]:bg-card-foreground dark:data-[state=checked]:bg-primary-foreground pointer-events-none block size-4 rounded-full ring-0 transition-transform data-[state=checked]:translate-x-[calc(100%-2px)] data-[state=unchecked]:translate-x-0",
        )}
      />
    </SwitchPrimitive.Root>
  );
}

export { Switch };
</file>

<file path="Figma_Front/src/components/ui/table.tsx">
"use client";

import * as React from "react";

import { cn } from "./utils";

function Table({ className, ...props }: React.ComponentProps<"table">) {
  return (
    <div
      data-slot="table-container"
      className="relative w-full overflow-x-auto"
    >
      <table
        data-slot="table"
        className={cn("w-full caption-bottom text-sm", className)}
        {...props}
      />
    </div>
  );
}

function TableHeader({ className, ...props }: React.ComponentProps<"thead">) {
  return (
    <thead
      data-slot="table-header"
      className={cn("[&_tr]:border-b", className)}
      {...props}
    />
  );
}

function TableBody({ className, ...props }: React.ComponentProps<"tbody">) {
  return (
    <tbody
      data-slot="table-body"
      className={cn("[&_tr:last-child]:border-0", className)}
      {...props}
    />
  );
}

function TableFooter({ className, ...props }: React.ComponentProps<"tfoot">) {
  return (
    <tfoot
      data-slot="table-footer"
      className={cn(
        "bg-muted/50 border-t font-medium [&>tr]:last:border-b-0",
        className,
      )}
      {...props}
    />
  );
}

function TableRow({ className, ...props }: React.ComponentProps<"tr">) {
  return (
    <tr
      data-slot="table-row"
      className={cn(
        "hover:bg-muted/50 data-[state=selected]:bg-muted border-b transition-colors",
        className,
      )}
      {...props}
    />
  );
}

function TableHead({ className, ...props }: React.ComponentProps<"th">) {
  return (
    <th
      data-slot="table-head"
      className={cn(
        "text-foreground h-10 px-2 text-left align-middle font-medium whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className,
      )}
      {...props}
    />
  );
}

function TableCell({ className, ...props }: React.ComponentProps<"td">) {
  return (
    <td
      data-slot="table-cell"
      className={cn(
        "p-2 align-middle whitespace-nowrap [&:has([role=checkbox])]:pr-0 [&>[role=checkbox]]:translate-y-[2px]",
        className,
      )}
      {...props}
    />
  );
}

function TableCaption({
  className,
  ...props
}: React.ComponentProps<"caption">) {
  return (
    <caption
      data-slot="table-caption"
      className={cn("text-muted-foreground mt-4 text-sm", className)}
      {...props}
    />
  );
}

export {
  Table,
  TableHeader,
  TableBody,
  TableFooter,
  TableHead,
  TableRow,
  TableCell,
  TableCaption,
};
</file>

<file path="Figma_Front/src/components/ui/tabs.tsx">
"use client";

import * as React from "react";
import * as TabsPrimitive from "@radix-ui/react-tabs@1.1.3";

import { cn } from "./utils";

function Tabs({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Root>) {
  return (
    <TabsPrimitive.Root
      data-slot="tabs"
      className={cn("flex flex-col gap-2", className)}
      {...props}
    />
  );
}

function TabsList({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.List>) {
  return (
    <TabsPrimitive.List
      data-slot="tabs-list"
      className={cn(
        "bg-muted text-muted-foreground inline-flex h-9 w-fit items-center justify-center rounded-xl p-[3px] flex",
        className,
      )}
      {...props}
    />
  );
}

function TabsTrigger({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Trigger>) {
  return (
    <TabsPrimitive.Trigger
      data-slot="tabs-trigger"
      className={cn(
        "data-[state=active]:bg-card dark:data-[state=active]:text-foreground focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:outline-ring dark:data-[state=active]:border-input dark:data-[state=active]:bg-input/30 text-foreground dark:text-muted-foreground inline-flex h-[calc(100%-1px)] flex-1 items-center justify-center gap-1.5 rounded-xl border border-transparent px-2 py-1 text-sm font-medium whitespace-nowrap transition-[color,box-shadow] focus-visible:ring-[3px] focus-visible:outline-1 disabled:pointer-events-none disabled:opacity-50 [&_svg]:pointer-events-none [&_svg]:shrink-0 [&_svg:not([class*='size-'])]:size-4",
        className,
      )}
      {...props}
    />
  );
}

function TabsContent({
  className,
  ...props
}: React.ComponentProps<typeof TabsPrimitive.Content>) {
  return (
    <TabsPrimitive.Content
      data-slot="tabs-content"
      className={cn("flex-1 outline-none", className)}
      {...props}
    />
  );
}

export { Tabs, TabsList, TabsTrigger, TabsContent };
</file>

<file path="Figma_Front/src/components/ui/textarea.tsx">
import * as React from "react";

import { cn } from "./utils";

function Textarea({ className, ...props }: React.ComponentProps<"textarea">) {
  return (
    <textarea
      data-slot="textarea"
      className={cn(
        "resize-none border-input placeholder:text-muted-foreground focus-visible:border-ring focus-visible:ring-ring/50 aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive dark:bg-input/30 flex field-sizing-content min-h-16 w-full rounded-md border bg-input-background px-3 py-2 text-base transition-[color,box-shadow] outline-none focus-visible:ring-[3px] disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
        className,
      )}
      {...props}
    />
  );
}

export { Textarea };
</file>

<file path="Figma_Front/src/components/ui/toggle-group.tsx">
"use client";

import * as React from "react";
import * as ToggleGroupPrimitive from "@radix-ui/react-toggle-group@1.1.2";
import { type VariantProps } from "class-variance-authority@0.7.1";

import { cn } from "./utils";
import { toggleVariants } from "./toggle";

const ToggleGroupContext = React.createContext<
  VariantProps<typeof toggleVariants>
>({
  size: "default",
  variant: "default",
});

function ToggleGroup({
  className,
  variant,
  size,
  children,
  ...props
}: React.ComponentProps<typeof ToggleGroupPrimitive.Root> &
  VariantProps<typeof toggleVariants>) {
  return (
    <ToggleGroupPrimitive.Root
      data-slot="toggle-group"
      data-variant={variant}
      data-size={size}
      className={cn(
        "group/toggle-group flex w-fit items-center rounded-md data-[variant=outline]:shadow-xs",
        className,
      )}
      {...props}
    >
      <ToggleGroupContext.Provider value={{ variant, size }}>
        {children}
      </ToggleGroupContext.Provider>
    </ToggleGroupPrimitive.Root>
  );
}

function ToggleGroupItem({
  className,
  children,
  variant,
  size,
  ...props
}: React.ComponentProps<typeof ToggleGroupPrimitive.Item> &
  VariantProps<typeof toggleVariants>) {
  const context = React.useContext(ToggleGroupContext);

  return (
    <ToggleGroupPrimitive.Item
      data-slot="toggle-group-item"
      data-variant={context.variant || variant}
      data-size={context.size || size}
      className={cn(
        toggleVariants({
          variant: context.variant || variant,
          size: context.size || size,
        }),
        "min-w-0 flex-1 shrink-0 rounded-none shadow-none first:rounded-l-md last:rounded-r-md focus:z-10 focus-visible:z-10 data-[variant=outline]:border-l-0 data-[variant=outline]:first:border-l",
        className,
      )}
      {...props}
    >
      {children}
    </ToggleGroupPrimitive.Item>
  );
}

export { ToggleGroup, ToggleGroupItem };
</file>

<file path="Figma_Front/src/components/ui/toggle.tsx">
"use client";

import * as React from "react";
import * as TogglePrimitive from "@radix-ui/react-toggle@1.1.2";
import { cva, type VariantProps } from "class-variance-authority@0.7.1";

import { cn } from "./utils";

const toggleVariants = cva(
  "inline-flex items-center justify-center gap-2 rounded-md text-sm font-medium hover:bg-muted hover:text-muted-foreground disabled:pointer-events-none disabled:opacity-50 data-[state=on]:bg-accent data-[state=on]:text-accent-foreground [&_svg]:pointer-events-none [&_svg:not([class*='size-'])]:size-4 [&_svg]:shrink-0 focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] outline-none transition-[color,box-shadow] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive whitespace-nowrap",
  {
    variants: {
      variant: {
        default: "bg-transparent",
        outline:
          "border border-input bg-transparent hover:bg-accent hover:text-accent-foreground",
      },
      size: {
        default: "h-9 px-2 min-w-9",
        sm: "h-8 px-1.5 min-w-8",
        lg: "h-10 px-2.5 min-w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  },
);

function Toggle({
  className,
  variant,
  size,
  ...props
}: React.ComponentProps<typeof TogglePrimitive.Root> &
  VariantProps<typeof toggleVariants>) {
  return (
    <TogglePrimitive.Root
      data-slot="toggle"
      className={cn(toggleVariants({ variant, size, className }))}
      {...props}
    />
  );
}

export { Toggle, toggleVariants };
</file>

<file path="Figma_Front/src/components/ui/tooltip.tsx">
"use client";

import * as React from "react";
import * as TooltipPrimitive from "@radix-ui/react-tooltip@1.1.8";

import { cn } from "./utils";

function TooltipProvider({
  delayDuration = 0,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Provider>) {
  return (
    <TooltipPrimitive.Provider
      data-slot="tooltip-provider"
      delayDuration={delayDuration}
      {...props}
    />
  );
}

function Tooltip({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Root>) {
  return (
    <TooltipProvider>
      <TooltipPrimitive.Root data-slot="tooltip" {...props} />
    </TooltipProvider>
  );
}

function TooltipTrigger({
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Trigger>) {
  return <TooltipPrimitive.Trigger data-slot="tooltip-trigger" {...props} />;
}

function TooltipContent({
  className,
  sideOffset = 0,
  children,
  ...props
}: React.ComponentProps<typeof TooltipPrimitive.Content>) {
  return (
    <TooltipPrimitive.Portal>
      <TooltipPrimitive.Content
        data-slot="tooltip-content"
        sideOffset={sideOffset}
        className={cn(
          "bg-primary text-primary-foreground animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2 z-50 w-fit origin-(--radix-tooltip-content-transform-origin) rounded-md px-3 py-1.5 text-xs text-balance",
          className,
        )}
        {...props}
      >
        {children}
        <TooltipPrimitive.Arrow className="bg-primary fill-primary z-50 size-2.5 translate-y-[calc(-50%_-_2px)] rotate-45 rounded-[2px]" />
      </TooltipPrimitive.Content>
    </TooltipPrimitive.Portal>
  );
}

export { Tooltip, TooltipTrigger, TooltipContent, TooltipProvider };
</file>

<file path="Figma_Front/src/components/ui/use-mobile.ts">
import * as React from "react";

const MOBILE_BREAKPOINT = 768;

export function useIsMobile() {
  const [isMobile, setIsMobile] = React.useState<boolean | undefined>(
    undefined,
  );

  React.useEffect(() => {
    const mql = window.matchMedia(`(max-width: ${MOBILE_BREAKPOINT - 1}px)`);
    const onChange = () => {
      setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
    };
    mql.addEventListener("change", onChange);
    setIsMobile(window.innerWidth < MOBILE_BREAKPOINT);
    return () => mql.removeEventListener("change", onChange);
  }, []);

  return !!isMobile;
}
</file>

<file path="Figma_Front/src/components/ui/utils.ts">
import { clsx, type ClassValue } from "clsx";
import { twMerge } from "tailwind-merge";

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
</file>

<file path="Figma_Front/src/components/widgets/DebitCardsWidget.tsx">
import { CreditCard, ArrowRight } from 'lucide-react';
import { formatCurrency } from '../../utils/formatters';
import type { AppState } from '../../data/mockAppState';

interface DebitCardsWidgetProps {
  balances: AppState['balances'];
  cards: AppState['cards'];
  onTap: () => void;
}

export function DebitCardsWidget({ balances, cards, onTap }: DebitCardsWidgetProps) {
  const debitCards = cards.filter(c => c.type === 'debit');

  return (
    <button
      onClick={onTap}
      className="w-full bg-white rounded-2xl p-5 border border-gray-200 hover:shadow-lg transition-shadow text-left"
      data-api-binding="balances.total_debit, cards[]"
    >
      <div className="flex items-start justify-between mb-4">
        <div>
          <div className="text-sm text-gray-500 mb-1">–ï–¥–∏–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –¥–µ–Ω–µ–≥</div>
          <div className="text-2xl font-semibold text-gray-900">
            {formatCurrency(balances.total_debit)}
          </div>
        </div>
        <ArrowRight className="w-5 h-5 text-gray-400 mt-1" />
      </div>

      <div className="text-xs text-gray-500">
        {debitCards.length} {debitCards.length === 1 ? '–∫–∞—Ä—Ç–∞' : debitCards.length < 5 ? '–∫–∞—Ä—Ç—ã' : '–∫–∞—Ä—Ç'}
      </div>
    </button>
  );
}
</file>

<file path="Figma_Front/src/components/widgets/HealthWidget.tsx">
import { TrendingUp, Info } from 'lucide-react';
import type { AppState } from '../../data/mockAppState';

interface HealthWidgetProps {
  health: AppState['health'];
  onTap: () => void;
}

export function HealthWidget({ health, onTap }: HealthWidgetProps) {
  const getStatusColor = () => {
    if (health.status === '—Å–ø–æ–∫–æ–π–Ω–æ') return 'var(--color-accent-primary)';
    if (health.status === '–≤–Ω–∏–º–∞–Ω–∏–µ') return 'var(--color-warning)';
    return 'var(--color-error)';
  };

  const getStatusBg = () => {
    if (health.status === '—Å–ø–æ–∫–æ–π–Ω–æ') return 'var(--color-accent-light)';
    if (health.status === '–≤–Ω–∏–º–∞–Ω–∏–µ') return 'var(--color-warning-light)';
    return 'var(--color-error-light)';
  };

  return (
    <button
      onClick={onTap}
      className="w-full bg-white rounded-2xl p-4 border border-gray-200 hover:shadow-lg transition-shadow text-left"
      data-api-binding="health.score, health.status, health.next_action"
    >
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-4">
          {/* Circle indicator */}
          <div className="relative">
            <svg className="w-16 h-16 -rotate-90">
              <circle
                cx="32"
                cy="32"
                r="28"
                fill="none"
                stroke="#f3f4f6"
                strokeWidth="4"
              />
              <circle
                cx="32"
                cy="32"
                r="28"
                fill="none"
                stroke={getStatusColor()}
                strokeWidth="4"
                strokeDasharray={`${(health.score / 100) * 175.93} 175.93`}
                className="transition-all duration-1000"
                style={{
                  animation: 'breathe 3s ease-in-out infinite',
                }}
              />
            </svg>
            <div className="absolute inset-0 flex items-center justify-center">
              <span className="font-medium" style={{ color: getStatusColor() }}>
                {health.score}
              </span>
            </div>
          </div>

          <div className="flex-1">
            <div className="text-sm text-gray-500 mb-1">–§–∏–Ω–∑–¥–æ—Ä–æ–≤—å–µ</div>
            <div
              className="inline-flex items-center gap-1.5 px-2 py-1 rounded-full text-xs"
              style={{
                backgroundColor: getStatusBg(),
                color: getStatusColor(),
              }}
            >
              <span>{health.status}</span>
            </div>
          </div>
        </div>

        {health.next_action && (
          <div className="flex items-center gap-1 text-xs" style={{ color: getStatusColor() }}>
            <Info className="w-4 h-4" />
          </div>
        )}
      </div>

      <style>{`
        @keyframes breathe {
          0%, 100% { stroke-opacity: 1; }
          50% { stroke-opacity: 0.6; }
        }
      `}</style>
    </button>
  );
}
</file>

<file path="Figma_Front/src/components/widgets/LoansDepositsWidget.tsx">
import { ArrowRight, TrendingDown, TrendingUp } from 'lucide-react';
import { formatCurrency } from '../../utils/formatters';
import type { AppState } from '../../data/mockAppState';

interface LoansDepositsWidgetProps {
  mode: 'loans' | 'deposits';
  loans: AppState['loans'];
  goals: AppState['goals'];
  onTap: () => void;
  onPayMDP?: () => void;
  onPayADP?: () => void;
  onPaySDP?: () => void;
}

export function LoansDepositsWidget({
  mode,
  loans,
  goals,
  onTap,
  onPayMDP,
  onPayADP,
  onPaySDP,
}: LoansDepositsWidgetProps) {
  if (mode === 'loans') {
    return (
      <div
        className="w-full bg-white rounded-2xl p-5 border border-gray-200 hover:shadow-lg transition-shadow"
        data-api-binding="loans.summary.total_outstanding, loans.summary.mandatory_daily_payment, loans.summary.additional_daily_payment"
      >
        <button onClick={onTap} className="w-full text-left mb-4">
          <div className="flex items-start justify-between mb-3">
            <div>
              <div className="text-sm text-gray-500 mb-1">–û–±—â–∏–π –¥–æ–ª–≥</div>
              <div className="text-2xl font-semibold text-gray-900">
                {formatCurrency(loans.summary.total_outstanding)}
              </div>
            </div>
            <ArrowRight className="w-5 h-5 text-gray-400 mt-1" />
          </div>
        </button>

        <div className="space-y-2">
          <div className="flex items-center justify-between p-3 bg-red-50 rounded-xl">
            <div>
              <div className="text-xs text-gray-600 mb-0.5">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂</div>
              <div className="font-semibold text-gray-900">
                {formatCurrency(1200)}
              </div>
            </div>
            <button
              onClick={(e) => {
                e.stopPropagation();
                onPayMDP?.();
              }}
              className="px-4 py-2 bg-red-600 text-white text-sm rounded-lg hover:bg-red-700 transition-colors"
              data-action="pay_mdp()"
            >
              –û–ø–ª–∞—Ç–∏—Ç—å
            </button>
          </div>

          <div className="flex items-center justify-between p-3 bg-purple-50 rounded-xl">
            <div>
              <div className="text-xs text-gray-600 mb-0.5">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂</div>
              <div className="font-semibold text-gray-900">
                {formatCurrency(540)}
              </div>
            </div>
            <button
              onClick={(e) => {
                e.stopPropagation();
                onPayADP?.();
              }}
              className="px-4 py-2 bg-purple-600 text-white text-sm rounded-lg hover:bg-purple-700 transition-colors"
              data-action="pay_adp()"
            >
              –û–ø–ª–∞—Ç–∏—Ç—å
            </button>
          </div>
        </div>
      </div>
    );
  }

  // Deposits mode
  return (
    <div
      className="w-full bg-white rounded-2xl p-5 border border-gray-200 hover:shadow-lg transition-shadow"
      data-api-binding="goals.summary.total_saved, goals.summary.daily_payment, goals.summary.target"
    >
      <button onClick={onTap} className="w-full text-left mb-4">
        <div className="flex items-start justify-between mb-3">
          <div>
            <div className="text-sm text-gray-500 mb-1">–ù–∞–∫–æ–ø–ª–µ–Ω–æ</div>
            <div className="text-2xl font-semibold text-gray-900">
              {formatCurrency(goals.summary.total_saved)}
            </div>
            <div className="text-xs text-gray-500 mt-1">
              –¶–µ–ª—å: {formatCurrency(goals.summary.target)}
            </div>
          </div>
          <ArrowRight className="w-5 h-5 text-gray-400 mt-1" />
        </div>
      </button>

      <div className="flex items-center justify-between p-3 bg-green-50 rounded-xl">
        <div>
          <div className="text-xs text-gray-600 mb-0.5">–ü–æ–ø–æ–ª–Ω–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è</div>
          <div className="font-semibold text-gray-900">
            {formatCurrency(goals.summary.daily_payment)}
          </div>
        </div>
        <button
          onClick={(e) => {
            e.stopPropagation();
            onPaySDP?.();
          }}
          className="px-4 py-2 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors"
          data-action="pay_sdp()"
        >
          SDP
        </button>
      </div>

      {goals.summary.total_saved > 0 && (
        <div className="mt-3">
          <div className="h-2 bg-gray-100 rounded-full overflow-hidden">
            <div
              className="h-full bg-gradient-to-r from-green-500 to-green-600 transition-all duration-500"
              style={{
                width: `${Math.min(100, (goals.summary.total_saved / goals.summary.target) * 100)}%`,
              }}
            />
          </div>
          <div className="text-xs text-gray-500 mt-2 text-right">
            {Math.round((goals.summary.total_saved / goals.summary.target) * 100)}% –∫ —Ü–µ–ª–∏
          </div>
        </div>
      )}
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/widgets/STSWidget.tsx">
import { ArrowRight, TrendingUp } from 'lucide-react';
import { formatCurrency } from '../../utils/formatters';
import type { AppState } from '../../data/mockAppState';

interface STSWidgetProps {
  sts: AppState['sts'];
  onTap: () => void;
}

export function STSWidget({ sts, onTap }: STSWidgetProps) {
  const remaining = sts.today.amount - sts.today.spent;

  return (
    <button
      onClick={onTap}
      className="w-full bg-gradient-to-br from-purple-50 to-purple-100/50 rounded-2xl p-5 border border-purple-200/50 hover:shadow-lg transition-shadow text-left"
      data-api-binding="sts.today.amount, sts.today.spent, sts.tomorrow.impact"
    >
      <div className="flex items-start justify-between mb-4">
        <div className="text-sm text-purple-700 font-medium">–°–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ</div>
        <ArrowRight className="w-4 h-4 text-purple-400" />
      </div>

      <div className="mb-3">
        <div className="text-3xl font-semibold text-purple-900 mb-1">
          {formatCurrency(1700)}
        </div>
        <div className="text-xs text-purple-600">
          –ü–æ—Ç—Ä–∞—á–µ–Ω–æ {formatCurrency(sts.today.spent)} –∏–∑ {formatCurrency(sts.today.amount)}
        </div>
      </div>

      <div className="flex items-center gap-1.5 text-xs text-purple-700 bg-white/60 rounded-lg px-3 py-2">
        <TrendingUp className="w-3.5 h-3.5" />
        <span>{sts.tomorrow.impact}</span>
      </div>
    </button>
  );
}
</file>

<file path="Figma_Front/src/components/widgets/TimelineWidget.tsx">
import { Calendar, Clock, AlertCircle } from 'lucide-react';
import { formatDate, formatCurrency, getDaysUntil } from '../../utils/formatters';
import type { AppState } from '../../data/mockAppState';

interface TimelineWidgetProps {
  timeline: AppState['timeline'];
  onTap: () => void;
}

export function TimelineWidget({ timeline, onTap }: TimelineWidgetProps) {
  const upcomingEvents = timeline.slice(0, 3);

  const getEventIcon = (type: string) => {
    if (type === 'loan_payment') return <AlertCircle className="w-4 h-4 text-red-500" />;
    if (type === 'deposit_due') return <TrendingUp className="w-4 h-4 text-green-500" />;
    return <Clock className="w-4 h-4 text-blue-500" />;
  };

  return (
    <button
      onClick={onTap}
      className="w-full bg-white rounded-2xl p-5 border border-gray-200 hover:shadow-lg transition-shadow text-left"
      data-api-binding="timeline[]"
    >
      <div className="flex items-center justify-between mb-4">
        <div className="flex items-center gap-2">
          <Calendar className="w-5 h-5 text-gray-400" />
          <span className="font-medium text-gray-900">–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ 30 –¥–Ω–µ–π</span>
        </div>
      </div>

      <div className="space-y-3">
        {upcomingEvents.map((event, idx) => {
          const daysUntil = getDaysUntil(event.date);
          return (
            <div key={idx} className="flex items-start justify-between py-2 border-b border-gray-100 last:border-0">
              <div className="flex items-start gap-3">
                {getEventIcon(event.type)}
                <div>
                  <div className="text-sm font-medium text-gray-900">{event.title}</div>
                  <div className="text-xs text-gray-500 mt-0.5">
                    {formatDate(event.date)} ‚Ä¢ {daysUntil === 0 ? '–°–µ–≥–æ–¥–Ω—è' : `—á–µ—Ä–µ–∑ ${daysUntil} –¥–Ω.`}
                  </div>
                </div>
              </div>
              <div className="text-right">
                <div className="text-sm font-semibold text-gray-900">
                  {formatCurrency(event.amount)}
                </div>
                {event.can_defer > 0 && (
                  <div className="text-xs text-purple-600 mt-0.5">
                    –æ—Ç–ª–æ–∂–∏—Ç—å
                  </div>
                )}
              </div>
            </div>
          );
        })}
      </div>

      {timeline.length > 3 && (
        <div className="mt-3 text-center text-sm text-purple-600 font-medium">
          –ï—â—ë {timeline.length - 3} —Å–æ–±—ã—Ç–∏–π ‚Üí
        </div>
      )}
    </button>
  );
}

function TrendingUp({ className }: { className: string }) {
  return (
    <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
    </svg>
  );
}
</file>

<file path="Figma_Front/src/components/BankCard.tsx">
import { Checkbox } from "./ui/checkbox";

interface BankCardProps {
  id: string;
  name: string;
  logo: string;
  status?: "idle" | "pending" | "connected" | "error";
  selected?: boolean;
  onSelect?: (id: string, selected: boolean) => void;
  showCheckbox?: boolean;
}

export function BankCard({ 
  id, 
  name, 
  logo, 
  status, 
  selected = false, 
  onSelect,
  showCheckbox = true
}: BankCardProps) {
  return (
    <div className="flex items-center gap-4 p-4 md:p-5 bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] rounded-2xl shadow-card hover:shadow-card-hover transition-all duration-200">
      {/* Bank Logo */}
      <div className="w-12 h-12 md:w-14 md:h-14 rounded-xl bg-gradient-to-br from-purple-100 to-purple-50 dark:from-purple-900 dark:to-purple-800 flex items-center justify-center flex-shrink-0">
        <span className="text-xl md:text-2xl">{logo}</span>
      </div>

      {/* Bank Info */}
      <div className="flex-1 min-w-0">
        <h3 className="text-[var(--color-text-primary)]">{name}</h3>
      </div>

      {/* Checkbox */}
      {showCheckbox && (
        <Checkbox
          checked={selected}
          onCheckedChange={(checked) => onSelect?.(id, checked as boolean)}
          className="flex-shrink-0"
        />
      )}
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/BottomNav.tsx">
import { Home, DollarSign, CreditCard, RefreshCw, User } from 'lucide-react';

interface BottomNavProps {
  currentScreen: string;
  onNavigate: (screen: string) => void;
  mode: 'loans' | 'deposits';
}

export function BottomNav({ currentScreen, onNavigate, mode }: BottomNavProps) {
  const navItems = [
    { id: 'home', label: '–ì–ª–∞–≤–Ω–∞—è', icon: Home },
    { id: 'sts', label: 'STS', icon: DollarSign },
    { 
      id: mode === 'loans' ? 'loans' : 'deposits', 
      label: mode === 'loans' ? '–ö—Ä–µ–¥–∏—Ç—ã' : '–¶–µ–ª–∏', 
      icon: CreditCard 
    },
    { id: 'refinance', label: '–û—Ñ—Ñ–µ—Ä—ã', icon: RefreshCw },
    { id: 'profile', label: '–ü—Ä–æ—Ñ–∏–ª—å', icon: User },
  ];

  return (
    <div className="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 z-50">
      <div className="max-w-lg mx-auto">
        <div className="flex items-center justify-around px-2 py-2">
          {navItems.map((item) => {
            const Icon = item.icon;
            const isActive = currentScreen === item.id;
            
            return (
              <button
                key={item.id}
                onClick={() => onNavigate(item.id)}
                className={`flex flex-col items-center gap-1 px-4 py-2 rounded-xl transition-colors ${
                  isActive
                    ? 'text-purple-600 bg-purple-50'
                    : 'text-gray-500 hover:text-gray-900 hover:bg-gray-50'
                }`}
              >
                <Icon className="w-5 h-5" />
                <span className="text-xs font-medium">{item.label}</span>
              </button>
            );
          })}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/ErrorBanner.tsx">
import { AlertCircle } from "lucide-react";
import { Button } from "./ui/button";

interface ErrorBannerProps {
  message: string;
  onRetry?: () => void;
}

export function ErrorBanner({ message, onRetry }: ErrorBannerProps) {
  return (
    <div className="p-4 md:p-5 bg-[var(--color-error-light)] border border-[var(--color-error)] rounded-xl flex items-start gap-3">
      <AlertCircle className="w-5 h-5 text-[var(--color-error)] flex-shrink-0 mt-0.5" />
      <div className="flex-1">
        <p className="text-[var(--color-error)] mb-3">{message}</p>
        {onRetry && (
          <Button
            variant="outline"
            size="sm"
            onClick={onRetry}
            className="border-[var(--color-error)] text-[var(--color-error)] hover:bg-[var(--color-error)] hover:text-white"
          >
            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É
          </Button>
        )}
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/PaymentSheet.tsx">
import { X, TrendingDown, TrendingUp } from 'lucide-react';
import { useState } from 'react';
import { formatCurrency } from '../utils/formatters';

interface PaymentSheetProps {
  type: 'mdp' | 'adp' | 'sdp';
  defaultAmount: number;
  currentSTS: number;
  onClose: () => void;
  onConfirm: (amount: number) => void;
}

export function PaymentSheet({
  type,
  defaultAmount,
  currentSTS,
  onClose,
  onConfirm,
}: PaymentSheetProps) {
  const [amount, setAmount] = useState(defaultAmount);
  const newSTS = type === 'sdp' ? currentSTS - amount : currentSTS + amount * 0.1; // Simplified calculation

  const getTitle = () => {
    if (type === 'mdp') return '–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂';
    if (type === 'adp') return '–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂';
    return '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π';
  };

  const getDescription = () => {
    if (type === 'mdp') return '–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Å—É–º–º–∞ –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è —à—Ç—Ä–∞—Ñ–æ–≤ –∏ –∫–æ–º–∏—Å—Å–∏–π';
    if (type === 'adp') return '–£—Å–∫–æ—Ä–∏—Ç –∑–∞–∫—Ä—ã—Ç–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤ —Å–æ–≥–ª–∞—Å–Ω–æ –≤–∞—à–µ–π —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏';
    return '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–∞—à–µ–≥–æ –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω–æ–≥–æ —Å—á—ë—Ç–∞';
  };

  return (
    <div className="fixed inset-0 bg-black/50 flex items-end justify-center z-50 animate-in fade-in duration-200">
      <div className="bg-white rounded-t-3xl w-full max-w-lg p-6 animate-in slide-in-from-bottom duration-300">
        <div className="flex items-start justify-between mb-6">
          <div>
            <h2 className="text-xl font-semibold text-gray-900 mb-1">{getTitle()}</h2>
            <p className="text-sm text-gray-600">{getDescription()}</p>
          </div>
          <button
            onClick={onClose}
            className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
            aria-label="–ó–∞–∫—Ä—ã—Ç—å"
          >
            <X className="w-5 h-5 text-gray-500" />
          </button>
        </div>

        {/* Amount input */}
        <div className="mb-6">
          <label className="block text-sm text-gray-600 mb-2">–°—É–º–º–∞ –ø–ª–∞—Ç–µ–∂–∞</label>
          <div className="relative">
            <input
              type="number"
              value={amount}
              onChange={(e) => setAmount(Number(e.target.value))}
              className="w-full text-3xl font-semibold text-gray-900 bg-gray-50 rounded-2xl px-6 py-4 outline-none focus:ring-2 focus:ring-purple-500 transition-shadow"
              min={type === 'mdp' ? defaultAmount : 0}
            />
            <div className="absolute right-6 top-1/2 -translate-y-1/2 text-2xl text-gray-400">‚ÇΩ</div>
          </div>
          <div className="text-xs text-gray-500 mt-2">
            –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—É–º–º–∞: {formatCurrency(defaultAmount)}
          </div>
        </div>

        {/* Impact preview */}
        <div className="bg-purple-50 rounded-2xl p-4 mb-6">
          <div className="text-sm text-gray-700 mb-3 font-medium">–í–ª–∏—è–Ω–∏–µ –Ω–∞ —Ñ–∏–Ω–∞–Ω—Å—ã:</div>
          <div className="space-y-2">
            <div className="flex items-center justify-between">
              <span className="text-sm text-gray-600">STS —Å–µ–≥–æ–¥–Ω—è</span>
              <div className="flex items-center gap-2">
                <span className="text-sm text-gray-500">{formatCurrency(currentSTS)}</span>
                {type === 'sdp' ? (
                  <TrendingDown className="w-4 h-4 text-red-500" />
                ) : (
                  <TrendingUp className="w-4 h-4 text-green-500" />
                )}
                <span className="text-sm font-semibold text-gray-900">
                  {formatCurrency(Math.round(newSTS))}
                </span>
              </div>
            </div>
            {type !== 'sdp' && (
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-600">–≠–∫–æ–Ω–æ–º–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤</span>
                <span className="text-sm font-semibold text-green-600">
                  +{formatCurrency(Math.round(amount * 0.002))}
                </span>
              </div>
            )}
          </div>
        </div>

        {/* Actions */}
        <div className="flex gap-3">
          <button
            onClick={onClose}
            className="flex-1 py-3 px-6 bg-gray-100 text-gray-700 rounded-xl font-medium hover:bg-gray-200 transition-colors"
          >
            –û—Ç–º–µ–Ω–∏—Ç—å
          </button>
          <button
            onClick={() => onConfirm(amount)}
            className="flex-1 py-3 px-6 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition-colors"
            data-action={`pay_${type}()`}
          >
            –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/ProductRow.tsx">
import { CreditCard, PiggyBank, Receipt } from "lucide-react";
import { Checkbox } from "./ui/checkbox";

interface ProductRowProps {
  id: string;
  type: "deposit" | "loan" | "debit_card" | "credit_card";
  name: string;
  bankName: string;
  selected?: boolean;
  onSelect?: (id: string, selected: boolean) => void;
  onAgreementClick?: () => void;
}

const productIcons = {
  deposit: PiggyBank,
  loan: Receipt,
  debit_card: CreditCard,
  credit_card: CreditCard,
};

export function ProductRow({
  id,
  type,
  name,
  bankName,
  selected = false,
  onSelect,
  onAgreementClick,
}: ProductRowProps) {
  const Icon = productIcons[type];

  return (
    <div className="flex items-center gap-3 md:gap-4 p-3 md:p-4 bg-[var(--color-bg-secondary)] border border-[var(--color-stroke-divider)] rounded-xl hover:bg-[var(--color-surface-panel)] transition-colors duration-200">
      {/* Icon */}
      <div className="w-10 h-10 rounded-lg bg-[var(--color-brand-primary)] bg-opacity-10 flex items-center justify-center flex-shrink-0">
        <Icon className="w-5 h-5 text-[var(--color-brand-primary)]" />
      </div>

      {/* Product Info */}
      <div className="flex-1 min-w-0">
        <p className="text-[var(--color-text-primary)] mb-0.5">{name}</p>
        <p className="caption text-[var(--color-text-secondary)]">{bankName}</p>
      </div>

      {/* Checkbox */}
      <Checkbox
        checked={selected}
        onCheckedChange={(checked) => onSelect?.(id, checked as boolean)}
        className="flex-shrink-0"
      />
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/StatusChip.tsx">
import { CheckCircle, Clock, AlertCircle, Circle } from "lucide-react";

type ChipStatus = "idle" | "pending" | "connected" | "error";

interface StatusChipProps {
  status: ChipStatus;
  label?: string;
}

const statusConfig = {
  idle: {
    icon: Circle,
    label: "–ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ",
    className: "bg-[var(--color-bg-secondary)] text-[var(--color-text-secondary)]",
  },
  pending: {
    icon: Clock,
    label: "–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...",
    className: "bg-[var(--color-pending-light)] text-[var(--color-pending)]",
  },
  connected: {
    icon: CheckCircle,
    label: "–ü–æ–¥–∫–ª—é—á–µ–Ω–æ",
    className: "bg-[var(--color-success-light)] text-[var(--color-success)]",
  },
  error: {
    icon: AlertCircle,
    label: "–û—à–∏–±–∫–∞",
    className: "bg-[var(--color-error-light)] text-[var(--color-error)]",
  },
};

export function StatusChip({ status, label }: StatusChipProps) {
  const config = statusConfig[status];
  const Icon = config.icon;
  const displayLabel = label || config.label;

  return (
    <div
      className={`
        inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full caption
        ${config.className}
      `}
    >
      <Icon className="w-3 h-3" />
      <span>{displayLabel}</span>
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/Stepper.tsx">
import { Check } from "lucide-react";

interface StepperProps {
  currentStep: number;
  totalSteps: number;
}

export function Stepper({ currentStep, totalSteps }: StepperProps) {
  return (
    <div className="w-full">
      {/* Progress Bar */}
      <div className="relative h-1 bg-[var(--color-stroke-divider)] rounded-full overflow-hidden mb-6">
        <div
          className="absolute top-0 left-0 h-full bg-[var(--color-brand-primary)] transition-all duration-300"
          style={{ width: `${(currentStep / totalSteps) * 100}%` }}
        />
      </div>

      {/* Step Indicators */}
      <div className="flex justify-between items-center">
        {Array.from({ length: totalSteps }).map((_, index) => {
          const stepNumber = index + 1;
          const isCompleted = stepNumber < currentStep;
          const isCurrent = stepNumber === currentStep;

          return (
            <div key={stepNumber} className="flex flex-col items-center gap-2 flex-1">
              <div
                className={`
                  w-8 h-8 md:w-10 md:h-10 rounded-full flex items-center justify-center transition-all duration-300
                  ${
                    isCompleted
                      ? "bg-[var(--color-brand-primary)] text-white"
                      : isCurrent
                      ? "bg-[var(--color-brand-primary)] text-white ring-4 ring-[var(--color-brand-primary-light)] ring-opacity-30"
                      : "bg-[var(--color-bg-secondary)] text-[var(--color-text-tertiary)]"
                  }
                `}
              >
                {isCompleted ? (
                  <Check className="w-4 h-4 md:w-5 md:h-5" />
                ) : (
                  <span className="caption md:text-sm">{stepNumber}</span>
                )}
              </div>
              <span className="caption text-[var(--color-text-secondary)] text-center hidden md:block">
                –®–∞–≥ {stepNumber}
              </span>
            </div>
          );
        })}
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/components/ThemeToggle.tsx">
import { Moon, Sun } from "lucide-react";
import { useEffect, useState } from "react";

export function ThemeToggle() {
  const [theme, setTheme] = useState<"light" | "dark">("light");

  useEffect(() => {
    const savedTheme = localStorage.getItem("theme") as "light" | "dark" | null;
    const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
    const initialTheme = savedTheme || (prefersDark ? "dark" : "light");
    setTheme(initialTheme);
    document.documentElement.setAttribute("data-theme", initialTheme);
  }, []);

  const toggleTheme = () => {
    const newTheme = theme === "light" ? "dark" : "light";
    setTheme(newTheme);
    document.documentElement.setAttribute("data-theme", newTheme);
    localStorage.setItem("theme", newTheme);
  };

  return (
    <button
      onClick={toggleTheme}
      className="fixed top-4 right-4 md:top-6 md:right-6 w-10 h-10 md:w-12 md:h-12 rounded-full bg-[var(--color-surface-panel)] border border-[var(--color-stroke-divider)] flex items-center justify-center shadow-md hover:shadow-lg transition-all duration-200 z-50"
      aria-label="Toggle theme"
    >
      {theme === "light" ? (
        <Moon className="w-5 h-5 text-[var(--color-text-primary)]" />
      ) : (
        <Sun className="w-5 h-5 text-[var(--color-text-primary)]" />
      )}
    </button>
  );
}
</file>

<file path="Figma_Front/src/data/mockAppState.ts">
// Mock data for Credit Guard app
export interface AppState {
  mode: 'loans' | 'deposits';
  user: {
    id: string;
    name: string;
    consents: {
      [bankId: string]: string;
    };
  };
  onboarding: {
    completed: boolean;
    strategy: '–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ' | '—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ' | '–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ';
  };
  health: {
    score: number;
    status: '—Å–ø–æ–∫–æ–π–Ω–æ' | '–≤–Ω–∏–º–∞–Ω–∏–µ' | '–Ω—É–∂–µ–Ω –ø–ª–∞–Ω';
    reasons: string[];
    next_action: {
      type: 'refinance' | 'pay_mdp' | 'pay_sdp' | 'save_more';
      label: string;
    } | null;
  };
  sts: {
    today: {
      amount: number;
      spent: number;
    };
    tomorrow: {
      impact: string;
    };
  };
  loans: {
    summary: {
      total_outstanding: number;
      mandatory_daily_payment: number;
      additional_daily_payment: number;
    };
    items: Array<{
      id: string;
      bank: string;
      type: string;
      balance: number;
      rate: number;
      monthly_payment: number;
      maturity_date: string;
      priority: number;
    }>;
  };
  goals: {
    summary: {
      total_saved: number;
      daily_payment: number;
      target: number;
      target_date: string;
    };
  };
  deposits: {
    current: {
      id: string;
      bank: string;
      product: string;
      rate: number;
      balance: number;
      capitalization: boolean;
      withdrawable: boolean;
      maturity_date: string;
    } | null;
    goal: {
      target_amount: number;
      horizon_months: number;
      liquidity: 'full' | 'partial' | 'locked';
    };
  };
  balances: {
    total: number;
    total_debit: number;
  };
  cards: Array<{
    id: string;
    bank: string;
    mask: string;
    balance: number;
    holds: number;
    type: 'debit' | 'credit';
  }>;
  timeline: Array<{
    date: string;
    type: 'loan_payment' | 'deposit_due' | 'reminder';
    title: string;
    amount: number;
    can_defer: number;
  }>;
  offers: {
    refi: Array<{
      id: string;
      bank: string;
      rate: number;
      term_months: number;
      monthly_payment: number;
      commission: number;
      savings: number;
      breakeven_months: number;
    }>;
    deposits: Array<{
      id: string;
      bank: string;
      product: string;
      rate: number;
      ear: number;
      term_months: number;
      capitalization: string;
      min_amount: number;
      withdrawable: boolean;
    }>;
  };
  applications: {
    [offerId: string]: {
      status: 'pending' | 'approved' | 'docs_required' | 'declined';
      created_at: string;
    };
  };
}

export const mockAppState: AppState = {
  mode: 'loans',
  user: {
    id: 'demo-user',
    name: '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
    consents: {
      sberbank: 'consent-sb-001',
      vtb: 'consent-vtb-001',
      tinkoff: 'consent-tf-001',
    },
  },
  onboarding: {
    completed: true,
    strategy: '—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ',
  },
  health: {
    score: 72,
    status: '—Å–ø–æ–∫–æ–π–Ω–æ',
    reasons: ['STS –≤—ã—à–µ 40%', '–î–æ–ª–≥ —Å–Ω–∏–∑–∏–ª—Å—è –Ω–∞ 5%'],
    next_action: {
      type: 'pay_mdp',
      label: '–û–ø–ª–∞—Ç–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂',
    },
  },
  sts: {
    today: {
      amount: 12500,
      spent: 2300,
    },
    tomorrow: {
      impact: '+1 200 ‚ÇΩ –ø–æ—Å–ª–µ –ø–ª–∞—Ç–µ–∂–∞',
    },
  },
  loans: {
    summary: {
      total_outstanding: 450000,
      mandatory_daily_payment: 850,
      additional_daily_payment: 1200,
    },
    items: [
      {
        id: 'loan1',
        bank: '–°–±–µ—Ä–±–∞–Ω–∫',
        type: '–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å–∫–∏–π',
        balance: 180000,
        rate: 12.5,
        monthly_payment: 8500,
        maturity_date: '2026-05-15',
        priority: 1,
      },
      {
        id: 'loan2',
        bank: '–í–¢–ë',
        type: '–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞',
        balance: 150000,
        rate: 24.9,
        monthly_payment: 6000,
        maturity_date: '2025-12-01',
        priority: 2,
      },
      {
        id: 'loan3',
        bank: '–¢–∏–Ω—å–∫–æ—Ñ—Ñ',
        type: '–†–∞—Å—Å—Ä–æ—á–∫–∞',
        balance: 120000,
        rate: 0,
        monthly_payment: 10000,
        maturity_date: '2025-08-01',
        priority: 3,
      },
    ],
  },
  goals: {
    summary: {
      total_saved: 0,
      daily_payment: 0,
      target: 0,
      target_date: '',
    },
  },
  deposits: {
    current: null,
    goal: {
      target_amount: 0,
      horizon_months: 0,
      liquidity: 'full',
    },
  },
  balances: {
    total: 85000,
    total_debit: 85000,
  },
  cards: [
    {
      id: 'card1',
      bank: '–°–±–µ—Ä–±–∞–Ω–∫',
      mask: '‚Ä¢‚Ä¢ 4356',
      balance: 45000,
      holds: 2500,
      type: 'debit',
    },
    {
      id: 'card2',
      bank: '–¢–∏–Ω—å–∫–æ—Ñ—Ñ',
      mask: '‚Ä¢‚Ä¢ 7821',
      balance: 32000,
      holds: 0,
      type: 'debit',
    },
    {
      id: 'card3',
      bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫',
      mask: '‚Ä¢‚Ä¢ 1234',
      balance: 8000,
      holds: 500,
      type: 'debit',
    },
  ],
  timeline: [
    {
      date: '2025-11-10',
      type: 'loan_payment',
      title: '–ü–ª–∞—Ç—ë–∂ –°–±–µ—Ä–±–∞–Ω–∫',
      amount: 8500,
      can_defer: 2500,
    },
    {
      date: '2025-11-15',
      type: 'loan_payment',
      title: '–ü–ª–∞—Ç—ë–∂ –í–¢–ë',
      amount: 6000,
      can_defer: 0,
    },
    {
      date: '2025-11-20',
      type: 'reminder',
      title: '–ü–æ–ø–æ–ª–Ω–∏—Ç—å STS',
      amount: 5000,
      can_defer: 5000,
    },
    {
      date: '2025-11-25',
      type: 'loan_payment',
      title: '–ü–ª–∞—Ç—ë–∂ –¢–∏–Ω—å–∫–æ—Ñ—Ñ',
      amount: 10000,
      can_defer: 0,
    },
  ],
  offers: {
    refi: [
      {
        id: 'refi1',
        bank: '–†–∞–π—Ñ—Ñ–∞–π–∑–µ–Ω–±–∞–Ω–∫',
        rate: 9.9,
        term_months: 36,
        monthly_payment: 7200,
        commission: 5000,
        savings: 45000,
        breakeven_months: 8,
      },
      {
        id: 'refi2',
        bank: '–ì–∞–∑–ø—Ä–æ–º–±–∞–Ω–∫',
        rate: 11.5,
        term_months: 24,
        monthly_payment: 9500,
        commission: 0,
        savings: 28000,
        breakeven_months: 12,
      },
    ],
    deposits: [
      {
        id: 'dep1',
        bank: '–°–±–µ—Ä–±–∞–Ω–∫',
        product: '–ü–æ–ø–æ–ª–Ω—è–π',
        rate: 18.5,
        ear: 19.2,
        term_months: 12,
        capitalization: '–µ–∂–µ–º–µ—Å—è—á–Ω–æ',
        min_amount: 1000,
        withdrawable: true,
      },
      {
        id: 'dep2',
        bank: '–í–¢–ë',
        product: '–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π',
        rate: 17.0,
        ear: 17.5,
        term_months: 6,
        capitalization: '–µ–∂–µ–¥–Ω–µ–≤–Ω–æ',
        min_amount: 10000,
        withdrawable: false,
      },
    ],
  },
  applications: {},
};

export const mockAppStateDeposits: AppState = {
  mode: 'deposits',
  user: {
    id: 'demo-user',
    name: '–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤',
    consents: {
      sberbank: 'consent-sb-001',
      vtb: 'consent-vtb-001',
    },
  },
  onboarding: {
    completed: true,
    strategy: '—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ',
  },
  health: {
    score: 68,
    status: '–≤–Ω–∏–º–∞–Ω–∏–µ',
    reasons: ['–¶–µ–ª—å –±–ª–∏–∑–∫–∞', '–ù–∏–∑–∫–∏–π —Ç–µ–º–ø –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è'],
    next_action: {
      type: 'save_more',
      label: '–£–≤–µ–ª–∏—á–∏—Ç—å –µ–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ',
    },
  },
  sts: {
    today: {
      amount: 8500,
      spent: 1200,
    },
    tomorrow: {
      impact: '‚àí500 ‚ÇΩ –ø–æ—Å–ª–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏—è',
    },
  },
  loans: {
    summary: {
      total_outstanding: 0,
      mandatory_daily_payment: 0,
      additional_daily_payment: 0,
    },
    items: [],
  },
  goals: {
    summary: {
      total_saved: 320000,
      daily_payment: 1500,
      target: 500000,
      target_date: '2026-06-01',
    },
  },
  deposits: {
    current: {
      id: 'dep_current',
      bank: '–°–±–µ—Ä–±–∞–Ω–∫',
      product: '–ü–æ–ø–æ–ª–Ω—è–π',
      rate: 18.5,
      balance: 320000,
      capitalization: true,
      withdrawable: true,
      maturity_date: '2026-06-01',
    },
    goal: {
      target_amount: 500000,
      horizon_months: 18,
      liquidity: 'partial',
    },
  },
  balances: {
    total: 65000,
    total_debit: 65000,
  },
  cards: [
    {
      id: 'card1',
      bank: '–°–±–µ—Ä–±–∞–Ω–∫',
      mask: '‚Ä¢‚Ä¢ 4356',
      balance: 45000,
      holds: 2500,
      type: 'debit',
    },
    {
      id: 'card2',
      bank: '–¢–∏–Ω—å–∫–æ—Ñ—Ñ',
      mask: '‚Ä¢‚Ä¢ 7821',
      balance: 20000,
      holds: 0,
      type: 'debit',
    },
  ],
  timeline: [
    {
      date: '2025-11-10',
      type: 'deposit_due',
      title: '–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –≤–∫–ª–∞–¥–∞',
      amount: 1500,
      can_defer: 1500,
    },
    {
      date: '2025-11-20',
      type: 'reminder',
      title: '–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤',
      amount: 5200,
      can_defer: 0,
    },
  ],
  offers: {
    refi: [],
    deposits: [
      {
        id: 'dep1',
        bank: '–í–¢–ë',
        product: '–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á—ë—Ç',
        rate: 19.0,
        ear: 20.1,
        term_months: 12,
        capitalization: '–µ–∂–µ–¥–Ω–µ–≤–Ω–æ',
        min_amount: 50000,
        withdrawable: true,
      },
      {
        id: 'dep2',
        bank: '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫',
        product: '–ê–ª—å—Ñ–∞-–í–∫–ª–∞–¥',
        rate: 18.0,
        ear: 18.8,
        term_months: 24,
        capitalization: '–µ–∂–µ–º–µ—Å—è—á–Ω–æ',
        min_amount: 100000,
        withdrawable: false,
      },
    ],
  },
  applications: {},
};
</file>

<file path="Figma_Front/src/guidelines/API_INTEGRATION.md">
# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –±—ç–∫–µ–Ω–¥–æ–º

## –û–±–∑–æ—Ä –∏–∑–º–µ–Ω–µ–Ω–∏–π

–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø–µ—Ä–µ—Å—Ç—Ä–æ–µ–Ω –ø–æ–¥ API-–∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã –±—ç–∫–µ–Ω–¥–∞. –í—Å–µ –≤–∏–∑—É–∞–ª—å–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏ –ø–æ—Ä—è–¥–æ–∫ —à–∞–≥–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã, –¥–æ–±–∞–≤–ª–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è loading/error/success –∏ –ø—Ä–∏–≤—è–∑–∫–∞ –∫ API-–∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º.

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö (onboardingState)

```typescript
interface OnboardingState {
  user_id: string;            // –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π ID (UUID/slug) - –¥–ª—è API
  user_name: string;          // –ò–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  banks: Array<{              // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –±–∞–Ω–∫–æ–≤
    id: string;
    name: string;
    connected: boolean;
  }>;
  selected_bank_ids: string[];  // –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º –±–∞–Ω–∫–∏
  productsByBank: {             // –ü—Ä–æ–¥—É–∫—Ç—ã –ø–æ –±–∞–Ω–∫–∞–º
    [bankId: string]: Array<{
      id: string;
      type: string;
      name: string;
      consented: boolean;
      tos_url: string;
    }>;
  };
  goals: {                      // –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏
    mode: "save" | "close_loans" | "both" | null;
    save_amount: number | null;
    save_speed: "conservative" | "optimal" | "fast" | null;
    close_loan_ids: string[];
    close_speed: "conservative" | "optimal" | "fast" | null;
  };
  consents: {                   // –°–ª—É–∂–µ–±–Ω–æ–µ –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–æ–≤
    pending_consent_id: string | null;
    last_error: string | null;
  };
}
```

## –®–∞–≥–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

### –®–∞–≥ 1: –î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

**–§–∞–π–ª:** `/components/steps/Step1UserInfo.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ `User ID` (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä)
- ‚úÖ –•–∏–Ω—Ç: "–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è API-–∑–∞–ø—Ä–æ—Å–æ–≤"
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è: –∫–Ω–æ–ø–∫–∞ Continue –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ –µ—Å–ª–∏ user_id –∏–ª–∏ user_name –ø—É—Å—Ç—ã–µ

**–î–∞–Ω–Ω—ã–µ:**
- `user_id` ‚Üí onboardingState.user_id
- `user_name` ‚Üí onboardingState.user_name

### –®–∞–≥ 2: –í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤

**–§–∞–π–ª:** `/components/steps/Step2BankSelection.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –±–∞–Ω–∫–æ–≤ (–∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑ onboardingState.banks)
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏—è: loading (—Å–∫–µ–ª–µ—Ç–æ–Ω—ã), error (ErrorBanner), empty ("–ë–∞–Ω–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã")
- ‚úÖ –ß–µ–∫–±–æ–∫—Å—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ selected_bank_ids
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω –≤–∏–∑—É–∞–ª BankCard –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞

**API (–±—É–¥—É—â–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è):**
```
GET /api/banks
Response: { banks: [{ id, name }] }
```

### –®–∞–≥ 3: –°–æ–≥–ª–∞—Å–∏–µ –±–∞–Ω–∫–∞

**–§–∞–π–ª:** `/components/steps/Step3BankConsent.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥—Ä–µ—Å—Å (–ë–∞–Ω–∫ X –∏–∑ Y)
- ‚úÖ –ü—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ "–í—ã–¥–∞—Ç—å –¥–æ—Å—Ç—É–ø" –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç—Å—è POST /api/consent/initiate
- ‚úÖ –°–∏–º—É–ª–∏—Ä—É–µ—Ç—Å—è —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ approval_url –±–∞–Ω–∫–∞
- ‚úÖ –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ CallbackScreen –ø–æ—Å–ª–µ "—Ä–µ–¥–∏—Ä–µ–∫—Ç–∞"

**API (–±—É–¥—É—â–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è):**
```
POST /api/consent/initiate
Body: { user_id, bank_id }
Response: { approval_url, consent_id }
‚Üí Redirect to approval_url
```

### Callback: –í–æ–∑–≤—Ä–∞—Ç –∏–∑ –±–∞–Ω–∫–∞

**–§–∞–π–ª:** `/components/steps/CallbackScreen.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ù–æ–≤—ã–π —ç–∫—Ä–∞–Ω –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –±–∞–Ω–∫–∞
- ‚úÖ –ß–∏—Ç–∞–µ—Ç consent_id –∏–∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ (–≤ –ø—Ä–æ—Ç–æ—Ç–∏–ø–µ - –º–æ–∫–∞–µ—Ç—Å—è)
- ‚úÖ –ú–æ–¥–µ–ª–∏—Ä—É–µ—Ç GET /api/consents/status
- ‚úÖ –ü—Ä–∏ —É—Å–ø–µ—Ö–µ –ø–æ–º–µ—á–∞–µ—Ç –±–∞–Ω–∫ –∫–∞–∫ connected
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏—è: checking (–∑–∞–≥—Ä—É–∑–∫–∞), approved (—É—Å–ø–µ—Ö), error (–æ—à–∏–±–∫–∞)

**API (–±—É–¥—É—â–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è):**
```
GET /api/consents/status?user_id=xxx&consent_id=xxx
Response: { status: "approved" | "rejected", bank_id }
```

### –®–∞–≥ 4: –í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤

**–§–∞–π–ª:** `/components/steps/Step4ProductSelection.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω–æ–≥–æ –±–∞–Ω–∫–∞
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏—è: loading (—Å–∫–µ–ª–µ—Ç–æ–Ω—ã), error (ErrorBanner), success
- ‚úÖ –ü—Ä–æ–¥—É–∫—Ç—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ productsByBank —Å –ø–æ–ª—è–º–∏: id, type, name, consented, tos_url
- ‚úÖ –°—Å—ã–ª–∫–∞ "–ü—Ä–æ—á–∏—Ç–∞—Ç—å —Å–æ–≥–ª–∞—à–µ–Ω–∏–µ" –∏—Å–ø–æ–ª—å–∑—É–µ—Ç tos_url
- ‚úÖ –ß–µ–∫–±–æ–∫—Å –ø—Ä–æ–¥—É–∫—Ç–∞ –¥–≤–∏–≥–∞–µ—Ç consented: true/false

**API (–±—É–¥—É—â–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è):**
```
GET /api/products?bank_id=xxx
Response: { products: [{ id, type, name, consented, tos_url }] }

POST /api/products/consent
Body: { user_id, items: [{ bank_id, product_id, consent: boolean }] }
```

### –®–∞–≥ 5: –í–æ–ø—Ä–æ—Å—ã –æ —Ü–µ–ª—è—Ö

**–§–∞–π–ª:** `/components/steps/Step5Questions.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞—Ç—å –æ–±–µ —Ü–µ–ª–∏ (–Ω–∞–∫–æ–ø–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–µ–¥–∏—Ç—ã)
- ‚úÖ –ü—Ä–∏–≤—è–∑–∫–∞ –∫ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ goals API
- ‚úÖ mode: "save" | "close_loans" | "both"
- ‚úÖ –ü–æ–ª—è –¥–ª—è –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π: save_amount, save_speed
- ‚úÖ –ü–æ–ª—è –¥–ª—è –∫—Ä–µ–¥–∏—Ç–æ–≤: close_loan_ids, close_speed
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–æ–º–ø–ª–µ–∫—Å–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω—ã –æ–±–µ —Ü–µ–ª–∏

**API (–±—É–¥—É—â–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è):**
```
POST /api/goals
Body: {
  user_id,
  mode: "save" | "close_loans" | "both",
  save: { amount, speed } | null,
  close: { loan_ids, speed } | null
}
```

### –§–∏–Ω–∞–ª: –û–±–∑–æ—Ä –∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ

**–§–∞–π–ª:** `/components/steps/FinalSummary.tsx`

**–ò–∑–º–µ–Ω–µ–Ω–∏—è:**
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—é–º–µ –∏–∑ onboardingState
- ‚úÖ –ü–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ –±–∞–Ω–∫–∏ (—Å connected: true)
- ‚úÖ –í—ã–±—Ä–∞–Ω–Ω—ã–µ –ø—Ä–æ–¥—É–∫—Ç—ã (—Å consented: true)
- ‚úÖ –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ü–µ–ª–∏ (goals)
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "–ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥" –º–æ–¥–µ–ª–∏—Ä—É–µ—Ç POST /api/onboarding/commit
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏—è: submitting (–∑–∞–≥—Ä—É–∑–∫–∞), error (ErrorBanner)

**API (–±—É–¥—É—â–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è):**
```
POST /api/onboarding/commit
Body: {
  user_id,
  banks: [{ id, connected }],
  products: [{ bank_id, product_id, consent }],
  goals: { mode, save, close }
}
```

## –°–æ—Å—Ç–æ—è–Ω–∏—è UI

### Loading States
- **Banks**: Skeleton –∑–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –±–∞–Ω–∫–æ–≤ (3 —Å–∫–µ–ª–µ—Ç–æ–Ω–∞)
- **Products**: Skeleton –∑–∞–≥—Ä—É–∑–∫–∞ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–Ω–∫–∞
- **Callback**: –°–ø–∏–Ω–Ω–µ—Ä "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è..."
- **Submit**: –ö–Ω–æ–ø–∫–∞ —Å —Ç–µ–∫—Å—Ç–æ–º "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ..."

### Error States
- **ErrorBanner** —Å –∫–Ω–æ–ø–∫–æ–π "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É"
- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –Ω–∞ –≤—Å–µ—Ö —à–∞–≥–∞—Ö –≥–¥–µ –≤–æ–∑–º–æ–∂–Ω—ã –æ—à–∏–±–∫–∏
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫

### Empty States
- **Banks Empty**: "–ë–∞–Ω–∫–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±—ç–∫–µ–Ω–¥—É"
- –° –∫–Ω–æ–ø–∫–æ–π "–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –ø–æ–ø—ã—Ç–∫—É"

## –ö–æ–¥—ã –æ—à–∏–±–æ–∫

–î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –≤ —Ä–µ–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

- **401/403**: "–ê–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ"
- **404**: "–î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
- **409**: "–ö–æ–Ω—Ñ–ª–∏–∫—Ç –æ–ø–µ—Ä–∞—Ü–∏–∏, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ"
- **424**: "–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ–≥–ª–∞—Å–∏–π, –ø–æ–¥–∫–ª—é—á–∏—Ç–µ –±–∞–Ω–∫"
- **429**: "–°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤, –ø–æ–¥–æ–∂–¥–∏—Ç–µ"
- **5xx**: "–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞, –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ"

## –°–∫–≤–æ–∑–Ω–æ–π —Å—Ü–µ–Ω–∞—Ä–∏–π

1. **Step 1** (User Info) ‚Üí –≤–≤–æ–¥ user_id –∏ user_name ‚Üí Next
2. **Step 2** (Banks) ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –±–∞–Ω–∫–æ–≤ ‚Üí –≤—ã–±–æ—Ä ‚Üí Next
3. **Step 3** (Consent 1) ‚Üí —Å–æ–≥–ª–∞—Å–∏–µ ‚Üí "Redirecting..." ‚Üí **Callback** ‚Üí –±–∞–Ω–∫ –ø–æ–º–µ—á–µ–Ω connected
4. **Step 3** (Consent 2) ‚Üí —Å–æ–≥–ª–∞—Å–∏–µ ‚Üí "Redirecting..." ‚Üí **Callback** ‚Üí –±–∞–Ω–∫ –ø–æ–º–µ—á–µ–Ω connected
5. **Step 4** (Products) ‚Üí –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤ ‚Üí –≤—ã–±–æ—Ä ‚Üí —Å–æ–≥–ª–∞—Å–∏–µ ‚Üí Next
6. **Step 5** (Goals) ‚Üí –≤—ã–±–æ—Ä —Ü–µ–ª–µ–π ‚Üí –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö ‚Üí —Ä–∞—Å—á—ë—Ç ‚Üí Next
7. **Summary** ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ ‚Üí "–ó–∞–≤–µ—Ä—à–∏—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥" ‚Üí POST /api/onboarding/commit ‚Üí Success

## –ü—Ä–∏–º–µ—Ä—ã –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

### –ó–∞–≥—Ä—É–∑–∫–∞ –±–∞–Ω–∫–æ–≤ (Step2)

```typescript
const fetchBanks = async () => {
  setLoadingState("loading");
  
  try {
    const response = await fetch('/api/banks');
    const data = await response.json();
    
    setOnboardingState((prev) => ({
      ...prev,
      banks: data.banks.map(b => ({ ...b, connected: false })),
    }));
    
    setLoadingState("success");
  } catch (error) {
    setLoadingState("error");
  }
};
```

### –ò–Ω–∏—Ü–∏–∞—Ü–∏—è —Å–æ–≥–ª–∞—Å–∏—è (Step3)

```typescript
const handleBankConsent = async (bankId: string) => {
  try {
    const response = await fetch('/api/consent/initiate', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ 
        user_id: onboardingState.user_id, 
        bank_id: bankId 
      })
    });
    
    const { approval_url, consent_id } = await response.json();
    
    // Store consent_id
    setOnboardingState(prev => ({
      ...prev,
      consents: { ...prev.consents, pending_consent_id: consent_id }
    }));
    
    // Redirect to bank
    window.location.href = approval_url;
  } catch (error) {
    // Handle error
  }
};
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ (Callback)

```typescript
const checkConsentStatus = async () => {
  const params = new URLSearchParams(window.location.search);
  const consent_id = params.get('consent_id');
  
  try {
    const response = await fetch(
      `/api/consents/status?user_id=${userId}&consent_id=${consent_id}`
    );
    const data = await response.json();
    
    if (data.status === 'approved') {
      // Mark bank as connected
      setOnboardingState(prev => ({
        ...prev,
        banks: prev.banks.map(b =>
          b.id === data.bank_id ? { ...b, connected: true } : b
        ),
      }));
    }
  } catch (error) {
    // Handle error
  }
};
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- `/components/steps/CallbackScreen.tsx` - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ –∏–∑ –±–∞–Ω–∫–∞

### –û–±–Ω–æ–≤–ª—ë–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- `/App.tsx` - –Ω–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ onboardingState
- `/components/steps/Step1UserInfo.tsx` - –¥–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª–µ user_id
- `/components/steps/Step2BankSelection.tsx` - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –±–∞–Ω–∫–æ–≤
- `/components/steps/Step3BankConsent.tsx` - –ø—Ä–æ–≥—Ä–µ—Å—Å –∏ —Å–∏–º—É–ª—è—Ü–∏—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
- `/components/steps/Step4ProductSelection.tsx` - –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–æ–≤
- `/components/steps/Step5Questions.tsx` - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ goals –¥–ª—è API
- `/components/steps/FinalSummary.tsx` - –æ–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–¥ onboardingState

### –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã
- `/components/ErrorBanner.tsx` - –±–∞–Ω–Ω–µ—Ä –æ—à–∏–±–∫–∏ —Å —Ä–µ—Ç—Ä–∞–µ–º
- `/components/StatusChip.tsx` - —á–∏–ø —Å—Ç–∞—Ç—É—Å–∞ –±–∞–Ω–∫–∞
- `/components/ui/skeleton.tsx` - —Å–∫–µ–ª–µ—Ç–æ–Ω—ã –∑–∞–≥—Ä—É–∑–∫–∏
- `/components/BankCard.tsx` - –∫–∞—Ä—Ç–æ—á–∫–∞ –±–∞–Ω–∫–∞ —Å —á–µ–∫–±–æ–∫—Å–æ–º
- `/components/ProductRow.tsx` - —Å—Ç—Ä–æ–∫–∞ –ø—Ä–æ–¥—É–∫—Ç–∞ —Å —á–µ–∫–±–æ–∫—Å–æ–º

## –ß—Ç–æ –ù–ï –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

‚úÖ –ü–æ—Ä—è–¥–æ–∫ —ç–∫—Ä–∞–Ω–æ–≤ (5 —à–∞–≥–æ–≤ + summary)
‚úÖ –í–∏–∑—É–∞–ª—å–Ω—ã–π —Å—Ç–∏–ª—å (–≤—Å–µ Color/Text Styles)
‚úÖ –ú–∞–∫–µ—Ç—ã –∏ Auto Layout
‚úÖ –í—ã–±–æ—Ä —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤
‚úÖ –í—ã–±–æ—Ä —Ü–µ–ª–µ–π (–Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –∏ –ø–æ–≥–∞—à–µ–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤)
‚úÖ –¢–µ–∫—Å—Ç—ã –∏ —Å—Å—ã–ª–∫–∏ –Ω–∞ —Å–æ–≥–ª–∞—à–µ–Ω–∏—è
‚úÖ –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å (desktop/tablet/mobile)
‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ light/dark —Ç–µ–º

## –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –±—ç–∫–µ–Ω–¥–æ–º:

1. ‚úÖ –í—Å–µ –ø–æ–ª—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—Ç –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞–º API
2. ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏—è loading/error/success –≤–µ–∑–¥–µ –≥–¥–µ –Ω—É–∂–Ω–æ
3. ‚úÖ Mock-–¥–∞–Ω–Ω—ã–µ –ª–µ–≥–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ API-–≤—ã–∑–æ–≤—ã
4. ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å –∫–æ–¥–∞–º–∏
5. ‚úÖ –°–æ—Ö—Ä–∞–Ω—ë–Ω –≤–µ—Å—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª –∏ –≤–∏–∑—É–∞–ª

–î–ª—è —Ä–µ–∞–ª—å–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —Ç–æ–ª—å–∫–æ –∑–∞–º–µ–Ω–∏—Ç—å mock-—Ñ—É–Ω–∫—Ü–∏–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–µ fetch-–≤—ã–∑–æ–≤—ã —Å–æ–≥–ª–∞—Å–Ω–æ –ø—Ä–∏–º–µ—Ä–∞–º –≤—ã—à–µ.
</file>

<file path="Figma_Front/src/guidelines/Guidelines.md">
**Add your own guidelines here**
<!--

System Guidelines

Use this file to provide the AI with rules and guidelines you want it to follow.
This template outlines a few examples of things you can add. You can add your own sections and format it to suit your needs

TIP: More context isn't always better. It can confuse the LLM. Try and add the most important rules you need

# General guidelines

Any general rules you want the AI to follow.
For example:

* Only use absolute positioning when necessary. Opt for responsive and well structured layouts that use flexbox and grid by default
* Refactor code as you go to keep code clean
* Keep file sizes small and put helper functions and components in their own files.

--------------

# Design system guidelines
Rules for how the AI should make generations look like your company's design system

Additionally, if you select a design system to use in the prompt box, you can reference
your design system's components, tokens, variables and components.
For example:

* Use a base font-size of 14px
* Date formats should always be in the format ‚ÄúJun 10‚Äù
* The bottom toolbar should only ever have a maximum of 4 items
* Never use the floating action button with the bottom toolbar
* Chips should always come in sets of 3 or more
* Don't use a dropdown if there are 2 or fewer options

You can also create sub sections and add more specific details
For example:


## Button
The Button component is a fundamental interactive element in our design system, designed to trigger actions or navigate
users through the application. It provides visual feedback and clear affordances to enhance user experience.

### Usage
Buttons should be used for important actions that users need to take, such as form submissions, confirming choices,
or initiating processes. They communicate interactivity and should have clear, action-oriented labels.

### Variants
* Primary Button
  * Purpose : Used for the main action in a section or page
  * Visual Style : Bold, filled with the primary brand color
  * Usage : One primary button per section to guide users toward the most important action
* Secondary Button
  * Purpose : Used for alternative or supporting actions
  * Visual Style : Outlined with the primary color, transparent background
  * Usage : Can appear alongside a primary button for less important actions
* Tertiary Button
  * Purpose : Used for the least important actions
  * Visual Style : Text-only with no border, using primary color
  * Usage : For actions that should be available but not emphasized
-->
</file>

<file path="Figma_Front/src/screens/CardsScreen.tsx">
import { ArrowLeft, CreditCard, Eye, EyeOff } from 'lucide-react';
import { useState } from 'react';
import { formatCurrency } from '../utils/formatters';
import type { AppState } from '../data/mockAppState';

interface CardsScreenProps {
  appState: AppState;
  onBack: () => void;
}

export function CardsScreen({ appState, onBack }: CardsScreenProps) {
  const [showBalance, setShowBalance] = useState(true);

  const getBankColor = (bank: string) => {
    const colors: Record<string, string> = {
      '–°–±–µ—Ä–±–∞–Ω–∫': 'from-green-600 to-green-700',
      '–¢–∏–Ω—å–∫–æ—Ñ—Ñ': 'from-yellow-500 to-yellow-600',
      '–ê–ª—å—Ñ–∞-–ë–∞–Ω–∫': 'from-red-600 to-red-700',
      '–í–¢–ë': 'from-blue-600 to-blue-700',
    };
    return colors[bank] || 'from-gray-700 to-gray-900';
  };

  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      <div className="max-w-lg mx-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b border-gray-200 z-10 px-4 py-4">
          <div className="flex items-center gap-3">
            <button
              onClick={onBack}
              className="p-2 -ml-2 hover:bg-gray-100 rounded-lg transition-colors"
              aria-label="–ù–∞–∑–∞–¥"
            >
              <ArrowLeft className="w-5 h-5" />
            </button>
            <h1 className="text-xl font-semibold text-gray-900">–ú–æ–∏ –∫–∞—Ä—Ç—ã</h1>
          </div>
        </div>

        <div className="p-4 space-y-6">
          {/* Total balance */}
          <div className="bg-white rounded-2xl p-5 border border-gray-200">
            <div className="flex items-center justify-between mb-2">
              <div className="text-sm text-gray-500">–û–±—â–∏–π –±–∞–ª–∞–Ω—Å</div>
              <button
                onClick={() => setShowBalance(!showBalance)}
                className="p-2 hover:bg-gray-100 rounded-lg transition-colors"
                aria-label={showBalance ? '–°–∫—Ä—ã—Ç—å –±–∞–ª–∞–Ω—Å' : '–ü–æ–∫–∞–∑–∞—Ç—å –±–∞–ª–∞–Ω—Å'}
              >
                {showBalance ? (
                  <Eye className="w-4 h-4 text-gray-500" />
                ) : (
                  <EyeOff className="w-4 h-4 text-gray-500" />
                )}
              </button>
            </div>
            <div className="text-3xl font-semibold text-gray-900">
              {showBalance ? formatCurrency(appState.balances.total_debit) : '‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢'}
            </div>
            <div className="text-xs text-gray-500 mt-1">
              –ù–∞ {appState.cards.filter(c => c.type === 'debit').length} –∫–∞—Ä—Ç–∞—Ö
            </div>
          </div>

          {/* Cards list */}
          <div>
            <h2 className="font-semibold text-gray-900 mb-3">–î–µ–±–µ—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã</h2>
            <div className="space-y-4">
              {appState.cards.filter(c => c.type === 'debit').map((card) => (
                <div
                  key={card.id}
                  className={`rounded-2xl p-6 bg-gradient-to-br ${getBankColor(card.bank)} text-white shadow-lg`}
                  data-api-binding="cards[]"
                >
                  <div className="flex items-start justify-between mb-8">
                    <div>
                      <div className="text-sm opacity-90 mb-1">{card.bank}</div>
                      <div className="text-xs opacity-75">–î–µ–±–µ—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞</div>
                    </div>
                    <CreditCard className="w-8 h-8 opacity-80" />
                  </div>

                  <div className="mb-6">
                    <div className="text-xs opacity-75 mb-1">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</div>
                    <div className="text-xl tracking-wider font-mono">
                      {card.mask}
                    </div>
                  </div>

                  <div className="flex items-end justify-between">
                    <div>
                      <div className="text-xs opacity-75 mb-1">–î–æ—Å—Ç—É–ø–Ω–æ</div>
                      <div className="text-2xl font-semibold">
                        {showBalance ? formatCurrency(card.balance) : '‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢'}
                      </div>
                    </div>
                    {card.holds > 0 && (
                      <div className="text-right">
                        <div className="text-xs opacity-75 mb-1">–í —Ö–æ–ª–¥–µ</div>
                        <div className="text-sm font-medium">
                          {showBalance ? formatCurrency(card.holds) : '‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢'}
                        </div>
                      </div>
                    )}
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Add card hint */}
          <button className="w-full p-5 bg-white border-2 border-dashed border-gray-300 rounded-2xl hover:border-purple-400 hover:bg-purple-50/50 transition-colors">
            <div className="flex items-center justify-center gap-2 text-gray-600">
              <div className="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center">
                <span className="text-xl">+</span>
              </div>
              <span className="font-medium">–î–æ–±–∞–≤–∏—Ç—å –∫–∞—Ä—Ç—É</span>
            </div>
          </button>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/screens/DepositsDetailScreen.tsx">
import { ArrowLeft, TrendingUp, Target, Sparkles } from 'lucide-react';
import { formatCurrency, formatDateFull } from '../utils/formatters';
import type { AppState } from '../data/mockAppState';

interface DepositsDetailScreenProps {
  appState: AppState;
  onBack: () => void;
  onPayment: (type: 'sdp') => void;
  onNavigate: (screen: string) => void;
}

export function DepositsDetailScreen({ appState, onBack, onPayment, onNavigate }: DepositsDetailScreenProps) {
  const { goals, deposits } = appState;
  const progress = (goals.summary.total_saved / goals.summary.target) * 100;

  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      <div className="max-w-lg mx-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b border-gray-200 z-10 px-4 py-4">
          <div className="flex items-center gap-3">
            <button
              onClick={onBack}
              className="p-2 -ml-2 hover:bg-gray-100 rounded-lg transition-colors"
              aria-label="–ù–∞–∑–∞–¥"
            >
              <ArrowLeft className="w-5 h-5" />
            </button>
            <h1 className="text-xl font-semibold text-gray-900">–ú–æ–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</h1>
          </div>
        </div>

        <div className="p-4 space-y-6">
          {/* Summary */}
          <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-2xl p-6 border border-green-200/50">
            <div className="text-sm text-green-700 mb-2">–ù–∞–∫–æ–ø–ª–µ–Ω–æ</div>
            <div className="text-3xl font-semibold text-green-900 mb-1">
              {formatCurrency(goals.summary.total_saved)}
            </div>
            <div className="text-xs text-green-600 mb-4">
              –¶–µ–ª—å: {formatCurrency(goals.summary.target)}
            </div>

            {/* Progress bar */}
            <div className="mb-4">
              <div className="h-3 bg-white/60 rounded-full overflow-hidden">
                <div
                  className="h-full bg-gradient-to-r from-green-500 to-green-600 transition-all duration-500"
                  style={{ width: `${Math.min(100, progress)}%` }}
                />
              </div>
              <div className="text-xs text-green-700 mt-2 text-right">
                {Math.round(progress)}% –∫ —Ü–µ–ª–∏
              </div>
            </div>

            <button
              onClick={() => onPayment('sdp')}
              className="w-full py-3 bg-green-600 text-white rounded-xl font-medium hover:bg-green-700 transition-colors"
            >
              –ü–æ–ø–æ–ª–Ω–∏—Ç—å {formatCurrency(goals.summary.daily_payment)}
            </button>
          </div>

          {/* Current deposit */}
          {deposits.current && (
            <div className="bg-white rounded-2xl p-5 border border-gray-200">
              <div className="flex items-center gap-2 mb-3">
                <Sparkles className="w-5 h-5 text-yellow-500" />
                <h2 className="font-semibold text-gray-900">–¢–µ–∫—É—â–∏–π –≤–∫–ª–∞–¥</h2>
              </div>

              <div className="mb-4">
                <div className="font-semibold text-gray-900 mb-1">{deposits.current.bank}</div>
                <div className="text-sm text-gray-600">{deposits.current.product}</div>
              </div>

              <div className="grid grid-cols-2 gap-4 mb-4">
                <div>
                  <div className="text-xs text-gray-500 mb-1">–ë–∞–ª–∞–Ω—Å</div>
                  <div className="text-lg font-semibold text-gray-900">
                    {formatCurrency(deposits.current.balance)}
                  </div>
                </div>
                <div>
                  <div className="text-xs text-gray-500 mb-1">–°—Ç–∞–≤–∫–∞</div>
                  <div className="text-lg font-semibold text-green-600">
                    {deposits.current.rate}%
                  </div>
                </div>
              </div>

              <div className="flex items-center gap-4 text-xs text-gray-600 pt-3 border-t border-gray-100">
                <div className="flex items-center gap-1">
                  {deposits.current.capitalization && (
                    <>
                      <div className="w-1.5 h-1.5 bg-green-500 rounded-full" />
                      <span>–ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è</span>
                    </>
                  )}
                </div>
                <div className="flex items-center gap-1">
                  {deposits.current.withdrawable && (
                    <>
                      <div className="w-1.5 h-1.5 bg-blue-500 rounded-full" />
                      <span>–ú–æ–∂–Ω–æ —Å–Ω–∏–º–∞—Ç—å</span>
                    </>
                  )}
                </div>
              </div>

              <div className="text-xs text-gray-500 mt-3">
                –î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è: {formatDateFull(deposits.current.maturity_date)}
              </div>
            </div>
          )}

          {/* Goal info */}
          <div className="bg-white rounded-2xl p-5 border border-gray-200">
            <div className="flex items-center gap-2 mb-3">
              <Target className="w-5 h-5 text-purple-500" />
              <h2 className="font-semibold text-gray-900">–í–∞—à–∞ —Ü–µ–ª—å</h2>
            </div>

            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-600">–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞</span>
                <span className="font-semibold text-gray-900">
                  {formatCurrency(deposits.goal.target_amount)}
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-600">–ì–æ—Ä–∏–∑–æ–Ω—Ç</span>
                <span className="font-semibold text-gray-900">
                  {deposits.goal.horizon_months} –º–µ—Å—è—Ü–µ–≤
                </span>
              </div>
              <div className="flex items-center justify-between">
                <span className="text-sm text-gray-600">–û—Å—Ç–∞–ª–æ—Å—å –Ω–∞–∫–æ–ø–∏—Ç—å</span>
                <span className="font-semibold text-purple-600">
                  {formatCurrency(deposits.goal.target_amount - goals.summary.total_saved)}
                </span>
              </div>
            </div>
          </div>

          {/* Better offers */}
          <div className="bg-white rounded-2xl p-5 border border-gray-200">
            <div className="flex items-center justify-between mb-4">
              <h2 className="font-semibold text-gray-900">–õ—É—á—à–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h2>
              <button
                onClick={() => onNavigate('refinance')}
                className="text-sm text-purple-600 font-medium hover:text-purple-700"
              >
                –í—Å–µ –æ—Ñ—Ñ–µ—Ä—ã ‚Üí
              </button>
            </div>

            <div className="space-y-3">
              {appState.offers.deposits.slice(0, 2).map((offer) => (
                <div
                  key={offer.id}
                  className="p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200/50"
                >
                  <div className="flex items-start justify-between mb-2">
                    <div>
                      <div className="font-semibold text-gray-900">{offer.bank}</div>
                      <div className="text-xs text-gray-600">{offer.product}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-lg font-semibold text-green-600">
                        {offer.rate}%
                      </div>
                      <div className="text-xs text-gray-500">
                        EAR {offer.ear}%
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center gap-3 text-xs text-gray-600">
                    <div>{offer.term_months} –º–µ—Å.</div>
                    <div>‚Ä¢</div>
                    <div>{offer.capitalization}</div>
                    <div>‚Ä¢</div>
                    <div>–æ—Ç {formatCurrency(offer.min_amount)}</div>
                  </div>
                </div>
              ))}
            </div>
          </div>

          {/* Projection */}
          <div className="bg-gradient-to-r from-purple-50 to-purple-100/50 rounded-2xl p-5 border border-purple-200/50">
            <div className="flex items-start gap-3">
              <TrendingUp className="w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5" />
              <div>
                <div className="text-sm font-medium text-gray-900 mb-1">
                  –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π
                </div>
                <div className="text-xs text-gray-600 mb-2">
                  –ü—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ç–µ–º–ø–µ ({formatCurrency(goals.summary.daily_payment)}/–¥–µ–Ω—å)
                </div>
                <div className="text-sm font-semibold text-purple-900">
                  –¶–µ–ª—å –±—É–¥–µ—Ç –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞ —á–µ—Ä–µ–∑ ~{Math.ceil((deposits.goal.target_amount - goals.summary.total_saved) / (goals.summary.daily_payment * 30))} –º–µ—Å—è—Ü–µ–≤
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/screens/HomeScreen.tsx">
import { HealthWidget } from '../components/widgets/HealthWidget';
import { STSWidget } from '../components/widgets/STSWidget';
import { LoansDepositsWidget } from '../components/widgets/LoansDepositsWidget';
import { DebitCardsWidget } from '../components/widgets/DebitCardsWidget';
import type { AppState } from '../data/mockAppState';

interface HomeScreenProps {
  appState: AppState;
  onNavigate: (screen: string) => void;
  onPayment: (type: 'mdp' | 'adp' | 'sdp') => void;
}

export function HomeScreen({ appState, onNavigate, onPayment }: HomeScreenProps) {
  const hasConsents = Object.keys(appState.user.consents).length > 0;

  if (!hasConsents) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <div className="max-w-md w-full bg-white rounded-2xl p-8 text-center border border-gray-200">
          <div className="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg className="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
          <h2 className="text-xl font-semibold text-gray-900 mb-2">–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –±–∞–Ω–∫–∏</h2>
          <p className="text-sm text-gray-600 mb-6">
            –î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –ø–æ–¥–∫–ª—é—á–∏—Ç–µ —Å–≤–æ–∏ –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ —Å—á–µ—Ç–∞ —á–µ—Ä–µ–∑ –±–µ–∑–æ–ø–∞—Å–Ω–æ–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
          </p>
          <button className="w-full py-3 px-6 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition-colors">
            –ü–æ–¥–∫–ª—é—á–∏—Ç—å –±–∞–Ω–∫–∏
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      <div className="max-w-lg mx-auto">
        {/* Header */}
        <div className="bg-white border-b border-gray-200 px-4 py-4">
          <h1 className="text-2xl font-semibold text-gray-900">–ü—Ä–∏–≤–µ—Ç, {appState.user.name.split(' ')[0]}!</h1>
          <p className="text-sm text-gray-600 mt-1">–í–∞—à–∏ —Ñ–∏–Ω–∞–Ω—Å—ã –ø–æ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º</p>
        </div>

        {/* Widgets */}
        <div className="p-4 space-y-4">
          <HealthWidget
            health={appState.health}
            onTap={() => onNavigate('health')}
          />

          <STSWidget
            sts={appState.sts}
            onTap={() => onNavigate('sts')}
          />

          <LoansDepositsWidget
            mode={appState.mode}
            loans={appState.loans}
            goals={appState.goals}
            onTap={() => onNavigate(appState.mode === 'loans' ? 'loans' : 'deposits')}
            onPayMDP={() => onPayment('mdp')}
            onPayADP={() => onPayment('adp')}
            onPaySDP={() => onPayment('sdp')}
          />

          <DebitCardsWidget
            balances={appState.balances}
            cards={appState.cards}
            onTap={() => onNavigate('cards')}
          />
        </div>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/screens/LoadingCalcScreen.tsx">
import { useEffect, useState } from 'react';
import { OnboardingData } from './OnboardingScreen';
import type { AppState } from '../data/mockAppState';

interface LoadingCalcScreenProps {
  onboardingData: OnboardingData;
  onComplete: (appState: AppState) => void;
}

export function LoadingCalcScreen({ onboardingData, onComplete }: LoadingCalcScreenProps) {
  const [progress, setProgress] = useState(0);
  const [status, setStatus] = useState('–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–Ω–∫–∞–º...');

  useEffect(() => {
    const loadData = async () => {
      // Simulate loading steps
      const steps = [
        { progress: 20, status: '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–Ω–∫–∞–º...', delay: 500 },
        { progress: 40, status: '–ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç–æ–≤...', delay: 600 },
        { progress: 60, status: '–ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π...', delay: 700 },
        { progress: 80, status: '–†–∞—Å—á—ë—Ç –º–µ—Ç—Ä–∏–∫...', delay: 600 },
        { progress: 100, status: '–ì–æ—Ç–æ–≤–æ!', delay: 400 },
      ];

      for (const step of steps) {
        await new Promise(resolve => setTimeout(resolve, step.delay));
        setProgress(step.progress);
        setStatus(step.status);
      }

      // Generate app_state from onboarding data
      const mode = onboardingData.goal?.type === 'save_money' ? 'deposits' : 'loans';
      
      // Mock data generation based on onboarding
      const mockLoans = [
        {
          id: 'loan-1',
          bank: onboardingData.linked_banks[0]?.name || '–ë–∞–Ω–∫ –ê',
          type: '–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—å—Å–∫–∏–π –∫—Ä–µ–¥–∏—Ç',
          balance: 350000,
          rate: 18.5,
          monthly_payment: 15000,
          maturity_date: '2026-03-15',
          priority: 1,
        },
        {
          id: 'loan-2',
          bank: onboardingData.linked_banks[1]?.name || '–ë–∞–Ω–∫ –ë',
          type: '–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞',
          balance: 125000,
          rate: 24.9,
          monthly_payment: 8000,
          maturity_date: '2025-09-20',
          priority: 2,
        },
      ];

      const mockCards = [
        {
          id: 'card-1',
          bank: onboardingData.linked_banks[0]?.name || '–ë–∞–Ω–∫ –ê',
          mask: '‚Ä¢‚Ä¢ 4532',
          balance: 45000,
          holds: 0,
          type: 'debit' as const,
        },
        {
          id: 'card-2',
          bank: onboardingData.linked_banks[1]?.name || '–ë–∞–Ω–∫ –ë',
          mask: '‚Ä¢‚Ä¢ 8821',
          balance: 12000,
          holds: 0,
          type: 'debit' as const,
        },
      ];

      const totalDebit = mockCards.reduce((sum, card) => sum + card.balance, 0);
      const totalOutstanding = mockLoans.reduce((sum, loan) => sum + loan.balance, 0);
      const mandatoryPayment = mockLoans.reduce((sum, loan) => sum + loan.monthly_payment * 0.03, 0);
      
      const riskMultiplier = onboardingData.goal?.risk_mode === 'fast' ? 1.4 : 
                             onboardingData.goal?.risk_mode === 'balanced' ? 1.2 : 1.05;
      const additionalPayment = mandatoryPayment * (riskMultiplier - 1);

      const stsToday = totalDebit - mandatoryPayment - additionalPayment;

      const appState: AppState = {
        mode,
        user: {
          id: onboardingData.user_profile.user_id,
          name: onboardingData.user_profile.display_name,
          consents: onboardingData.consents.reduce((acc, consent) => {
            acc[consent.bank_id] = consent.consent_id;
            return acc;
          }, {} as Record<string, string>),
        },
        onboarding: {
          completed: true,
          strategy: onboardingData.goal?.risk_mode === 'fast' ? '–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ' :
                   onboardingData.goal?.risk_mode === 'balanced' ? '—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ' : '–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ',
        },
        health: {
          score: 72,
          status: '—Å–ø–æ–∫–æ–π–Ω–æ',
          reasons: [
            '–î–æ–ª–≥–æ–≤–∞—è –Ω–∞–≥—Ä—É–∑–∫–∞ –≤ –Ω–æ—Ä–º–µ',
            '–†–µ–≥—É–ª—è—Ä–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏',
            '–ï—Å—Ç—å —Ä–µ–∑–µ—Ä–≤—ã –Ω–∞ —Å—á–µ—Ç–∞—Ö',
          ],
          next_action: mode === 'loans' ? {
            type: 'pay_mdp',
            label: '–í–Ω–µ—Å—Ç–∏ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂',
          } : {
            type: 'pay_sdp',
            label: '–ü–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è',
          },
        },
        sts: {
          today: {
            amount: Math.max(stsToday, 5000),
            spent: 0,
          },
          tomorrow: {
            impact: '–ü—Ä–∏ –æ–ø–ª–∞—Ç–µ MDP: +500 ‚ÇΩ –∫ STS –∑–∞–≤—Ç—Ä–∞',
          },
        },
        loans: {
          summary: {
            total_outstanding: totalOutstanding,
            mandatory_daily_payment: Math.round(mandatoryPayment),
            additional_daily_payment: Math.round(additionalPayment),
          },
          items: mockLoans,
        },
        goals: {
          summary: {
            total_saved: mode === 'deposits' ? 50000 : 0,
            daily_payment: mode === 'deposits' ? 500 : 0,
            target: onboardingData.goal?.save?.amount_target || 150000,
            target_date: '2025-12-31',
          },
        },
        deposits: {
          current: mode === 'deposits' ? {
            id: 'deposit-1',
            bank: onboardingData.linked_banks[0]?.name || '–ë–∞–Ω–∫ –ê',
            product: '–ù–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—ã–π —Å—á—ë—Ç',
            rate: 8.5,
            balance: 50000,
            capitalization: true,
            withdrawable: true,
            maturity_date: '2025-12-31',
          } : null,
          goal: {
            target_amount: onboardingData.goal?.save?.amount_target || 150000,
            horizon_months: onboardingData.goal?.save?.horizon === 'long' ? 24 : 12,
            liquidity: 'full',
          },
        },
        balances: {
          total: totalDebit + (mode === 'deposits' ? 50000 : 0),
          total_debit: totalDebit,
        },
        cards: mockCards,
        timeline: [
          {
            date: '2024-11-15',
            type: 'loan_payment',
            title: '–ü–ª–∞—Ç—ë–∂ –ø–æ –∫—Ä–µ–¥–∏—Ç—É',
            amount: 15000,
            can_defer: 5,
          },
          {
            date: '2024-11-20',
            type: 'loan_payment',
            title: '–ü–ª–∞—Ç—ë–∂ –ø–æ –∫–∞—Ä—Ç–µ',
            amount: 8000,
            can_defer: 3,
          },
        ],
        offers: {
          refi: [
            {
              id: 'refi-1',
              bank: '–ë–∞–Ω–∫ –†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è',
              rate: 14.9,
              term_months: 36,
              monthly_payment: 12500,
              commission: 2500,
              savings: 85000,
              breakeven_months: 3,
            },
          ],
          deposits: [],
        },
      };

      // Wait a bit to show "–ì–æ—Ç–æ–≤–æ!" message
      await new Promise(resolve => setTimeout(resolve, 500));
      
      onComplete(appState);
    };

    loadData();
  }, [onboardingData, onComplete]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-50 to-purple-100/50 flex items-center justify-center px-4">
      <div className="max-w-md w-full">
        <div className="bg-white rounded-3xl p-8 shadow-xl border border-purple-200/50">
          {/* Icon */}
          <div className="w-20 h-20 mx-auto mb-6 bg-purple-100 rounded-2xl flex items-center justify-center">
            <svg className="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
            </svg>
          </div>

          {/* Title */}
          <h2 className="text-center text-xl font-semibold text-gray-900 mb-2">
            –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–∞—à –ø—Ä–æ—Ñ–∏–ª—å
          </h2>
          <p className="text-center text-sm text-gray-600 mb-8">
            {status}
          </p>

          {/* Progress bar */}
          <div className="relative w-full h-2 bg-purple-100 rounded-full overflow-hidden">
            <div 
              className="absolute top-0 left-0 h-full bg-gradient-to-r from-purple-500 to-purple-600 rounded-full transition-all duration-500 ease-out"
              style={{ width: `${progress}%` }}
            />
          </div>

          {/* Progress text */}
          <div className="mt-4 text-center">
            <span className="text-sm font-medium text-purple-600">{progress}%</span>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/screens/LoansDetailScreen.tsx">
import { ArrowLeft, TrendingDown, Info, Zap } from 'lucide-react';
import { formatCurrency, formatDateFull, getMonthsUntil } from '../utils/formatters';
import type { AppState } from '../data/mockAppState';

interface LoansDetailScreenProps {
  appState: AppState;
  onBack: () => void;
  onPayment: (type: 'mdp' | 'adp') => void;
}

export function LoansDetailScreen({ appState, onBack, onPayment }: LoansDetailScreenProps) {
  const { loans, onboarding } = appState;

  const priorityLabels = ['–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç', '–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç', '–ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç'];

  const getStrategyLabel = () => {
    if (onboarding.strategy === '–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ') return '+5% –∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º';
    if (onboarding.strategy === '—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ') return '+20% –∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º';
    return '+40% –∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º';
  };

  const getStrategyColor = () => {
    if (onboarding.strategy === '–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ') return 'text-blue-600 bg-blue-50';
    if (onboarding.strategy === '—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ') return 'text-purple-600 bg-purple-50';
    return 'text-orange-600 bg-orange-50';
  };

  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      <div className="max-w-lg mx-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b border-gray-200 z-10 px-4 py-4">
          <div className="flex items-center gap-3">
            <button
              onClick={onBack}
              className="p-2 -ml-2 hover:bg-gray-100 rounded-lg transition-colors"
              aria-label="–ù–∞–∑–∞–¥"
            >
              <ArrowLeft className="w-5 h-5" />
            </button>
            <h1 className="text-xl font-semibold text-gray-900">–ú–æ–∏ –∫—Ä–µ–¥–∏—Ç—ã</h1>
          </div>
        </div>

        <div className="p-4 space-y-6">
          {/* Summary */}
          <div className="bg-white rounded-2xl p-5 border border-gray-200">
            <div className="text-sm text-gray-500 mb-2">–û–±—â–∏–π –¥–æ–ª–≥</div>
            <div className="text-3xl font-semibold text-gray-900 mb-4">
              {formatCurrency(loans.summary.total_outstanding)}
            </div>

            <div className="flex items-center gap-2 mb-4">
              <div className={`inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-xs font-medium ${getStrategyColor()}`}>
                <Zap className="w-3.5 h-3.5" />
                <span>{onboarding.strategy}</span>
              </div>
              <div className="text-xs text-gray-500">{getStrategyLabel()}</div>
            </div>

            <div className="grid grid-cols-2 gap-3">
              <button
                onClick={() => onPayment('mdp')}
                className="p-4 bg-red-50 rounded-xl hover:bg-red-100 transition-colors text-left"
              >
                <div className="text-xs text-gray-600 mb-1">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π</div>
                <div className="text-lg font-semibold text-gray-900">
                  {formatCurrency(1200)}
                </div>
                <div className="text-xs text-red-600 mt-1 font-medium">–û–ø–ª–∞—Ç–∏—Ç—å</div>
              </button>

              <button
                onClick={() => onPayment('adp')}
                className="p-4 bg-purple-50 rounded-xl hover:bg-purple-100 transition-colors text-left"
              >
                <div className="text-xs text-gray-600 mb-1">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π</div>
                <div className="text-lg font-semibold text-gray-900">
                  {formatCurrency(540)}
                </div>
                <div className="text-xs text-purple-600 mt-1 font-medium">–û–ø–ª–∞—Ç–∏—Ç—å</div>
              </button>
            </div>
          </div>

          {/* Strategy info */}
          <div className="bg-blue-50 rounded-2xl p-4">
            <div className="flex items-start gap-3">
              <Info className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
              <div>
                <div className="text-sm font-medium text-gray-900 mb-1">
                  –ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è: –ª–∞–≤–∏–Ω–∞ –¥–æ–ª–≥–æ–≤
                </div>
                <div className="text-xs text-gray-600">
                  –°–Ω–∞—á–∞–ª–∞ –∑–∞–∫—Ä—ã–≤–∞–µ–º –∫—Ä–µ–¥–∏—Ç—ã —Å –Ω–∞–∏–±–æ–ª—å—à–µ–π –ø—Ä–æ—Ü–µ–Ω—Ç–Ω–æ–π —Å—Ç–∞–≤–∫–æ–π, —á—Ç–æ–±—ã –º–∏–Ω–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–µ—Ä–µ–ø–ª–∞—Ç—É
                </div>
              </div>
            </div>
          </div>

          {/* Loans list */}
          <div>
            <h2 className="font-semibold text-gray-900 mb-3">–í—Å–µ –∫—Ä–µ–¥–∏—Ç—ã</h2>
            <div className="space-y-3">
              {loans.items.map((loan) => {
                const monthsLeft = getMonthsUntil(loan.maturity_date);
                return (
                  <div
                    key={loan.id}
                    className="bg-white rounded-2xl p-5 border border-gray-200"
                    data-api-binding="loans[]"
                  >
                    <div className="flex items-start justify-between mb-3">
                      <div>
                        <div className="font-semibold text-gray-900 mb-1">{loan.bank}</div>
                        <div className="text-xs text-gray-500">{loan.type}</div>
                      </div>
                      <div className={`px-2 py-1 rounded-full text-xs ${
                        loan.priority === 1
                          ? 'bg-red-50 text-red-700'
                          : loan.priority === 2
                          ? 'bg-orange-50 text-orange-700'
                          : 'bg-gray-100 text-gray-600'
                      }`}>
                        {priorityLabels[loan.priority - 1]}
                      </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4 mb-3">
                      <div>
                        <div className="text-xs text-gray-500 mb-1">–û—Å—Ç–∞—Ç–æ–∫</div>
                        <div className="text-lg font-semibold text-gray-900">
                          {formatCurrency(loan.balance)}
                        </div>
                      </div>
                      <div>
                        <div className="text-xs text-gray-500 mb-1">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</div>
                        <div className="text-lg font-semibold text-gray-900">
                          {formatCurrency(loan.monthly_payment)}
                        </div>
                      </div>
                    </div>

                    <div className="flex items-center justify-between text-xs text-gray-600 pt-3 border-t border-gray-100">
                      <div>
                        <span className="text-gray-500">–°—Ç–∞–≤–∫–∞: </span>
                        <span className="font-medium">{loan.rate}%</span>
                      </div>
                      <div>
                        <span className="text-gray-500">–û—Å—Ç–∞–ª–æ—Å—å: </span>
                        <span className="font-medium">{monthsLeft} –º–µ—Å.</span>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          </div>

          {/* Simulator hint */}
          <div className="bg-gradient-to-r from-purple-50 to-purple-100/50 rounded-2xl p-5 border border-purple-200/50">
            <div className="flex items-start gap-3">
              <TrendingDown className="w-5 h-5 text-purple-600 flex-shrink-0 mt-0.5" />
              <div>
                <div className="text-sm font-medium text-gray-900 mb-1">
                  –°–∏–º—É–ª—è—Ç–æ—Ä –∑–∞–∫—Ä—ã—Ç–∏—è
                </div>
                <div className="text-xs text-gray-600 mb-3">
                  –ü—Ä–∏ —Ç–µ–∫—É—â–µ–º —Ç–µ–º–ø–µ –≤—Å–µ –∫—Ä–µ–¥–∏—Ç—ã –±—É–¥—É—Ç –∑–∞–∫—Ä—ã—Ç—ã —á–µ—Ä–µ–∑{' '}
                  <span className="font-semibold text-purple-900">18 –º–µ—Å—è—Ü–µ–≤</span>
                </div>
                <div className="text-xs text-purple-700 font-medium">
                  –£–≤–µ–ª–∏—á—å—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ –Ω–∞ 50% ‚Üí –∑–∞–∫—Ä—ã—Ç–∏–µ –∑–∞ 14 –º–µ—Å—è—Ü–µ–≤
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/screens/OnboardingScreen.tsx">
import { useState } from 'react';
import { Step1UserInfo } from '../components/steps/Step1UserInfo';
import { Step2BankSelection } from '../components/steps/Step2BankSelection';
import { Step3BankConsent } from '../components/steps/Step3BankConsent';
import { Step4ProductSelection } from '../components/steps/Step4ProductSelection';
import { Step5Questions } from '../components/steps/Step5Questions';
import { Stepper } from '../components/Stepper';

export interface OnboardingData {
  user_profile: {
    user_id: string;
    display_name: string;
  };
  linked_banks: Array<{
    bank_id: string;
    name: string;
    connected: boolean;
  }>;
  consents: Array<{
    bank_id: string;
    consent_id: string;
    status: 'pending' | 'approved' | 'rejected';
  }>;
  selected_products: Array<{
    bank_id: string;
    product_id: string;
    product_type: 'loan' | 'deposit' | 'card';
  }>;
  goal: {
    type: 'close_debts' | 'save_money' | 'both';
    risk_mode: 'conservative' | 'balanced' | 'fast';
    save?: {
      amount_target: number;
      horizon: 'short' | 'long';
    };
    debts?: {
      selected_loan_ids: string[];
    };
  } | null;
}

interface OnboardingScreenProps {
  onComplete: (data: OnboardingData) => void;
}

export function OnboardingScreen({ onComplete }: OnboardingScreenProps) {
  const [currentStep, setCurrentStep] = useState(1);
  const [onboardingState, setOnboardingState] = useState<any>({
    user_id: '',
    user_name: '',
    banks: [],
    selected_bank_ids: [],
    consents: {},
    selected_products: [],
    goals: {
      mode: null,
      save_amount: null,
      save_speed: null,
      close_loan_ids: [],
      close_speed: null,
    },
  });

  const handleStep1Complete = (userId: string, userName: string) => {
    setOnboardingState((prev: any) => ({
      ...prev,
      user_id: userId,
      user_name: userName,
    }));
    setCurrentStep(2);
  };

  const handleStep2Complete = (selectedBankIds: string[]) => {
    setOnboardingState((prev: any) => ({
      ...prev,
      selected_bank_ids: selectedBankIds,
    }));
    setCurrentStep(3);
  };

  const handleStep3Complete = (consents: any) => {
    setOnboardingState((prev: any) => ({
      ...prev,
      consents,
      // Mark selected banks as connected
      banks: prev.banks.map((bank: any) => ({
        ...bank,
        connected: prev.selected_bank_ids.includes(bank.id),
      })),
    }));
    setCurrentStep(4);
  };

  const handleStep4Complete = (products: any[]) => {
    setOnboardingState((prev: any) => ({
      ...prev,
      selected_products: products,
    }));
    setCurrentStep(5);
  };

  const handleStep5Complete = (goals: any) => {
    // Map onboarding data to final structure
    const finalData: OnboardingData = {
      user_profile: {
        user_id: onboardingState.user_id || 'demo-user',
        display_name: onboardingState.user_name || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
      },
      linked_banks: (onboardingState.banks || [])
        .filter((bank: any) => (onboardingState.selected_bank_ids || []).includes(bank.id))
        .map((bank: any) => ({
          bank_id: bank.id,
          name: bank.name,
          connected: true,
        })),
      consents: onboardingState.consents 
        ? Object.entries(onboardingState.consents).map(([bank_id, consent_id]) => ({
            bank_id,
            consent_id: consent_id as string,
            status: 'approved' as const,
          }))
        : [],
      selected_products: onboardingState.selected_products || [],
      goal: goals.mode ? {
        type: goals.mode === 'save' ? 'save_money' : goals.mode === 'close_loans' ? 'close_debts' : 'both',
        risk_mode: goals.save_speed || goals.close_speed || 'balanced',
        ...(goals.mode === 'save' || goals.mode === 'both' ? {
          save: {
            amount_target: goals.save_amount,
            horizon: goals.save_amount > 500000 ? 'long' : 'short',
          }
        } : {}),
        ...(goals.mode === 'close_loans' || goals.mode === 'both' ? {
          debts: {
            selected_loan_ids: goals.close_loan_ids || [],
          }
        } : {}),
      } : null,
    };

    onComplete(finalData);
  };

  const handleSkip = () => {
    // Create minimal onboarding data for skip
    const minimalData: OnboardingData = {
      user_profile: {
        user_id: 'demo-user',
        display_name: '–ò–≤–∞–Ω',
      },
      linked_banks: [],
      consents: [],
      selected_products: [],
      goal: null,
    };
    onComplete(minimalData);
  };

  return (
    <div className="min-h-screen bg-[var(--color-bg-primary)]">
      <div className="max-w-4xl mx-auto px-4 py-6 md:py-8">
        {/* Stepper */}
        <div className="mb-8 md:mb-12">
          <Stepper currentStep={currentStep} totalSteps={5} />
        </div>

        {/* Step Content */}
        <div className="pb-20">
          {currentStep === 1 && (
            <Step1UserInfo
              onNext={handleStep1Complete}
              onSkip={handleSkip}
              initialUserId={onboardingState.user_id}
              initialName={onboardingState.user_name}
            />
          )}

          {currentStep === 2 && (
            <Step2BankSelection
              onNext={handleStep2Complete}
              onBack={() => setCurrentStep(1)}
              initialSelection={onboardingState.selected_bank_ids}
              onboardingState={onboardingState}
              setOnboardingState={setOnboardingState}
            />
          )}

          {currentStep === 3 && (
            <Step3BankConsent
              onNext={handleStep3Complete}
              onBack={() => setCurrentStep(2)}
              selectedBanks={onboardingState.selected_bank_ids}
              banks={onboardingState.banks}
              initialConsents={onboardingState.consents}
            />
          )}

          {currentStep === 4 && (
            <Step4ProductSelection
              onNext={handleStep4Complete}
              onBack={() => setCurrentStep(3)}
              connectedBanks={onboardingState.banks.filter((bank: any) =>
                onboardingState.selected_bank_ids.includes(bank.id)
              )}
              initialProducts={onboardingState.selected_products}
            />
          )}

          {currentStep === 5 && (
            <Step5Questions
              onNext={handleStep5Complete}
              onBack={() => setCurrentStep(4)}
              initialGoals={onboardingState.goals}
            />
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/screens/RefinanceScreen.tsx">
import { ArrowLeft, TrendingDown, Check, AlertCircle } from 'lucide-react';
import { useState } from 'react';
import { formatCurrency } from '../utils/formatters';
import type { AppState } from '../data/mockAppState';

interface RefinanceScreenProps {
  appState: AppState;
  onBack: () => void;
}

export function RefinanceScreen({ appState, onBack }: RefinanceScreenProps) {
  const [selectedOffer, setSelectedOffer] = useState<string | null>(null);
  const [applicationStatus, setApplicationStatus] = useState<'idle' | 'pending' | 'approved' | 'declined'>('idle');

  const isLoansMode = appState.mode === 'loans';
  const offers = isLoansMode ? appState.offers.refi : appState.offers.deposits;

  const handleSelectOffer = (offerId: string) => {
    setSelectedOffer(offerId);
  };

  const handleSubmitApplication = () => {
    setApplicationStatus('pending');
    // Simulate API call
    setTimeout(() => {
      setApplicationStatus(Math.random() > 0.3 ? 'approved' : 'declined');
    }, 2000);
  };

  if (applicationStatus === 'pending') {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <div className="max-w-md w-full bg-white rounded-2xl p-8 text-center border border-gray-200">
          <div className="w-16 h-16 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4 animate-pulse">
            <div className="w-8 h-8 border-4 border-purple-600 border-t-transparent rounded-full animate-spin" />
          </div>
          <h2 className="text-xl font-semibold text-gray-900 mb-2">–û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏</h2>
          <p className="text-sm text-gray-600">
            –û–∂–∏–¥–∞–µ–º –æ—Ç–≤–µ—Ç –æ—Ç –±–∞–Ω–∫–∞...
          </p>
        </div>
      </div>
    );
  }

  if (applicationStatus === 'approved') {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <div className="max-w-md w-full bg-white rounded-2xl p-8 text-center border border-gray-200">
          <div className="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <Check className="w-8 h-8 text-green-600" />
          </div>
          <h2 className="text-xl font-semibold text-gray-900 mb-2">–ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞!</h2>
          <p className="text-sm text-gray-600 mb-6">
            –í–∞—à–∏ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –±—É–¥—É—Ç –æ–±–Ω–æ–≤–ª–µ–Ω—ã, –∏ STS –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
          </p>
          <button
            onClick={onBack}
            className="w-full py-3 px-6 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition-colors"
            data-action="refresh_balances(), recalc_sts()"
          >
            –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é
          </button>
        </div>
      </div>
    );
  }

  if (applicationStatus === 'declined') {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center p-4">
        <div className="max-w-md w-full bg-white rounded-2xl p-8 text-center border border-gray-200">
          <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
            <AlertCircle className="w-8 h-8 text-red-600" />
          </div>
          <h2 className="text-xl font-semibold text-gray-900 mb-2">–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞</h2>
          <p className="text-sm text-gray-600 mb-6">
            –ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –±–∞–Ω–∫ –æ—Ç–∫–ª–æ–Ω–∏–ª –∑–∞—è–≤–∫—É. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
          </p>
          <button
            onClick={() => {
              setApplicationStatus('idle');
              setSelectedOffer(null);
            }}
            className="w-full py-3 px-6 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition-colors"
          >
            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥—Ä—É–≥–∏–µ –æ—Ñ—Ñ–µ—Ä—ã
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      <div className="max-w-lg mx-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b border-gray-200 z-10 px-4 py-4">
          <div className="flex items-center gap-3">
            <button
              onClick={onBack}
              className="p-2 -ml-2 hover:bg-gray-100 rounded-lg transition-colors"
              aria-label="–ù–∞–∑–∞–¥"
            >
              <ArrowLeft className="w-5 h-5" />
            </button>
            <h1 className="text-xl font-semibold text-gray-900">
              {isLoansMode ? '–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–õ—É—á—à–∏–µ –≤–∫–ª–∞–¥—ã'}
            </h1>
          </div>
        </div>

        <div className="p-4 space-y-4">
          {/* Info banner */}
          <div className="bg-purple-50 rounded-2xl p-4 border border-purple-200/50">
            <div className="text-sm font-medium text-gray-900 mb-1">
              {isLoansMode ? '–°–Ω–∏–∑—å—Ç–µ –ø–µ—Ä–µ–ø–ª–∞—Ç—É –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º' : '–£–≤–µ–ª–∏—á—å—Ç–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å'}
            </div>
            <div className="text-xs text-gray-600">
              {isLoansMode 
                ? '–ú—ã –Ω–∞—à–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è —Å –±–æ–ª–µ–µ –≤—ã–≥–æ–¥–Ω—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏ –¥–ª—è –≤–∞—Å'
                : '–†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –≤–∫–ª–∞–¥—ã —Å –±–æ–ª–µ–µ –≤—ã—Å–æ–∫–æ–π —Å—Ç–∞–≤–∫–æ–π –∏ –ª—É—á—à–∏–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏'
              }
            </div>
          </div>

          {/* Offers list */}
          <div className="space-y-3">
            {isLoansMode ? (
              // Loan refinancing offers
              (offers as AppState['offers']['refi']).map((offer) => (
                <button
                  key={offer.id}
                  onClick={() => handleSelectOffer(offer.id)}
                  className={`w-full text-left bg-white rounded-2xl p-5 border-2 transition-all ${
                    selectedOffer === offer.id
                      ? 'border-purple-500 shadow-lg'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                  data-api-binding="offers.refi[]"
                >
                  <div className="flex items-start justify-between mb-3">
                    <div>
                      <div className="font-semibold text-gray-900 mb-1">{offer.bank}</div>
                      <div className="text-xs text-gray-500">–†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ</div>
                    </div>
                    <div className="text-right">
                      <div className="text-2xl font-semibold text-purple-600">
                        {offer.rate}%
                      </div>
                      <div className="text-xs text-gray-500">{offer.term_months} –º–µ—Å.</div>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4 mb-3">
                    <div>
                      <div className="text-xs text-gray-500 mb-0.5">–ï–∂–µ–º–µ—Å—è—á–Ω–æ</div>
                      <div className="font-semibold text-gray-900">
                        {formatCurrency(offer.monthly_payment)}
                      </div>
                    </div>
                    <div>
                      <div className="text-xs text-gray-500 mb-0.5">–ö–æ–º–∏—Å—Å–∏—è</div>
                      <div className="font-semibold text-gray-900">
                        {offer.commission > 0 ? formatCurrency(offer.commission) : '–ë–µ–∑ –∫–æ–º–∏—Å—Å–∏–∏'}
                      </div>
                    </div>
                  </div>

                  <div className="pt-3 border-t border-gray-100">
                    <div className="flex items-center justify-between text-sm">
                      <div className="flex items-center gap-1.5 text-green-600">
                        <TrendingDown className="w-4 h-4" />
                        <span className="font-medium">–≠–∫–æ–Ω–æ–º–∏—è {formatCurrency(offer.savings)}</span>
                      </div>
                      <div className="text-xs text-gray-500">
                        –û–∫—É–ø–∞–µ—Ç—Å—è –∑–∞ {offer.breakeven_months} –º–µ—Å.
                      </div>
                    </div>
                  </div>
                </button>
              ))
            ) : (
              // Deposit offers
              (offers as AppState['offers']['deposits']).map((offer) => (
                <button
                  key={offer.id}
                  onClick={() => handleSelectOffer(offer.id)}
                  className={`w-full text-left bg-white rounded-2xl p-5 border-2 transition-all ${
                    selectedOffer === offer.id
                      ? 'border-purple-500 shadow-lg'
                      : 'border-gray-200 hover:border-gray-300'
                  }`}
                  data-api-binding="offers.deposits[]"
                >
                  <div className="flex items-start justify-between mb-3">
                    <div>
                      <div className="font-semibold text-gray-900 mb-1">{offer.bank}</div>
                      <div className="text-xs text-gray-500">{offer.product}</div>
                    </div>
                    <div className="text-right">
                      <div className="text-2xl font-semibold text-green-600">
                        {offer.rate}%
                      </div>
                      <div className="text-xs text-gray-500">EAR {offer.ear}%</div>
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4 mb-3">
                    <div>
                      <div className="text-xs text-gray-500 mb-0.5">–°—Ä–æ–∫</div>
                      <div className="font-semibold text-gray-900">
                        {offer.term_months} –º–µ—Å.
                      </div>
                    </div>
                    <div>
                      <div className="text-xs text-gray-500 mb-0.5">–ú–∏–Ω–∏–º—É–º</div>
                      <div className="font-semibold text-gray-900">
                        {formatCurrency(offer.min_amount)}
                      </div>
                    </div>
                  </div>

                  <div className="flex items-center gap-3 text-xs text-gray-600 pt-3 border-t border-gray-100">
                    <div className="flex items-center gap-1">
                      <div className="w-1.5 h-1.5 bg-green-500 rounded-full" />
                      <span>{offer.capitalization}</span>
                    </div>
                    {offer.withdrawable && (
                      <div className="flex items-center gap-1">
                        <div className="w-1.5 h-1.5 bg-blue-500 rounded-full" />
                        <span>–ú–æ–∂–Ω–æ —Å–Ω–∏–º–∞—Ç—å</span>
                      </div>
                    )}
                  </div>
                </button>
              ))
            )}
          </div>

          {/* Submit button */}
          {selectedOffer && (
            <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200">
              <div className="max-w-lg mx-auto">
                <button
                  onClick={handleSubmitApplication}
                  className="w-full py-4 px-6 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition-colors shadow-lg"
                  data-action="submit_refi_application(offer_id)"
                >
                  –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                </button>
              </div>
            </div>
          )}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/screens/SplashScreen.tsx">
import { useEffect } from 'react';

interface SplashScreenProps {
  onComplete: () => void;
}

export function SplashScreen({ onComplete }: SplashScreenProps) {
  useEffect(() => {
    // Auto-transition after 2 seconds
    const timer = setTimeout(() => {
      onComplete();
    }, 2000);

    return () => clearTimeout(timer);
  }, [onComplete]);

  return (
    <div className="min-h-screen bg-gradient-to-br from-purple-600 via-purple-500 to-purple-700 flex items-center justify-center">
      <div className="text-center px-6">
        {/* Logo/Icon */}
        <div className="w-24 h-24 mx-auto mb-6 bg-white/20 backdrop-blur-sm rounded-3xl flex items-center justify-center">
          <div className="w-16 h-16 bg-white rounded-2xl flex items-center justify-center">
            <span className="text-4xl">üí≥</span>
          </div>
        </div>
        
        {/* App Name */}
        <h1 className="text-white mb-2">Credit Guard</h1>
        <p className="text-purple-100 text-sm">–í–∞—à —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ–º–æ—â–Ω–∏–∫</p>
        
        {/* Loading indicator */}
        <div className="mt-8 flex justify-center gap-2">
          <div className="w-2 h-2 bg-white/60 rounded-full animate-pulse" style={{ animationDelay: '0ms' }}></div>
          <div className="w-2 h-2 bg-white/60 rounded-full animate-pulse" style={{ animationDelay: '200ms' }}></div>
          <div className="w-2 h-2 bg-white/60 rounded-full animate-pulse" style={{ animationDelay: '400ms' }}></div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/screens/STSDetailScreen.tsx">
import { ArrowLeft } from 'lucide-react';
import { formatCurrency } from '../utils/formatters';
import type { AppState } from '../data/mockAppState';

interface STSDetailScreenProps {
  appState: AppState;
  onBack: () => void;
  onPayment: (type: 'mdp' | 'adp' | 'sdp') => void;
}

export function STSDetailScreen({ appState, onBack, onPayment }: STSDetailScreenProps) {
  const { sts } = appState;
  const remaining = 1700;

  // Mock chart data for 30 days
  const chartData = Array.from({ length: 30 }, (_, i) => ({
    day: i + 1,
    amount: 8000 + Math.random() * 8000,
  }));

  return (
    <div className="min-h-screen bg-gray-50 pb-20">
      <div className="max-w-lg mx-auto">
        {/* Header */}
        <div className="sticky top-0 bg-white border-b border-gray-200 z-10 px-4 py-4">
          <div className="flex items-center gap-3">
            <button
              onClick={onBack}
              className="p-2 -ml-2 hover:bg-gray-100 rounded-lg transition-colors"
              aria-label="–ù–∞–∑–∞–¥"
            >
              <ArrowLeft className="w-5 h-5" />
            </button>
            <h1 className="text-xl font-semibold text-gray-900">Safe to Spend</h1>
          </div>
        </div>

        <div className="p-4 space-y-6">
          {/* Current STS */}
          <div className="bg-gradient-to-br from-purple-50 to-purple-100/50 rounded-2xl p-6 border border-purple-200/50">
            <div className="text-sm text-purple-700 mb-2">–î–æ—Å—Ç—É–ø–Ω–æ —Å–µ–≥–æ–¥–Ω—è</div>
            <div className="text-4xl font-semibold text-purple-900 mb-3">
              {formatCurrency(remaining)}
            </div>
            <div className="flex items-center gap-4 text-sm">
              <div>
                <span className="text-purple-600">–ü–æ—Ç—Ä–∞—á–µ–Ω–æ: </span>
                <span className="font-medium text-purple-900">{formatCurrency(sts.today.spent)}</span>
              </div>
              <div>
                <span className="text-purple-600">–õ–∏–º–∏—Ç: </span>
                <span className="font-medium text-purple-900">{formatCurrency(sts.today.amount)}</span>
              </div>
            </div>
          </div>

          {/* Quick actions */}
          <div className="bg-white rounded-2xl p-5 border border-gray-200">
            <h2 className="font-semibold text-gray-900 mb-4">–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h2>
            <div className="space-y-3">
              {appState.mode === 'loans' && (
                <>
                  <button
                    onClick={() => onPayment('mdp')}
                    className="w-full flex items-center justify-between p-4 bg-red-50 rounded-xl hover:bg-red-100 transition-colors"
                  >
                    <div className="text-left">
                      <div className="text-sm font-medium text-gray-900">–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂</div>
                      <div className="text-xs text-gray-600 mt-0.5">
                        {formatCurrency(1200)}
                      </div>
                    </div>
                    <div className="px-4 py-2 bg-red-600 text-white text-sm rounded-lg font-medium">
                      –û–ø–ª–∞—Ç–∏—Ç—å
                    </div>
                  </button>
                  <button
                    onClick={() => onPayment('adp')}
                    className="w-full flex items-center justify-between p-4 bg-purple-50 rounded-xl hover:bg-purple-100 transition-colors"
                  >
                    <div className="text-left">
                      <div className="text-sm font-medium text-gray-900">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂</div>
                      <div className="text-xs text-gray-600 mt-0.5">
                        {formatCurrency(540)}
                      </div>
                    </div>
                    <div className="px-4 py-2 bg-purple-600 text-white text-sm rounded-lg font-medium">
                      –û–ø–ª–∞—Ç–∏—Ç—å
                    </div>
                  </button>
                </>
              )}
              {appState.mode === 'deposits' && (
                <button
                  onClick={() => onPayment('sdp')}
                  className="w-full flex items-center justify-between p-4 bg-green-50 rounded-xl hover:bg-green-100 transition-colors"
                >
                  <div className="text-left">
                    <div className="text-sm font-medium text-gray-900">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</div>
                    <div className="text-xs text-gray-600 mt-0.5">
                      {formatCurrency(appState.goals.summary.daily_payment)}
                    </div>
                  </div>
                  <div className="px-4 py-2 bg-green-600 text-white text-sm rounded-lg font-medium">
                    SDP
                  </div>
                </button>
              )}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="Figma_Front/src/styles/globals.css">
@import "tailwindcss";

@layer theme {
  :root {
    /* Brand Colors - Purple accent as per requirements */
    --color-brand-primary: #7c3aed;
    --color-brand-primary-hover: #6d28d9;
    --color-brand-primary-light: #a78bfa;
    
    /* Text Colors */
    --color-text-primary: #0f172a;
    --color-text-secondary: #64748b;
    --color-text-tertiary: #94a3b8;
    --color-text-inverse: #ffffff;
    
    /* Background Colors */
    --color-bg-default: #f9fafb;
    --color-bg-secondary: #f3f4f6;
    --color-bg-surface: #ffffff;
    
    /* Surface & Borders */
    --color-surface-panel: #ffffff;
    --color-stroke-divider: #e5e7eb;
    --color-stroke-input: #d1d5db;
    
    /* Status Colors - Stress-free palette (no red/orange) */
    --color-success: #10b981;
    --color-success-light: #d1fae5;
    --color-info: #3b82f6;
    --color-info-light: #dbeafe;
    
    /* Health Status Colors */
    --color-accent-primary: #7c3aed;
    --color-accent-light: #ede9fe;
    --color-calm: #10b981;
    --color-calm-light: #d1fae5;
    --color-attention: #f59e0b;
    --color-attention-light: #fef3c7;
    --color-plan-needed: #8b5cf6;
    --color-plan-needed-light: #ede9fe;
    
    /* Legacy error colors (used minimally) */
    --color-error: #dc2626;
    --color-error-light: #fee2e2;
    --color-warning: #f59e0b;
    --color-warning-light: #fef3c7;
    
    /* Shadows */
    --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
    --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1);
    --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1);
    --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1);
  }

  [data-theme="dark"] {
    /* Text Colors Dark */
    --color-text-primary: #f1f5f9;
    --color-text-secondary: #94a3b8;
    --color-text-tertiary: #64748b;
    --color-text-inverse: #0f172a;
    
    /* Background Colors Dark */
    --color-bg-default: #0f172a;
    --color-bg-secondary: #1e293b;
    --color-bg-surface: #1e293b;
    
    /* Surface & Borders Dark */
    --color-surface-panel: #1e293b;
    --color-stroke-divider: #334155;
    --color-stroke-input: #475569;
  }
}

@layer base {
  * {
    @apply border-[var(--color-stroke-divider)];
  }

  body {
    @apply bg-[var(--color-bg-default)] text-[var(--color-text-primary)] antialiased transition-colors duration-200;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
  }

  h1 {
    font-size: 24px;
    line-height: 32px;
  }

  h2 {
    font-size: 20px;
    line-height: 28px;
  }

  p {
    font-size: 16px;
    line-height: 24px;
  }

  button {
    font-size: 14px;
    line-height: 16px;
  }

  .caption {
    font-size: 12px;
    line-height: 16px;
  }
}

@layer utilities {
  .container-responsive {
    @apply mx-auto w-full px-4 md:px-5 lg:px-6;
    @apply max-w-full md:max-w-[720px] lg:max-w-[1200px];
  }

  .shadow-card {
    box-shadow: var(--shadow-md);
  }

  .shadow-card-hover {
    box-shadow: var(--shadow-lg);
  }
}
</file>

<file path="Figma_Front/src/utils/formatters.ts">
// Utility functions for formatting data

export function formatCurrency(amount: number): string {
  return new Intl.NumberFormat('ru-RU', {
    style: 'currency',
    currency: 'RUB',
    minimumFractionDigits: 0,
    maximumFractionDigits: 0,
  }).format(amount);
}

export function formatDate(dateStr: string): string {
  const date = new Date(dateStr);
  return new Intl.DateTimeFormat('ru-RU', {
    day: 'numeric',
    month: 'short',
  }).format(date);
}

export function formatDateFull(dateStr: string): string {
  const date = new Date(dateStr);
  return new Intl.DateTimeFormat('ru-RU', {
    day: 'numeric',
    month: 'long',
    year: 'numeric',
  }).format(date);
}

export function getDaysUntil(dateStr: string): number {
  const date = new Date(dateStr);
  const now = new Date();
  const diff = date.getTime() - now.getTime();
  return Math.ceil(diff / (1000 * 60 * 60 * 24));
}

export function getMonthsUntil(dateStr: string): number {
  const date = new Date(dateStr);
  const now = new Date();
  const months = (date.getFullYear() - now.getFullYear()) * 12 + (date.getMonth() - now.getMonth());
  return months;
}
</file>

<file path="Figma_Front/src/API_INTEGRATION.md">
# API Integration Guide

–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ Credit Guard —Å —Ä–µ–∞–ª—å–Ω—ã–º backend API.

## üì° –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

### –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –∏ –¥–æ—Å—Ç—É–ø—ã

```typescript
// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —Å–æ–≥–ª–∞—Å–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
GET /api/v1/user/consents
Response: {
  [bankId: string]: 'granted' | 'pending' | 'denied'
}

// –ü–æ–¥–∫–ª—é—á–∏—Ç—å –Ω–æ–≤—ã–π –±–∞–Ω–∫
POST /api/v1/user/consents
Body: {
  bankId: string
  redirectUrl: string
}
Response: {
  consentUrl: string  // URL –¥–ª—è —Ä–µ–¥–∏—Ä–µ–∫—Ç–∞
  consentId: string
}
```

### –ë–∞–ª–∞–Ω—Å—ã –∏ –∫–∞—Ä—Ç—ã

```typescript
// –ü–æ–ª—É—á–∏—Ç—å –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –∏ –∫–∞—Ä—Ç—ã
GET /api/v1/balances
Response: {
  total: number
  total_debit: number
  cards: Array<{
    id: string
    bank: string
    mask: string
    balance: number
    holds: number
    type: 'debit' | 'credit'
  }>
}

// –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã (–ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
POST /api/v1/balances/refresh
Response: {
  status: 'syncing' | 'completed'
  timestamp: string
}
```

### Safe to Spend (STS)

```typescript
// –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π STS
GET /api/v1/sts/today
Response: {
  amount: number        // –î–æ—Å—Ç—É–ø–Ω–æ —Å–µ–≥–æ–¥–Ω—è
  spent: number        // –ü–æ—Ç—Ä–∞—á–µ–Ω–æ
  tomorrow: {
    impact: string     // –¢–µ–∫—Å—Ç–æ–≤–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–≥–Ω–æ–∑–∞
    amount: number     // –ü—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –∑–∞–≤—Ç—Ä–∞
  }
}

// –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å STS –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
POST /api/v1/sts/recalculate
Body: {
  reason: 'payment' | 'income' | 'manual'
  amount?: number
}
Response: {
  new_sts: number
  previous_sts: number
  diff: number
}
```

### –ö—Ä–µ–¥–∏—Ç—ã

```typescript
// –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É –ø–æ –∫—Ä–µ–¥–∏—Ç–∞–º
GET /api/v1/loans/summary
Response: {
  total_outstanding: number
  mandatory_daily_payment: number
  additional_daily_payment: number
  total_monthly_payment: number
}

// –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫—Ä–µ–¥–∏—Ç–æ–≤
GET /api/v1/loans
Response: {
  items: Array<{
    id: string
    bank: string
    type: string
    balance: number
    rate: number
    monthly_payment: number
    maturity_date: string
    priority: number
  }>
}

// –û–ø–ª–∞—Ç–∏—Ç—å –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞—Ç—ë–∂
POST /api/v1/loans/pay/mdp
Body: {
  amount: number
  loanIds?: string[]  // –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã
}
Response: {
  success: boolean
  transaction_id: string
  new_balance: number
}

// –û–ø–ª–∞—Ç–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂
POST /api/v1/loans/pay/adp
Body: {
  amount: number
  loanIds?: string[]
}
Response: {
  success: boolean
  transaction_id: string
  new_balance: number
  interest_saved: number
}
```

### –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è –∏ –≤–∫–ª–∞–¥—ã

```typescript
// –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â–∏–π –≤–∫–ª–∞–¥
GET /api/v1/deposits/current
Response: {
  id: string
  bank: string
  product: string
  rate: number
  balance: number
  capitalization: boolean
  withdrawable: boolean
  maturity_date: string
}

// –ü–æ–ª—É—á–∏—Ç—å —Å–≤–æ–¥–∫—É –ø–æ —Ü–µ–ª—è–º
GET /api/v1/goals/summary
Response: {
  total_saved: number
  daily_payment: number
  target: number
  target_date: string
}

// –ü–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è
POST /api/v1/deposits/pay/sdp
Body: {
  amount: number
  depositId: string
}
Response: {
  success: boolean
  transaction_id: string
  new_balance: number
  interest_earned: number
}
```

### –§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ

```typescript
// –ü–æ–ª—É—á–∏—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å —Ñ–∏–Ω–∑–¥–æ—Ä–æ–≤—å—è
GET /api/v1/health
Response: {
  score: number                    // 0-100
  status: '—Å–ø–æ–∫–æ–π–Ω–æ' | '–≤–Ω–∏–º–∞–Ω–∏–µ' | '–Ω—É–∂–µ–Ω –ø–ª–∞–Ω'
  reasons: string[]                // –ü—Ä–∏—á–∏–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è
  next_action: {
    type: 'refinance' | 'pay_mdp' | 'pay_sdp' | 'save_more'
    label: string
  } | null
  factors: Array<{
    name: string
    value: number
    weight: number
    impact: 'positive' | 'neutral' | 'negative'
  }>
}
```

### –¢–∞–π–º–ª–∞–π–Ω —Å–æ–±—ã—Ç–∏–π

```typescript
// –ü–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è –Ω–∞ N –¥–Ω–µ–π
GET /api/v1/timeline?days=30
Response: {
  events: Array<{
    date: string                    // ISO 8601
    type: 'loan_payment' | 'deposit_due' | 'reminder' | 'income'
    title: string
    amount: number
    can_defer: number               // –°—É–º–º–∞, –∫–æ—Ç–æ—Ä—É—é –º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å
    loan_id?: string
    deposit_id?: string
  }>
}

// –û—Ç–ª–æ–∂–∏—Ç—å —Å–æ–±—ã—Ç–∏–µ
POST /api/v1/timeline/defer
Body: {
  eventId: string
  deferDays: number
  deferAmount: number
}
Response: {
  success: boolean
  new_date: string
}
```

### –†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ

```typescript
// –ü–æ–ª—É—á–∏—Ç—å –æ—Ñ—Ñ–µ—Ä—ã —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏—è
GET /api/v1/refinance/offers?type=loans
Query params:
  - type: 'loans' | 'deposits'
  - loanIds: string[]              // –î–ª—è —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –∫—Ä–µ–¥–∏—Ç–æ–≤
Response: {
  offers: Array<{
    id: string
    bank: string
    rate: number
    term_months: number
    monthly_payment: number
    commission: number
    savings: number                 // –≠–∫–æ–Ω–æ–º–∏—è –∑–∞ –≤–µ—Å—å —Å—Ä–æ–∫
    breakeven_months: number        // –û–∫—É–ø–∞–µ–º–æ—Å—Ç—å –∫–æ–º–∏—Å—Å–∏–∏
    requirements: {
      min_credit_score?: number
      min_income?: number
      kyc_level: 'basic' | 'full'
    }
  }>
}

// –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ
POST /api/v1/refinance/apply
Body: {
  offerId: string
  loanIds: string[]                // –ö–∞–∫–∏–µ –∫—Ä–µ–¥–∏—Ç—ã —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞—Ç—å
  amount: number
}
Response: {
  applicationId: string
  status: 'pending' | 'docs_required' | 'approved' | 'declined'
  statusUrl: string                // URL –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
}

// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
GET /api/v1/refinance/applications/:id
Response: {
  status: 'pending' | 'docs_required' | 'approved' | 'declined'
  created_at: string
  updated_at: string
  bank: string
  amount: number
  next_steps?: string[]
  documents_required?: Array<{
    type: string
    description: string
  }>
}

// –ü–æ–ª—É—á–∏—Ç—å –æ—Ñ—Ñ–µ—Ä—ã –≤–∫–ª–∞–¥–æ–≤
GET /api/v1/deposits/offers
Response: {
  offers: Array<{
    id: string
    bank: string
    product: string
    rate: number
    ear: number                     // Effective Annual Rate
    term_months: number
    capitalization: string
    min_amount: number
    max_amount?: number
    withdrawable: boolean
    early_withdrawal_penalty?: number
    requirements: {
      kyc_level: 'basic' | 'full'
    }
  }>
}
```

### –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏

```typescript
// –ü–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
GET /api/v1/onboarding/strategy
Response: {
  strategy: '–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ' | '—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ' | '–±—ã—Å—Ç—Ä–æ'
  goal: '–∑–∞–∫—Ä—ã—Ç—å –∫—Ä–µ–¥–∏—Ç—ã' | '–Ω–∞–∫–æ–ø–∏—Ç—å'
  created_at: string
}

// –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏—é
PUT /api/v1/onboarding/strategy
Body: {
  strategy: '–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ' | '—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ' | '–±—ã—Å—Ç—Ä–æ'
}
Response: {
  success: boolean
  recalculated: {
    adp_new: number
    sdp_new: number
  }
}
```

## üîÑ Webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

Backend –º–æ–∂–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å webhook —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏:

```typescript
// Webhook payload
POST /client/webhook
Body: {
  type: 'balance_updated' | 'payment_completed' | 'application_status_changed'
  timestamp: string
  data: {
    // –ó–∞–≤–∏—Å–∏—Ç –æ—Ç —Ç–∏–ø–∞ —Å–æ–±—ã—Ç–∏—è
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏
window.addEventListener('creditguard:webhook', (event) => {
  const { type, data } = event.detail;
  
  if (type === 'balance_updated') {
    // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –∏ –ø–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å STS
    refreshBalances();
    recalculateSTS();
  }
  
  if (type === 'payment_completed') {
    // –ü–æ–∫–∞–∑–∞—Ç—å toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    toast.success('–ü–ª–∞—Ç—ë–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
  }
  
  if (type === 'application_status_changed') {
    // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏
    updateApplicationStatus(data.applicationId, data.status);
  }
});
```

## üîê –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Bearer token –¥–ª—è –≤—Å–µ—Ö –∑–∞–ø—Ä–æ—Å–æ–≤:

```typescript
const headers = {
  'Authorization': `Bearer ${accessToken}`,
  'Content-Type': 'application/json'
};
```

## ‚ö†Ô∏è –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

–í—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç –æ—à–∏–±–∫–∏ –≤ –µ–¥–∏–Ω–æ–º —Ñ–æ—Ä–º–∞—Ç–µ:

```typescript
Response (4xx, 5xx): {
  error: {
    code: string              // –ú–∞—à–∏–Ω–Ω–æ-—á–∏—Ç–∞–µ–º—ã–π –∫–æ–¥
    message: string           // –ß–µ–ª–æ–≤–µ–∫–æ-—á–∏—Ç–∞–µ–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
    details?: any            // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
  }
}

// –ü—Ä–∏–º–µ—Ä—ã –∫–æ–¥–æ–≤ –æ—à–∏–±–æ–∫
'INSUFFICIENT_BALANCE'        // –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤
'CONSENT_REQUIRED'           // –¢—Ä–µ–±—É–µ—Ç—Å—è —Å–æ–≥–ª–∞—Å–∏–µ –±–∞–Ω–∫–∞
'INVALID_AMOUNT'             // –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—É–º–º–∞
'LOAN_NOT_FOUND'             // –ö—Ä–µ–¥–∏—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω
'APPLICATION_ALREADY_EXISTS' // –ó–∞—è–≤–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
'BANK_API_ERROR'             // –û—à–∏–±–∫–∞ API –±–∞–Ω–∫–∞
'RATE_LIMIT_EXCEEDED'        // –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤
```

## üéØ Action Hooks –¥–ª—è UI

–í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è data-–∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è —Å–≤—è–∑–∏ —Å API:

```typescript
// –í HomeScreen.tsx
const handlePayMDP = async () => {
  try {
    const response = await fetch('/api/v1/loans/pay/mdp', {
      method: 'POST',
      headers,
      body: JSON.stringify({
        amount: appState.loans.summary.mandatory_daily_payment
      })
    });
    
    if (response.ok) {
      const data = await response.json();
      
      // –û–±–Ω–æ–≤–∏—Ç—å state
      setAppState(prev => ({
        ...prev,
        loans: {
          ...prev.loans,
          summary: {
            ...prev.loans.summary,
            total_outstanding: data.new_balance
          }
        }
      }));
      
      // –ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å STS
      await recalculateSTS('payment', amount);
      
      toast.success('–ü–ª–∞—Ç—ë–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ');
    }
  } catch (error) {
    toast.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –ø–ª–∞—Ç–µ–∂–∞');
  }
};
```

## üìä Polling –∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

–î–ª—è –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Ç—Ä–µ–±—É–µ—Ç—Å—è polling —Å—Ç–∞—Ç—É—Å–∞:

```typescript
// Polling —Å—Ç–∞—Ç—É—Å–∞ –∑–∞—è–≤–∫–∏
const pollApplicationStatus = async (applicationId: string) => {
  const maxAttempts = 30;
  let attempts = 0;
  
  const poll = async () => {
    if (attempts >= maxAttempts) {
      throw new Error('Timeout waiting for application status');
    }
    
    const response = await fetch(`/api/v1/refinance/applications/${applicationId}`, {
      headers
    });
    
    const data = await response.json();
    
    if (data.status === 'pending') {
      attempts++;
      setTimeout(poll, 2000);  // –û–ø—Ä–∞—à–∏–≤–∞–µ–º –∫–∞–∂–¥—ã–µ 2 —Å–µ–∫—É–Ω–¥—ã
    } else {
      // –°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–∏–ª—Å—è
      return data;
    }
  };
  
  return poll();
};
```

## üß™ Mock —Ä–µ–∂–∏–º –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

–î–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–≥–æ backend –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ñ–∞–π–ª—ã mock-–¥–∞–Ω–Ω—ã—Ö:

```typescript
// –í App.tsx
const USE_MOCK_DATA = process.env.REACT_APP_USE_MOCK === 'true';

const fetchBalances = async () => {
  if (USE_MOCK_DATA) {
    return mockAppState.balances;
  }
  
  const response = await fetch('/api/v1/balances', { headers });
  return response.json();
};
```

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Open Banking

–î–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–∞–Ω–∫–æ–≤ —á–µ—Ä–µ–∑ Open Banking API:

1. –ü–æ–ª—É—á–∏—Ç—å consent URL –æ—Ç backend
2. –†–µ–¥–∏—Ä–µ–∫—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–∞–Ω–∫–∞
3. –ü–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –±–∞–Ω–∫ —Ä–µ–¥–∏—Ä–µ–∫—Ç–∏—Ç –æ–±—Ä–∞—Ç–Ω–æ —Å –∫–æ–¥–æ–º
4. Backend –æ–±–º–µ–Ω–∏–≤–∞–µ—Ç –∫–æ–¥ –Ω–∞ access token
5. Backend –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ

```typescript
// –ò–Ω–∏—Ü–∏–∞—Ü–∏—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±–∞–Ω–∫–∞
const connectBank = async (bankId: string) => {
  const response = await fetch('/api/v1/user/consents', {
    method: 'POST',
    headers,
    body: JSON.stringify({
      bankId,
      redirectUrl: `${window.location.origin}/callback`
    })
  });
  
  const { consentUrl } = await response.json();
  
  // –†–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –±–∞–Ω–∫–∞
  window.location.href = consentUrl;
};

// Callback –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
// /callback?code=xxx&state=yyy
const handleCallback = async () => {
  const params = new URLSearchParams(window.location.search);
  const code = params.get('code');
  
  if (code) {
    // Backend –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ–¥ –∏ —Å–æ–∑–¥–∞—Å—Ç —Å–æ–≥–ª–∞—Å–∏–µ
    // –ü—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–æ–≥–ª–∞—Å–∏–π
    await refreshConsents();
  }
};
```

## üì± Push —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è

–î–ª—è push-—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ FCM/APNs:

```typescript
// –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Ç–æ–∫–µ–Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
POST /api/v1/notifications/register
Body: {
  token: string
  platform: 'ios' | 'android' | 'web'
}

// –¢–∏–ø—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- payment_due           // –ü—Ä–∏–±–ª–∏–∂–∞–µ—Ç—Å—è —Å—Ä–æ–∫ –ø–ª–∞—Ç–µ–∂–∞
- payment_completed     // –ü–ª–∞—Ç—ë–∂ –≤—ã–ø–æ–ª–Ω–µ–Ω
- application_approved  // –ó–∞—è–≤–∫–∞ –æ–¥–æ–±—Ä–µ–Ω–∞
- balance_low          // –ù–∏–∑–∫–∏–π –±–∞–ª–∞–Ω—Å STS
- refinance_opportunity // –ü–æ—è–≤–∏–ª–∞—Å—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å —Ä–µ—Ñ–∏–Ω–∞–Ω—Å–∞
```

## üé® Best Practices

1. **–û–ø—Ç–∏–º–∏—Å—Ç–∏—á–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è** - –æ–±–Ω–æ–≤–ª—è–π—Ç–µ UI —Å—Ä–∞–∑—É, –æ—Ç–∫–∞—Ç—ã–≤–∞–π—Ç–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
2. **–ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ** - –∫–µ—à–∏—Ä—É–π—Ç–µ –¥–∞–Ω–Ω—ã–µ –ª–æ–∫–∞–ª—å–Ω–æ, —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–π—Ç–µ —Ñ–æ–Ω–æ–º
3. **Retry –º–µ—Ö–∞–Ω–∏–∑–º—ã** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è–π—Ç–µ –Ω–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã
4. **Offline —Ä–µ–∂–∏–º** - –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ñ–ª–∞–π–Ω
5. **Loading states** - –≤—Å–µ–≥–¥–∞ –ø–æ–∫–∞–∑—ã–≤–∞–π—Ç–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
6. **Error handling** - –ø–æ–Ω—è—Ç–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é

## üìö –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ä–µ—Å—É—Ä—Å—ã

- [Open Banking API Documentation](https://www.openbanking.org.uk/)
- [PSD2 Compliance Guide](https://ec.europa.eu/info/law/payment-services-psd-2-directive-eu-2015-2366_en)
- [API Security Best Practices](https://owasp.org/www-project-api-security/)
</file>

<file path="Figma_Front/src/App.tsx">
import { useState } from 'react';
import { SplashScreen } from './screens/SplashScreen';
import { OnboardingScreen, OnboardingData } from './screens/OnboardingScreen';
import { LoadingCalcScreen } from './screens/LoadingCalcScreen';
import { HomeScreen } from './screens/HomeScreen';
import { STSDetailScreen } from './screens/STSDetailScreen';
import { LoansDetailScreen } from './screens/LoansDetailScreen';
import { DepositsDetailScreen } from './screens/DepositsDetailScreen';
import { RefinanceScreen } from './screens/RefinanceScreen';
import { CardsScreen } from './screens/CardsScreen';
import { BottomNav } from './components/BottomNav';
import { PaymentSheet } from './components/PaymentSheet';
import { type AppState } from './data/mockAppState';
import { Toaster, toast } from 'sonner@2.0.3';

type AppFlow = 'splash' | 'onboarding' | 'loading' | 'app';
type Screen = 'home' | 'sts' | 'loans' | 'deposits' | 'refinance' | 'cards' | 'profile' | 'health';
type PaymentType = 'mdp' | 'adp' | 'sdp' | null;

export default function App() {
  const [flow, setFlow] = useState<AppFlow>('splash');
  const [onboardingData, setOnboardingData] = useState<OnboardingData | null>(null);
  const [appState, setAppState] = useState<AppState | null>(null);
  const [currentScreen, setCurrentScreen] = useState<Screen>('home');
  const [paymentType, setPaymentType] = useState<PaymentType>(null);

  // Flow handlers
  const handleSplashComplete = () => {
    setFlow('onboarding');
  };

  const handleOnboardingComplete = (data: OnboardingData) => {
    setOnboardingData(data);
    setFlow('loading');
  };

  const handleLoadingComplete = (state: AppState) => {
    setAppState(state);
    setFlow('app');
  };

  // Navigation handlers
  const handleNavigate = (screen: string) => {
    setCurrentScreen(screen as Screen);
  };

  const handlePayment = (type: 'mdp' | 'adp' | 'sdp') => {
    setPaymentType(type);
  };

  const handlePaymentConfirm = (amount: number) => {
    if (!appState) return;

    // Simulate payment processing
    setPaymentType(null);
    
    // Recalculate STS and balances
    setAppState((prev) => {
      if (!prev) return prev;
      const newState = { ...prev };
      
      if (paymentType === 'mdp' || paymentType === 'adp') {
        // Update loans
        newState.loans.summary.total_outstanding -= amount;
        // Increase STS
        newState.sts.today.amount += amount * 0.1;
      } else if (paymentType === 'sdp') {
        // Update deposits
        newState.goals.summary.total_saved += amount;
        if (newState.deposits.current) {
          newState.deposits.current.balance += amount;
        }
        // Decrease STS
        newState.sts.today.amount -= amount;
      }
      
      return newState;
    });
    
    toast.success('–ü–ª–∞—Ç—ë–∂ —É—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω', {
      description: `STS –ø–µ—Ä–µ—Å—á–∏—Ç–∞–Ω —Å —É—á—ë—Ç–æ–º –Ω–æ–≤–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞`,
    });
  };

  const getDefaultPaymentAmount = () => {
    if (!appState) return 0;
    if (paymentType === 'mdp') return 1200;
    if (paymentType === 'adp') return 540;
    if (paymentType === 'sdp') return appState.goals.summary.daily_payment;
    return 0;
  };

  // Render splash screen
  if (flow === 'splash') {
    return <SplashScreen onComplete={handleSplashComplete} />;
  }

  // Render onboarding
  if (flow === 'onboarding') {
    return <OnboardingScreen onComplete={handleOnboardingComplete} />;
  }

  // Render loading/calculation screen
  if (flow === 'loading' && onboardingData) {
    return (
      <LoadingCalcScreen
        onboardingData={onboardingData}
        onComplete={handleLoadingComplete}
      />
    );
  }

  // Main app - require appState
  if (!appState) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="text-center">
          <p className="text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞...</p>
        </div>
      </div>
    );
  }

  // Profile screen
  if (currentScreen === 'profile') {
    return (
      <div className="min-h-screen bg-gray-50 pb-20">
        <div className="max-w-lg mx-auto">
          <div className="bg-white border-b border-gray-200 px-4 py-4">
            <h1 className="text-xl font-semibold text-gray-900">–ü—Ä–æ—Ñ–∏–ª—å</h1>
          </div>
          <div className="p-4">
            <div className="bg-white rounded-2xl p-8 text-center border border-gray-200">
              <div className="w-20 h-20 bg-purple-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <svg className="w-10 h-10 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                </svg>
              </div>
              <h2 className="text-xl font-semibold text-gray-900 mb-2">{appState.user.name}</h2>
              <p className="text-sm text-gray-600 mb-6">{appState.user.id}</p>
              
              <div className="space-y-3 text-left">
                <button className="w-full p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-left">
                  <div className="font-medium text-gray-900">–ù–∞—Å—Ç—Ä–æ–π–∫–∏</div>
                  <div className="text-xs text-gray-500 mt-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–æ–º</div>
                </button>
                <button className="w-full p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-left">
                  <div className="font-medium text-gray-900">–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ –±–∞–Ω–∫–∏</div>
                  <div className="text-xs text-gray-500 mt-1">{Object.keys(appState.user.consents).length} –±–∞–Ω–∫–æ–≤</div>
                </button>
                <button className="w-full p-4 bg-gray-50 rounded-xl hover:bg-gray-100 transition-colors text-left">
                  <div className="font-medium text-gray-900">–°—Ç—Ä–∞—Ç–µ–≥–∏—è</div>
                  <div className="text-xs text-gray-500 mt-1">{appState.onboarding.strategy}</div>
                </button>
              </div>
            </div>
          </div>
        </div>
        <BottomNav currentScreen={currentScreen} onNavigate={handleNavigate} mode={appState.mode} />
      </div>
    );
  }

  // Health detail screen
  if (currentScreen === 'health') {
    return (
      <div className="min-h-screen bg-gray-50 pb-20">
        <div className="max-w-lg mx-auto">
          <div className="sticky top-0 bg-white border-b border-gray-200 z-10 px-4 py-4">
            <div className="flex items-center gap-3">
              <button
                onClick={() => handleNavigate('home')}
                className="p-2 -ml-2 hover:bg-gray-100 rounded-lg transition-colors"
              >
                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" />
                </svg>
              </button>
              <h1 className="text-xl font-semibold text-gray-900">–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ</h1>
            </div>
          </div>
          <div className="p-4 space-y-6">
            <div className="bg-white rounded-2xl p-6 text-center border border-gray-200">
              <div className="text-sm text-gray-500 mb-3">–í–∞—à –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å</div>
              <div className="text-5xl font-semibold text-purple-600 mb-4">
                {appState.health.score}
              </div>
              <div className="inline-flex items-center gap-2 px-4 py-2 rounded-full bg-purple-50">
                <span className="text-sm font-medium text-purple-700">{appState.health.status}</span>
              </div>
            </div>

            <div className="bg-white rounded-2xl p-5 border border-gray-200">
              <h2 className="font-semibold text-gray-900 mb-3">–ü—Ä–∏—á–∏–Ω—ã –∏–∑–º–µ–Ω–µ–Ω–∏—è</h2>
              <div className="space-y-2">
                {appState.health.reasons.map((reason, idx) => (
                  <div key={idx} className="flex items-start gap-2 text-sm text-gray-700">
                    <div className="w-1.5 h-1.5 bg-purple-500 rounded-full mt-2" />
                    <span>{reason}</span>
                  </div>
                ))}
              </div>
            </div>

            {appState.health.next_action && (
              <div className="bg-purple-50 rounded-2xl p-5 border border-purple-200/50">
                <div className="font-semibold text-gray-900 mb-2">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–æ–µ –¥–µ–π—Å—Ç–≤–∏–µ</div>
                <div className="text-sm text-gray-700 mb-4">{appState.health.next_action.label}</div>
                <button
                  onClick={() => {
                    if (appState.health.next_action?.type === 'refinance') {
                      handleNavigate('refinance');
                    } else if (appState.health.next_action?.type.startsWith('pay_')) {
                      const type = appState.health.next_action.type.replace('pay_', '') as 'mdp' | 'adp' | 'sdp';
                      handlePayment(type);
                    }
                  }}
                  className="w-full py-3 bg-purple-600 text-white rounded-xl font-medium hover:bg-purple-700 transition-colors"
                >
                  –í—ã–ø–æ–ª–Ω–∏—Ç—å
                </button>
              </div>
            )}
          </div>
        </div>
        <BottomNav currentScreen={currentScreen} onNavigate={handleNavigate} mode={appState.mode} />
      </div>
    );
  }

  // Main app screens
  return (
    <>
      {currentScreen === 'home' && (
        <HomeScreen
          appState={appState}
          onNavigate={handleNavigate}
          onPayment={handlePayment}
        />
      )}
      
      {currentScreen === 'sts' && (
        <STSDetailScreen
          appState={appState}
          onBack={() => handleNavigate('home')}
          onPayment={handlePayment}
        />
      )}
      
      {currentScreen === 'loans' && (
        <LoansDetailScreen
          appState={appState}
          onBack={() => handleNavigate('home')}
          onPayment={handlePayment}
        />
      )}
      
      {currentScreen === 'deposits' && (
        <DepositsDetailScreen
          appState={appState}
          onBack={() => handleNavigate('home')}
          onPayment={handlePayment}
          onNavigate={handleNavigate}
        />
      )}
      
      {currentScreen === 'refinance' && (
        <RefinanceScreen
          appState={appState}
          onBack={() => handleNavigate('home')}
        />
      )}
      
      {currentScreen === 'cards' && (
        <CardsScreen
          appState={appState}
          onBack={() => handleNavigate('home')}
        />
      )}

      {/* Bottom Navigation */}
      {['home', 'sts', 'loans', 'deposits', 'refinance', 'profile'].includes(currentScreen) && (
        <BottomNav
          currentScreen={currentScreen}
          onNavigate={handleNavigate}
          mode={appState.mode}
        />
      )}

      {/* Payment Sheet Modal */}
      {paymentType && (
        <PaymentSheet
          type={paymentType}
          defaultAmount={getDefaultPaymentAmount()}
          currentSTS={1700}
          onClose={() => setPaymentType(null)}
          onConfirm={handlePaymentConfirm}
        />
      )}

      {/* Toast notifications */}
      <Toaster position="top-center" richColors />
    </>
  );
}
</file>

<file path="Figma_Front/src/Attributions.md">
This Figma Make file includes components from [shadcn/ui](https://ui.shadcn.com/) used under [MIT license](https://github.com/shadcn-ui/ui/blob/main/LICENSE.md).

This Figma Make file includes photos from [Unsplash](https://unsplash.com) used under [license](https://unsplash.com/license).
</file>

<file path="Figma_Front/src/index.css">
/*! tailwindcss v4.1.3 | MIT License | https://tailwindcss.com */
@layer properties {
  @supports (((-webkit-hyphens: none)) and (not (margin-trim: inline))) or ((-moz-orient: inline) and (not (color: rgb(from red r g b)))) {
    *, :before, :after, ::backdrop {
      --tw-translate-x: 0;
      --tw-translate-y: 0;
      --tw-translate-z: 0;
      --tw-space-y-reverse: 0;
      --tw-border-style: solid;
      --tw-gradient-position: initial;
      --tw-gradient-from: #0000;
      --tw-gradient-via: #0000;
      --tw-gradient-to: #0000;
      --tw-gradient-stops: initial;
      --tw-gradient-via-stops: initial;
      --tw-gradient-from-position: 0%;
      --tw-gradient-via-position: 50%;
      --tw-gradient-to-position: 100%;
      --tw-leading: initial;
      --tw-font-weight: initial;
      --tw-tracking: initial;
      --tw-shadow: 0 0 #0000;
      --tw-shadow-color: initial;
      --tw-shadow-alpha: 100%;
      --tw-inset-shadow: 0 0 #0000;
      --tw-inset-shadow-color: initial;
      --tw-inset-shadow-alpha: 100%;
      --tw-ring-color: initial;
      --tw-ring-shadow: 0 0 #0000;
      --tw-inset-ring-color: initial;
      --tw-inset-ring-shadow: 0 0 #0000;
      --tw-ring-inset: initial;
      --tw-ring-offset-width: 0px;
      --tw-ring-offset-color: #fff;
      --tw-ring-offset-shadow: 0 0 #0000;
      --tw-outline-style: solid;
      --tw-blur: initial;
      --tw-brightness: initial;
      --tw-contrast: initial;
      --tw-grayscale: initial;
      --tw-hue-rotate: initial;
      --tw-invert: initial;
      --tw-opacity: initial;
      --tw-saturate: initial;
      --tw-sepia: initial;
      --tw-drop-shadow: initial;
      --tw-drop-shadow-color: initial;
      --tw-drop-shadow-alpha: 100%;
      --tw-drop-shadow-size: initial;
      --tw-backdrop-blur: initial;
      --tw-backdrop-brightness: initial;
      --tw-backdrop-contrast: initial;
      --tw-backdrop-grayscale: initial;
      --tw-backdrop-hue-rotate: initial;
      --tw-backdrop-invert: initial;
      --tw-backdrop-opacity: initial;
      --tw-backdrop-saturate: initial;
      --tw-backdrop-sepia: initial;
      --tw-duration: initial;
      --tw-ease: initial;
    }
  }
}

@layer theme {
  :root, :host {
    --font-sans: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji";
    --font-mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    --color-red-50: oklch(.971 .013 17.38);
    --color-red-100: oklch(.936 .032 17.717);
    --color-red-500: oklch(.637 .237 25.331);
    --color-red-600: oklch(.577 .245 27.325);
    --color-red-700: oklch(.505 .213 27.518);
    --color-orange-50: oklch(.98 .016 73.684);
    --color-orange-600: oklch(.646 .222 41.116);
    --color-orange-700: oklch(.553 .195 38.402);
    --color-yellow-500: oklch(.795 .184 86.047);
    --color-yellow-600: oklch(.681 .162 75.834);
    --color-green-50: oklch(.982 .018 155.826);
    --color-green-100: oklch(.962 .044 156.743);
    --color-green-200: oklch(.925 .084 155.995);
    --color-green-500: oklch(.723 .219 149.579);
    --color-green-600: oklch(.627 .194 149.214);
    --color-green-700: oklch(.527 .154 150.069);
    --color-green-900: oklch(.393 .095 152.535);
    --color-emerald-50: oklch(.979 .021 166.113);
    --color-blue-50: oklch(.97 .014 254.604);
    --color-blue-500: oklch(.623 .214 259.815);
    --color-blue-600: oklch(.546 .245 262.881);
    --color-blue-700: oklch(.488 .243 264.376);
    --color-purple-50: oklch(.977 .014 308.299);
    --color-purple-100: oklch(.946 .033 307.174);
    --color-purple-200: oklch(.902 .063 306.703);
    --color-purple-400: oklch(.714 .203 305.504);
    --color-purple-500: oklch(.627 .265 303.9);
    --color-purple-600: oklch(.558 .288 302.321);
    --color-purple-700: oklch(.496 .265 301.924);
    --color-purple-800: oklch(.438 .218 303.724);
    --color-purple-900: oklch(.381 .176 304.987);
    --color-gray-50: oklch(.985 .002 247.839);
    --color-gray-100: oklch(.967 .003 264.542);
    --color-gray-200: oklch(.928 .006 264.531);
    --color-gray-300: oklch(.872 .01 258.338);
    --color-gray-400: oklch(.707 .022 261.325);
    --color-gray-500: oklch(.551 .027 264.364);
    --color-gray-600: oklch(.446 .03 256.802);
    --color-gray-700: oklch(.373 .034 259.733);
    --color-gray-900: oklch(.21 .034 264.665);
    --color-black: #000;
    --color-white: #fff;
    --spacing: .25rem;
    --container-md: 28rem;
    --container-lg: 32rem;
    --container-2xl: 42rem;
    --container-3xl: 48rem;
    --container-4xl: 56rem;
    --text-xs: .75rem;
    --text-xs--line-height: calc(1 / .75);
    --text-sm: .875rem;
    --text-sm--line-height: calc(1.25 / .875);
    --text-base: 1rem;
    --text-base--line-height: calc(1.5 / 1);
    --text-lg: 1.125rem;
    --text-lg--line-height: calc(1.75 / 1.125);
    --text-xl: 1.25rem;
    --text-xl--line-height: calc(1.75 / 1.25);
    --text-2xl: 1.5rem;
    --text-2xl--line-height: calc(2 / 1.5);
    --text-3xl: 1.875rem;
    --text-3xl--line-height: calc(2.25 / 1.875);
    --text-4xl: 2.25rem;
    --text-4xl--line-height: calc(2.5 / 2.25);
    --text-5xl: 3rem;
    --text-5xl--line-height: 1;
    --font-weight-medium: 500;
    --font-weight-semibold: 600;
    --tracking-wider: .05em;
    --radius-2xl: 1rem;
    --radius-3xl: 1.5rem;
    --shadow-md: 0 4px 6px -1px #0000001a, 0 2px 4px -2px #0000001a;
    --shadow-lg: 0 10px 15px -3px #0000001a, 0 4px 6px -4px #0000001a;
    --ease-out: cubic-bezier(0, 0, .2, 1);
    --ease-in-out: cubic-bezier(.4, 0, .2, 1);
    --animate-spin: spin 1s linear infinite;
    --animate-pulse: pulse 2s cubic-bezier(.4, 0, .6, 1) infinite;
    --blur-sm: 8px;
    --default-transition-duration: .15s;
    --default-transition-timing-function: cubic-bezier(.4, 0, .2, 1);
    --default-font-family: var(--font-sans);
    --default-font-feature-settings: var(--font-sans--font-feature-settings);
    --default-font-variation-settings: var(--font-sans--font-variation-settings);
    --default-mono-font-family: var(--font-mono);
    --default-mono-font-feature-settings: var(--font-mono--font-feature-settings);
    --default-mono-font-variation-settings: var(--font-mono--font-variation-settings);
  }

  :root {
    --color-brand-primary: #7c3aed;
    --color-brand-primary-hover: #6d28d9;
    --color-brand-primary-light: #a78bfa;
    --color-text-primary: #0f172a;
    --color-text-secondary: #64748b;
    --color-text-tertiary: #94a3b8;
    --color-text-inverse: #fff;
    --color-bg-default: #f9fafb;
    --color-bg-secondary: #f3f4f6;
    --color-bg-surface: #fff;
    --color-surface-panel: #fff;
    --color-stroke-divider: #e5e7eb;
    --color-stroke-input: #d1d5db;
    --color-success: #10b981;
    --color-success-light: #d1fae5;
    --color-info: #3b82f6;
    --color-info-light: #dbeafe;
    --color-accent-primary: #7c3aed;
    --color-accent-light: #ede9fe;
    --color-calm: #10b981;
    --color-calm-light: #d1fae5;
    --color-attention: #f59e0b;
    --color-attention-light: #fef3c7;
    --color-plan-needed: #8b5cf6;
    --color-plan-needed-light: #ede9fe;
    --color-error: #dc2626;
    --color-error-light: #fee2e2;
    --color-warning: #f59e0b;
    --color-warning-light: #fef3c7;
    --shadow-sm: 0 1px 2px 0 #0000000d;
    --shadow-md: 0 4px 6px -1px #0000001a;
    --shadow-lg: 0 10px 15px -3px #0000001a;
    --shadow-xl: 0 20px 25px -5px #0000001a;
  }

  [data-theme="dark"] {
    --color-text-primary: #f1f5f9;
    --color-text-secondary: #94a3b8;
    --color-text-tertiary: #64748b;
    --color-text-inverse: #0f172a;
    --color-bg-default: #0f172a;
    --color-bg-secondary: #1e293b;
    --color-bg-surface: #1e293b;
    --color-surface-panel: #1e293b;
    --color-stroke-divider: #334155;
    --color-stroke-input: #475569;
  }
}

@layer base {
  *, :after, :before, ::backdrop {
    box-sizing: border-box;
    border: 0 solid;
    margin: 0;
    padding: 0;
  }

  ::file-selector-button {
    box-sizing: border-box;
    border: 0 solid;
    margin: 0;
    padding: 0;
  }

  html, :host {
    -webkit-text-size-adjust: 100%;
    tab-size: 4;
    line-height: 1.5;
    font-family: var(--default-font-family, ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji");
    font-feature-settings: var(--default-font-feature-settings, normal);
    font-variation-settings: var(--default-font-variation-settings, normal);
    -webkit-tap-highlight-color: transparent;
  }

  body {
    line-height: inherit;
  }

  hr {
    height: 0;
    color: inherit;
    border-top-width: 1px;
  }

  abbr:where([title]) {
    -webkit-text-decoration: underline dotted;
    text-decoration: underline dotted;
  }

  h1, h2, h3, h4, h5, h6 {
    font-size: inherit;
    font-weight: inherit;
  }

  a {
    color: inherit;
    -webkit-text-decoration: inherit;
    -webkit-text-decoration: inherit;
    text-decoration: inherit;
  }

  b, strong {
    font-weight: bolder;
  }

  code, kbd, samp, pre {
    font-family: var(--default-mono-font-family, ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace);
    font-feature-settings: var(--default-mono-font-feature-settings, normal);
    font-variation-settings: var(--default-mono-font-variation-settings, normal);
    font-size: 1em;
  }

  small {
    font-size: 80%;
  }

  sub, sup {
    vertical-align: baseline;
    font-size: 75%;
    line-height: 0;
    position: relative;
  }

  sub {
    bottom: -.25em;
  }

  sup {
    top: -.5em;
  }

  table {
    text-indent: 0;
    border-color: inherit;
    border-collapse: collapse;
  }

  :-moz-focusring {
    outline: auto;
  }

  progress {
    vertical-align: baseline;
  }

  summary {
    display: list-item;
  }

  ol, ul, menu {
    list-style: none;
  }

  img, svg, video, canvas, audio, iframe, embed, object {
    vertical-align: middle;
    display: block;
  }

  img, video {
    max-width: 100%;
    height: auto;
  }

  button, input, select, optgroup, textarea {
    font: inherit;
    font-feature-settings: inherit;
    font-variation-settings: inherit;
    letter-spacing: inherit;
    color: inherit;
    opacity: 1;
    background-color: #0000;
    border-radius: 0;
  }

  ::file-selector-button {
    font: inherit;
    font-feature-settings: inherit;
    font-variation-settings: inherit;
    letter-spacing: inherit;
    color: inherit;
    opacity: 1;
    background-color: #0000;
    border-radius: 0;
  }

  :where(select:is([multiple], [size])) optgroup {
    font-weight: bolder;
  }

  :where(select:is([multiple], [size])) optgroup option {
    padding-inline-start: 20px;
  }

  ::file-selector-button {
    margin-inline-end: 4px;
  }

  ::placeholder {
    opacity: 1;
    color: currentColor;
  }

  @supports (color: color-mix(in lab, red, red)) {
    ::placeholder {
      color: color-mix(in oklab, currentColor 50%, transparent);
    }
  }

  textarea {
    resize: vertical;
  }

  ::-webkit-search-decoration {
    -webkit-appearance: none;
  }

  ::-webkit-date-and-time-value {
    min-height: 1lh;
    text-align: inherit;
  }

  ::-webkit-datetime-edit {
    display: inline-flex;
  }

  ::-webkit-datetime-edit-fields-wrapper {
    padding: 0;
  }

  ::-webkit-datetime-edit {
    padding-block: 0;
  }

  ::-webkit-datetime-edit-year-field {
    padding-block: 0;
  }

  ::-webkit-datetime-edit-month-field {
    padding-block: 0;
  }

  ::-webkit-datetime-edit-day-field {
    padding-block: 0;
  }

  ::-webkit-datetime-edit-hour-field {
    padding-block: 0;
  }

  ::-webkit-datetime-edit-minute-field {
    padding-block: 0;
  }

  ::-webkit-datetime-edit-second-field {
    padding-block: 0;
  }

  ::-webkit-datetime-edit-millisecond-field {
    padding-block: 0;
  }

  ::-webkit-datetime-edit-meridiem-field {
    padding-block: 0;
  }

  :-moz-ui-invalid {
    box-shadow: none;
  }

  button, input:where([type="button"], [type="reset"], [type="submit"]) {
    appearance: button;
  }

  ::file-selector-button {
    appearance: button;
  }

  ::-webkit-inner-spin-button {
    height: auto;
  }

  ::-webkit-outer-spin-button {
    height: auto;
  }

  [hidden]:where(:not([hidden="until-found"])) {
    display: none !important;
  }

  * {
    border-color: oklch(.922 0 0);
    outline-color: color-mix(in oklab, oklch(.708 0 0) 50%, transparent);
  }

  body {
    background-color: oklch(1 0 0);
    color: oklch(.145 0 0);
  }

  * {
    border-color: var(--color-stroke-divider);
  }

  body {
    background-color: var(--color-bg-default);
    color: var(--color-text-primary);
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    transition-property: color, background-color, border-color, outline-color, text-decoration-color, fill, stroke, --tw-gradient-from, --tw-gradient-via, --tw-gradient-to;
    transition-timing-function: var(--tw-ease, var(--default-transition-timing-function));
    transition-duration: var(--tw-duration, var(--default-transition-duration));
    --tw-duration: .2s;
    font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    transition-duration: .2s;
  }

  h1 {
    font-size: 24px;
    line-height: 32px;
  }

  h2 {
    font-size: 20px;
    line-height: 28px;
  }

  p {
    font-size: 16px;
    line-height: 24px;
  }

  button {
    font-size: 14px;
    line-height: 16px;
  }

  .caption {
    font-size: 12px;
    line-height: 16px;
  }
}

@layer utilities {
  .absolute {
    position: absolute;
  }

  .fixed {
    position: fixed;
  }

  .relative {
    position: relative;
  }

  .sticky {
    position: sticky;
  }

  .inset-0 {
    inset: calc(var(--spacing) * 0);
  }

  .top-0 {
    top: calc(var(--spacing) * 0);
  }

  .top-1\/2 {
    top: 50%;
  }

  .right-0 {
    right: calc(var(--spacing) * 0);
  }

  .right-4 {
    right: calc(var(--spacing) * 4);
  }

  .right-6 {
    right: calc(var(--spacing) * 6);
  }

  .bottom-0 {
    bottom: calc(var(--spacing) * 0);
  }

  .left-0 {
    left: calc(var(--spacing) * 0);
  }

  .z-10 {
    z-index: 10;
  }

  .z-50 {
    z-index: 50;
  }

  .mx-auto {
    margin-inline: auto;
  }

  .mt-0\.5 {
    margin-top: calc(var(--spacing) * .5);
  }

  .mt-1 {
    margin-top: calc(var(--spacing) * 1);
  }

  .mt-2 {
    margin-top: calc(var(--spacing) * 2);
  }

  .mt-3 {
    margin-top: calc(var(--spacing) * 3);
  }

  .mt-4 {
    margin-top: calc(var(--spacing) * 4);
  }

  .mt-6 {
    margin-top: calc(var(--spacing) * 6);
  }

  .mt-8 {
    margin-top: calc(var(--spacing) * 8);
  }

  .mb-0\.5 {
    margin-bottom: calc(var(--spacing) * .5);
  }

  .mb-1 {
    margin-bottom: calc(var(--spacing) * 1);
  }

  .mb-2 {
    margin-bottom: calc(var(--spacing) * 2);
  }

  .mb-3 {
    margin-bottom: calc(var(--spacing) * 3);
  }

  .mb-4 {
    margin-bottom: calc(var(--spacing) * 4);
  }

  .mb-6 {
    margin-bottom: calc(var(--spacing) * 6);
  }

  .mb-8 {
    margin-bottom: calc(var(--spacing) * 8);
  }

  .-ml-2 {
    margin-left: calc(var(--spacing) * -2);
  }

  .block {
    display: block;
  }

  .flex {
    display: flex;
  }

  .grid {
    display: grid;
  }

  .hidden {
    display: none;
  }

  .inline-flex {
    display: inline-flex;
  }

  .size-3\.5 {
    width: calc(var(--spacing) * 3.5);
    height: calc(var(--spacing) * 3.5);
  }

  .size-4 {
    width: calc(var(--spacing) * 4);
    height: calc(var(--spacing) * 4);
  }

  .size-9 {
    width: calc(var(--spacing) * 9);
    height: calc(var(--spacing) * 9);
  }

  .h-1 {
    height: calc(var(--spacing) * 1);
  }

  .h-1\.5 {
    height: calc(var(--spacing) * 1.5);
  }

  .h-2 {
    height: calc(var(--spacing) * 2);
  }

  .h-3 {
    height: calc(var(--spacing) * 3);
  }

  .h-3\.5 {
    height: calc(var(--spacing) * 3.5);
  }

  .h-4 {
    height: calc(var(--spacing) * 4);
  }

  .h-5 {
    height: calc(var(--spacing) * 5);
  }

  .h-6 {
    height: calc(var(--spacing) * 6);
  }

  .h-8 {
    height: calc(var(--spacing) * 8);
  }

  .h-9 {
    height: calc(var(--spacing) * 9);
  }

  .h-10 {
    height: calc(var(--spacing) * 10);
  }

  .h-12 {
    height: calc(var(--spacing) * 12);
  }

  .h-14 {
    height: calc(var(--spacing) * 14);
  }

  .h-16 {
    height: calc(var(--spacing) * 16);
  }

  .h-20 {
    height: calc(var(--spacing) * 20);
  }

  .h-24 {
    height: calc(var(--spacing) * 24);
  }

  .h-full {
    height: 100%;
  }

  .min-h-screen {
    min-height: 100vh;
  }

  .w-1\.5 {
    width: calc(var(--spacing) * 1.5);
  }

  .w-2 {
    width: calc(var(--spacing) * 2);
  }

  .w-3 {
    width: calc(var(--spacing) * 3);
  }

  .w-3\.5 {
    width: calc(var(--spacing) * 3.5);
  }

  .w-4 {
    width: calc(var(--spacing) * 4);
  }

  .w-4\/6 {
    width: 66.6667%;
  }

  .w-5 {
    width: calc(var(--spacing) * 5);
  }

  .w-5\/6 {
    width: 83.3333%;
  }

  .w-8 {
    width: calc(var(--spacing) * 8);
  }

  .w-10 {
    width: calc(var(--spacing) * 10);
  }

  .w-12 {
    width: calc(var(--spacing) * 12);
  }

  .w-16 {
    width: calc(var(--spacing) * 16);
  }

  .w-20 {
    width: calc(var(--spacing) * 20);
  }

  .w-24 {
    width: calc(var(--spacing) * 24);
  }

  .w-32 {
    width: calc(var(--spacing) * 32);
  }

  .w-full {
    width: 100%;
  }

  .max-w-2xl {
    max-width: var(--container-2xl);
  }

  .max-w-3xl {
    max-width: var(--container-3xl);
  }

  .max-w-4xl {
    max-width: var(--container-4xl);
  }

  .max-w-lg {
    max-width: var(--container-lg);
  }

  .max-w-md {
    max-width: var(--container-md);
  }

  .min-w-0 {
    min-width: calc(var(--spacing) * 0);
  }

  .min-w-\[200px\] {
    min-width: 200px;
  }

  .flex-1 {
    flex: 1;
  }

  .flex-shrink-0, .shrink-0 {
    flex-shrink: 0;
  }

  .grow {
    flex-grow: 1;
  }

  .-translate-y-1\/2 {
    --tw-translate-y: calc(calc(1 / 2 * 100%) * -1);
    translate: var(--tw-translate-x) var(--tw-translate-y);
  }

  .-rotate-90 {
    rotate: -90deg;
  }

  .animate-in {
    animation: enter var(--tw-duration, .15s) var(--tw-ease, ease);
  }

  .animate-pulse {
    animation: var(--animate-pulse);
  }

  .animate-spin {
    animation: var(--animate-spin);
  }

  .cursor-pointer {
    cursor: pointer;
  }

  .touch-none {
    touch-action: none;
  }

  .grid-cols-2 {
    grid-template-columns: repeat(2, minmax(0, 1fr));
  }

  .flex-col {
    flex-direction: column;
  }

  .items-center {
    align-items: center;
  }

  .items-end {
    align-items: flex-end;
  }

  .items-start {
    align-items: flex-start;
  }

  .justify-around {
    justify-content: space-around;
  }

  .justify-between {
    justify-content: space-between;
  }

  .justify-center {
    justify-content: center;
  }

  .gap-1 {
    gap: calc(var(--spacing) * 1);
  }

  .gap-1\.5 {
    gap: calc(var(--spacing) * 1.5);
  }

  .gap-2 {
    gap: calc(var(--spacing) * 2);
  }

  .gap-3 {
    gap: calc(var(--spacing) * 3);
  }

  .gap-4 {
    gap: calc(var(--spacing) * 4);
  }

  :where(.space-y-2 > :not(:last-child)) {
    --tw-space-y-reverse: 0;
    margin-block-start: calc(calc(var(--spacing) * 2) * var(--tw-space-y-reverse));
    margin-block-end: calc(calc(var(--spacing) * 2) * calc(1 - var(--tw-space-y-reverse)));
  }

  :where(.space-y-3 > :not(:last-child)) {
    --tw-space-y-reverse: 0;
    margin-block-start: calc(calc(var(--spacing) * 3) * var(--tw-space-y-reverse));
    margin-block-end: calc(calc(var(--spacing) * 3) * calc(1 - var(--tw-space-y-reverse)));
  }

  :where(.space-y-4 > :not(:last-child)) {
    --tw-space-y-reverse: 0;
    margin-block-start: calc(calc(var(--spacing) * 4) * var(--tw-space-y-reverse));
    margin-block-end: calc(calc(var(--spacing) * 4) * calc(1 - var(--tw-space-y-reverse)));
  }

  :where(.space-y-6 > :not(:last-child)) {
    --tw-space-y-reverse: 0;
    margin-block-start: calc(calc(var(--spacing) * 6) * var(--tw-space-y-reverse));
    margin-block-end: calc(calc(var(--spacing) * 6) * calc(1 - var(--tw-space-y-reverse)));
  }

  .overflow-hidden {
    overflow: hidden;
  }

  .rounded {
    border-radius: .25rem;
  }

  .rounded-2xl {
    border-radius: var(--radius-2xl);
  }

  .rounded-3xl {
    border-radius: var(--radius-3xl);
  }

  .rounded-\[4px\] {
    border-radius: 4px;
  }

  .rounded-full {
    border-radius: 3.40282e38px;
  }

  .rounded-lg {
    border-radius: .625rem;
  }

  .rounded-md {
    border-radius: .425rem;
  }

  .rounded-xl {
    border-radius: 1.025rem;
  }

  .rounded-t-3xl {
    border-top-left-radius: var(--radius-3xl);
    border-top-right-radius: var(--radius-3xl);
  }

  .border {
    border-style: var(--tw-border-style);
    border-width: 1px;
  }

  .border-2 {
    border-style: var(--tw-border-style);
    border-width: 2px;
  }

  .border-4 {
    border-style: var(--tw-border-style);
    border-width: 4px;
  }

  .border-t {
    border-top-style: var(--tw-border-style);
    border-top-width: 1px;
  }

  .border-b {
    border-bottom-style: var(--tw-border-style);
    border-bottom-width: 1px;
  }

  .border-dashed {
    --tw-border-style: dashed;
    border-style: dashed;
  }

  .border-\[var\(--color-brand-primary\)\] {
    border-color: var(--color-brand-primary);
  }

  .border-\[var\(--color-error\)\] {
    border-color: var(--color-error);
  }

  .border-\[var\(--color-stroke-divider\)\] {
    border-color: var(--color-stroke-divider);
  }

  .border-\[var\(--color-stroke-input\)\] {
    border-color: var(--color-stroke-input);
  }

  .border-gray-100 {
    border-color: var(--color-gray-100);
  }

  .border-gray-200 {
    border-color: var(--color-gray-200);
  }

  .border-gray-300 {
    border-color: var(--color-gray-300);
  }

  .border-green-200\/50 {
    border-color: color-mix(in srgb, oklch(.925 .084 155.995) 50%, transparent);
  }

  @supports (color: color-mix(in lab, red, red)) {
    .border-green-200\/50 {
      border-color: color-mix(in oklab, var(--color-green-200) 50%, transparent);
    }
  }

  .border-input {
    border-color: oklch(.922 0 0);
  }

  .border-primary {
    border-color: oklch(.205 0 0);
  }

  .border-purple-200\/50 {
    border-color: color-mix(in srgb, oklch(.902 .063 306.703) 50%, transparent);
  }

  @supports (color: color-mix(in lab, red, red)) {
    .border-purple-200\/50 {
      border-color: color-mix(in oklab, var(--color-purple-200) 50%, transparent);
    }
  }

  .border-purple-500 {
    border-color: var(--color-purple-500);
  }

  .border-purple-600 {
    border-color: var(--color-purple-600);
  }

  .border-t-transparent {
    border-top-color: #0000;
  }

  .bg-\[var\(--color-bg-primary\)\] {
    background-color: var(--color-bg-primary);
  }

  .bg-\[var\(--color-bg-secondary\)\] {
    background-color: var(--color-bg-secondary);
  }

  .bg-\[var\(--color-brand-primary\)\] {
    background-color: var(--color-brand-primary);
  }

  .bg-\[var\(--color-error-light\)\] {
    background-color: var(--color-error-light);
  }

  .bg-\[var\(--color-pending-light\)\] {
    background-color: var(--color-pending-light);
  }

  .bg-\[var\(--color-stroke-divider\)\] {
    background-color: var(--color-stroke-divider);
  }

  .bg-\[var\(--color-success-light\)\] {
    background-color: var(--color-success-light);
  }

  .bg-\[var\(--color-surface-panel\)\] {
    background-color: var(--color-surface-panel);
  }

  .bg-accent {
    background-color: oklch(.97 0 0);
  }

  .bg-background {
    background-color: oklch(1 0 0);
  }

  .bg-black\/50 {
    background-color: #00000080;
  }

  @supports (color: color-mix(in lab, red, red)) {
    .bg-black\/50 {
      background-color: color-mix(in oklab, var(--color-black) 50%, transparent);
    }
  }

  .bg-blue-50 {
    background-color: var(--color-blue-50);
  }

  .bg-blue-500 {
    background-color: var(--color-blue-500);
  }

  .bg-destructive {
    background-color: oklch(.577 .245 27.325);
  }

  .bg-gray-50 {
    background-color: var(--color-gray-50);
  }

  .bg-gray-100 {
    background-color: var(--color-gray-100);
  }

  .bg-green-50 {
    background-color: var(--color-green-50);
  }

  .bg-green-100 {
    background-color: var(--color-green-100);
  }

  .bg-green-500 {
    background-color: var(--color-green-500);
  }

  .bg-green-600 {
    background-color: var(--color-green-600);
  }

  .bg-muted {
    background-color: oklch(.97 0 0);
  }

  .bg-orange-50 {
    background-color: var(--color-orange-50);
  }

  .bg-primary {
    background-color: oklch(.205 0 0);
  }

  .bg-purple-50 {
    background-color: var(--color-purple-50);
  }

  .bg-purple-100 {
    background-color: var(--color-purple-100);
  }

  .bg-purple-500 {
    background-color: var(--color-purple-500);
  }

  .bg-purple-600 {
    background-color: var(--color-purple-600);
  }

  .bg-red-50 {
    background-color: var(--color-red-50);
  }

  .bg-red-100 {
    background-color: var(--color-red-100);
  }

  .bg-red-600 {
    background-color: var(--color-red-600);
  }

  .bg-secondary {
    background-color: oklch(.97 0 0);
  }

  .bg-white {
    background-color: var(--color-white);
  }

  .bg-white\/20 {
    background-color: #fff3;
  }

  @supports (color: color-mix(in lab, red, red)) {
    .bg-white\/20 {
      background-color: color-mix(in oklab, var(--color-white) 20%, transparent);
    }
  }

  .bg-white\/60 {
    background-color: #fff9;
  }

  @supports (color: color-mix(in lab, red, red)) {
    .bg-white\/60 {
      background-color: color-mix(in oklab, var(--color-white) 60%, transparent);
    }
  }

  .bg-gradient-to-br {
    --tw-gradient-position: to bottom right in oklab;
    background-image: linear-gradient(var(--tw-gradient-stops));
  }

  .bg-gradient-to-r {
    --tw-gradient-position: to right in oklab;
    background-image: linear-gradient(var(--tw-gradient-stops));
  }

  .from-blue-600 {
    --tw-gradient-from: var(--color-blue-600);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .from-gray-700 {
    --tw-gradient-from: var(--color-gray-700);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .from-green-50 {
    --tw-gradient-from: var(--color-green-50);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .from-green-500 {
    --tw-gradient-from: var(--color-green-500);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .from-green-600 {
    --tw-gradient-from: var(--color-green-600);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .from-purple-50 {
    --tw-gradient-from: var(--color-purple-50);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .from-purple-100 {
    --tw-gradient-from: var(--color-purple-100);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .from-purple-500 {
    --tw-gradient-from: var(--color-purple-500);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .from-purple-600 {
    --tw-gradient-from: var(--color-purple-600);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .from-red-600 {
    --tw-gradient-from: var(--color-red-600);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .from-yellow-500 {
    --tw-gradient-from: var(--color-yellow-500);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .via-purple-500 {
    --tw-gradient-via: var(--color-purple-500);
    --tw-gradient-via-stops: var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-via) var(--tw-gradient-via-position), var(--tw-gradient-to) var(--tw-gradient-to-position);
    --tw-gradient-stops: var(--tw-gradient-via-stops);
  }

  .to-blue-700 {
    --tw-gradient-to: var(--color-blue-700);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .to-emerald-50 {
    --tw-gradient-to: var(--color-emerald-50);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .to-gray-900 {
    --tw-gradient-to: var(--color-gray-900);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .to-green-600 {
    --tw-gradient-to: var(--color-green-600);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .to-green-700 {
    --tw-gradient-to: var(--color-green-700);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .to-purple-50 {
    --tw-gradient-to: var(--color-purple-50);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .to-purple-100\/50 {
    --tw-gradient-to: color-mix(in srgb, oklch(.946 .033 307.174) 50%, transparent);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  @supports (color: color-mix(in lab, red, red)) {
    .to-purple-100\/50 {
      --tw-gradient-to: color-mix(in oklab, var(--color-purple-100) 50%, transparent);
    }
  }

  .to-purple-600 {
    --tw-gradient-to: var(--color-purple-600);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .to-purple-700 {
    --tw-gradient-to: var(--color-purple-700);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .to-red-700 {
    --tw-gradient-to: var(--color-red-700);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .to-white {
    --tw-gradient-to: var(--color-white);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .to-yellow-600 {
    --tw-gradient-to: var(--color-yellow-600);
    --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
  }

  .p-2 {
    padding: calc(var(--spacing) * 2);
  }

  .p-3 {
    padding: calc(var(--spacing) * 3);
  }

  .p-4 {
    padding: calc(var(--spacing) * 4);
  }

  .p-5 {
    padding: calc(var(--spacing) * 5);
  }

  .p-6 {
    padding: calc(var(--spacing) * 6);
  }

  .p-8 {
    padding: calc(var(--spacing) * 8);
  }

  .px-2 {
    padding-inline: calc(var(--spacing) * 2);
  }

  .px-3 {
    padding-inline: calc(var(--spacing) * 3);
  }

  .px-4 {
    padding-inline: calc(var(--spacing) * 4);
  }

  .px-6 {
    padding-inline: calc(var(--spacing) * 6);
  }

  .py-1 {
    padding-block: calc(var(--spacing) * 1);
  }

  .py-1\.5 {
    padding-block: calc(var(--spacing) * 1.5);
  }

  .py-2 {
    padding-block: calc(var(--spacing) * 2);
  }

  .py-3 {
    padding-block: calc(var(--spacing) * 3);
  }

  .py-4 {
    padding-block: calc(var(--spacing) * 4);
  }

  .py-6 {
    padding-block: calc(var(--spacing) * 6);
  }

  .py-12 {
    padding-block: calc(var(--spacing) * 12);
  }

  .pt-3 {
    padding-top: calc(var(--spacing) * 3);
  }

  .pr-12 {
    padding-right: calc(var(--spacing) * 12);
  }

  .pb-4 {
    padding-bottom: calc(var(--spacing) * 4);
  }

  .pb-20 {
    padding-bottom: calc(var(--spacing) * 20);
  }

  .text-center {
    text-align: center;
  }

  .text-left {
    text-align: left;
  }

  .text-right {
    text-align: right;
  }

  .font-mono {
    font-family: var(--font-mono);
  }

  .text-2xl {
    font-size: var(--text-2xl);
    line-height: var(--tw-leading, var(--text-2xl--line-height));
  }

  .text-3xl {
    font-size: var(--text-3xl);
    line-height: var(--tw-leading, var(--text-3xl--line-height));
  }

  .text-4xl {
    font-size: var(--text-4xl);
    line-height: var(--tw-leading, var(--text-4xl--line-height));
  }

  .text-5xl {
    font-size: var(--text-5xl);
    line-height: var(--tw-leading, var(--text-5xl--line-height));
  }

  .text-base {
    font-size: var(--text-base);
    line-height: var(--tw-leading, var(--text-base--line-height));
  }

  .text-lg {
    font-size: var(--text-lg);
    line-height: var(--tw-leading, var(--text-lg--line-height));
  }

  .text-sm {
    font-size: var(--text-sm);
    line-height: var(--tw-leading, var(--text-sm--line-height));
  }

  .text-xl {
    font-size: var(--text-xl);
    line-height: var(--tw-leading, var(--text-xl--line-height));
  }

  .text-xs {
    font-size: var(--text-xs);
    line-height: var(--tw-leading, var(--text-xs--line-height));
  }

  .leading-none {
    --tw-leading: 1;
    line-height: 1;
  }

  .font-medium {
    --tw-font-weight: var(--font-weight-medium);
    font-weight: var(--font-weight-medium);
  }

  .font-semibold {
    --tw-font-weight: var(--font-weight-semibold);
    font-weight: var(--font-weight-semibold);
  }

  .tracking-wider {
    --tw-tracking: var(--tracking-wider);
    letter-spacing: var(--tracking-wider);
  }

  .whitespace-nowrap {
    white-space: nowrap;
  }

  .text-\[var\(--color-brand-primary\)\] {
    color: var(--color-brand-primary);
  }

  .text-\[var\(--color-error\)\] {
    color: var(--color-error);
  }

  .text-\[var\(--color-pending\)\] {
    color: var(--color-pending);
  }

  .text-\[var\(--color-success\)\] {
    color: var(--color-success);
  }

  .text-\[var\(--color-text-primary\)\] {
    color: var(--color-text-primary);
  }

  .text-\[var\(--color-text-secondary\)\] {
    color: var(--color-text-secondary);
  }

  .text-\[var\(--color-text-tertiary\)\] {
    color: var(--color-text-tertiary);
  }

  .text-blue-600 {
    color: var(--color-blue-600);
  }

  .text-current {
    color: currentColor;
  }

  .text-foreground {
    color: oklch(.145 0 0);
  }

  .text-gray-400 {
    color: var(--color-gray-400);
  }

  .text-gray-500 {
    color: var(--color-gray-500);
  }

  .text-gray-600 {
    color: var(--color-gray-600);
  }

  .text-gray-700 {
    color: var(--color-gray-700);
  }

  .text-gray-900 {
    color: var(--color-gray-900);
  }

  .text-green-500 {
    color: var(--color-green-500);
  }

  .text-green-600 {
    color: var(--color-green-600);
  }

  .text-green-700 {
    color: var(--color-green-700);
  }

  .text-green-900 {
    color: var(--color-green-900);
  }

  .text-orange-600 {
    color: var(--color-orange-600);
  }

  .text-orange-700 {
    color: var(--color-orange-700);
  }

  .text-primary {
    color: oklch(.205 0 0);
  }

  .text-primary-foreground {
    color: oklch(.985 0 0);
  }

  .text-purple-100 {
    color: var(--color-purple-100);
  }

  .text-purple-400 {
    color: var(--color-purple-400);
  }

  .text-purple-500 {
    color: var(--color-purple-500);
  }

  .text-purple-600 {
    color: var(--color-purple-600);
  }

  .text-purple-700 {
    color: var(--color-purple-700);
  }

  .text-purple-900 {
    color: var(--color-purple-900);
  }

  .text-red-500 {
    color: var(--color-red-500);
  }

  .text-red-600 {
    color: var(--color-red-600);
  }

  .text-red-700 {
    color: var(--color-red-700);
  }

  .text-secondary-foreground {
    color: oklch(.205 0 0);
  }

  .text-white {
    color: var(--color-white);
  }

  .text-yellow-500 {
    color: var(--color-yellow-500);
  }

  .underline-offset-4 {
    text-underline-offset: 4px;
  }

  .opacity-75 {
    opacity: .75;
  }

  .opacity-80 {
    opacity: .8;
  }

  .opacity-90 {
    opacity: .9;
  }

  .shadow-lg {
    --tw-shadow: 0 10px 15px -3px var(--tw-shadow-color, #0000001a), 0 4px 6px -4px var(--tw-shadow-color, #0000001a);
    box-shadow: var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
  }

  .shadow-sm {
    --tw-shadow: 0 1px 3px 0 var(--tw-shadow-color, #0000001a), 0 1px 2px -1px var(--tw-shadow-color, #0000001a);
    box-shadow: var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
  }

  .shadow-xl {
    --tw-shadow: 0 20px 25px -5px var(--tw-shadow-color, #0000001a), 0 8px 10px -6px var(--tw-shadow-color, #0000001a);
    box-shadow: var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
  }

  .shadow-xs {
    --tw-shadow: 0 1px 2px 0 var(--tw-shadow-color, #0000000d);
    box-shadow: var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
  }

  .ring-4 {
    --tw-ring-shadow: var(--tw-ring-inset, ) 0 0 0 calc(4px + var(--tw-ring-offset-width)) var(--tw-ring-color, currentcolor);
    box-shadow: var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
  }

  .shadow-card {
    --tw-shadow-color: oklch(1 0 0);
  }

  @supports (color: color-mix(in lab, red, red)) {
    .shadow-card {
      --tw-shadow-color: color-mix(in oklab, oklch(1 0 0) var(--tw-shadow-alpha), transparent);
    }
  }

  .ring-\[var\(--color-brand-primary-light\)\] {
    --tw-ring-color: var(--color-brand-primary-light);
  }

  .ring-ring\/50 {
    --tw-ring-color: color-mix(in oklab, oklch(.708 0 0) 50%, transparent);
  }

  .outline {
    outline-style: var(--tw-outline-style);
    outline-width: 1px;
  }

  .filter {
    filter: var(--tw-blur, ) var(--tw-brightness, ) var(--tw-contrast, ) var(--tw-grayscale, ) var(--tw-hue-rotate, ) var(--tw-invert, ) var(--tw-saturate, ) var(--tw-sepia, ) var(--tw-drop-shadow, );
  }

  .backdrop-blur-sm {
    --tw-backdrop-blur: blur(var(--blur-sm));
    -webkit-backdrop-filter: var(--tw-backdrop-blur, ) var(--tw-backdrop-brightness, ) var(--tw-backdrop-contrast, ) var(--tw-backdrop-grayscale, ) var(--tw-backdrop-hue-rotate, ) var(--tw-backdrop-invert, ) var(--tw-backdrop-opacity, ) var(--tw-backdrop-saturate, ) var(--tw-backdrop-sepia, );
    backdrop-filter: var(--tw-backdrop-blur, ) var(--tw-backdrop-brightness, ) var(--tw-backdrop-contrast, ) var(--tw-backdrop-grayscale, ) var(--tw-backdrop-hue-rotate, ) var(--tw-backdrop-invert, ) var(--tw-backdrop-opacity, ) var(--tw-backdrop-saturate, ) var(--tw-backdrop-sepia, );
  }

  .transition-\[color\,box-shadow\] {
    transition-property: color, box-shadow;
    transition-timing-function: var(--tw-ease, var(--default-transition-timing-function));
    transition-duration: var(--tw-duration, var(--default-transition-duration));
  }

  .transition-all {
    transition-property: all;
    transition-timing-function: var(--tw-ease, var(--default-transition-timing-function));
    transition-duration: var(--tw-duration, var(--default-transition-duration));
  }

  .transition-colors {
    transition-property: color, background-color, border-color, outline-color, text-decoration-color, fill, stroke, --tw-gradient-from, --tw-gradient-via, --tw-gradient-to;
    transition-timing-function: var(--tw-ease, var(--default-transition-timing-function));
    transition-duration: var(--tw-duration, var(--default-transition-duration));
  }

  .transition-shadow {
    transition-property: box-shadow;
    transition-timing-function: var(--tw-ease, var(--default-transition-timing-function));
    transition-duration: var(--tw-duration, var(--default-transition-duration));
  }

  .transition-none {
    transition-property: none;
  }

  .duration-200 {
    --tw-duration: .2s;
    transition-duration: .2s;
  }

  .duration-300 {
    --tw-duration: .3s;
    transition-duration: .3s;
  }

  .duration-500 {
    --tw-duration: .5s;
    transition-duration: .5s;
  }

  .duration-1000 {
    --tw-duration: 1s;
    transition-duration: 1s;
  }

  .ease-in-out {
    --tw-ease: var(--ease-in-out);
    transition-timing-function: var(--ease-in-out);
  }

  .ease-out {
    --tw-ease: var(--ease-out);
    transition-timing-function: var(--ease-out);
  }

  .outline-none {
    --tw-outline-style: none;
    outline-style: none;
  }

  .select-none {
    -webkit-user-select: none;
    user-select: none;
  }

  .fade-in {
    --tw-enter-opacity: 0;
  }

  .slide-in-from-bottom {
    --tw-enter-translate-y: 100%;
  }

  .group-data-\[disabled\=true\]\:pointer-events-none:is(:where(.group)[data-disabled="true"] *) {
    pointer-events: none;
  }

  .group-data-\[disabled\=true\]\:opacity-50:is(:where(.group)[data-disabled="true"] *) {
    opacity: .5;
  }

  .peer-disabled\:cursor-not-allowed:is(:where(.peer):disabled ~ *) {
    cursor: not-allowed;
  }

  .peer-disabled\:opacity-50:is(:where(.peer):disabled ~ *) {
    opacity: .5;
  }

  .selection\:bg-primary ::selection, .selection\:bg-primary::selection {
    background-color: oklch(.205 0 0);
  }

  .selection\:text-primary-foreground ::selection, .selection\:text-primary-foreground::selection {
    color: oklch(.985 0 0);
  }

  .file\:inline-flex::file-selector-button {
    display: inline-flex;
  }

  .file\:h-7::file-selector-button {
    height: calc(var(--spacing) * 7);
  }

  .file\:border-0::file-selector-button {
    border-style: var(--tw-border-style);
    border-width: 0;
  }

  .file\:bg-transparent::file-selector-button {
    background-color: #0000;
  }

  .file\:text-sm::file-selector-button {
    font-size: var(--text-sm);
    line-height: var(--tw-leading, var(--text-sm--line-height));
  }

  .file\:font-medium::file-selector-button {
    --tw-font-weight: var(--font-weight-medium);
    font-weight: var(--font-weight-medium);
  }

  .file\:text-foreground::file-selector-button {
    color: oklch(.145 0 0);
  }

  .placeholder\:text-muted-foreground::placeholder {
    color: oklch(.556 0 0);
  }

  @media (hover: hover) {
    .hover\:border-\[var\(--color-brand-primary-light\)\]:hover {
      border-color: var(--color-brand-primary-light);
    }
  }

  @media (hover: hover) {
    .hover\:border-gray-300:hover {
      border-color: var(--color-gray-300);
    }
  }

  @media (hover: hover) {
    .hover\:border-purple-400:hover {
      border-color: var(--color-purple-400);
    }
  }

  @media (hover: hover) {
    .hover\:bg-\[var\(--color-brand-primary-hover\)\]:hover {
      background-color: var(--color-brand-primary-hover);
    }
  }

  @media (hover: hover) {
    .hover\:bg-\[var\(--color-error\)\]:hover {
      background-color: var(--color-error);
    }
  }

  @media (hover: hover) {
    .hover\:bg-\[var\(--color-surface-panel\)\]:hover {
      background-color: var(--color-surface-panel);
    }
  }

  @media (hover: hover) {
    .hover\:bg-accent:hover {
      background-color: oklch(.97 0 0);
    }
  }

  @media (hover: hover) {
    .hover\:bg-destructive\/90:hover {
      background-color: color-mix(in oklab, oklch(.577 .245 27.325) 90%, transparent);
    }
  }

  @media (hover: hover) {
    .hover\:bg-gray-50:hover {
      background-color: var(--color-gray-50);
    }
  }

  @media (hover: hover) {
    .hover\:bg-gray-100:hover {
      background-color: var(--color-gray-100);
    }
  }

  @media (hover: hover) {
    .hover\:bg-gray-200:hover {
      background-color: var(--color-gray-200);
    }
  }

  @media (hover: hover) {
    .hover\:bg-green-100:hover {
      background-color: var(--color-green-100);
    }
  }

  @media (hover: hover) {
    .hover\:bg-green-700:hover {
      background-color: var(--color-green-700);
    }
  }

  @media (hover: hover) {
    .hover\:bg-primary\/90:hover {
      background-color: color-mix(in oklab, oklch(.205 0 0) 90%, transparent);
    }
  }

  @media (hover: hover) {
    .hover\:bg-purple-50\/50:hover {
      background-color: color-mix(in srgb, oklch(.977 .014 308.299) 50%, transparent);
    }

    @supports (color: color-mix(in lab, red, red)) {
      .hover\:bg-purple-50\/50:hover {
        background-color: color-mix(in oklab, var(--color-purple-50) 50%, transparent);
      }
    }
  }

  @media (hover: hover) {
    .hover\:bg-purple-100:hover {
      background-color: var(--color-purple-100);
    }
  }

  @media (hover: hover) {
    .hover\:bg-purple-700:hover {
      background-color: var(--color-purple-700);
    }
  }

  @media (hover: hover) {
    .hover\:bg-red-100:hover {
      background-color: var(--color-red-100);
    }
  }

  @media (hover: hover) {
    .hover\:bg-red-700:hover {
      background-color: var(--color-red-700);
    }
  }

  @media (hover: hover) {
    .hover\:bg-secondary\/80:hover {
      background-color: color-mix(in oklab, oklch(.97 0 0) 80%, transparent);
    }
  }

  @media (hover: hover) {
    .hover\:text-accent-foreground:hover {
      color: oklch(.205 0 0);
    }
  }

  @media (hover: hover) {
    .hover\:text-gray-900:hover {
      color: var(--color-gray-900);
    }
  }

  @media (hover: hover) {
    .hover\:text-purple-700:hover {
      color: var(--color-purple-700);
    }
  }

  @media (hover: hover) {
    .hover\:text-white:hover {
      color: var(--color-white);
    }
  }

  @media (hover: hover) {
    .hover\:underline:hover {
      text-decoration-line: underline;
    }
  }

  @media (hover: hover) {
    .hover\:shadow-lg:hover {
      --tw-shadow: 0 10px 15px -3px var(--tw-shadow-color, #0000001a), 0 4px 6px -4px var(--tw-shadow-color, #0000001a);
      box-shadow: var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
    }
  }

  @media (hover: hover) {
    .hover\:ring-4:hover {
      --tw-ring-shadow: var(--tw-ring-inset, ) 0 0 0 calc(4px + var(--tw-ring-offset-width)) var(--tw-ring-color, currentcolor);
      box-shadow: var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
    }
  }

  .focus\:ring-2:focus {
    --tw-ring-shadow: var(--tw-ring-inset, ) 0 0 0 calc(2px + var(--tw-ring-offset-width)) var(--tw-ring-color, currentcolor);
    box-shadow: var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
  }

  .focus\:ring-purple-500:focus {
    --tw-ring-color: var(--color-purple-500);
  }

  .focus-visible\:border-ring:focus-visible {
    border-color: oklch(.708 0 0);
  }

  .focus-visible\:ring-4:focus-visible {
    --tw-ring-shadow: var(--tw-ring-inset, ) 0 0 0 calc(4px + var(--tw-ring-offset-width)) var(--tw-ring-color, currentcolor);
    box-shadow: var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
  }

  .focus-visible\:ring-\[3px\]:focus-visible {
    --tw-ring-shadow: var(--tw-ring-inset, ) 0 0 0 calc(3px + var(--tw-ring-offset-width)) var(--tw-ring-color, currentcolor);
    box-shadow: var(--tw-inset-shadow), var(--tw-inset-ring-shadow), var(--tw-ring-offset-shadow), var(--tw-ring-shadow), var(--tw-shadow);
  }

  .focus-visible\:ring-destructive\/20:focus-visible {
    --tw-ring-color: color-mix(in oklab, oklch(.577 .245 27.325) 20%, transparent);
  }

  .focus-visible\:ring-ring\/50:focus-visible {
    --tw-ring-color: color-mix(in oklab, oklch(.708 0 0) 50%, transparent);
  }

  .focus-visible\:outline-hidden:focus-visible {
    --tw-outline-style: none;
    outline-style: none;
  }

  @media (forced-colors: active) {
    .focus-visible\:outline-hidden:focus-visible {
      outline-offset: 2px;
      outline: 2px solid #0000;
    }
  }

  .disabled\:pointer-events-none:disabled {
    pointer-events: none;
  }

  .disabled\:cursor-not-allowed:disabled {
    cursor: not-allowed;
  }

  .disabled\:opacity-50:disabled {
    opacity: .5;
  }

  .has-\[\>svg\]\:px-2\.5:has( > svg) {
    padding-inline: calc(var(--spacing) * 2.5);
  }

  .has-\[\>svg\]\:px-3:has( > svg) {
    padding-inline: calc(var(--spacing) * 3);
  }

  .has-\[\>svg\]\:px-4:has( > svg) {
    padding-inline: calc(var(--spacing) * 4);
  }

  .aria-invalid\:border-destructive[aria-invalid="true"] {
    border-color: oklch(.577 .245 27.325);
  }

  .aria-invalid\:ring-destructive\/20[aria-invalid="true"] {
    --tw-ring-color: color-mix(in oklab, oklch(.577 .245 27.325) 20%, transparent);
  }

  .data-\[disabled\]\:opacity-50[data-disabled] {
    opacity: .5;
  }

  .data-\[orientation\=horizontal\]\:h-4[data-orientation="horizontal"] {
    height: calc(var(--spacing) * 4);
  }

  .data-\[orientation\=horizontal\]\:h-full[data-orientation="horizontal"] {
    height: 100%;
  }

  .data-\[orientation\=horizontal\]\:w-full[data-orientation="horizontal"] {
    width: 100%;
  }

  .data-\[orientation\=vertical\]\:h-full[data-orientation="vertical"] {
    height: 100%;
  }

  .data-\[orientation\=vertical\]\:min-h-44[data-orientation="vertical"] {
    min-height: calc(var(--spacing) * 44);
  }

  .data-\[orientation\=vertical\]\:w-1\.5[data-orientation="vertical"] {
    width: calc(var(--spacing) * 1.5);
  }

  .data-\[orientation\=vertical\]\:w-auto[data-orientation="vertical"] {
    width: auto;
  }

  .data-\[orientation\=vertical\]\:w-full[data-orientation="vertical"] {
    width: 100%;
  }

  .data-\[orientation\=vertical\]\:flex-col[data-orientation="vertical"] {
    flex-direction: column;
  }

  .data-\[state\=checked\]\:border-primary[data-state="checked"] {
    border-color: oklch(.205 0 0);
  }

  .data-\[state\=checked\]\:bg-primary[data-state="checked"] {
    background-color: oklch(.205 0 0);
  }

  .data-\[state\=checked\]\:text-primary-foreground[data-state="checked"] {
    color: oklch(.985 0 0);
  }

  @media (width >= 48rem) {
    .md\:mb-4 {
      margin-bottom: calc(var(--spacing) * 4);
    }
  }

  @media (width >= 48rem) {
    .md\:mb-8 {
      margin-bottom: calc(var(--spacing) * 8);
    }
  }

  @media (width >= 48rem) {
    .md\:mb-10 {
      margin-bottom: calc(var(--spacing) * 10);
    }
  }

  @media (width >= 48rem) {
    .md\:mb-12 {
      margin-bottom: calc(var(--spacing) * 12);
    }
  }

  @media (width >= 48rem) {
    .md\:block {
      display: block;
    }
  }

  @media (width >= 48rem) {
    .md\:h-5 {
      height: calc(var(--spacing) * 5);
    }
  }

  @media (width >= 48rem) {
    .md\:h-10 {
      height: calc(var(--spacing) * 10);
    }
  }

  @media (width >= 48rem) {
    .md\:h-14 {
      height: calc(var(--spacing) * 14);
    }
  }

  @media (width >= 48rem) {
    .md\:h-16 {
      height: calc(var(--spacing) * 16);
    }
  }

  @media (width >= 48rem) {
    .md\:h-20 {
      height: calc(var(--spacing) * 20);
    }
  }

  @media (width >= 48rem) {
    .md\:w-5 {
      width: calc(var(--spacing) * 5);
    }
  }

  @media (width >= 48rem) {
    .md\:w-10 {
      width: calc(var(--spacing) * 10);
    }
  }

  @media (width >= 48rem) {
    .md\:w-14 {
      width: calc(var(--spacing) * 14);
    }
  }

  @media (width >= 48rem) {
    .md\:w-20 {
      width: calc(var(--spacing) * 20);
    }
  }

  @media (width >= 48rem) {
    .md\:w-auto {
      width: auto;
    }
  }

  @media (width >= 48rem) {
    .md\:flex-1 {
      flex: 1;
    }
  }

  @media (width >= 48rem) {
    .md\:grid-cols-2 {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }
  }

  @media (width >= 48rem) {
    .md\:flex-row {
      flex-direction: row;
    }
  }

  @media (width >= 48rem) {
    .md\:gap-4 {
      gap: calc(var(--spacing) * 4);
    }
  }

  @media (width >= 48rem) {
    .md\:gap-6 {
      gap: calc(var(--spacing) * 6);
    }
  }

  @media (width >= 48rem) {
    :where(.md\:space-y-4 > :not(:last-child)) {
      --tw-space-y-reverse: 0;
      margin-block-start: calc(calc(var(--spacing) * 4) * var(--tw-space-y-reverse));
      margin-block-end: calc(calc(var(--spacing) * 4) * calc(1 - var(--tw-space-y-reverse)));
    }
  }

  @media (width >= 48rem) {
    :where(.md\:space-y-8 > :not(:last-child)) {
      --tw-space-y-reverse: 0;
      margin-block-start: calc(calc(var(--spacing) * 8) * var(--tw-space-y-reverse));
      margin-block-end: calc(calc(var(--spacing) * 8) * calc(1 - var(--tw-space-y-reverse)));
    }
  }

  @media (width >= 48rem) {
    .md\:p-4 {
      padding: calc(var(--spacing) * 4);
    }
  }

  @media (width >= 48rem) {
    .md\:p-5 {
      padding: calc(var(--spacing) * 5);
    }
  }

  @media (width >= 48rem) {
    .md\:p-6 {
      padding: calc(var(--spacing) * 6);
    }
  }

  @media (width >= 48rem) {
    .md\:p-8 {
      padding: calc(var(--spacing) * 8);
    }
  }

  @media (width >= 48rem) {
    .md\:py-8 {
      padding-block: calc(var(--spacing) * 8);
    }
  }

  @media (width >= 48rem) {
    .md\:text-2xl {
      font-size: var(--text-2xl);
      line-height: var(--tw-leading, var(--text-2xl--line-height));
    }
  }

  @media (width >= 48rem) {
    .md\:text-4xl {
      font-size: var(--text-4xl);
      line-height: var(--tw-leading, var(--text-4xl--line-height));
    }
  }

  @media (width >= 48rem) {
    .md\:text-sm {
      font-size: var(--text-sm);
      line-height: var(--tw-leading, var(--text-sm--line-height));
    }
  }

  @media (prefers-color-scheme: dark) {
    .dark\:border-input {
      border-color: oklch(.922 0 0);
    }
  }

  @media (prefers-color-scheme: dark) {
    .dark\:bg-destructive\/60 {
      background-color: color-mix(in oklab, oklch(.577 .245 27.325) 60%, transparent);
    }
  }

  @media (prefers-color-scheme: dark) {
    .dark\:bg-input\/30 {
      background-color: color-mix(in oklab, oklch(.922 0 0) 30%, transparent);
    }
  }

  @media (prefers-color-scheme: dark) {
    .dark\:from-purple-900 {
      --tw-gradient-from: var(--color-purple-900);
      --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
    }
  }

  @media (prefers-color-scheme: dark) {
    .dark\:from-purple-900\/20 {
      --tw-gradient-from: color-mix(in srgb, oklch(.381 .176 304.987) 20%, transparent);
      --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
    }

    @supports (color: color-mix(in lab, red, red)) {
      .dark\:from-purple-900\/20 {
        --tw-gradient-from: color-mix(in oklab, var(--color-purple-900) 20%, transparent);
      }
    }
  }

  @media (prefers-color-scheme: dark) {
    .dark\:to-purple-800 {
      --tw-gradient-to: var(--color-purple-800);
      --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
    }
  }

  @media (prefers-color-scheme: dark) {
    .dark\:to-purple-800\/10 {
      --tw-gradient-to: color-mix(in srgb, oklch(.438 .218 303.724) 10%, transparent);
      --tw-gradient-stops: var(--tw-gradient-via-stops, var(--tw-gradient-position), var(--tw-gradient-from) var(--tw-gradient-from-position), var(--tw-gradient-to) var(--tw-gradient-to-position));
    }

    @supports (color: color-mix(in lab, red, red)) {
      .dark\:to-purple-800\/10 {
        --tw-gradient-to: color-mix(in oklab, var(--color-purple-800) 10%, transparent);
      }
    }
  }

  @media (prefers-color-scheme: dark) {
    @media (hover: hover) {
      .dark\:hover\:bg-accent\/50:hover {
        background-color: color-mix(in oklab, oklch(.97 0 0) 50%, transparent);
      }
    }
  }

  @media (prefers-color-scheme: dark) {
    @media (hover: hover) {
      .dark\:hover\:bg-input\/50:hover {
        background-color: color-mix(in oklab, oklch(.922 0 0) 50%, transparent);
      }
    }
  }

  @media (prefers-color-scheme: dark) {
    .dark\:focus-visible\:ring-destructive\/40:focus-visible {
      --tw-ring-color: color-mix(in oklab, oklch(.577 .245 27.325) 40%, transparent);
    }
  }

  @media (prefers-color-scheme: dark) {
    .dark\:aria-invalid\:ring-destructive\/40[aria-invalid="true"] {
      --tw-ring-color: color-mix(in oklab, oklch(.577 .245 27.325) 40%, transparent);
    }
  }

  @media (prefers-color-scheme: dark) {
    .dark\:data-\[state\=checked\]\:bg-primary[data-state="checked"] {
      background-color: oklch(.205 0 0);
    }
  }

  .\[\&_svg\]\:pointer-events-none svg {
    pointer-events: none;
  }

  .\[\&_svg\]\:shrink-0 svg {
    flex-shrink: 0;
  }

  .\[\&_svg\:not\(\[class\*\=\'size-\'\]\)\]\:size-4 svg:not([class*="size-"]) {
    width: calc(var(--spacing) * 4);
    height: calc(var(--spacing) * 4);
  }

  .container-responsive {
    width: 100%;
    padding-inline: calc(var(--spacing) * 4);
    max-width: 100%;
    margin-inline: auto;
  }

  @media (width >= 48rem) {
    .container-responsive {
      padding-inline: calc(var(--spacing) * 5);
    }
  }

  @media (width >= 64rem) {
    .container-responsive {
      padding-inline: calc(var(--spacing) * 6);
    }
  }

  @media (width >= 48rem) {
    .container-responsive {
      max-width: 720px;
    }
  }

  @media (width >= 64rem) {
    .container-responsive {
      max-width: 1200px;
    }
  }

  .shadow-card {
    box-shadow: var(--shadow-md);
  }

  .shadow-card-hover {
    box-shadow: var(--shadow-lg);
  }
}

@property --tw-translate-x {
  syntax: "*";
  inherits: false;
  initial-value: 0;
}

@property --tw-translate-y {
  syntax: "*";
  inherits: false;
  initial-value: 0;
}

@property --tw-translate-z {
  syntax: "*";
  inherits: false;
  initial-value: 0;
}

@property --tw-space-y-reverse {
  syntax: "*";
  inherits: false;
  initial-value: 0;
}

@property --tw-border-style {
  syntax: "*";
  inherits: false;
  initial-value: solid;
}

@property --tw-gradient-position {
  syntax: "*";
  inherits: false
}

@property --tw-gradient-from {
  syntax: "<color>";
  inherits: false;
  initial-value: #0000;
}

@property --tw-gradient-via {
  syntax: "<color>";
  inherits: false;
  initial-value: #0000;
}

@property --tw-gradient-to {
  syntax: "<color>";
  inherits: false;
  initial-value: #0000;
}

@property --tw-gradient-stops {
  syntax: "*";
  inherits: false
}

@property --tw-gradient-via-stops {
  syntax: "*";
  inherits: false
}

@property --tw-gradient-from-position {
  syntax: "<length-percentage>";
  inherits: false;
  initial-value: 0%;
}

@property --tw-gradient-via-position {
  syntax: "<length-percentage>";
  inherits: false;
  initial-value: 50%;
}

@property --tw-gradient-to-position {
  syntax: "<length-percentage>";
  inherits: false;
  initial-value: 100%;
}

@property --tw-leading {
  syntax: "*";
  inherits: false
}

@property --tw-font-weight {
  syntax: "*";
  inherits: false
}

@property --tw-tracking {
  syntax: "*";
  inherits: false
}

@property --tw-shadow {
  syntax: "*";
  inherits: false;
  initial-value: 0 0 #0000;
}

@property --tw-shadow-color {
  syntax: "*";
  inherits: false
}

@property --tw-shadow-alpha {
  syntax: "<percentage>";
  inherits: false;
  initial-value: 100%;
}

@property --tw-inset-shadow {
  syntax: "*";
  inherits: false;
  initial-value: 0 0 #0000;
}

@property --tw-inset-shadow-color {
  syntax: "*";
  inherits: false
}

@property --tw-inset-shadow-alpha {
  syntax: "<percentage>";
  inherits: false;
  initial-value: 100%;
}

@property --tw-ring-color {
  syntax: "*";
  inherits: false
}

@property --tw-ring-shadow {
  syntax: "*";
  inherits: false;
  initial-value: 0 0 #0000;
}

@property --tw-inset-ring-color {
  syntax: "*";
  inherits: false
}

@property --tw-inset-ring-shadow {
  syntax: "*";
  inherits: false;
  initial-value: 0 0 #0000;
}

@property --tw-ring-inset {
  syntax: "*";
  inherits: false
}

@property --tw-ring-offset-width {
  syntax: "<length>";
  inherits: false;
  initial-value: 0;
}

@property --tw-ring-offset-color {
  syntax: "*";
  inherits: false;
  initial-value: #fff;
}

@property --tw-ring-offset-shadow {
  syntax: "*";
  inherits: false;
  initial-value: 0 0 #0000;
}

@property --tw-outline-style {
  syntax: "*";
  inherits: false;
  initial-value: solid;
}

@property --tw-blur {
  syntax: "*";
  inherits: false
}

@property --tw-brightness {
  syntax: "*";
  inherits: false
}

@property --tw-contrast {
  syntax: "*";
  inherits: false
}

@property --tw-grayscale {
  syntax: "*";
  inherits: false
}

@property --tw-hue-rotate {
  syntax: "*";
  inherits: false
}

@property --tw-invert {
  syntax: "*";
  inherits: false
}

@property --tw-opacity {
  syntax: "*";
  inherits: false
}

@property --tw-saturate {
  syntax: "*";
  inherits: false
}

@property --tw-sepia {
  syntax: "*";
  inherits: false
}

@property --tw-drop-shadow {
  syntax: "*";
  inherits: false
}

@property --tw-drop-shadow-color {
  syntax: "*";
  inherits: false
}

@property --tw-drop-shadow-alpha {
  syntax: "<percentage>";
  inherits: false;
  initial-value: 100%;
}

@property --tw-drop-shadow-size {
  syntax: "*";
  inherits: false
}

@property --tw-backdrop-blur {
  syntax: "*";
  inherits: false
}

@property --tw-backdrop-brightness {
  syntax: "*";
  inherits: false
}

@property --tw-backdrop-contrast {
  syntax: "*";
  inherits: false
}

@property --tw-backdrop-grayscale {
  syntax: "*";
  inherits: false
}

@property --tw-backdrop-hue-rotate {
  syntax: "*";
  inherits: false
}

@property --tw-backdrop-invert {
  syntax: "*";
  inherits: false
}

@property --tw-backdrop-opacity {
  syntax: "*";
  inherits: false
}

@property --tw-backdrop-saturate {
  syntax: "*";
  inherits: false
}

@property --tw-backdrop-sepia {
  syntax: "*";
  inherits: false
}

@property --tw-duration {
  syntax: "*";
  inherits: false
}

@property --tw-ease {
  syntax: "*";
  inherits: false
}

@keyframes spin {
  to {
    transform: rotate(360deg);
  }
}

@keyframes pulse {
  50% {
    opacity: .5;
  }
}

@keyframes enter {
  from {
    opacity: var(--tw-enter-opacity, 1);
    transform: translate3d(var(--tw-enter-translate-x, 0), var(--tw-enter-translate-y, 0), 0) scale3d(var(--tw-enter-scale, 1), var(--tw-enter-scale, 1), var(--tw-enter-scale, 1)) rotate(var(--tw-enter-rotate, 0));
  }
}
</file>

<file path="Figma_Front/src/INTEGRATION_GUIDE.md">
# Credit Guard - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

## –û–±–∑–æ—Ä –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Ç–µ–ø–µ—Ä—å –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–æ —Å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–æ–º –∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –µ–¥–∏–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö.

### –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –ø–æ—Ç–æ–∫—É

```
Splash Screen (2 —Å–µ–∫)
    ‚Üì
Onboarding (5 —à–∞–≥–æ–≤)
    ‚Üì
Loading/Calculation Screen
    ‚Üì
Home Screen (–≥–ª–∞–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ)
    ‚Üì
–î–µ—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã (STS, Loans, Deposits, etc.)
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–∞–Ω–Ω—ã—Ö

### OnboardingData (—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –≤ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–µ)

```typescript
{
  user_profile: {
    user_id: string,
    display_name: string
  },
  linked_banks: [{
    bank_id: string,
    name: string,
    connected: boolean
  }],
  consents: [{
    bank_id: string,
    consent_id: string,
    status: 'pending' | 'approved' | 'rejected'
  }],
  selected_products: [{
    bank_id: string,
    product_id: string,
    product_type: 'loan' | 'deposit' | 'card'
  }],
  goal: {
    type: 'close_debts' | 'save_money' | 'both',
    risk_mode: 'conservative' | 'balanced' | 'fast',
    save?: { amount_target, horizon },
    debts?: { selected_loan_ids[] }
  }
}
```

### AppState (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –≥–ª–∞–≤–Ω–æ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏)

```typescript
{
  mode: 'loans' | 'deposits',
  user: {
    id: string,
    name: string,
    consents: { [bankId]: consentId }
  },
  onboarding: {
    completed: boolean,
    strategy: '–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ' | '—Å–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ' | '–∞–≥—Ä–µ—Å—Å–∏–≤–Ω–æ'
  },
  health: { score, status, reasons, next_action },
  sts: { today: { amount, spent }, tomorrow },
  loans: { summary, items[] },
  goals: { summary },
  deposits: { current, goal },
  balances: { total, total_debit },
  cards: [],
  timeline: [],
  offers: { refi[], deposits[] }
}
```

## –≠—Ç–∞–ø—ã –ø–æ—Ç–æ–∫–∞

### 1. Splash Screen
- –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è 2 —Å–µ–∫—É–Ω–¥—ã
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥—É
- –§–∞–π–ª: `/screens/SplashScreen.tsx`

### 2. Onboarding (5 —à–∞–≥–æ–≤)

**–®–∞–≥ 1: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ**
- User ID –∏ –∏–º—è
- –°–æ–≥–ª–∞—Å–∏–µ —Å —É—Å–ª–æ–≤–∏—è–º–∏
- –û–ø—Ü–∏—è "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" (—Å–æ–∑–¥–∞–µ—Ç –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å)

**–®–∞–≥ 2: –í—ã–±–æ—Ä –±–∞–Ω–∫–æ–≤**
- –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã–µ –±–∞–Ω–∫–∏
- –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –≤—ã–±–æ—Ä
- API: `GET /api/banks`

**–®–∞–≥ 3: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏–π**
- OAuth-–ø–æ–¥–æ–±–Ω—ã–π –ø—Ä–æ—Ü–µ—Å—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–Ω–∫–∞
- –°–∏–º—É–ª–∏—Ä—É–µ—Ç —Ä–µ–¥–∏—Ä–µ–∫—Ç –∏ callback
- API: `POST /api/consents/:bankId`

**–®–∞–≥ 4: –í—ã–±–æ—Ä –ø—Ä–æ–¥—É–∫—Ç–æ–≤**
- –ó–∞–≥—Ä—É–∂–∞–µ—Ç –ø—Ä–æ–¥—É–∫—Ç—ã –∏–∑ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö –±–∞–Ω–∫–æ–≤
- –í—ã–±–æ—Ä –∫—Ä–µ–¥–∏—Ç–æ–≤, –≤–∫–ª–∞–¥–æ–≤, –∫–∞—Ä—Ç
- API: `GET /api/products?bank_id=xxx`

**–®–∞–≥ 5: –¶–µ–ª–∏ –∏ —Å—Ç—Ä–∞—Ç–µ–≥–∏—è**
- –í—ã–±–æ—Ä —Ü–µ–ª–∏: –Ω–∞–∫–æ–ø–∏—Ç—å / –∑–∞–∫—Ä—ã—Ç—å –∫—Ä–µ–¥–∏—Ç—ã / –æ–±–∞
- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—É–º–º—ã –∏ —Å–∫–æ—Ä–æ—Å—Ç–∏
- –ü–æ–∫–∞–∑ –ø—Ä–æ–≥–Ω–æ–∑–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤

### 3. Loading/Calculation Screen

- –°–∏–º—É–ª–∏—Ä—É–µ—Ç –∑–∞–≥—Ä—É–∑–∫—É –¥–∞–Ω–Ω—ã—Ö:
  - –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–Ω–∫–∞–º (20%)
  - –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç–æ–≤ (40%)
  - –ê–Ω–∞–ª–∏–∑ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π (60%)
  - –†–∞—Å—á—ë—Ç –º–µ—Ç—Ä–∏–∫ (80%)
  - –ì–æ—Ç–æ–≤–æ (100%)

- –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç `AppState` –Ω–∞ –æ—Å–Ω–æ–≤–µ `OnboardingData`:
  - –°–æ–∑–¥–∞–µ—Ç –º–æ–∫–æ–≤—ã–µ loans, cards, deposits
  - –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç STS, MDP, ADP
  - –§–æ—Ä–º–∏—Ä—É–µ—Ç health score
  - –°–æ–∑–¥–∞–µ—Ç timeline —Å–æ–±—ã—Ç–∏–π

### 4. Home Screen –∏ –¥–µ—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã

- Home –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç:
  - –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –∏–º–µ–Ω–µ–º –∏–∑ `app_state.user.name`
  - Health Widget ‚Üí `app_state.health`
  - STS Widget ‚Üí `app_state.sts.today`
  - Loans/Deposits Widget ‚Üí `app_state.loans` –∏–ª–∏ `app_state.goals`
  - Debit Cards Widget ‚Üí `app_state.balances.total_debit`

- –î–µ—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã –∏—Å–ø–æ–ª—å–∑—É—é—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ `app_state`
- –ù–∏–∫–∞–∫–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –≤–∏–∑—É–∞–ª—å–Ω–æ–º –¥–∏–∑–∞–π–Ω–µ

## –û—Ö—Ä–∞–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏–π
```typescript
const hasConsents = Object.keys(appState.user.consents).length > 0;
```
–ï—Å–ª–∏ –Ω–µ—Ç —Å–æ–≥–ª–∞—Å–∏–π ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–∞–Ω–Ω–µ—Ä "–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –±–∞–Ω–∫–∏"

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–µ–ª–µ–π
```typescript
if (!appState.onboarding.completed) {
  // –ü–æ–∫–∞–∑–∞—Ç—å CTA "–ó–∞–≤–µ—Ä—à–∏—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫—É"
}
```

### –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã
```typescript
const mode = appState.mode; // 'loans' –∏–ª–∏ 'deposits'
```
–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç, –∫–∞–∫–∏–µ –≤–∏–¥–∂–µ—Ç—ã –∏ —ç–∫—Ä–∞–Ω—ã –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å

## –ü—Ä–µ—Å–µ—Ç—ã –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

### Preset A: –ù–∞–∫–æ–ø–ª–µ–Ω–∏—è
```javascript
// –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –≤ Step5 –≤—ã–±—Ä–∞–Ω–æ "save"
{
  mode: 'deposits',
  goal: { type: 'save_money', save: { amount_target: 150000 } },
  linked_banks: 2,
  sts.today > 0
}
```

### Preset B: –ö—Ä–µ–¥–∏—Ç—ã
```javascript
// –°–æ–∑–¥–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –≤ Step5 –≤—ã–±—Ä–∞–Ω–æ "payoff"
{
  mode: 'loans',
  goal: { type: 'close_debts', risk_mode: 'fast' },
  linked_banks: 3,
  loans: 3 –∫—Ä–µ–¥–∏—Ç–∞,
  refinance_candidates: –µ—Å—Ç—å
}
```

## API Binding –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏

–í –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞—Ö –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏ API:
```jsx
<div data-api-binding="balances.total_debit, cards[]">
  {/* –ó–¥–µ—Å—å –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è data –∏–∑ API endpoint */}
</div>
```

## –ü–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏

```javascript
// –í App.tsx
handleNavigate('home')     // –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
handleNavigate('sts')      // STS –¥–µ—Ç–∞–ª–∏
handleNavigate('loans')    // –ö—Ä–µ–¥–∏—Ç—ã –¥–µ—Ç–∞–ª–∏
handleNavigate('deposits') // –í–∫–ª–∞–¥—ã –¥–µ—Ç–∞–ª–∏
handleNavigate('cards')    // –ö–∞—Ä—Ç—ã
handleNavigate('refinance') // –†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ
handleNavigate('profile')  // –ü—Ä–æ—Ñ–∏–ª—å
```

## –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã
- `/screens/SplashScreen.tsx` - –ó–∞—Å—Ç–∞–≤–∫–∞
- `/screens/OnboardingScreen.tsx` - –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
- `/screens/LoadingCalcScreen.tsx` - –ó–∞–≥—Ä—É–∑–∫–∞ –∏ —Ä–∞—Å—á—ë—Ç—ã
- `/screens/HomeScreen.tsx` - –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω
- `/screens/STSDetailScreen.tsx` - –î–µ—Ç–∞–ª–∏ STS
- `/screens/LoansDetailScreen.tsx` - –î–µ—Ç–∞–ª–∏ –∫—Ä–µ–¥–∏—Ç–æ–≤
- `/screens/DepositsDetailScreen.tsx` - –î–µ—Ç–∞–ª–∏ –≤–∫–ª–∞–¥–æ–≤
- `/screens/RefinanceScreen.tsx` - –†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ
- `/screens/CardsScreen.tsx` - –ö–∞—Ä—Ç—ã

### –®–∞–≥–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
- `/components/steps/Step1UserInfo.tsx`
- `/components/steps/Step2BankSelection.tsx`
- `/components/steps/Step3BankConsent.tsx`
- `/components/steps/Step4ProductSelection.tsx`
- `/components/steps/Step5Questions.tsx`

### –í–∏–¥–∂–µ—Ç—ã
- `/components/widgets/HealthWidget.tsx`
- `/components/widgets/STSWidget.tsx`
- `/components/widgets/LoansDepositsWidget.tsx`
- `/components/widgets/DebitCardsWidget.tsx`

## –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

1. –ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å—Ç–∞—Ä—Ç—É–µ—Ç —Å–æ Splash Screen
2. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥—É
3. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Ö–æ–¥–∏—Ç 5 —à–∞–≥–æ–≤ (–∏–ª–∏ –Ω–∞–∂–∏–º–∞–µ—Ç "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" –Ω–∞ —à–∞–≥–µ 1)
4. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è Loading Screen —Å –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä–æ–º
5. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ Home Screen
6. –¢–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–Ω–∞ –≤—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

## –ò–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Ñ–∞–π–ª–∞—Ö

### `/App.tsx`
- –î–æ–±–∞–≤–ª–µ–Ω state —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ—Ç–æ–∫–æ–º (splash ‚Üí onboarding ‚Üí loading ‚Üí app)
- –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ OnboardingData –∏ AppState
- –†–æ—É—Ç–∏–Ω–≥ –º–µ–∂–¥—É –æ—Å–Ω–æ–≤–Ω—ã–º–∏ —ç—Ç–∞–ø–∞–º–∏

### `/data/mockAppState.ts`
- –û–±–Ω–æ–≤–ª–µ–Ω–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ AppState
- –î–æ–±–∞–≤–ª–µ–Ω—ã –ø–æ–ª—è `user` (id, name, consents)
- –û–±–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª–µ `onboarding` (completed, strategy)

### `/screens/HomeScreen.tsx`
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `appState.user.name`
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–≥–ª–∞—Å–∏–π –æ–±–Ω–æ–≤–ª–µ–Ω–∞

## –ß—Ç–æ –ù–ï –∏–∑–º–µ–Ω–∏–ª–æ—Å—å

‚úÖ –î–∏–∑–∞–π–Ω –∏ –≤–µ—Ä—Å—Ç–∫–∞ –≤—Å–µ—Ö —ç–∫—Ä–∞–Ω–æ–≤ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã  
‚úÖ –õ–æ–≥–∏–∫–∞ –≤–∏–¥–∂–µ—Ç–æ–≤ –Ω–µ –∏–∑–º–µ–Ω–∏–ª–∞—Å—å  
‚úÖ –ò–Ω—Ç–µ—Ä–∞–∫—Ü–∏–∏ –∏ –ø–µ—Ä–µ—Ö–æ–¥—ã —Ä–∞–±–æ—Ç–∞—é—Ç –∫–∞–∫ —Ä–∞–Ω—å—à–µ  
‚úÖ –í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã UI (shadcn) —Ä–∞–±–æ—Ç–∞—é—Ç –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π  
‚úÖ –°—Ç–∏–ª–∏ –∏ —Ç–æ–∫–µ–Ω—ã –∏–∑ globals.css –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è  

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ API –≤–º–µ—Å—Ç–æ –º–æ–∫–æ–≤
2. –î–æ–±–∞–≤–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –æ—à–∏–±–æ–∫ API
3. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è (localStorage/API)
4. –î–æ–±–∞–≤–∏—Ç—å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
5. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–æ–≥–ª–∞—Å–∏–π –±–∞–Ω–∫–æ–≤
</file>

<file path="Figma_Front/src/main.tsx">
import { createRoot } from "react-dom/client";
  import App from "./App.tsx";
  import "./index.css";

  createRoot(document.getElementById("root")!).render(<App />);
</file>

<file path="Figma_Front/src/README.md">
# Credit Guard - –ú—É–ª—å—Ç–∏–±–∞–Ω–∫–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ

–ú–æ–±–∏–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–∞–º–∏ –∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è–º–∏ —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ —Å—Ç—Ä–µ—Å—Å-—Ñ—Ä–∏ UX –∏ –µ–¥–∏–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É —Ñ–∏–Ω–∞–Ω—Å–æ–≤.

## üéØ –†–µ—à–∞–µ–º—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π

1. **–ù–µ –≤–∏–¥–∏—Ç –µ–¥–∏–Ω—É—é –∫–∞—Ä—Ç–∏–Ω—É —Å–≤–æ–µ–≥–æ –¥–æ–ª–≥–∞** - –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≤–µ—Å—å –¥–æ–ª–≥ –∏ –≤—Å–µ –∫–∞—Ä—Ç—ã –≤ –æ–¥–Ω–æ–º –º–µ—Å—Ç–µ
2. **–ù–µ –∑–Ω–∞–µ—Ç, –∫–∞–∫–æ–π –∫—Ä–µ–¥–∏—Ç –∑–∞–∫—Ä—ã–≤–∞—Ç—å –ø–µ—Ä–≤—ã–º** - –ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è –ø–æ –º–µ—Ç–æ–¥—É "–ª–∞–≤–∏–Ω—ã –¥–æ–ª–≥–æ–≤" (–≤—ã—Å–æ–∫–∏–µ —Å—Ç–∞–≤–∫–∏ –ø–µ—Ä–≤—ã–º–∏)
3. **–ù–µ –ø–æ–Ω–∏–º–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ —Ç—Ä–∞—Ç–∏—Ç—å** - STS (Safe to Spend) –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–Ω–µ–≤–Ω–æ–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ª–∏–º–∏—Ç

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

### –ì–ª–∞–≤–Ω—ã–π —ç–∫—Ä–∞–Ω (–±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞)

5 –∫–æ–º–ø–∞–∫—Ç–Ω—ã—Ö –≤–∏–¥–∂–µ—Ç–æ–≤:

1. **–§–∏–Ω–∞–Ω—Å–æ–≤–æ–µ –∑–¥–æ—Ä–æ–≤—å–µ** - –∫—Ä—É–≥–æ–≤–æ–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä 0-100 —Å "–¥—ã—Ö–∞–Ω–∏–µ–º"
2. **STS "–°–µ–≥–æ–¥–Ω—è –º–æ–∂–Ω–æ"** - –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è
3. **–ö—Ä–µ–¥–∏—Ç—ã/–¶–µ–ª–∏** - —É–Ω–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤–∏–¥–∂–µ—Ç –¥–ª—è –¥–≤—É—Ö —Ä–µ–∂–∏–º–æ–≤
4. **–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ 30 –¥–Ω–µ–π** - —Ç–∞–π–º–ª–∞–π–Ω –±–ª–∏–∂–∞–π—à–∏—Ö —Å–æ–±—ã—Ç–∏–π
5. **–ï–¥–∏–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∞ –¥–µ–Ω–µ–≥** - –æ–±—â–∏–π –±–∞–ª–∞–Ω—Å –¥–µ–±–µ—Ç–æ–≤—ã—Ö –∫–∞—Ä—Ç

### –ù–∞–≤–∏–≥–∞—Ü–∏—è

–ù–∏–∂–Ω—è—è –ø–∞–Ω–µ–ª—å —Å 5 –≤–∫–ª–∞–¥–∫–∞–º–∏:
- üè† –ì–ª–∞–≤–Ω–∞—è
- üí∞ STS
- üí≥ –ö—Ä–µ–¥–∏—Ç—ã/–¶–µ–ª–∏ (–≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞)
- üîÑ –û—Ñ—Ñ–µ—Ä—ã (—Ä–µ—Ñ–∏–Ω–∞–Ω—Å/–≤–∫–ª–∞–¥—ã)
- üë§ –ü—Ä–æ—Ñ–∏–ª—å

### –î–µ—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã

- **STS Details** - –≥—Ä–∞—Ñ–∏–∫ –Ω–∞ 30 –¥–Ω–µ–π, —Å–æ–±—ã—Ç–∏—è, –±—ã—Å—Ç—Ä—ã–µ –ø–ª–∞—Ç–µ–∂–∏
- **Loans Details** - —Å–ø–∏—Å–æ–∫ –∫—Ä–µ–¥–∏—Ç–æ–≤, –ø—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è, —Å–∏–º—É–ª—è—Ç–æ—Ä –∑–∞–∫—Ä—ã—Ç–∏—è
- **Deposits Details** - —Ç–µ–∫—É—â–∏–π –≤–∫–ª–∞–¥, —Ü–µ–ª—å, –æ—Ñ—Ñ–µ—Ä—ã –±–∞–Ω–∫–æ–≤
- **Refinancing** - –ø–æ–¥–±–æ—Ä –æ—Ñ—Ñ–µ—Ä–æ–≤, –∑–∞—è–≤–∫–∏, —Å—Ç–∞—Ç—É—Å—ã
- **Cards** - –≤—Å–µ –¥–µ–±–µ—Ç–æ–≤—ã–µ –∫–∞—Ä—Ç—ã —Å –±–∞–ª–∞–Ω—Å–∞–º–∏

## üí° –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### Safe to Spend (STS)

–†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –º–æ–∂–Ω–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –ø–æ—Ç—Ä–∞—Ç–∏—Ç—å —Å–µ–≥–æ–¥–Ω—è –ø–æ—Å–ª–µ –≤—Å–µ—Ö –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–ª–∞—Ç–µ–∂–µ–π:

```typescript
STS = –ë–∞–ª–∞–Ω—Å - –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–ª–∞—Ç–µ–∂–∏ - –•–æ–ª–¥—ã - –ó–∞–ø–∞—Å
```

### –ü–ª–∞—Ç–µ–∂–∏

**–î–ª—è —Ä–µ–∂–∏–º–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤:**
- **MDP** (Mandatory Daily Payment) - –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –¥–Ω–µ–≤–Ω–æ–π –ø–ª–∞—Ç—ë–∂
- **ADP** (Additional Daily Payment) - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂ –¥–ª—è —É—Å–∫–æ—Ä–µ–Ω–∏—è –∑–∞–∫—Ä—ã—Ç–∏—è

**–î–ª—è —Ä–µ–∂–∏–º–∞ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π:**
- **SDP** (Savings Daily Payment) - –¥–Ω–µ–≤–Ω–æ–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π

### –°—Ç—Ä–∞—Ç–µ–≥–∏–∏ –∑–∞–∫—Ä—ã—Ç–∏—è

- **–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω–æ** - +5% –∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º
- **–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–æ** - +20% –∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º
- **–ë—ã—Å—Ç—Ä–æ** - +40% –∫ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–º –ø–ª–∞—Ç–µ–∂–∞–º

### –†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥–±–æ—Ä –æ—Ñ—Ñ–µ—Ä–æ–≤ –æ—Ç –±–∞–Ω–∫–æ–≤ —Å —Ä–∞—Å—á—ë—Ç–æ–º:
- –≠–∫–æ–Ω–æ–º–∏–∏ –≤ —Ä—É–±–ª—è—Ö
- –û–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ (breakeven) –≤ –º–µ—Å—è—Ü–∞—Ö
- –ù–æ–≤–æ–≥–æ –µ–∂–µ–º–µ—Å—è—á–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞

## üé® –î–∏–∑–∞–π–Ω-—Å–∏—Å—Ç–µ–º–∞

### –¶–≤–µ—Ç–∞

**–ê–∫—Ü–µ–Ω—Ç–Ω—ã–π:** –§–∏–æ–ª–µ—Ç–æ–≤—ã–π (`#7c3aed`)

**–°—Ç–∞—Ç—É—Å—ã —Ñ–∏–Ω–∑–¥–æ—Ä–æ–≤—å—è:**
- üü¢ –°–ø–æ–∫–æ–π–Ω–æ - –∑–µ–ª—ë–Ω—ã–π (`#10b981`)
- üü° –í–Ω–∏–º–∞–Ω–∏–µ - –∂—ë–ª—Ç—ã–π (`#f59e0b`)  
- üü£ –ù—É–∂–µ–Ω –ø–ª–∞–Ω - —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (`#8b5cf6`)

**–°—Ç—Ä–µ—Å—Å-—Ñ—Ä–∏ –ø–∞–ª–∏—Ç—Ä–∞:** –±–µ–∑ –∫—Ä–∞—Å–Ω–æ–≥–æ –∏ –æ—Ä–∞–Ω–∂–µ–≤–æ–≥–æ –¥–ª—è —Å–Ω–∏–∂–µ–Ω–∏—è —Ç—Ä–µ–≤–æ–∂–Ω–æ—Å—Ç–∏

### –¢–∏–ø–æ–≥—Ä–∞—Ñ–∏–∫–∞

- H1: 24px / 32px
- H2: 20px / 28px
- Body: 16px / 24px
- Button: 14px / 16px
- Caption: 12px / 16px

### Spacing

8-pt grid —Å–∏—Å—Ç–µ–º–∞

### –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤

- –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä touch-–∑–æ–Ω—ã: 44√ó44pt
- –†–∞–¥–∏—É—Å—ã: 16px / 24px –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
- –¢–µ–Ω–∏: –ª—ë–≥–∫–∏–µ, —Ç—Ä—ë—Ö—É—Ä–æ–≤–Ω–µ–≤—ã–µ

## üîå API Ready

### Data Bindings

–í—Å–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –∏–º–µ—é—Ç –∞—Ç—Ä–∏–±—É—Ç—ã `data-api-binding` –¥–ª—è —Å–≤—è–∑–∏ —Å —Ä–µ–∞–ª—å–Ω—ã–º API:

```typescript
// Health widget
data-api-binding="health.score, health.status, health.next_action"

// STS widget  
data-api-binding="sts.today.amount, sts.today.spent, sts.tomorrow.impact"

// Loans widget
data-api-binding="loans.summary.total_outstanding, loans.summary.mandatory_daily_payment"
```

### Action Hooks

–í—Å–µ –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–º–µ—é—Ç `data-action` –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏:

```typescript
data-action="pay_mdp()"
data-action="pay_adp()"
data-action="pay_sdp()"
data-action="recalc_sts()"
data-action="submit_refi_application(offer_id)"
data-action="refresh_balances()"
```

## üöÄ –î–≤–∞ —Ä–µ–∂–∏–º–∞ —Ä–∞–±–æ—Ç—ã

### –†–µ–∂–∏–º "–ö—Ä–µ–¥–∏—Ç—ã" (Loans Mode)

- –§–æ–∫—É—Å –Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏–∏ –¥–æ–ª–≥–æ–≤
- MDP/ADP –ø–ª–∞—Ç–µ–∂–∏
- –ü—Ä–∏–æ—Ä–∏—Ç–µ–∑–∞—Ü–∏—è –∫—Ä–µ–¥–∏—Ç–æ–≤
- –†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤

### –†–µ–∂–∏–º "–ù–∞–∫–æ–ø–ª–µ–Ω–∏—è" (Deposits Mode)

- –§–æ–∫—É—Å –Ω–∞ –¥–æ—Å—Ç–∏–∂–µ–Ω–∏–∏ —Ü–µ–ª–µ–π
- SDP –ø–ª–∞—Ç–µ–∂–∏
- –ü—Ä–æ–≥—Ä–µ—Å—Å –∫ —Ü–µ–ª–∏
- –ü–æ–¥–±–æ—Ä –≤–∫–ª–∞–¥–æ–≤ —Å –ª—É—á—à–∏–º–∏ —Å—Ç–∞–≤–∫–∞–º–∏

**–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ:** –ü—Ä–æ—Ñ–∏–ª—å ‚Üí "–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º"

## üì± Responsive Design

- Mobile-first –ø–æ–¥—Ö–æ–¥
- –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –¥–ª—è 390√ó844pt (iPhone)
- –í—Å–µ –≤–∏–¥–∂–µ—Ç—ã –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞ –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞
- –î–µ—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã —Å–∫—Ä–æ–ª–ª–∏—Ä—É–µ–º—ã–µ

## üîê –î–∞–Ω–Ω—ã–µ –∏ Privacy

- Mock-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –¥–µ–º–æ
- –ì–æ—Ç–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è Open Banking API
- –°—Ç–∞—Ç—É—Å—ã —Å–æ–≥–ª–∞—Å–∏–π: granted/pending/denied
- KYC-—É—Ä–æ–≤–Ω–∏ –¥–ª—è –æ—Ñ—Ñ–µ—Ä–æ–≤

## üéØ –ü–æ—Ç–æ–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –û–ø–ª–∞—Ç–∞ –∫—Ä–µ–¥–∏—Ç–∞

1. –ì–ª–∞–≤–Ω–∞—è ‚Üí –í–∏–¥–∂–µ—Ç "–ö—Ä–µ–¥–∏—Ç—ã" ‚Üí –ö–Ω–æ–ø–∫–∞ "MDP"/"ADP"
2. –û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã —Å preview —ç—Ñ—Ñ–µ–∫—Ç–∞ –Ω–∞ STS
3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
4. –ê–≤—Ç–æ–ø–µ—Ä–µ—Å—á—ë—Ç STS, –±–∞–ª–∞–Ω—Å–æ–≤, –¥–æ–ª–≥–∞

### –†–µ—Ñ–∏–Ω–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–∏–µ

1. –ì–ª–∞–≤–Ω–∞—è ‚Üí –ù–∞–≤–∏–≥–∞—Ü–∏—è "–û—Ñ—Ñ–µ—Ä—ã"
2. –ü—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –æ—Ñ—Ñ–µ—Ä–æ–≤ —Å —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π –ø–æ —ç–∫–æ–Ω–æ–º–∏–∏
3. –í—ã–±–æ—Ä –æ—Ñ—Ñ–µ—Ä–∞
4. –ü–æ–¥–∞—á–∞ –∑–∞—è–≤–∫–∏
5. –°—Ç–∞—Ç—É—Å—ã: pending ‚Üí approved/declined
6. –ü—Ä–∏ approved: –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –∏ STS

### –ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π

1. –ì–ª–∞–≤–Ω–∞—è ‚Üí –í–∏–¥–∂–µ—Ç "–¶–µ–ª–∏" ‚Üí –ö–Ω–æ–ø–∫–∞ "SDP"
2. –û–∫–Ω–æ –æ–ø–ª–∞—Ç—ã —Å preview —ç—Ñ—Ñ–µ–∫—Ç–∞
3. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –≤–∫–ª–∞–¥–∞ –∏ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∫ —Ü–µ–ª–∏

## üì¶ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ñ–∞–π–ª–æ–≤

```
/
‚îú‚îÄ‚îÄ App.tsx                     # –ì–ª–∞–≤–Ω—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç —Å –Ω–∞–≤–∏–≥–∞—Ü–∏–µ–π
‚îú‚îÄ‚îÄ data/
‚îÇ   ‚îî‚îÄ‚îÄ mockAppState.ts        # Mock-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ–±–æ–∏—Ö —Ä–µ–∂–∏–º–æ–≤
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ widgets/               # –í–∏–¥–∂–µ—Ç—ã –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ HealthWidget.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ STSWidget.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoansDepositsWidget.tsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ TimelineWidget.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ DebitCardsWidget.tsx
‚îÇ   ‚îú‚îÄ‚îÄ BottomNav.tsx          # –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
‚îÇ   ‚îî‚îÄ‚îÄ PaymentSheet.tsx       # –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ–ø–ª–∞—Ç—ã
‚îú‚îÄ‚îÄ screens/                   # –î–µ—Ç–∞–ª—å–Ω—ã–µ —ç–∫—Ä–∞–Ω—ã
‚îÇ   ‚îú‚îÄ‚îÄ HomeScreen.tsx
‚îÇ   ‚îú‚îÄ‚îÄ STSDetailScreen.tsx
‚îÇ   ‚îú‚îÄ‚îÄ LoansDetailScreen.tsx
‚îÇ   ‚îú‚îÄ‚îÄ DepositsDetailScreen.tsx
‚îÇ   ‚îú‚îÄ‚îÄ RefinanceScreen.tsx
‚îÇ   ‚îî‚îÄ‚îÄ CardsScreen.tsx
‚îú‚îÄ‚îÄ utils/
‚îÇ   ‚îî‚îÄ‚îÄ formatters.ts          # –£—Ç–∏–ª–∏—Ç—ã —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
‚îî‚îÄ‚îÄ styles/
    ‚îî‚îÄ‚îÄ globals.css            # –î–∏–∑–∞–π–Ω-—Ç–æ–∫–µ–Ω—ã –∏ —Å—Ç–∏–ª–∏
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∂–∏–º–æ–≤

–í `App.tsx` –∏–∑–º–µ–Ω–∏—Ç–µ –Ω–∞—á–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ:

```typescript
// –†–µ–∂–∏–º –∫—Ä–µ–¥–∏—Ç–æ–≤
const [appState, setAppState] = useState<AppState>(mockAppState);

// –†–µ–∂–∏–º –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–π
const [appState, setAppState] = useState<AppState>(mockAppStateDeposits);
```

–ò–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –≤ –ø—Ä–æ—Ñ–∏–ª–µ.

## ‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ UX

- **Breathing animation** - –ø—É–ª—å—Å–∞—Ü–∏—è –∫—Ä—É–≥–∞ —Ñ–∏–Ω–∑–¥–æ—Ä–æ–≤—å—è
- **Preview –ø–ª–∞—Ç–µ–∂–µ–π** - –ø–æ–∫–∞–∑ —ç—Ñ—Ñ–µ–∫—Ç–∞ –¥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
- **Stress-free —Ü–≤–µ—Ç–∞** - –±–µ–∑ –∫—Ä–∞—Å–Ω–æ–≥–æ –∏ –æ—Ä–∞–Ω–∂–µ–≤–æ–≥–æ
- **Above-the-fold** - –≤—Å–µ –≤–∏–¥–∂–µ—Ç—ã –±–µ–∑ —Å–∫—Ä–æ–ª–ª–∞
- **Toast —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è** - –æ–±—Ä–∞—Ç–Ω–∞—è —Å–≤—è–∑—å –ø–æ—Å–ª–µ –¥–µ–π—Å—Ç–≤–∏–π
- **Skeleton states** - –∑–∞–≥–ª—É—à–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
- **Empty states** - –ø–æ–Ω—è—Ç–Ω—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –¥–∞–Ω–Ω—ã—Ö

## üéì –í–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ

–î–∏–∑–∞–π–Ω –≤–¥–æ—Ö–Ω–æ–≤–ª—ë–Ω:
- **Peek Finance** - –º–∏–Ω–∏–º–∞–ª–∏–∑–º, —á–∏—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å
- **Whoop** - health scoring, breathing animations
- **N26** - mobile-first navigation
- **Revolut** - unified money view

## üìÑ –õ–∏—Ü–µ–Ω–∑–∏—è

MIT
</file>

<file path="Figma_Front/index.html">
<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Main screens</title>
    </head>

    <body>
      <div id="root"></div>
      <script type="module" src="/src/main.tsx"></script>
    </body>
  </html>
</file>

<file path="Figma_Front/package.json">
{
      "name": "Main screens",
      "version": "0.1.0",
      "private": true,
      "dependencies": {
          "@radix-ui/react-accordion": "^1.2.3",
          "@radix-ui/react-alert-dialog": "^1.1.6",
          "@radix-ui/react-aspect-ratio": "^1.1.2",
          "@radix-ui/react-avatar": "^1.1.3",
          "@radix-ui/react-checkbox": "^1.1.4",
          "@radix-ui/react-collapsible": "^1.1.3",
          "@radix-ui/react-context-menu": "^2.2.6",
          "@radix-ui/react-dialog": "^1.1.6",
          "@radix-ui/react-dropdown-menu": "^2.1.6",
          "@radix-ui/react-hover-card": "^1.1.6",
          "@radix-ui/react-label": "^2.1.2",
          "@radix-ui/react-menubar": "^1.1.6",
          "@radix-ui/react-navigation-menu": "^1.2.5",
          "@radix-ui/react-popover": "^1.1.6",
          "@radix-ui/react-progress": "^1.1.2",
          "@radix-ui/react-radio-group": "^1.2.3",
          "@radix-ui/react-scroll-area": "^1.2.3",
          "@radix-ui/react-select": "^2.1.6",
          "@radix-ui/react-separator": "^1.1.2",
          "@radix-ui/react-slider": "^1.2.3",
          "@radix-ui/react-slot": "^1.1.2",
          "@radix-ui/react-switch": "^1.1.3",
          "@radix-ui/react-tabs": "^1.1.3",
          "@radix-ui/react-toggle": "^1.1.2",
          "@radix-ui/react-toggle-group": "^1.1.2",
          "@radix-ui/react-tooltip": "^1.1.8",
          "class-variance-authority": "^0.7.1",
          "clsx": "*",
          "cmdk": "^1.1.1",
          "embla-carousel-react": "^8.6.0",
          "input-otp": "^1.4.2",
          "lucide-react": "^0.487.0",
          "next-themes": "^0.4.6",
          "react": "^18.3.1",
          "react-day-picker": "^8.10.1",
          "react-dom": "^18.3.1",
          "react-hook-form": "^7.55.0",
          "react-resizable-panels": "^2.1.7",
          "recharts": "^2.15.2",
          "sonner": "^2.0.3",
          "tailwind-merge": "*",
          "tailwindcss": "*",
          "vaul": "^1.1.2"
      },
      "devDependencies": {
          "@types/node": "^20.10.0",
          "@vitejs/plugin-react-swc": "^3.10.2",
          "vite": "6.3.5"
      },
      "scripts": {
          "dev": "vite",
          "build": "vite build"
      }
  }
</file>

<file path="Figma_Front/vite.config.ts">
import { defineConfig } from 'vite';
  import react from '@vitejs/plugin-react-swc';
  import path from 'path';

  export default defineConfig({
    plugins: [react()],
    resolve: {
      extensions: ['.js', '.jsx', '.ts', '.tsx', '.json'],
      alias: {
        'vaul@1.1.2': 'vaul',
        'sonner@2.0.3': 'sonner',
        'recharts@2.15.2': 'recharts',
        'react-resizable-panels@2.1.7': 'react-resizable-panels',
        'react-hook-form@7.55.0': 'react-hook-form',
        'react-day-picker@8.10.1': 'react-day-picker',
        'next-themes@0.4.6': 'next-themes',
        'lucide-react@0.487.0': 'lucide-react',
        'input-otp@1.4.2': 'input-otp',
        'embla-carousel-react@8.6.0': 'embla-carousel-react',
        'cmdk@1.1.1': 'cmdk',
        'class-variance-authority@0.7.1': 'class-variance-authority',
        '@radix-ui/react-tooltip@1.1.8': '@radix-ui/react-tooltip',
        '@radix-ui/react-toggle@1.1.2': '@radix-ui/react-toggle',
        '@radix-ui/react-toggle-group@1.1.2': '@radix-ui/react-toggle-group',
        '@radix-ui/react-tabs@1.1.3': '@radix-ui/react-tabs',
        '@radix-ui/react-switch@1.1.3': '@radix-ui/react-switch',
        '@radix-ui/react-slot@1.1.2': '@radix-ui/react-slot',
        '@radix-ui/react-slider@1.2.3': '@radix-ui/react-slider',
        '@radix-ui/react-separator@1.1.2': '@radix-ui/react-separator',
        '@radix-ui/react-select@2.1.6': '@radix-ui/react-select',
        '@radix-ui/react-scroll-area@1.2.3': '@radix-ui/react-scroll-area',
        '@radix-ui/react-radio-group@1.2.3': '@radix-ui/react-radio-group',
        '@radix-ui/react-progress@1.1.2': '@radix-ui/react-progress',
        '@radix-ui/react-popover@1.1.6': '@radix-ui/react-popover',
        '@radix-ui/react-navigation-menu@1.2.5': '@radix-ui/react-navigation-menu',
        '@radix-ui/react-menubar@1.1.6': '@radix-ui/react-menubar',
        '@radix-ui/react-label@2.1.2': '@radix-ui/react-label',
        '@radix-ui/react-hover-card@1.1.6': '@radix-ui/react-hover-card',
        '@radix-ui/react-dropdown-menu@2.1.6': '@radix-ui/react-dropdown-menu',
        '@radix-ui/react-dialog@1.1.6': '@radix-ui/react-dialog',
        '@radix-ui/react-context-menu@2.2.6': '@radix-ui/react-context-menu',
        '@radix-ui/react-collapsible@1.1.3': '@radix-ui/react-collapsible',
        '@radix-ui/react-checkbox@1.1.4': '@radix-ui/react-checkbox',
        '@radix-ui/react-avatar@1.1.3': '@radix-ui/react-avatar',
        '@radix-ui/react-aspect-ratio@1.1.2': '@radix-ui/react-aspect-ratio',
        '@radix-ui/react-alert-dialog@1.1.6': '@radix-ui/react-alert-dialog',
        '@radix-ui/react-accordion@1.2.3': '@radix-ui/react-accordion',
        '@': path.resolve(__dirname, './src'),
      },
    },
    build: {
      target: 'esnext',
      outDir: 'build',
    },
    server: {
      port: 3000,
      open: true,
    },
  });
</file>

<file path="hktn/backend/routers/__init__.py">
from . import analytics, banks, consents, onboarding, profile

__all__ = ["analytics", "banks", "consents", "onboarding", "profile"]
</file>

<file path="hktn/backend/routers/analytics.py">
from __future__ import annotations

from fastapi import APIRouter

from ..schemas import AnalysisRequest, FinancialPortraitRequest, IngestRequest
from ..services import analytics

router = APIRouter(prefix="/api", tags=["analytics"])


@router.get("/credits")
async def get_user_credits(user_id: str):
    return await analytics.get_user_credits(user_id)


@router.get("/dashboard")
async def get_dashboard_metrics(user_id: str):
    return await analytics.get_dashboard_metrics(user_id)


@router.post("/financial-portrait")
async def build_financial_portrait(req: FinancialPortraitRequest):
    return await analytics.build_financial_portrait_view(req)


@router.post("/ingest/run")
async def run_initial_ingestion(req: IngestRequest):
    return await analytics.run_initial_ingestion(req)


@router.post("/analyze")
async def start_analysis(req: AnalysisRequest):
    return await analytics.start_analysis(req)
</file>

<file path="hktn/backend/routers/banks.py">
from __future__ import annotations

from fastapi import APIRouter

from ..services import banking

router = APIRouter(prefix="/api", tags=["banks"])


@router.get("/banks")
async def list_banks(user_id: str | None = None):
    return banking.list_banks(user_id)


@router.get("/banks/{bank_id}/bootstrap")
async def bootstrap_bank(bank_id: str, user_id: str):
    return await banking.bootstrap_bank(bank_id, user_id)
</file>

<file path="hktn/backend/routers/onboarding.py">
from __future__ import annotations

from fastapi import APIRouter

from ..schemas import IngestRequest, OnboardingCommitRequest, PreviewResponse, ProductConsentRequest
from ..services import onboarding

router = APIRouter(prefix="/api", tags=["onboarding"])


@router.post("/ingest/preview", response_model=PreviewResponse)
async def preview_products(req: IngestRequest):
    return await onboarding.preview_products(req)


@router.post("/products/consent")
async def save_product_consents(req: ProductConsentRequest):
    return onboarding.save_product_consents(req)


@router.post("/onboarding/commit")
async def finalize_onboarding(req: OnboardingCommitRequest):
    return onboarding.finalize_onboarding(req)


@router.get("/app/state")
async def get_app_state(user_id: str, include_portrait: bool = False):
    return await onboarding.load_app_state(user_id, include_portrait)
</file>

<file path="hktn/backend/services/products.py">
from __future__ import annotations

import uuid
from datetime import date, datetime
from typing import Any, Dict, List, Optional, Sequence, Tuple

from ..config import settings

BALANCE_FIELDS: Tuple[str, ...] = (
    "outstanding_balance",
    "outstandingBalance",
    "remaining_balance",
    "remainingBalance",
    "balance",
    "current_balance",
    "currentBalance",
    "principal",
    "principal_amount",
    "principalAmount",
    "amount",
    "available_balance",
    "availableBalance",
    "total_balance",
    "totalBalance",
)

PAYMENT_FIELDS: Tuple[str, ...] = (
    "min_payment",
    "minimum_payment",
    "payment",
    "monthly_payment",
    "monthlyPayment",
    "scheduled_payment",
    "installment_amount",
    "installmentAmount",
)

RATE_FIELDS: Tuple[str, ...] = (
    "rate",
    "interest_rate",
    "interestRate",
    "apr",
    "percentage",
    "rate_percent",
    "ratePercent",
)

DATE_FIELDS: Tuple[str, ...] = (
    "next_payment_date",
    "nextPaymentDate",
    "due_date",
    "dueDate",
    "payment_due_date",
    "paymentDueDate",
    "maturity_date",
    "maturityDate",
)


def _coerce_number(value: Any) -> Optional[float]:
    if value is None:
        return None
    if isinstance(value, (int, float)) and not isinstance(value, bool):
        return float(value)
    if isinstance(value, str):
        try:
            normalized = value.strip().replace("\u00a0", "").replace(" ", "").replace(",", ".")
            return float(normalized)
        except ValueError:
            return None
    if isinstance(value, dict):
        for nested_key in ("amount", "value", "balance", "current", "val"):
            if nested_key in value:
                nested = _coerce_number(value[nested_key])
                if nested is not None:
                    return nested
    if isinstance(value, (list, tuple)):
        for item in value:
            nested = _coerce_number(item)
            if nested is not None:
                return nested
    return None


def _extract_number(payload: Dict[str, Any], field_names: Sequence[str]) -> Optional[float]:
    for key in field_names:
        if key in payload:
            number = _coerce_number(payload[key])
            if number is not None:
                return number
    return None


def _extract_date(payload: Dict[str, Any], field_names: Sequence[str]) -> Optional[str]:
    for key in field_names:
        raw_value = payload.get(key)
        if not raw_value:
            continue
        if isinstance(raw_value, datetime):
            return raw_value.date().isoformat()
        if isinstance(raw_value, date):
            return raw_value.isoformat()
        if isinstance(raw_value, str):
            try:
                normalized = raw_value.replace("Z", "")
                return datetime.fromisoformat(normalized).date().isoformat()
            except ValueError:
                try:
                    return datetime.strptime(normalized, "%Y-%m-%dT%H:%M:%S").date().isoformat()
                except Exception:  # noqa: BLE001
                    continue
    return None


def _infer_product_type(candidates: Sequence[Optional[str]], default_type: str) -> str:
    for candidate in candidates:
        if not candidate:
            continue
        lowered = str(candidate).lower()
        if any(token in lowered for token in ("credit card", "creditcard", "–∫—Ä–µ–¥–∏—Ç–Ω–∞—è –∫–∞—Ä—Ç–∞")):
            return "credit_card"
        if "card" in lowered and any(token in lowered for token in ("credit", "–∫—Ä–µ–¥–∏—Ç")):
            return "credit_card"
        if any(token in lowered for token in ("debit", "–¥–µ–±–µ—Ç", "checking")) and "card" in lowered:
            return "debit_card"
        if any(token in lowered for token in ("deposit", "–≤–∫–ª–∞–¥", "–Ω–∞–∫–æ–ø", "savings")):
            return "deposit"
        if any(token in lowered for token in ("loan", "–∫—Ä–µ–¥–∏—Ç", "–∏–ø–æ—Ç–µ–∫–∞", "installment")):
            return "loan"
    return default_type


def build_account_product(account: Dict[str, Any], bank_id: str) -> Optional[Dict[str, Any]]:
    if not isinstance(account, dict):
        return None
    config = settings.banks.get(bank_id)
    bank_name = config.display_name if config else bank_id
    account_id = (
        account.get("accountId")
        or account.get("account_id")
        or account.get("id")
        or account.get("resource_id")
        or str(uuid.uuid4())
    )
    balance = _extract_number(account, BALANCE_FIELDS)
    rate = _extract_number(account, RATE_FIELDS)
    rate_value = None
    if rate is not None:
        rate_value = round(rate * 100, 2) if rate <= 1 else round(rate, 2)
    product_type = _infer_product_type(
        (
            str(account.get("product_type")),
            str(account.get("accountSubType")),
            str(account.get("accountType")),
            str(account.get("nickname")),
        ),
        "debit_card",
    )
    name = (
        account.get("nickname")
        or account.get("accountName")
        or account.get("product")
        or account.get("product_name")
        or "–°—á–µ—Ç"
    )
    return {
        "id": account_id,
        "type": product_type,
        "product_type": product_type,
        "name": name,
        "bank_id": bank_id,
        "bank_name": bank_name,
        "consented": False,
        "tos_url": account.get("tos_url") or "#",
        "outstanding_balance": round(balance, 2) if balance is not None else None,
        "balance": round(balance, 2) if balance is not None else None,
        "min_payment": None,
        "next_payment_date": None,
        "rate": rate_value,
        "raw_product": account,
    }


def build_credit_product(credit: Dict[str, Any], bank_id: str) -> Optional[Dict[str, Any]]:
    if not isinstance(credit, dict):
        return None
    config = settings.banks.get(bank_id)
    bank_name = config.display_name if config else bank_id
    credit_id = (
        credit.get("agreement_id")
        or credit.get("credit_id")
        or credit.get("id")
        or str(uuid.uuid4())
    )
    balance = _extract_number(credit, BALANCE_FIELDS)
    min_payment = _extract_number(credit, PAYMENT_FIELDS)
    next_payment = _extract_date(credit, DATE_FIELDS)
    rate = _extract_number(credit, RATE_FIELDS)
    normalized_rate = None
    if rate is not None:
        normalized_rate = round(rate * 100, 2) if rate <= 1 else round(rate, 2)
    product_type = _infer_product_type(
        (
            str(credit.get("product_type")),
            str(credit.get("type")),
            str(credit.get("product")),
            str(credit.get("name")),
        ),
        "loan",
    )
    name = credit.get("name") or credit.get("product_name") or credit.get("product") or "–ö—Ä–µ–¥–∏—Ç"
    return {
        "id": credit_id,
        "type": product_type,
        "product_type": product_type,
        "name": name,
        "bank_id": bank_id,
        "bank_name": bank_name,
        "consented": False,
        "tos_url": credit.get("tos_url") or "#",
        "outstanding_balance": round(balance, 2) if balance is not None else None,
        "balance": round(balance, 2) if balance is not None else None,
        "min_payment": round(min_payment, 2) if min_payment is not None else None,
        "next_payment_date": next_payment,
        "rate": normalized_rate,
        "raw_product": credit,
    }


def group_products_by_bank(
    accounts: Sequence[Dict[str, Any]],
    credits: Sequence[Dict[str, Any]],
) -> Dict[str, List[Dict[str, Any]]]:
    grouped: Dict[str, List[Dict[str, Any]]] = {}
    for product in list(accounts) + list(credits):
        bank_id = product.get("bank_id") or "unknown"
        grouped.setdefault(bank_id, []).append(product)
    return grouped


def apply_consent_flags(
    products_by_bank: Dict[str, List[Dict[str, Any]]],
    product_consents: Sequence[Dict[str, Any]] | None,
) -> Dict[str, List[Dict[str, Any]]]:
    if not product_consents:
        return products_by_bank
    index = {
        (item.get("bank_id"), item.get("product_id")): bool(item.get("consented"))
        for item in product_consents
    }
    for bank_products in products_by_bank.values():
        for product in bank_products:
            key = (product.get("bank_id"), product.get("id"))
            if key in index:
                product["consented"] = index[key]
    return products_by_bank
</file>

<file path="hktn/backend/__init__.py">
from .app import create_app

__all__ = ["create_app"]
</file>

<file path="hktn/backend/config.py">
from __future__ import annotations

import os
from pathlib import Path
from typing import Dict, List, Optional

from dotenv import load_dotenv

BASE_DIR = Path(__file__).resolve().parent.parent
load_dotenv(BASE_DIR / ".env")


class BankConfig(dict):
    """Dictionary-backed bank configuration with attribute helpers."""

    def __init__(self, display_name: str, url: Optional[str]):
        super().__init__(display_name=display_name, url=url)

    @property
    def display_name(self) -> str:
        return self.get("display_name", "")

    @display_name.setter
    def display_name(self, value: str) -> None:
        self["display_name"] = value

    @property
    def url(self) -> Optional[str]:
        return self.get("url")

    @url.setter
    def url(self, value: Optional[str]) -> None:
        self["url"] = value


def _build_bank_configs() -> Dict[str, BankConfig]:
    """Load partner bank configuration from environment variables."""
    return {
        "vbank": BankConfig(display_name="VBank", url=os.getenv("VBANK_API_URL")),
        "abank": BankConfig(display_name="ABank", url=os.getenv("ABANK_API_URL")),
        "sbank": BankConfig(display_name="SBank", url=os.getenv("SBANK_API_URL")),
    }


class Settings:
    """Runtime settings shared across the backend application."""

    def __init__(self) -> None:
        self.title: str = "FinPulse Experience API"
        self.version: str = "4.0.0"
        self.frontend_url: str = os.getenv("FRONTEND_URL", "http://localhost:5173")
        self.cors_origins: List[str] = [
            "http://localhost:3000",
            "http://localhost:5173",
            "http://127.0.0.1:5173",
        ]
        self.api_cache_ttl: int = int(os.getenv("API_CACHE_TTL", "300"))
        self.api_cache_size: int = int(os.getenv("API_CACHE_SIZE", "100"))
        self.team_client_id: Optional[str] = os.getenv("CLIENT_ID")
        self.team_client_secret: Optional[str] = os.getenv("CLIENT_SECRET")
        self.banks: Dict[str, BankConfig] = _build_bank_configs()


settings = Settings()
</file>

<file path="hktn/backend/schemas.py">
from __future__ import annotations

from datetime import date, timedelta
from typing import Any, Dict, List, Optional

from pydantic import BaseModel, Field


class ConsentInitiateRequest(BaseModel):
    user_id: str
    bank_id: str


class AnalysisRequest(BaseModel):
    user_id: str
    current_balance: float = 50_000.0
    payment_date: date = Field(default_factory=lambda: date.today() + timedelta(days=15))
    payment_amount: float = 25_000.0


class GoalRequest(BaseModel):
    user_id: str
    goal_type: str
    goal_details: Dict[str, Any]


class IngestRequest(BaseModel):
    user_id: str
    user_name: Optional[str] = None


class FinancialPortraitRequest(BaseModel):
    user_id: str
    user_name: Optional[str] = None
    goal_type: Optional[str] = None
    pace: Optional[str] = None
    goal_details: Optional[Dict[str, Any]] = None
    force_error_for_bank: Optional[str] = None


class ProductConsentItem(BaseModel):
    bank_id: str
    product_id: str
    product_type: Optional[str] = None
    consented: bool


class ProductConsentRequest(BaseModel):
    user_id: str
    items: List[ProductConsentItem]


class OnboardingCommitRequest(BaseModel):
    user_id: str


class PreviewResponse(BaseModel):
    productsByBank: Dict[str, List[Dict[str, Any]]]
    latestConsentState: List[Dict[str, Any]] = Field(default_factory=list)
</file>

<file path="hktn/backend/state.py">
from __future__ import annotations

from cachetools import TTLCache

from .config import settings

# Shared cache for expensive banking API calls.
api_cache: TTLCache[str, dict] = TTLCache(maxsize=settings.api_cache_size, ttl=settings.api_cache_ttl)
</file>

<file path="hktn/core/__init__.py">
"""Core package exposing primary interfaces for the FinPulse project."""

from .analytics_engine import build_financial_portrait, run_analysis, UserGoal
from .data_models import AnalysisResult, Transaction
from .obr_client import ConsentInitResult, OBRAPIClient

__all__ = [
    "run_analysis",
    "build_financial_portrait",
    "UserGoal",
    "OBRAPIClient",
    "ConsentInitResult",
    "AnalysisResult",
    "Transaction",
]
</file>

<file path="hktn/src/components/__tests__/BanksList.test.js">
import { jsx as _jsx } from "react/jsx-runtime";
import { render, screen } from '@testing-library/react';
import { describe, expect, it, vi } from 'vitest';
import { BanksList } from '../BanksList';
describe('BanksList', () => {
    it('renders empty state', () => {
        const onConnect = vi.fn();
        render(_jsx(BanksList, { banks: [], onConnect: onConnect }));
        expect(screen.getByText(/–∫–∞—Ç–∞–ª–æ–≥ –±–∞–Ω–∫–æ–≤ –ø—É—Å—Ç/i)).toBeInTheDocument();
    });
    it('disables button when already connected', () => {
        const onConnect = vi.fn();
        const banks = [{ id: 'demo', name: 'Demo', connected: true }];
        render(_jsx(BanksList, { banks: banks, onConnect: onConnect }));
        expect(screen.getByRole('button', { name: /–≥–æ—Ç–æ–≤–æ/i })).toBeDisabled();
    });
});
</file>

<file path="hktn/src/components/__tests__/BanksList.test.tsx">
import { render, screen } from '@testing-library/react';
import { describe, expect, it, vi } from 'vitest';
import { BanksList } from '../BanksList';
import type { BankSummary } from '../../state/useUser';

describe('BanksList', () => {
  it('renders empty state', () => {
    const onConnect = vi.fn();
    render(<BanksList banks={[]} onConnect={onConnect} />);
    expect(screen.getByText(/–∫–∞—Ç–∞–ª–æ–≥ –±–∞–Ω–∫–æ–≤ –ø—É—Å—Ç/i)).toBeInTheDocument();
  });

  it('disables button when already connected', () => {
    const onConnect = vi.fn();
    const banks: BankSummary[] = [{ id: 'demo', name: 'Demo', connected: true }];
    render(<BanksList banks={banks} onConnect={onConnect} />);
    expect(screen.getByRole('button', { name: /–≥–æ—Ç–æ–≤–æ/i })).toBeDisabled();
  });
});
</file>

<file path="hktn/src/components/__tests__/UserIdForm.test.js">
import { jsx as _jsx } from "react/jsx-runtime";
import { fireEvent, render, screen } from '@testing-library/react';
import { describe, expect, it, vi } from 'vitest';
import { UserIdForm } from '../UserIdForm';
describe('UserIdForm', () => {
    it('validates demo-XXX format', () => {
        const handleSubmit = vi.fn();
        render(_jsx(UserIdForm, { onSubmit: handleSubmit }));
        const input = screen.getByLabelText(/user id/i);
        fireEvent.change(input, { target: { value: 'foo' } });
        fireEvent.click(screen.getByRole('button', { name: /–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å/i }));
        expect(screen.getByRole('alert')).toHaveTextContent('demo-XXX');
        expect(handleSubmit).not.toHaveBeenCalled();
    });
});
</file>

<file path="hktn/src/components/__tests__/UserIdForm.test.tsx">
import { fireEvent, render, screen } from '@testing-library/react';
import { describe, expect, it, vi } from 'vitest';
import { UserIdForm } from '../UserIdForm';

describe('UserIdForm', () => {
  it('validates demo-XXX format', () => {
    const handleSubmit = vi.fn();
    render(<UserIdForm onSubmit={handleSubmit} />);

    const input = screen.getByLabelText(/user id/i);
    fireEvent.change(input, { target: { value: 'foo' } });
    fireEvent.click(screen.getByRole('button', { name: /–ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å/i }));

    expect(screen.getByRole('alert')).toHaveTextContent('demo-XXX');
    expect(handleSubmit).not.toHaveBeenCalled();
  });
});
</file>

<file path="hktn/src/components/BanksList.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
export const BanksList = ({ banks, onConnect, busyBankId }) => {
    if (!banks.length) {
        return (_jsx("div", { className: "card", children: _jsx("p", { children: "\u041A\u0430\u0442\u0430\u043B\u043E\u0433 \u0431\u0430\u043D\u043A\u043E\u0432 \u043F\u0443\u0441\u0442. \u041F\u0440\u043E\u0432\u0435\u0440\u044C\u0442\u0435 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438 \u0431\u044D\u043A\u0435\u043D\u0434\u0430." }) }));
    }
    return (_jsx("div", { className: "grid grid-two", children: banks.map((bank) => (_jsxs("div", { className: "card", children: [_jsx("h3", { children: bank.name }), _jsxs("p", { style: { marginTop: 4, color: '#475569' }, children: ["Base URL: ", bank.baseUrl || '–Ω–µ —É–∫–∞–∑–∞–Ω'] }), bank.error ? (_jsx("p", { style: { color: '#dc2626' }, children: bank.error })) : (_jsx("p", { style: { color: bank.connected ? '#16a34a' : '#475569' }, children: bank.connected ? '–£–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω' : '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è' })), _jsx("button", { type: "button", className: "btn", disabled: !!bank.error || bank.connected || busyBankId === bank.id, onClick: () => onConnect(bank), children: bank.connected ? '–ì–æ—Ç–æ–≤–æ' : busyBankId === bank.id ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : 'Connect' })] }, bank.id))) }));
};
</file>

<file path="hktn/src/components/BanksList.tsx">
import React from 'react';
import type { BankSummary } from '../state/useUser';

type BanksListProps = {
  banks: BankSummary[];
  onConnect: (bank: BankSummary) => void;
  busyBankId?: string | null;
};

export const BanksList: React.FC<BanksListProps> = ({ banks, onConnect, busyBankId }) => {
  if (!banks.length) {
    return (
      <div className="card">
        <p>–ö–∞—Ç–∞–ª–æ–≥ –±–∞–Ω–∫–æ–≤ –ø—É—Å—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—ç–∫–µ–Ω–¥–∞.</p>
      </div>
    );
  }

  return (
    <div className="grid grid-two">
      {banks.map((bank) => (
        <div key={bank.id} className="card">
          <h3>{bank.name}</h3>
          <p style={{ marginTop: 4, color: '#475569' }}>Base URL: {bank.baseUrl || '–Ω–µ —É–∫–∞–∑–∞–Ω'}</p>
          {bank.error ? (
            <p style={{ color: '#dc2626' }}>{bank.error}</p>
          ) : (
            <p style={{ color: bank.connected ? '#16a34a' : '#475569' }}>
              {bank.connected ? '–£–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω' : '–û–∂–∏–¥–∞–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è'}
            </p>
          )}
          <button
            type="button"
            className="btn"
            disabled={!!bank.error || bank.connected || busyBankId === bank.id}
            onClick={() => onConnect(bank)}
          >
            {bank.connected ? '–ì–æ—Ç–æ–≤–æ' : busyBankId === bank.id ? '–°–æ–∑–¥–∞–Ω–∏–µ...' : 'Connect'}
          </button>
        </div>
      ))}
    </div>
  );
};
</file>

<file path="hktn/src/components/UserIdForm.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useState } from 'react';
export const USER_ID_PATTERN = /^team260-([1-9]|10)$/i;
export const validateUserId = (value) => USER_ID_PATTERN.test(value.trim());
export const UserIdForm = ({ defaultUserId = '', defaultUserName = '', onSubmit, isSubmitting, }) => {
    const [userId, setUserId] = useState(defaultUserId ?? '');
    const [userName, setUserName] = useState(defaultUserName ?? '');
    const [agreed, setAgreed] = useState(false);
    const [error, setError] = useState(null);
    const handleSubmit = async (event) => {
        event.preventDefault();
        const trimmedId = userId.trim();
        const trimmedName = userName.trim();
        if (!validateUserId(trimmedId)) {
            setError('ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ team260-X, –≥–¥–µ X –æ—Ç 1 –¥–æ 10');
            return;
        }
        if (!trimmedName) {
            setError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
            return;
        }
        if (!agreed) {
            setError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
            return;
        }
        setError(null);
        await onSubmit(trimmedId, trimmedName);
    };
    return (_jsxs("form", { className: "card", onSubmit: handleSubmit, children: [_jsx("h2", { children: "\u0428\u0430\u0433 1. \u0418\u0434\u0435\u043D\u0442\u0438\u0444\u0438\u043A\u0430\u0446\u0438\u044F" }), _jsx("p", { children: "\u0412\u0432\u0435\u0434\u0438\u0442\u0435 \u0432\u0430\u0448 ID \u0438 \u0438\u043C\u044F \u0434\u043B\u044F \u043D\u0430\u0447\u0430\u043B\u0430 \u0440\u0430\u0431\u043E\u0442\u044B." }), _jsx("label", { htmlFor: "user-id-input", children: "User ID" }), _jsx("input", { id: "user-id-input", value: userId, onChange: (e) => setUserId(e.target.value), placeholder: "team260-1", className: "text-input", disabled: isSubmitting }), _jsx("label", { htmlFor: "user-name-input", children: "\u0412\u0430\u0448\u0435 \u0438\u043C\u044F" }), _jsx("input", { id: "user-name-input", value: userName, onChange: (e) => setUserName(e.target.value), placeholder: "\u0418\u0432\u0430\u043D \u0418\u0432\u0430\u043D\u043E\u0432", className: "text-input", disabled: isSubmitting }), _jsxs("label", { style: { display: 'flex', gap: 12, alignItems: 'center', margin: '16px 0' }, children: [_jsx("input", { type: "checkbox", checked: agreed, onChange: (e) => setAgreed(e.target.checked) }), _jsx("span", { children: "\u042F \u0441\u043E\u0433\u043B\u0430\u0441\u0435\u043D \u043D\u0430 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u043A\u0443 \u043F\u0435\u0440\u0441\u043E\u043D\u0430\u043B\u044C\u043D\u044B\u0445 \u0434\u0430\u043D\u043D\u044B\u0445" })] }), error ? (_jsx("p", { role: "alert", style: { color: '#dc2626', marginTop: 8 }, children: error })) : null, _jsx("button", { type: "submit", className: "btn", disabled: isSubmitting || !agreed, children: "\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C" })] }));
};
</file>

<file path="hktn/src/pages/__tests__/DashboardPage.test.tsx">
import { render, screen, waitFor, within } from '@testing-library/react';
import { act } from 'react';
import userEvent from '@testing-library/user-event';
import React from 'react';
import { vi } from 'vitest';
import type { DashboardResponse } from '../../types/dashboard';
import { DashboardPage } from '../DashboardPage';

vi.mock('../../state/useUser', () => ({
  useUser: () => ({
    userId: 'demo-user',
    userName: 'Demo',
    setInitialUserData: vi.fn(),
    clearUser: vi.fn(),
    consents: [],
    upsertConsent: vi.fn(),
    banks: [],
    refreshBanks: vi.fn(),
    isFetchingBanks: false,
  }),
}));

vi.mock('../../state/notifications', () => ({
  useNotifications: () => ({
    notify: vi.fn(),
    notifyError: vi.fn(),
    notifySuccess: vi.fn(),
  }),
}));

const mockGetDashboard = vi.fn();
const mockGetFinancialPortrait = vi.fn();

vi.mock('../../api/client', () => ({
  getDashboard: (...args: unknown[]) => mockGetDashboard(...args),
  getFinancialPortrait: (...args: unknown[]) => mockGetFinancialPortrait(...args),
}));

const dashboardStub: DashboardResponse = {
  safe_to_spend: 45000,
  safe_to_spend_daily: 1500,
  goal_probability: 82,
  current_balance: 120000,
  analysis: {
    payment_amount: 12000,
    payment_date: '2024-05-10',
    recommendation: '–û–ø–ª–∞—Ç–∏—Ç–µ –∞—Ä–µ–Ω–¥—É –∑–∞—Ä–∞–Ω–µ–µ',
    color_zone: 'green',
    success_probability_percent: 78,
  },
  upcoming_payments: [
    {
      name: '–ê—Ä–µ–Ω–¥–∞',
      amount: 40000,
      due_date: '2024-05-05',
      source: 'recurring_debit',
      mcc_code: '4900',
      category: 'utilities',
      merchant_name: 'Utility Co',
      bank_transaction_code: 'POS:RNT',
    },
    {
      name: '–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –≤—ã–ø–ª–∞—Ç–∞',
      amount: 12000,
      due_date: '2024-05-12',
      source: 'credit_agreement',
      mcc_code: '0000',
      category: 'loan',
      merchant_name: 'Bank Loan',
    },
  ],
  recurring_events: [
    {
      name: '–ó–∞—Ä–ø–ª–∞—Ç–∞',
      amount: 90000,
      is_income: true,
      next_date: '2024-05-25',
      frequency_days: 30,
      mcc_code: '6011',
      category: 'salary',
      merchant_name: 'ACME Corp',
      bank_transaction_code: 'TRF:PAY',
      source: 'recurring_income',
    },
    {
      name: '–ö–æ–º–º—É–Ω–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏',
      amount: -4000,
      is_income: false,
      next_date: '2024-05-07',
      frequency_days: 30,
      mcc_code: '4900',
      category: 'utilities',
      merchant_name: 'Utility Co',
      bank_transaction_code: 'POS:RNT',
      source: 'recurring_debit',
    },
  ],
  credit_rankings: [
    {
      name: 'Loan A',
      balance: 200000,
      min_payment: 12000,
      stress_score: 45,
    },
  ],
};

describe('DashboardPage', () => {
  beforeEach(() => {
    mockGetDashboard.mockResolvedValue(dashboardStub);
    mockGetFinancialPortrait.mockResolvedValue({
      recurring_events: dashboardStub.recurring_events,
      transactions_sample: [
        {
          transactionId: 'tx-1',
          amount: -4000,
          bookingDate: '2024-04-05',
          merchant: { name: 'Utility Co', mccCode: '4900' },
        },
      ],
    });
  });

  afterEach(() => {
    vi.clearAllMocks();
  });

  it('renders metadata badges for upcoming payments', () => {
    render(<DashboardPage initialData={dashboardStub} />);

    const mccBadges = screen.getAllByText(/MCC 4900/i);
    expect(mccBadges.length).toBeGreaterThan(0);
    expect(screen.getByText('AI-–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ')).toBeInTheDocument();
    expect(screen.getByText(/–ë–∞–ª–∞–Ω—Å:/)).toBeInTheDocument();
  });

  it('filters upcoming payments by source', async () => {
    render(<DashboardPage initialData={dashboardStub} />);

    const sourceSelect = screen.getByLabelText('–ò—Å—Ç–æ—á–Ω–∏–∫');
    await act(async () => {
      await userEvent.selectOptions(sourceSelect, 'credit_agreement');
    });

    const paymentsSection = screen.getByRole('heading', { name: '–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏' }).closest('.card');
    expect(paymentsSection).toBeTruthy();
    expect(within(paymentsSection as HTMLElement).getByText('–ö—Ä–µ–¥–∏—Ç–Ω–∞—è –≤—ã–ø–ª–∞—Ç–∞')).toBeInTheDocument();
    expect(within(paymentsSection as HTMLElement).queryByText('–ê—Ä–µ–Ω–¥–∞')).not.toBeInTheDocument();
  });

  it('fetches financial portrait when details are expanded', async () => {
    render(<DashboardPage initialData={dashboardStub} />);

    const toggleButton = screen.getByRole('button', { name: /–ø–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏/i });
    await act(async () => {
      await userEvent.click(toggleButton);
    });

    await waitFor(() => expect(mockGetFinancialPortrait).toHaveBeenCalledWith({ user_id: 'demo-user' }));
    const portraitHeadings = await screen.findAllByText(/–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–æ–±—ã—Ç–∏—è/);
    expect(portraitHeadings.length).toBeGreaterThan(0);
    const utilityBadges = await screen.findAllByText(/Utility Co/);
    expect(utilityBadges.length).toBeGreaterThan(0);
  });
});
</file>

<file path="hktn/src/pages/CallbackPage.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useLocation, useNavigate } from 'react-router-dom';
export const CallbackPage = () => {
    const { search } = useLocation();
    const navigate = useNavigate();
    const params = new URLSearchParams(search);
    const consentId = params.get('consent_id');
    return (_jsx("div", { className: "app-main", children: _jsxs("div", { className: "card", children: [_jsx("h2", { children: "\u0411\u0430\u043D\u043A \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u043B \u043A\u043E\u043D\u0441\u0435\u043D\u0442" }), _jsx("p", { children: "\u041C\u043E\u0436\u043D\u043E \u0437\u0430\u043A\u0440\u044B\u0442\u044C \u0432\u043A\u043B\u0430\u0434\u043A\u0443 \u0431\u0430\u043D\u043A\u0430 \u0438 \u0432\u0435\u0440\u043D\u0443\u0442\u044C\u0441\u044F \u0432 \u043F\u0440\u0438\u043B\u043E\u0436\u0435\u043D\u0438\u0435." }), consentId ? _jsxs("p", { children: ["Consent ID: ", consentId] }) : null, _jsx("button", { className: "btn", onClick: () => navigate('/banks/preview'), children: "\u0412\u0435\u0440\u043D\u0443\u0442\u044C\u0441\u044F" })] }) }));
};
</file>

<file path="hktn/src/pages/CallbackPage.tsx">
import React from 'react';
import { useLocation, useNavigate } from 'react-router-dom';

export const CallbackPage: React.FC = () => {
  const { search } = useLocation();
  const navigate = useNavigate();
  const params = new URLSearchParams(search);
  const consentId = params.get('consent_id');

  return (
    <div className="app-main">
      <div className="card">
        <h2>–ë–∞–Ω–∫ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª –∫–æ–Ω—Å–µ–Ω—Ç</h2>
        <p>–ú–æ–∂–Ω–æ –∑–∞–∫—Ä—ã—Ç—å –≤–∫–ª–∞–¥–∫—É –±–∞–Ω–∫–∞ –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.</p>
        {consentId ? <p>Consent ID: {consentId}</p> : null}
        <button className="btn" onClick={() => navigate('/banks/preview')}>
          –í–µ—Ä–Ω—É—Ç—å—Å—è
        </button>
      </div>
    </div>
  );
};
</file>

<file path="hktn/src/pages/ConsentStatusPage.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useCallback, useEffect, useState } from 'react';
import { useNavigate, useParams, useSearchParams } from 'react-router-dom';
import { pollConsent } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';
const POLL_INTERVAL_MS = 3500;
export const ConsentStatusPage = () => {
    const { bankId } = useParams();
    const [searchParams] = useSearchParams();
    const requestId = searchParams.get('requestId') || undefined;
    const bankName = searchParams.get('bankName') ?? bankId;
    const navigate = useNavigate();
    const { userId, upsertConsent } = useUser();
    const { notifyError } = useNotifications();
    const [status, setStatus] = useState(null);
    const [isPolling, setIsPolling] = useState(false);
    const runPoll = useCallback(async () => {
        if (!userId || !bankId || !requestId) {
            return null;
        }
        try {
            setIsPolling(true);
            const payload = await pollConsent({ user_id: userId, bank_id: bankId, request_id: requestId });
            setStatus(payload);
            upsertConsent({
                bankId,
                requestId,
                consentId: payload.consent_id,
                status: payload.state,
                approvalUrl: payload.approval_url,
            });
            return payload;
        }
        catch (error) {
            console.error(error);
            notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
            return null;
        }
        finally {
            setIsPolling(false);
        }
    }, [bankId, bankName, notifyError, requestId, upsertConsent, userId]);
    useEffect(() => {
        if (!userId || !bankId || !requestId)
            return;
        let timer;
        let cancelled = false;
        const schedule = () => {
            timer = window.setTimeout(async () => {
                if (cancelled)
                    return;
                const payload = await runPoll();
                if (!cancelled && payload?.state !== 'approved') {
                    schedule();
                }
            }, POLL_INTERVAL_MS);
        };
        runPoll().then((payload) => {
            if (!cancelled && payload?.state !== 'approved') {
                schedule();
            }
        });
        return () => {
            cancelled = true;
            window.clearTimeout(timer);
        };
    }, [bankId, requestId, runPoll, userId]);
    const canContinue = status?.state === 'approved';
    if (!bankId || !requestId) {
        return (_jsx("div", { className: "app-main", children: _jsxs("div", { className: "card", children: [_jsx("p", { children: "\u041D\u0435\u0442 \u0430\u043A\u0442\u0438\u0432\u043D\u043E\u0433\u043E \u0437\u0430\u043F\u0440\u043E\u0441\u0430. \u0412\u0435\u0440\u043D\u0438\u0442\u0435\u0441\u044C \u043A \u0441\u043F\u0438\u0441\u043A\u0443 \u0431\u0430\u043D\u043A\u043E\u0432." }), _jsx("button", { className: "btn-secondary btn", onClick: () => navigate('/banks'), children: "\u041D\u0430\u0437\u0430\u0434 \u043A \u0431\u0430\u043D\u043A\u0430\u043C" })] }) }));
    }
    return (_jsx("div", { className: "app-main", children: _jsxs("div", { className: "card", children: [_jsxs("h2", { children: ["\u0421\u0442\u0430\u0442\u0443\u0441 \u0437\u0430\u043F\u0440\u043E\u0441\u0430 \u0432 ", bankName] }), _jsxs("p", { children: ["\u0421\u0442\u0430\u0442\u0443\u0441: ", status?.state ?? '–æ–∂–∏–¥–∞–Ω–∏–µ'] }), _jsxs("p", { children: ["\u041E\u0442\u0432\u0435\u0442 \u0431\u0430\u043D\u043A\u0430: ", status?.status ?? '...', " "] }), status?.approval_url ? (_jsxs("p", { children: ["\u0421\u0441\u044B\u043B\u043A\u0430: ", _jsx("a", { href: status.approval_url, children: "\u041E\u0442\u043A\u0440\u044B\u0442\u044C \u043F\u043E\u0440\u0442\u0430\u043B \u0431\u0430\u043D\u043A\u0430" })] })) : null, _jsxs("div", { style: { display: 'flex', gap: 12, marginTop: 16 }, children: [_jsx("button", { className: "btn", onClick: runPoll, disabled: isPolling, children: "\u042F \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u043B" }), _jsx("button", { className: "btn-secondary btn", onClick: () => navigate('/banks'), children: "\u0412\u044B\u0431\u0440\u0430\u0442\u044C \u0434\u0440\u0443\u0433\u043E\u0439 \u0431\u0430\u043D\u043A" })] }), canContinue ? (_jsx("button", { className: "btn", style: { marginTop: 16 }, onClick: () => navigate('/banks/preview'), children: "\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u043A \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u0430\u043C" })) : null] }) }));
};
</file>

<file path="hktn/src/pages/ConsentStatusPage.tsx">
import React, { useCallback, useEffect, useState } from 'react';
import { useNavigate, useParams, useSearchParams } from 'react-router-dom';
import { pollConsent } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';

type ConsentStatusPayload = {
  state: string;
  status: string;
  approval_url?: string;
  consent_id?: string;
  request_id?: string;
};

const POLL_INTERVAL_MS = 3500;

export const ConsentStatusPage: React.FC = () => {
  const { bankId } = useParams();
  const [searchParams] = useSearchParams();
  const requestId = searchParams.get('requestId') || undefined;
  const bankName = searchParams.get('bankName') ?? bankId;
  const navigate = useNavigate();
  const { userId, upsertConsent } = useUser();
  const { notifyError } = useNotifications();
  const [status, setStatus] = useState<ConsentStatusPayload | null>(null);
  const [isPolling, setIsPolling] = useState(false);

  const runPoll = useCallback(async (): Promise<ConsentStatusPayload | null> => {
    if (!userId || !bankId || !requestId) {
      return null;
    }
    try {
      setIsPolling(true);
      const payload = await pollConsent({ user_id: userId, bank_id: bankId, request_id: requestId });
      setStatus(payload);
      upsertConsent({
        bankId,
        requestId,
        consentId: payload.consent_id,
        status: payload.state,
        approvalUrl: payload.approval_url,
      });
      return payload;
    } catch (error) {
      console.error(error);
      notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å');
      return null;
    }
    finally {
      setIsPolling(false);
    }
  }, [bankId, bankName, notifyError, requestId, upsertConsent, userId]);

  useEffect(() => {
    if (!userId || !bankId || !requestId) return;
    let timer: number;
    let cancelled = false;
    const schedule = () => {
      timer = window.setTimeout(async () => {
        if (cancelled) return;
        const payload = await runPoll();
        if (!cancelled && payload?.state !== 'approved') {
          schedule();
        }
      }, POLL_INTERVAL_MS);
    };

    runPoll().then((payload) => {
      if (!cancelled && payload?.state !== 'approved') {
        schedule();
      }
    });
    return () => {
      cancelled = true;
      window.clearTimeout(timer);
    };
  }, [bankId, requestId, runPoll, userId]);

  const canContinue = status?.state === 'approved';

  if (!bankId || !requestId) {
    return (
      <div className="app-main">
        <div className="card">
          <p>–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞. –í–µ—Ä–Ω–∏—Ç–µ—Å—å –∫ —Å–ø–∏—Å–∫—É –±–∞–Ω–∫–æ–≤.</p>
          <button className="btn-secondary btn" onClick={() => navigate('/banks')}>
            –ù–∞–∑–∞–¥ –∫ –±–∞–Ω–∫–∞–º
          </button>
        </div>
      </div>
    );
  }

  return (
    <div className="app-main">
      <div className="card">
        <h2>–°—Ç–∞—Ç—É—Å –∑–∞–ø—Ä–æ—Å–∞ –≤ {bankName}</h2>
        <p>–°—Ç–∞—Ç—É—Å: {status?.state ?? '–æ–∂–∏–¥–∞–Ω–∏–µ'}</p>
        <p>–û—Ç–≤–µ—Ç –±–∞–Ω–∫–∞: {status?.status ?? '...'} </p>
        {status?.approval_url ? (
          <p>
            –°—Å—ã–ª–∫–∞: <a href={status.approval_url}>–û—Ç–∫—Ä—ã—Ç—å –ø–æ—Ä—Ç–∞–ª –±–∞–Ω–∫–∞</a>
          </p>
        ) : null}
        <div style={{ display: 'flex', gap: 12, marginTop: 16 }}>
          <button className="btn" onClick={runPoll} disabled={isPolling}>
            –Ø –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª
          </button>
          <button className="btn-secondary btn" onClick={() => navigate('/banks')}>
            –í—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π –±–∞–Ω–∫
          </button>
        </div>
        {canContinue ? (
          <button className="btn" style={{ marginTop: 16 }} onClick={() => navigate('/banks/preview')}>
            –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–¥—É–∫—Ç–∞–º
          </button>
        ) : null}
      </div>
    </div>
  );
};
</file>

<file path="hktn/src/pages/DashboardPage.jsx">
import React, { useEffect, useMemo, useState } from 'react';
import { getDashboard, getFinancialPortrait } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';

const currencyFormatter = new Intl.NumberFormat('ru-RU', {
  style: 'currency',
  currency: 'RUB',
  maximumFractionDigits: 0,
});

const formatCurrency = (value) => {
  if (value === null || value === undefined || Number.isNaN(value)) {
    return '‚Äî';
  }
  return currencyFormatter.format(value);
};

const formatDate = (value) => {
  if (!value) return '‚Äî';
  const parsed = new Date(value);
  if (Number.isNaN(parsed.getTime())) {
    return value;
  }
  return parsed.toLocaleDateString('ru-RU', {
    day: '2-digit',
    month: 'short',
  });
};

const SOURCE_COPY = {
  credit_agreement: { label: '–ö—Ä–µ–¥–∏—Ç', tone: 'credit' },
  recurring_debit: { label: '–†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥', tone: 'debit' },
  expense_event: { label: '–†–∞—Å—Ö–æ–¥ (AI)', tone: 'debit' },
  recurring_income: { label: '–†–µ–≥—É–ª—è—Ä–Ω—ã–π –¥–æ—Ö–æ–¥', tone: 'income' },
  income_event: { label: '–î–æ—Ö–æ–¥ (AI)', tone: 'income' },
};

const sanitizeSourceKey = (source) => source.replace(/[^a-z0-9]+/gi, '-').toLowerCase();

const SourceChip = ({ source }) => {
  if (!source) return null;
  const descriptor = SOURCE_COPY[source] ?? { label: source.replace(/_/g, ' '), tone: 'neutral' };
  const chipClass = `chip chip--source chip--${descriptor.tone} chip--${sanitizeSourceKey(source)}`;
  return (
    <span className={chipClass} aria-label={`–ò—Å—Ç–æ—á–Ω–∏–∫: ${descriptor.label}`}>
      {descriptor.label}
    </span>
  );
};

const MetadataBadges = ({ mcc, category, merchantName, bankTransactionCode, source, isIncome }) => {
  const merchantLabel = merchantName || (isIncome ? '–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞ –Ω–µ –æ–ø–æ–∑–Ω–∞–Ω' : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ—Ä–≥–æ–≤–µ—Ü');
  return (
    <div className="metadata-badges" aria-label="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã —Å–æ–±—ã—Ç–∏—è">
      <span className="metadata-badge metadata-badge--merchant" title={merchantLabel}>
        {merchantLabel}
      </span>
      <span className="metadata-badge metadata-badge--mcc" title={`MCC ${mcc || '‚Äî'}`}>
        {`MCC ${mcc || '‚Äî'}${category ? ` ‚Ä¢ ${category}` : ''}`}
      </span>
      {bankTransactionCode ? (
        <span
          className="metadata-badge metadata-badge--code"
          title={`–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –∫–æ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${bankTransactionCode}`}
          aria-label={bankTransactionCode}
        >
          {bankTransactionCode}
        </span>
      ) : (
        <span className="metadata-badge metadata-badge--muted" aria-label="–ö–æ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç">
          –ù–µ—Ç –∫–æ–¥–∞
        </span>
      )}
      <SourceChip source={source} />
    </div>
  );
};

const RecurringEventRow = ({ event }) => (
  <li className={`event-row ${event.is_income ? 'event-row--income' : 'event-row--expense'}`}>
    <div className="event-row__header">
      <div>
        <p
          className="event-row__title"
          title={event.bank_transaction_code ? `–ö–æ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${event.bank_transaction_code}` : undefined}
        >
          {event.name ?? '–ü–æ–≤—Ç–æ—Ä—è—é—â–µ–µ—Å—è —Å–æ–±—ã—Ç–∏–µ'}
        </p>
        <p className="event-row__subtitle">
          {event.merchant_name || (event.is_income ? '–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω' : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ—Ä–≥–æ–≤–µ—Ü')}
          {event.frequency_days ? ` ‚Ä¢ –∫–∞–∂–¥—ã–µ ~${event.frequency_days} –¥.` : null}
        </p>
      </div>
      <div className="event-row__amount" aria-label="–†–∞–∑–º–µ—Ä —Å–æ–±—ã—Ç–∏—è">
        <span>{formatCurrency(event.amount)}</span>
        <small>
          {event.is_income ? '–°–ª–µ–¥—É—é—â–∏–π –¥–æ—Ö–æ–¥' : '–°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç—ë–∂'}: {formatDate(event.next_date)}
        </small>
      </div>
    </div>
    <MetadataBadges
      mcc={event.mcc_code}
      category={event.category}
      merchantName={event.merchant_name}
      bankTransactionCode={event.bank_transaction_code}
      source={event.source}
      isIncome={event.is_income}
    />
  </li>
);

const UpcomingPaymentRow = ({ payment }) => {
  const derived = payment.source && payment.source !== 'credit_agreement';
  const amount = typeof payment.amount === 'number' ? Math.abs(payment.amount) : null;
  return (
    <li className={`event-row obligation-row ${derived ? 'obligation-row--derived' : ''}`}>
      <div className="event-row__header">
        <div>
          <p
            className="event-row__title"
            title={payment.bank_transaction_code ? `–ö–æ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${payment.bank_transaction_code}` : undefined}
          >
            {payment.name || '–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂'}
          </p>
          <p className="event-row__subtitle">–°—Ä–æ–∫: {formatDate(payment.due_date)}</p>
        </div>
        <div className="event-row__amount">
          <span>{formatCurrency(amount)}</span>
          <small>–ò—Å—Ç–æ—á–Ω–∏–∫: {payment.source ? SOURCE_COPY[payment.source]?.label || payment.source : '‚Äî'}</small>
        </div>
      </div>
      {derived ? <span className="chip chip--derived">AI-–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ</span> : null}
      <MetadataBadges
        mcc={payment.mcc_code}
        category={payment.category}
        merchantName={payment.merchant_name}
        bankTransactionCode={payment.bank_transaction_code}
        source={payment.source}
      />
    </li>
  );
};

export const DashboardPage = ({ initialData = null }) => {
  const { userId } = useUser();
  const { notifyError } = useNotifications();
  const [data, setData] = useState(initialData);
  const [loading, setLoading] = useState(false);
  const [portraitOpen, setPortraitOpen] = useState(false);
  const [portraitLoading, setPortraitLoading] = useState(false);
  const [portrait, setPortrait] = useState(null);
  const [sourceFilter, setSourceFilter] = useState('all');
  const [mccFilter, setMccFilter] = useState('all');
  const [sortMode, setSortMode] = useState('due_date');

  useEffect(() => {
    if (!userId || initialData) {
      return;
    }
    const load = async () => {
      try {
        setLoading(true);
        const payload = await getDashboard(userId);
        setData(payload);
      } catch (error) {
        console.error(error);
        notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É');
      } finally {
        setLoading(false);
      }
    };
    load();
  }, [notifyError, userId, initialData]);

  useEffect(() => {
    if (!portraitOpen || portrait || !userId) {
      return;
    }
    const load = async () => {
      try {
        setPortraitLoading(true);
        const payload = await getFinancialPortrait({ user_id: userId });
        setPortrait(payload);
      } catch (error) {
        console.error(error);
        notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–æ—Ä—Ç—Ä–µ—Ç');
      } finally {
        setPortraitLoading(false);
      }
    };
    load();
  }, [portraitOpen, portrait, userId, notifyError]);

  const upcomingPayments = useMemo(() => {
    const parsed = [...(data?.upcoming_payments ?? [])];
    return parsed
      .map((item) => ({
        ...item,
        due_date: item.due_date ?? item.date ?? '',
      }))
      .sort((a, b) => {
        const aTime = a.due_date ? new Date(a.due_date).getTime() : Number.POSITIVE_INFINITY;
        const bTime = b.due_date ? new Date(b.due_date).getTime() : Number.POSITIVE_INFINITY;
        return aTime - bTime;
      });
  }, [data]);

  const recurringEvents = data?.recurring_events ?? [];
  const uniqueSources = useMemo(() => {
    const values = new Set();
    upcomingPayments.forEach((item) => {
      if (item.source) values.add(item.source);
    });
    return Array.from(values);
  }, [upcomingPayments]);

  const uniqueMccCodes = useMemo(() => {
    const values = new Set();
    upcomingPayments.forEach((item) => {
      if (item.mcc_code) values.add(item.mcc_code);
    });
    return Array.from(values);
  }, [upcomingPayments]);

  const filteredPayments = useMemo(() => {
    const filtered = upcomingPayments.filter((item) => {
      if (sourceFilter !== 'all' && (item.source || 'none') !== sourceFilter) {
        return false;
      }
      if (mccFilter !== 'all' && (item.mcc_code || 'none') !== mccFilter) {
        return false;
      }
      return true;
    });
    if (sortMode === 'amount') {
      return [...filtered].sort((a, b) => {
        const aAmount = typeof a.amount === 'number' ? a.amount : 0;
        const bAmount = typeof b.amount === 'number' ? b.amount : 0;
        return bAmount - aAmount;
      });
    }
    return filtered;
  }, [upcomingPayments, sourceFilter, mccFilter, sortMode]);

  const safeToSpend = data?.safe_to_spend ?? null;
  const safeToSpendDaily = data?.safe_to_spend_daily ?? (safeToSpend ? Math.max(0, Math.round(safeToSpend / 30)) : null);
  const currentBalance = data?.current_balance ?? 0;
  const topObligations = upcomingPayments.slice(0, 3);
  const obligationsTotal = upcomingPayments.reduce(
    (acc, item) => acc + (typeof item.amount === 'number' ? item.amount : 0),
    0
  );
  const recommendedPaymentDate = data?.analysis?.payment_date;
  const recommendationDateLabel = recommendedPaymentDate ? formatDate(String(recommendedPaymentDate)) : '‚Äî';
  const recommendedPaymentAmount = data?.analysis?.payment_amount;
  const portraitEvents = portrait?.recurring_events ?? recurringEvents;
  const portraitTransactions = portrait?.transactions_sample ?? [];
  const mccCoverage = portraitEvents.length
    ? Math.round((portraitEvents.filter((event) => Boolean(event.mcc_code)).length / portraitEvents.length) * 100)
    : 0;
  const merchantClusters = useMemo(() => {
    const map = new Map();
    portraitEvents.forEach((event) => {
      if (!event.merchant_name) return;
      const key = event.merchant_name.toLowerCase();
      map.set(key, (map.get(key) ?? 0) + 1);
    });
    return Array.from(map.entries())
      .map(([key, count]) => ({ name: key, count }))
      .sort((a, b) => b.count - a.count);
  }, [portraitEvents]);

  const renderTransactionsForEvent = (event) => {
    const matches = portraitTransactions.filter((tx) => {
      const txMerchant = tx.merchant?.name || tx.description;
      const txMcc = tx.mccCode || tx.merchant?.mccCode;
      const merchantMatch =
        !!event.merchant_name &&
        !!txMerchant &&
        txMerchant.toLowerCase().includes(event.merchant_name.toLowerCase());
      const mccMatch = !!event.mcc_code && !!txMcc && event.mcc_code === txMcc;
      return merchantMatch || mccMatch;
    });
    if (!matches.length) {
      return <p className="muted">–ù–µ –Ω–∞—à–ª–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è —ç—Ç–æ–π –º–µ—Ç–∫–∏.</p>;
    }
    return (
      <ul className="metadata-transactions">
        {matches.slice(0, 4).map((tx) => (
          <li key={tx.transactionId}>
            <strong>{formatCurrency(tx.amount)}</strong>
            <span>{tx.bookingDate ? formatDate(tx.bookingDate) : '‚Äî'}</span>
            <span>{tx.merchant?.name || tx.description || '‚Äî'}</span>
          </li>
        ))}
      </ul>
    );
  };

  if (loading) {
    return (
      <div className="app-main">
        <div className="card">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</div>
      </div>
    );
  }

  if (!data) {
    return (
      <div className="app-main">
        <div className="card">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–π–¥–∏—Ç–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥.</div>
      </div>
    );
  }

  return (
    <div className="app-main">
      <div className="card safe-card">
        <div className="card-header">
          <h2>Safe-to-Spend</h2>
          <span className="chip chip--balance" aria-label="–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å">
            –ë–∞–ª–∞–Ω—Å: {formatCurrency(currentBalance)}
          </span>
        </div>
        <p className="muted">
          –û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ {formatCurrency(currentBalance)} –∏ {topObligations.length || '‚Äî'} –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞—Ö FinPulse AI.
        </p>
        <div className="safe-grid">
          <div>
            <p className="muted">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ª–∏–º–∏—Ç</p>
            <strong className="metric">{safeToSpendDaily ? `${formatCurrency(safeToSpendDaily)} / –¥–µ–Ω—å` : '–ù–µ—Ç –æ—Ü–µ–Ω–∫–∏'}</strong>
          </div>
          <div>
            <p className="muted">–ì–æ—Ä–∏–∑–æ–Ω—Ç (30 –¥–Ω.)</p>
            <strong className="metric">{safeToSpend ? formatCurrency(safeToSpend) : '–ù–µ—Ç –æ—Ü–µ–Ω–∫–∏'}</strong>
          </div>
          <div>
            <p className="muted">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏</p>
            <strong className="metric">{data.goal_probability ?? data.analysis?.success_probability_percent ?? 0}%</strong>
          </div>
        </div>
        {recommendedPaymentAmount ? (
          <div className="safe-recommendation">
            <span>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: </span>
            <strong>
              {formatCurrency(recommendedPaymentAmount)} –¥–æ {recommendationDateLabel}
            </strong>
            <span className="muted">{data.analysis?.recommendation}</span>
          </div>
        ) : null}
        <div className="safe-obligations">
          <p className="muted">–û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ —Ä–∞—Å—á—ë—Ç–µ:</p>
          <div className="metadata-badges">
            {topObligations.length ? (
              topObligations.map((item) => (
                <span key={`${item.name}-${item.due_date}`} className="metadata-badge metadata-badge--obligation">
                  {item.name}: {formatCurrency(typeof item.amount === 'number' ? item.amount : null)} –¥–æ {formatDate(item.due_date)}
                </span>
              ))
            ) : (
              <span className="metadata-badge metadata-badge--muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤</span>
            )}
          </div>
          <p className="muted">
            –í—Å–µ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ ‚âà {formatCurrency(obligationsTotal)} –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ Safe-to-Spend.
          </p>
        </div>
      </div>

      <div className="card">
        <div className="card-header">
          <h3>–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h3>
          <div className="filter-row">
            <label>
              –ò—Å—Ç–æ—á–Ω–∏–∫
              <select value={sourceFilter} onChange={(event) => setSourceFilter(event.target.value)}>
                <option value="all">–í—Å–µ</option>
                {uniqueSources.map((source) => (
                  <option key={source} value={source}>
                    {SOURCE_COPY[source]?.label || source}
                  </option>
                ))}
              </select>
            </label>
            <label>
              MCC
              <select value={mccFilter} onChange={(event) => setMccFilter(event.target.value)}>
                <option value="all">–í—Å–µ</option>
                {uniqueMccCodes.map((mcc) => (
                  <option key={mcc} value={mcc}>
                    {mcc}
                  </option>
                ))}
              </select>
            </label>
            <label>
              –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
              <select value={sortMode} onChange={(event) => setSortMode(event.target.value)}>
                <option value="due_date">–ü–æ –¥–∞—Ç–µ</option>
                <option value="amount">–ü–æ —Å—É–º–º–µ</option>
              </select>
            </label>
          </div>
        </div>
        <ul className="list list--dense">
          {filteredPayments.length ? (
            filteredPayments.map((payment) => <UpcomingPaymentRow key={`${payment.name}-${payment.due_date}`} payment={payment} />)
          ) : (
            <li className="muted">–ù–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</li>
          )}
        </ul>
      </div>

      <div className="card">
        <div className="card-header">
          <h3>–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–æ–±—ã—Ç–∏—è</h3>
          <span className="chip chip--neutral">{recurringEvents.length} –ø–æ—Ç–æ–∫(–æ–≤)</span>
        </div>
        <ul className="list list--dense">
          {recurringEvents.length ? (
            recurringEvents.map((event) => <RecurringEventRow key={`${event.name}-${event.next_date}`} event={event} />)
          ) : (
            <li className="muted">–ù–µ—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–±—ã—Ç–∏–π.</li>
          )}
        </ul>
      </div>

      <div className="card">
        <div className="card-header">
          <h3>–ö—Ä–µ–¥–∏—Ç—ã</h3>
          <span className="chip chip--credit">{(data.credit_rankings ?? []).length} –∞–∫—Ç–∏–≤–Ω—ã—Ö</span>
        </div>
        <ul className="list list--dense">
          {(data.credit_rankings ?? []).length ? (
            (data.credit_rankings ?? []).map((credit) => (
              <li key={credit.name} className="credit-row">
                <div>
                  <strong>{credit.name}</strong>
                  <p className="muted">Stress {credit.stress_score ?? '‚Äî'}</p>
                </div>
                <div className="credit-row__metrics">
                  <span>–î–æ–ª–≥: {formatCurrency(credit.balance)}</span>
                  <span>–ü–ª–∞—Ç—ë–∂: {formatCurrency(credit.min_payment)}</span>
                </div>
              </li>
            ))
          ) : (
            <li className="muted">–ù–µ—Ç –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.</li>
          )}
        </ul>
      </div>

      <div className="card portrait-card">
        <div className="card-header">
          <h3>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ—Ä—Ç—Ä–µ—Ç</h3>
          <button className="btn btn-secondary" onClick={() => setPortraitOpen((prev) => !prev)}>
            {portraitOpen ? '–°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏' : '–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏'}
          </button>
        </div>
        <p className="muted">
          –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–≤–æ–¥–∫–∞ MCC, —Ç–æ—Ä–≥–æ–≤—Ü–µ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –ª–µ–∂–∞—â–∏—Ö –≤ –æ—Å–Ω–æ–≤–µ –ø–æ—Ä—Ç—Ä–µ—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ—ë –¥–ª—è —Ä—É—á–Ω–æ–π
          –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞.
        </p>
        <div className="portrait-summary">
          <span className="metadata-badge metadata-badge--mcc" title="–î–æ–ª—è —Å–æ–±—ã—Ç–∏–π —Å MCC">
            MCC –ø–æ–∫—Ä—ã—Ç–∏–µ: {mccCoverage}% —Å–æ–±—ã—Ç–∏–π
          </span>
          <span className="metadata-badge metadata-badge--merchant">–ö–ª–∞—Å—Ç–µ—Ä–æ–≤ —Ç–æ—Ä–≥–æ–≤—Ü–µ–≤: {merchantClusters.length}</span>
        </div>
        {portraitOpen ? (
          <div className="portrait-details">
            {portraitLoading && <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–∞...</p>}
            {!portraitLoading && !portrait && <p>–ù–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∂–µ.</p>}
            {!portraitLoading && portrait ? (
              <details open className="portrait-panel">
                <summary>–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–æ–±—ã—Ç–∏—è ({portraitEvents.length})</summary>
                <ul className="list list--dense">
                  {portraitEvents.map((event) => (
                    <li key={`${event.name}-${event.next_date}`} className="portrait-event">
                      <div className="portrait-event__header">
                        <div>
                          <strong>{event.name}</strong>
                          <p className="muted">
                            {event.merchant_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ—Ä–≥–æ–≤–µ—Ü'} ‚Ä¢ {event.mcc_code || 'MCC ‚Äî'}
                          </p>
                        </div>
                        <span>{event.is_income ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'}</span>
                      </div>
                      <MetadataBadges
                        mcc={event.mcc_code}
                        category={event.category}
                        merchantName={event.merchant_name}
                        bankTransactionCode={event.bank_transaction_code}
                        source={event.source}
                        isIncome={event.is_income}
                      />
                      <details>
                        <summary>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏-–∫–∞–Ω–¥–∏–¥–∞—Ç—ã</summary>
                        {renderTransactionsForEvent(event)}
                      </details>
                    </li>
                  ))}
                </ul>
              </details>
            ) : null}
          </div>
        ) : null}
      </div>
    </div>
  );
};

export default DashboardPage;
</file>

<file path="hktn/src/pages/DebtGoalPage.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { getCredits, saveGoal } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';
const paceOptions = [
    { value: 'conservative', label: '–ú—è–≥–∫–∏–π' },
    { value: 'optimal', label: '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π' },
    { value: 'fast', label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π' },
];
export const DebtGoalPage = () => {
    const { userId } = useUser();
    const { notifyError, notifySuccess } = useNotifications();
    const navigate = useNavigate();
    const [credits, setCredits] = useState([]);
    const [selected, setSelected] = useState({});
    const [pace, setPace] = useState('optimal');
    const [timeline, setTimeline] = useState('12');
    const [loading, setLoading] = useState(false);
    const [saving, setSaving] = useState(false);
    useEffect(() => {
        const load = async () => {
            if (!userId)
                return;
            try {
                setLoading(true);
                const response = await getCredits(userId);
                setCredits(response.credits ?? []);
            }
            catch (error) {
                console.error(error);
                notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫—Ä–µ–¥–∏—Ç–æ–≤');
            }
            finally {
                setLoading(false);
            }
        };
        load();
    }, [notifyError, userId]);
    const toggle = (creditId) => {
        setSelected((prev) => ({ ...prev, [creditId]: !prev[creditId] }));
    };
    const handleSubmit = async (event) => {
        event.preventDefault();
        if (!userId)
            return;
        const chosen = Object.entries(selected)
            .filter(([, checked]) => checked)
            .map(([creditId]) => creditId);
        try {
            setSaving(true);
            await saveGoal({
                user_id: userId,
                goal_type: 'pay_debts',
                goal_details: {
                    close_speed: pace,
                    close_loan_ids: chosen,
                    timeline_months: Number(timeline),
                },
            });
            notifySuccess('–¶–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
            navigate('/ingest');
        }
        catch (error) {
            console.error(error);
            notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å');
        }
        finally {
            setSaving(false);
        }
    };
    return (_jsx("div", { className: "app-main", children: _jsxs("form", { className: "card", onSubmit: handleSubmit, children: [_jsx("h2", { children: "\u041A\u0430\u043A\u0438\u0435 \u043A\u0440\u0435\u0434\u0438\u0442\u044B \u0437\u0430\u043A\u0440\u044B\u0432\u0430\u0435\u043C?" }), loading ? _jsx("p", { children: "\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u043A\u0440\u0435\u0434\u0438\u0442\u043E\u0432..." }) : null, _jsx("ul", { className: "list", children: credits.map((credit, index) => {
                        const creditId = credit.id ?? `${credit.bank_id}-${index}`;
                        return (_jsx("li", { children: _jsxs("label", { style: { display: 'flex', gap: 12 }, children: [_jsx("input", { type: "checkbox", checked: selected[creditId] ?? false, onChange: () => toggle(creditId) }), _jsxs("div", { children: [_jsx("strong", { children: credit.name ?? `–ö—Ä–µ–¥–∏—Ç ${index + 1}` }), _jsxs("div", { style: { fontSize: 14, color: '#475569' }, children: ["\u0411\u0430\u043B\u0430\u043D\u0441: ", credit.balance ?? '‚Äî', " | \u041F\u043B\u0430\u0442\u0451\u0436: ", credit.min_payment ?? '‚Äî'] })] })] }) }, creditId));
                    }) }), _jsx("label", { children: "\u0422\u0435\u043C\u043F \u043F\u043E\u0433\u0430\u0448\u0435\u043D\u0438\u044F" }), _jsx("select", { value: pace, onChange: (event) => setPace(event.target.value), children: paceOptions.map((opt) => (_jsx("option", { value: opt.value, children: opt.label }, opt.value))) }), _jsx("label", { children: "\u0413\u043E\u0440\u0438\u0437\u043E\u043D\u0442, \u043C\u0435\u0441\u044F\u0446\u0435\u0432" }), _jsx("input", { value: timeline, onChange: (event) => setTimeline(event.target.value), className: "text-input" }), _jsx("button", { type: "submit", className: "btn", disabled: saving, children: "\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0438 \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C" })] }) }));
};
</file>

<file path="hktn/src/pages/DebtGoalPage.tsx">
import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { getCredits, saveGoal } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';

type Credit = {
  name?: string;
  balance?: number;
  min_payment?: number;
  stress_score?: number;
  bank_id?: string;
  id?: string;
};

const paceOptions = [
  { value: 'conservative', label: '–ú—è–≥–∫–∏–π' },
  { value: 'optimal', label: '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π' },
  { value: 'fast', label: '–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π' },
];

export const DebtGoalPage: React.FC = () => {
  const { userId } = useUser();
  const { notifyError, notifySuccess } = useNotifications();
  const navigate = useNavigate();
  const [credits, setCredits] = useState<Credit[]>([]);
  const [selected, setSelected] = useState<Record<string, boolean>>({});
  const [pace, setPace] = useState('optimal');
  const [timeline, setTimeline] = useState('12');
  const [loading, setLoading] = useState(false);
  const [saving, setSaving] = useState(false);

  useEffect(() => {
    const load = async () => {
      if (!userId) return;
      try {
        setLoading(true);
        const response = await getCredits(userId);
        setCredits(response.credits ?? []);
      } catch (error) {
        console.error(error);
        notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫—Ä–µ–¥–∏—Ç–æ–≤');
      } finally {
        setLoading(false);
      }
    };
    load();
  }, [notifyError, userId]);

  const toggle = (creditId: string) => {
    setSelected((prev) => ({ ...prev, [creditId]: !prev[creditId] }));
  };

  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault();
    if (!userId) return;
    const chosen = Object.entries(selected)
      .filter(([, checked]) => checked)
      .map(([creditId]) => creditId);
    try {
      setSaving(true);
      await saveGoal({
        user_id: userId,
        goal_type: 'pay_debts',
        goal_details: {
          close_speed: pace,
          close_loan_ids: chosen,
          timeline_months: Number(timeline),
        },
      });
      notifySuccess('–¶–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
      navigate('/ingest');
    } catch (error) {
      console.error(error);
      notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å');
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="app-main">
      <form className="card" onSubmit={handleSubmit}>
        <h2>–ö–∞–∫–∏–µ –∫—Ä–µ–¥–∏—Ç—ã –∑–∞–∫—Ä—ã–≤–∞–µ–º?</h2>
        {loading ? <p>–ó–∞–≥—Ä—É–∑–∫–∞ –∫—Ä–µ–¥–∏—Ç–æ–≤...</p> : null}
        <ul className="list">
          {credits.map((credit, index) => {
            const creditId = credit.id ?? `${credit.bank_id}-${index}`;
            return (
              <li key={creditId}>
                <label style={{ display: 'flex', gap: 12 }}>
                  <input type="checkbox" checked={selected[creditId] ?? false} onChange={() => toggle(creditId)} />
                  <div>
                    <strong>{credit.name ?? `–ö—Ä–µ–¥–∏—Ç ${index + 1}`}</strong>
                    <div style={{ fontSize: 14, color: '#475569' }}>
                      –ë–∞–ª–∞–Ω—Å: {credit.balance ?? '‚Äî'} | –ü–ª–∞—Ç—ë–∂: {credit.min_payment ?? '‚Äî'}
                    </div>
                  </div>
                </label>
              </li>
            );
          })}
        </ul>
        <label>–¢–µ–º–ø –ø–æ–≥–∞—à–µ–Ω–∏—è</label>
        <select value={pace} onChange={(event) => setPace(event.target.value)}>{paceOptions.map((opt) => (
            <option key={opt.value} value={opt.value}>
              {opt.label}
            </option>
          ))}</select>
        <label>–ì–æ—Ä–∏–∑–æ–Ω—Ç, –º–µ—Å—è—Ü–µ–≤</label>
        <input value={timeline} onChange={(event) => setTimeline(event.target.value)} className="text-input" />
        <button type="submit" className="btn" disabled={saving}>
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </button>
      </form>
    </div>
  );
};
</file>

<file path="hktn/src/pages/GoalsLandingPage.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useNavigate } from 'react-router-dom';
export const GoalsLandingPage = () => {
    const navigate = useNavigate();
    return (_jsxs("div", { className: "app-main", children: [_jsxs("div", { className: "card", children: [_jsx("h2", { children: "\u0428\u0430\u0433 5. \u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0446\u0435\u043B\u044C" }), _jsx("p", { children: "\u0426\u0435\u043B\u044C \u0432\u043B\u0438\u044F\u0435\u0442 \u043D\u0430 \u0430\u043D\u0430\u043B\u0438\u0442\u0438\u043A\u0443 \u0438 \u0440\u0435\u043A\u043E\u043C\u0435\u043D\u0434\u0430\u0446\u0438\u0438." })] }), _jsxs("div", { className: "grid grid-two", children: [_jsxs("div", { className: "card", children: [_jsx("h3", { children: "\u041D\u0430\u043A\u043E\u043F\u0438\u0442\u044C \u0441\u0431\u0435\u0440\u0435\u0436\u0435\u043D\u0438\u044F" }), _jsx("p", { children: "\u041F\u043B\u0430\u043D\u0438\u0440\u043E\u0432\u0430\u043D\u0438\u0435 \u043F\u043E\u0434\u0443\u0448\u043A\u0438 \u0431\u0435\u0437\u043E\u043F\u0430\u0441\u043D\u043E\u0441\u0442\u0438 \u0438 \u043F\u0440\u043E\u0433\u043D\u043E\u0437 \u0432\u0435\u0440\u043E\u044F\u0442\u043D\u043E\u0441\u0442\u0438 \u043D\u0430\u043A\u043E\u043F\u043B\u0435\u043D\u0438\u044F." }), _jsx("button", { className: "btn", onClick: () => navigate('/goals/save'), children: "\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C" })] }), _jsxs("div", { className: "card", children: [_jsx("h3", { children: "\u0417\u0430\u043A\u0440\u044B\u0442\u044C \u043A\u0440\u0435\u0434\u0438\u0442\u044B" }), _jsx("p", { children: "\u041E\u0442\u0441\u043B\u0435\u0436\u0438\u0432\u0430\u043D\u0438\u0435 \u043A\u0440\u0435\u0434\u0438\u0442\u043E\u0432, \u0441\u0446\u0435\u043D\u0430\u0440\u0438\u0438 \u0432\u044B\u043F\u043B\u0430\u0442 \u0438 \u043F\u0440\u0438\u043E\u0440\u0438\u0442\u0438\u0437\u0430\u0446\u0438\u044F." }), _jsx("button", { className: "btn", onClick: () => navigate('/goals/debts'), children: "\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C" })] })] })] }));
};
</file>

<file path="hktn/src/pages/GoalsLandingPage.tsx">
import React from 'react';
import { useNavigate } from 'react-router-dom';

export const GoalsLandingPage: React.FC = () => {
  const navigate = useNavigate();

  return (
    <div className="app-main">
      <div className="card">
        <h2>–®–∞–≥ 5. –í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª—å</h2>
        <p>–¶–µ–ª—å –≤–ª–∏—è–µ—Ç –Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏.</p>
      </div>
      <div className="grid grid-two">
        <div className="card">
          <h3>–ù–∞–∫–æ–ø–∏—Ç—å —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è</h3>
          <p>–ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–¥—É—à–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ –∏ –ø—Ä–æ–≥–Ω–æ–∑ –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç–∏ –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è.</p>
          <button className="btn" onClick={() => navigate('/goals/save')}>
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
          </button>
        </div>
        <div className="card">
          <h3>–ó–∞–∫—Ä—ã—Ç—å –∫—Ä–µ–¥–∏—Ç—ã</h3>
          <p>–û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫—Ä–µ–¥–∏—Ç–æ–≤, —Å—Ü–µ–Ω–∞—Ä–∏–∏ –≤—ã–ø–ª–∞—Ç –∏ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è.</p>
          <button className="btn" onClick={() => navigate('/goals/debts')}>
            –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
          </button>
        </div>
      </div>
    </div>
  );
};
</file>

<file path="hktn/src/pages/IngestionPage.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { commitOnboarding, runIngestion } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';
export const IngestionPage = () => {
    const { userId } = useUser();
    const { notifyError, notifySuccess } = useNotifications();
    const navigate = useNavigate();
    const [ingesting, setIngesting] = useState(false);
    const [committing, setCommitting] = useState(false);
    const [statuses, setStatuses] = useState([]);
    const [ingestDone, setIngestDone] = useState(false);
    const [commitDone, setCommitDone] = useState(false);
    const handleIngest = async () => {
        if (!userId)
            return;
        try {
            setIngesting(true);
            const response = await runIngestion({ user_id: userId });
            setStatuses(response.bank_statuses ?? []);
            setIngestDone(true);
            notifySuccess('–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
        }
        catch (error) {
            console.error(error);
            notifyError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π');
        }
        finally {
            setIngesting(false);
        }
    };
    const handleCommit = async () => {
        if (!userId)
            return;
        try {
            setCommitting(true);
            await commitOnboarding({ user_id: userId });
            setCommitDone(true);
            notifySuccess('–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω');
        }
        catch (error) {
            console.error(error);
            notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥');
        }
        finally {
            setCommitting(false);
        }
    };
    return (_jsx("div", { className: "app-main", children: _jsxs("div", { className: "card", children: [_jsx("h2", { children: "\u0428\u0430\u0433 8. \u0418\u043D\u0436\u0435\u0441\u0442 \u0438 \u043A\u043E\u043C\u043C\u0438\u0442" }), _jsx("p", { children: "\u0421\u043E\u0431\u0438\u0440\u0430\u0435\u043C \u0442\u0440\u0430\u043D\u0437\u0430\u043A\u0446\u0438\u0438 \u0441\u043E \u0432\u0441\u0435\u0445 \u0431\u0430\u043D\u043A\u043E\u0432 \u0438 \u0444\u0438\u043A\u0441\u0438\u0440\u0443\u0435\u043C \u0441\u0435\u0441\u0441\u0438\u044E." }), _jsx("button", { className: "btn", onClick: handleIngest, disabled: ingesting || ingestDone, children: ingestDone ? '–ì–æ—Ç–æ–≤–æ' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ' }), statuses.length ? (_jsx("ul", { className: "list", children: statuses.map((status) => (_jsxs("li", { children: [status.bank_name, ": ", status.status, " \u2014 ", status.message] }, status.bank_name))) })) : null, ingestDone ? (_jsx("button", { className: "btn", onClick: handleCommit, disabled: committing || commitDone, children: commitDone ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ' : 'Commit onboarding' })) : null, commitDone ? (_jsx("button", { className: "btn", style: { marginTop: 12 }, onClick: () => navigate('/dashboard'), children: "\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u043A \u0430\u043D\u0430\u043B\u0438\u0442\u0438\u043A\u0435" })) : null] }) }));
};
</file>

<file path="hktn/src/pages/IngestionPage.tsx">
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { commitOnboarding, runIngestion } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';

type BankStatus = {
  bank_name: string;
  status: string;
  message?: string;
};

export const IngestionPage: React.FC = () => {
  const { userId } = useUser();
  const { notifyError, notifySuccess } = useNotifications();
  const navigate = useNavigate();
  const [ingesting, setIngesting] = useState(false);
  const [committing, setCommitting] = useState(false);
  const [statuses, setStatuses] = useState<BankStatus[]>([]);
  const [ingestDone, setIngestDone] = useState(false);
  const [commitDone, setCommitDone] = useState(false);

  const handleIngest = async () => {
    if (!userId) return;
    try {
      setIngesting(true);
      const response = await runIngestion({ user_id: userId });
      setStatuses(response.bank_statuses ?? []);
      setIngestDone(true);
      notifySuccess('–ó–∞–≥—Ä—É–∑–∫–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
    } catch (error) {
      console.error(error);
      notifyError('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π');
    } finally {
      setIngesting(false);
    }
  };

  const handleCommit = async () => {
    if (!userId) return;
    try {
      setCommitting(true);
      await commitOnboarding({ user_id: userId });
      setCommitDone(true);
      notifySuccess('–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à—ë–Ω');
    } catch (error) {
      console.error(error);
      notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≤–µ—Ä—à–∏—Ç—å –æ–Ω–±–æ—Ä–¥–∏–Ω–≥');
    } finally {
      setCommitting(false);
    }
  };

  return (
    <div className="app-main">
      <div className="card">
        <h2>–®–∞–≥ 8. –ò–Ω–∂–µ—Å—Ç –∏ –∫–æ–º–º–∏—Ç</h2>
        <p>–°–æ–±–∏—Ä–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Å–æ –≤—Å–µ—Ö –±–∞–Ω–∫–æ–≤ –∏ —Ñ–∏–∫—Å–∏—Ä—É–µ–º —Å–µ—Å—Å–∏—é.</p>
        <button className="btn" onClick={handleIngest} disabled={ingesting || ingestDone}>
          {ingestDone ? '–ì–æ—Ç–æ–≤–æ' : '–ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ'}
        </button>
        {statuses.length ? (
          <ul className="list">
            {statuses.map((status) => (
              <li key={status.bank_name}>
                {status.bank_name}: {status.status} ‚Äî {status.message}
              </li>
            ))}
          </ul>
        ) : null}
        {ingestDone ? (
          <button className="btn" onClick={handleCommit} disabled={committing || commitDone}>
            {commitDone ? '–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ' : 'Commit onboarding'}
          </button>
        ) : null}
        {commitDone ? (
          <button className="btn" style={{ marginTop: 12 }} onClick={() => navigate('/dashboard')}>
            –ü–µ—Ä–µ–π—Ç–∏ –∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ
          </button>
        ) : null}
      </div>
    </div>
  );
};
</file>

<file path="hktn/src/pages/SaveGoalPage.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { saveGoal } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';
const paceOptions = [
    { value: 'conservative', label: '–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π' },
    { value: 'optimal', label: '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π' },
    { value: 'fast', label: '–ë—ã—Å—Ç—Ä—ã–π' },
];
export const SaveGoalPage = () => {
    const { userId } = useUser();
    const { notifyError, notifySuccess } = useNotifications();
    const navigate = useNavigate();
    const [amount, setAmount] = useState('100000');
    const [pace, setPace] = useState('optimal');
    const [monthly, setMonthly] = useState('20000');
    const [saving, setSaving] = useState(false);
    const handleSubmit = async (event) => {
        event.preventDefault();
        if (!userId)
            return;
        try {
            setSaving(true);
            await saveGoal({
                user_id: userId,
                goal_type: 'save_money',
                goal_details: {
                    save_amount: Number(amount),
                    save_speed: pace,
                    monthly_contribution: Number(monthly),
                },
            });
            notifySuccess('–¶–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
            navigate('/ingest');
        }
        catch (error) {
            console.error(error);
            notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å');
        }
        finally {
            setSaving(false);
        }
    };
    return (_jsx("div", { className: "app-main", children: _jsxs("form", { className: "card", onSubmit: handleSubmit, children: [_jsx("h2", { children: "\u0421\u043A\u043E\u043B\u044C\u043A\u043E \u0445\u043E\u0442\u0438\u0442\u0435 \u043E\u0442\u043B\u043E\u0436\u0438\u0442\u044C?" }), _jsx("label", { children: "\u0426\u0435\u043B\u0435\u0432\u0430\u044F \u0441\u0443\u043C\u043C\u0430, \u20BD" }), _jsx("input", { value: amount, onChange: (event) => setAmount(event.target.value), className: "text-input" }), _jsx("label", { children: "\u0422\u0435\u043C\u043F \u043D\u0430\u043A\u043E\u043F\u043B\u0435\u043D\u0438\u044F" }), _jsx("select", { value: pace, onChange: (event) => setPace(event.target.value), children: paceOptions.map((opt) => (_jsx("option", { value: opt.value, children: opt.label }, opt.value))) }), _jsx("label", { children: "\u0415\u0436\u0435\u043C\u0435\u0441\u044F\u0447\u043D\u044B\u0439 \u0432\u043A\u043B\u0430\u0434, \u20BD" }), _jsx("input", { value: monthly, onChange: (event) => setMonthly(event.target.value), className: "text-input" }), _jsx("button", { type: "submit", className: "btn", disabled: saving, children: "\u0421\u043E\u0445\u0440\u0430\u043D\u0438\u0442\u044C \u0438 \u043F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C" })] }) }));
};
</file>

<file path="hktn/src/pages/SaveGoalPage.tsx">
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { saveGoal } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';

const paceOptions = [
  { value: 'conservative', label: '–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π' },
  { value: 'optimal', label: '–û–ø—Ç–∏–º–∞–ª—å–Ω—ã–π' },
  { value: 'fast', label: '–ë—ã—Å—Ç—Ä—ã–π' },
];

export const SaveGoalPage: React.FC = () => {
  const { userId } = useUser();
  const { notifyError, notifySuccess } = useNotifications();
  const navigate = useNavigate();
  const [amount, setAmount] = useState('100000');
  const [pace, setPace] = useState('optimal');
  const [monthly, setMonthly] = useState('20000');
  const [saving, setSaving] = useState(false);

  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault();
    if (!userId) return;
    try {
      setSaving(true);
      await saveGoal({
        user_id: userId,
        goal_type: 'save_money',
        goal_details: {
          save_amount: Number(amount),
          save_speed: pace,
          monthly_contribution: Number(monthly),
        },
      });
      notifySuccess('–¶–µ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞');
      navigate('/ingest');
    } catch (error) {
      console.error(error);
      notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ü–µ–ª—å');
    } finally {
      setSaving(false);
    }
  };

  return (
    <div className="app-main">
      <form className="card" onSubmit={handleSubmit}>
        <h2>–°–∫–æ–ª—å–∫–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ª–æ–∂–∏—Ç—å?</h2>
        <label>–¶–µ–ª–µ–≤–∞—è —Å—É–º–º–∞, ‚ÇΩ</label>
        <input value={amount} onChange={(event) => setAmount(event.target.value)} className="text-input" />
        <label>–¢–µ–º–ø –Ω–∞–∫–æ–ø–ª–µ–Ω–∏—è</label>
        <select value={pace} onChange={(event) => setPace(event.target.value)}>
          {paceOptions.map((opt) => (
            <option key={opt.value} value={opt.value}>
              {opt.label}
            </option>
          ))}
        </select>
        <label>–ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –≤–∫–ª–∞–¥, ‚ÇΩ</label>
        <input value={monthly} onChange={(event) => setMonthly(event.target.value)} className="text-input" />
        <button type="submit" className="btn" disabled={saving}>
          –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
        </button>
      </form>
    </div>
  );
};
</file>

<file path="hktn/src/pages/UserIdPage.js">
import { jsx as _jsx } from "react/jsx-runtime";
import { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { UserIdForm } from '../components/UserIdForm';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';
export const UserIdPage = () => {
    const { userId, userName, setInitialUserData } = useUser();
    const { notifySuccess, notifyError } = useNotifications();
    const navigate = useNavigate();
    const [isSubmitting, setIsSubmitting] = useState(false);
    const handleSubmit = async (nextId, nextName) => {
        try {
            setIsSubmitting(true);
            setInitialUserData(nextId.toLowerCase(), nextName);
            notifySuccess('ID –∏ –∏–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
            navigate('/banks');
        }
        catch (error) {
            console.error(error);
            notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
        }
        finally {
            setIsSubmitting(false);
        }
    };
    return (_jsx("div", { className: "app-main", children: _jsx(UserIdForm, { defaultUserId: userId, defaultUserName: userName, onSubmit: handleSubmit, isSubmitting: isSubmitting }) }));
};
</file>

<file path="hktn/src/state/notifications.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { createContext, useCallback, useContext, useMemo, useState } from 'react';
const NotificationsContext = createContext(undefined);
export const NotificationsProvider = ({ children }) => {
    const [items, setItems] = useState([]);
    const dismiss = useCallback((id) => {
        setItems((prev) => prev.filter((item) => item.id !== id));
    }, []);
    const notify = useCallback((message, type = 'info') => {
        const id = `${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
        setItems((prev) => [...prev, { id, message, type }]);
        window.setTimeout(() => dismiss(id), 5000);
    }, [dismiss]);
    const contextValue = useMemo(() => ({
        notify,
        notifyError: (msg) => notify(msg, 'error'),
        notifySuccess: (msg) => notify(msg, 'success'),
    }), [notify]);
    return (_jsxs(NotificationsContext.Provider, { value: contextValue, children: [children, _jsx("div", { className: "toast-stack", role: "status", "aria-live": "polite", children: items.map((item) => (_jsx("div", { className: `toast toast-${item.type}`, children: item.message }, item.id))) })] }));
};
export const useNotifications = () => {
    const ctx = useContext(NotificationsContext);
    if (!ctx) {
        throw new Error('useNotifications must be used inside NotificationsProvider');
    }
    return ctx;
};
</file>

<file path="hktn/src/state/notifications.tsx">
import React, { createContext, useCallback, useContext, useMemo, useState } from 'react';

type Notification = {
  id: string;
  message: string;
  type: 'info' | 'error' | 'success';
};

type NotificationsContextValue = {
  notify: (message: string, type?: Notification['type']) => void;
  notifyError: (message: string) => void;
  notifySuccess: (message: string) => void;
};

const NotificationsContext = createContext<NotificationsContextValue | undefined>(undefined);

export const NotificationsProvider: React.FC<React.PropsWithChildren> = ({ children }) => {
  const [items, setItems] = useState<Notification[]>([]);

  const dismiss = useCallback((id: string) => {
    setItems((prev) => prev.filter((item) => item.id !== id));
  }, []);

  const notify = useCallback(
    (message: string, type: Notification['type'] = 'info') => {
      const id = `${Date.now()}-${Math.random().toString(36).slice(2, 6)}`;
      setItems((prev) => [...prev, { id, message, type }]);
      window.setTimeout(() => dismiss(id), 5000);
    },
    [dismiss]
  );

  const contextValue = useMemo<NotificationsContextValue>(
    () => ({
      notify,
      notifyError: (msg: string) => notify(msg, 'error'),
      notifySuccess: (msg: string) => notify(msg, 'success'),
    }),
    [notify]
  );

  return (
    <NotificationsContext.Provider value={contextValue}>
      {children}
      <div className="toast-stack" role="status" aria-live="polite">
        {items.map((item) => (
          <div key={item.id} className={`toast toast-${item.type}`}>
            {item.message}
          </div>
        ))}
      </div>
    </NotificationsContext.Provider>
  );
};

export const useNotifications = (): NotificationsContextValue => {
  const ctx = useContext(NotificationsContext);
  if (!ctx) {
    throw new Error('useNotifications must be used inside NotificationsProvider');
  }
  return ctx;
};
</file>

<file path="hktn/src/state/useUser.js">
import { jsx as _jsx } from "react/jsx-runtime";
import { createContext, useCallback, useContext, useEffect, useMemo, useState } from 'react';
import { getBanks } from '../api/client';
const STORAGE_KEY = 'finpulse:userId';
const USER_NAME_KEY = 'finpulse:userName';
const CONSENTS_KEY = 'finpulse:consents';
const UserContext = createContext(undefined);
const parseStoredConsents = () => {
    try {
        const serialized = localStorage.getItem(CONSENTS_KEY);
        if (!serialized) {
            return [];
        }
        const raw = JSON.parse(serialized);
        if (Array.isArray(raw)) {
            return raw.filter((item) => item && typeof item.bankId === 'string');
        }
        return [];
    }
    catch {
        return [];
    }
};
export const UserProvider = ({ children }) => {
    const [userId, setUserIdState] = useState(() => localStorage.getItem(STORAGE_KEY));
    const [userName, setUserNameState] = useState(() => localStorage.getItem(USER_NAME_KEY));
    const [consents, setConsents] = useState(parseStoredConsents);
    const [banks, setBanks] = useState([]);
    const [isFetchingBanks, setIsFetchingBanks] = useState(false);
    const setInitialUserData = useCallback((nextId, nextName) => {
        localStorage.setItem(STORAGE_KEY, nextId);
        setUserIdState(nextId);
        localStorage.setItem(USER_NAME_KEY, nextName);
        setUserNameState(nextName);
    }, []);
    const clearUser = useCallback(() => {
        localStorage.removeItem(STORAGE_KEY);
        localStorage.removeItem(USER_NAME_KEY);
        localStorage.removeItem(CONSENTS_KEY);
        setUserIdState(null);
        setUserNameState(null);
        setConsents([]);
        setBanks([]);
    }, []);
    const upsertConsent = useCallback((update) => {
        setConsents((prev) => {
            const next = [...prev];
            const index = next.findIndex((item) => item.bankId === update.bankId);
            const payload = {
                ...(index >= 0 ? next[index] : {}),
                ...update,
                lastUpdated: Date.now(),
            };
            if (index >= 0) {
                next[index] = payload;
            }
            else {
                next.push(payload);
            }
            localStorage.setItem(CONSENTS_KEY, JSON.stringify(next));
            return next;
        });
    }, []);
    const refreshBanks = useCallback(async () => {
        if (!userId) {
            setBanks([]);
            return;
        }
        try {
            setIsFetchingBanks(true);
            const response = await getBanks(userId);
            setBanks(response.banks ?? []);
        }
        catch (error) {
            console.error('Failed to fetch banks', error);
        }
        finally {
            setIsFetchingBanks(false);
        }
    }, [userId]);
    useEffect(() => {
        if (userId) {
            refreshBanks();
        }
    }, [userId, refreshBanks]);
    const value = useMemo(() => ({
        userId,
        userName,
        setInitialUserData,
        clearUser,
        consents,
        upsertConsent,
        banks,
        refreshBanks,
        isFetchingBanks,
    }), [banks, clearUser, consents, isFetchingBanks, refreshBanks, upsertConsent, setInitialUserData, userId, userName]);
    return _jsx(UserContext.Provider, { value: value, children: children });
};
export const useUser = () => {
    const ctx = useContext(UserContext);
    if (!ctx) {
        throw new Error('useUser must be used inside UserProvider');
    }
    return ctx;
};
</file>

<file path="hktn/src/test/setup.js">
import '@testing-library/jest-dom';
</file>

<file path="hktn/src/test/setup.ts">
import '@testing-library/jest-dom';
</file>

<file path="hktn/src/types/dashboard.ts">
export type ObligationSource =
  | 'credit_agreement'
  | 'recurring_debit'
  | 'recurring_income'
  | 'income_event'
  | 'expense_event'
  | (string & Record<never, never>);

export type MetadataMixin = {
  mcc_code?: string | null;
  category?: string | null;
  merchant_name?: string | null;
  bank_transaction_code?: string | null;
  source?: ObligationSource | null;
  frequency_days?: number | null;
};

export type UpcomingPayment = MetadataMixin & {
  name: string;
  amount: number | null;
  due_date: string;
};

export type RecurringEvent = MetadataMixin & {
  name: string;
  amount: number;
  is_income: boolean;
  next_date: string;
};

export type CreditRanking = {
  name: string;
  balance: number;
  rate?: number;
  min_payment: number;
  days_past_due?: number;
  stress_score?: number;
};

export type DashboardAnalysis = {
  recommendation?: string;
  color_zone?: string;
  payment_amount?: number;
  payment_date?: string;
  [key: string]: unknown;
};

export type DashboardResponse = {
  analysis?: DashboardAnalysis;
  safe_to_spend?: number;
  safe_to_spend_daily?: number;
  goal_probability?: number;
  bank_statuses?: Record<string, { status: string; message?: string }>;
  recurring_events?: RecurringEvent[];
  total_debt?: number;
  monthly_income?: number;
  monthly_payments?: number;
  health_score?: number;
  upcoming_payments?: UpcomingPayment[];
  current_balance?: number;
  credit_rankings?: CreditRanking[];
};
</file>

<file path="hktn/src/main.js">
import { jsx as _jsx } from "react/jsx-runtime";
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import App from './App';
import './styles/global.css';
import { UserProvider } from './state/useUser';
import { NotificationsProvider } from './state/notifications';
ReactDOM.createRoot(document.getElementById('root')).render(_jsx(React.StrictMode, { children: _jsx(NotificationsProvider, { children: _jsx(UserProvider, { children: _jsx(BrowserRouter, { children: _jsx(App, {}) }) }) }) }));
</file>

<file path="hktn/src/main.tsx">
import React from 'react';
import ReactDOM from 'react-dom/client';
import { BrowserRouter } from 'react-router-dom';
import App from './App';
import './styles/global.css';
import { UserProvider } from './state/useUser';
import { NotificationsProvider } from './state/notifications';

ReactDOM.createRoot(document.getElementById('root') as HTMLElement).render(
  <React.StrictMode>
    <NotificationsProvider>
      <UserProvider>
        <BrowserRouter>
          <App />
        </BrowserRouter>
      </UserProvider>
    </NotificationsProvider>
  </React.StrictMode>
);
</file>

<file path="hktn/src/vite-env.d.ts">
/// <reference types="vite/client" />
</file>

<file path="hktn/index.html">
<!DOCTYPE html>
  <html lang="en">
    <head>
      <meta charset="UTF-8" />
      <meta name="viewport" content="width=device-width, initial-scale=1.0" />
      <title>Main screens</title>
    </head>

    <body>
      <div id="root"></div>
      <script type="module" src="/src/main.tsx"></script>
    </body>
  </html>
</file>

<file path="hktn/jest.config.ts">
import type { Config } from 'jest';

const config: Config = {
  preset: 'ts-jest',
  testEnvironment: 'jsdom',
  roots: ['<rootDir>/src', '<rootDir>/tests'],
  moduleFileExtensions: ['ts', 'tsx', 'js', 'jsx', 'json'],
  setupFilesAfterEnv: ['<rootDir>/src/setupTests.ts'],
  transform: {
    '^.+\\.(ts|tsx)$': [
      'ts-jest',
      {
        tsconfig: '<rootDir>/tsconfig.json',
      },
    ],
  },
};

export default config;
</file>

<file path="hktn/package.json">
{
  "name": "finpulse-open-banking-ui",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc && vite build",
    "preview": "vite preview",
    "test": "vitest run"
  },
  "dependencies": {
    "react": "^18.2.0",
    "react-dom": "^18.2.0",
    "react-router-dom": "^6.22.3"
  },
  "devDependencies": {
    "@testing-library/jest-dom": "^6.4.2",
    "@testing-library/react": "^14.1.2",
    "@testing-library/user-event": "^14.4.3",
    "@types/jest": "^29.5.12",
    "@types/react": "^18.2.66",
    "@types/react-dom": "^18.2.22",
    "@vitejs/plugin-react": "^4.2.1",
    "jest": "^29.7.0",
    "jest-environment-jsdom": "^29.7.0",
    "jsdom": "^24.1.3",
    "ts-jest": "^29.1.1",
    "ts-node": "^10.9.2",
    "typescript": "^5.3.3",
    "vite": "^5.1.4",
    "vitest": "^1.6.1"
  }
}
</file>

<file path="hktn/requirements.txt">
# -- Backend Framework --
# FastAPI –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è REST API –∏ Uvicorn –¥–ª—è –µ–≥–æ –∑–∞–ø—É—Å–∫–∞.
fastapi
uvicorn[standard]
python-multipart

# -- Data Science & Analytics --
# –û—Å–Ω–æ–≤–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–≤–∏–∂–∫–∞ "–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ü—É–ª—å—Å".
pandas
numpy
scikit-learn
scipy

# -- Core Utilities & API Communication --
# –ë–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è HTTP-–∑–∞–ø—Ä–æ—Å–æ–≤, —Ä–∞–±–æ—Ç—ã —Å JWT, .env —Ñ–∞–π–ª–∞–º–∏ –∏ –º–æ–¥–µ–ª—è–º–∏ –¥–∞–Ω–Ω—ã—Ö.
httpx[http2]
pydantic
python-dotenv
pyjwt[crypto]
tenacity
cachetools
pytest
pytest-asyncio
pytest-mock
respx
</file>

<file path="hktn/tsconfig.json">
{
  "compilerOptions": {
    "target": "ES2020",
    "useDefineForClassFields": true,
    "lib": ["DOM", "DOM.Iterable", "ES2020"],
    "module": "ESNext",
    "moduleResolution": "Node",
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "strict": true,
    "forceConsistentCasingInFileNames": true,
    "skipLibCheck": true,
    "resolveJsonModule": true,
    "jsx": "react-jsx"
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
</file>

<file path="hktn/tsconfig.node.json">
{
  "compilerOptions": {
    "composite": true,
    "module": "ESNext",
    "moduleResolution": "Node",
    "allowSyntheticDefaultImports": true
  },
  "include": ["vite.config.ts"]
}
</file>

<file path=".gitignore">
cat <<'EOF' > .gitignore
# Python artifacts
__pycache__/
*.py[cod]
*.sqlite3
*.db
*.log
.env
.venv/
venv/
*venv/
.pytest_cache/
tests/
data/tests/
hktn/tests/
data/out/

# Node artifacts
node_modules/
hktn/node_modules/
yarn.lock
package-lock.json
npm-debug.log
dist/

# IDE/editor
.vscode/
.idea/

# Misc
*.egg-info/
*.egg
.DS_Store
EOF
</file>

<file path="hktn/backend/routers/consents.py">
from __future__ import annotations

from fastapi import APIRouter, Request
from fastapi.responses import RedirectResponse

from ..config import settings
from ..schemas import ConsentInitiateRequest
from ..services import consents

router = APIRouter(prefix="/api", tags=["consents"])


@router.post("/consent/initiate")
async def initiate_consent(req: ConsentInitiateRequest):
    return await consents.initiate_consent(req)


@router.post("/consent/initiate/product")
async def initiate_product_consent(req: ConsentInitiateRequest):
    return await consents.initiate_product_consent(req)


@router.post("/consents/start")
async def start_consent_alias(req: ConsentInitiateRequest):
    """Specification-friendly alias for /api/consent/initiate."""
    return await consents.initiate_consent(req)


@router.get("/consent/callback")
async def consent_callback(request: Request, consent_id: str):
    consents.mark_consent_from_callback(consent_id)
    return RedirectResponse(url=f"{settings.frontend_url}/callback")


@router.get("/consent/status")
async def get_consent_status(user_id: str, bank_id: str, request_id: str):
    return await consents.poll_consent_status(user_id=user_id, bank_id=bank_id, request_id=request_id)


@router.get("/consents/status")
async def get_consent_status_alias(user_id: str, bank_id: str, request_id: str):
    """Specification-friendly alias for /api/consent/status."""
    return await consents.poll_consent_status(user_id=user_id, bank_id=bank_id, request_id=request_id)
</file>

<file path="hktn/backend/routers/profile.py">
from __future__ import annotations

import logging

from fastapi import APIRouter, HTTPException

from hktn.core.database import save_user_profile

from ..schemas import GoalRequest

logger = logging.getLogger("finpulse.backend.profile")
router = APIRouter(prefix="/api", tags=["profile"])


@router.post("/profile/goal")
async def set_user_goal(req: GoalRequest):
    """Persist the user's selected financial goal."""
    try:
        save_user_profile(req.user_id, req.goal_type, req.goal_details)
        logger.info("Goal saved for user %s (%s)", req.user_id, req.goal_type)
        return {"status": "ok", "message": "Goal saved successfully."}
    except Exception as exc:  # noqa: BLE001
        logger.error("Failed to save goal for user %s: %s", req.user_id, exc)
        raise HTTPException(status_code=500, detail="Could not save user profile.") from exc
</file>

<file path="hktn/backend/services/goals.py">
from __future__ import annotations

from typing import Any, Dict, Optional

from hktn.core.analytics_engine import UserGoal

VALID_GOAL_PACES = {"conservative", "optimal", "fast"}


def _ensure_goal_details(payload: Optional[Dict[str, Any]]) -> Dict[str, Any]:
    if isinstance(payload, dict):
        return dict(payload)
    return {}


def compose_user_goal(
    stored_goal: Optional[Dict[str, Any]],
    goal_type_override: Optional[str] = None,
    goal_details_override: Optional[Dict[str, Any]] = None,
    pace_override: Optional[str] = None,
) -> UserGoal:
    base_details = _ensure_goal_details(goal_details_override) or _ensure_goal_details(
        (stored_goal or {}).get("goal_details")
        if stored_goal
        else {}
    )
    goal_type = goal_type_override or (stored_goal or {}).get("goal_type")
    if not goal_type:
        goal_type = "pay_debts"

    pace_candidates = (
        pace_override,
        base_details.get("pace"),
        base_details.get("save_speed"),
        base_details.get("close_speed"),
    )
    pace = next(
        (candidate for candidate in pace_candidates if isinstance(candidate, str) and candidate in VALID_GOAL_PACES),
        "optimal",
    )
    return UserGoal(goal_type=goal_type, pace=pace, goal_details=base_details)
</file>

<file path="hktn/backend/app.py">
from __future__ import annotations

import logging

from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

from hktn.core.database import init_db
from .config import settings
from .routers import analytics, banks, consents, onboarding, profile

logging.basicConfig(level=logging.INFO)
logger = logging.getLogger("finpulse.backend")


def create_app() -> FastAPI:
    app = FastAPI(title=settings.title, version=settings.version)

    app.add_middleware(
        CORSMiddleware,
        allow_origins=settings.cors_origins,
        allow_credentials=True,
        allow_methods=["*"],
        allow_headers=["*"],
    )

    app.include_router(banks.router)
    app.include_router(consents.router)
    app.include_router(onboarding.router)
    app.include_router(profile.router)
    app.include_router(analytics.router)

    @app.on_event("startup")
    def _on_startup() -> None:
        logger.info("Bootstrapping FinPulse backend")
        init_db()

    return app


app = create_app()
</file>

<file path="hktn/core/analytics_engine.py">
"""Financial Pulse analytics engine with probabilistic forecasting."""
from __future__ import annotations

import math
import re
from collections import Counter
from datetime import date, datetime, timedelta
from typing import Any, Dict, Iterable, List, Optional, Sequence, Tuple, Literal

import numpy as np
import pandas as pd
from scipy.spatial.distance import cosine
from sklearn.cluster import DBSCAN
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.preprocessing import StandardScaler

from pydantic import BaseModel, Field

from .data_models import AnalysisResult, Transaction

# Feature weighting balances numeric and textual signal strength.
_NUMERIC_FEATURE_WEIGHT = 2.5
_TEXT_FEATURE_WEIGHT = 1.0
_DEFAULT_SIMULATIONS = 1200
_MIN_SIGMA_AMOUNT = 1.0


class UserGoal(BaseModel):
    """Represents user's desired financial outcome and preferred pace."""

    goal_type: Literal["pay_debts", "save_money"] = "pay_debts"
    pace: Literal["conservative", "optimal", "fast"] = "optimal"
    goal_details: Dict[str, Any] = Field(default_factory=dict)


def _safe_float(value: Any) -> Optional[float]:
    """Best-effort conversion to float."""
    if value is None:
        return None
    if isinstance(value, (int, float)) and not isinstance(value, bool):
        return float(value)
    if isinstance(value, str):
        try:
            return float(value.strip())
        except ValueError:
            return None
    return None


def _stringify(value: Any) -> str:
    """Return a trimmed string representation for feature engineering."""
    if value is None:
        return ""
    if isinstance(value, str):
        return value.strip()
    return str(value).strip()


def estimate_goal_probability(
    goal: UserGoal,
    trajectories: np.ndarray,
    forecast_dates: Sequence[date],
    obligations: Optional[Sequence[Dict[str, Any]]] = None,
    event_profiles: Optional[Sequence[Dict[str, Any]]] = None,
) -> int:
    """
    Approximate probability (0-100%) that a user will hit the selected goal.
    save_money: share of forecast paths ending above the target balance.
    pay_debts: compares recurring income vs. required obligations.
    """
    if trajectories.size == 0 or not forecast_dates:
        return 0

    details = goal.goal_details or {}
    terminal_balances = trajectories[:, -1]

    if goal.goal_type == "save_money":
        target_candidates = (
            details.get("save_amount"),
            details.get("target_amount"),
            details.get("targeted_balance"),
        )
        target_amount = next(
            (val for val in ( _safe_float(candidate) for candidate in target_candidates ) if val is not None),
            None,
        )
        if target_amount is None or target_amount <= 0:
            target_amount = float(np.median(terminal_balances))
        probability = float(np.mean(terminal_balances >= target_amount))
        return int(round(np.clip(probability * 100.0, 0.0, 100.0)))

    # pay_debts
    obligation_total = sum(float(item.get("amount") or 0.0) for item in obligations or [])
    targeted_payment = _safe_float(details.get("targeted_monthly_payment"))
    if obligation_total <= 0 and targeted_payment:
        obligation_total = targeted_payment
    if obligation_total <= 0:
        return 85  # nothing to pay off

    income_total = 0.0
    for profile in event_profiles or []:
        if profile.get("is_income"):
            income_total += float(profile.get("mu_amount") or 0.0)
    if income_total <= 0:
        declared_income = _safe_float(details.get("declared_income"))
        income_total = declared_income or 0.0
    if income_total <= 0:
        return 25

    coverage_ratio = income_total / max(obligation_total, 1.0)
    probability = np.clip(coverage_ratio / 1.5, 0.0, 1.0) * 100.0
    return int(round(probability))


def _coerce_to_date(value: Any) -> Optional[date]:
    """Normalize multiple date formats to python date."""
    if value is None:
        return None
    if isinstance(value, date) and not isinstance(value, datetime):
        return value
    if isinstance(value, datetime):
        return value.date()
    if isinstance(value, pd.Timestamp):
        return value.to_pydatetime().date()
    if isinstance(value, str):
        try:
            normalized = value.replace("Z", "")
            return datetime.fromisoformat(normalized).date()
        except ValueError:
            return None
    return None


def extract_recurring_events(
    event_profiles: Sequence[Dict[str, Any]],
    limit: int = 8,
) -> List[Dict[str, Any]]:
    """Produce a simplified list of recurring events for UI."""
    events: List[Dict[str, Any]] = []
    today = date.today()

    for profile in event_profiles or []:
        label = profile.get("label") or profile.get("merchant") or "Recurring"
        amount = round(float(profile.get("mu_amount") or 0.0), 2)
        is_income = bool(profile.get("is_income"))
        frequency_days = int(profile.get("frequency_days") or profile.get("frequencyDays") or 30)
        frequency_days = max(frequency_days, 1)
        last_date = _coerce_to_date(
            profile.get("last_date")
            or profile.get("lastDate")
            or profile.get("last_occurrence")
            or profile.get("lastOccurrence")
        )
        next_date = last_date or today
        while next_date <= today:
            next_date += timedelta(days=frequency_days)

        metadata = profile.get("metadata") or {}
        mcc_code = profile.get("mcc_code") or metadata.get("dominant_mcc_code")
        category = (
            profile.get("merchant_category")
            or metadata.get("merchant_category")
            or metadata.get("transaction_category")
        )
        merchant_name = profile.get("merchant_name") or metadata.get("dominant_merchant")
        source = profile.get("source") or ("recurring_income" if is_income else "recurring_debit")

        events.append(
            {
                "name": label,
                "amount": amount,
                "is_income": is_income,
                "next_date": next_date.isoformat(),
                "frequency_days": frequency_days,
                "mcc_code": mcc_code,
                "category": category,
                "merchant_name": merchant_name,
                "bank_transaction_code": profile.get("bank_transaction_code")
                or metadata.get("dominant_bank_transaction_code"),
                "source": source,
            }
        )

    events.sort(key=lambda item: item["next_date"])
    return events[:limit]


def _calculate_annuity_payment(principal: float, annual_rate_percent: float, term_months: int) -> float:
    """
    Compute best-effort annuity payment when API does not return min_payment explicitly.
    """
    if principal <= 0:
        return 0.0
    if term_months <= 0:
        return 0.0
    if annual_rate_percent <= 0:
        return round(principal / term_months, 2)

    monthly_rate = (annual_rate_percent / 100.0) / 12.0
    try:
        factor = (1 + monthly_rate) ** term_months
        denom = factor - 1
        if denom == 0:
            payment = principal / term_months
        else:
            payment = principal * (monthly_rate * factor / denom)
    except OverflowError:
        payment = principal / term_months
    return round(payment, 2)


def _parse_payment_date(date_raw: Optional[str]) -> Optional[date]:
    """Safely parse payment date from ISO-like formats."""
    if not date_raw:
        return None
    try:
        normalized = date_raw.replace("Z", "")
        return datetime.fromisoformat(normalized).date()
    except (ValueError, TypeError, AttributeError):
        return None


def _create_obligations_from_credits(credits: Sequence[Dict[str, Any]]) -> List[Dict[str, Any]]:
    """Transform credit agreements into deterministic payment obligations."""
    obligations: List[Dict[str, Any]] = []
    for credit in credits or []:
        payment_amount = float(credit.get("min_payment") or credit.get("payment") or 0.0)
        if payment_amount <= 0:
            principal = float(credit.get("balance") or credit.get("principal") or 0.0)
            rate = float(credit.get("rate") or credit.get("interest_rate") or 0.0)
            term_months = int(credit.get("term_months") or credit.get("termMonths") or 36)
            if principal > 0:
                payment_amount = _calculate_annuity_payment(principal, rate * 100 if rate < 1 else rate, term_months)

        if payment_amount <= 0:
            continue

        obligations.append(
            {
                "label": credit.get("name") or credit.get("product") or "–ö—Ä–µ–¥–∏—Ç–Ω—ã–π –ø–ª–∞—Ç–µ–∂",
                "amount": round(payment_amount, 2),
                "due_date": _parse_payment_date(credit.get("next_payment_date")),
                "source": "credit_agreement",
                "mcc_code": credit.get("mccCode"),
                "merchant_name": credit.get("name"),
                "category": credit.get("category") or credit.get("type"),
                "bank_transaction_code": None,
                "frequency_days": 30,
            }
        )
    return obligations


def _event_to_obligation(event: Dict[str, Any]) -> Optional[Dict[str, Any]]:
    """Convert a debit event profile into a deterministic obligation payload."""
    if event.get("is_income"):
        return None

    amount = abs(float(event.get("mu_amount") or 0.0))
    if amount <= 0:
        return None

    sample_size = int(event.get("sample_size") or 0)
    if sample_size < 2:
        return None

    coherence = float(event.get("coherence") or 0.0)
    metadata = event.get("metadata") or {}
    mcc_code = event.get("mcc_code") or metadata.get("dominant_mcc_code")
    mcc_consistency = float(metadata.get("mcc_consistency") or 0.0)

    if coherence < 0.55 and mcc_consistency < 0.5:
        return None

    frequency_days = max(int(round(event.get("frequency_days") or 30)), 1)
    last_date = event.get("last_date")
    if isinstance(last_date, pd.Timestamp):
        last_date = last_date.date()
    elif isinstance(last_date, datetime):
        last_date = last_date.date()
    if not isinstance(last_date, date):
        last_date = date.today()

    next_due = last_date
    while next_due <= date.today():
        next_due += timedelta(days=frequency_days)

    label = (
        metadata.get("dominant_merchant")
        or metadata.get("merchant_category")
        or event.get("label")
        or "Recurring debit"
    )

    return {
        "label": label,
        "amount": round(amount, 2),
        "due_date": next_due,
        "source": "recurring_debit",
        "mcc_code": mcc_code,
        "merchant_name": metadata.get("dominant_merchant"),
        "category": metadata.get("merchant_category") or metadata.get("transaction_category"),
        "bank_transaction_code": event.get("bank_transaction_code"),
        "cluster_id": event.get("cluster_id"),
        "frequency_days": frequency_days,
    }


def derive_obligations(
    credits: Sequence[Dict[str, Any]],
    event_profiles: Sequence[Dict[str, Any]],
) -> List[Dict[str, Any]]:
    """Combine credit-derived obligations with recurring debit events."""
    obligations = _create_obligations_from_credits(credits)
    for event in event_profiles or []:
        obligation = _event_to_obligation(event)
        if obligation:
            obligations.append(obligation)
    return obligations


def _credit_identifier(credit: Dict[str, Any]) -> Optional[str]:
    for key in ("id", "agreement_id", "credit_id", "product_id"):
        if credit.get(key):
            return str(credit[key])
    return None


PACE_COEFFICIENTS: Dict[str, float] = {
    "conservative": 0.10,
    "optimal": 0.25,
    "fast": 0.50,
}


def _find_next_income_event(event_profiles: List[Dict[str, Any]], start_date: date) -> Optional[Dict[str, Any]]:
    """Locate the soonest expected income event."""
    candidates: List[Dict[str, Any]] = []
    for event in event_profiles or []:
        if not event.get("is_income"):
            continue
        last_date: date = event.get("last_date") or start_date
        frequency = timedelta(days=max(int(round(event.get("frequency_days", 30) or 30)), 1))
        next_date = last_date
        while next_date <= start_date:
            next_date += frequency
        candidates.append(
            {
                "next_occurrence": next_date,
                "mu_amount": float(event.get("mu_amount") or 0.0),
                "label": event.get("label") or "–î–æ—Ö–æ–¥",
            }
        )
    if not candidates:
        return None
    return min(candidates, key=lambda item: item["next_occurrence"])


def _extract_account_balance(account: Dict[str, Any]) -> float:
    """Best-effort balance extraction across heterogeneous account payloads."""
    balance_keys = (
        "available_balance",
        "availableBalance",
        "balance",
        "current_balance",
        "currentBalance",
    )
    for key in balance_keys:
        if key in account and account[key] is not None:
            try:
                return float(account[key])
            except (TypeError, ValueError):
                continue
    return 0.0


def calculate_daily_s2s(
    current_balance: float,
    event_profiles: List[Dict[str, Any]],
    obligations: List[Dict[str, Any]],
    user_goal: UserGoal,
    start_date: Optional[date] = None,
) -> float:
    """Estimate safe-to-spend per day leveraging detected income cycle and obligations."""
    if start_date is None:
        start_date = date.today()

    next_income = _find_next_income_event(event_profiles, start_date)
    if next_income:
        cycle_end = next_income["next_occurrence"]
    else:
        cycle_end = start_date + timedelta(days=30)

    days_in_cycle = max((cycle_end - start_date).days, 1)

    cycle_expenses = 0.0
    for obligation in obligations or []:
        due_date = obligation.get("due_date")
        if isinstance(due_date, date) and start_date < due_date <= cycle_end:
            cycle_expenses += float(obligation.get("amount") or 0.0)

    for event in event_profiles or []:
        if event.get("is_income"):
            continue
        cycle_expenses += abs(float(event.get("mu_amount") or 0.0))

    free_cash = current_balance - cycle_expenses
    if free_cash <= 0:
        return 0.0

    reserve = 0.0
    if user_goal.goal_type == "pay_debts":
        reserve = free_cash * PACE_COEFFICIENTS.get(user_goal.pace, 0.25)

    spendable = max(0.0, free_cash - reserve)
    return round(spendable / days_in_cycle, 2)


def _normalize_description(value: Optional[str]) -> str:
    """Normalize merchant description: lowercase alpha characters only."""
    if not isinstance(value, str):
        return "unknown"
    cleaned = re.sub(r"[^a-zA-Z–∞-—è–ê-–Ø\s]", " ", value).lower()
    normalized = re.sub(r"\s+", " ", cleaned).strip()
    return normalized or "unknown"


def _prepare_transactions_df(transactions: Sequence[Transaction]) -> pd.DataFrame:
    """Convert transactions into a consistently typed DataFrame."""
    if not transactions:
        return pd.DataFrame(columns=["transactionId", "amount", "description", "bookingDate"])

    df = pd.DataFrame([tx.model_dump() for tx in transactions])
    df["bookingDate"] = pd.to_datetime(df["bookingDate"])
    df = df.sort_values("bookingDate").reset_index(drop=True)
    for field in ("description", "transactionInformation", "creditDebitIndicator", "bankTransactionCode", "mccCode", "category"):
        if field not in df:
            df[field] = None
    if "merchant" not in df:
        df["merchant"] = [{} for _ in range(len(df))]

    df["description"] = df["description"].fillna("")
    df["transactionInformation"] = df["transactionInformation"].fillna("")
    merchant_series = df["merchant"].apply(lambda value: value if isinstance(value, dict) else {})
    df["merchantName"] = merchant_series.apply(lambda merchant: _stringify(merchant.get("name")))
    df["merchantCategory"] = merchant_series.apply(lambda merchant: _stringify(merchant.get("category")))
    df["merchantMcc"] = merchant_series.apply(lambda merchant: _stringify(merchant.get("mccCode") or merchant.get("mcc")))

    empty_mask = df["description"].str.strip() == ""
    df.loc[empty_mask, "description"] = df.loc[empty_mask, "transactionInformation"]
    empty_mask = df["description"].str.strip() == ""
    df.loc[empty_mask, "description"] = df.loc[empty_mask, "merchantName"]
    df["description"] = df["description"].fillna("")

    df["bankTransactionCode"] = df["bankTransactionCode"].apply(_stringify)
    df["creditDebitIndicator"] = df["creditDebitIndicator"].apply(_stringify)
    df["category"] = df["category"].apply(_stringify)
    df["mcc_code"] = df["mccCode"]
    df.loc[df["mcc_code"].isna(), "mcc_code"] = df.loc[df["mcc_code"].isna(), "merchantMcc"]
    df["mcc_code"] = df["mcc_code"].apply(lambda value: _stringify(value) or None)
    df["has_mcc"] = df["mcc_code"].notna()

    df["normalized_description"] = df["description"].apply(_normalize_description)
    df["day_of_month"] = df["bookingDate"].dt.day.astype(float)
    df["is_income"] = (df["amount"] >= 0).astype(int)
    return df


def _discover_events(df: pd.DataFrame) -> pd.DataFrame:
    """Cluster transactions that form recurring financial events."""
    if df.empty:
        df["cluster_id"] = []
        return df

    text_vectorizer = TfidfVectorizer(min_df=1, ngram_range=(1, 2))
    text_features = text_vectorizer.fit_transform(df["normalized_description"]).toarray()
    if text_features.size == 0:
        text_features = np.zeros((len(df), 1))

    scaler = StandardScaler()
    numeric_features = df[["amount", "day_of_month"]].astype(float)
    scaled_numeric = scaler.fit_transform(numeric_features) * _NUMERIC_FEATURE_WEIGHT
    scaled_text = text_features * _TEXT_FEATURE_WEIGHT

    feature_matrix = np.hstack([scaled_numeric, scaled_text])

    if len(df) < 2:
        cluster_labels = np.full(len(df), -1, dtype=int)
    else:
        dbscan = DBSCAN(eps=0.85, min_samples=2, metric="euclidean")
        cluster_labels = dbscan.fit_predict(feature_matrix)

    df_with_clusters = df.copy()
    df_with_clusters["cluster_id"] = cluster_labels
    return df_with_clusters


def _cluster_label(descriptions: Iterable[str]) -> str:
    """Generate a human readable label for cluster."""
    filtered = [desc for desc in descriptions if desc]
    if not filtered:
        return "Recurring event"

    token_counter: Counter[str] = Counter()
    for desc in filtered:
        token_counter.update(desc.split())

    most_common = token_counter.most_common(2)
    label = " ".join(token for token, _ in most_common[:2])
    return label.title() if label else "Recurring event"


def _cluster_coherence(normalized_descriptions: Sequence[str]) -> float:
    """Estimate textual cohesion inside the cluster using cosine similarity."""
    if len(normalized_descriptions) <= 1:
        return 1.0

    vectorizer = TfidfVectorizer()
    matrix = vectorizer.fit_transform(normalized_descriptions).toarray()
    centroid = matrix.mean(axis=0)
    # Guard against degenerate vectors.
    if not np.any(centroid):
        return 0.5
    similarities = []
    for row in matrix:
        if not np.any(row):
            continue
        similarities.append(1 - cosine(centroid, row))
    return float(np.mean(similarities)) if similarities else 0.5


def _profile_events(df_with_clusters: pd.DataFrame) -> Tuple[List[Dict[str, object]], Dict[str, float]]:
    """Build probabilistic profiles for discovered events and background noise."""
    event_profiles: List[Dict[str, object]] = []

    for cluster_id, cluster_df in df_with_clusters.groupby("cluster_id"):
        if cluster_id == -1:
            continue

        cluster_df = cluster_df.sort_values("bookingDate")
        amount_series = cluster_df["amount"]
        day_series = cluster_df["day_of_month"]

        # Exponentially weighted mean emphasises recent behavior.
        mu_amount = float(cluster_df["amount"].ewm(alpha=0.35).mean().iloc[-1])
        sigma_amount = float(amount_series.std(ddof=0)) if len(cluster_df) > 1 else 0.0
        sigma_amount = max(sigma_amount, _MIN_SIGMA_AMOUNT)

        mu_day = float(day_series.mean())
        sigma_day = float(day_series.std(ddof=0)) if len(cluster_df) > 1 else 1.5
        sigma_day = max(sigma_day, 1.5)

        intervals = cluster_df["bookingDate"].diff().dt.days.dropna()
        if not intervals.empty:
            frequency_days = float(np.clip(np.median(intervals), 1, 45))
        else:
            frequency_days = 30.0

        descriptions = cluster_df["description"].tolist()
        normalized_descriptions = cluster_df["normalized_description"].tolist()
        label = _cluster_label(normalized_descriptions)
        coherence = _cluster_coherence(normalized_descriptions)
        last_date = cluster_df["bookingDate"].iloc[-1].date()
        dominant_sign = cluster_df["is_income"].mean()

        mcc_counter = Counter(code for code in cluster_df["mcc_code"].tolist() if code)
        bank_code_counter = Counter(code for code in cluster_df["bankTransactionCode"].tolist() if code)
        merchant_counter = Counter(name for name in cluster_df["merchantName"].tolist() if name)
        merchant_category_counter = Counter(cat for cat in cluster_df["merchantCategory"].tolist() if cat)
        txn_category_counter = Counter(cat for cat in cluster_df["category"].tolist() if cat)

        dominant_mcc = mcc_counter.most_common(1)[0][0] if mcc_counter else None
        dominant_bank_code = bank_code_counter.most_common(1)[0][0] if bank_code_counter else None
        dominant_merchant = merchant_counter.most_common(1)[0][0] if merchant_counter else None
        dominant_merchant_category = (
            merchant_category_counter.most_common(1)[0][0] if merchant_category_counter else None
        )
        dominant_txn_category = txn_category_counter.most_common(1)[0][0] if txn_category_counter else None
        total_mcc_samples = sum(mcc_counter.values())
        mcc_consistency = (
            mcc_counter[dominant_mcc] / total_mcc_samples if dominant_mcc and total_mcc_samples else 0.0
        )

        metadata = {
            "dominant_mcc_code": dominant_mcc,
            "dominant_bank_transaction_code": dominant_bank_code,
            "dominant_merchant": dominant_merchant,
            "merchant_category": dominant_merchant_category,
            "transaction_category": dominant_txn_category,
            "mcc_consistency": mcc_consistency,
        }
        source_label = "income_event" if bool(dominant_sign >= 0.5) else "expense_event"

        event_profiles.append(
            {
                "cluster_id": int(cluster_id),
                "label": label,
                "mu_amount": mu_amount,
                "sigma_amount": sigma_amount,
                "mu_day": mu_day,
                "sigma_day": sigma_day,
                "frequency_days": frequency_days,
                "last_date": last_date,
                "is_income": bool(dominant_sign >= 0.5),
                "coherence": coherence,
                "sample_size": len(cluster_df),
                "descriptions": descriptions,
                "mcc_code": dominant_mcc,
                "merchant_name": dominant_merchant,
                "merchant_category": dominant_merchant_category,
                "bank_transaction_code": dominant_bank_code,
                "has_mcc": bool(dominant_mcc),
                "metadata": metadata,
                "source": source_label,
            }
        )

    noise_df = df_with_clusters[df_with_clusters["cluster_id"] == -1]
    if noise_df.empty:
        noise_profile = {"mu_daily_spend_noise": 0.0, "sigma_daily_spend_noise": 0.0}
    else:
        daily_totals = noise_df.groupby(noise_df["bookingDate"].dt.date)["amount"].sum()
        mu_noise = float(daily_totals.mean()) if not daily_totals.empty else 0.0
        sigma_noise = float(daily_totals.std(ddof=0)) if len(daily_totals) > 1 else _MIN_SIGMA_AMOUNT
        noise_profile = {
            "mu_daily_spend_noise": mu_noise,
            "sigma_daily_spend_noise": max(abs(sigma_noise), _MIN_SIGMA_AMOUNT),
        }

    return event_profiles, noise_profile


def _initial_event_schedule(event_profiles: Sequence[Dict[str, object]], start_date: date) -> List[date]:
    """Calculate the next occurrence date for each event at simulation start."""
    schedule: List[date] = []
    for event in event_profiles:
        frequency = max(int(round(event["frequency_days"])), 1)
        last_date: date = event["last_date"]
        next_date = last_date
        while next_date <= start_date:
            next_date = next_date + timedelta(days=frequency)
        schedule.append(next_date)
    return schedule


def _draw_event_amount(rng: np.random.Generator, mu: float, sigma: float) -> float:
    sigma_safe = sigma if sigma > 0 else max(abs(mu) * 0.1, _MIN_SIGMA_AMOUNT)
    return float(rng.normal(mu, sigma_safe))


def _run_monte_carlo_simulation(
    current_balance: float,
    event_profiles: Sequence[Dict[str, object]],
    noise_profile: Dict[str, float],
    horizon_days: int,
    n_simulations: int = _DEFAULT_SIMULATIONS,
    random_seed: Optional[int] = 42,
) -> np.ndarray:
    """Simulate future balance trajectories using Monte Carlo sampling."""
    horizon_days = max(int(horizon_days), 1)
    if n_simulations <= 0:
        raise ValueError("n_simulations must be positive")

    rng = np.random.default_rng(random_seed)
    trajectories = np.zeros((n_simulations, horizon_days), dtype=float)
    start_date = date.today()

    for sim_idx in range(n_simulations):
        balance = current_balance
        next_occurrences = _initial_event_schedule(event_profiles, start_date)
        for day_offset in range(horizon_days):
            current_date = start_date + timedelta(days=day_offset + 1)
            daily_delta = 0.0

            for idx, event in enumerate(event_profiles):
                if current_date < next_occurrences[idx]:
                    continue

                mu_amount = float(event["mu_amount"])
                sigma_amount = float(event["sigma_amount"])
                expected_day = float(event["mu_day"])
                sigma_day = float(event["sigma_day"])

                day_gap = abs(current_date.day - expected_day)
                trigger_probability = math.exp(-0.5 * (day_gap / sigma_day) ** 2)
                trigger_probability = min(max(trigger_probability, 0.1), 0.99)

                if rng.random() <= trigger_probability:
                    daily_delta += _draw_event_amount(rng, mu_amount, sigma_amount)
                    frequency = max(int(round(event["frequency_days"])), 1)
                    next_occurrences[idx] = current_date + timedelta(days=frequency)
                else:
                    # event skipped; revisit the next day without advancing schedule
                    pass

            mu_noise = float(noise_profile.get("mu_daily_spend_noise", 0.0))
            sigma_noise = float(noise_profile.get("sigma_daily_spend_noise", 0.0))
            if abs(mu_noise) > 1e-6 or sigma_noise > 1e-6:
                daily_delta += _draw_event_amount(rng, mu_noise, max(sigma_noise, _MIN_SIGMA_AMOUNT))

            balance += daily_delta
            trajectories[sim_idx, day_offset] = balance

    return trajectories


def _color_zone(probability_percent: float) -> Tuple[str, str]:
    """Map probability to color code and human recommendation."""
    if probability_percent >= 95:
        return "green", "–ü–ª–∞—Ç–µ–∂ –ø–æ—á—Ç–∏ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω. –ú–æ–∂–Ω–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ü–µ–ª–∏."
    if probability_percent >= 70:
        return "yellow", "–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å —Å—Ä–µ–¥–Ω—è—è: –æ–ø—Ç–∏–º–∏–∑–∏—Ä—É–π—Ç–µ —Ä–∞—Å—Ö–æ–¥—ã –∏ –¥–µ—Ä–∂–∏—Ç–µ —Ä–µ–∑–µ—Ä–≤."
    return "red", "–í—ã—Å–æ–∫–∏–π —Ä–∏—Å–∫ –¥–µ—Ñ–∏—Ü–∏—Ç–∞. –†–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∏–ª–∏ –ø–µ—Ä–µ–Ω–æ—Å –ø–ª–∞—Ç–µ–∂–∞."


def _execute_engine(
    transactions: Sequence[Transaction],
    current_balance: float,
    payment_date: date,
    payment_amount: float,
) -> Tuple[AnalysisResult, Dict[str, object]]:
    df = _prepare_transactions_df(transactions)
    if df.empty:
        result = AnalysisResult(
            payment_date=payment_date,
            payment_amount=payment_amount,
            success_probability_percent=0,
            recommendation="–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏.",
            color_zone="red",
        )
        details = {
            "trajectories": np.zeros((_DEFAULT_SIMULATIONS, 1)),
            "forecast_dates": [date.today()],
            "event_profiles": [],
            "noise_profile": {"mu_daily_spend_noise": 0.0, "sigma_daily_spend_noise": _MIN_SIGMA_AMOUNT},
            "payment_index": 0,
        }
        return result, details

    df_with_clusters = _discover_events(df)
    event_profiles, noise_profile = _profile_events(df_with_clusters)

    today = date.today()
    days_until_payment = max((payment_date - today).days, 0)
    horizon_days = max(days_until_payment + 1, 30)

    trajectories = _run_monte_carlo_simulation(
        current_balance=current_balance,
        event_profiles=event_profiles,
        noise_profile=noise_profile,
        horizon_days=horizon_days,
    )

    forecast_dates = [today + timedelta(days=offset + 1) for offset in range(horizon_days)]
    payment_index = min(days_until_payment, horizon_days - 1)

    payment_balances = trajectories[:, payment_index]
    probability = float(np.mean(payment_balances >= payment_amount) * 100.0)
    probability_percent = int(round(probability))

    color_zone, recommendation = _color_zone(probability)

    analysis = AnalysisResult(
        payment_date=payment_date,
        payment_amount=payment_amount,
        success_probability_percent=probability_percent,
        recommendation=recommendation,
        color_zone=color_zone,
    )

    details = {
        "trajectories": trajectories,
        "forecast_dates": forecast_dates,
        "event_profiles": event_profiles,
        "noise_profile": noise_profile,
        "payment_index": payment_index,
    }

    return analysis, details


def run_analysis(
    transactions: Sequence[Transaction],
    current_balance: float,
    payment_date: date,
    payment_amount: float,
) -> AnalysisResult:
    """Public API returning only AnalysisResult for backward compatibility."""
    analysis, _details = _execute_engine(transactions, current_balance, payment_date, payment_amount)
    return analysis


def run_analysis_with_details(
    transactions: Sequence[Transaction],
    current_balance: float,
    payment_date: date,
    payment_amount: float,
) -> Tuple[AnalysisResult, np.ndarray, List[date], Dict[str, object], List[Dict[str, object]]]:
    """Extended API returning forecast trajectories and diagnostic profiles."""
    analysis, details = _execute_engine(transactions, current_balance, payment_date, payment_amount)
    return (
        analysis,
        details["trajectories"],
        details["forecast_dates"],
        details["noise_profile"],
        details["event_profiles"],
    )


def calculate_safe_to_spend(
    obligations: Sequence[Dict[str, object]],
    forecast_trajectories: np.ndarray,
    forecast_dates: Sequence[date],
    confidence_level: float = 0.8,
) -> float:
    """Estimate safe-to-spend amount at a chosen confidence level."""
    if forecast_trajectories.size == 0 or not forecast_dates:
        return 0.0

    confidence_level = float(np.clip(confidence_level, 0.01, 0.99))
    percentile = (1.0 - confidence_level) * 100.0
    lower_envelope = np.percentile(forecast_trajectories, percentile, axis=0)

    horizon_end = forecast_dates[-1]
    obligations_total = 0.0
    for obligation in obligations or []:
        amount = float(obligation.get("amount", 0.0) or 0.0)
        due_raw = obligation.get("due_date")
        due_date: Optional[date] = None
        if isinstance(due_raw, date):
            due_date = due_raw
        elif isinstance(due_raw, pd.Timestamp):
            due_date = due_raw.date()
        elif hasattr(due_raw, "to_pydatetime"):
            due_date = due_raw.to_pydatetime().date()
        elif isinstance(due_raw, str):
            try:
                due_date = datetime.fromisoformat(due_raw).date()
            except ValueError:
                due_date = None
        if due_date is None or due_date > horizon_end:
            continue
        obligations_total += amount

    safe_buffer = float(np.min(lower_envelope)) - obligations_total
    return max(0.0, round(safe_buffer, 2))


def rank_credits(credits: Sequence[Dict[str, object]]) -> List[Dict[str, object]]:
    """Produce a stress-based ranking for outstanding credits."""
    ranked: List[Dict[str, object]] = []
    for credit in credits or []:
        balance = float(credit.get("balance") or credit.get("principal") or 0.0)
        rate = float(credit.get("rate") or credit.get("interest_rate") or 0.0)
        min_payment = float(credit.get("min_payment") or credit.get("payment") or 0.0)
        days_past_due = float(credit.get("days_past_due") or 0.0)

        utilization = min(balance / max(credit.get("limit", balance or 1.0), 1.0), 1.0)
        stress_score = rate * 100 + min_payment / max(balance, 1.0) * 50 + days_past_due * 2 + utilization * 25

        ranked.append(
            {
                "name": credit.get("name") or credit.get("product") or "–ö—Ä–µ–¥–∏—Ç",
                "balance": round(balance, 2),
                "rate": round(rate, 4),
                "min_payment": round(min_payment, 2),
                "days_past_due": int(days_past_due),
                "stress_score": round(stress_score, 2),
            }
        )

    ranked.sort(key=lambda item: item["stress_score"], reverse=True)
    return ranked


def build_financial_portrait(
    transactions: Sequence[Transaction],
    credits: Sequence[Dict[str, Any]],
    accounts: Sequence[Dict[str, Any]],
    user_goal: UserGoal,
) -> Dict[str, Any]:
    """Compose a holistic financial portrait combining probabilistic and deterministic insights."""
    df = _prepare_transactions_df(transactions)
    if df.empty:
        return {
            "safe_to_spend_daily": 0.0,
            "credit_rankings": [],
            "discovered_events": [],
            "recurring_events": [],
            "upcoming_payments": [],
            "financial_health": {"total_debt": 0.0, "total_monthly_payments": 0.0},
            "noise_profile": {"mu_daily_spend_noise": 0.0, "sigma_daily_spend_noise": 0.0},
            "next_income_event": None,
            "error": "–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.",
        }

    df_with_clusters = _discover_events(df)
    event_profiles, noise_profile = _profile_events(df_with_clusters)

    obligations = derive_obligations(credits, event_profiles)
    current_balance = sum(_extract_account_balance(acc) for acc in accounts or [])
    daily_s2s = calculate_daily_s2s(current_balance, event_profiles, obligations, user_goal)

    ranked_credits = rank_credits(credits)
    next_income_event = _find_next_income_event(event_profiles, date.today())

    upcoming_payments = [
        obligation
        for obligation in obligations
        if isinstance(obligation.get("due_date"), date) and obligation["due_date"] >= date.today()
    ]
    upcoming_payments.sort(key=lambda item: item["due_date"])

    total_debt = sum(float(c.get("balance") or c.get("principal") or 0.0) for c in credits or [])
    total_monthly_payments = sum(float(obligation.get("amount") or 0.0) for obligation in obligations)

    upcoming_payments_payload = [
        {
            "name": obligation.get("label") or "–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂",
            "amount": obligation.get("amount"),
            "due_date": obligation.get("due_date").isoformat()
            if isinstance(obligation.get("due_date"), date)
            else obligation.get("due_date"),
            "source": obligation.get("source"),
            "mcc_code": obligation.get("mcc_code"),
            "category": obligation.get("category"),
            "merchant_name": obligation.get("merchant_name"),
            "bank_transaction_code": obligation.get("bank_transaction_code"),
            "frequency_days": obligation.get("frequency_days"),
        }
        for obligation in upcoming_payments
    ]

    goal_details = user_goal.goal_details or {}
    close_loan_ids = [str(item) for item in goal_details.get("close_loan_ids") or []]
    targeted_balance = 0.0
    if close_loan_ids:
        lookup = {_credit_identifier(credit): credit for credit in credits or []}
        for loan_id in close_loan_ids:
            credit = lookup.get(str(loan_id))
            if not credit:
                continue
            targeted_balance += float(
                credit.get("outstanding_balance")
                or credit.get("balance")
                or credit.get("principal")
                or 0.0
            )
    targeted_balance = round(targeted_balance, 2) if targeted_balance else 0.0

    timeline_months = goal_details.get("timeline_months")
    expected_close_date = goal_details.get("expected_close_date")
    if not expected_close_date and timeline_months:
        try:
            months_int = int(timeline_months)
            expected_close_date = (date.today() + timedelta(days=months_int * 30)).isoformat()
        except (TypeError, ValueError):
            expected_close_date = None

    targeted_monthly_payment = goal_details.get("targeted_monthly_payment")
    if not targeted_monthly_payment and timeline_months and targeted_balance:
        try:
            targeted_monthly_payment = round(targeted_balance / max(float(timeline_months), 1.0), 2)
        except (TypeError, ValueError):
            targeted_monthly_payment = None

    if user_goal.goal_type == "pay_debts":
        target_amount = goal_details.get("targeted_loan_amount") or targeted_balance or total_debt
    else:
        target_amount = goal_details.get("save_amount") or goal_details.get("target_amount")
    if target_amount is not None:
        try:
            target_amount = round(float(target_amount), 2)
        except (TypeError, ValueError):
            target_amount = None

    goal_summary = {
        "type": user_goal.goal_type,
        "pace": user_goal.pace,
        "speed": goal_details.get("close_speed") or goal_details.get("save_speed") or user_goal.pace,
        "target_amount": target_amount,
        "close_loan_ids": close_loan_ids,
        "targeted_balance": targeted_balance or None,
        "timeline_months": timeline_months,
        "expected_close_date": expected_close_date,
        "recommended_monthly_payment": targeted_monthly_payment,
    }

    return {
        "safe_to_spend_daily": daily_s2s,
        "current_balance": round(current_balance, 2),
        "credit_rankings": ranked_credits,
        "discovered_events": event_profiles,
        "upcoming_payments": upcoming_payments_payload,
        "timeline": upcoming_payments_payload,
        "financial_health": {
            "total_debt": round(total_debt, 2),
            "total_monthly_payments": round(total_monthly_payments, 2),
        },
        "recurring_events": extract_recurring_events(event_profiles),
        "noise_profile": noise_profile,
        "next_income_event": next_income_event,
        "goal_summary": goal_summary,
    }
</file>

<file path="hktn/core/data_models.py">
"""Data models for the hackathon project core."""
from __future__ import annotations

from datetime import date
from typing import Any, Dict, List, Optional

from pydantic import BaseModel, Field


class Transaction(BaseModel):
    """Represents a single bank transaction with optional merchant context."""

    transactionId: str
    amount: float
    currency: str
    description: Optional[str] = None
    bookingDate: date
    creditDebitIndicator: Optional[str] = None
    bankTransactionCode: Optional[str] = None
    merchant: Dict[str, Optional[str]] = Field(default_factory=dict)
    mccCode: Optional[str] = None
    category: Optional[str] = None
    transactionInformation: Optional[str] = None
    transactionLocation: Dict[str, Any] = Field(default_factory=dict)
    card: Dict[str, Optional[str]] = Field(default_factory=dict)


class Account(BaseModel):
    """Represents a user's account."""

    accountId: str
    nickname: Optional[str] = None
    # Extend with additional fields once API contract is finalized.


class BankConsent(BaseModel):
    """Stores consent metadata for a bank."""

    bank_id: str
    consent_id: str


class AnalysisResult(BaseModel):
    """Outcome structure returned by analytics engine."""

    payment_date: date
    payment_amount: float
    success_probability_percent: int
    recommendation: str
    color_zone: str = Field(description="green, yellow, or red")
</file>

<file path="hktn/core/database.py">
import json
import logging
import sqlite3
from dataclasses import dataclass
from typing import Any, Dict, List, Optional

DB_FILE = "finpulse_consents.db"
logger = logging.getLogger(__name__)


@dataclass(frozen=True)
class StoredConsent:
    """Lightweight view of a consent record used by service layers."""

    bank_id: str
    consent_id: str
    consent_type: str = "accounts"


def get_db_connection() -> sqlite3.Connection:
    """Open a connection to the consent state database."""
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    return conn


def _ensure_column(conn: sqlite3.Connection, table: str, column: str, definition: str) -> None:
    """Ensure the given column exists on the table, adding it if necessary."""
    cursor = conn.execute(f"PRAGMA table_info({table})")
    columns = {row[1] for row in cursor.fetchall()}
    if column not in columns:
        logger.info("Adding column %s to table %s", column, table)
        conn.execute(f"ALTER TABLE {table} ADD COLUMN {column} {definition};")


def init_db() -> None:
    """Create all required tables for the application if they are absent."""
    try:
        with get_db_connection() as conn:
            conn.execute(
                """
                CREATE TABLE IF NOT EXISTS consents (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id TEXT NOT NULL,
                    bank_id TEXT NOT NULL,
                    consent_id TEXT NOT NULL UNIQUE,
                    status TEXT NOT NULL,
                    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
                """
            )
            _ensure_column(conn, "consents", "request_id", "TEXT")
            _ensure_column(conn, "consents", "approval_url", "TEXT")
            _ensure_column(conn, "consents", "consent_type", "TEXT")
            # Backfill consent type for legacy rows.
            conn.execute(
                """
                UPDATE consents
                SET bank_id = substr(bank_id, 1, length(bank_id) - 9),
                    consent_type = COALESCE(consent_type, 'products')
                WHERE bank_id LIKE '%\_products' ESCAPE '\\'
                """
            )
            conn.execute(
                """
                UPDATE consents
                SET consent_type = COALESCE(consent_type, 'accounts')
                WHERE consent_type IS NULL
                """
            )
            conn.execute(
                """
                CREATE TABLE IF NOT EXISTS user_profiles (
                    user_id TEXT PRIMARY KEY,
                    goal_type TEXT,
                    goal_details TEXT
                );
                """
            )

            conn.execute(
                """
                CREATE TABLE IF NOT EXISTS user_product_consents (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id TEXT NOT NULL,
                    bank_id TEXT NOT NULL,
                    product_id TEXT NOT NULL,
                    product_type TEXT,
                    consented BOOLEAN NOT NULL,
                    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                    UNIQUE(user_id, bank_id, product_id)
                );
                """
            )

            conn.execute(
                """
                CREATE TABLE IF NOT EXISTS bank_status_log (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id TEXT NOT NULL,
                    bank_id TEXT NOT NULL,
                    operation TEXT NOT NULL,
                    status TEXT NOT NULL,
                    message TEXT,
                    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
                """
            )

            conn.execute(
                """
                CREATE TABLE IF NOT EXISTS onboarding_sessions (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    user_id TEXT NOT NULL,
                    banks_connected TEXT,
                    products_consented TEXT,
                    goal_profile TEXT,
                    completed_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
                );
                """
            )
            conn.commit()
        logger.info("All database tables ensured.")
    except sqlite3.Error as exc:
        logger.error("Database initialization failed: %s", exc)
        raise


def save_consent(
    user_id: str,
    bank_id: str,
    consent_id: str,
    status: str,
    request_id: Optional[str] = None,
    approval_url: Optional[str] = None,
    consent_type: str = "accounts",
) -> None:
    """Persist or update a consent record."""
    with get_db_connection() as conn:
        conn.execute(
            """
            INSERT INTO consents (user_id, bank_id, consent_id, status, request_id, approval_url, consent_type)
            VALUES (?, ?, ?, ?, ?, ?, ?)
            ON CONFLICT(consent_id) DO UPDATE SET
                status=excluded.status,
                user_id=excluded.user_id,
                bank_id=excluded.bank_id,
                request_id=COALESCE(excluded.request_id, consents.request_id),
                approval_url=COALESCE(excluded.approval_url, consents.approval_url),
                consent_type=COALESCE(excluded.consent_type, consents.consent_type)
            """,
            (user_id, bank_id, consent_id, status, request_id, approval_url, consent_type),
        )
        conn.commit()


def update_consent_status(consent_id: str, status: str) -> bool:
    """Set consent status; returns True if a row was updated."""
    with get_db_connection() as conn:
        cursor = conn.execute(
            "UPDATE consents SET status = ? WHERE consent_id = ?",
            (status, consent_id),
        )
        conn.commit()
        return cursor.rowcount > 0


def update_consent_from_request(request_id: str, consent_id: str, status: str) -> bool:
    """Update a pending consent row once the real consent_id becomes available."""
    with get_db_connection() as conn:
        cursor = conn.execute(
            """
            UPDATE consents
            SET consent_id = ?, status = ?
            WHERE request_id = ?
            """,
            (consent_id, status, request_id),
        )
        conn.commit()
        return cursor.rowcount > 0


def get_consent_by_request_id(request_id: str) -> Optional[Dict[str, Any]]:
    """Return consent row by request_id if it exists."""
    with get_db_connection() as conn:
        cursor = conn.execute(
            "SELECT * FROM consents WHERE request_id = ?",
            (request_id,),
        )
        row = cursor.fetchone()
    return dict(row) if row else None


def find_approved_consents(user_id: str, consent_type: Optional[str] = None) -> List[StoredConsent]:
    """Return structured consents filtered by approval status (and optionally type)."""
    with get_db_connection() as conn:
        sql = "SELECT bank_id, consent_id, consent_type FROM consents WHERE user_id = ? AND status = 'APPROVED'"
        params: List[Any] = [user_id]
        if consent_type:
            sql += " AND consent_type = ?"
            params.append(consent_type)
        cursor = conn.execute(sql, params)
        rows = cursor.fetchall()
    return [
        StoredConsent(
            bank_id=row["bank_id"],
            consent_id=row["consent_id"],
            consent_type=row["consent_type"] or "accounts",
        )
        for row in rows
    ]


def upsert_product_consents(user_id: str, items: List[Dict[str, Any]]) -> None:
    """Upsert multiple product consent records for a user."""
    if not items:
        return
    with get_db_connection() as conn:
        cursor = conn.cursor()
        for item in items:
            cursor.execute(
                """
                INSERT INTO user_product_consents (user_id, bank_id, product_id, product_type, consented, updated_at)
                VALUES (?, ?, ?, ?, ?, CURRENT_TIMESTAMP)
                ON CONFLICT(user_id, bank_id, product_id) DO UPDATE SET
                    consented = excluded.consented,
                    product_type = excluded.product_type,
                    updated_at = CURRENT_TIMESTAMP;
                """,
                (
                    user_id,
                    item["bank_id"],
                    item["product_id"],
                    item.get("product_type"),
                    bool(item["consented"]),
                ),
            )
        conn.commit()
    logger.info("Upserted %d product consents for user %s", len(items), user_id)


def get_product_consents_for_user(user_id: str) -> List[Dict[str, Any]]:
    """Fetch all product consents for a given user."""
    with get_db_connection() as conn:
        cursor = conn.execute("SELECT * FROM user_product_consents WHERE user_id = ?", (user_id,))
        rows = cursor.fetchall()
    return [dict(row) for row in rows]


def get_user_consents(user_id: str) -> List[Dict[str, Any]]:
    """Return all stored consents (any status) for the user."""
    with get_db_connection() as conn:
        cursor = conn.execute(
            "SELECT bank_id, consent_id, status, request_id, approval_url, created_at, consent_type FROM consents WHERE user_id = ?",
            (user_id,),
        )
        rows = cursor.fetchall()
    return [dict(row) for row in rows]


def add_bank_status_log(user_id: str, bank_id: str, operation: str, status: str, message: str) -> None:
    """Log the status of a bank operation."""
    with get_db_connection() as conn:
        conn.execute(
            """
            INSERT INTO bank_status_log (user_id, bank_id, operation, status, message)
            VALUES (?, ?, ?, ?, ?);
            """,
            (user_id, bank_id, operation, status, message),
        )
        conn.commit()


def get_recent_bank_status_logs(user_id: str, limit: int = 10) -> List[Dict[str, Any]]:
    """Fetch recent bank operation logs for a user."""
    with get_db_connection() as conn:
        cursor = conn.execute(
            "SELECT * FROM bank_status_log WHERE user_id = ? ORDER BY timestamp DESC LIMIT ?",
            (user_id, limit),
        )
        rows = cursor.fetchall()
    return [dict(row) for row in rows]


def commit_onboarding_session(user_id: str, banks: List[str], products: List[Dict[str, Any]], goal: Dict[str, Any]) -> None:
    """Save a summary of the completed onboarding session."""
    with get_db_connection() as conn:
        conn.execute(
            """
            INSERT INTO onboarding_sessions (user_id, banks_connected, products_consented, goal_profile)
            VALUES (?, ?, ?, ?);
            """,
            (user_id, json.dumps(banks), json.dumps(products), json.dumps(goal)),
        )
        conn.commit()
    logger.info("Committed onboarding session for user %s", user_id)


def get_latest_onboarding_session(user_id: str) -> Optional[Dict[str, Any]]:
    """Return the most recent onboarding session snapshot if it exists."""
    with get_db_connection() as conn:
        cursor = conn.execute(
            """
            SELECT user_id, banks_connected, products_consented, goal_profile, completed_at
            FROM onboarding_sessions
            WHERE user_id = ?
            ORDER BY completed_at DESC
            LIMIT 1;
            """,
            (user_id,),
        )
        row = cursor.fetchone()

    if not row:
        return None

    def _safe_parse(value: Optional[str], default: Any) -> Any:
        if not value:
            return default
        try:
            return json.loads(value)
        except json.JSONDecodeError:
            return default

    return {
        "user_id": row["user_id"],
        "banks_connected": _safe_parse(row["banks_connected"], []),
        "products_consented": _safe_parse(row["products_consented"], []),
        "goal_profile": _safe_parse(row["goal_profile"], {}),
        "completed_at": row["completed_at"],
    }


def get_user_goal(user_id: str) -> Optional[Dict[str, Any]]:
    """Fetch the last saved user goal."""
    with get_db_connection() as conn:
        cursor = conn.execute(
            "SELECT goal_type, goal_details FROM user_profiles WHERE user_id = ?",
            (user_id,),
        )
        row = cursor.fetchone()
    if not row:
        return None
    goal_details = json.loads(row["goal_details"]) if row["goal_details"] else {}
    return {"goal_type": row["goal_type"], "goal_details": goal_details}


def save_user_profile(user_id: str, goal_type: str, goal_details: Dict[str, Any]) -> None:
    """Upsert the user's selected goal details."""
    with get_db_connection() as conn:
        conn.execute(
            """
            INSERT INTO user_profiles (user_id, goal_type, goal_details)
            VALUES (?, ?, ?)
            ON CONFLICT(user_id) DO UPDATE SET
                goal_type = excluded.goal_type,
                goal_details = excluded.goal_details
            """,
            (user_id, goal_type, json.dumps(goal_details)),
        )
        conn.commit()
    logger.info("Saved profile for user %s (goal=%s)", user_id, goal_type)
</file>

<file path="hktn/src/api/client.js">
const API_BASE = import.meta.env.VITE_API_BASE ?? '';
async function fetchJson(path, options = {}) {
    const url = `${API_BASE}${path}`;
    const headers = new Headers(options.headers);
    if (options.body && !headers.get('Content-Type')) {
        headers.set('Content-Type', 'application/json');
    }
    const response = await fetch(url, { ...options, headers });
    if (!response.ok) {
        let message = `Request failed with status ${response.status}`;
        try {
            const payload = await response.json();
            if (payload?.detail) {
                message = Array.isArray(payload.detail) ? payload.detail[0]?.msg ?? message : payload.detail;
            }
        }
        catch {
            // ignore JSON parse errors
        }
        const error = new Error(message);
        error.status = response.status;
        throw error;
    }
    if (response.status === 204) {
        return {};
    }
    return (await response.json());
}
export const getBanks = (userId) => {
    const query = userId ? `?user_id=${encodeURIComponent(userId)}` : '';
    return fetchJson(`/api/banks${query}`);
};
export const startConsent = (payload) => fetchJson('/api/consents/start', { method: 'POST', body: JSON.stringify(payload) });
export const startProductConsent = (payload) => fetchJson('/api/consent/initiate/product', { method: 'POST', body: JSON.stringify(payload) });
export const pollConsent = (params) => {
    const query = new URLSearchParams({
        user_id: params.user_id,
        bank_id: params.bank_id,
        request_id: params.request_id,
    }).toString();
    return fetchJson(`/api/consents/status?${query}`);
};
export const getBankBootstrap = (bankId, userId) => fetchJson(`/api/banks/${bankId}/bootstrap?user_id=${encodeURIComponent(userId)}`);
export const getPreview = (payload) => fetchJson('/api/ingest/preview', { method: 'POST', body: JSON.stringify(payload) });
export const saveProductConsents = (payload) => fetchJson('/api/products/consent', { method: 'POST', body: JSON.stringify(payload) });
export const saveGoal = (payload) => fetchJson('/api/profile/goal', { method: 'POST', body: JSON.stringify(payload) });
export const runIngestion = (payload) => fetchJson('/api/ingest/run', { method: 'POST', body: JSON.stringify(payload) });
export const commitOnboarding = (payload) => fetchJson('/api/onboarding/commit', { method: 'POST', body: JSON.stringify(payload) });
export const getDashboard = (userId) => fetchJson(`/api/dashboard?user_id=${encodeURIComponent(userId)}`);
export const getCredits = (userId) => fetchJson(`/api/credits?user_id=${encodeURIComponent(userId)}`);
export const getFinancialPortrait = (payload) => fetchJson('/api/financial-portrait', { method: 'POST', body: JSON.stringify(payload) });
export { fetchJson };
</file>

<file path="hktn/src/pages/BanksCatalogPage.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';
export const BanksCatalogPage = () => {
    const { userId, banks, refreshBanks, isFetchingBanks } = useUser();
    const { notifyError } = useNotifications();
    const navigate = useNavigate();
    const [selectedBankIds, setSelectedBankIds] = useState(new Set());
    useEffect(() => {
        if (userId) {
            refreshBanks();
        }
    }, [userId, refreshBanks]);
    const handleToggleBank = (bankId) => {
        setSelectedBankIds((prev) => {
            const next = new Set(prev);
            if (next.has(bankId)) {
                next.delete(bankId);
            }
            else {
                next.add(bankId);
            }
            return next;
        });
    };
    const handleSubmit = () => {
        if (selectedBankIds.size === 0) {
            notifyError('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–∞–Ω–∫');
            return;
        }
        const selectedBanks = banks.filter((bank) => selectedBankIds.has(bank.id));
        navigate('/onboarding/consent', { state: { selectedBanks } });
    };
    return (_jsxs("div", { className: "app-main", children: [_jsxs("div", { className: "card", children: [_jsx("h2", { children: "\u0428\u0430\u0433 2. \u0412\u044B\u0431\u0435\u0440\u0438\u0442\u0435 \u0431\u0430\u043D\u043A\u0438" }), _jsx("p", { children: "\u041E\u0442\u043C\u0435\u0442\u044C\u0442\u0435 \u0431\u0430\u043D\u043A\u0438, \u043A\u043E\u0442\u043E\u0440\u044B\u0435 \u0445\u043E\u0442\u0438\u0442\u0435 \u043F\u043E\u0434\u043A\u043B\u044E\u0447\u0438\u0442\u044C \u0434\u043B\u044F \u0430\u043D\u0430\u043B\u0438\u0437\u0430." })] }), isFetchingBanks && (_jsx("div", { className: "card", children: _jsx("p", { children: "\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0441\u043F\u0438\u0441\u043A\u0430 \u0431\u0430\u043D\u043A\u043E\u0432..." }) })), !isFetchingBanks && banks.length === 0 && (_jsx("div", { className: "card", children: _jsx("p", { children: "\u041A\u0430\u0442\u0430\u043B\u043E\u0433 \u0431\u0430\u043D\u043A\u043E\u0432 \u043F\u0443\u0441\u0442. \u041F\u0440\u043E\u0432\u0435\u0440\u044C\u0442\u0435 \u043D\u0430\u0441\u0442\u0440\u043E\u0439\u043A\u0438 \u0431\u044D\u043A\u0435\u043D\u0434\u0430." }) })), banks.length > 0 && (_jsx("div", { className: "card", children: banks.map((bank, index) => (_jsx("div", { style: { padding: '12px 0', borderBottom: index === banks.length - 1 ? 'none' : '1px solid #eee' }, children: _jsxs("label", { style: { display: 'flex', alignItems: 'center', gap: 12, cursor: 'pointer' }, children: [_jsx("input", { type: "checkbox", checked: selectedBankIds.has(bank.id), onChange: () => handleToggleBank(bank.id), disabled: bank.connected }), _jsxs("div", { children: [_jsx("strong", { children: bank.name }), _jsx("p", { style: { margin: 0, fontSize: 14, color: bank.connected ? '#16a34a' : '#475569' }, children: bank.connected ? '–£–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω' : '–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é' })] })] }) }, bank.id))) })), _jsx("button", { className: "btn", onClick: handleSubmit, disabled: selectedBankIds.size === 0 || isFetchingBanks, children: "\u041F\u0440\u043E\u0434\u043E\u043B\u0436\u0438\u0442\u044C" })] }));
};
</file>

<file path="hktn/src/pages/DashboardPage.js">
export { DashboardPage as default, DashboardPage } from './DashboardPage.jsx';
</file>

<file path="hktn/src/pages/UserIdPage.tsx">
import React, { useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { UserIdForm } from '../components/UserIdForm';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';

export const UserIdPage: React.FC = () => {
  const { userId, userName, setInitialUserData } = useUser();
  const { notifySuccess, notifyError } = useNotifications();
  const navigate = useNavigate();
  const [isSubmitting, setIsSubmitting] = useState(false);

  const handleSubmit = async (nextId: string, nextName: string) => {
    try {
      setIsSubmitting(true);
      setInitialUserData(nextId.toLowerCase(), nextName);
      notifySuccess('ID –∏ –∏–º—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã');
      navigate('/banks');
    } catch (error) {
      console.error(error);
      notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ');
    } finally {
      setIsSubmitting(false);
    }
  };

  return (
    <div className="app-main">
      <UserIdForm
        defaultUserId={userId}
        defaultUserName={userName}
        onSubmit={handleSubmit}
        isSubmitting={isSubmitting}
      />
    </div>
  );
};
</file>

<file path="hktn/src/state/useUser.tsx">
import React, { createContext, useCallback, useContext, useEffect, useMemo, useState } from 'react';
import { getBanks } from '../api/client';

export type ConsentState = {
  bankId: string;
  requestId?: string;
  consentId?: string;
  status?: string;
  approvalUrl?: string;
  lastUpdated: number;
};

export type BankSummary = {
  id: string;
  name: string;
  connected: boolean;
  baseUrl?: string | null;
  status?: string;
  error?: string;
};

type UserContextValue = {
  userId: string | null;
  userName: string | null;
  setInitialUserData: (nextId: string, nextName: string) => void;
  clearUser: () => void;
  consents: ConsentState[];
  upsertConsent: (consent: Omit<ConsentState, 'lastUpdated'>) => void;
  banks: BankSummary[];
  refreshBanks: () => Promise<void>;
  isFetchingBanks: boolean;
};

const STORAGE_KEY = 'finpulse:userId';
const USER_NAME_KEY = 'finpulse:userName';
const CONSENTS_KEY = 'finpulse:consents';

const UserContext = createContext<UserContextValue | undefined>(undefined);

const parseStoredConsents = (): ConsentState[] => {
  try {
    const serialized = localStorage.getItem(CONSENTS_KEY);
    if (!serialized) {
      return [];
    }
    const raw = JSON.parse(serialized);
    if (Array.isArray(raw)) {
      return raw.filter(
        (item) => item && typeof item.bankId === 'string'
      ) as ConsentState[];
    }
    return [];
  } catch {
    return [];
  }
};

export const UserProvider: React.FC<React.PropsWithChildren> = ({ children }) => {
  const [userId, setUserIdState] = useState<string | null>(() => localStorage.getItem(STORAGE_KEY));
  const [userName, setUserNameState] = useState<string | null>(() => localStorage.getItem(USER_NAME_KEY));
  const [consents, setConsents] = useState<ConsentState[]>(parseStoredConsents);
  const [banks, setBanks] = useState<BankSummary[]>([]);
  const [isFetchingBanks, setIsFetchingBanks] = useState(false);

  const setInitialUserData = useCallback((nextId: string, nextName: string) => {
    localStorage.setItem(STORAGE_KEY, nextId);
    setUserIdState(nextId);
    localStorage.setItem(USER_NAME_KEY, nextName);
    setUserNameState(nextName);
  }, []);

  const clearUser = useCallback(() => {
    localStorage.removeItem(STORAGE_KEY);
    localStorage.removeItem(USER_NAME_KEY);
    localStorage.removeItem(CONSENTS_KEY);
    setUserIdState(null);
    setUserNameState(null);
    setConsents([]);
    setBanks([]);
  }, []);

  const upsertConsent = useCallback(
    (update: Omit<ConsentState, 'lastUpdated'>) => {
      setConsents((prev) => {
        const next = [...prev];
        const index = next.findIndex((item) => item.bankId === update.bankId);
        const payload = {
          ...(index >= 0 ? next[index] : {}),
          ...update,
          lastUpdated: Date.now(),
        };
        if (index >= 0) {
          next[index] = payload as ConsentState;
        } else {
          next.push(payload as ConsentState);
        }
        localStorage.setItem(CONSENTS_KEY, JSON.stringify(next));
        return next;
      });
    },
    []
  );

  const refreshBanks = useCallback(async () => {
    if (!userId) {
      setBanks([]);
      return;
    }
    try {
      setIsFetchingBanks(true);
      const response = await getBanks(userId);
      setBanks(response.banks ?? []);
    } catch (error) {
      console.error('Failed to fetch banks', error);
    } finally {
      setIsFetchingBanks(false);
    }
  }, [userId]);

  useEffect(() => {
    if (userId) {
      refreshBanks();
    }
  }, [userId, refreshBanks]);

  const value = useMemo<UserContextValue>(
    () => ({
      userId,
      userName,
      setInitialUserData,
      clearUser,
      consents,
      upsertConsent,
      banks,
      refreshBanks,
      isFetchingBanks,
    }),
    [banks, clearUser, consents, isFetchingBanks, refreshBanks, upsertConsent, setInitialUserData, userId, userName]
  );

  return <UserContext.Provider value={value}>{children}</UserContext.Provider>;
};

export const useUser = (): UserContextValue => {
  const ctx = useContext(UserContext);
  if (!ctx) {
    throw new Error('useUser must be used inside UserProvider');
  }
  return ctx;
};
</file>

<file path="hktn/src/styles/global.css">
:root {
  font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
  color: #0f172a;
  background-color: #f5f7fb;
  --color-surface: #fff;
  --color-border: rgba(15, 23, 42, 0.08);
  --color-muted: #64748b;
  --color-chip-credit: #eef2ff;
  --color-chip-income: #dcfce7;
  --color-chip-debit: #fee2e2;
  --color-chip-neutral: #e2e8f0;
  --color-chip-balance: #dbeafe;
  --radius-pill: 999px;
  --radius-md: 16px;
  --space-xxs: 4px;
  --space-xs: 8px;
  --space-sm: 12px;
  --space-md: 16px;
  --space-lg: 20px;
}

* {
  box-sizing: border-box;
}

body,
#root {
  margin: 0;
  min-height: 100vh;
}

body {
  background: linear-gradient(180deg, #f5f7fb 0%, #edf0f9 100%);
}

a {
  color: #2563eb;
  text-decoration: none;
}

.app-shell {
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}

.app-main {
  flex: 1;
  padding: 24px;
  max-width: 900px;
  margin: 0 auto;
}

.card {
  background: var(--color-surface);
  border-radius: var(--radius-md);
  border: 1px solid var(--color-border);
  padding: var(--space-lg);
  margin-bottom: 16px;
  box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
}

.card h2 {
  margin-top: 0;
}

.btn {
  border: none;
  border-radius: 999px;
  padding: 10px 18px;
  cursor: pointer;
  font-weight: 600;
  background: #2563eb;
  color: #fff;
  transition: opacity 0.2s ease;
}

.btn:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.btn-secondary {
  background: #fff;
  color: #0f172a;
  border: 1px solid rgba(15, 23, 42, 0.2);
}

.toast-stack {
  position: fixed;
  top: 16px;
  right: 16px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 999;
}

.toast {
  padding: 12px 16px;
  border-radius: 8px;
  color: #fff;
  box-shadow: 0 12px 20px rgba(0, 0, 0, 0.15);
}

.toast-info {
  background: #2563eb;
}

.toast-success {
  background: #16a34a;
}

.toast-error {
  background: #dc2626;
}

.grid {
  display: grid;
  gap: 16px;
}

.grid-two {
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
}

.list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.list li {
  padding: 12px 0;
  border-bottom: 1px solid rgba(15, 23, 42, 0.08);
}

.list--dense li {
  padding: 12px 0;
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: var(--space-sm);
  flex-wrap: wrap;
}

.muted {
  color: var(--color-muted);
  margin: 4px 0;
}

.chip {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  border-radius: var(--radius-pill);
  font-size: 13px;
  padding: 4px 10px;
  background: var(--color-chip-neutral);
  color: #0f172a;
  border: 1px solid rgba(15, 23, 42, 0.06);
}

.chip--balance {
  background: var(--color-chip-balance);
}

.chip--credit {
  background: var(--color-chip-credit);
}

.chip--derived {
  background: #fde68a;
}

.chip--neutral {
  background: var(--color-chip-neutral);
}

.chip--source.chip--income {
  background: var(--color-chip-income);
}

.chip--source.chip--debit {
  background: var(--color-chip-debit);
}

.chip--source.chip--credit {
  background: var(--color-chip-credit);
}

.metadata-badges {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-xs);
  margin-top: var(--space-xs);
}

.metadata-badge {
  padding: 4px 8px;
  border-radius: 10px;
  font-size: 13px;
  background: var(--color-chip-neutral);
  border: 1px solid rgba(15, 23, 42, 0.06);
}

.metadata-badge--merchant {
  background: #e0f2fe;
}

.metadata-badge--mcc {
  background: #ede9fe;
}

.metadata-badge--code {
  background: #fee2e2;
}

.metadata-badge--obligation {
  background: #fef3c7;
}

.metadata-badge--muted {
  background: transparent;
  border-style: dashed;
  color: var(--color-muted);
}

.event-row {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.event-row__header {
  display: flex;
  justify-content: space-between;
  gap: var(--space-sm);
}

.event-row__title {
  font-weight: 600;
  margin: 0 0 4px;
}

.event-row__subtitle {
  margin: 0;
  color: var(--color-muted);
  font-size: 14px;
}

.event-row__amount {
  min-width: 160px;
  text-align: right;
}

.obligation-row {
  border-left: 3px solid transparent;
  padding-left: var(--space-sm);
}

.obligation-row--derived {
  border-left-color: #f59e0b;
}

.filter-row {
  display: flex;
  gap: var(--space-sm);
  flex-wrap: wrap;
}

.filter-row label {
  display: flex;
  flex-direction: column;
  font-size: 13px;
  color: var(--color-muted);
}

.safe-card {
  position: relative;
  overflow: hidden;
}

.safe-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
  gap: var(--space-md);
  margin: var(--space-md) 0;
}

.metric {
  font-size: 20px;
}

.safe-recommendation {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-xs);
  align-items: baseline;
  padding: 8px 12px;
  background: #ecfccb;
  border-radius: 8px;
  margin-bottom: 12px;
}

.safe-obligations {
  border-top: 1px solid rgba(15, 23, 42, 0.08);
  margin-top: var(--space-md);
  padding-top: var(--space-sm);
}

.credit-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--space-sm);
}

.credit-row__metrics {
  display: flex;
  flex-direction: column;
  gap: 4px;
  text-align: right;
}

.metadata-transactions {
  list-style: none;
  padding-left: 0;
  display: grid;
  gap: 4px;
}

.metadata-transactions li {
  display: grid;
  grid-template-columns: minmax(80px, 120px) 80px 1fr;
  gap: 8px;
  font-size: 13px;
  border-bottom: 1px dashed rgba(15, 23, 42, 0.08);
  padding-bottom: 4px;
}

.portrait-summary {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-xs);
  margin-bottom: var(--space-sm);
}

.portrait-event {
  padding-bottom: var(--space-sm);
}

.portrait-event__header {
  display: flex;
  justify-content: space-between;
  gap: var(--space-sm);
}

.portrait-panel {
  border: 1px solid rgba(15, 23, 42, 0.08);
  border-radius: 12px;
  padding: var(--space-sm);
}

@media (max-width: 640px) {
  .event-row__header {
    flex-direction: column;
    align-items: flex-start;
  }

  .event-row__amount {
    text-align: left;
  }

  .filter-row {
    flex-direction: column;
  }

  .metadata-badges {
    flex-direction: column;
    align-items: flex-start;
  }

  .metadata-transactions li {
    grid-template-columns: repeat(2, minmax(80px, 1fr));
  }

  .safe-grid {
    grid-template-columns: 1fr;
  }
}

.text-input,
select,
textarea {
  width: 100%;
  padding: 10px 12px;
  border-radius: 10px;
  border: 1px solid rgba(15, 23, 42, 0.2);
  font-size: 16px;
  margin: 8px 0 16px;
  font-family: inherit;
  background: #fff;
}
</file>

<file path="hktn/src/App.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import React from 'react';
import { Navigate, Outlet, Route, Routes, useLocation, useNavigate } from 'react-router-dom';
import { useNotifications } from './state/notifications';
import { useUser } from './state/useUser';
import { BanksCatalogPage } from './pages/BanksCatalogPage';
import { CallbackPage } from './pages/CallbackPage';
import { ConsentStatusPage } from './pages/ConsentStatusPage';
import { DashboardPage } from './pages/DashboardPage';
import { DebtGoalPage } from './pages/DebtGoalPage';
import { GoalsLandingPage } from './pages/GoalsLandingPage';
import { IngestionPage } from './pages/IngestionPage';
import { SaveGoalPage } from './pages/SaveGoalPage';
import { UserIdPage } from './pages/UserIdPage';
import { ConsentProcessPage } from './pages/ConsentProcessPage';
const ProtectedRoute = () => {
    const { userId } = useUser();
    const location = useLocation();
    if (!userId) {
        return _jsx(Navigate, { to: "/", replace: true, state: { from: location } });
    }
    return _jsx(Outlet, {});
};
class AppErrorBoundary extends React.Component {
    constructor(props) {
        super(props);
        this.state = { hasError: false };
    }
    static getDerivedStateFromError(error) {
        return { hasError: true, message: error.message };
    }
    componentDidCatch(error, errorInfo) {
        console.error('App crashed', error, errorInfo);
    }
    render() {
        if (this.state.hasError) {
            return (_jsx("div", { className: "app-main", children: _jsxs("div", { className: "card", children: [_jsx("h2", { children: "\u0427\u0442\u043E-\u0442\u043E \u043F\u043E\u0448\u043B\u043E \u043D\u0435 \u0442\u0430\u043A" }), _jsx("p", { children: this.state.message }), _jsx("button", { className: "btn", onClick: () => this.setState({ hasError: false }), children: "\u041F\u043E\u043F\u0440\u043E\u0431\u043E\u0432\u0430\u0442\u044C \u0441\u043D\u043E\u0432\u0430" })] }) }));
        }
        return this.props.children;
    }
}
const Header = () => {
    const { userId, clearUser } = useUser();
    const navigate = useNavigate();
    const { notify } = useNotifications();
    return (_jsxs("header", { style: { padding: '16px 24px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }, children: [_jsxs("div", { children: [_jsx("strong", { children: "FinPulse MPA" }), userId ? _jsxs("span", { style: { marginLeft: 12, color: '#475569' }, children: ["User: ", userId] }) : null] }), _jsxs("div", { style: { display: 'flex', gap: 12 }, children: [_jsx("button", { className: "btn-secondary btn", onClick: () => navigate('/dashboard'), children: "\u0414\u0430\u0448\u0431\u043E\u0440\u0434" }), userId ? (_jsx("button", { className: "btn-secondary btn", onClick: () => {
                            clearUser();
                            notify('–°–µ—Å—Å–∏—è –æ—á–∏—â–µ–Ω–∞');
                            navigate('/');
                        }, children: "\u0421\u0431\u0440\u043E\u0441\u0438\u0442\u044C" })) : null] })] }));
};
export const App = () => (_jsx(AppErrorBoundary, { children: _jsxs("div", { className: "app-shell", children: [_jsx(Header, {}), _jsxs(Routes, { children: [_jsx(Route, { path: "/", element: _jsx(UserIdPage, {}) }), _jsxs(Route, { element: _jsx(ProtectedRoute, {}), children: [_jsx(Route, { path: "/banks", element: _jsx(BanksCatalogPage, {}) }), _jsx(Route, { path: "/banks/:bankId/status", element: _jsx(ConsentStatusPage, {}) }), _jsx(Route, { path: "/onboarding/consent", element: _jsx(ConsentProcessPage, {}) }), _jsx(Route, { path: "/goals", element: _jsx(GoalsLandingPage, {}) }), _jsx(Route, { path: "/goals/save", element: _jsx(SaveGoalPage, {}) }), _jsx(Route, { path: "/goals/debts", element: _jsx(DebtGoalPage, {}) }), _jsx(Route, { path: "/ingest", element: _jsx(IngestionPage, {}) }), _jsx(Route, { path: "/dashboard", element: _jsx(DashboardPage, {}) })] }), _jsx(Route, { path: "/callback", element: _jsx(CallbackPage, {}) }), _jsx(Route, { path: "*", element: _jsx(Navigate, { to: "/", replace: true }) })] })] }) }));
export default App;
</file>

<file path="hktn/backend_app.py">
"""Compatibility wrapper for legacy imports.

This module keeps the historical `hktn.backend_app:app` entrypoint working
while the real FastAPI application lives inside `hktn.backend`.
"""

try:  # pragma: no cover - compatibility for direct module import
    from .backend.app import app, create_app
    from .backend.config import settings
except ImportError:  # pragma: no cover
    from backend.app import app, create_app  # type: ignore
    from backend.config import settings  # type: ignore

from hktn.core.obr_client import OBRAPIClient  # re-exported for legacy tests

BANK_CONFIGS = settings.banks
TEAM_CLIENT_ID = settings.team_client_id
TEAM_CLIENT_SECRET = settings.team_client_secret

__all__ = ["app", "create_app", "BANK_CONFIGS", "TEAM_CLIENT_ID", "TEAM_CLIENT_SECRET", "OBRAPIClient"]
</file>

<file path="readme.md">
# Cash Predict

## –û–±–∑–æ—Ä –ø—Ä–æ–µ–∫—Ç–∞

- **–¶–µ–ª—å:** –ø–æ–º–æ—á—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º –ø—Ä–∏–Ω–∏–º–∞—Ç—å —É–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è: —Å–æ–±—Ä–∞—Ç—å –¥–∞–Ω–Ω—ã–µ –±–∞–Ω–∫–æ–≤—Å–∫–∏—Ö —Å—á–µ—Ç–æ–≤, —Ä–∞—Å—Å—á–∏—Ç–∞—Ç—å –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –æ—Å—Ç–∞—Ç–æ–∫ –¥–ª—è —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –ø–æ–∫–∞–∑–∞—Ç—å –≤–µ—Å–æ–º—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –Ω–∞ –ª–µ–≥–∫–æ–≤–µ—Å–Ω–æ–π –ø–∞–Ω–µ–ª–∏.
- **–°—Ç–µ–∫:** FastAPI –Ω–∞ Python –¥–ª—è —Å–±–æ—Ä–∞ –¥–∞–Ω–Ω—ã—Ö, –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∏ API + –ø—Ä–æ—Ç–æ—Ç–∏–ø —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ –Ω–∞ TypeScript/Vite, –ø–æ–∫–∞ —Ä–∞–±–æ—Ç–∞—é—â–∏–π –Ω–∞ –º–æ–∫–∞—Ö.
- **–°—Ç–∞—Ç—É—Å:** —è–¥—Ä–æ –±—ç–∫–µ–Ω–¥–∞ (—Å–æ–≥–ª–∞—Å–∏—è, —Å–±–æ—Ä, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞) —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–ª–∏–µ–Ω—Ç—ã OBR; —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –ø–æ–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä–∏—Ä—É–µ—Ç—Å—è —á–µ—Ä–µ–∑ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω–Ω—ã–π –∏ –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–æ—Ç–æ—Ç–∏–ø.

## –û—Å–Ω–æ–≤–Ω—ã–µ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

1. **–°–æ–≥–ª–∞—Å–∏—è –∏ –∞–≥—Ä–µ–≥–∞—Ü–∏—è** ‚Äî –∏–Ω–∏—Ü–∏–∏—Ä—É–µ–º —Å–æ–≥–ª–∞—Å–∏—è –≤ –ø–µ—Å–æ—á–Ω–∏—Ü–µ, –æ–ø—Ä–∞—à–∏–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –∏ —Å–∫–∞—á–∏–≤–∞–µ–º —Å—á–µ—Ç–∞/—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —á–µ—Ä–µ–∑ `core.obr_client`.
2. **–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∞—è –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞** ‚Äî –ø—Ä–µ–≤—Ä–∞—â–∞–µ—Ç –Ω–µ–æ–±—Ä–∞–±–æ—Ç–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –≤ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞, —Ü–µ–ª–∏ –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ (—Å–º. `data/scripts/test_anal.py` –∏ `hktn/core/analytics_engine.py`).
3. **Backend API** ‚Äî FastAPI-—Ä–æ—É—Ç–µ—Ä—ã —ç–∫—Å–ø–æ–Ω–∏—Ä—É—é—Ç –±–∞–Ω–∫–∏, –∫–æ–Ω–≤–µ–π–µ—Ä —Å–æ–≥–ª–∞—Å–∏–π, onboarding –∏ –¥–∞—à–±–æ—Ä–¥; –ø–æ–∫—Ä—ã—Ç—ã –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –ø—Ä–æ–≤–µ—Ä–∫–∞–º–∏ –∏ —Å–Ω—É–ø-—Ç–µ—Å—Ç–æ–º.
4. **–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–∞–Ω–Ω—ã—Ö** ‚Äî —Ö–µ–ª–ø–µ—Ä—ã –≤—Ä–æ–¥–µ `collect_data.py`/`hndmd.py` –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä—É—é—Ç —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∏–∑ –ø–µ—Å–æ—á–Ω–∏—Ü—ã –¥–ª—è –¥–µ–º–æ –∏ –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π.

## –§—Ä–æ–Ω—Ç–µ–Ω–¥ –∏ –¥–µ–º–æ

- –ú—ã –ø–æ–¥–≥–æ—Ç–æ–≤–∏–ª–∏ **–ø–æ–ª–Ω—ã–π –ø—Ä–æ—Ç–æ—Ç–∏–ø –≤–æ Figma**, –∫–æ—Ç–æ—Ä—ã–π –æ–ø–∏—Å—ã–≤–∞–µ—Ç –ø—É—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –≤–∏–∑—É–∞–ª—å–Ω—É—é —Å—Ç–∏–ª–∏—Å—Ç–∏–∫—É –∏ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –¥–ª—è –ø—Ä–µ–∑–µ–Ω—Ç–∞—Ü–∏–π –∏ –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–π.
- –í—Ä–µ–º—è –Ω–µ –ø–æ–∑–≤–æ–ª–∏–ª–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–≤—è–∑–∞—Ç—å –∫–æ–Ω–µ—á–Ω—ã–µ —Ç–æ—á–∫–∏ –±—ç–∫–µ–Ω–¥–∞ –∫ –ø—Ä–æ–¥–≤–∏–Ω—É—Ç–æ–º—É –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—É, –Ω–æ –º–æ–∫–æ–≤–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Ç–æ–º—É, –∫–∞–∫ –º—ã –ø—Ä–æ–µ–∫—Ç–∏—Ä—É–µ–º API.
- –ú—ã –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–±–æ—Ç—É –Ω–∞–¥ –±—ç–∫–µ–Ω–¥–æ–º –∏ –ø–ª–∞–Ω–∏—Ä—É–µ–º –∑–∞–∫–æ–Ω—á–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –∫ –ø–æ–ª—É—Ñ–∏–Ω–∞–ª—É; —Å–µ–π—á–∞—Å –¥–µ–º–æ –ø—Ä–æ—Ö–æ–¥–∏—Ç –ø–æ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã–º –¥–∞–Ω–Ω—ã–º –∏ –ø—Ä–æ—Ç–æ—Ç–∏–ø—É, —á—Ç–æ–±—ã –ø–æ–∫–∞–∑–∞—Ç—å –≤—Å—é –∏–¥–µ—é.

## –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

```bash
python -m venv venv
source venv/bin/activate
pip install -r hktn/requirements.txt
cd hktn
npx vite build
```

–¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –±—ç–∫–µ–Ω–¥–∞: `python -m hktn.backend.app` (FastAPI + Uvicorn).

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

- –ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –º–µ–∂–¥—É FastAPI –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º –∏–∑ –ø—Ä–æ—Ç–æ—Ç–∏–ø–∞.
- –†–∞—Å—à–∏—Ä–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã (—Å–º–æ—É–∫, –∞–Ω–∞–ª–∏—Ç–∏–∫–∞, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏) –∏ –ø–æ–¥–∫–ª—é—á–∏—Ç—å CI.
</file>

<file path="hktn/backend/services/banking.py">
from __future__ import annotations

import asyncio
import logging
from contextlib import asynccontextmanager
from typing import Any, Dict, List, Optional, Sequence, Tuple

from fastapi import HTTPException, status

from hktn.core.database import add_bank_status_log, find_approved_consents
from hktn.core.obr_client import OBRAPIClient

from ..config import BankConfig, settings
from ..state import api_cache

logger = logging.getLogger("finpulse.backend.banking")


def _ensure_team_credentials() -> Tuple[str, str]:
    if not settings.team_client_id or not settings.team_client_secret:
        raise HTTPException(
            status_code=status.HTTP_500_INTERNAL_SERVER_ERROR,
            detail="Server is missing TEAM credentials.",
        )
    return settings.team_client_id, settings.team_client_secret


def _require_bank(bank_id: str, require_url: bool = True) -> BankConfig:
    config = settings.banks.get(bank_id)
    if not config:
        raise HTTPException(status_code=404, detail=f"Bank '{bank_id}' is not supported.")
    if require_url and not config.url:
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail="Bank endpoint URL is not configured.",
        )
    return config


def get_bank_config(bank_id: str, require_url: bool = False) -> BankConfig:
    """Return bank configuration ensuring it exists."""
    return _require_bank(bank_id, require_url=require_url)


@asynccontextmanager
async def bank_client(bank_id: str):
    config = _require_bank(bank_id, require_url=True)
    client_id, client_secret = _ensure_team_credentials()
    client = OBRAPIClient(
        api_base_url=config.url,
        team_client_id=client_id,
        team_client_secret=client_secret,
    )
    try:
        yield client
    finally:
        await client.close()


def list_banks(user_id: Optional[str] = None) -> Dict[str, List[Dict[str, Any]]]:
    connected_bank_ids = set()
    if user_id:
        connected_bank_ids = {
            consent.bank_id for consent in find_approved_consents(user_id, consent_type="accounts")
        }

    banks = []
    for bank_id, config in settings.banks.items():
        entry: Dict[str, Any] = {
            "id": bank_id,
            "name": config.display_name,
            "connected": bank_id in connected_bank_ids,
            "baseUrl": config.url,
            "status": "configured" if config.url else "missing_url",
        }
        if not config.url:
            entry["error"] = "Bank endpoint URL is not configured."
        banks.append(entry)
    return {"banks": banks}


async def fetch_bank_data_with_consent(bank_id: str, consent_id: str, user_id: str) -> Dict[str, Any]:
    cache_key = f"{user_id}:{bank_id}:{consent_id}"
    if cache_key in api_cache:
        logger.info("Serving data from cache for bank %s", bank_id)
        return api_cache[cache_key]

    _require_bank(bank_id)
    async with bank_client(bank_id) as client:
        try:
            transactions = await client.fetch_transactions_with_consent(user_id, consent_id)
            message = f"Fetched {len(transactions)} transactions"
            result = {
                "bank_id": bank_id,
                "status": "ok",
                "transactions": transactions,
                "message": message,
            }
            api_cache[cache_key] = result
            add_bank_status_log(user_id, bank_id, "fetch_transactions", "ok", message)
            return result
        except Exception as exc:  # noqa: BLE001
            error_message = str(exc)
            logger.error("Failed to fetch data for bank %s: %s", bank_id, error_message)
            add_bank_status_log(user_id, bank_id, "fetch_transactions", "error", error_message)
            return {"bank_id": bank_id, "status": "error", "transactions": [], "message": error_message}


async def fetch_bank_credits(
    bank_id: str,
    consent_id: str,
    user_id: str,
    user_name: Optional[str] = None,
    create_product_consent: bool = False,
) -> Dict[str, Any]:
    _require_bank(bank_id)
    async with bank_client(bank_id) as client:
        try:
            prod_consent_id = consent_id
            if create_product_consent:
                prod_consent_meta = await client.initiate_product_consent(user_id, user_display_name=user_name)
                if prod_consent_meta and prod_consent_meta.consent_id:
                    prod_consent_id = prod_consent_meta.consent_id

            credits = await client.fetch_credits_with_consent(user_id, prod_consent_id)
            for credit in credits or []:
                if isinstance(credit, dict):
                    credit.setdefault("bank_id", bank_id)
                    credit.setdefault("bank_name", settings.banks[bank_id].display_name)
            message = f"Fetched {len(credits)} credits"
            add_bank_status_log(user_id, bank_id, "fetch_credits", "ok", message)
            return {
                "bank_id": bank_id,
                "status": "ok",
                "credits": credits,
                "message": message,
            }
        except Exception as exc:  # noqa: BLE001
            error_message = str(exc)
            logger.error("Failed to fetch credits for bank %s: %s", bank_id, error_message)
            add_bank_status_log(user_id, bank_id, "fetch_credits", "error", error_message)
            return {"bank_id": bank_id, "status": "error", "credits": [], "message": error_message}


async def fetch_bank_accounts_with_consent(bank_id: str, consent_id: str, user_id: str) -> Dict[str, Any]:
    _require_bank(bank_id)
    async with bank_client(bank_id) as client:
        try:
            accounts = await client.fetch_accounts_with_consent(user_id, consent_id)
            for account in accounts or []:
                if isinstance(account, dict):
                    account.setdefault("bank_id", bank_id)
                    account.setdefault("bank_name", settings.banks[bank_id].display_name)
            message = f"Fetched {len(accounts)} accounts"
            add_bank_status_log(user_id, bank_id, "fetch_accounts", "ok", message)
            return {
                "bank_id": bank_id,
                "status": "ok",
                "accounts": accounts,
                "message": message,
            }
        except Exception as exc:  # noqa: BLE001
            error_message = str(exc)
            logger.error("Failed to fetch accounts for bank %s: %s", bank_id, error_message)
            add_bank_status_log(user_id, bank_id, "fetch_accounts", "error", error_message)
            return {"bank_id": bank_id, "status": "error", "accounts": [], "message": error_message}


async def bootstrap_bank(bank_id: str, user_id: str) -> Dict[str, Any]:
    """Aggregate initial payload for a connected bank."""
    config = _require_bank(bank_id)
    if not config.url:
        message = "Bank endpoint URL is not configured."
        add_bank_status_log(user_id, bank_id, "bootstrap", "error", message)
        raise HTTPException(
            status_code=status.HTTP_503_SERVICE_UNAVAILABLE,
            detail=message,
        )

    approved_consents = find_approved_consents(user_id, consent_type="accounts")
    consent = next((entry for entry in approved_consents if entry.bank_id == bank_id), None)
    if not consent:
        message = "No approved consents found."
        add_bank_status_log(user_id, bank_id, "bootstrap", "error", message)
        raise HTTPException(status_code=status.HTTP_424_FAILED_DEPENDENCY, detail=message)

    accounts_task = fetch_bank_accounts_with_consent(bank_id, consent.consent_id, user_id)
    transactions_task = fetch_bank_data_with_consent(bank_id, consent.consent_id, user_id)
    credits_task = fetch_bank_credits(bank_id, consent.consent_id, user_id)

    accounts_res, transactions_res, credits_res = await asyncio.gather(
        accounts_task,
        transactions_task,
        credits_task,
    )

    transactions_snapshot = list(transactions_res.get("transactions") or [])[:100]
    status_block = {
        "accounts": {
            "state": accounts_res.get("status"),
            "message": accounts_res.get("message"),
        },
        "transactions": {
            "state": transactions_res.get("status"),
            "message": transactions_res.get("message"),
        },
        "credits": {
            "state": credits_res.get("status"),
            "message": credits_res.get("message"),
        },
    }

    result = {
        "bank_id": bank_id,
        "user_id": user_id,
        "baseUrl": config.url,
        "accounts": accounts_res.get("accounts") or [],
        "credits": credits_res.get("credits") or [],
        "transactions": transactions_snapshot,
        "status": status_block,
    }
    add_bank_status_log(user_id, bank_id, "bootstrap", "ok", "Bootstrap payload generated.")
    return result
</file>

<file path="hktn/backend/services/onboarding.py">
from __future__ import annotations

import asyncio
import logging
from datetime import datetime, timezone
from typing import Any, Dict

from fastapi import HTTPException, status

from hktn.core.database import (
    commit_onboarding_session,
    find_approved_consents,
    get_latest_onboarding_session,
    get_product_consents_for_user,
    get_user_consents,
    get_user_goal,
    upsert_product_consents,
)

from ..schemas import FinancialPortraitRequest, IngestRequest, OnboardingCommitRequest, ProductConsentRequest
from .banking import fetch_bank_accounts_with_consent, fetch_bank_credits
from .products import apply_consent_flags, build_account_product, build_credit_product, group_products_by_bank

logger = logging.getLogger("finpulse.backend.onboarding")


async def preview_products(req: IngestRequest) -> Dict[str, Any]:
    """Fetch lightweight preview of accounts and credits for onboarding."""
    approved_consents = find_approved_consents(req.user_id, consent_type="accounts")
    if not approved_consents:
        raise HTTPException(
            status_code=status.HTTP_424_FAILED_DEPENDENCY,
            detail="No approved consents found.",
        )

    account_tasks = [
        fetch_bank_accounts_with_consent(consent.bank_id, consent.consent_id, req.user_id)
        for consent in approved_consents
    ]
    credit_tasks = [
        fetch_bank_credits(
            consent.bank_id,
            consent.consent_id,
            req.user_id,
            req.user_name,
            create_product_consent=True,
        )
        for consent in approved_consents
    ]

    account_results, credit_results = await asyncio.gather(
        asyncio.gather(*account_tasks),
        asyncio.gather(*credit_tasks),
    )

    products_by_bank: Dict[str, list[Dict[str, Any]]] = {}
    for res in account_results:
        bank_id = res["bank_id"]
        products_by_bank.setdefault(bank_id, [])
        if res["status"] != "ok":
            continue
        for account in res.get("accounts", []) or []:
            enriched = build_account_product(account, bank_id)
            if not enriched:
                continue
            products_by_bank[bank_id].append(enriched)

    for res in credit_results:
        bank_id = res["bank_id"]
        products_by_bank.setdefault(bank_id, [])
        if res["status"] != "ok":
            continue
        for credit in res.get("credits", []) or []:
            enriched = build_credit_product(credit, bank_id)
            if not enriched:
                continue
            products_by_bank[bank_id].append(enriched)

    existing_consents = get_product_consents_for_user(req.user_id)
    products_by_bank = apply_consent_flags(products_by_bank, existing_consents)
    latest_state = get_user_consents(req.user_id) or []

    return {"productsByBank": products_by_bank, "latestConsentState": latest_state}


def save_product_consents(req: ProductConsentRequest) -> Dict[str, Any]:
    """Persist the user's product consent selections."""
    if not req.user_id:
        raise HTTPException(status_code=400, detail="user_id is required.")

    approved_consents = find_approved_consents(req.user_id, consent_type="accounts")
    if not approved_consents:
        raise HTTPException(
            status_code=status.HTTP_424_FAILED_DEPENDENCY,
            detail="No approved consents found.",
        )

    try:
        payload = [item.model_dump() for item in req.items]
        upsert_product_consents(req.user_id, payload)
        current_consents = get_product_consents_for_user(req.user_id)
        latest_state = get_user_consents(req.user_id) or []
        return {
            "status": "ok",
            "consents": current_consents,
            "latestConsentState": latest_state,
        }
    except Exception as exc:  # noqa: BLE001
        logger.error("Failed to save product consents for user %s: %s", req.user_id, exc)
        raise HTTPException(status_code=500, detail="Could not save product consents.") from exc


def finalize_onboarding(req: OnboardingCommitRequest) -> Dict[str, Any]:
    """Commit the onboarding flow and store a snapshot."""
    if not req.user_id:
        raise HTTPException(status_code=400, detail="user_id is required.")

    try:
        approved_consents = find_approved_consents(req.user_id, consent_type="accounts")
        if not approved_consents:
            raise HTTPException(
                status_code=status.HTTP_424_FAILED_DEPENDENCY,
                detail="No approved consents found.",
            )

        product_consents = get_product_consents_for_user(req.user_id)
        if not product_consents:
            raise HTTPException(
                status_code=status.HTTP_424_FAILED_DEPENDENCY,
                detail="No product consents have been saved.",
            )

        user_goal = get_user_goal(req.user_id)
        if not user_goal:
            raise HTTPException(
                status_code=status.HTTP_424_FAILED_DEPENDENCY,
                detail="No financial goal has been saved.",
            )

        connected_bank_ids = [consent.bank_id for consent in approved_consents]
        commit_onboarding_session(req.user_id, connected_bank_ids, product_consents, user_goal)

        snapshot = {
            "banks_connected": connected_bank_ids,
            "products_consented": product_consents,
            "goal_profile": user_goal,
            "completed_at": datetime.now(timezone.utc).isoformat(),
        }
        return {"status": "ok", "message": "Onboarding completed", "data": snapshot}
    except HTTPException:
        raise
    except Exception as exc:  # noqa: BLE001
        logger.error("Failed to commit onboarding for user %s: %s", req.user_id, exc)
        raise HTTPException(status_code=500, detail="Could not finalize onboarding session.") from exc


async def load_app_state(user_id: str, include_portrait: bool = False) -> Dict[str, Any]:
    """Return onboarding snapshot, consents and optional portrait for the SPA shell."""
    snapshot = get_latest_onboarding_session(user_id)
    product_consents = get_product_consents_for_user(user_id)
    consents = get_user_consents(user_id)

    response: Dict[str, Any] = {
        "user_id": user_id,
        "is_onboarded": snapshot is not None,
        "onboarding_snapshot": snapshot,
        "product_consents": product_consents,
        "consents": consents,
    }

    if not snapshot:
        response["reason"] = "onboarding_not_completed"
        return response

    user_goal = get_user_goal(user_id)
    response["goal"] = user_goal

    portrait = None
    portrait_error = None

    if include_portrait:
        try:
            portrait_request = FinancialPortraitRequest(
                user_id=user_id,
                goal_type=(user_goal or {}).get("goal_type"),
                goal_details=(user_goal or {}).get("goal_details"),
                pace=(user_goal or {}).get("goal_details", {}).get("save_speed")
                or (user_goal or {}).get("goal_details", {}).get("close_speed"),
            )
            # Lazy import to avoid circular dependency at module load time.
            from .analytics import build_financial_portrait_view

            portrait = await build_financial_portrait_view(portrait_request)
        except HTTPException as exc:
            if exc.status_code == status.HTTP_424_FAILED_DEPENDENCY:
                portrait_error = exc.detail
            else:
                raise

    response["portrait"] = portrait
    response["portrait_error"] = portrait_error
    return response
</file>

<file path="hktn/core/obr_client.py">
import asyncio
import json
import logging
import uuid
from dataclasses import dataclass
from datetime import datetime, timedelta, timezone
from typing import Any, Dict, List, Optional
from urllib.parse import urljoin

import httpx
import jwt
from tenacity import retry, retry_if_exception, stop_after_attempt, wait_exponential

from .data_models import Transaction

logger = logging.getLogger(__name__)
DEFAULT_TIMEOUT = httpx.Timeout(20.0, connect=5.0)

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º, –∫–∞–∫–∏–µ –æ—à–∏–±–∫–∏ —Å—á–∏—Ç–∞—Ç—å –≤—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–æ–≤
RETRYABLE_EXCEPTIONS = (
    httpx.TimeoutException,
    httpx.ConnectError,
    httpx.NetworkError,
)


def _is_retryable(exc: BaseException) -> bool:
    """Retry only on transport errors and HTTP 5xx per API docs."""
    if isinstance(exc, httpx.HTTPStatusError):
        return exc.response.status_code >= 500
    return isinstance(exc, RETRYABLE_EXCEPTIONS)


# –°–æ–∑–¥–∞–µ–º –¥–µ–∫–æ—Ä–∞—Ç–æ—Ä retry —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
api_retry = retry(
    stop=stop_after_attempt(3),
    wait=wait_exponential(multiplier=1, min=1, max=5),
    retry=retry_if_exception(_is_retryable),
)

AUTHORIZED_CONSENT_STATUSES = {"Authorized", "AuthorizedConsent", "Active", "Approved"}
PENDING_CONSENT_STATUSES = {"AwaitingAuthorization", "Pending", "AwaitingApproval"}
FAILED_CONSENT_STATUSES = {"Rejected", "Expired", "Revoked", "Cancelled"}
_AUTHORIZED_STATUS_SET = {item.lower() for item in AUTHORIZED_CONSENT_STATUSES}
_FAILED_STATUS_SET = {item.lower() for item in FAILED_CONSENT_STATUSES}
RSA_JWT_ALGS = {"RS256", "RS384", "RS512"}


def _normalize_status_value(value: Any) -> str:
    if value is None:
        return ""
    return str(value).strip()


@dataclass
class ConsentInitResult:
    consent_id: Optional[str]
    status: str
    auto_approved: bool
    approval_url: Optional[str] = None
    request_id: Optional[str] = None

    @property
    def requires_manual_action(self) -> bool:
        return not self.auto_approved and self.status not in AUTHORIZED_CONSENT_STATUSES


class OBRAPIClient:
    """Implements the multi-step OBR consent flow."""

    def __init__(self, api_base_url: str, team_client_id: str, team_client_secret: str):
        if not all([api_base_url, team_client_id, team_client_secret]):
            raise ValueError("api_base_url, team_client_id, and team_client_secret are required.")

        self.api_base_url = api_base_url.rstrip("/")
        self.team_id = team_client_id
        self.team_secret = team_client_secret
        self._client = httpx.AsyncClient(base_url=self.api_base_url, timeout=DEFAULT_TIMEOUT)
        self._bank_token: Optional[str] = None
        self._token_expires_at: Optional[datetime] = None
        self._jwks_keys: Optional[List[Dict[str, Any]]] = None
        self._token_lock = asyncio.Lock()

    async def _get_common_headers(self, bank_token: str) -> Dict[str, str]:
        """Header block shared by most outbound calls."""
        return {
            "Authorization": f"Bearer {bank_token}",
            "X-Requesting-Bank": self.team_id,
            "x-fapi-interaction-id": str(uuid.uuid4()),
        }

    @api_retry
    async def _get_jwks_keys(self) -> List[Dict[str, Any]]:
        if self._jwks_keys:
            return self._jwks_keys

        logger.info("Fetching JWKS from %s/.well-known/jwks.json", self.api_base_url)
        response = await self._client.get("/.well-known/jwks.json")
        response.raise_for_status()
        self._jwks_keys = response.json().get("keys", [])
        if not self._jwks_keys:
            raise ValueError("JWKS endpoint did not return any keys.")
        return self._jwks_keys

    def invalidate_jwks_cache(self) -> None:
        """Allow callers to force JWKS refresh (e.g., after key rotation)."""
        self._jwks_keys = None

    async def _validate_jwt(self, token: str) -> Dict[str, Any]:
        """
        Decode JWT payload and verify signature when the bank provides an RSA key.
        Some sandbox banks issue HS256 tokens without a shared secret in docs, so we
        fall back to skipping signature verification in that case.
        """
        try:
            unverified_header = jwt.get_unverified_header(token)
            alg = unverified_header.get("alg", "RS256")
            options = {"verify_aud": False}
            key: Optional[Any] = None

            if alg in RSA_JWT_ALGS:
                kid = unverified_header.get("kid")
                if not kid:
                    raise jwt.InvalidTokenError("JWT header is missing required 'kid' for RSA algorithms.")

                jwks_keys = await self._get_jwks_keys()
                if not jwks_keys:
                    raise jwt.InvalidTokenError("No keys found in JWKS endpoint.")

                key_data: Optional[Dict[str, Any]] = next(
                    (jwks_key for jwks_key in jwks_keys if jwks_key.get("kid") == kid),
                    None,
                )
                if key_data is None:
                    raise jwt.InvalidTokenError(f"Unknown 'kid' {kid} in JWT header.")

                public_key = jwt.algorithms.RSAAlgorithm.from_jwk(json.dumps(key_data))
                key = public_key
                options["verify_signature"] = True
            else:
                options["verify_signature"] = False
                logger.warning(
                    "Bank %s issued JWT with unsupported alg '%s'; skipping signature verification.",
                    self.api_base_url,
                    alg,
                )

            payload = jwt.decode(
                token,
                key,
                algorithms=[alg] if options.get("verify_signature") else None,
                options=options,
            )
            return payload
        except jwt.PyJWTError as exc:
            logger.error("JWT validation failed: %s", exc)
            raise

    async def _get_bank_token(self) -> str:
        async with self._token_lock:
            if self._bank_token and self._token_expires_at and datetime.now(timezone.utc) < self._token_expires_at:
                return self._bank_token

            logger.info("Requesting new bank token from %s", self.api_base_url)

            @api_retry
            async def _fetch_token_with_retry():
                response = await self._client.post(
                    "/auth/bank-token",
                    params={"client_id": self.team_id, "client_secret": self.team_secret},
                )
                response.raise_for_status()
                return response.json()

            token_data = await _fetch_token_with_retry()
            access_token = token_data["access_token"]

            payload = await self._validate_jwt(access_token)
            self._bank_token = access_token
            
            expires_at_timestamp = payload.get("exp", 0)
            self._token_expires_at = datetime.fromtimestamp(expires_at_timestamp, tz=timezone.utc) - timedelta(minutes=1)

            logger.info("Successfully obtained and validated new bank token.")
            return self._bank_token

    # !!! –£–ë–†–ê–õ–ò @retry –û–¢–°–Æ–î–ê !!!
    async def initiate_consent(self, user_id: str) -> ConsentInitResult:
        """
        Step 1: Create an account access consent request at the bank.
        Returns metadata about the consent, including approval URL when provided.
        """
        bank_token = await self._get_bank_token()
        headers = await self._get_common_headers(bank_token)
        body = {
            "client_id": user_id,
            "permissions": ["ReadAccountsDetail", "ReadBalances", "ReadTransactionsDetail"],
            "reason": "Financial analysis for FinPulse Hackathon",
            "requesting_bank": self.team_id,
            "requesting_bank_name": f"{self.team_id} App",
            "redirect_uri": "http://localhost:5173/callback",
        }

        logger.info("Initiating consent for user '%s' at %s", user_id, self.api_base_url)
        
        @api_retry
        async def _post_consent_request():
            response = await self._client.post("/account-consents/request", headers=headers, json=body)
            response.raise_for_status()
            return response.json()

        response_data = await _post_consent_request()

        data_section = response_data.get("data") if isinstance(response_data, dict) else {}
        if not isinstance(data_section, dict):
            data_section = {}

        consent_id = (
            data_section.get("consentId")
            or data_section.get("consent_id")
            or (response_data.get("consentId") if isinstance(response_data, dict) else None)
            or (response_data.get("consent_id") if isinstance(response_data, dict) else None)
        )
        request_id = (
            data_section.get("requestId")
            or data_section.get("request_id")
            or (response_data.get("request_id") if isinstance(response_data, dict) else None)
            or (response_data.get("requestId") if isinstance(response_data, dict) else None)
        )

        approval_url = (
            response_data.get("links", {}).get("consentApproval")
            or response_data.get("links", {}).get("consentApprovalUrl")
            or response_data.get("links", {}).get("approvalUrl")
            or response_data.get("approvalUrl")
            or response_data.get("approval_url")
        )

        status = (
            data_section.get("status")
            or response_data.get("status") if isinstance(response_data, dict) else None
            or ("Authorized" if response_data.get("auto_approved") else "AwaitingAuthorization")
        )
        auto_approved = bool(
            response_data.get("auto_approved")
            or data_section.get("autoApproved")
            or (status in AUTHORIZED_CONSENT_STATUSES)
        )

        if not consent_id and not request_id:
            raise ValueError("API did not return a consent or request identifier.")

        if not approval_url and auto_approved:
            logger.info(
                "Consent %s appears auto-approved at %s (no approval URL).",
                consent_id,
                self.api_base_url,
            )

        logger.info(
            "Consent initiated with consent_id=%s request_id=%s (status=%s)",
            consent_id,
            request_id,
            status,
        )
        return ConsentInitResult(
            consent_id=consent_id,
            approval_url=approval_url,
            status=status,
            auto_approved=auto_approved,
            request_id=request_id,
        )

    async def initiate_product_consent(
        self, user_id: str, user_display_name: Optional[str] = None
    ) -> Optional[ConsentInitResult]:
        """Tries multiple payloads to create a product agreement consent, inspired by hndmd.py."""
        bank_token = await self._get_bank_token()
        headers = await self._get_common_headers(bank_token)
        url = "/product-agreement-consents/request"

        valid_until = (
            datetime.now(timezone.utc) + timedelta(days=365)
        ).replace(microsecond=0).isoformat().replace("+00:00", "Z")

        base_payload = {
            "requesting_bank": self.team_id,
            "requesting_bank_name": f"{self.team_id} App",
            "client_id": user_id,
            "reason": "CreditGuard: credit analysis",
            "customer_name": user_display_name or user_id,
        }

        payloads_to_try = [
            {
                **base_payload,
                "read_product_agreements": True,
                "open_product_agreements": False,
                "close_product_agreements": False,
                "allowed_product_types": ["deposit", "loan", "credit_card"],
                "max_amount": 5_000_000,
                "valid_until": valid_until,
            },
            {
                **base_payload,
                "permissions": ["ReadProductAgreements"],
            },
            {
                **base_payload,
                "read_product_agreements": True,
            },
        ]

        for body in payloads_to_try:
            try:
                response = await self._client.post(
                    url,
                    headers=headers,
                    params={"client_id": user_id},
                    json=body,
                )
                if response.status_code >= 400:
                    logger.warning("Payload failed with status %s: %s", response.status_code, body)
                    continue

                data = response.json()
                consent_id = data.get("consent_id") or self._jget(data, ["data", "consentId"])
                request_id = data.get("request_id") or self._jget(data, ["data", "requestId"])
                status_raw = data.get("status") or self._jget(data, ["data", "status"])
                approval_url = self._jget(data, ["links", "consentApproval"])

                # SBank –º–æ–∂–µ—Ç –≤–µ—Ä–Ω—É—Ç—å request_id –≤–º–µ—Å—Ç–æ consent_id
                final_id = consent_id or request_id
                if final_id:
                    normalized_status = _normalize_status_value(status_raw).lower()
                    auto_approved = bool(
                        data.get("auto_approved")
                        or (normalized_status and normalized_status in _AUTHORIZED_STATUS_SET)
                    )
                    if not auto_approved and not approval_url and normalized_status not in _FAILED_STATUS_SET:
                        auto_approved = True
                        status_raw = "Approved"

                    status_value = status_raw or ("Approved" if auto_approved else "Pending")

                    logger.info("Product consent initiated successfully with payload: %s", body)
                    return ConsentInitResult(
                        consent_id=final_id,
                        status=status_value,
                        auto_approved=auto_approved,
                        approval_url=approval_url,
                        request_id=request_id,
                    )
            except httpx.RequestError as e:  # noqa: PERF203
                logger.warning("Request failed for product consent payload %s: %s", body, e)

        logger.error("All attempts to create product consent failed for user %s at %s", user_id, self.api_base_url)
        return None

    @api_retry
    async def get_consent_details(self, consent_id: str) -> Dict[str, Any]:
        """Fetch consent status from /account-consents/{consent_id}."""
        response = await self._client.get(f"/account-consents/{consent_id}")
        response.raise_for_status()
        return response.json()

    @api_retry
    async def get_consent_status_by_request_id(self, request_id: str) -> Dict[str, Any]:
        """Fetch consent status when only request_id is available."""
        bank_token = await self._get_bank_token()
        headers = await self._get_common_headers(bank_token)
        response = await self._client.get(f"/account-consents/{request_id}", headers=headers)
        response.raise_for_status()
        return response.json()

    async def wait_for_consent_authorization(
        self,
        consent_id: str,
        timeout_seconds: float = 300,
        poll_interval_seconds: float = 5,
    ) -> str:
        """Poll consent status until it becomes authorized or fails."""
        logger.info("Waiting for consent %s to be authorized...", consent_id)
        deadline = asyncio.get_running_loop().time() + timeout_seconds

        while True:
            consent_payload = await self.get_consent_details(consent_id)
            data_section = consent_payload.get("data", {}) if isinstance(consent_payload, dict) else {}
            status = data_section.get("status") or consent_payload.get("status") or "unknown"

            if status in AUTHORIZED_CONSENT_STATUSES:
                logger.info("Consent %s authorized with status %s.", consent_id, status)
                return status
            if status in FAILED_CONSENT_STATUSES:
                raise RuntimeError(f"Consent {consent_id} failed with status '{status}'.")

            if asyncio.get_running_loop().time() >= deadline:
                raise TimeoutError(f"Timed out waiting for consent {consent_id} authorization (last status {status}).")

            await asyncio.sleep(poll_interval_seconds)

    async def fetch_transactions_with_consent(self, user_id: str, consent_id: str) -> List[Transaction]:
        """
        Step 2: Retrieve transactions for the user using an approved consent.
        """
        bank_token = await self._get_bank_token()
        base_headers = await self._get_common_headers(bank_token)

        logger.info("Fetching accounts for user '%s' with consent '%s'", user_id, consent_id)
        headers = {**base_headers, "X-Consent-Id": consent_id}
        
        @api_retry
        async def _get_accounts():
            acc_response = await self._client.get(f"/accounts?client_id={user_id}", headers=headers)
            acc_response.raise_for_status()
            return acc_response.json()

        accounts_data = await _get_accounts()
        accounts = self._extract_accounts(accounts_data)

        all_transactions: List[Transaction] = []
        for account in accounts:
            account_id = self._extract_account_id(account)
            if not account_id:
                continue

            next_page_url: Optional[str] = f"/accounts/{account_id}/transactions?client_id={user_id}"
            page_num = 1
            while next_page_url:
                logger.info(
                    "Fetching transactions for account '%s', page %d (next=%s)",
                    account_id,
                    page_num,
                    next_page_url,
                )
                paginated_headers = {**headers, "x-fapi-interaction-id": str(uuid.uuid4())}

                @api_retry
                async def _get_transactions_page(url):
                    tx_response = await self._client.get(url, headers=paginated_headers)
                    tx_response.raise_for_status()
                    return tx_response.json()
                
                response_data = await _get_transactions_page(next_page_url)

                raw_txs = self._extract_transactions(response_data)

                for raw in raw_txs:
                    tx_model = self._to_transaction_model(raw)
                    if tx_model:
                        all_transactions.append(tx_model)
                    else:
                        logger.warning("Failed to normalize transaction payload: %s", raw)

                next_page_url = self._extract_next_link(response_data)
                logger.info(
                    "Pagination checkpoint account=%s page=%d next=%s",
                    account_id,
                    page_num,
                    next_page_url,
                )
                page_num += 1

        logger.info("Fetched %d transactions for user '%s' from %s", len(all_transactions), user_id, self.api_base_url)
        return all_transactions

    async def close(self) -> None:
        """Dispose the underlying HTTP client."""
        await self._client.aclose()

    async def fetch_accounts_with_consent(self, user_id: str, consent_id: str) -> List[Dict[str, Any]]:
        """Fetch accounts list for the user with the granted consent."""
        bank_token = await self._get_bank_token()
        headers = {**(await self._get_common_headers(bank_token)), "X-Consent-Id": consent_id}

        logger.info("Fetching accounts overview for user '%s' (consent %s)", user_id, consent_id)

        @api_retry
        async def _get_accounts():
            response = await self._client.get(f"/accounts?client_id={user_id}", headers=headers)
            response.raise_for_status()
            return response.json()

        payload = await _get_accounts()
        accounts = self._extract_accounts(payload)
        logger.info("Retrieved %d accounts for user '%s' from %s", len(accounts), user_id, self.api_base_url)
        return accounts

    async def fetch_credits_with_consent(self, user_id: str, consent_id: str) -> List[Dict[str, Any]]:
        """
        Fetches credit agreements using multiple header variations and pagination,
        inspired by hndmd.py.
        """
        if not consent_id:
            logger.warning("fetch_credits_with_consent called without consent_id for user %s", user_id)
            return []

        bank_token = await self._get_bank_token()
        common_headers = await self._get_common_headers(bank_token)
        params: Dict[str, Any] = {"client_id": user_id}

        urls_to_try = ["/credits", "/product-agreements"]

        headers_variations = [
            {"X-Product-Agreement-Consent-Id": consent_id},
            {"x-product-agreement-consent-id": consent_id},
            {"X-Consent-Id": consent_id},
        ]

        for url in urls_to_try:
            for header_variant in headers_variations:
                headers = {**common_headers, **header_variant}
                try:
                    response = await self._client.get(url, headers=headers, params=params)
                    if response.status_code in (400, 401, 403, 404):
                        logger.warning(
                            "Request to %s failed with status %s using header %s",
                            url,
                            response.status_code,
                            list(header_variant.keys())[0],
                        )
                        continue

                    response.raise_for_status()

                    all_agreements = await self._paginate(response, headers, params)
                    credits = [ag for ag in all_agreements if self._is_credit(ag)]

                    logger.info(
                        "Successfully fetched %d credits from %s using header %s",
                        len(credits),
                        url,
                        list(header_variant.keys())[0],
                    )
                    return credits
                except httpx.RequestError as e:
                    logger.error("Network error while fetching from %s: %s", url, e)
                    raise

        logger.error("All attempts to fetch credits/agreements failed for consent %s.", consent_id)
        return []

    async def _paginate(self, first_response: httpx.Response, headers: Dict[str, str], params: Dict[str, Any]) -> List[Dict[str, Any]]:
        """Paginates through API results using the 'next' link."""
        body = first_response.json()
        items = self._extract_agreements(body) or self._extract_accounts(body)
        items = list(items) if items else []

        next_url = self._extract_next_link(body)
        while next_url:
            paginated_params = {k: v for k, v in (params or {}).items() if f"{k}=" not in next_url}

            response = await self._client.get(next_url, headers=headers, params=paginated_params or None)
            if response.status_code != 200:
                logger.warning("Pagination failed at URL %s with status %s", next_url, response.status_code)
                break

            body = response.json()
            items.extend(self._extract_agreements(body) or self._extract_accounts(body))
            next_url = self._extract_next_link(body)

        return items

    @staticmethod
    def _jget(d: Dict[str, Any], path: List[str], default: Any = None) -> Any:
        cur = d
        for p in path:
            if isinstance(cur, dict) and p in cur:
                cur = cur[p]
            else:
                return default
        return cur

    @staticmethod
    def _is_credit(agreement: Dict[str, Any]) -> bool:
        """Checks if a product agreement is a credit product."""
        prod_type = (agreement.get("product_type") or "").lower()
        name = (agreement.get("product_name") or "").lower()
        return "credit" in prod_type or "loan" in prod_type or "–∫—Ä–µ–¥–∏—Ç" in name

    @staticmethod
    def _extract_accounts(payload: Any) -> List[Dict[str, Any]]:
        if isinstance(payload, dict):
            if isinstance(payload.get("accounts"), list):
                return payload["accounts"]
            data = payload.get("data")
            if isinstance(data, dict):
                if isinstance(data.get("accounts"), list):
                    return data["accounts"]
                if isinstance(data.get("account"), list):
                    return data["account"]
        return []

    @staticmethod
    def _extract_transactions(payload: Any) -> List[Dict[str, Any]]:
        if isinstance(payload, dict):
            if isinstance(payload.get("transactions"), list):
                return payload["transactions"]
            data = payload.get("data")
            if isinstance(data, dict):
                if isinstance(data.get("transactions"), list):
                    return data["transactions"]
                if isinstance(data.get("transaction"), list):
                    return data["transaction"]
        return []

    @staticmethod
    def _extract_agreements(payload: Any) -> List[Dict[str, Any]]:
        if isinstance(payload, dict):
            if isinstance(payload.get("agreements"), list):
                return payload["agreements"]
            if isinstance(payload.get("items"), list):
                return payload["items"]
            if isinstance(payload.get("credits"), list):
                return payload["credits"]
            data = payload.get("data")
            if isinstance(data, dict):
                if isinstance(data.get("agreements"), list):
                    return data["agreements"]
                if isinstance(data.get("credits"), list):
                    return data["credits"]
        return []

    def _extract_next_link(self, payload: Any) -> Optional[str]:
        if not isinstance(payload, dict):
            return None

        next_url = (
            self._jget(payload, ["links", "next"])
            or self._jget(payload, ["Links", "next"])
            or self._jget(payload, ["data", "links", "next"])
        )

        if not next_url:
            return None

        # –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω—ã—Ö –∏ –∞–±—Å–æ–ª—é—Ç–Ω—ã—Ö URL
        return urljoin(self.api_base_url + "/", str(next_url))

    @staticmethod
    def _extract_account_id(account_payload: Any) -> Optional[str]:
        if not isinstance(account_payload, dict):
            return None
        for key in ("accountId", "account_id", "id"):
            value = account_payload.get(key)
            if value:
                return str(value)
        return None

    @staticmethod
    def _parse_booking_datetime(raw_value: Any) -> Optional[datetime]:
        if not isinstance(raw_value, str):
            return None

        value = raw_value.strip()
        if not value:
            return None

        try:
            if value.endswith("Z"):
                value = value.replace("Z", "+00:00")
            return datetime.fromisoformat(value)
        except ValueError:
            try:
                return datetime.fromisoformat(value + "+00:00")
            except ValueError:
                return None

    @staticmethod
    def _safe_str(value: Any) -> Optional[str]:
        if value is None:
            return None
        text = str(value).strip()
        return text or None

    @staticmethod
    def _normalize_merchant_payload(raw: Any) -> Dict[str, Optional[str]]:
        if not isinstance(raw, dict):
            return {}
        merchant = {
            "merchantId": OBRAPIClient._safe_str(
                raw.get("merchantId") or raw.get("id") or raw.get("merchant_id")
            ),
            "name": OBRAPIClient._safe_str(raw.get("name")),
            "mccCode": OBRAPIClient._safe_str(raw.get("mccCode") or raw.get("mcc")),
            "category": OBRAPIClient._safe_str(raw.get("category")),
            "city": OBRAPIClient._safe_str(raw.get("city")),
            "country": OBRAPIClient._safe_str(raw.get("country")),
            "address": OBRAPIClient._safe_str(raw.get("address") or raw.get("street")),
        }
        return {key: value for key, value in merchant.items() if value}

    @staticmethod
    def _normalize_card_payload(raw: Any) -> Dict[str, Optional[str]]:
        if not isinstance(raw, dict):
            return {}
        card = {
            "maskedPan": OBRAPIClient._safe_str(raw.get("maskedPan") or raw.get("masked_pan")),
            "type": OBRAPIClient._safe_str(raw.get("type") or raw.get("scheme")),
            "name": OBRAPIClient._safe_str(raw.get("name")),
        }
        return {key: value for key, value in card.items() if value}

    @staticmethod
    def _extract_bank_transaction_code(raw: Any) -> Optional[str]:
        if raw is None:
            return None
        if isinstance(raw, str):
            return OBRAPIClient._safe_str(raw)
        if isinstance(raw, dict):
            code = OBRAPIClient._safe_str(raw.get("code"))
            subcode = OBRAPIClient._safe_str(raw.get("subCode") or raw.get("subcode"))
            if code and subcode:
                return f"{code}:{subcode}"
            return code or subcode
        return None

    def _to_transaction_model(self, raw: Any) -> Optional[Transaction]:
        if not isinstance(raw, dict):
            return None

        transaction_id = (
            raw.get("transactionId")
            or raw.get("transaction_id")
            or raw.get("id")
            or str(uuid.uuid4())
        )

        amount_payload = raw.get("amount") or raw.get("transactionAmount") or raw.get("transaction_amount")
        currency = "RUB"
        amount_value: Optional[str] = None
        if isinstance(amount_payload, dict):
            currency = amount_payload.get("currency", currency)
            amount_value = amount_payload.get("amount")
        elif amount_payload is not None:
            amount_value = amount_payload

        if amount_value is None:
            amount_value = raw.get("amount")
        if "currency" in raw and not isinstance(amount_payload, dict):
            currency = raw.get("currency") or currency

        try:
            amount = float(amount_value)
        except (TypeError, ValueError):
            return None

        indicator = raw.get("creditDebitIndicator") or raw.get("direction")
        if isinstance(indicator, str) and indicator.lower().startswith("debit"):
            amount = -abs(amount)
        elif isinstance(indicator, str) and indicator.lower().startswith("credit"):
            amount = abs(amount)

        booking_value = (
            raw.get("bookingDate")
            or raw.get("bookingDateTime")
            or raw.get("valueDate")
            or raw.get("valueDateTime")
        )
        booking_dt = self._parse_booking_datetime(booking_value)
        if booking_dt is None:
            return None

        description = (
            raw.get("transactionInformation")
            or raw.get("description")
            or raw.get("narration")
            or raw.get("statementDescription")
        )
        transaction_information = raw.get("transactionInformation")

        merchant_payload = self._normalize_merchant_payload(raw.get("merchant"))
        mcc_code = merchant_payload.get("mccCode") or self._safe_str(raw.get("mccCode") or raw.get("mcc_code"))

        bank_transaction_code = self._extract_bank_transaction_code(
            raw.get("bankTransactionCode") or raw.get("bank_transaction_code")
        )

        transaction_location = raw.get("transactionLocation") or raw.get("transaction_location") or raw.get("location")
        if not isinstance(transaction_location, dict):
            transaction_location = {}

        card_payload = self._normalize_card_payload(
            raw.get("card") or raw.get("cardInstrument") or raw.get("card_instrument")
        )

        category = self._safe_str(raw.get("category") or raw.get("transactionCategory") or raw.get("categoryCode"))

        return Transaction(
            transactionId=str(transaction_id),
            amount=amount,
            currency=str(currency),
            description=description,
            bookingDate=booking_dt.date(),
            creditDebitIndicator=self._safe_str(indicator),
            bankTransactionCode=bank_transaction_code,
            merchant=merchant_payload or {},
            mccCode=mcc_code,
            category=category,
            transactionInformation=transaction_information,
            transactionLocation=transaction_location or {},
            card=card_payload or {},
        )
</file>

<file path="hktn/src/components/UserIdForm.tsx">
import React, { useState } from 'react';

export const USER_ID_PATTERN = /^team260-([1-9]|10)$/i;
export const validateUserId = (value: string): boolean => USER_ID_PATTERN.test(value.trim());

type UserIdFormProps = {
  defaultUserId?: string | null;
  defaultUserName?: string | null;
  onSubmit: (userId: string, userName: string) => void | Promise<void>;
  isSubmitting?: boolean;
};

export const UserIdForm: React.FC<UserIdFormProps> = ({
  defaultUserId = '',
  defaultUserName = '',
  onSubmit,
  isSubmitting,
}) => {
  const [userId, setUserId] = useState(defaultUserId ?? '');
  const [userName, setUserName] = useState(defaultUserName ?? '');
  const [agreed, setAgreed] = useState(false);
  const [error, setError] = useState<string | null>(null);

  const handleSubmit = async (event: React.FormEvent) => {
    event.preventDefault();
    const trimmedId = userId.trim();
    const trimmedName = userName.trim();

    if (!validateUserId(trimmedId)) {
      setError('ID –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –≤ —Ñ–æ—Ä–º–∞—Ç–µ team260-X, –≥–¥–µ X –æ—Ç 1 –¥–æ 10');
      return;
    }
    if (!trimmedName) {
      setError('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è');
      return;
    }
    if (!agreed) {
      setError('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ —Å–æ–≥–ª–∞—Å–∏—Ç—å—Å—è –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
      return;
    }
    setError(null);
    await onSubmit(trimmedId, trimmedName);
  };

  return (
    <form className="card" onSubmit={handleSubmit}>
      <h2>–®–∞–≥ 1. –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è</h2>
      <p>–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID –∏ –∏–º—è –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã.</p>

      <label htmlFor="user-id-input">User ID</label>
      <input
        id="user-id-input"
        value={userId}
        onChange={(e) => setUserId(e.target.value)}
        placeholder="team260-1"
        className="text-input"
        disabled={isSubmitting}
      />

      <label htmlFor="user-name-input">–í–∞—à–µ –∏–º—è</label>
      <input
        id="user-name-input"
        value={userName}
        onChange={(e) => setUserName(e.target.value)}
        placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
        className="text-input"
        disabled={isSubmitting}
      />

      <label style={{ display: 'flex', gap: 12, alignItems: 'center', margin: '16px 0' }}>
        <input type="checkbox" checked={agreed} onChange={(e) => setAgreed(e.target.checked)} />
        <span>–Ø —Å–æ–≥–ª–∞—Å–µ–Ω –Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫—É –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö</span>
      </label>

      {error ? (
        <p role="alert" style={{ color: '#dc2626', marginTop: 8 }}>
          {error}
        </p>
      ) : null}
      <button type="submit" className="btn" disabled={isSubmitting || !agreed}>
        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
      </button>
    </form>
  );
};
</file>

<file path="hktn/src/pages/BanksCatalogPage.tsx">
import React, { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { useNotifications } from '../state/notifications';
import { useUser, BankSummary } from '../state/useUser';

export const BanksCatalogPage: React.FC = () => {
  const { userId, banks, refreshBanks, isFetchingBanks } = useUser();
  const { notifyError } = useNotifications();
  const navigate = useNavigate();
  const [selectedBankIds, setSelectedBankIds] = useState<Set<string>>(new Set());

  useEffect(() => {
    if (userId) {
      refreshBanks();
    }
  }, [userId, refreshBanks]);

  const handleToggleBank = (bankId: string) => {
    setSelectedBankIds((prev) => {
      const next = new Set(prev);
      if (next.has(bankId)) {
        next.delete(bankId);
      } else {
        next.add(bankId);
      }
      return next;
    });
  };

  const handleSubmit = () => {
    if (selectedBankIds.size === 0) {
      notifyError('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –±–∞–Ω–∫');
      return;
    }
    const selectedBanks: BankSummary[] = banks.filter((bank) => selectedBankIds.has(bank.id));
    navigate('/onboarding/consent', { state: { selectedBanks } });
  };

  return (
    <div className="app-main">
      <div className="card">
        <h2>–®–∞–≥ 2. –í—ã–±–µ—Ä–∏—Ç–µ –±–∞–Ω–∫–∏</h2>
        <p>–û—Ç–º–µ—Ç—å—Ç–µ –±–∞–Ω–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ —Ö–æ—Ç–∏—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞.</p>
      </div>

      {isFetchingBanks && (
        <div className="card">
          <p>–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –±–∞–Ω–∫–æ–≤...</p>
        </div>
      )}

      {!isFetchingBanks && banks.length === 0 && (
        <div className="card">
          <p>–ö–∞—Ç–∞–ª–æ–≥ –±–∞–Ω–∫–æ–≤ –ø—É—Å—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –±—ç–∫–µ–Ω–¥–∞.</p>
        </div>
      )}

      {banks.length > 0 && (
        <div className="card">
          {banks.map((bank, index) => (
            <div
              key={bank.id}
              style={{ padding: '12px 0', borderBottom: index === banks.length - 1 ? 'none' : '1px solid #eee' }}
            >
              <label style={{ display: 'flex', alignItems: 'center', gap: 12, cursor: 'pointer' }}>
                <input
                  type="checkbox"
                  checked={selectedBankIds.has(bank.id)}
                  onChange={() => handleToggleBank(bank.id)}
                  disabled={bank.connected}
                />
                <div>
                  <strong>{bank.name}</strong>
                  <p style={{ margin: 0, fontSize: 14, color: bank.connected ? '#16a34a' : '#475569' }}>
                    {bank.connected ? '–£–∂–µ –ø–æ–¥–∫–ª—é—á—ë–Ω' : '–ì–æ—Ç–æ–≤ –∫ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—é'}
                  </p>
                </div>
              </label>
            </div>
          ))}
        </div>
      )}

      <button className="btn" onClick={handleSubmit} disabled={selectedBankIds.size === 0 || isFetchingBanks}>
        –ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å
      </button>
    </div>
  );
};
</file>

<file path="hktn/src/pages/ConsentProcessPage.js">
import { jsx as _jsx, jsxs as _jsxs } from "react/jsx-runtime";
import { useCallback, useEffect, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { startConsent, startProductConsent, pollConsent } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';
const POLL_INTERVAL_MS = 3000;
export const ConsentProcessPage = () => {
    const { state } = useLocation();
    const navigate = useNavigate();
    const { userId } = useUser();
    const { notifyError, notifySuccess } = useNotifications();
    const [bankStates, setBankStates] = useState([]);
    const [currentIndex, setCurrentIndex] = useState(0);
    useEffect(() => {
        const selectedBanks = state?.selectedBanks;
        if (!selectedBanks || selectedBanks.length === 0) {
            navigate('/banks');
        }
        else {
            setBankStates(selectedBanks.map((bank) => ({
                ...bank,
                accountsStatus: 'idle',
                productsStatus: 'idle',
                activeStepData: {},
            })));
        }
    }, [state, navigate]);
    const updateBankStatus = (index, newState) => {
        setBankStates((prev) => prev.map((bank, i) => (i === index ? { ...bank, ...newState } : bank)));
    };
    const finishBank = useCallback(() => {
        setTimeout(() => setCurrentIndex((prev) => prev + 1), 1200);
    }, []);
    const requestConsent = useCallback(async (index, step) => {
        const bank = bankStates[index];
        if (!bank || !userId) {
            return;
        }
        const statusField = step === 'accounts' ? 'accountsStatus' : 'productsStatus';
        updateBankStatus(index, { [statusField]: 'connecting', errorMessage: undefined, activeStepData: {} });
        try {
            const apiCall = step === 'accounts' ? startConsent : startProductConsent;
            const response = await apiCall({ user_id: userId, bank_id: bank.id });
            if (response.state === 'error') {
                const message = response.error_message ?? '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ';
                notifyError(message);
                updateBankStatus(index, { [statusField]: 'error', errorMessage: message });
                return;
            }
            if (response.auto_approved || response.state === 'approved') {
                notifySuccess(`–î–æ—Å—Ç—É–ø –∫ ${step === 'accounts' ? '—Å—á–µ—Ç–∞–º/—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º' : '–ø—Ä–æ–¥—É–∫—Ç–∞–º'} –¥–ª—è ${bank.name} –ø–æ–ª—É—á–µ–Ω!`);
                updateBankStatus(index, { [statusField]: 'connected', activeStepData: {} });
                if (step === 'accounts') {
                    void requestConsent(index, 'products');
                }
                else {
                    finishBank();
                }
            }
            else {
                const pendingData = { approvalUrl: response.approval_url, requestId: response.request_id };
                updateBankStatus(index, {
                    [statusField]: 'pending_approval',
                    activeStepData: pendingData,
                });
            }
        }
        catch (error) {
            const message = error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
            notifyError(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ ${step === 'accounts' ? '—Å—á–µ—Ç–∞–º' : '–ø—Ä–æ–¥—É–∫—Ç–∞–º'} –¥–ª—è ${bank.name}`);
            updateBankStatus(index, { [statusField]: 'error', errorMessage: message });
        }
    }, [bankStates, finishBank, notifyError, notifySuccess, userId]);
    const handlePoll = useCallback(async (index, step, requestIdOverride) => {
        const bank = bankStates[index];
        const requestId = requestIdOverride ?? bank?.activeStepData?.requestId;
        if (!bank || !userId || !requestId)
            return;
        const statusField = step === 'accounts' ? 'accountsStatus' : 'productsStatus';
        updateBankStatus(index, { [statusField]: 'polling' });
        const poll = async () => {
            try {
                const payload = await pollConsent({ user_id: userId, bank_id: bank.id, request_id: requestId });
                if (payload.state === 'approved') {
                    notifySuccess(`–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ ${step === 'accounts' ? '—Å—á–µ—Ç–∞' : '–ø—Ä–æ–¥—É–∫—Ç—ã'} –æ—Ç ${bank.name} –ø–æ–ª—É—á–µ–Ω–æ!`);
                    updateBankStatus(index, { [statusField]: 'connected', activeStepData: {} });
                    if (step === 'accounts') {
                        void requestConsent(index, 'products');
                    }
                    else {
                        finishBank();
                    }
                    return true;
                }
                return false;
            }
            catch (error) {
                const message = error instanceof Error ? error.message : '–û—à–∏–±–∫–∞ –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞';
                notifyError(message);
                updateBankStatus(index, { [statusField]: 'error', errorMessage: message });
                return true;
            }
        };
        const intervalId = setInterval(async () => {
            if (await poll()) {
                clearInterval(intervalId);
            }
        }, POLL_INTERVAL_MS);
        if (await poll()) {
            clearInterval(intervalId);
        }
    }, [bankStates, finishBank, notifyError, notifySuccess, requestConsent, userId]);
    useEffect(() => {
        if (bankStates.length === 0) {
            return;
        }
        if (currentIndex < bankStates.length) {
            const bank = bankStates[currentIndex];
            if (bank.accountsStatus === 'idle') {
                void requestConsent(currentIndex, 'accounts');
            }
        }
    }, [bankStates, currentIndex, requestConsent]);
    useEffect(() => {
        bankStates.forEach((bank, index) => {
            if (bank.accountsStatus === 'pending_approval' &&
                !bank.activeStepData?.approvalUrl &&
                bank.activeStepData?.requestId) {
                void handlePoll(index, 'accounts', bank.activeStepData.requestId);
            }
            if (bank.accountsStatus === 'connected' &&
                bank.productsStatus === 'pending_approval' &&
                !bank.activeStepData?.approvalUrl &&
                bank.activeStepData?.requestId) {
                void handlePoll(index, 'products', bank.activeStepData.requestId);
            }
        });
    }, [bankStates, handlePoll]);
    const retryBank = (index) => {
        const bank = bankStates[index];
        if (!bank)
            return;
        if (bank.accountsStatus !== 'connected') {
            void requestConsent(index, 'accounts');
        }
        else {
            void requestConsent(index, 'products');
        }
    };
    const isFinished = bankStates.length > 0 && currentIndex >= bankStates.length;
    const renderStepStatus = (label, status, bank, step, index) => (_jsxs("div", { style: { padding: '8px 0', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }, children: [_jsx("span", { children: label }), status === 'idle' && _jsx("span", { style: { color: '#94a3b8' }, children: "\u041E\u0436\u0438\u0434\u0430\u043D\u0438\u0435\u2026" }), (status === 'connecting' || status === 'polling') && _jsx("span", { children: "\u0412 \u043F\u0440\u043E\u0446\u0435\u0441\u0441\u0435 \u23F3" }), status === 'connected' && _jsx("span", { style: { color: '#16a34a', fontWeight: 600 }, children: "\u2705 \u041F\u043E\u043B\u0443\u0447\u0435\u043D" }), status === 'error' && _jsx("span", { style: { color: '#dc2626', fontWeight: 600 }, children: "\u274C \u041E\u0448\u0438\u0431\u043A\u0430" }), status === 'pending_approval' &&
                (bank.activeStepData?.approvalUrl ? (_jsxs("div", { style: { display: 'flex', gap: 8 }, children: [_jsx("a", { className: "btn-secondary btn", href: bank.activeStepData.approvalUrl, target: "_blank", rel: "noreferrer", children: "\u041F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u0442\u044C \u0432 \u0431\u0430\u043D\u043A\u0435" }), _jsx("button", { className: "btn", onClick: () => handlePoll(index, step), children: "\u042F \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0434\u0438\u043B" })] })) : (_jsx("span", { children: "\u041E\u0436\u0438\u0434\u0430\u0435\u043C \u043F\u043E\u0434\u0442\u0432\u0435\u0440\u0436\u0434\u0435\u043D\u0438\u0435 \u043E\u0442 \u0431\u0430\u043D\u043A\u0430\u2026" })))] }));
    return (_jsxs("div", { className: "app-main", children: [_jsxs("div", { className: "card", children: [_jsx("h2", { children: "\u0428\u0430\u0433 3. \u041F\u043E\u0434\u043A\u043B\u044E\u0447\u0435\u043D\u0438\u0435 \u0431\u0430\u043D\u043A\u043E\u0432" }), _jsx("p", { children: "\u0414\u043B\u044F \u043A\u0430\u0436\u0434\u043E\u0433\u043E \u0431\u0430\u043D\u043A\u0430 \u043F\u043E\u043B\u0443\u0447\u0430\u0435\u043C \u0434\u043E\u0441\u0442\u0443\u043F \u043A \u0441\u0447\u0435\u0442\u0430\u043C \u0438 \u043E\u0442\u0434\u0435\u043B\u044C\u043D\u043E\u0435 \u0441\u043E\u0433\u043B\u0430\u0441\u0438\u0435 \u043D\u0430 \u0443\u043F\u0440\u0430\u0432\u043B\u0435\u043D\u0438\u0435 \u043F\u0440\u043E\u0434\u0443\u043A\u0442\u0430\u043C\u0438." })] }), bankStates.map((bank, index) => (_jsxs("div", { className: "card", style: { opacity: index === currentIndex ? 1 : 0.6 }, children: [_jsxs("h3", { children: [index + 1, ". ", bank.name] }), renderStepStatus('1. –î–æ—Å—Ç—É–ø –∫ —Å—á–µ—Ç–∞–º –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º', bank.accountsStatus, bank, 'accounts', index), bank.accountsStatus === 'connected' &&
                        renderStepStatus('2. –î–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–¥—É–∫—Ç–∞–º (–∫—Ä–µ–¥–∏—Ç—ã/–≤–∫–ª–∞–¥—ã/–∫–∞—Ä—Ç—ã)', bank.productsStatus, bank, 'products', index), (bank.accountsStatus === 'error' || bank.productsStatus === 'error') && (_jsx("button", { className: "btn-secondary btn", style: { marginTop: 12 }, onClick: () => retryBank(index), children: "\u041F\u043E\u0432\u0442\u043E\u0440\u0438\u0442\u044C" }))] }, bank.id))), isFinished && (_jsxs("div", { className: "card", children: [_jsx("h2", { children: "\u0412\u0441\u0435 \u0431\u0430\u043D\u043A\u0438 \u043E\u0431\u0440\u0430\u0431\u043E\u0442\u0430\u043D\u044B!" }), _jsx("p", { children: "\u0414\u043E\u0441\u0442\u0443\u043F\u044B \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u044B, \u043C\u043E\u0436\u043D\u043E \u043F\u0435\u0440\u0435\u0445\u043E\u0434\u0438\u0442\u044C \u043A \u0430\u043D\u0430\u043B\u0438\u0442\u0438\u043A\u0435." }), _jsx("button", { className: "btn", onClick: () => navigate('/dashboard'), children: "\u041F\u0435\u0440\u0435\u0439\u0442\u0438 \u043A \u0430\u043D\u0430\u043B\u0438\u0442\u0438\u043A\u0435" })] }))] }));
};
</file>

<file path="hktn/src/pages/ConsentProcessPage.tsx">
import React, { useCallback, useEffect, useState } from 'react';
import { useLocation, useNavigate } from 'react-router-dom';
import { startConsent, startProductConsent, pollConsent } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser, BankSummary } from '../state/useUser';

type ConsentStep = 'accounts' | 'products';
type StepStatus = 'idle' | 'connecting' | 'pending_approval' | 'polling' | 'connected' | 'error';

type BankState = BankSummary & {
  accountsStatus: StepStatus;
  productsStatus: StepStatus;
  errorMessage?: string;
  activeStepData?: {
    approvalUrl?: string;
    requestId?: string;
  };
};

const POLL_INTERVAL_MS = 3000;

export const ConsentProcessPage: React.FC = () => {
  const { state } = useLocation();
  const navigate = useNavigate();
  const { userId } = useUser();
  const { notifyError, notifySuccess } = useNotifications();

  const [bankStates, setBankStates] = useState<BankState[]>([]);
  const [currentIndex, setCurrentIndex] = useState(0);

  useEffect(() => {
    const selectedBanks = state?.selectedBanks as BankSummary[] | undefined;
    if (!selectedBanks || selectedBanks.length === 0) {
      navigate('/banks');
    } else {
      setBankStates(
        selectedBanks.map((bank) => ({
          ...bank,
          accountsStatus: 'idle',
          productsStatus: 'idle',
          activeStepData: {},
        }))
      );
    }
  }, [state, navigate]);

  const updateBankStatus = (index: number, newState: Partial<BankState>) => {
    setBankStates((prev) => prev.map((bank, i) => (i === index ? { ...bank, ...newState } : bank)));
  };

  const finishBank = useCallback(() => {
    setTimeout(() => setCurrentIndex((prev) => prev + 1), 1200);
  }, []);

  const requestConsent = useCallback(
    async (index: number, step: ConsentStep) => {
      const bank = bankStates[index];
      if (!bank || !userId) {
        return;
      }

      const statusField = step === 'accounts' ? 'accountsStatus' : 'productsStatus';
      updateBankStatus(index, { [statusField]: 'connecting', errorMessage: undefined, activeStepData: {} });

      try {
        const apiCall = step === 'accounts' ? startConsent : startProductConsent;
        const response = await apiCall({ user_id: userId, bank_id: bank.id });
        if (response.state === 'error') {
          const message = response.error_message ?? '–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∏—Ä–æ–≤–∞—Ç—å —Å–æ–≥–ª–∞—Å–∏–µ';
          notifyError(message);
          updateBankStatus(index, { [statusField]: 'error', errorMessage: message });
          return;
        }

        if (response.auto_approved || response.state === 'approved') {
          notifySuccess(
            `–î–æ—Å—Ç—É–ø –∫ ${step === 'accounts' ? '—Å—á–µ—Ç–∞–º/—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º' : '–ø—Ä–æ–¥—É–∫—Ç–∞–º'} –¥–ª—è ${bank.name} –ø–æ–ª—É—á–µ–Ω!`
          );
          updateBankStatus(index, { [statusField]: 'connected', activeStepData: {} });
          if (step === 'accounts') {
            void requestConsent(index, 'products');
          } else {
            finishBank();
          }
        } else {
          const pendingData = { approvalUrl: response.approval_url, requestId: response.request_id };
          updateBankStatus(index, {
            [statusField]: 'pending_approval',
            activeStepData: pendingData,
          });
        }
      } catch (error) {
        const message = error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞';
        notifyError(`–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ ${step === 'accounts' ? '—Å—á–µ—Ç–∞–º' : '–ø—Ä–æ–¥—É–∫—Ç–∞–º'} –¥–ª—è ${bank.name}`);
        updateBankStatus(index, { [statusField]: 'error', errorMessage: message });
      }
    },
    [bankStates, finishBank, notifyError, notifySuccess, userId]
  );

  const handlePoll = useCallback(
    async (index: number, step: ConsentStep, requestIdOverride?: string) => {
      const bank = bankStates[index];
      const requestId = requestIdOverride ?? bank?.activeStepData?.requestId;
      if (!bank || !userId || !requestId) return;

      const statusField = step === 'accounts' ? 'accountsStatus' : 'productsStatus';
      updateBankStatus(index, { [statusField]: 'polling' });

      const poll = async (): Promise<boolean> => {
        try {
          const payload = await pollConsent({ user_id: userId, bank_id: bank.id, request_id: requestId });
          if (payload.state === 'approved') {
            notifySuccess(`–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –Ω–∞ ${step === 'accounts' ? '—Å—á–µ—Ç–∞' : '–ø—Ä–æ–¥—É–∫—Ç—ã'} –æ—Ç ${bank.name} –ø–æ–ª—É—á–µ–Ω–æ!`);
            updateBankStatus(index, { [statusField]: 'connected', activeStepData: {} });
            if (step === 'accounts') {
              void requestConsent(index, 'products');
            } else {
              finishBank();
            }
            return true;
          }
          return false;
        } catch (error) {
          const message = error instanceof Error ? error.message : '–û—à–∏–±–∫–∞ –æ–ø—Ä–æ—Å–∞ —Å—Ç–∞—Ç—É—Å–∞';
          notifyError(message);
          updateBankStatus(index, { [statusField]: 'error', errorMessage: message });
          return true;
        }
      };

      const intervalId = setInterval(async () => {
        if (await poll()) {
          clearInterval(intervalId);
        }
      }, POLL_INTERVAL_MS);

      if (await poll()) {
        clearInterval(intervalId);
      }
    },
    [bankStates, finishBank, notifyError, notifySuccess, requestConsent, userId]
  );

  useEffect(() => {
    if (bankStates.length === 0) {
      return;
    }
    if (currentIndex < bankStates.length) {
      const bank = bankStates[currentIndex];
      if (bank.accountsStatus === 'idle') {
        void requestConsent(currentIndex, 'accounts');
      }
    }
  }, [bankStates, currentIndex, requestConsent]);

  useEffect(() => {
    bankStates.forEach((bank, index) => {
      if (
        bank.accountsStatus === 'pending_approval' &&
        !bank.activeStepData?.approvalUrl &&
        bank.activeStepData?.requestId
      ) {
        void handlePoll(index, 'accounts', bank.activeStepData.requestId);
      }
      if (
        bank.accountsStatus === 'connected' &&
        bank.productsStatus === 'pending_approval' &&
        !bank.activeStepData?.approvalUrl &&
        bank.activeStepData?.requestId
      ) {
        void handlePoll(index, 'products', bank.activeStepData.requestId);
      }
    });
  }, [bankStates, handlePoll]);

  const retryBank = (index: number) => {
    const bank = bankStates[index];
    if (!bank) return;
    if (bank.accountsStatus !== 'connected') {
      void requestConsent(index, 'accounts');
    } else {
      void requestConsent(index, 'products');
    }
  };

  const isFinished = bankStates.length > 0 && currentIndex >= bankStates.length;

  const renderStepStatus = (
    label: string,
    status: StepStatus,
    bank: BankState,
    step: ConsentStep,
    index: number
  ) => (
    <div style={{ padding: '8px 0', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
      <span>{label}</span>
      {status === 'idle' && <span style={{ color: '#94a3b8' }}>–û–∂–∏–¥–∞–Ω–∏–µ‚Ä¶</span>}
      {(status === 'connecting' || status === 'polling') && <span>–í –ø—Ä–æ—Ü–µ—Å—Å–µ ‚è≥</span>}
      {status === 'connected' && <span style={{ color: '#16a34a', fontWeight: 600 }}>‚úÖ –ü–æ–ª—É—á–µ–Ω</span>}
      {status === 'error' && <span style={{ color: '#dc2626', fontWeight: 600 }}>‚ùå –û—à–∏–±–∫–∞</span>}
      {status === 'pending_approval' &&
        (bank.activeStepData?.approvalUrl ? (
          <div style={{ display: 'flex', gap: 8 }}>
            <a className="btn-secondary btn" href={bank.activeStepData.approvalUrl} target="_blank" rel="noreferrer">
              –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –≤ –±–∞–Ω–∫–µ
            </a>
            <button className="btn" onClick={() => handlePoll(index, step)}>
              –Ø –ø–æ–¥—Ç–≤–µ—Ä–¥–∏–ª
            </button>
          </div>
        ) : (
          <span>–û–∂–∏–¥–∞–µ–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç –±–∞–Ω–∫–∞‚Ä¶</span>
        ))}
    </div>
  );

  return (
    <div className="app-main">
      <div className="card">
        <h2>–®–∞–≥ 3. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –±–∞–Ω–∫–æ–≤</h2>
        <p>–î–ª—è –∫–∞–∂–¥–æ–≥–æ –±–∞–Ω–∫–∞ –ø–æ–ª—É—á–∞–µ–º –¥–æ—Å—Ç—É–ø –∫ —Å—á–µ—Ç–∞–º –∏ –æ—Ç–¥–µ–ª—å–Ω–æ–µ —Å–æ–≥–ª–∞—Å–∏–µ –Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏.</p>
      </div>
      {bankStates.map((bank, index) => (
        <div className="card" key={bank.id} style={{ opacity: index === currentIndex ? 1 : 0.6 }}>
          <h3>
            {index + 1}. {bank.name}
          </h3>
          {renderStepStatus('1. –î–æ—Å—Ç—É–ø –∫ —Å—á–µ—Ç–∞–º –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è–º', bank.accountsStatus, bank, 'accounts', index)}
          {bank.accountsStatus === 'connected' &&
            renderStepStatus('2. –î–æ—Å—Ç—É–ø –∫ –ø—Ä–æ–¥—É–∫—Ç–∞–º (–∫—Ä–µ–¥–∏—Ç—ã/–≤–∫–ª–∞–¥—ã/–∫–∞—Ä—Ç—ã)', bank.productsStatus, bank, 'products', index)}
          {(bank.accountsStatus === 'error' || bank.productsStatus === 'error') && (
            <button className="btn-secondary btn" style={{ marginTop: 12 }} onClick={() => retryBank(index)}>
              –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
            </button>
          )}
        </div>
      ))}
      {isFinished && (
        <div className="card">
          <h2>–í—Å–µ –±–∞–Ω–∫–∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω—ã!</h2>
          <p>–î–æ—Å—Ç—É–ø—ã –ø–æ–ª—É—á–µ–Ω—ã, –º–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ.</p>
          <button className="btn" onClick={() => navigate('/dashboard')}>
            –ü–µ—Ä–µ–π—Ç–∏ –∫ –∞–Ω–∞–ª–∏—Ç–∏–∫–µ
          </button>
        </div>
      )}
    </div>
  );
};
</file>

<file path="hktn/src/pages/DashboardPage.tsx">
import React, { useEffect, useMemo, useState } from 'react';
import { getDashboard, getFinancialPortrait } from '../api/client';
import { useNotifications } from '../state/notifications';
import { useUser } from '../state/useUser';
import type { DashboardResponse, RecurringEvent, UpcomingPayment } from '../types/dashboard';

const currencyFormatter = new Intl.NumberFormat('ru-RU', {
  style: 'currency',
  currency: 'RUB',
  maximumFractionDigits: 0,
});

const formatCurrency = (value?: number | null) => {
  if (value === null || value === undefined || Number.isNaN(value)) {
    return '‚Äî';
  }
  return currencyFormatter.format(value);
};

const formatDate = (value?: string | null) => {
  if (!value) return '‚Äî';
  const parsed = new Date(value);
  if (Number.isNaN(parsed.getTime())) {
    return value;
  }
  return parsed.toLocaleDateString('ru-RU', {
    day: '2-digit',
    month: 'short',
  });
};

const SOURCE_COPY: Record<
  string,
  {
    label: string;
    tone: 'credit' | 'income' | 'debit' | 'neutral';
  }
> = {
  credit_agreement: { label: '–ö—Ä–µ–¥–∏—Ç', tone: 'credit' },
  recurring_debit: { label: '–†–µ–≥—É–ª—è—Ä–Ω—ã–π —Ä–∞—Å—Ö–æ–¥', tone: 'debit' },
  expense_event: { label: '–†–∞—Å—Ö–æ–¥ (AI)', tone: 'debit' },
  recurring_income: { label: '–†–µ–≥—É–ª—è—Ä–Ω—ã–π –¥–æ—Ö–æ–¥', tone: 'income' },
  income_event: { label: '–î–æ—Ö–æ–¥ (AI)', tone: 'income' },
};

const sanitizeSourceKey = (source: string) => source.replace(/[^a-z0-9]+/gi, '-').toLowerCase();

type MetadataProps = {
  mcc?: string | null;
  category?: string | null;
  merchantName?: string | null;
  bankTransactionCode?: string | null;
  source?: string | null;
  isIncome?: boolean;
};

const SourceChip: React.FC<{ source?: string | null }> = ({ source }) => {
  if (!source) return null;
  const descriptor = SOURCE_COPY[source] ?? { label: source.replace(/_/g, ' '), tone: 'neutral' };
  const chipClass = `chip chip--source chip--${descriptor.tone} chip--${sanitizeSourceKey(source)}`;
  return (
    <span className={chipClass} aria-label={`–ò—Å—Ç–æ—á–Ω–∏–∫: ${descriptor.label}`}>
      {descriptor.label}
    </span>
  );
};

const MetadataBadges: React.FC<MetadataProps> = ({ mcc, category, merchantName, bankTransactionCode, source, isIncome }) => {
  const merchantLabel = merchantName || (isIncome ? '–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞ –Ω–µ –æ–ø–æ–∑–Ω–∞–Ω' : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ—Ä–≥–æ–≤–µ—Ü');
  return (
    <div className="metadata-badges" aria-label="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∞—Ç—Ä–∏–±—É—Ç—ã —Å–æ–±—ã—Ç–∏—è">
      <span className="metadata-badge metadata-badge--merchant" title={merchantLabel}>
        {merchantLabel}
      </span>
      <span className="metadata-badge metadata-badge--mcc" title={`MCC ${mcc || '‚Äî'}`}>
        {`MCC ${mcc || '‚Äî'}${category ? ` ‚Ä¢ ${category}` : ''}`}
      </span>
      {bankTransactionCode ? (
        <span
          className="metadata-badge metadata-badge--code"
          title={`–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –∫–æ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${bankTransactionCode}`}
          aria-label={bankTransactionCode}
        >
          {bankTransactionCode}
        </span>
      ) : (
        <span className="metadata-badge metadata-badge--muted" aria-label="–ö–æ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç">
          –ù–µ—Ç –∫–æ–¥–∞
        </span>
      )}
      <SourceChip source={source} />
    </div>
  );
};

const RecurringEventRow: React.FC<{ event: RecurringEvent }> = ({ event }) => (
  <li className={`event-row ${event.is_income ? 'event-row--income' : 'event-row--expense'}`}>
    <div className="event-row__header">
      <div>
        <p
          className="event-row__title"
          title={event.bank_transaction_code ? `–ö–æ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${event.bank_transaction_code}` : undefined}
        >
          {event.name ?? '–ü–æ–≤—Ç–æ—Ä—è—é—â–µ–µ—Å—è —Å–æ–±—ã—Ç–∏–µ'}
        </p>
        <p className="event-row__subtitle">
          {event.merchant_name || (event.is_income ? '–ò—Å—Ç–æ—á–Ω–∏–∫ –¥–æ—Ö–æ–¥–∞ –Ω–µ–∏–∑–≤–µ—Å—Ç–µ–Ω' : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ—Ä–≥–æ–≤–µ—Ü')}
          {event.frequency_days ? ` ‚Ä¢ –∫–∞–∂–¥—ã–µ ~${event.frequency_days} –¥.` : null}
        </p>
      </div>
      <div className="event-row__amount" aria-label="–†–∞–∑–º–µ—Ä —Å–æ–±—ã—Ç–∏—è">
        <span>{formatCurrency(event.amount)}</span>
        <small>
          {event.is_income ? '–°–ª–µ–¥—É—é—â–∏–π –¥–æ—Ö–æ–¥' : '–°–ª–µ–¥—É—é—â–∏–π –ø–ª–∞—Ç—ë–∂'}: {formatDate(event.next_date)}
        </small>
      </div>
    </div>
    <MetadataBadges
      mcc={event.mcc_code}
      category={event.category}
      merchantName={event.merchant_name}
      bankTransactionCode={event.bank_transaction_code}
      source={event.source}
      isIncome={event.is_income}
    />
  </li>
);

const UpcomingPaymentRow: React.FC<{ payment: UpcomingPayment }> = ({ payment }) => {
  const derived = payment.source && payment.source !== 'credit_agreement';
  const amount = typeof payment.amount === 'number' ? Math.abs(payment.amount) : null;
  return (
    <li className={`event-row obligation-row ${derived ? 'obligation-row--derived' : ''}`}>
      <div className="event-row__header">
        <div>
          <p
            className="event-row__title"
            title={payment.bank_transaction_code ? `–ö–æ–¥ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏: ${payment.bank_transaction_code}` : undefined}
          >
            {payment.name || '–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π –ø–ª–∞—Ç—ë–∂'}
          </p>
          <p className="event-row__subtitle">–°—Ä–æ–∫: {formatDate(payment.due_date)}</p>
        </div>
        <div className="event-row__amount">
          <span>{formatCurrency(amount)}</span>
          <small>–ò—Å—Ç–æ—á–Ω–∏–∫: {payment.source ? SOURCE_COPY[payment.source]?.label || payment.source : '‚Äî'}</small>
        </div>
      </div>
      {derived ? <span className="chip chip--derived">AI-–æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–æ</span> : null}
      <MetadataBadges
        mcc={payment.mcc_code}
        category={payment.category}
        merchantName={payment.merchant_name}
        bankTransactionCode={payment.bank_transaction_code}
        source={payment.source}
      />
    </li>
  );
};

type PortraitData = {
  recurring_events?: RecurringEvent[];
  transactions_sample?: Array<Record<string, any>>;
};

type DashboardPageProps = {
  initialData?: DashboardResponse | null;
};

export const DashboardPage: React.FC<DashboardPageProps> = ({ initialData = null }) => {
  const { userId } = useUser();
  const { notifyError } = useNotifications();
  const [data, setData] = useState<DashboardResponse | null>(initialData);
  const [loading, setLoading] = useState(false);
  const [portraitOpen, setPortraitOpen] = useState(false);
  const [portraitLoading, setPortraitLoading] = useState(false);
  const [portrait, setPortrait] = useState<PortraitData | null>(null);
  const [sourceFilter, setSourceFilter] = useState<string>('all');
  const [mccFilter, setMccFilter] = useState<string>('all');
  const [sortMode, setSortMode] = useState<'due_date' | 'amount'>('due_date');

  useEffect(() => {
    if (!userId || initialData) {
      return;
    }
    const load = async () => {
      try {
        setLoading(true);
        const payload = await getDashboard(userId);
        setData(payload);
      } catch (error) {
        console.error(error);
        notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É');
      } finally {
        setLoading(false);
      }
    };
    load();
  }, [notifyError, userId, initialData]);

  useEffect(() => {
    if (!portraitOpen || portrait || !userId) {
      return;
    }
    const load = async () => {
      try {
        setPortraitLoading(true);
        const payload = await getFinancialPortrait({ user_id: userId });
        setPortrait(payload);
      } catch (error) {
        console.error(error);
        notifyError('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–π –ø–æ—Ä—Ç—Ä–µ—Ç');
      } finally {
        setPortraitLoading(false);
      }
    };
    load();
  }, [portraitOpen, portrait, userId, notifyError]);

  const upcomingPayments = useMemo(() => {
    const parsed = [...(data?.upcoming_payments ?? [])];
    return parsed
      .map((item) => ({
        ...item,
        due_date: item.due_date ?? (item as Record<string, any>).date ?? '',
      }))
      .sort((a, b) => {
        const aTime = a.due_date ? new Date(a.due_date).getTime() : Number.POSITIVE_INFINITY;
        const bTime = b.due_date ? new Date(b.due_date).getTime() : Number.POSITIVE_INFINITY;
        return aTime - bTime;
      });
  }, [data]);

  const recurringEvents = data?.recurring_events ?? [];
  const uniqueSources = useMemo(() => {
    const values = new Set<string>();
    upcomingPayments.forEach((item) => {
      if (item.source) values.add(item.source);
    });
    return Array.from(values);
  }, [upcomingPayments]);

  const uniqueMccCodes = useMemo(() => {
    const values = new Set<string>();
    upcomingPayments.forEach((item) => {
      if (item.mcc_code) values.add(item.mcc_code);
    });
    return Array.from(values);
  }, [upcomingPayments]);

  const filteredPayments = useMemo(() => {
    const filtered = upcomingPayments.filter((item) => {
      if (sourceFilter !== 'all' && (item.source || 'none') !== sourceFilter) {
        return false;
      }
      if (mccFilter !== 'all' && (item.mcc_code || 'none') !== mccFilter) {
        return false;
      }
      return true;
    });
    if (sortMode === 'amount') {
      return [...filtered].sort((a, b) => {
        const aAmount = typeof a.amount === 'number' ? a.amount : 0;
        const bAmount = typeof b.amount === 'number' ? b.amount : 0;
        return bAmount - aAmount;
      });
    }
    return filtered;
  }, [upcomingPayments, sourceFilter, mccFilter, sortMode]);

  const safeToSpend = data?.safe_to_spend ?? null;
  const safeToSpendDaily = data?.safe_to_spend_daily ?? (safeToSpend ? Math.max(0, Math.round(safeToSpend / 30)) : null);
  const currentBalance = data?.current_balance ?? 0;
  const topObligations = upcomingPayments.slice(0, 3);
  const obligationsTotal = upcomingPayments.reduce(
    (acc, item) => acc + (typeof item.amount === 'number' ? item.amount : 0),
    0
  );
  const recommendedPaymentDate = data?.analysis?.payment_date;
  const recommendationDateLabel = recommendedPaymentDate ? formatDate(String(recommendedPaymentDate)) : '‚Äî';
  const recommendedPaymentAmount = data?.analysis?.payment_amount;
  const portraitEvents = portrait?.recurring_events ?? recurringEvents;
  const portraitTransactions = portrait?.transactions_sample ?? [];
  const mccCoverage = portraitEvents.length
    ? Math.round((portraitEvents.filter((event) => Boolean(event.mcc_code)).length / portraitEvents.length) * 100)
    : 0;
  const merchantClusters = useMemo(() => {
    const map = new Map<string, number>();
    portraitEvents.forEach((event) => {
      if (!event.merchant_name) return;
      const key = event.merchant_name.toLowerCase();
      map.set(key, (map.get(key) ?? 0) + 1);
    });
    return Array.from(map.entries())
      .map(([key, count]) => ({ name: key, count }))
      .sort((a, b) => b.count - a.count);
  }, [portraitEvents]);

  const renderTransactionsForEvent = (event: RecurringEvent) => {
    const matches = portraitTransactions.filter((tx: Record<string, any>) => {
      const txMerchant = tx.merchant?.name || tx.description;
      const txMcc = tx.mccCode || tx.merchant?.mccCode;
      const merchantMatch =
        !!event.merchant_name &&
        !!txMerchant &&
        txMerchant.toLowerCase().includes(event.merchant_name.toLowerCase());
      const mccMatch = !!event.mcc_code && !!txMcc && event.mcc_code === txMcc;
      return merchantMatch || mccMatch;
    });
    if (!matches.length) {
      return <p className="muted">–ù–µ –Ω–∞—à–ª–∏ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –¥–ª—è —ç—Ç–æ–π –º–µ—Ç–∫–∏.</p>;
    }
    return (
      <ul className="metadata-transactions">
        {matches.slice(0, 4).map((tx) => (
          <li key={tx.transactionId}>
            <strong>{formatCurrency(tx.amount)}</strong>
            <span>{tx.bookingDate ? formatDate(tx.bookingDate) : '‚Äî'}</span>
            <span>{tx.merchant?.name || tx.description || '‚Äî'}</span>
          </li>
        ))}
      </ul>
    );
  };

  if (loading) {
    return (
      <div className="app-main">
        <div className="card">–ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏...</div>
      </div>
    );
  }

  if (!data) {
    return (
      <div className="app-main">
        <div className="card">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–π–¥–∏—Ç–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥.</div>
      </div>
    );
  }

  return (
    <div className="app-main">
      <div className="card safe-card">
        <div className="card-header">
          <h2>Safe-to-Spend</h2>
          <span className="chip chip--balance" aria-label="–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å">
            –ë–∞–ª–∞–Ω—Å: {formatCurrency(currentBalance)}
          </span>
        </div>
        <p className="muted">
          –û—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ {formatCurrency(currentBalance)} –∏ {topObligations.length || '‚Äî'} –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞—Ö FinPulse AI.
        </p>
        <div className="safe-grid">
          <div>
            <p className="muted">–ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –ª–∏–º–∏—Ç</p>
            <strong className="metric">{safeToSpendDaily ? `${formatCurrency(safeToSpendDaily)} / –¥–µ–Ω—å` : '–ù–µ—Ç –æ—Ü–µ–Ω–∫–∏'}</strong>
          </div>
          <div>
            <p className="muted">–ì–æ—Ä–∏–∑–æ–Ω—Ç (30 –¥–Ω.)</p>
            <strong className="metric">{safeToSpend ? formatCurrency(safeToSpend) : '–ù–µ—Ç –æ—Ü–µ–Ω–∫–∏'}</strong>
          </div>
          <div>
            <p className="muted">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∏–∂–µ–Ω–∏—è —Ü–µ–ª–∏</p>
            <strong className="metric">{data.goal_probability ?? data.analysis?.success_probability_percent ?? 0}%</strong>
          </div>
        </div>
        {recommendedPaymentAmount ? (
          <div className="safe-recommendation">
            <span>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è: </span>
            <strong>
              {formatCurrency(recommendedPaymentAmount)} –¥–æ {recommendationDateLabel}
            </strong>
            <span className="muted">{data.analysis?.recommendation}</span>
          </div>
        ) : null}
        <div className="safe-obligations">
          <p className="muted">–û—Å–Ω–æ–≤–Ω—ã–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤–∞ –≤ —Ä–∞—Å—á—ë—Ç–µ:</p>
          <div className="metadata-badges">
            {topObligations.length ? (
              topObligations.map((item) => (
                <span key={`${item.name}-${item.due_date}`} className="metadata-badge metadata-badge--obligation">
                  {item.name}: {formatCurrency(typeof item.amount === 'number' ? item.amount : null)} –¥–æ {formatDate(item.due_date)}
                </span>
              ))
            ) : (
              <span className="metadata-badge metadata-badge--muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤</span>
            )}
          </div>
          <p className="muted">
            –í—Å–µ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ ‚âà {formatCurrency(obligationsTotal)} –Ω–∞ –≥–æ—Ä–∏–∑–æ–Ω—Ç–µ Safe-to-Spend.
          </p>
        </div>
      </div>

      <div className="card">
        <div className="card-header">
          <h3>–ü—Ä–µ–¥—Å—Ç–æ—è—â–∏–µ –ø–ª–∞—Ç–µ–∂–∏</h3>
          <div className="filter-row">
            <label>
              –ò—Å—Ç–æ—á–Ω–∏–∫
              <select value={sourceFilter} onChange={(event) => setSourceFilter(event.target.value)}>
                <option value="all">–í—Å–µ</option>
                {uniqueSources.map((source) => (
                  <option key={source} value={source}>
                    {SOURCE_COPY[source]?.label || source}
                  </option>
                ))}
              </select>
            </label>
            <label>
              MCC
              <select value={mccFilter} onChange={(event) => setMccFilter(event.target.value)}>
                <option value="all">–í—Å–µ</option>
                {uniqueMccCodes.map((mcc) => (
                  <option key={mcc} value={mcc}>
                    {mcc}
                  </option>
                ))}
              </select>
            </label>
            <label>
              –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
              <select value={sortMode} onChange={(event) => setSortMode(event.target.value as 'due_date' | 'amount')}>
                <option value="due_date">–ü–æ –¥–∞—Ç–µ</option>
                <option value="amount">–ü–æ —Å—É–º–º–µ</option>
              </select>
            </label>
          </div>
        </div>
        <ul className="list list--dense">
          {filteredPayments.length ? (
            filteredPayments.map((payment) => <UpcomingPaymentRow key={`${payment.name}-${payment.due_date}`} payment={payment} />)
          ) : (
            <li className="muted">–ù–µ—Ç –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–º —Ñ–∏–ª—å—Ç—Ä–∞–º.</li>
          )}
        </ul>
      </div>

      <div className="card">
        <div className="card-header">
          <h3>–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–æ–±—ã—Ç–∏—è</h3>
          <span className="chip chip--neutral">{recurringEvents.length} –ø–æ—Ç–æ–∫(–æ–≤)</span>
        </div>
        <ul className="list list--dense">
          {recurringEvents.length ? (
            recurringEvents.map((event) => <RecurringEventRow key={`${event.name}-${event.next_date}`} event={event} />)
          ) : (
            <li className="muted">–ù–µ—Ç –æ–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã—Ö –ø–æ–≤—Ç–æ—Ä—è—é—â–∏—Ö—Å—è —Å–æ–±—ã—Ç–∏–π.</li>
          )}
        </ul>
      </div>

      <div className="card">
        <div className="card-header">
          <h3>–ö—Ä–µ–¥–∏—Ç—ã</h3>
          <span className="chip chip--credit">{(data.credit_rankings ?? []).length} –∞–∫—Ç–∏–≤–Ω—ã—Ö</span>
        </div>
        <ul className="list list--dense">
          {(data.credit_rankings ?? []).length ? (
            (data.credit_rankings ?? []).map((credit) => (
              <li key={credit.name} className="credit-row">
                <div>
                  <strong>{credit.name}</strong>
                  <p className="muted">Stress {credit.stress_score ?? '‚Äî'}</p>
                </div>
                <div className="credit-row__metrics">
                  <span>–î–æ–ª–≥: {formatCurrency(credit.balance)}</span>
                  <span>–ü–ª–∞—Ç—ë–∂: {formatCurrency(credit.min_payment)}</span>
                </div>
              </li>
            ))
          ) : (
            <li className="muted">–ù–µ—Ç –∫—Ä–µ–¥–∏—Ç–Ω—ã—Ö –ø—Ä–æ–¥—É–∫—Ç–æ–≤.</li>
          )}
        </ul>
      </div>

      <div className="card portrait-card">
        <div className="card-header">
          <h3>–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ø–æ—Ä—Ç—Ä–µ—Ç</h3>
          <button className="btn btn-secondary" onClick={() => setPortraitOpen((prev) => !prev)}>
            {portraitOpen ? '–°–∫—Ä—ã—Ç—å –¥–µ—Ç–∞–ª–∏' : '–ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏'}
          </button>
        </div>
        <p className="muted">
          –î–µ—Ç–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–≤–æ–¥–∫–∞ MCC, —Ç–æ—Ä–≥–æ–≤—Ü–µ–≤ –∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π, –ª–µ–∂–∞—â–∏—Ö –≤ –æ—Å–Ω–æ–≤–µ –ø–æ—Ä—Ç—Ä–µ—Ç–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ—ë –¥–ª—è —Ä—É—á–Ω–æ–π
          –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞.
        </p>
        <div className="portrait-summary">
          <span className="metadata-badge metadata-badge--mcc" title="–î–æ–ª—è —Å–æ–±—ã—Ç–∏–π —Å MCC">
            MCC –ø–æ–∫—Ä—ã—Ç–∏–µ: {mccCoverage}% —Å–æ–±—ã—Ç–∏–π
          </span>
          <span className="metadata-badge metadata-badge--merchant">–ö–ª–∞—Å—Ç–µ—Ä–æ–≤ —Ç–æ—Ä–≥–æ–≤—Ü–µ–≤: {merchantClusters.length}</span>
        </div>
        {portraitOpen ? (
          <div className="portrait-details">
            {portraitLoading && <p>–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Ä—Ç—Ä–µ—Ç–∞...</p>}
            {!portraitLoading && !portrait && <p>–ù–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö ‚Äî –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–∑–∂–µ.</p>}
            {!portraitLoading && portrait ? (
              <details open className="portrait-panel">
                <summary>–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–µ—Å—è —Å–æ–±—ã—Ç–∏—è ({portraitEvents.length})</summary>
                <ul className="list list--dense">
                  {portraitEvents.map((event) => (
                    <li key={`${event.name}-${event.next_date}`} className="portrait-event">
                      <div className="portrait-event__header">
                        <div>
                          <strong>{event.name}</strong>
                          <p className="muted">
                            {event.merchant_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–æ—Ä–≥–æ–≤–µ—Ü'} ‚Ä¢ {event.mcc_code || 'MCC ‚Äî'}
                          </p>
                        </div>
                        <span>{event.is_income ? '–î–æ—Ö–æ–¥' : '–†–∞—Å—Ö–æ–¥'}</span>
                      </div>
                      <MetadataBadges
                        mcc={event.mcc_code}
                        category={event.category}
                        merchantName={event.merchant_name}
                        bankTransactionCode={event.bank_transaction_code}
                        source={event.source}
                        isIncome={event.is_income}
                      />
                      <details>
                        <summary>–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏-–∫–∞–Ω–¥–∏–¥–∞—Ç—ã</summary>
                        {renderTransactionsForEvent(event)}
                      </details>
                    </li>
                  ))}
                </ul>
              </details>
            ) : null}
          </div>
        ) : null}
      </div>
    </div>
  );
};
</file>

<file path="hktn/src/App.tsx">
import React from 'react';
import { Navigate, Outlet, Route, Routes, useLocation, useNavigate } from 'react-router-dom';
import { useNotifications } from './state/notifications';
import { useUser } from './state/useUser';
import { BanksCatalogPage } from './pages/BanksCatalogPage';
import { CallbackPage } from './pages/CallbackPage';
import { ConsentStatusPage } from './pages/ConsentStatusPage';
import { DashboardPage } from './pages/DashboardPage';
import { DebtGoalPage } from './pages/DebtGoalPage';
import { GoalsLandingPage } from './pages/GoalsLandingPage';
import { IngestionPage } from './pages/IngestionPage';
import { SaveGoalPage } from './pages/SaveGoalPage';
import { UserIdPage } from './pages/UserIdPage';
import { ConsentProcessPage } from './pages/ConsentProcessPage';

const ProtectedRoute: React.FC = () => {
  const { userId } = useUser();
  const location = useLocation();
  if (!userId) {
    return <Navigate to="/" replace state={{ from: location }} />;
  }
  return <Outlet />;
};

class AppErrorBoundary extends React.Component<React.PropsWithChildren, { hasError: boolean; message?: string }> {
  constructor(props: React.PropsWithChildren) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error) {
    return { hasError: true, message: error.message };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('App crashed', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return (
        <div className="app-main">
          <div className="card">
            <h2>–ß—Ç–æ-—Ç–æ –ø–æ—à–ª–æ –Ω–µ —Ç–∞–∫</h2>
            <p>{this.state.message}</p>
            <button className="btn" onClick={() => this.setState({ hasError: false })}>
              –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
            </button>
          </div>
        </div>
      );
    }
    return this.props.children;
  }
}

const Header: React.FC = () => {
  const { userId, clearUser } = useUser();
  const navigate = useNavigate();
  const { notify } = useNotifications();

  return (
    <header style={{ padding: '16px 24px', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
      <div>
        <strong>FinPulse MPA</strong>
        {userId ? <span style={{ marginLeft: 12, color: '#475569' }}>User: {userId}</span> : null}
      </div>
      <div style={{ display: 'flex', gap: 12 }}>
        <button className="btn-secondary btn" onClick={() => navigate('/dashboard')}>
          –î–∞—à–±–æ—Ä–¥
        </button>
        {userId ? (
          <button
            className="btn-secondary btn"
            onClick={() => {
              clearUser();
              notify('–°–µ—Å—Å–∏—è –æ—á–∏—â–µ–Ω–∞');
              navigate('/');
            }}
          >
            –°–±—Ä–æ—Å–∏—Ç—å
          </button>
        ) : null}
      </div>
    </header>
  );
};

export const App: React.FC = () => (
  <AppErrorBoundary>
    <div className="app-shell">
      <Header />
      <Routes>
        <Route path="/" element={<UserIdPage />} />
        <Route element={<ProtectedRoute />}>
          <Route path="/banks" element={<BanksCatalogPage />} />
          <Route path="/banks/:bankId/status" element={<ConsentStatusPage />} />
          <Route path="/onboarding/consent" element={<ConsentProcessPage />} />
          <Route path="/goals" element={<GoalsLandingPage />} />
          <Route path="/goals/save" element={<SaveGoalPage />} />
          <Route path="/goals/debts" element={<DebtGoalPage />} />
          <Route path="/ingest" element={<IngestionPage />} />
          <Route path="/dashboard" element={<DashboardPage />} />
        </Route>
        <Route path="/callback" element={<CallbackPage />} />
        <Route path="*" element={<Navigate to="/" replace />} />
      </Routes>
    </div>
  </AppErrorBoundary>
);

export default App;
</file>

<file path="hktn/README.md">
# Main screens

  This is a code bundle for Main screens. The original project is available at https://www.figma.com/design/g2lq6y3UolIAHaAuvnYRaz/Main-screens.

  ## Running the code

  Run `npm i` to install the dependencies.

  Run `npm run dev` to start the development server.

  ## Analytics flow updates

  - Bank transactions now retain merchant, MCC, bank transaction code, and card metadata so the clustering engine can reason about actual merchants instead of generic descriptions.
  - The analytics engine derives deterministic obligations from both credit agreements and highly coherent recurring debit clusters (tagged with their MCC/category/source), which flow into `/api/dashboard` and `/api/financial-portrait`.
  - Safe-to-spend calculations now use real-time balances summed from linked accounts, so probability estimates and explanations reflect actual cash instead of placeholder values.
  - Dashboard UI consumes the enriched payload and surfaces badges for MCC/category, merchant, transaction codes and obligation sources. Upcoming-payment filters allow PMs to slice by source or MCC to verify data quality quickly.
  - The ‚ÄúFinancial Portrait‚Äù inspector lazy-loads the `/api/financial-portrait` response, links recurring events back to `transactions_sample`, and displays MCC coverage percentages so onboarding engineers can confirm clustering quality without leaving the UI.
  - Design tokens (`--color-chip-*`, `--space-*`, etc.) were added to `src/styles/global.css` to keep badges/chips responsive. Metadata stacks collapse vertically under 640px widths, so screenshots captured via `npm run dev` ‚Üí `localhost:5173/dashboard` at 360px and 1440px widths remain legible.

  ## Testing & QA

  - Run `npm run test -- DashboardPage` to execute the new vitest suite at `src/pages/__tests__/DashboardPage.test.tsx`, which covers metadata rendering, filter behavior, and the lazy portrait fetch contract.
  - Accessibility: All metadata badges expose ARIA labels/tooltips (e.g., `SourceChip`, bank transaction code titles). When adding new badges, reuse the `.metadata-badge` classes to inherit focus contrast.
  - Localization: strings for badges/tooltips live inside `DashboardPage.tsx`. To localize, extract them into a shared dictionary and update the tests accordingly.
  - Screenshot/regression coverage: capture updated dashboard states after major API changes and drop PNGs into `docs/main_screens`. Mention which dataset (e.g., `data/260-1_account.json`) produced the snapshot so analysts can reproduce it.
</file>

<file path="hktn/vite.config.ts">
/// <reference types="vitest" />
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';

// –Ø —É–±—Ä–∞–ª root: 'src', –∫–∞–∫ –º—ã –∏ –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞–ª–∏—Å—å
export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
  },
  test: { // –¢–µ–ø–µ—Ä—å —ç—Ç–∞ —Å–µ–∫—Ü–∏—è –≤–∞–ª–∏–¥–Ω–∞!
    globals: true,
    environment: 'jsdom',
    setupFiles: './src/test/setup.ts',
  },
});
</file>

<file path="hktn/backend/services/analytics.py">
from __future__ import annotations

import asyncio
import logging
from datetime import date, timedelta
from typing import Any, Dict, List, Sequence

from fastapi import HTTPException, status

from hktn.core.analytics_engine import (
    build_financial_portrait,
    calculate_safe_to_spend,
    derive_obligations,
    estimate_goal_probability,
    extract_recurring_events,
    rank_credits,
    run_analysis_with_details,
    _extract_account_balance,
)
from hktn.core.data_models import Transaction
from hktn.core.database import (
    find_approved_consents,
    get_product_consents_for_user,
    get_recent_bank_status_logs,
    get_user_goal,
    StoredConsent,
)

from ..schemas import AnalysisRequest, FinancialPortraitRequest, IngestRequest
from .banking import fetch_bank_accounts_with_consent, fetch_bank_credits, fetch_bank_data_with_consent
from .goals import compose_user_goal
from .products import apply_consent_flags, build_account_product, build_credit_product, group_products_by_bank

logger = logging.getLogger("finpulse.backend.analytics")


def _require_consents(user_id: str) -> Sequence[StoredConsent]:
    approved_consents = find_approved_consents(user_id, consent_type="accounts")
    if not approved_consents:
        raise HTTPException(
            status_code=status.HTTP_424_FAILED_DEPENDENCY,
            detail="No approved consents found.",
        )
    return approved_consents


async def get_user_credits(user_id: str) -> Dict[str, Any]:
    approved_consents = _require_consents(user_id)
    tasks = [
        fetch_bank_credits(consent.bank_id, consent.consent_id, user_id, create_product_consent=True)
        for consent in approved_consents
    ]
    bank_results = await asyncio.gather(*tasks)

    all_credits: List[Dict[str, Any]] = []
    bank_statuses: List[Dict[str, str]] = []
    for res in bank_results:
        bank_statuses.append({"bank_name": res["bank_id"], "status": res["status"], "message": res["message"]})
        if res["status"] == "ok":
            all_credits.extend(res["credits"])

    ranked = rank_credits(all_credits)
    return {"credits": all_credits, "credit_rankings": ranked, "bank_statuses": bank_statuses}


async def get_dashboard_metrics(user_id: str) -> Dict[str, Any]:
    approved_consents = _require_consents(user_id)

    stored_goal = get_user_goal(user_id)
    user_goal = compose_user_goal(stored_goal)

    tx_tasks = [
        fetch_bank_data_with_consent(consent.bank_id, consent.consent_id, user_id)
        for consent in approved_consents
    ]
    credit_tasks = [
        fetch_bank_credits(consent.bank_id, consent.consent_id, user_id)
        for consent in approved_consents
    ]
    account_tasks = [
        fetch_bank_accounts_with_consent(consent.bank_id, consent.consent_id, user_id)
        for consent in approved_consents
    ]

    tx_results, credit_results, account_results = await asyncio.gather(
        asyncio.gather(*tx_tasks),
        asyncio.gather(*credit_tasks),
        asyncio.gather(*account_tasks),
    )

    all_transactions: List[Transaction] = []
    all_credits: List[Dict[str, Any]] = []
    all_accounts: List[Dict[str, Any]] = []
    bank_statuses: Dict[str, Dict[str, str]] = {}

    for res in tx_results:
        bank_statuses[res["bank_id"]] = {
            "bank_name": res["bank_id"],
            "status": res["status"],
            "message": res["message"],
        }
        if res["status"] == "ok":
            all_transactions.extend(res["transactions"])

    for res in credit_results:
        entry = bank_statuses.setdefault(
            res["bank_id"],
            {"bank_name": res["bank_id"], "status": res["status"], "message": res["message"]},
        )
        if res["status"] == "ok":
            all_credits.extend(res["credits"])
        else:
            if entry["status"] == "ok":
                entry["status"] = "partial_error"
            entry["message"] += f"; credits failed: {res['message']}"

    for res in account_results:
        entry = bank_statuses.setdefault(
            res["bank_id"],
            {"bank_name": res["bank_id"], "status": res["status"], "message": res["message"]},
        )
        if res["status"] == "ok":
            all_accounts.extend(res.get("accounts") or [])
        else:
            if entry["status"] == "ok":
                entry["status"] = "partial_error"
            suffix = f"accounts failed: {res['message']}"
            entry["message"] = f"{entry.get('message', '')}; {suffix}" if entry.get("message") else suffix

    if not all_transactions:
        raise HTTPException(
            status_code=status.HTTP_424_FAILED_DEPENDENCY,
            detail="Could not fetch any transactions.",
        )

    current_balance = sum(_extract_account_balance(account) for account in all_accounts)

    (
        analysis_result,
        trajectories,
        forecast_dates,
        noise_profile,
        event_profiles,
    ) = run_analysis_with_details(
        all_transactions,
        current_balance,
        date.today() + timedelta(days=30),
        0,
    )

    obligations = derive_obligations(all_credits, event_profiles)
    safe_to_spend = calculate_safe_to_spend(obligations, trajectories, forecast_dates)
    goal_probability = estimate_goal_probability(user_goal, trajectories, forecast_dates, obligations, event_profiles)
    recurring_events = extract_recurring_events(event_profiles)

    total_debt = sum(float(credit.get("balance", 0) or 0) for credit in all_credits)
    monthly_income = sum(float(event.get("mu_amount", 0) or 0) for event in event_profiles if event.get("is_income"))
    monthly_payments = sum(float(obligation.get("amount") or 0.0) for obligation in obligations)
    health_score = 0
    if monthly_income > 0:
        debt_to_income_ratio = monthly_payments / monthly_income if monthly_income else 0
        health_score = max(0, int((1 - debt_to_income_ratio * 2) * 100))

    upcoming_payloads: List[Dict[str, Any]] = []
    for obligation in obligations:
        due_date = obligation.get("due_date")
        if not isinstance(due_date, date):
            continue
        payload = {
            "name": obligation.get("label") or "Payment",
            "amount": obligation.get("amount"),
            "due_date": due_date,
            "source": obligation.get("source"),
            "mcc_code": obligation.get("mcc_code"),
            "category": obligation.get("category"),
            "merchant_name": obligation.get("merchant_name"),
            "bank_transaction_code": obligation.get("bank_transaction_code"),
            "frequency_days": obligation.get("frequency_days"),
        }
        upcoming_payloads.append(payload)

    upcoming_payloads.sort(key=lambda item: item["due_date"])
    upcoming_payments = [
        {**payload, "due_date": payload["due_date"].isoformat()} for payload in upcoming_payloads[:5]
    ]

    return {
        "analysis": analysis_result.dict(),
        "safe_to_spend": safe_to_spend,
        "goal_probability": goal_probability,
        "bank_statuses": bank_statuses,
        "recurring_events": recurring_events,
        "total_debt": total_debt,
        "monthly_income": monthly_income,
        "monthly_payments": monthly_payments,
        "health_score": health_score,
        "upcoming_payments": upcoming_payments,
        "current_balance": round(current_balance, 2),
    }


async def build_financial_portrait_view(req: FinancialPortraitRequest) -> Dict[str, Any]:
    approved_consents = _require_consents(req.user_id)

    tx_tasks = [
        fetch_bank_data_with_consent(consent.bank_id, consent.consent_id, req.user_id)
        for consent in approved_consents
    ]
    credit_tasks = [
        fetch_bank_credits(consent.bank_id, consent.consent_id, req.user_id, create_product_consent=True)
        for consent in approved_consents
    ]
    account_tasks = [
        fetch_bank_accounts_with_consent(consent.bank_id, consent.consent_id, req.user_id)
        for consent in approved_consents
    ]

    tx_results, credit_results, account_results = await asyncio.gather(
        asyncio.gather(*tx_tasks),
        asyncio.gather(*credit_tasks),
        asyncio.gather(*account_tasks),
    )

    all_transactions: List[Transaction] = []
    all_credits: List[Dict[str, Any]] = []
    all_accounts: List[Dict[str, Any]] = []
    enriched_credits: List[Dict[str, Any]] = []
    enriched_accounts: List[Dict[str, Any]] = []
    tx_statuses: List[Dict[str, str]] = []
    credit_statuses: List[Dict[str, str]] = []
    account_statuses: List[Dict[str, str]] = []

    for res in tx_results:
        tx_statuses.append({"bank": res["bank_id"], "status": res["status"], "message": res.get("message") or ""})
        if res["status"] == "ok":
            all_transactions.extend(res["transactions"])

    for res in credit_results:
        credit_statuses.append({"bank": res["bank_id"], "status": res["status"], "message": res.get("message") or ""})
        if res["status"] == "ok":
            all_credits.extend(res.get("credits") or [])
            for credit in res.get("credits", []) or []:
                enriched = build_credit_product(credit, res["bank_id"])
                if enriched:
                    enriched_credits.append(enriched)

    for res in account_results:
        account_statuses.append({"bank": res["bank_id"], "status": res["status"], "message": res.get("message") or ""})
        if res["status"] == "ok":
            all_accounts.extend(res.get("accounts") or [])
            for account in res.get("accounts", []) or []:
                enriched = build_account_product(account, res["bank_id"])
                if enriched:
                    enriched_accounts.append(enriched)

    product_consents = get_product_consents_for_user(req.user_id)
    bank_status_logs = get_recent_bank_status_logs(req.user_id)

    if not all_transactions:
        return {
            "error": "Could not fetch any transactions.",
            "bank_statuses": {
                "transactions": tx_statuses,
                "credits": credit_statuses,
                "accounts": account_statuses,
            },
            "product_consents": product_consents,
            "bank_status_logs": bank_status_logs,
        }

    stored_goal = get_user_goal(req.user_id)
    user_goal = compose_user_goal(stored_goal, req.goal_type, req.goal_details, req.pace)

    portrait = build_financial_portrait(
        transactions=all_transactions,
        credits=enriched_credits or all_credits,
        accounts=enriched_accounts or all_accounts,
        user_goal=user_goal,
    )
    portrait["bank_statuses"] = {
        "transactions": tx_statuses,
        "credits": credit_statuses,
        "accounts": account_statuses,
    }
    portrait["product_consents"] = product_consents
    portrait["bank_status_logs"] = bank_status_logs
    portrait["accounts"] = enriched_accounts or all_accounts
    portrait["credits"] = enriched_credits or all_credits
    portrait["transactions_sample"] = all_transactions[:100]
    products_by_bank = group_products_by_bank(portrait["accounts"], portrait["credits"])
    portrait["products_by_bank"] = apply_consent_flags(products_by_bank, product_consents)
    (
        portrait_analysis,
        portrait_trajectories,
        portrait_forecast_dates,
        portrait_noise_profile,
        portrait_event_profiles,
    ) = run_analysis_with_details(
        all_transactions,
        float(portrait.get("current_balance") or 0.0),
        date.today() + timedelta(days=30),
        0,
    )
    recurring_source = portrait.get("discovered_events") or portrait_event_profiles
    obligations = derive_obligations(portrait["credits"], recurring_source)
    goal_probability = estimate_goal_probability(
        user_goal,
        portrait_trajectories,
        portrait_forecast_dates,
        obligations,
        recurring_source,
    )
    portrait["analysis"] = portrait_analysis.dict()
    portrait["diagnostics"] = {
        "noise_profile": portrait_noise_profile,
        "forecast_dates": [d.isoformat() for d in portrait_forecast_dates],
        "trajectory_sample": list(portrait_trajectories.shape),
    }
    portrait["goal_probability"] = goal_probability
    if not portrait.get("recurring_events"):
        portrait["recurring_events"] = extract_recurring_events(recurring_source)
    logger.info(
        "Financial portrait for %s: debt=%.2f, monthly=%.2f, sts=%.2f, loans=%d, accounts=%d",
        req.user_id,
        portrait.get("financial_health", {}).get("total_debt", 0.0),
        portrait.get("financial_health", {}).get("total_monthly_payments", 0.0),
        portrait.get("safe_to_spend_daily", 0.0),
        len(portrait["credits"]),
        len(portrait["accounts"]),
    )
    return portrait


async def run_initial_ingestion(req: IngestRequest) -> Dict[str, Any]:
    logger.info("Starting initial ingestion for user %s", req.user_id)
    approved_consents = _require_consents(req.user_id)

    tasks = [
        fetch_bank_data_with_consent(consent.bank_id, consent.consent_id, req.user_id)
        for consent in approved_consents
    ]
    bank_results = await asyncio.gather(*tasks)

    all_transactions: List[Transaction] = []
    bank_statuses: List[Dict[str, str]] = []
    for res in bank_results:
        bank_statuses.append(
            {"bank_name": res["bank_id"], "status": res["status"], "message": res["message"]}
        )
        if res["status"] == "ok":
            all_transactions.extend(res["transactions"])

    if not all_transactions:
        raise HTTPException(
            status_code=status.HTTP_424_FAILED_DEPENDENCY,
            detail="Could not fetch any transactions.",
        )

    logger.info(
        "Initial ingestion completed for user %s (%d transactions)",
        req.user_id,
        len(all_transactions),
    )

    return {
        "status": "ok",
        "transactions_count": len(all_transactions),
        "bank_statuses": bank_statuses,
        "message": "Initial data ingestion complete.",
    }


async def start_analysis(req: AnalysisRequest) -> Dict[str, Any]:
    approved_consents = _require_consents(req.user_id)

    tasks = [
        fetch_bank_data_with_consent(consent.bank_id, consent.consent_id, req.user_id)
        for consent in approved_consents
    ]
    bank_results = await asyncio.gather(*tasks)

    all_transactions: List[Transaction] = []
    bank_statuses: List[Dict[str, str]] = []
    for res in bank_results:
        bank_statuses.append(
            {"bank_name": res["bank_id"], "status": res["status"], "message": res["message"]}
        )
        if res["status"] == "ok":
            all_transactions.extend(res["transactions"])

    if not all_transactions:
        raise HTTPException(
            status_code=status.HTTP_424_FAILED_DEPENDENCY,
            detail="Could not fetch any transactions.",
        )

    (
        analysis_result,
        trajectories,
        forecast_dates,
        noise_profile,
        event_profiles,
    ) = run_analysis_with_details(
        all_transactions,
        req.current_balance,
        req.payment_date,
        req.payment_amount,
    )

    return {
        "analysis_result": analysis_result.dict(),
        "bank_statuses": bank_statuses,
        "discovered_events": event_profiles,
        "noise_profile": noise_profile,
        "forecast_dates": [d.isoformat() for d in forecast_dates],
        "trajectory_shape": list(trajectories.shape),
    }
</file>

<file path="hktn/src/api/client.ts">
import type { DashboardResponse } from '../types/dashboard';
const API_BASE = import.meta.env.VITE_API_BASE ?? '';

type FetchOptions = RequestInit & { skipAuth?: boolean };

async function fetchJson<T = any>(path: string, options: FetchOptions = {}): Promise<T> {
  const url = `${API_BASE}${path}`;
  const headers = new Headers(options.headers);
  if (options.body && !headers.get('Content-Type')) {
    headers.set('Content-Type', 'application/json');
  }

  const response = await fetch(url, { ...options, headers });
  if (!response.ok) {
    let message = `Request failed with status ${response.status}`;
    try {
      const payload = await response.json();
      if (payload?.detail) {
        message = Array.isArray(payload.detail) ? payload.detail[0]?.msg ?? message : payload.detail;
      }
    } catch {
      // ignore JSON parse errors
    }
    const error = new Error(message);
    (error as Error & { status?: number }).status = response.status;
    throw error;
  }
  if (response.status === 204) {
    return {} as T;
  }
  return (await response.json()) as T;
}

export type BankResponse = {
  banks: Array<{
    id: string;
    name: string;
    connected: boolean;
    baseUrl?: string | null;
    status?: string;
    error?: string;
  }>;
};

export const getBanks = (userId?: string) => {
  const query = userId ? `?user_id=${encodeURIComponent(userId)}` : '';
  return fetchJson<BankResponse>(`/api/banks${query}`);
};

export const startConsent = (payload: { user_id: string; bank_id: string }) =>
  fetchJson('/api/consents/start', { method: 'POST', body: JSON.stringify(payload) });

export const startProductConsent = (payload: { user_id: string; bank_id: string }) =>
  fetchJson('/api/consent/initiate/product', { method: 'POST', body: JSON.stringify(payload) });

export const pollConsent = (params: { user_id: string; bank_id: string; request_id: string }) => {
  const query = new URLSearchParams({
    user_id: params.user_id,
    bank_id: params.bank_id,
    request_id: params.request_id,
  }).toString();
  return fetchJson(`/api/consents/status?${query}`);
};

export const getBankBootstrap = (bankId: string, userId: string) =>
  fetchJson(`/api/banks/${bankId}/bootstrap?user_id=${encodeURIComponent(userId)}`);

export const getPreview = (payload: { user_id: string }) =>
  fetchJson('/api/ingest/preview', { method: 'POST', body: JSON.stringify(payload) });

export const saveProductConsents = (payload: {
  user_id: string;
  items: Array<{ bank_id: string; product_id: string; product_type?: string; consented: boolean }>;
}) => fetchJson('/api/products/consent', { method: 'POST', body: JSON.stringify(payload) });

export const saveGoal = (payload: { user_id: string; goal_type: string; goal_details: Record<string, unknown> }) =>
  fetchJson('/api/profile/goal', { method: 'POST', body: JSON.stringify(payload) });

export const runIngestion = (payload: { user_id: string }) =>
  fetchJson('/api/ingest/run', { method: 'POST', body: JSON.stringify(payload) });

export const commitOnboarding = (payload: { user_id: string }) =>
  fetchJson('/api/onboarding/commit', { method: 'POST', body: JSON.stringify(payload) });

export const getDashboard = (userId: string) =>
  fetchJson<DashboardResponse>(`/api/dashboard?user_id=${encodeURIComponent(userId)}`);

export const getCredits = (userId: string) =>
  fetchJson(`/api/credits?user_id=${encodeURIComponent(userId)}`);

export const getFinancialPortrait = (payload: { user_id: string }) =>
  fetchJson('/api/financial-portrait', { method: 'POST', body: JSON.stringify(payload) });

export type { DashboardResponse };

export { fetchJson };
</file>

<file path="hktn/backend/services/consents.py">
from __future__ import annotations

import logging
from typing import Any, Dict

from fastapi import HTTPException, status

from hktn.core.database import (
    get_consent_by_request_id,
    save_consent,
    update_consent_from_request,
    update_consent_status,
)
from hktn.core.obr_client import AUTHORIZED_CONSENT_STATUSES, FAILED_CONSENT_STATUSES

from ..schemas import ConsentInitiateRequest
from .banking import bank_client, get_bank_config

logger = logging.getLogger("finpulse.backend.consents")


async def initiate_consent(req: ConsentInitiateRequest) -> Dict[str, Any]:
    bank_config = get_bank_config(req.bank_id, require_url=True)
    async with bank_client(req.bank_id) as client:
        try:
            logger.info("Initiating consent for user '%s' with bank '%s'", req.user_id, req.bank_id)
            consent_meta = await client.initiate_consent(req.user_id)
            consent_identifier = consent_meta.consent_id or consent_meta.request_id
            if not consent_identifier:
                raise HTTPException(
                    status_code=502,
                    detail="Bank did not provide consent or request identifier.",
                )

            initial_status = "APPROVED" if consent_meta.auto_approved else "AWAITING_USER"
            save_consent(
                req.user_id,
                req.bank_id,
                consent_identifier,
                initial_status,
                request_id=consent_meta.request_id,
                approval_url=consent_meta.approval_url,
                consent_type="accounts",
            )

            if consent_meta.consent_id and consent_meta.auto_approved:
                update_consent_status(consent_meta.consent_id, "APPROVED")

            response_payload: Dict[str, Any] = {
                "bank_id": req.bank_id,
                "bank_name": bank_config.display_name,
                "user_id": req.user_id,
                "state": "approved" if consent_meta.auto_approved else "pending",
                "status": consent_meta.status,
                "consent_id": consent_meta.consent_id,
                "request_id": consent_meta.request_id,
                "approval_url": consent_meta.approval_url,
                "auto_approved": consent_meta.auto_approved,
            }

            if consent_meta.auto_approved:
                logger.info("Consent %s auto-approved for user '%s'.", consent_meta.consent_id, req.user_id)
            else:
                logger.info(
                    "Consent awaiting user action (request_id=%s) for user '%s'.",
                    consent_meta.request_id,
                    req.user_id,
                )
            return response_payload
        except HTTPException:
            raise
        except Exception as exc:  # noqa: BLE001
            logger.error("Failed to initiate consent for bank %s: %s", req.bank_id, exc)
            raise HTTPException(status_code=502, detail=f"Could not initiate consent with bank: {exc}") from exc


async def initiate_product_consent(req: ConsentInitiateRequest) -> Dict[str, Any]:
    """Initiate product-agreement consent for the selected bank."""
    bank_config = get_bank_config(req.bank_id, require_url=True)
    async with bank_client(req.bank_id) as client:
        try:
            logger.info("Initiating PRODUCT consent for user '%s' with bank '%s'", req.user_id, req.bank_id)
            consent_meta = await client.initiate_product_consent(req.user_id)
            if not consent_meta or not (consent_meta.consent_id or consent_meta.request_id):
                raise HTTPException(status_code=502, detail="Bank did not provide product consent identifier.")

            consent_identifier = consent_meta.consent_id or consent_meta.request_id
            initial_status = "APPROVED" if consent_meta.auto_approved else "AWAITING_USER"
            save_consent(
                req.user_id,
                req.bank_id,
                consent_identifier,
                initial_status,
                request_id=consent_meta.request_id,
                approval_url=consent_meta.approval_url,
                consent_type="products",
            )

            if consent_meta.consent_id and consent_meta.auto_approved:
                update_consent_status(consent_meta.consent_id, "APPROVED")

            return {
                "bank_id": req.bank_id,
                "bank_name": bank_config.display_name,
                "type": "product",
                "state": "approved" if consent_meta.auto_approved else "pending",
                "status": consent_meta.status,
                "consent_id": consent_meta.consent_id,
                "request_id": consent_meta.request_id,
                "approval_url": consent_meta.approval_url,
                "auto_approved": consent_meta.auto_approved,
            }
        except HTTPException as exc:
            logger.error("Failed to initiate PRODUCT consent for bank %s: %s", req.bank_id, exc)
            return {
                "bank_id": req.bank_id,
                "bank_name": bank_config.display_name,
                "type": "product",
                "state": "error",
                "status": "error",
                "error_message": str(exc.detail if hasattr(exc, "detail") else exc),
            }
        except Exception as exc:  # noqa: BLE001
            logger.error("Failed to initiate PRODUCT consent for bank %s: %s", req.bank_id, exc)
            return {
                "bank_id": req.bank_id,
                "bank_name": bank_config.display_name,
                "type": "product",
                "state": "error",
                "status": "error",
                "error_message": str(exc),
            }


async def poll_consent_status(user_id: str, bank_id: str, request_id: str) -> Dict[str, Any]:
    if not request_id:
        raise HTTPException(status_code=400, detail="request_id is required.")
    get_bank_config(bank_id, require_url=True)

    async with bank_client(bank_id) as client:
        try:
            logger.info("Polling consent status for request_id=%s at bank %s", request_id, bank_id)
            payload = await client.get_consent_status_by_request_id(request_id)
            data_section = payload.get("data", {}) if isinstance(payload, dict) else {}
            consent_id = (
                data_section.get("consentId")
                or data_section.get("consent_id")
                or payload.get("consent_id")
            )
            status_value = (
                data_section.get("status")
                or payload.get("status")
                or "unknown"
            )
            response: Dict[str, Any] = {
                "state": "pending",
                "status": status_value,
                "bank_id": bank_id,
                "request_id": request_id,
            }
            stored = get_consent_by_request_id(request_id)
            if stored and stored.get("approval_url"):
                response["approval_url"] = stored["approval_url"]
            approval_link = (
                payload.get("links", {}).get("consentApproval")
                if isinstance(payload, dict)
                else None
            )
            if approval_link:
                response["approval_url"] = approval_link

            if status_value in FAILED_CONSENT_STATUSES:
                response["state"] = "failed"
                if consent_id:
                    update_consent_from_request(request_id, consent_id, status_value)
                return response

            if consent_id:
                response["consent_id"] = consent_id
                if status_value in AUTHORIZED_CONSENT_STATUSES:
                    updated = update_consent_from_request(request_id, consent_id, "APPROVED")
                    if not updated:
                        consent_kind = (stored or {}).get("consent_type") or "accounts"
                        save_consent(
                            user_id,
                            bank_id,
                            consent_id,
                            "APPROVED",
                            request_id=request_id,
                            consent_type=consent_kind,
                        )
                    update_consent_status(consent_id, "APPROVED")
                    response["state"] = "approved"
            return response
        except HTTPException:
            raise
        except Exception as exc:  # noqa: BLE001
            logger.error("Failed to fetch consent status for bank %s: %s", bank_id, exc)
            raise HTTPException(status_code=502, detail=f"Failed to fetch consent status: {exc}") from exc


def mark_consent_from_callback(consent_id: str) -> bool:
    """Mark consent as approved when redirected back from bank."""
    return update_consent_status(consent_id, "APPROVED")
</file>

</files>
