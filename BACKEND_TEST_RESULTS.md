# üß™ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è Backend API

**–î–∞—Ç–∞**: 2025-01-20  
**–í–µ—Ä—Å–∏—è –±—ç–∫–µ–Ω–¥–∞**: 4.0.0  
**–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å**: team260-3  
**–ë–∞–Ω–∫**: ABank (abank)

---

## ‚úÖ –£—Å–ø–µ—à–Ω—ã–µ —Ç–µ—Å—Ç—ã

### 1. –ë–∞–∑–æ–≤—ã–µ Endpoints

#### ‚úÖ `/api/auth/login`
**–ó–∞–ø—Ä–æ—Å**:
```bash
POST /api/auth/login
{
  "user_id": "team260-3",
  "user_name": "–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–£–°–ü–ï–•**
```json
{
  "token": "mock-token-for-team260-3",
  "profile": {
    "user_id": "team260-3",
    "name": "–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å",
    "subscription_plan": "free",
    "is_active": true
  }
}
```

---

#### ‚úÖ `/api/banks`
**–ó–∞–ø—Ä–æ—Å**:
```bash
GET /api/banks
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–£–°–ü–ï–•**
```json
{
  "banks": [
    {
      "id": "vbank",
      "name": "VBank",
      "connected": false,
      "baseUrl": "https://vbank.open.bankingapi.ru",
      "status": "configured"
    },
    {
      "id": "abank",
      "name": "ABank",
      "connected": false,
      "baseUrl": "https://abank.open.bankingapi.ru",
      "status": "configured"
    },
    {
      "id": "sbank",
      "name": "SBank",
      "connected": false,
      "baseUrl": "https://sbank.open.bankingapi.ru",
      "status": "configured"
    }
  ]
}
```

**–í—ã–≤–æ–¥**: –í—Å–µ 3 –±–∞–Ω–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ –¥–æ—Å—Ç—É–ø–Ω—ã.

---

### 2. Consent Flow

#### ‚úÖ `/api/consent/initiate`
**–ó–∞–ø—Ä–æ—Å**:
```bash
POST /api/consent/initiate
{
  "user_id": "team260-3",
  "bank_id": "abank",
  "user_name": "–¢–µ—Å—Ç–æ–≤—ã–π –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å"
}
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–£–°–ü–ï–•**

**Account Consent**:
```json
{
  "bank_id": "abank",
  "bank_name": "ABank",
  "user_id": "team260-3",
  "state": "approved",
  "status": "approved",
  "consent_id": "consent-451b5d81dbe0",
  "request_id": "req-827d4f47e2f7",
  "approval_url": null,
  "auto_approved": true
}
```

**Product Consent** (—Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):
- ‚úÖ Account consent –±—ã–ª auto-approved
- ‚úÖ Product consent —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏: `pagc-301668ade71e`
- ‚úÖ –û–±–∞ consent —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ –ë–î —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏

**–õ–æ–≥–∏**:
```
INFO: Account consent auto-approved, trying to create product consent for team260-3@abank
INFO: Product consent created for team260-3@abank (consent_id=pagc-301668ade71e)
```

**–í—ã–≤–æ–¥**: ‚úÖ `initiate_full_consent_flow()` —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
- –°–æ–∑–¥–∞–µ—Ç account consent
- –ü—Ä–∏ auto-approve –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–æ–∑–¥–∞–µ—Ç product consent
- –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –æ–±–∞ –≤ –ë–î

---

### 3. Bootstrap Endpoint (–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö)

#### ‚úÖ `/api/banks/{bank_id}/bootstrap`
**–ó–∞–ø—Ä–æ—Å**:
```bash
GET /api/banks/abank/bootstrap?user_id=team260-3
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ **–£–°–ü–ï–•**

#### Accounts (–°—á–µ—Ç–∞)
```json
{
  "accounts": [
    {
      "accountId": "acc-3693",
      "status": "Enabled",
      "currency": "RUB",
      "accountType": "Personal",
      "accountSubType": "Checking",
      "nickname": "Checking —Å—á–µ—Ç",
      "openingDate": "2024-10-30",
      "bank_id": "abank",
      "bank_name": "ABank"
    }
  ]
}
```
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **1 —Å—á–µ—Ç –ø–æ–ª—É—á–µ–Ω**

---

#### Balances (–ë–∞–ª–∞–Ω—Å—ã)
```json
{
  "balances": [
    {
      "accountId": "acc-3693",
      "type": "InterimAvailable",
      "dateTime": "2025-11-19T17:42:39.106562Z",
      "amount": {
        "amount": "264245.21",
        "currency": "RUB"
      },
      "creditDebitIndicator": "Credit"
    },
    {
      "accountId": "acc-3693",
      "type": "InterimBooked",
      "dateTime": "2025-11-19T17:42:39.106572Z",
      "amount": {
        "amount": "264245.21",
        "currency": "RUB"
      },
      "creditDebitIndicator": "Credit"
    }
  ]
}
```
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **2 –∑–∞–ø–∏—Å–∏ –±–∞–ª–∞–Ω—Å–∞ –ø–æ–ª—É—á–µ–Ω—ã**
- ‚úÖ –ü–∞—Ä—Å–∏–Ω–≥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ `_extract_balances()` –ø—Ä–∏–º–µ–Ω–µ–Ω–æ)
- ‚úÖ –ë–∞–ª–∞–Ω—Å: **264,245.21 RUB**

---

#### Transactions (–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏)
**–°—Ç–∞—Ç—É—Å**: ‚úÖ **189 —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø–æ–ª—É—á–µ–Ω–æ** (–ø–µ—Ä–≤—ã–µ 100 –≤ –æ—Ç–≤–µ—Ç–µ)

**–ü—Ä–∏–º–µ—Ä —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏**:
```json
{
  "transactionId": "tx-abank-00632484",
  "amount": -4306.32,
  "currency": "RUB",
  "description": "Dodopizza - –ú–æ—Å–∫–≤–∞",
  "bookingDate": "2025-11-08",
  "creditDebitIndicator": "Debit",
  "merchant": {
    "merchantId": "merchant-restaurant-0335",
    "name": "Dodopizza",
    "mccCode": "5812",
    "category": "restaurant",
    "city": "–ú–æ—Å–∫–≤–∞"
  }
}
```

**–í—ã–≤–æ–¥**: ‚úÖ –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –ø–∞—Ä—Å—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ, –≤—Å–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã.

---

#### Credits (–ö—Ä–µ–¥–∏—Ç—ã)
```json
{
  "credits": []
}
```
**–°—Ç–∞—Ç—É—Å**: ‚ö†Ô∏è **0 –∫—Ä–µ–¥–∏—Ç–æ–≤** (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)

**–í–æ–∑–º–æ–∂–Ω—ã–µ –ø—Ä–∏—á–∏–Ω—ã**:
1. –£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤ –≤ ABank
2. Product consent –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ (–Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É)

**–ü—Ä–æ–≤–µ—Ä–∫–∞**: –í –ª–æ–≥–∞—Ö –≤–∏–¥–Ω–æ, —á—Ç–æ product consent —Å–æ–∑–¥–∞–Ω (`pagc-301668ade71e`), –Ω–æ credits –ø—É—Å—Ç–æ–π. –í–æ–∑–º–æ–∂–Ω–æ:
- –ö—Ä–µ–¥–∏—Ç–æ–≤ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–µ—Ç
- –ò–ª–∏ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è product consent –≤ `fetch_bank_credits()`

---

### 4. Status Block (–°—Ç–∞—Ç—É—Å—ã –∑–∞–ø—Ä–æ—Å–æ–≤)

```json
{
  "status": {
    "accounts": {
      "state": "ok",
      "message": "Fetched 1 accounts"
    },
    "transactions": {
      "state": "ok",
      "message": "Fetched 189 transactions"
    },
    "credits": {
      "state": "ok",
      "message": "Fetched 0 credits"
    },
    "balances": {
      "state": "ok",
      "message": "Fetched 2 balance records"
    }
  }
}
```

**–í—ã–≤–æ–¥**: ‚úÖ –í—Å–µ –∑–∞–ø—Ä–æ—Å—ã –≤—ã–ø–æ–ª–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ, —Å—Ç–∞—Ç—É—Å—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.

---

## üìä –ò—Ç–æ–≥–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –°—Ç–∞—Ç—É—Å | –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ | –î–µ—Ç–∞–ª–∏ |
|-----------|--------|-----------|--------|
| **Accounts** | ‚úÖ | 1 | –°—á–µ—Ç `acc-3693` –ø–æ–ª—É—á–µ–Ω |
| **Balances** | ‚úÖ | 2 | –ë–∞–ª–∞–Ω—Å: 264,245.21 RUB |
| **Transactions** | ‚úÖ | 189 | –ü–µ—Ä–≤—ã–µ 100 –≤ –æ—Ç–≤–µ—Ç–µ |
| **Credits** | ‚ö†Ô∏è | 0 | –ü—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ (–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤) |
| **Consents** | ‚úÖ | 2 | Account + Product consent —Å–æ–∑–¥–∞–Ω—ã |

---

## ‚úÖ –ß—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ

1. **Consent Flow**:
   - ‚úÖ Account consent —Å–æ–∑–¥–∞–µ—Ç—Å—è –∏ auto-approves
   - ‚úÖ Product consent —Å–æ–∑–¥–∞–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ auto-approve
   - ‚úÖ –û–±–∞ consent —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ –ë–î —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ —Ç–∏–ø–∞–º–∏

2. **–ü–∞—Ä—Å–∏–Ω–≥ –¥–∞–Ω–Ω—ã—Ö**:
   - ‚úÖ Balances –ø–∞—Ä—Å—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (–∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ)
   - ‚úÖ Accounts –ø–∞—Ä—Å—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
   - ‚úÖ Transactions –ø–∞—Ä—Å—è—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ —Å–æ –≤—Å–µ–º–∏ –ø–æ–ª—è–º–∏

3. **Bootstrap endpoint**:
   - ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç
   - ‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ
   - ‚úÖ Status –±–ª–æ–∫–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã

---

## ‚ö†Ô∏è –ß—Ç–æ –Ω—É–∂–Ω–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ

1. **Credits –ø—É—Å—Ç–æ–π**:
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –∫—Ä–µ–¥–∏—Ç—ã —É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–∞—Ö (VBank, SBank)
   - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è product consent –≤ `fetch_bank_credits()`
   - –í–æ–∑–º–æ–∂–Ω–æ –Ω—É–∂–µ–Ω –æ—Ç–¥–µ–ª—å–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Å product consent ID

2. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤**:
   - VBank
   - SBank

---

## üéØ –í—ã–≤–æ–¥—ã

**–ë—ç–∫–µ–Ω–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –Ω–∞ ~95%**:

‚úÖ **–í—Å–µ –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Ä–∞–±–æ—Ç–∞—é—Ç**:
- Consent flow —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω –ø—Ä–∞–≤–∏–ª—å–Ω–æ
- –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–∞—Ä—Å–∏–Ω–≥–∞ balances –ø—Ä–∏–º–µ–Ω–µ–Ω–æ
- Bootstrap endpoint –ø–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ
- –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç

‚ö†Ô∏è **–ù–µ–∑–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã**:
- Credits –ø—É—Å—Ç–æ–π (–≤–æ–∑–º–æ–∂–Ω–æ –Ω–µ—Ç –∫—Ä–µ–¥–∏—Ç–æ–≤ –∏–ª–∏ –Ω—É–∂–Ω–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞)
- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –±–∞–Ω–∫–∏ (VBank, SBank)

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è**: –ë—ç–∫–µ–Ω–¥ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é. –ú–æ–∂–Ω–æ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º.

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. ‚úÖ –ë—ç–∫–µ–Ω–¥ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç
2. ‚è≠Ô∏è –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –¥—Ä—É–≥–∏–µ –±–∞–Ω–∫–∏ (VBank, SBank)
3. ‚è≠Ô∏è –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—É—á–µ–Ω–∏–µ credits —Å product consent
4. ‚è≠Ô∏è –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º

